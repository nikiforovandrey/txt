z_trana01:--z_trana01	
	SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	declare @t_accy nvarchar(10)
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_btrandate nvarchar(10)
	declare @t_etrandate nvarchar(10)
	declare @t_carno nvarchar(20)
	declare @t_carkind  nvarchar(max)
	declare @t_rate nvarchar(10)
	declare @t_sort01 nvarchar(max)
	declare @t_filter nvarchar(max)
	
	set @t_accy = '[1]'
	set @t_bdate = case when '#non'=[2] then '' else [2] end
	set @t_edate = case when '#non'=[3] then CHAR(255) else [3] end
	set @t_btrandate = case when '#non'=[4] then '' else [4] end
	set @t_etrandate = case when '#non'=[5] then CHAR(255) else [5] end
	set @t_carno = case when '#non'=[6] then '' else [6] end
	set @t_carkind  = case when '#non'=[7] then '' else [7] end
	set @t_rate  = case when '#non'=[8] then '' else [8] end
	set @t_sort01  = case when '#non'=[9] then '' else [9] end
	set @t_filter  = case when '#non'=[10] then '' else [10] end
	----------------------------------------------------------------------------------------------
	declare @string nvarchar(max)
	declare @n int
	--解析要計算的種類
	IF OBJECT_ID('tempdb..#carkind')is not null
	BEGIN
		set @cmd = 'drop table #carkind'
		EXECUTE sp_executesql @cmd
	END
	create table #carkind(
		noa nvarchar(20)
	)
	set @string = @t_carkind
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #carkind select @string
			end
			break
		end
		insert into #carkind select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end

	----------------------------------------------------------------------------------------------
	declare @carno nvarchar(20)
	declare @datea nvarchar(10)
	declare @carkindno  nvarchar(20)
	declare @carkind	nvarchar(20)
	declare @miles float
	declare @tranmoney float
	declare @drivermoney float
	declare @reserve float 
	declare @mount float 
	declare @money float 
	----------------------------------------------------------------------------------------------
	
	declare @t_date nvarchar(10)
	declare @t_date1 nvarchar(10)
	declare @t_date2 nvarchar(10)

	set @t_date1 = convert(nvarchar(4),convert(int,LEFT(@t_btrandate,3))+1911)+'-'+SUBSTRING(@t_btrandate,5,2)+'-'+RIGHT(@t_btrandate,2)
	set @t_date2 = convert(nvarchar(4),convert(int,LEFT(@t_etrandate,3))+1911)+'-'+SUBSTRING(@t_etrandate,5,2)+'-'+RIGHT(@t_etrandate,2)
	set @t_date=@t_date1

	if(isdate(@t_date1)=0 or isdate(@t_date2)=0)
	begin
		print '日期錯誤'
		return	
	end
	if(DATEDIFF(MM,@t_date1,@t_date2)>2)
	begin
		print '查詢區間不可超過三個月'
		return	
	end
	IF OBJECT_ID('tempdb..#listDate')is not null
	BEGIN
		set @cmd = 'drop table #listDate'
		EXECUTE sp_executesql @cmd
	END
	create table #listDate(
		[date] nvarchar(20)
	)

	while (@t_date between @t_date1 and @t_date2)
	begin
		insert into #listDate select right('00'+convert(nvarchar(3),convert(int,YEAR(@t_date))-1911),3)+'/'+right('0'+convert(nvarchar(2),convert(int,MONTH(@t_date))),2)+'/'+right('0'+convert(nvarchar(2),convert(int,DAY(@t_date))),2)
		set @t_date= convert(date,DATEADD(DD,1,@t_date),111)
	end
	----------------------------------------------------------------------------------------------
	IF OBJECT_ID('tempdb..#listCarno')is not null
	BEGIN
		set @cmd = 'drop table #listCarno'
		EXECUTE sp_executesql @cmd
	END
	create table #listCarno(
		carno nvarchar(20),	
		carkindno nvarchar(20),
		carkind nvarchar(20)																																				
	)
	set @cmd=
	" select  a.carno,isnull(c.noa,''),isnull(c.kind,'') "+ 
	" from  view_trans"+@t_accy+" a  "+
	" left join car2 b on a.carno=b.carno"+
	" left join carKind c on b.carkindno=c.noa"+
	" left join calctypes d on d.noa+d.noq=a.calctype"+
	" left join #carkind e on e.noa=c.noa"+ 
	" where isnull(d.isoutside,0)=0"+
	" and (len(@t_carno)=0 or @t_carno=a.carno)"+
	" and (e.noa is not null)"+
	" and (LEFT(a.trandate,6)  between LEFT(@t_btrandate,6)  and  LEFT(@t_etrandate,6)) "+ 
	" group  by a.carno,isnull(c.noa,''),isnull(c.kind,'') "
	
	insert into #listCarno
	execute  sp_executesql @cmd,N'@t_carno nvarchar(20),@t_btrandate  nvarchar(10),@t_etrandate  nvarchar(10)',@t_btrandate=@t_btrandate,@t_etrandate=@t_etrandate,@t_carno=@t_carno
	----------------------------------------------------------------------------------------------
	IF OBJECT_ID('tempdb..#z_tran01')is not null
	BEGIN
		set @cmd = 'drop table #z_tran01'
		EXECUTE sp_executesql @cmd
	END
	create table #z_tran01 (
		n float,
		gno nvarchar(3),
		carno nvarchar(20),
		carkindno nvarchar(20),
		carkind nvarchar(20),
		driverno nvarchar(20),
		driver nvarchar(20),
		trandate nvarchar(10),
		miles float,
		tranmoney float,
		drivermoney float,
		oilmount float,
		oilmoney float,
		tolls float,
		ticket float,
		reserve float,
		profit  float,
		memo nvarchar(max),
		rate1 float
	)
	CREATE INDEX noa ON #z_tran01 (carno,trandate)
	
	declare cursor_table cursor for
	select carno,carkindno,carkind,[date] from #listCarno,#listDate
	open cursor_table
	fetch next from cursor_table
	into @carno,@carkindno,@carkind,@datea
	while(@@FETCH_STATUS <> -1)
	begin
		insert into #z_tran01(n,gno,carno,carkindno,carkind,trandate,rate1)values(-1,'1',@carno,@carkindno,@carkind,@datea,0)
		fetch next from cursor_table
		into @carno,@carkindno,@carkind,@datea
	end
	close cursor_table
	deallocate cursor_table
	-----------------------------------------------------------------------------------------------------------
	declare @trandate nvarchar(10)
	declare @memo nvarchar(max)
	--出車單
	declare @tmp table(
		carno nvarchar(20),
		trandate nvarchar(20),
		miles float,
		tranmoney float,
		drivermoney float,
		reserve float
	)
	set @cmd  =
	" select a.carno,a.trandate"+
	" ,sum(ISNULL(miles,0))"+
	" ,sum(round(a.price*a.mount,0))"+
	" ,sum(round(a.price2*a.mount2*a.discount,0))"+
	" ,sum(isnull(a.reserve,0))"+
	" from view_trans"+@t_accy+" a"+
	" left join car2 b on a.carno=b.carno"+
	" left join #carkind c on b.carkindno=c.noa"+
	" left  join  calctypes d on d.noa+d.noq=a.calctype "+
	" where (c.noa is not null)"+
	" and  isnull(d.isoutside,0)=0"+
	" and (a.trandate between @t_btrandate and @t_etrandate)"+
	" group by a.carno,a.trandate"
	
	insert into @tmp
	execute sp_executesql @cmd,N'@t_btrandate nvarchar(10),@t_etrandate nvarchar(10)',
	@t_btrandate=@t_btrandate,@t_etrandate=@t_etrandate
	
	
	----------------------------------------------------------------------------------------------
	declare cursor_table cursor for
	select carno,trandate,miles,tranmoney,drivermoney,reserve from @tmp
	open cursor_table
	fetch next from cursor_table
	into @carno,@trandate,@miles,@tranmoney,@drivermoney,@reserve
	while(@@FETCH_STATUS <> -1)
	begin
		update #z_tran01 set miles=@miles,tranmoney=@tranmoney,drivermoney=@drivermoney,reserve=@reserve where carno=@carno and trandate=@trandate
		
		fetch next from cursor_table
		into @carno,@trandate,@miles,@tranmoney,@drivermoney,@reserve
	end
	close cursor_table
	deallocate cursor_table
	
	-----------------------------------------------------------------------------------------------------------
	--油費
	declare cursor_table cursor for
	select a.carno,a.datea,SUM(isnull(a.mount,0)),SUM(isnull(a.[money],0))
	from oil a
	where (a.datea between @t_btrandate and @t_etrandate)
	group  by  a.carno,a.datea
	open cursor_table
	fetch next from cursor_table
	into @carno,@datea,@mount,@money
	while(@@FETCH_STATUS <> -1)
	begin
		update #z_tran01 set oilmount=@mount,oilmoney=@money where carno=@carno and trandate=@datea
		
		fetch next from cursor_table
		into @carno,@datea,@mount,@money
	end
	close cursor_table
	deallocate cursor_table
	-----------------------------------------------------------------------------------------------------------
	--ETC
	declare cursor_table cursor for
	select a.carno,a.datea,SUM(isnull(a.[money],0))
	from etc a
	where (a.typea='ETC' or a.typea='CASH')
	and (a.datea between @t_btrandate and @t_etrandate)
	group  by  a.carno,a.datea
	open cursor_table
	fetch next from cursor_table
	into @carno,@datea,@money
	while(@@FETCH_STATUS <> -1)
	begin
		update #z_tran01 set tolls=@money where carno=@carno and trandate=@datea
		
		fetch next from cursor_table
		into @carno,@datea,@money
	end
	close cursor_table
	deallocate cursor_table
	-----------------------------------------------------------------------------------------------------------
	--罰單
	declare cursor_table cursor for
	select a.carno,a.datea,SUM(isnull(a.comppay,0))
	from carborr a
	where comppay!=0
	and (a.datea between @t_btrandate and @t_etrandate)
	group  by  a.carno,a.datea
	open cursor_table
	fetch next from cursor_table
	into @carno,@datea,@money
	while(@@FETCH_STATUS <> -1)
	begin
		update #z_tran01 set ticket=@money where carno=@carno and trandate=@datea
		
		fetch next from cursor_table
		into @carno,@datea,@money
	end
	close cursor_table
	deallocate cursor_table
	----------------------------------------------------------------------------------------------
	update #z_tran01 set profit=ISNULL(tranmoney,0)-ISNULL(drivermoney,0)-ISNULL(oilmoney,0)-ISNULL(tolls,0)-ISNULL(ticket,0)-ISNULL(reserve,0)
	
	delete #z_tran01 where (isnull(tranmoney,0)=0 and isnull(oilmoney,0)=0 and @t_rate>0) or (isnull(tranmoney,0)!=0 and round(isnull(oilmoney,0)*100/isnull(tranmoney,0),0)<CAST(@t_rate as float))
	
	---------------------------------------------------------------------------------------------
	insert  into  #z_tran01
	select  2,'2',CHAR(255),'','','','',CHAR(255)
	,SUM(ISNULL(miles,0)),SUM(ISNULL(tranmoney,0)),SUM(ISNULL(drivermoney,0)),SUM(ISNULL(oilmount,0)),SUM(ISNULL(oilmoney,0))
	,SUM(ISNULL(tolls,0)),SUM(ISNULL(ticket,0)),SUM(ISNULL(reserve,0)),SUM(ISNULL(profit,0)),'',0
	from  #z_tran01 where gno='1'
	
	update #z_tran01 set rate1 = cast(case when isnull(tranmoney,0)=0 then 0 else round(isnull(oilmoney,0)*100/isnull(tranmoney,0),0) end as nvarchar)
	----------------------------------------------------------------------------------------------
	declare @driver nvarchar(40)
	declare @straddr nvarchar(40)
	declare @total float
	declare @str varchar(max)
	declare @bool bit
	declare @rate1 float
	declare @oilstation nvarchar(20)
	declare @price float
	declare @bmiles float
	declare @emiles float
	declare @oilmoney float
	
	if(patindex('%trans%',@t_filter)>0 or patindex('%oil%',@t_filter)>0)
	begin
		declare cursor_table cursor for
		select trandate,carkindno,carno,isnull(rate1,0),tranmoney,oilmoney from #z_tran01 where gno='1'
		open cursor_table
		fetch next from cursor_table
		into @trandate,@carkindno,@carno,@rate1,@tranmoney,@oilmoney
		while(@@FETCH_STATUS <> -1)
		begin
			--出車明細
			set @bool = 0
			set @cmd ="if exists(select noa from view_trans"+@t_accy+" where carno=@carno and trandate=@trandate) set @bool = 1 else set @bool = 0"
			execute sp_executesql @cmd,N'@bool bit output,@carno nvarchar(20),@trandate nvarchar(10)',@bool=@bool output,@carno=@carno,@trandate=@trandate			
			if(@bool=1 and patindex('%trans%',@t_filter)>0)
			begin
				set @str = '司機'+SPACE(8)
				+SPACE(2)+'起迄地點'+SPACE(12)
				+SPACE(2)+SPACE(6)+'收入'
				+SPACE(2)+SPACE(4)+'里程數'
				set @str = REPLACE(@str,SPACE(1),'&nbsp'+CHAR(59))
				insert into #z_tran01(n,gno,trandate,carkindno,carno,memo,rate1,tranmoney,oilmoney)values(0,'3',@trandate,@carkindno,@carno,@str,@rate1,@tranmoney,@oilmoney)
				set @cmd =
				" declare cursor_table2 cursor for"+
				" select driver,straddr,total,miles from view_trans"+@t_accy+" where carno=@carno and trandate=@trandate"+
				" open cursor_table2"+
				" fetch next from cursor_table2"+
				" into @driver,@straddr,@total,@miles"+
				" while(@@FETCH_STATUS <> -1)"+
				" begin"+
				" 	set @str = left(CAST(@driver+space(12) as varchar(12)),12) "+
				" 	+SPACE(2)+ left(CAST(@straddr+space(20) as varchar(20)),20) "+
				" 	+SPACE(2)+ RIGHT(space(10)+ reverse(substring(reverse(convert(varchar(15),CONVERT(money,isnull(@total,0)),1)),4,10)),10)"+
				" 	+SPACE(2)+ RIGHT(space(10)+ reverse(substring(reverse(convert(varchar(15),CONVERT(money,isnull(@miles,0)),1)),4,10)),10)"+
				" 	set @str = REPLACE(@str,SPACE(1),'&nbsp'+CHAR(59))"+
				" 	insert into #z_tran01(n,gno,trandate,carkindno,carno,memo,rate1,tranmoney,oilmoney)values(0.1,'0',@trandate,@carkindno,@carno,@str,@rate1,@tranmoney,@oilmoney)"+
				" 	fetch next from cursor_table2"+
				" 	into @driver,@straddr,@total,@miles"+
				" end"+
				" close cursor_table2"+
				" deallocate cursor_table2"
				
				execute sp_executesql @cmd,N'@tranmoney float,@oilmoney float,@rate1 float,@carno nvarchar(20),@carkindno nvarchar(20),@trandate nvarchar(10),@driver nvarchar(20),@straddr nvarchar(40),@total float,@miles float,@str varchar(max)'
				,@tranmoney=@tranmoney,@oilmoney=@oilmoney,@rate1=@rate1,@carno=@carno,@carkindno=@carkindno,@trandate=@trandate,@driver=@driver,@straddr=@straddr,@total=@total,@miles=@miles,@str=@str
			end
			--加油明細
			set @bool = 0
			if exists(select noa from oil where carno=@carno and datea=@trandate )
				set @bool = 1
			else
				set @bool = 0
			if(@bool=1 and patindex('%oil%',@t_filter)>0)
			begin	
				set @str = '站名'+SPACE(4)
				+SPACE(2)+SPACE(4)+'公升'
				+SPACE(2)+SPACE(4)+'單價'
				+SPACE(2)+SPACE(12)+'金額'
				+SPACE(2)+SPACE(4)+'里程數'
				+SPACE(2)+SPACE(2)+'上次里程數'
				+SPACE(2)+SPACE(2)+'本次里程數'
				
				set @str = REPLACE(@str,SPACE(1),'&nbsp'+CHAR(59))
				insert into #z_tran01(n,gno,trandate,carkindno,carno,memo,rate1,tranmoney,oilmoney)values(0.2,'4',@trandate,@carkindno,@carno,@str,@rate1,@tranmoney,@oilmoney)
				
				declare cursor_table2 cursor for
				select oilstation,price,mount,[money],bmiles,emiles,miles from oil where carno=@carno and datea=@trandate order by datea,noa
				open cursor_table2
				fetch next from cursor_table2
				into @oilstation,@price,@mount,@money,@bmiles,@emiles,@miles
				while(@@FETCH_STATUS <> -1)
				begin
					set @str = left(CAST(@oilstation+space(8) as varchar(8)),8)
					+SPACE(2)+ RIGHT(space(8)+ Cast(CAST(@mount as decimal(10,2)) as varchar(8)),8) 
					+SPACE(2)+ RIGHT(space(8)+ Cast(CAST(@price as decimal(10,2)) as varchar(8)),8)
					+SPACE(2)+ RIGHT(space(16)+ reverse(substring(reverse(convert(varchar(16),CONVERT(money,isnull(@miles,0)),1)),4,16)),16)
					+SPACE(2)+ RIGHT(space(10)+ reverse(substring(reverse(convert(varchar(15),CONVERT(money,isnull(@money,0)),1)),4,10)),10) 
					+SPACE(2)+ RIGHT(space(12)+ reverse(substring(reverse(convert(varchar(15),CONVERT(money,isnull(@bmiles,0)),1)),4,12)),12)
					+SPACE(2)+ RIGHT(space(12)+ reverse(substring(reverse(convert(varchar(15),CONVERT(money,isnull(@emiles,0)),1)),4,12)),12)					
					set @str = REPLACE(@str,SPACE(1),'&nbsp'+CHAR(59))
					insert into #z_tran01(n,gno,trandate,carkindno,carno,memo,rate1,tranmoney,oilmoney)values(0.21,'0',@trandate,@carkindno,@carno,@str,@rate1,@tranmoney,@oilmoney)
					
					fetch next from cursor_table2
					into @oilstation,@price,@mount,@money,@bmiles,@emiles,@miles
				end
				close cursor_table2
				deallocate cursor_table2
			end
				
			fetch next from cursor_table
			into @trandate,@carkindno,@carno,@rate1,@tranmoney,@oilmoney
		end
		close cursor_table
		deallocate cursor_table
	end
	----------------------------------------------------------------------------------------------
	select @cmd = ''
	select @cmd = cast(COUNT(1) as nvarchar)+'車次' from #z_tran01 where gno='1'
	
	if @t_sort01 = 'trandate'
	begin
		select a.*,trandate dd,c.kind 類別,b.caryear 年份,b.cylinder 汽缸
		,cast(a.rate1 as nvarchar)+'%' 耗油比
		,cast(case when isnull(oilmount,0)=0 then 0 else round(isnull(miles,0)/isnull(oilmount,0),2) end as nvarchar) 公里升
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tranmoney,0)),1)),4,12)) 收入
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(drivermoney,0)),1)),4,12)) 薪資
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(oilmoney,0)),1)),4,12)) 油費
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(oilmount,0)),1)),4,12))油量
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tolls,0)),1)),4,12)) 通行費
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(ticket,0)),1)),4,12)) 罰款
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(a.reserve,0)),1)),4,12)) 寄櫃費
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(a.profit,0)),1)),4,12)) 淨利
		,e.memo mmm
		,@cmd times
		from #z_tran01 a
		left join car2 b on a.carno=b.carno
		left join carKind c on b.carkindno=c.noa
		left join driver d on a.driverno=d.noa
		left join carpresents e on a.carno=e.carno and a.trandate=e.datea
		order  by  a.trandate,a.carkindno,b.caryear,a.carno,n
	end
	else
	begin
		select a.*,trandate dd,c.kind 類別,b.caryear 年份,b.cylinder 汽缸
		,cast(a.rate1 as nvarchar)+'%' 耗油比
		,cast(case when isnull(oilmount,0)=0 then 0 else round(isnull(miles,0)/isnull(oilmount,0),2) end as nvarchar) 公里升
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tranmoney,0)),1)),4,12)) 收入
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(drivermoney,0)),1)),4,12)) 薪資
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(oilmoney,0)),1)),4,12)) 油費
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(oilmount,0)),1)),4,12))油量
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tolls,0)),1)),4,12)) 通行費
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(ticket,0)),1)),4,12)) 罰款
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(a.reserve,0)),1)),4,12)) 寄櫃費
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(a.profit,0)),1)),4,12)) 淨利
		,e.memo mmm
		,@cmd times
		,case when gno='2' then -999 when a.rate1=0 and a.oilmoney!=0 then (9999) else a.rate1 end sort01
		from #z_tran01 a
		left join car2 b on a.carno=b.carno
		left join carKind c on b.carkindno=c.noa
		left join driver d on a.driverno=d.noa
		left join carpresents e on a.carno=e.carno and a.trandate=e.datea
		order  by  sort01 desc,a.trandate,a.carkindno,b.caryear,a.carno,n
	end
	----------------------------------------------------------------------------------------------
	drop table #carkind
	drop table #listDate
	drop table #z_tran01;