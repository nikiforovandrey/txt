z_trana15:--z_trana15
	SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	declare @t_accy nvarchar(10)
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_bcustno nvarchar(30)
	declare @t_ecustno nvarchar(30)
	declare @t_bdriverno nvarchar(30)
	declare @t_edriverno nvarchar(30)
	declare @t_carno nvarchar(20)
	declare @t_po nvarchar(20)
	declare @t_addr nvarchar(20)
	declare @t_carteamno nvarchar(max)
	declare @t_calctype nvarchar(max)
	declare @t_other nvarchar(max)
	declare @t_calcmoney nvarchar(max)
	declare @t_sort8 nvarchar(max)
	declare @t_sort10 nvarchar(max)
	declare @t_sort3 nvarchar(max)
	declare @t_bsalesno nvarchar(20)
	declare @t_esalesno nvarchar(20)
	declare @t_field5 nvarchar(max)
	declare @t_yproduct nvarchar(max)
	declare @t_yaddr nvarchar(max)
	declare @t_yboatname nvarchar(max)
	declare @t_sort6 nvarchar(max)
	declare @t_carkindno nvarchar(max)
	declare @t_sort5 nvarchar(max)	
	declare @t_field13 nvarchar(max)	
	declare @t_sort13 nvarchar(max)	
	declare @t_field1 nvarchar(max)	
	declare @t_sort1 nvarchar(max)	
	declare @t_acomp nvarchar(max)	
	declare @t_sort14 nvarchar(max)
	declare @t_trandono nvarchar(max)
	declare @t_option14 nvarchar(max)
	declare @t_baddrno nvarchar(20)
	declare @t_eaddrno nvarchar(20)
	declare @t_btrandate nvarchar(10)
	declare @t_etrandate nvarchar(10)
	declare @t_plusmoney int
	declare @t_minusmoney int
	
	set @t_accy = [1]
	set @t_bdate = case when '#non'=[2] then '' else [2] end
	set @t_edate = case when '#non'=[3] then char(255) else [3] end
	set @t_bcustno = case when '#non'=[4] then '' else [4] end
	set @t_ecustno = case when '#non'=[5] then char(255) else [5] end
	set @t_bdriverno = case when '#non'=[6] then '' else [6] end
	set @t_edriverno = case when '#non'=[7] then char(255) else [7] end
	set @t_carno = case when '#non'=[8] then '' else [8] end
	set @t_po = case when '#non'=[9] then '' else [9] end
	set @t_addr = case when '#non'=[10] then '' else [10] end
	set @t_carteamno = case when '#non'=[11] then '' else [11] end
	set @t_calctype = case when '#non'=[12] then '' else [12] end
	set @t_other = case when '#non'=[13] then '' else [13] end
	set @t_calcmoney = case when '#non'=[14] then '' else [14] end
	set @t_sort8 = case when '#non'=[15] then '' else [15] end
	set @t_sort10 =  case when '#non'=[16] then '' else [16] end
	set @t_sort3 = case when '#non'=[17] then '' else [17] end
	set @t_bsalesno = case when '#non'=[18] then '' else [18] end
	set @t_esalesno = case when '#non'=[19] then char(255) else [19] end
	set @t_field5 = case when '#non'=[20] then '' else [20] end
	set @t_yproduct = case when '#non'=[21] then '' else [21] end
	set @t_yaddr = case when '#non'=[22] then '' else [22] end
	set @t_yboatname = case when '#non'=[23] then '' else [23] end
	set @t_sort6 = case when '#non'=[24] then '' else [24] end
	set @t_carkindno = case when '#non'=[25] then '' else [25] end
	set @t_sort5 = case when '#non'=[26] then '' else [26] end
	set @t_field13 = case when '#non'=[27] then '' else [27] end
	set @t_sort13 = case when '#non'=[28] then '' else [28] end
	set @t_field1 = case when '#non'=[29] then '' else [29] end
	set @t_sort1 = case when '#non'=[30] then '' else [30] end
	set @t_acomp = case when '#non'=[31] then '' else [31] end
	set @t_sort14 = case when '#non'=[32] then '' else [32] end
	set @t_trandono = case when '#non'=[33] then '' else [33] end
	set @t_option14 = case when '#non'=[34] then '' else [34] end
	set @t_baddrno = case when '#non'=[35] then '' else [35] end
	set @t_eaddrno = case when '#non'=[36] then char(255) else [36] end
	set @t_btrandate = case when '#non'=[37] then '' else [37] end
	set @t_etrandate = case when '#non'=[38] then char(255) else [38] end
	set @t_plusmoney = case when '#non'=[39] then '0' else cast([39] as int) end
	set @t_minusmoney = case when '#non'=[40]then '0' else cast([40] as int) end
	-------------------------------------------------------------------------------------------------------------
	declare @n int
	declare @noa nvarchar(10)
	declare @carno nvarchar(20)
	declare @mount2 float
	declare @total2 float
	declare @team nvarchar(20)
	declare @x_key nvarchar(max)
	declare @x_mount2 float
	declare @x_total2 float
	declare @driverno nvarchar(20)
	-------------------------------------------------------------------------------------------------------------
	--解析要計算的種類
	declare @string nvarchar(max)
	IF OBJECT_ID('tempdb..#carteam')is not null
	BEGIN
		set @cmd = 'drop table #carteam'
		EXECUTE sp_executesql @cmd
	END
	create table #carteam(
		noa nvarchar(10)
	)
	set @string = @t_carteamno
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #carteam select @string
			end
			break
		end
		insert into #carteam select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	IF OBJECT_ID('tempdb..#calctype')is not null
	BEGIN
		set @cmd = 'drop table #calctype'
		EXECUTE sp_executesql @cmd
	END
	create table #calctype(
		noa nvarchar(10)
	)
	set @string = @t_calctype
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #calctype select @string
			end
			break
		end
		insert into #calctype select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	-------------------------------------------------------------------------------------------------------------
	IF OBJECT_ID('tempdb..#z_trana15')is not null
	BEGIN
		set @cmd = 'drop table #z_trana15'
		EXECUTE sp_executesql @cmd
	END
	create table #z_trana15(
		gno nvarchar(3),
		trandate nvarchar(10),
		datea nvarchar(10),
		custno nvarchar(20),
		comp nvarchar(40),
		driverno nvarchar(20),
		namea nvarchar(20),
		carno nvarchar(20),
		addr nvarchar(40),
		product nvarchar(40),
		mount decimal(10,3),
		price float,
		total float,
		mount2 decimal(10,3),
		price2 float,
		price3 float,
		discount decimal(10,3),
		total2 float,
		po nvarchar(30),
		caseno nvarchar(30),
		cc  nvarchar(20),
		tt  nvarchar(20),
		noa  nvarchar(20)
	)
	
	set @cmd = 
		" select  '0',a.trandate,a.datea,a.custno,left(a.comp,4),a.driverno,a.driver,a.carno,a.straddr,a.product,"+
		" a.mount,a.price,a.total,a.mount2,a.price2,a.price3,a.discount,a.total2,a.po,a.caseno,e.typea,d.team,a.noa"+
		" from  trans"+@t_accy+"  a"+
		" left join #carteam  b on a.carteamno=b.noa"+	
		" left join #calctype c on a.calctype=c.noa"+
		" left join carteam  d on a.carteamno=d.noa"+	
		" left join calctypes e on a.calctype=e.noa+e.noq"+
		" where "+
		" (a.datea  between  @t_bdate  and  @t_edate) and "+
		" (a.custno  between  @t_bcustno   and  @t_ecustno) and "+
		" (a.driverno  between  @t_bdriverno   and  @t_edriverno) and "+
		" (len(@t_carno)=0  or  a.carno=@t_carno) and "+
		" (len(@t_po)=0  or  a.po=@t_po) and "+
		"(len(@t_addr)=0 or  a.straddrno = @t_addr  or  a.straddr = @t_addr)  and"+
		" (b.noa  is  not  null) and (c.noa  is  not  null)"
	if @t_sort3='carno'  or @t_sort3='noa' or @t_sort3='driverno' 
		set  @cmd  =  @cmd+" order  by  a.driverno,a.carno,a.noa"
	else
		set  @cmd  =  @cmd+" order  by  a.driverno,a.carno,a.["+@t_sort3+"],a.noa"
	insert into #z_trana15
	execute sp_executesql @cmd,N'@t_bdate nvarchar(10),@t_edate nvarchar(10),@t_bcustno nvarchar(20),@t_ecustno nvarchar(20),@t_bdriverno  nvarchar(20),@t_edriverno  nvarchar(20),@t_carno  nvarchar(20),@t_po  nvarchar(20),@t_addr  nvarchar(20)',
		@t_bdate=@t_bdate,@t_edate=@t_edate,@t_bcustno=@t_bcustno,@t_ecustno=@t_ecustno,@t_bdriverno=@t_bdriverno,@t_edriverno=@t_edriverno,@t_carno=@t_carno,@t_po=@t_po,@t_addr=@t_addr
		
	select @mount2=SUM(ISNULL(mount2,0)),@total2=SUM(ISNULL(total2,0)) from #z_trana15
	--insert into #z_trana15 (gno,driverno,carno,mount2,total2)values('2',CHAR(255),CHAR(255),@mount2,@total2)
	
	
	if @t_sort3='carno'  or @t_sort3='noa' 
	begin 
		declare cursor_table cursor for
		select driverno,carno,max(noa),sum(isnull(mount2,0)),sum(isnull(total2,0)) from #z_trana15 where gno='0' group  by  driverno,carno
		open cursor_table
		fetch next from cursor_table
		into @driverno,@carno,@noa,@mount2,@total2
		while(@@FETCH_STATUS <> -1)
		begin
			insert  into #z_trana15(gno,driverno,carno,noa,mount2,total2)values('1',@driverno,@carno,@noa+CHAR(255),@mount2,@total2)		
			fetch next from cursor_table
			into @driverno,@carno,@noa,@mount2,@total2
		end
		close cursor_table
		deallocate cursor_table
	end
	else
	begin
		declare cursor_table cursor for
		select driverno,carno from #z_trana15 where gno='0'  group  by  driverno,carno
		open cursor_table
		fetch next from cursor_table
		into @driverno,@carno
		while(@@FETCH_STATUS <> -1)
		begin
			set @x_key=''
			set @cmd="select @x_key=cast(max("+@t_sort3+") as  nvarchar) from  #z_trana15 where driverno=@driverno and carno=@carno"
			execute sp_executesql @cmd,N'@driverno nvarchar(20),@carno  nvarchar(20),@x_key nvarchar(max) output',@driverno=@driverno,@carno=@carno,@x_key=@x_key output 
			
			set @noa=''
			set @cmd="select @noa=max(noa) from  #z_trana15 where driverno=@driverno and carno=@carno and "+@t_sort3+"=@x_key"
			execute sp_executesql @cmd,N'@driverno nvarchar(20),@carno  nvarchar(20),@x_key nvarchar(max),@noa nvarchar(20) output',@driverno=@driverno,@carno=@carno,@x_key=@x_key,@noa=@noa output
			select @mount2=0,@total2=0
			select @mount2=sum(isnull(mount2,0)),@total2=sum(isnull(total2,0)) from #z_trana15 where driverno=@driverno and carno=@carno
			
			set @cmd="insert  into  #z_trana15(gno,driverno,carno,"+@t_sort3+",noa,mount2,total2)values('0',@driverno,@carno,char(255),CHAR(255),@mount2,@total2)"
			execute sp_executesql @cmd,N'@driverno nvarchar(20),@carno  nvarchar(20),@mount2  float,@total2  float',@driverno=@driverno,@carno=@carno,@mount2=@mount2,@total2=@total2	
			
			fetch next from cursor_table
			into @driverno,@carno
		end
		close cursor_table
		deallocate cursor_table
	end
	
	if @t_sort3='carno'  or @t_sort3='noa' or @t_sort3='driverno' 
	begin
		set @cmd = 
			" select  gno,trandate  aa,custno bb,namea cc,carno dd,addr,product ee,mount2 ff,"+
			" case when price2=0 then price3 else price2 end gg,discount hh,"+
			" reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total2),1)),4,12)) ii,"+
			" caseno jj,case when right(noa,1)=char(255) then '' else noa  end kk "+
			" from  #z_trana15 order  by driverno,carno,gno,noa"
	end
	else
	begin
		set @cmd = " select  gno,trandate  aa,custno bb,namea cc,carno dd,addr,product ee,mount2 ff,"+
			" case when price2=0 then price3 else price2 end gg,discount hh,"+
			" reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total2),1)),4,12)) ii,"+
			" caseno jj,noa kk "+
			" from  #z_trana15 order  by driverno,carno,gno,["+@t_sort3+"],noa"
	end
	EXECUTE sp_executesql @cmd
	drop table #z_trana15;

z_trana14:--z_trana14
	SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	declare @t_accy nvarchar(10)
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_bcustno nvarchar(30)
	declare @t_ecustno nvarchar(30)
	declare @t_bdriverno nvarchar(30)
	declare @t_edriverno nvarchar(30)
	declare @t_carno nvarchar(20)
	declare @t_po nvarchar(20)
	declare @t_addr nvarchar(20)
	declare @t_carteamno nvarchar(max)
	declare @t_calctype nvarchar(max)
	declare @t_other nvarchar(max)
	declare @t_calcmoney nvarchar(max)
	declare @t_sort8 nvarchar(max)
	declare @t_sort10 nvarchar(max)
	declare @t_sort3 nvarchar(max)
	declare @t_bsalesno nvarchar(20)
	declare @t_esalesno nvarchar(20)
	declare @t_field5 nvarchar(max)
	declare @t_yproduct nvarchar(max)
	declare @t_yaddr nvarchar(max)
	declare @t_yboatname nvarchar(max)
	declare @t_sort6 nvarchar(max)
	declare @t_carkindno nvarchar(max)
	declare @t_sort5 nvarchar(max)	
	declare @t_field13 nvarchar(max)	
	declare @t_sort13 nvarchar(max)	
	declare @t_field1 nvarchar(max)	
	declare @t_sort1 nvarchar(max)	
	declare @t_acomp nvarchar(max)	
	declare @t_sort14 nvarchar(max)
	declare @t_trandono nvarchar(max)
	declare @t_option14 nvarchar(max)
	declare @t_baddrno nvarchar(20)
	declare @t_eaddrno nvarchar(20)
	declare @t_btrandate nvarchar(10)
	declare @t_etrandate nvarchar(10)
	declare @t_plusmoney int
	declare @t_minusmoney int
	
	set @t_accy = [1]
	set @t_bdate = case when '#non'=[2] then '' else [2] end
	set @t_edate = case when '#non'=[3] then char(255) else [3] end
	set @t_bcustno = case when '#non'=[4] then '' else [4] end
	set @t_ecustno = case when '#non'=[5] then char(255) else [5] end
	set @t_bdriverno = case when '#non'=[6] then '' else [6] end
	set @t_edriverno = case when '#non'=[7] then char(255) else [7] end
	set @t_carno = case when '#non'=[8] then '' else [8] end
	set @t_po = case when '#non'=[9] then '' else [9] end
	set @t_addr = case when '#non'=[10] then '' else [10] end
	set @t_carteamno = case when '#non'=[11] then '' else [11] end
	set @t_calctype = case when '#non'=[12] then '' else [12] end
	set @t_other = case when '#non'=[13] then '' else [13] end
	set @t_calcmoney = case when '#non'=[14] then '' else [14] end
	set @t_sort8 = case when '#non'=[15] then '' else [15] end
	set @t_sort10 =  case when '#non'=[16] then '' else [16] end
	set @t_sort3 = case when '#non'=[17] then '' else [17] end
	set @t_bsalesno = case when '#non'=[18] then '' else [18] end
	set @t_esalesno = case when '#non'=[19] then char(255) else [19] end
	set @t_field5 = case when '#non'=[20] then '' else [20] end
	set @t_yproduct = case when '#non'=[21] then '' else [21] end
	set @t_yaddr = case when '#non'=[22] then '' else [22] end
	set @t_yboatname = case when '#non'=[23] then '' else [23] end
	set @t_sort6 = case when '#non'=[24] then '' else [24] end
	set @t_carkindno = case when '#non'=[25] then '' else [25] end
	set @t_sort5 = case when '#non'=[26] then '' else [26] end
	set @t_field13 = case when '#non'=[27] then '' else [27] end
	set @t_sort13 = case when '#non'=[28] then '' else [28] end
	set @t_field1 = case when '#non'=[29] then '' else [29] end
	set @t_sort1 = case when '#non'=[30] then '' else [30] end
	set @t_acomp = case when '#non'=[31] then '' else [31] end
	set @t_sort14 = case when '#non'=[32] then '' else [32] end
	set @t_trandono = case when '#non'=[33] then '' else [33] end
	set @t_option14 = case when '#non'=[34] then '' else [34] end
	set @t_baddrno = case when '#non'=[35] then '' else [35] end
	set @t_eaddrno = case when '#non'=[36] then char(255) else [36] end
	set @t_btrandate = case when '#non'=[37] then '' else [37] end
	set @t_etrandate = case when '#non'=[38] then char(255) else [38] end
	set @t_plusmoney = case when '#non'=[39] then '0' else cast([39] as int) end
	set @t_minusmoney = case when '#non'=[40]then '0' else cast([40] as int) end
	------------------------------------------------------------------------------------------------------------------
	declare @minN int
	set @minN = 40
	declare @acomp nvarchar(50)
	declare @calctypeno nvarchar(10)
	declare @carkind nvarchar(20)
	declare @carkindno nvarchar(10)
	declare @carno nvarchar(20)
	declare @caryear nvarchar(20)
	declare @comp nvarchar(40)
	declare @custno nvarchar(20)
	declare @cylinder int
	declare @datea nvarchar(10)
	declare @day int
	declare @driver nvarchar(20)
	declare @driverno nvarchar(20)
	declare @fieldh nvarchar(20)
	declare @fieldm nvarchar(20)
	declare @header nvarchar(20)
	declare @isDiscount int
	declare @isSum int
	declare @key nvarchar(20)
	declare @miles float
	declare @mon nvarchar(10)
	declare @money float
	declare @money2 float
	declare @money3 float
	declare @mount float
	declare @mount2 float
	declare @mount3 float
	declare @n int
	declare @namea nvarchar(30)
	declare @noa nvarchar(30)
	declare @po nvarchar(30)
	declare @product float
	declare @resverve float
	declare @serial nvarchar(20)
	declare @sort nvarchar(max)
	declare @sortkey nvarchar(20)
	declare @string nvarchar(max)
	declare @tel nvarchar(20)
	declare @title nvarchar(max)
	declare @tolls float
	declare @trandono nvarchar(20)
	declare @totmount1 float--客戶
	declare @totmount2 float--司機
	declare @totmount3 float--外車
	declare @totmoney1 float--客戶
	declare @totmoney2 float--司機
	declare @totmoney3 float--外車
	declare @totmoney4 float  
	------------------------------------------------------------------------------------------------------------------
	--解析要計算的種類
	IF OBJECT_ID('tempdb..#carteam')is not null
	BEGIN
		set @cmd = 'drop table #carteam'
		EXECUTE sp_executesql @cmd
	END
	create table #carteam(
		noa nvarchar(10)
	)
	set @string = @t_carteamno
	while(1=1 and LEN(@string)>0)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #carteam select @string
			end
			break
		end
		insert into #carteam select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	IF OBJECT_ID('tempdb..#calctype')is not null
	BEGIN
		set @cmd = 'drop table #calctype'
		EXECUTE sp_executesql @cmd
	END
	create table #calctype(
		noa nvarchar(10)
	)
	set @string = @t_calctype
	while(1=1 and LEN(@string)>0)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #calctype select @string
			end
			break
		end
		insert into #calctype select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	IF OBJECT_ID('tempdb..#carkind')is not null
	BEGIN
		set @cmd = 'drop table #carkind'
		EXECUTE sp_executesql @cmd
	END
	create table #carkind(
		noa nvarchar(10)
	)
	set @string = @t_carkindno
	while(1=1 and LEN(@string)>0)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #carkind select @string
			end
			break
		end
		insert into #carkind select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end

	set @isDiscount=0
	set @string = @t_other
	while(1=1 and LEN(@string)>0)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				if  @string='discount'
					set  @isDiscount  =  1
			end
			break
		end
		if   LEFT(@string,@n-1)='discount'
			set  @isDiscount  =  1
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	declare @display table(
		noa nvarchar(20)
	)
	
	set @string = case 
					when len(@t_field5)>0 then @t_field5
					when LEN(@t_field13)>0 then @t_field13
					when LEN(@t_field1)>0 then @t_field1
				end					
	while(1=1 and LEN(@string)>0)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into @display select @string
			end
			break
		end
		insert into @display select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	---------------------------------------------------------------------------------------
	------------------------------------------------------------------------------------------------------------------
	IF OBJECT_ID('tempdb..#z_trana14')is not null
	BEGIN
		set @cmd = 'drop table #z_trana14'
		EXECUTE sp_executesql @cmd
	END
	create table  #z_trana14(
		gno nvarchar(3),
		sortkey nvarchar(20),
		title nvarchar(max),
		acomp nvarchar(30),
		noa nvarchar(20),	
		custno nvarchar(20),
		comp nvarchar(50),
		po nvarchar(20),
		datea nvarchar(20),
		trandate nvarchar(20),
		driverno nvarchar(20),
		driver nvarchar(20),
		straddrno nvarchar(20),
		straddr nvarchar(40),
		productno nvarchar(20),
		product nvarchar(40),
		memo nvarchar(max),
		isoutside int,
		inmount decimal(12, 3),
		pton1 decimal(12, 3),
		mount1 decimal(12, 3),
		price1 decimal(12, 3),
		money1 float,
		outmount decimal(12, 3),
		pton2 decimal(12, 3),
		mount2 decimal(12, 3),
		price2 decimal(12, 3),
		discount decimal(12, 3),
		money2 float,
		totmount1 decimal(12, 3),--客戶
		totmount2 decimal(12, 3),--司機
		totmount3 decimal(12, 3),--外車
		totmoney1 float,--客戶
		totmoney2 float,--司機
		totmoney3 float,--外車
		totmoney4 float,--差額
	)
	
	if(@t_sort14='custno')
		set @cmd = "select '0',a.custno,('客戶：'+rtrim(a.custno)+space(2)+rtrim(a.comp))"
	else
		set @cmd = "select '0',a.custno,('P／O：'+a.po)"

	set @cmd =	@cmd+
		",@t_acomp,a.noa,a.custno,a.comp,a.po,a.datea,a.trandate"+
		" ,a.driverno,a.driver,a.straddrno,a.straddr,a.uccno,a.product,a.memo,isnull(e.isoutside,0)"+
		" ,a.inmount,a.pton,a.mount,a.price,a.total"+
		" ,a.outmount,a.pton2,a.mount2,(isnull(a.price2,0)+isnull(a.price3,0)),a.discount,a.total2"+
		" ,0,0,0,0,0,0,0"+
		" from  trans"+@t_accy+"  a"+
		" left join #carteam  b on a.carteamno=b.noa"+	
		" left join #calctype c on a.calctype=c.noa"+
		" left join carteam  d on a.carteamno=d.noa"+	
		" left join calctypes e on a.calctype=e.noa+e.noq"+
		" where "+
		" (a.datea  between  @t_bdate  and  @t_edate) and "+
		" (a.trandate between  @t_btrandate  and  @t_etrandate) and "+
		" (a.custno  between  @t_bcustno   and  @t_ecustno) and "+
		" (a.driverno  between  @t_bdriverno   and  @t_edriverno) and "+
		" (len(@t_carno)=0  or  a.carno=@t_carno) and "+
		" (len(@t_po)=0  or  a.po=@t_po) and "+
		" (a.straddrno between @t_baddrno and @t_eaddrno)  and"+
		" (b.noa  is  not  null) and (c.noa  is  not  null)"
	insert into #z_trana14
	execute sp_executesql @cmd,N'@t_acomp nvarchar(40),@t_bdate nvarchar(10),@t_edate nvarchar(10),@t_btrandate nvarchar(10),@t_etrandate nvarchar(10)
	,@t_bcustno nvarchar(20),@t_ecustno nvarchar(20),@t_bdriverno  nvarchar(20),@t_edriverno  nvarchar(20),@t_carno  nvarchar(20),@t_po  nvarchar(20),@t_baddrno  nvarchar(20),@t_eaddrno  nvarchar(20)',
		@t_acomp=@t_acomp,@t_bdate=@t_bdate,@t_edate=@t_edate,@t_btrandate=@t_btrandate,@t_etrandate=@t_etrandate
		,@t_bcustno=@t_bcustno,@t_ecustno=@t_ecustno,@t_bdriverno=@t_bdriverno,@t_edriverno=@t_edriverno,@t_carno=@t_carno,@t_po=@t_po,@t_baddrno=@t_baddrno,@t_eaddrno=@t_eaddrno
		
	if(patindex('%in%',@t_option14)=0)
	begin
		update #z_trana14 set discount=1,money2=ROUND(mount2*price2,0) where isoutside=0
	end
	if(patindex('%out%',@t_option14)=0)
	begin
		update #z_trana14 set discount=1,money2=ROUND(mount2*price2,0) where isoutside=1
	end
	
	declare cursor_table cursor for
	select sortkey from #z_trana14  group by sortkey order by sortkey
	open cursor_table
	fetch next from cursor_table
	into @sortkey
	while(@@FETCH_STATUS <> -1)
	begin
		select @title='',@acomp='',@totmount1=0,@totmount2=0,@totmount3=0,@totmoney1=0,@totmoney2=0,@totmoney3=0,@totmoney4=0
		select top 1 @title=title,@acomp=acomp from #z_trana14 where sortkey=@sortkey
		select @totmount1=SUM(mount1)
			,@totmount2=SUM(case when isoutside=0 then mount2 else 0 end) 
			,@totmount3=SUM(case when isoutside=1 then mount2 else 0 end)  
			,@totmoney1=SUM(money1)
			,@totmoney2=SUM(case when isoutside=0 then money2 else 0 end) 
			,@totmoney3=SUM(case when isoutside=1 then money2 else 0 end)
			,@totmoney4=SUM(money1-money2)
		from  #z_trana14  where  sortkey=@sortkey
		insert into #z_trana14(gno,title,acomp,sortkey,totmount1,totmount2,totmount3,totmoney1,totmoney2,totmoney3,totmoney4)
		values('1',@title,@acomp,@sortkey,@totmount1,@totmount2,@totmount3,@totmoney1,@totmoney2,@totmoney3,@totmoney4)
		fetch next from cursor_table
		into @sortkey
	end
	close cursor_table
	deallocate cursor_table
	
	select gno,sortkey,acomp,title,trandate tdate,driver dd,straddr addr,product pp,memo
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,floor(mount1)),1)),4,12))+RIGHT(cast(mount1 as nvarchar),4) mount1
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,floor(price1)),1)),4,12))+RIGHT(cast(price1 as nvarchar),4) price1
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,floor(price2)),1)),4,12))+RIGHT(cast(price2 as nvarchar),4) price2
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,floor(mount2)),1)),4,12))+RIGHT(cast(mount2 as nvarchar),4) mount2
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,floor(totmount1)),1)),4,12))+RIGHT(cast(totmount1 as nvarchar),4) totmount1
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,floor(totmount2)),1)),4,12))+RIGHT(cast(totmount2 as nvarchar),4) totmount2
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,floor(totmount3)),1)),4,12))+RIGHT(cast(totmount3 as nvarchar),4) totmount3
		,case when discount=1 then null else discount end disc
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,money1),1)),4,12)) money1
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,money2),1)),4,12)) money2
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,totmoney1),1)),4,12)) totmoney1
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,totmoney2),1)),4,12)) totmoney2
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,totmoney3),1)),4,12)) totmoney3
		,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,totmoney4),1)),4,12)) totmoney4
	from #z_trana14 order by sortkey,gno,noa
	drop table #z_trana14;

z_trana2:--z_trana2
	SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	declare @t_accy nvarchar(10)
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_bcustno nvarchar(30)
	declare @t_ecustno nvarchar(30)
	declare @t_bdriverno nvarchar(30)
	declare @t_edriverno nvarchar(30)
	declare @t_carno nvarchar(20)
	declare @t_po nvarchar(20)
	declare @t_addr nvarchar(20)
	declare @t_carteamno nvarchar(max)
	declare @t_calctype nvarchar(max)
	declare @t_other nvarchar(max)
	declare @t_calcmoney nvarchar(max)
	declare @t_sort8 nvarchar(max)
	declare @t_sort10 nvarchar(max)
	declare @t_sort3 nvarchar(max)
	declare @t_bsalesno nvarchar(20)
	declare @t_esalesno nvarchar(20)
	declare @t_field5 nvarchar(max)
	declare @t_yproduct nvarchar(max)
	declare @t_yaddr nvarchar(max)
	declare @t_yboatname nvarchar(max)
	declare @t_sort6 nvarchar(max)
	declare @t_carkindno nvarchar(max)
	declare @t_sort5 nvarchar(max)	
	declare @t_field13 nvarchar(max)	
	declare @t_sort13 nvarchar(max)	
	declare @t_field1 nvarchar(max)	
	declare @t_sort1 nvarchar(max)	
	declare @t_acomp nvarchar(max)	
	declare @t_sort14 nvarchar(max)
	declare @t_trandono nvarchar(max)
	declare @t_option14 nvarchar(max)
	declare @t_baddrno nvarchar(20)
	declare @t_eaddrno nvarchar(20)
	declare @t_btrandate nvarchar(10)
	declare @t_etrandate nvarchar(10)
	declare @t_plusmoney int
	declare @t_minusmoney int
	
	set @t_accy = [1]
	set @t_bdate = case when '#non'=[2] then '' else [2] end
	set @t_edate = case when '#non'=[3] then char(255) else [3] end
	set @t_bcustno = case when '#non'=[4] then '' else [4] end
	set @t_ecustno = case when '#non'=[5] then char(255) else [5] end
	set @t_bdriverno = case when '#non'=[6] then '' else [6] end
	set @t_edriverno = case when '#non'=[7] then char(255) else [7] end
	set @t_carno = case when '#non'=[8] then '' else [8] end
	set @t_po = case when '#non'=[9] then '' else [9] end
	set @t_addr = case when '#non'=[10] then '' else [10] end
	set @t_carteamno = case when '#non'=[11] then '' else [11] end
	set @t_calctype = case when '#non'=[12] then '' else [12] end
	set @t_other = case when '#non'=[13] then '' else [13] end
	set @t_calcmoney = case when '#non'=[14] then '' else [14] end
	set @t_sort8 = case when '#non'=[15] then '' else [15] end
	set @t_sort10 =  case when '#non'=[16] then '' else [16] end
	set @t_sort3 = case when '#non'=[17] then '' else [17] end
	set @t_bsalesno = case when '#non'=[18] then '' else [18] end
	set @t_esalesno = case when '#non'=[19] then char(255) else [19] end
	set @t_field5 = case when '#non'=[20] then '' else [20] end
	set @t_yproduct = case when '#non'=[21] then '' else [21] end
	set @t_yaddr = case when '#non'=[22] then '' else [22] end
	set @t_yboatname = case when '#non'=[23] then '' else [23] end
	set @t_sort6 = case when '#non'=[24] then '' else [24] end
	set @t_carkindno = case when '#non'=[25] then '' else [25] end
	set @t_sort5 = case when '#non'=[26] then '' else [26] end
	set @t_field13 = case when '#non'=[27] then '' else [27] end
	set @t_sort13 = case when '#non'=[28] then '' else [28] end
	set @t_field1 = case when '#non'=[29] then '' else [29] end
	set @t_sort1 = case when '#non'=[30] then '' else [30] end
	set @t_acomp = case when '#non'=[31] then '' else [31] end
	set @t_sort14 = case when '#non'=[32] then '' else [32] end
	set @t_trandono = case when '#non'=[33] then '' else [33] end
	set @t_option14 = case when '#non'=[34] then '' else [34] end
	set @t_baddrno = case when '#non'=[35] then '' else [35] end
	set @t_eaddrno = case when '#non'=[36] then char(255) else [36] end
	set @t_btrandate = case when '#non'=[37] then '' else [37] end
	set @t_etrandate = case when '#non'=[38] then char(255) else [38] end
	set @t_plusmoney = case when '#non'=[39] then '0' else cast([39] as int) end
	set @t_minusmoney = case when '#non'=[40]then '0' else cast([40] as int) end
	------------------------------------------------------------------------------------------------------------------
	declare @minN int
	set @minN = 40
	declare @acomp nvarchar(50)
	declare @calctypeno nvarchar(10)
	declare @carkind nvarchar(20)
	declare @carkindno nvarchar(10)
	declare @carno nvarchar(20)
	declare @caryear nvarchar(20)
	declare @comp nvarchar(40)
	declare @custno nvarchar(20)
	declare @cylinder int
	declare @datea nvarchar(10)
	declare @day int
	declare @driver nvarchar(20)
	declare @driverno nvarchar(20)
	declare @fieldh nvarchar(20)
	declare @fieldm nvarchar(20)
	declare @header nvarchar(20)
	declare @isDiscount int
	declare @isSum int
	declare @key nvarchar(20)
	declare @miles float
	declare @mon nvarchar(10)
	declare @money float
	declare @money2 float
	declare @money3 float
	declare @mount float
	declare @mount2 float
	declare @mount3 float
	declare @n int
	declare @namea nvarchar(30)
	declare @noa nvarchar(30)
	declare @po nvarchar(30)
	declare @product float
	declare @resverve float
	declare @serial nvarchar(20)
	declare @sort nvarchar(max)
	declare @string nvarchar(max)
	declare @tel nvarchar(20)
	declare @tolls float
	declare @trandono nvarchar(20)
	declare @t_isDiscount int
	declare @plusmoney float
	declare @minusmoney float
	------------------------------------------------------------------------------------------------------------------
	--解析要計算的種類
	IF OBJECT_ID('tempdb..#carteam')is not null
	BEGIN
		set @cmd = 'drop table #carteam'
		EXECUTE sp_executesql @cmd
	END
	create table #carteam(
		noa nvarchar(10)
	)
	set @string = @t_carteamno
	while(1=1 and LEN(@string)>0)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #carteam select @string
			end
			break
		end
		insert into #carteam select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	IF OBJECT_ID('tempdb..#calctype')is not null
	BEGIN
		set @cmd = 'drop table #calctype'
		EXECUTE sp_executesql @cmd
	END
	create table #calctype(
		noa nvarchar(10)
	)
	set @string = @t_calctype
	while(1=1 and LEN(@string)>0)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #calctype select @string
			end
			break
		end
		insert into #calctype select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	IF OBJECT_ID('tempdb..#carkind')is not null
	BEGIN
		set @cmd = 'drop table #carkind'
		EXECUTE sp_executesql @cmd
	END
	create table #carkind(
		noa nvarchar(10)
	)
	set @string = @t_carkindno
	while(1=1 and LEN(@string)>0)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #carkind select @string
			end
			break
		end
		insert into #carkind select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end

	set @isDiscount=0
	set @string = @t_other
	while(1=1 and LEN(@string)>0)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				if  @string='discount'
					set  @isDiscount  =  1
			end
			break
		end
		if   LEFT(@string,@n-1)='discount'
			set  @isDiscount  =  1
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	declare @display table(
		noa nvarchar(20)
	)
	
	set @string = case 
					when len(@t_field5)>0 then @t_field5
					when LEN(@t_field13)>0 then @t_field13
					when LEN(@t_field1)>0 then @t_field1
				end					
	while(1=1 and LEN(@string)>0)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into @display select @string
			end
			break
		end
		insert into @display select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	set @t_isDiscount=0
	set @string = @t_other
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				if  @string='discount'
					set  @t_isDiscount  =  1
			end
			break
		end
		if   LEFT(@string,@n-1)='discount'
			set  @t_isDiscount  =  1
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	---------------------------------------------------------------------------------------
	declare @tmp table(
		gno nvarchar(3),
		custno nvarchar(20),
		comp nvarchar(20),
		mon  nvarchar(10),
		total float,
		total2 float,--公司
		total3 float,--外車
		diff  float,
		trdmoney1  float,--當月請款
		trdmoney2  float,--次月請款 
		unpay  float,		
		total4 float, --外車實發 
		plusmoney float,
		minusmoney float
	)
	
	set @cmd = " select  '0',a.custno,b.nick,left(a.datea,6),SUM(isnull(a.total,0)),"
	if  @t_isDiscount=1
		set @cmd = @cmd+" SUM(case when  e.isoutside=1 then 0 else isnull(round(a.mount2*(a.price2+a.price3)*a.discount,0),0) end),"+
						" SUM(case when  e.isoutside=1 then isnull(round(a.mount2*(a.price2+a.price3)*a.discount,0),0) else 0 end),"+
						" SUM(isnull(a.total,0)-isnull(round(a.mount2*(a.price2+a.price3)*a.discount,0),0)),"
	else
		set @cmd = @cmd+" SUM(case when  e.isoutside=1 then 0 else isnull(round(a.mount2*(a.price2+a.price3),0),0) end),"+
						" SUM(case when  e.isoutside=1 then isnull(round(a.mount2*(a.price2+a.price3),0),0) else 0 end),"+
						" SUM(isnull(a.total,0)-isnull(round(a.mount2*(a.price2+a.price3),0),0)),"
	set @cmd = @cmd+
		" sum(case  when g.mon=left(a.datea,6) then isnull(f.tranmoney,0) else  0  end),"+
		" sum(case  when g.mon=left(a.datea,6) then 0 else  isnull(f.tranmoney,0)  end),"+
		" 0  unpay,"+
		" SUM(case when  e.isoutside=1 then isnull(round(a.mount2*(a.price2+a.price3)*a.discount,0),0) else 0 end),"+
		" 0 plus,0 minus"+
		" from  trans"+@t_accy+"  a"+
		" left join cust b on a.custno=b.noa"+
		" left join #carteam  c on a.carteamno=c.noa"+	
		" left join #calctype d on a.calctype=d.noa"+
		" left join calctypes e on a.calctype=e.noa+e.noq"+
		" left join trds"+@t_accy+" f on a.noa=f.tranno and a.noq=f.trannoq"+
		" left join trd"+@t_accy+" g on f.noa=g.noa"+ 
		" where "+
		" (a.datea between  @t_bdate and  @t_edate) and "+
		" (a.custno  between  @t_bcustno   and  @t_ecustno) and "+
		" (a.driverno  between  @t_bdriverno   and  @t_edriverno) and "+
		" (len(@t_carno)=0  or  a.carno=@t_carno) and "+
		" (len(@t_po)=0  or  a.po=@t_po) and "+
		"  (len(@t_addr)=0 or  a.straddrno = @t_addr  or  a.straddr = @t_addr)  and"+
		" (c.noa  is  not  null) and (d.noa  is  not  null)"+
		" group by a.custno,b.nick,left(a.datea,6)"
	insert into @tmp
	execute sp_executesql @cmd,N'@t_bdate nvarchar(10),@t_edate nvarchar(10),@t_bcustno nvarchar(20),@t_ecustno nvarchar(20),@t_bdriverno  nvarchar(20),@t_edriverno  nvarchar(20),@t_carno  nvarchar(20),@t_po  nvarchar(20),@t_addr  nvarchar(20)',
		@t_bdate=@t_bdate,@t_edate=@t_edate,@t_bcustno=@t_bcustno,@t_ecustno=@t_ecustno,@t_bdriverno=@t_bdriverno,@t_edriverno=@t_edriverno,@t_carno=@t_carno,@t_po=@t_po,@t_addr=@t_addr
	-------------------------------------------------------------------------------------------------------------------
	update  @tmp  set  unpay=total-trdmoney1-trdmoney2
	-------------------------------------------------------------------------------------------------------------------
	--declare @tmp2  table(
	--	custno  nvarchar(20),
	--	driverno nvarchar(20),
	--	carno nvarchar(20)
	--)
	--set @cmd=
	--	" select a.custno,a.driverno,a.carno"+
	--	" from  trans"+@t_accy+"  a"+
	--	" left join cust b on a.custno=b.noa"+
	--	" left join #carteam  c on a.carteamno=c.noa"+	
	--	" left join #calctype d on a.calctype=d.noa"+
	--	" left join calctypes e on a.calctype=e.noa+e.noq"+
	--	" left join trds"+@t_accy+" f on a.noa=f.tranno and a.noq=f.trannoq"+
	--	" left join trd"+@t_accy+" g on f.noa=g.noa"+ 
	--	" where "+
	--	" (a.datea  between  @t_bdate  and  @t_edate) and "+
	--	" (a.custno  between  @t_bcustno   and  @t_ecustno) and "+
	--	" (a.driverno  between  @t_bdriverno   and  @t_edriverno) and "+
	--	" (len(@t_carno)=0  or  a.carno=@t_carno) and "+
	--	" (len(@t_po)=0  or  a.po=@t_po) and "+
	--	"  (len(@t_addr)=0 or  a.straddrno = @t_addr  or  a.straddr = @t_addr)  and"+
	--	" (c.noa  is  not  null) and (d.noa  is  not  null)"+
	--	" group by a.custno,a.driverno,a.carno"
	--insert into @tmp2
	--execute sp_executesql @cmd,N'@t_bdate nvarchar(10),@t_edate nvarchar(10),@t_bcustno nvarchar(20),@t_ecustno nvarchar(20),@t_bdriverno  nvarchar(20),@t_edriverno  nvarchar(20),@t_carno  nvarchar(20),@t_po  nvarchar(20),@t_addr  nvarchar(20)',
	--	@t_bdate=@t_bdate,@t_edate=@t_edate,@t_bcustno=@t_bcustno,@t_ecustno=@t_ecustno,@t_bdriverno=@t_bdriverno,@t_edriverno=@t_edriverno,@t_carno=@t_carno,@t_po=@t_po,@t_addr=@t_addr
	
	--declare cursor_table cursor for
	--select custno,driverno,carno from @tmp2 
	--open cursor_table
	--fetch next from cursor_table
	--into @custno,@driverno,@carno
	--while(@@FETCH_STATUS <> -1)
	--begin
	--	select @plusmoney=0,@minusmoney=0  
	--	select @plusmoney=SUM(isnull(plusmoney,0)),@minusmoney=SUM(ISNULL(minusmoney,0))  from  carchg  
	--	where  driverno=@driverno and carno=@carno and (datea  between  @t_bdate  and  @t_edate) 
	--	group by custno
		
	--	update @tmp set plusmoney=plusmoney+@plusmoney,minusmoney=minusmoney+@minusmoney where custno=@custno
		
	--	fetch next from cursor_table
	--	into @custno,@driverno,@carno
	--end
	--close cursor_table
	--deallocate cursor_table
	-------------------------------------------------------------------------------------------------------------------
	select @n=COUNT(1) from( select mon from @tmp group by mon)as a
	if @n>1
		insert into @tmp select '1',custno,comp,CHAR(255),SUM(total),SUM(total2),SUM(total3),SUM(diff),SUM(trdmoney1),SUM(trdmoney2),SUM(unpay),SUM(total4),SUM(plusmoney),SUM(minusmoney) from @tmp group  by  custno,comp

	insert into @tmp select '2',CHAR(255),'',CHAR(255),SUM(total),SUM(total2),SUM(total3),SUM(diff),SUM(trdmoney1),SUM(trdmoney2),SUM(unpay),SUM(total4),SUM(plusmoney),SUM(minusmoney) from @tmp where gno='0'

	select gno,custno cc,comp dd,mon,
		reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total),1)),4,12)) total,
		reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total2),1)),4,12)) total2,
		reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total3),1)),4,12)) total3,
		reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,diff),1)),4,12)) diff,
		reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,trdmoney1),1)),4,12)) trdmoney1,
		reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,trdmoney2),1)),4,12)) trdmoney2,
		reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,unpay),1)),4,12)) unpay,
		reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total4),1)),4,12)) total4,
		reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,@t_plusmoney),1)),4,12)) plusmoney,
		reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,@t_minusmoney),1)),4,12)) minusmoney,
		(reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total4),1)),4,12))+' + '+
		reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,@t_plusmoney),1)),4,12))+' - '+
		reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,@t_minusmoney),1)),4,12))+' = '+
		reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total4+@t_plusmoney-@t_minusmoney),1)),4,12))) total5
	from @tmp order by custno,gno,mon;

z_trana8:--z_trana8	
	SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	declare @t_accy nvarchar(10)
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_bcustno nvarchar(30)
	declare @t_ecustno nvarchar(30)
	declare @t_bdriverno nvarchar(30)
	declare @t_edriverno nvarchar(30)
	declare @t_carno nvarchar(20)
	declare @t_po nvarchar(20)
	declare @t_addr nvarchar(20)
	declare @t_carteamno nvarchar(max)
	declare @t_calctype nvarchar(max)
	declare @t_other nvarchar(max)
	declare @t_calcmoney nvarchar(max)
	declare @t_sort8 nvarchar(max)
	declare @t_sort10 nvarchar(max)
	declare @t_sort3 nvarchar(max)
	declare @t_bsalesno nvarchar(20)
	declare @t_esalesno nvarchar(20)
	declare @t_field5 nvarchar(max)
	declare @t_yproduct nvarchar(max)
	declare @t_yaddr nvarchar(max)
	declare @t_yboatname nvarchar(max)
	declare @t_sort6 nvarchar(max)
	declare @t_carkindno nvarchar(max)
	declare @t_sort5 nvarchar(max)	
	declare @t_field13 nvarchar(max)	
	declare @t_sort13 nvarchar(max)	
	declare @t_field1 nvarchar(max)	
	declare @t_sort1 nvarchar(max)	
	declare @t_acomp nvarchar(max)	
	declare @t_sort14 nvarchar(max)
	declare @t_trandono nvarchar(max)
	declare @t_option14 nvarchar(max)
	declare @t_baddrno nvarchar(20)
	declare @t_eaddrno nvarchar(20)
	declare @t_btrandate nvarchar(10)
	declare @t_etrandate nvarchar(10)
	declare @t_plusmoney int
	declare @t_minusmoney int
	
	set @t_accy = [1]
	set @t_bdate = case when '#non'=[2] then '' else [2] end
	set @t_edate = case when '#non'=[3] then char(255) else [3] end
	set @t_bcustno = case when '#non'=[4] then '' else [4] end
	set @t_ecustno = case when '#non'=[5] then char(255) else [5] end
	set @t_bdriverno = case when '#non'=[6] then '' else [6] end
	set @t_edriverno = case when '#non'=[7] then char(255) else [7] end
	set @t_carno = case when '#non'=[8] then '' else [8] end
	set @t_po = case when '#non'=[9] then '' else [9] end
	set @t_addr = case when '#non'=[10] then '' else [10] end
	set @t_carteamno = case when '#non'=[11] then '' else [11] end
	set @t_calctype = case when '#non'=[12] then '' else [12] end
	set @t_other = case when '#non'=[13] then '' else [13] end
	set @t_calcmoney = case when '#non'=[14] then '' else [14] end
	set @t_sort8 = case when '#non'=[15] then '' else [15] end
	set @t_sort10 =  case when '#non'=[16] then '' else [16] end
	set @t_sort3 = case when '#non'=[17] then '' else [17] end
	set @t_bsalesno = case when '#non'=[18] then '' else [18] end
	set @t_esalesno = case when '#non'=[19] then char(255) else [19] end
	set @t_field5 = case when '#non'=[20] then '' else [20] end
	set @t_yproduct = case when '#non'=[21] then '' else [21] end
	set @t_yaddr = case when '#non'=[22] then '' else [22] end
	set @t_yboatname = case when '#non'=[23] then '' else [23] end
	set @t_sort6 = case when '#non'=[24] then '' else [24] end
	set @t_carkindno = case when '#non'=[25] then '' else [25] end
	set @t_sort5 = case when '#non'=[26] then '' else [26] end
	set @t_field13 = case when '#non'=[27] then '' else [27] end
	set @t_sort13 = case when '#non'=[28] then '' else [28] end
	set @t_field1 = case when '#non'=[29] then '' else [29] end
	set @t_sort1 = case when '#non'=[30] then '' else [30] end
	set @t_acomp = case when '#non'=[31] then '' else [31] end
	set @t_sort14 = case when '#non'=[32] then '' else [32] end
	set @t_trandono = case when '#non'=[33] then '' else [33] end
	set @t_option14 = case when '#non'=[34] then '' else [34] end
	set @t_baddrno = case when '#non'=[35] then '' else [35] end
	set @t_eaddrno = case when '#non'=[36] then char(255) else [36] end
	set @t_btrandate = case when '#non'=[37] then '' else [37] end
	set @t_etrandate = case when '#non'=[38] then char(255) else [38] end
	set @t_plusmoney = case when '#non'=[39] then '0' else cast([39] as int) end
	set @t_minusmoney = case when '#non'=[40]then '0' else cast([40] as int) end
	------------------------------------------------------------------------------------------------------------------
	declare @minN int
	set @minN = 40
	declare @acomp nvarchar(50)
	declare @calctypeno nvarchar(10)
	declare @carkind nvarchar(20)
	declare @carkindno nvarchar(10)
	declare @carno nvarchar(20)
	declare @caryear nvarchar(20)
	declare @comp nvarchar(40)
	declare @custno nvarchar(20)
	declare @cylinder int
	declare @datea nvarchar(10)
	declare @day int
	declare @driver nvarchar(20)
	declare @driverno nvarchar(20)
	declare @fieldh nvarchar(20)
	declare @fieldm nvarchar(20)
	declare @header nvarchar(20)
	declare @isDiscount int
	declare @isSum int
	declare @key nvarchar(20)
	declare @miles float
	declare @mon nvarchar(10)
	declare @money float
	declare @money2 float
	declare @money3 float
	declare @mount float
	declare @mount2 float
	declare @mount3 float
	declare @n int
	declare @namea nvarchar(30)
	declare @noa nvarchar(30)
	declare @po nvarchar(30)
	declare @product float
	declare @resverve float
	declare @serial nvarchar(20)
	declare @sort nvarchar(max)
	declare @string nvarchar(max)
	declare @tel nvarchar(20)
	declare @tolls float
	declare @trandono nvarchar(20)
	------------------------------------------------------------------------------------------------------------------
	--解析要計算的種類
	IF OBJECT_ID('tempdb..#carteam')is not null
	BEGIN
		set @cmd = 'drop table #carteam'
		EXECUTE sp_executesql @cmd
	END
	create table #carteam(
		noa nvarchar(10)
	)
	set @string = @t_carteamno
	while(1=1 and LEN(@string)>0)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #carteam select @string
			end
			break
		end
		insert into #carteam select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	IF OBJECT_ID('tempdb..#calctype')is not null
	BEGIN
		set @cmd = 'drop table #calctype'
		EXECUTE sp_executesql @cmd
	END
	create table #calctype(
		noa nvarchar(10)
	)
	set @string = @t_calctype
	while(1=1 and LEN(@string)>0)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #calctype select @string
			end
			break
		end
		insert into #calctype select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	IF OBJECT_ID('tempdb..#carkind')is not null
	BEGIN
		set @cmd = 'drop table #carkind'
		EXECUTE sp_executesql @cmd
	END
	create table #carkind(
		noa nvarchar(10)
	)
	set @string = @t_carkindno
	while(1=1 and LEN(@string)>0)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #carkind select @string
			end
			break
		end
		insert into #carkind select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end

	set @isDiscount=0
	set @string = @t_other
	while(1=1 and LEN(@string)>0)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				if  @string='discount'
					set  @isDiscount  =  1
			end
			break
		end
		if   LEFT(@string,@n-1)='discount'
			set  @isDiscount  =  1
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	declare @display table(
		noa nvarchar(20)
	)
	
	set @string = case 
					when len(@t_field5)>0 then @t_field5
					when LEN(@t_field13)>0 then @t_field13
					when LEN(@t_field1)>0 then @t_field1
				end					
	while(1=1 and LEN(@string)>0)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into @display select @string
			end
			break
		end
		insert into @display select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	---------------------------------------------------------------------------------------
	IF OBJECT_ID('tempdb..#z_trana8')is not null
	BEGIN
		set @cmd = 'drop table #z_trana8'
		EXECUTE sp_executesql @cmd
	END
	create table  #z_trana8(
			gno nvarchar(1),
			pno nvarchar(1),
			acomp nvarchar(50),
			noa nvarchar(20),
			datea nvarchar(20),
			trandate nvarchar(20),
			po nvarchar(20),
			custno nvarchar(20),
			comp nvarchar(50),
			custorde nvarchar(30),
			newcustorde nvarchar(30),
			serial nvarchar(20),
			tel nvarchar(20),
			straddr nvarchar(20),
			product nvarchar(20),
			mount decimal(18,3),
			price decimal(18,3),
			total decimal(18,3),
			carno nvarchar(20),
			isoutside int,
			caseno nvarchar(20),
			driverno nvarchar(20),
			carteamno nvarchar(20),
			calctype nvarchar(20),
			mount2 float,--公司車
			mount3 float,--外車
			total2 float,--公司車
			total3 float,--外車
			times int--車次
	)
	create index noa on #z_trana8(noa)
	set @cmd = 
		"select '0' gno,'0' pno,(@t_acomp+'【請款明細表】'),a.noa,a.datea,a.trandate,a.po,a.custno,isnull(f.comp,''),a.custorde,'',isnull(f.serial,''),left(isnull(f.tel,''),20),a.straddr,a.product,"+
		"a.mount,a.price,a.total,a.carno,isnull(e.isoutside,''),a.caseno,a.driverno,a.carteamno,a.calctype,0,0,0,0,0"+
		" from  trans"+@t_accy+"  a "+
		" left join #carteam  b on a.carteamno=b.noa"+	
		" left join #calctype c on a.calctype=c.noa"+
		" left join carteam  d on a.carteamno=d.noa"+	
		" left join calctypes e on a.calctype=e.noa+e.noq"+
		" left join cust f on f.noa = a.custno "+
		" where "+
		"(isnull(a.datea,'') between @t_bdate and @t_edate) and "+
		"(isnull(a.trandate,'') between @t_btrandate and @t_etrandate) and "+
		"(isnull(a.custno,'') between @t_bcustno and @t_ecustno) and" +
		"(isnull(a.driverno,'') between @t_bdriverno and @t_edriverno) and"+
		"(len(@t_carno) = 0 or a.carno = @t_carno) and"+
		"(len(@t_po)=0 or a.po = @t_po) and"+
		"(a.straddrno between @t_baddrno and @t_eaddrno) and"+
		" (b.noa  is  not  null) and (c.noa  is  not  null)"
	insert into #z_trana8
	execute sp_executesql @cmd,N'@t_acomp  nvarchar(50),@t_bdate nvarchar(10),@t_edate nvarchar(10),@t_bcustno nvarchar(20),@t_ecustno nvarchar(20),@t_bdriverno  nvarchar(20),@t_edriverno  nvarchar(20),@t_carno  nvarchar(20),@t_po  nvarchar(20),@t_baddrno nvarchar(20),@t_eaddrno nvarchar(20),@t_btrandate nvarchar(10),@t_etrandate nvarchar(10)',
		@t_acomp=@t_acomp,@t_bdate=@t_bdate,@t_edate=@t_edate,@t_bcustno=@t_bcustno,@t_ecustno=@t_ecustno,@t_bdriverno=@t_bdriverno,@t_edriverno=@t_edriverno,@t_carno=@t_carno,@t_po=@t_po,@t_baddrno=@t_baddrno,@t_eaddrno=@t_eaddrno,@t_btrandate=@t_btrandate,@t_etrandate=@t_etrandate
	
	declare cursor_table cursor for
	select noa,custorde from #z_trana8
	open cursor_table
	fetch next from cursor_table
	into @noa,@string
	while(@@FETCH_STATUS <> -1)
	begin
		set @n = PATINDEX('%[0-9]%',@string)
		if(@n>1)
		begin
			set @string = substring(@string,@n,len(@string)-@n+1)+LEFT(@string,@n-1)
		end
		update #z_trana8 set newcustorde=@string where  noa=@noa
		
		fetch next from cursor_table
		into @noa,@string
	end
	close cursor_table
	deallocate cursor_table
	
	declare cursor_table cursor for
	select acomp,custno,comp,serial,tel,count(1) n,sum(mount),sum(total) from #z_trana8 group by acomp,custno,comp,serial,tel
	open cursor_table
	fetch next from cursor_table
	into @acomp,@custno,@comp,@serial,@tel,@n,@mount,@money
	while(@@FETCH_STATUS <> -1)
	begin
		select @mount2=0,@mount3=0,@money2=0,@money3=0
		select @mount2=isnull(SUM(isnull(mount,0)),0),@money2=isnull(sum(isnull(total,0)),0) from  #z_trana8  a
		left join calctypes b on a.calctype=b.noa+b.noq
		where  a.custno=@custno  and  not((b.noa+b.noq)is null) and b.isoutside!=1
		select @mount3=isnull(SUM(isnull(mount,0)),0),@money3=isnull(sum(isnull(total,0)),0) from  #z_trana8  a
		left join calctypes b on a.calctype=b.noa+b.noq
		where  a.custno=@custno  and  not((b.noa+b.noq)is null) and  b.isoutside=1

		insert into #z_trana8(gno,pno,acomp,custno,comp,serial,tel,mount,total,times,mount2,total2,mount3,total3)values('1','x',@acomp,@custno,@comp,@serial,@tel,@mount,@money,@n,@mount2,@money2,@mount3,@money3)
		set @n=(@n+2)%@minN
		while(@n!=0 and @n<@minN)
		begin
			insert into #z_trana8(gno,pno,acomp,custno,comp,serial,tel)values('0','y',@acomp,@custno,@comp,@serial,@tel)
			set @n = @n+1
		end
		insert into #z_trana8(gno,pno,acomp,custno,comp,serial,tel)values('2','z',@acomp,@custno,@comp,@serial,@tel)
		fetch next from cursor_table
		into @acomp,@custno,@comp,@serial,@tel,@n,@mount,@money
	end
	close cursor_table
	deallocate cursor_table
	
	declare @h1  char(104)
	declare @h2  char(104)
	set @h1=" 日   期 "+space(1)+" 起  迄  點 "+space(1)+" 品    名 "+SPACE(1)+" 數    量 "+SPACE(1)
			+" 單    價 "+SPACE(1)+" 金    額 "+SPACE(1)+" 車  號 "+SPACE(1)+" 憑 單 號 碼 "+SPACE(1)+" 貨 櫃 號 碼 "
	set @h2=REPLICATE('=',9)+SPACE(1)+REPLICATE('=',12)+SPACE(1)+REPLICATE('=',10)+SPACE(1)+REPLICATE('=',10)+SPACE(1) 
		+REPLICATE('=',10)+SPACE(1) +REPLICATE('=',10)+SPACE(1)+REPLICATE('=',8)+SPACE(1)+REPLICATE('=',13)+SPACE(1)+REPLICATE('=',13)+SPACE(1)  
	declare @tmp table(
		gno nvarchar(3),
		pno nvarchar(3),
		acomp nvarchar(50),
		custno  nvarchar(20),
		newcustorde  nvarchar(30),
		comp  nvarchar(50),
		serial nvarchar(20),
		tel nvarchar(20),
		po nvarchar(20),
		times int,
		h1 char(1000),
		h2 char(1000),
		memo char(1000),
		t1 char(1000),
		t2 char(1000),
		t3 char(1000)
	)
	set @cmd="select gno,pno,acomp,custno,newcustorde,comp,serial,tel,isnull(po,'')"+
	",times"+
	",@h1,@h2,("+
	"cast(isnull(trandate,'') as char(9))+space(1)+cast(isnull(straddr,'') as char(12))+space(1)+cast(isnull(product,'') as char(10))"+
	"+space(1)+right(space(10)+(reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,floor(mount)),1)),4,12))+left(right(convert(nvarchar,cast(mount  as  money),2),5),4)),10)"+
	"+space(1)+right(space(10)+(reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,floor(price)),1)),4,12))+left(right(convert(nvarchar,cast(price  as  money),2),5),4)),10)"+
	"+space(1)+right(space(10)+reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total),1)),4,12)),10)"+
	"+space(1)+cast(isnull(carno,'') as char(8))"+
	"+space(1)+cast(isnull(custorde,'') as char(13))"+
	"+space(1)+cast(isnull(caseno,'') as char(13))"+
	") memo"+
	",(space(25)+'合  計：'"+
	"+space(1)+right(space(10)+(reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,floor(mount)),1)),4,12))+left(right(convert(nvarchar,cast(mount  as  money),2),5),4)),10)"+
	"+space(12)+right(space(10)+reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total),1)),4,12)),10)"+
	")"+
	",(space(25)+'公司車：'"+
	"+space(1)+right(space(10)+(reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,floor(mount2)),1)),4,12))+left(right(convert(nvarchar,cast(mount2  as  money),2),5),4)),10)"+
	"+space(12)+right(space(10)+reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total2),1)),4,12)),10)"+
	")"+
	",(space(25)+'外  車：'"+
	"+space(1)+right(space(10)+(reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,floor(mount3)),1)),4,12))+left(right(convert(nvarchar,cast(mount3  as  money),2),5),4)),10)"+
	"+space(12)+right(space(10)+reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total3),1)),4,12)),10)"+
	")"+
	"  from  #z_trana8  order  by  custno,pno,gno,"+(case when @t_sort8='custorde' then 'newcustorde' else @t_sort8 end)+",noa"
	insert into @tmp
	execute sp_executesql @cmd,N'@h1 nvarchar(max),@h2 nvarchar(max)',@h1=@h1,@h2=@h2
	update @tmp set h1=REPLACE(h1,SPACE(1),'&nbsp'+char(59))
	,h2=REPLACE(h2,SPACE(1),'&nbsp'+char(59))
	,memo=REPLACE(memo,SPACE(1),'&nbsp'+char(59))
	,t1=REPLACE(t1,SPACE(1),'&nbsp'+char(59))
	,t2=REPLACE(t2,SPACE(1),'&nbsp'+char(59))
	,t3=REPLACE(t3,SPACE(1),'&nbsp'+char(59))
	select * from @tmp
	drop table #z_trana8;
	


z_trana7:--z_trana7    有PO案號的才會抓
	SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	declare @t_accy nvarchar(10)
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_bcustno nvarchar(30)
	declare @t_ecustno nvarchar(30)
	declare @t_bdriverno nvarchar(30)
	declare @t_edriverno nvarchar(30)
	declare @t_carno nvarchar(20)
	declare @t_po nvarchar(20)
	declare @t_addr nvarchar(20)
	declare @t_carteamno nvarchar(max)
	declare @t_calctype nvarchar(max)
	declare @t_other nvarchar(max)
	declare @t_calcmoney nvarchar(max)
	declare @t_sort8 nvarchar(max)
	declare @t_sort10 nvarchar(max)
	declare @t_sort3 nvarchar(max)
	declare @t_bsalesno nvarchar(20)
	declare @t_esalesno nvarchar(20)
	declare @t_field5 nvarchar(max)
	declare @t_yproduct nvarchar(max)
	declare @t_yaddr nvarchar(max)
	declare @t_yboatname nvarchar(max)
	declare @t_sort6 nvarchar(max)
	declare @t_carkindno nvarchar(max)
	declare @t_sort5 nvarchar(max)	
	declare @t_field13 nvarchar(max)	
	declare @t_sort13 nvarchar(max)	
	declare @t_field1 nvarchar(max)	
	declare @t_sort1 nvarchar(max)	
	declare @t_acomp nvarchar(max)	
	declare @t_sort14 nvarchar(max)
	declare @t_trandono nvarchar(max)
	declare @t_option14 nvarchar(max)
	declare @t_baddrno nvarchar(20)
	declare @t_eaddrno nvarchar(20)
	declare @t_btrandate nvarchar(10)
	declare @t_etrandate nvarchar(10)
	declare @t_plusmoney int
	declare @t_minusmoney int
	
	set @t_accy = [1]
	set @t_bdate = case when '#non'=[2] then '' else [2] end
	set @t_edate = case when '#non'=[3] then char(255) else [3] end
	set @t_bcustno = case when '#non'=[4] then '' else [4] end
	set @t_ecustno = case when '#non'=[5] then char(255) else [5] end
	set @t_bdriverno = case when '#non'=[6] then '' else [6] end
	set @t_edriverno = case when '#non'=[7] then char(255) else [7] end
	set @t_carno = case when '#non'=[8] then '' else [8] end
	set @t_po = case when '#non'=[9] then '' else [9] end
	set @t_addr = case when '#non'=[10] then '' else [10] end
	set @t_carteamno = case when '#non'=[11] then '' else [11] end
	set @t_calctype = case when '#non'=[12] then '' else [12] end
	set @t_other = case when '#non'=[13] then '' else [13] end
	set @t_calcmoney = case when '#non'=[14] then '' else [14] end
	set @t_sort8 = case when '#non'=[15] then '' else [15] end
	set @t_sort10 =  case when '#non'=[16] then '' else [16] end
	set @t_sort3 = case when '#non'=[17] then '' else [17] end
	set @t_bsalesno = case when '#non'=[18] then '' else [18] end
	set @t_esalesno = case when '#non'=[19] then char(255) else [19] end
	set @t_field5 = case when '#non'=[20] then '' else [20] end
	set @t_yproduct = case when '#non'=[21] then '' else [21] end
	set @t_yaddr = case when '#non'=[22] then '' else [22] end
	set @t_yboatname = case when '#non'=[23] then '' else [23] end
	set @t_sort6 = case when '#non'=[24] then '' else [24] end
	set @t_carkindno = case when '#non'=[25] then '' else [25] end
	set @t_sort5 = case when '#non'=[26] then '' else [26] end
	set @t_field13 = case when '#non'=[27] then '' else [27] end
	set @t_sort13 = case when '#non'=[28] then '' else [28] end
	set @t_field1 = case when '#non'=[29] then '' else [29] end
	set @t_sort1 = case when '#non'=[30] then '' else [30] end
	set @t_acomp = case when '#non'=[31] then '' else [31] end
	set @t_sort14 = case when '#non'=[32] then '' else [32] end
	set @t_trandono = case when '#non'=[33] then '' else [33] end
	set @t_option14 = case when '#non'=[34] then '' else [34] end
	set @t_baddrno = case when '#non'=[35] then '' else [35] end
	set @t_eaddrno = case when '#non'=[36] then char(255) else [36] end
	set @t_btrandate = case when '#non'=[37] then '' else [37] end
	set @t_etrandate = case when '#non'=[38] then char(255) else [38] end
	set @t_plusmoney = case when '#non'=[39] then '0' else cast([39] as int) end
	set @t_minusmoney = case when '#non'=[40]then '0' else cast([40] as int) end
	------------------------------------------------------------------------------------------------------------------
	declare @minN int
	set @minN = 21
	declare @calctypeno nvarchar(10)
	declare @carkind nvarchar(20)
	declare @carkindno nvarchar(10)
	declare @carno nvarchar(20)
	declare @caryear nvarchar(20)
	declare @comp nvarchar(40)
	declare @custno nvarchar(20)
	declare @cylinder int
	declare @datea nvarchar(10)
	declare @day int
	declare @driver nvarchar(20)
	declare @driverno nvarchar(20)
	declare @fieldh nvarchar(20)
	declare @fieldm nvarchar(20)
	declare @header nvarchar(20)
	declare @isDiscount int
	declare @isSum int
	declare @key nvarchar(20)
	declare @miles float
	declare @mon nvarchar(10)
	declare @money float
	declare @mount float
	declare @n int
	declare @namea nvarchar(30)
	declare @noa nvarchar(30)
	declare @po nvarchar(30)
	declare @product float
	declare @resverve float
	declare @sort nvarchar(max)
	declare @string nvarchar(max)
	declare @tolls float
	declare @trandono nvarchar(20)
	-------------------------------------------------------------------------------------------------------------
	--解析要計算的種類
	IF OBJECT_ID('tempdb..#carteam')is not null
	BEGIN
		set @cmd = 'drop table #carteam'
		EXECUTE sp_executesql @cmd
	END
	create table #carteam(
		noa nvarchar(10)
	)
	set @string = @t_carteamno
	while(1=1 and LEN(@string)>0)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #carteam select @string
			end
			break
		end
		insert into #carteam select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	IF OBJECT_ID('tempdb..#calctype')is not null
	BEGIN
		set @cmd = 'drop table #calctype'
		EXECUTE sp_executesql @cmd
	END
	create table #calctype(
		noa nvarchar(10)
	)
	set @string = @t_calctype
	while(1=1 and LEN(@string)>0)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #calctype select @string
			end
			break
		end
		insert into #calctype select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	IF OBJECT_ID('tempdb..#carkind')is not null
	BEGIN
		set @cmd = 'drop table #carkind'
		EXECUTE sp_executesql @cmd
	END
	create table #carkind(
		noa nvarchar(10)
	)
	set @string = @t_carkindno
	while(1=1 and LEN(@string)>0)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #carkind select @string
			end
			break
		end
		insert into #carkind select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end

	set @isDiscount=0
	set @string = @t_other
	while(1=1 and LEN(@string)>0)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				if  @string='discount'
					set  @isDiscount  =  1
			end
			break
		end
		if   LEFT(@string,@n-1)='discount'
			set  @isDiscount  =  1
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	declare @display table(
		noa nvarchar(20)
	)
	
	set @string = case 
					when len(@t_field5)>0 then @t_field5
					when LEN(@t_field13)>0 then @t_field13
					when LEN(@t_field1)>0 then @t_field1
				end					
	while(1=1 and LEN(@string)>0)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into @display select @string
			end
			break
		end
		insert into @display select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	---------------------------------------------------------------------------------------
	-------------------------------------------------------------------------------------------------------------
	IF OBJECT_ID('tempdb..#z_trana7')is not null
	BEGIN
		set @cmd = 'drop table #z_trana7'
		EXECUTE sp_executesql @cmd
	END
	create table  #z_trana7(
		gno nvarchar(3),
		p nvarchar(3),
		acomp  nvarchar(50),
		custno nvarchar(20),
		comp nvarchar(40),
		memo varchar(1000),
		noa nvarchar(20),
		trandate char(9),
		custorde char(30),
		caseno char(20),
		[money] float,
		cmoney char(7),
		po char(16),
		product char(12),
		addr char(23),
		boatname char(24),
		trandono nvarchar(20)
	)
	declare @h1 varchar(120)
	declare @h2 varchar(120)
	declare @h3 varchar(120)
	set @h1 = SPACE(1)+'運輸日期'+SPACE(1)+'憑單號碼'+SPACE(3)+'貨櫃號碼'+SPACE(5)+'金'+SPACE(3)+'額'+SPACE(1)+
			'P/O號碼'+SPACE(10)+'貨品名稱'+SPACE(5)+'起訖地點'+SPACE(16)+'船名'+SPACE(18)
	set @h2 = REPLICATE('=',9)+SPACE(1)+REPLICATE('=',10)+SPACE(1)+REPLICATE('=',12)+SPACE(1)+REPLICATE('=',7)+SPACE(1)+
			REPLICATE('=',16)+SPACE(1)++REPLICATE('=',12)+SPACE(1)++REPLICATE('=',23)+SPACE(1)++REPLICATE('=',24)
	set @h3 = REPLICATE('-',120)
	
	set @cmd= 
	" select '0','2','',a.custno,e.comp,'',a.noa,a.trandate,left(convert(char(30),a.custorde ),10),left(convert(char(30),a.caseno ),16)"+
	" ,total,reverse(substring(reverse(convert(nvarchar(10),CONVERT(money,a.total),1)),4,7))"+
	" ,a.po"+
	" ,case when g.noa is null then a.product else f.product end"+
	" ,case when g.noa is null then a.straddr else f.addr end"+
	" ,case when g.noa is null then a.boatname else g.boatname end"+
	" ,isnull(g.deliveryno,'')"+
	" from trans"+@t_accy+" a"+
	" left join #calctype b on a.calctype=b.noa"+
	" left join calctype c on left(a.calctype,1)=c.noa"+
	" left join #carteam d on a.carteamno=d.noa"+
	" left join cust e on a.custno=e.noa"+
	" left join trandos f on a.noa=f.tranno  and  a.noq=f.trannoq"+
	" left join trando g on f.noa=g.noa"+
	" where a.calctype=b.noa  and  a.carteamno=d.noa "+
	"	and (len(@t_carno)=0 or a.carno=@t_carno)"+
	"	and (a.datea between @t_bdate and @t_edate)"+
	"	and (a.custno between @t_bcustno and @t_ecustno)"+
	"	and (a.driverno between @t_bdriverno and @t_edriverno)"+
	"	and (len(@t_po)=0 or a.po=@t_po) and len(a.po)>0"+
	"   and (len(@t_addr)=0 or a.straddrno=@t_addr or a.straddr=@t_addr)"+
	" and (len(@t_trandono)=0 or g.deliveryno=@t_trandono)"
	insert into #z_trana7
	EXECUTE sp_executesql @cmd,N'@t_trandono nvarchar(30),@t_addr nvarchar(20),@t_bdate nvarchar(10),@t_edate nvarchar(10),@t_bdriverno nvarchar(20),@t_edriverno nvarchar(20),@t_carno nvarchar(20),@t_bcustno nvarchar(20),@t_ecustno nvarchar(20),@t_po nvarchar(30)',
	@t_trandono=@t_trandono,@t_addr=@t_addr,@t_bdate=@t_bdate,@t_edate=@t_edate,@t_bdriverno=@t_bdriverno,@t_edriverno=@t_edriverno,@t_carno=@t_carno,@t_bcustno=@t_bcustno,@t_ecustno=@t_ecustno,@t_po=@t_po

	set @cmd="update #z_trana7 set memo=isnull(trandate,space(9))+SPACE(1)+isnull(left(custorde,10),space(10))+SPACE(1)+isnull(left(caseno,12),space(12))+SPACE(1)+isnull(right(space(7)+rtrim(cmoney),7),space(7))+SPACE(1)+isnull(po,space(16))+SPACE(1)+"
	if len(@t_yproduct)=0
	set @cmd = @cmd + "isnull(product,space(12))+SPACE(1)+"
	else
	set @cmd = @cmd + "convert(char(12),isnull(@t_yproduct,space(12)))+SPACE(1)+"
	if LEN(@t_yaddr)=0
	set @cmd = @cmd + "isnull(addr,space(23))+SPACE(1)+"	
	else
	set @cmd = @cmd + "convert(char(23),isnull(@t_yaddr,space(23)))+SPACE(1)+"
	if LEN(@t_yboatname)=0
	set @cmd = @cmd + "isnull(boatname,space(24))"
	else
	set @cmd = @cmd + "convert(char(24),isnull(@t_yboatname,space(24)))"
	EXECUTE sp_executesql  @cmd,N'@t_yproduct nvarchar(max),@t_yaddr nvarchar(max),@t_yboatname nvarchar(max)',
	@t_yproduct=@t_yproduct,@t_yaddr=@t_yaddr,@t_yboatname=@t_yboatname
	
	declare cursor_table cursor for
	select custno,comp,po,trandono,count(1),sum(isnull([money],0))
	from #z_trana7 group by custno,comp,po,trandono
	open cursor_table
	fetch next from cursor_table
	into @custno,@comp,@po,@trandono,@mount,@money
	while(@@FETCH_STATUS <> -1)
	begin
		insert into #z_trana7(gno,p,custno,comp,po,trandono,memo)values('0','0',@custno,@comp,@po,@trandono,@h1)
		insert into #z_trana7(gno,p,custno,comp,po,trandono,memo)values('0','1',@custno,@comp,@po,@trandono,@h2)
		insert into #z_trana7(gno,p,custno,po,trandono,memo)values('0','3',@custno,@po,@trandono,@h3)
		insert into #z_trana7(gno,p,custno,po,trandono,memo)values('0','4',@custno,@po,@trandono,'共'+right(space(5)+rtrim(CONVERT(char(5),@mount)),5)+' 只'+SPACE(11)+'合計金額：'+reverse(substring(reverse(convert(char(13),CONVERT(money,@money),1)),4,10)))
		insert into #z_trana7(gno,custno,po,trandono)values('1',@custno,@po,@trandono)
		fetch next from cursor_table
		into @custno,@comp,@po,@trandono,@mount,@money
	end
	close cursor_table
	deallocate cursor_table
	
	update  #z_trana7  set acomp=rtrim(@t_acomp)+'【請款明細表】',  memo=REPLACE(memo,SPACE(1),'&nbsp'+char(59))
	select * from #z_trana7 order by custno,po,trandono,gno,p,noa;


	


z_trana13:--z_trana13
	SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	declare @t_accy nvarchar(10)
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_bcustno nvarchar(30)
	declare @t_ecustno nvarchar(30)
	declare @t_bdriverno nvarchar(30)
	declare @t_edriverno nvarchar(30)
	declare @t_carno nvarchar(20)
	declare @t_po nvarchar(20)
	declare @t_addr nvarchar(20)
	declare @t_carteamno nvarchar(max)
	declare @t_calctype nvarchar(max)
	declare @t_other nvarchar(max)
	declare @t_calcmoney nvarchar(max)
	declare @t_sort8 nvarchar(max)
	declare @t_sort10 nvarchar(max)
	declare @t_sort3 nvarchar(max)
	declare @t_bsalesno nvarchar(20)
	declare @t_esalesno nvarchar(20)
	declare @t_field5 nvarchar(max)
	declare @t_yproduct nvarchar(max)
	declare @t_yaddr nvarchar(max)
	declare @t_yboatname nvarchar(max)
	declare @t_sort6 nvarchar(max)
	declare @t_carkindno nvarchar(max)
	declare @t_sort5 nvarchar(max)	
	declare @t_field13 nvarchar(max)	
	declare @t_sort13 nvarchar(max)	
	declare @t_field1 nvarchar(max)	
	declare @t_sort1 nvarchar(max)	
	declare @t_acomp nvarchar(max)	
	declare @t_sort14 nvarchar(max)
	declare @t_trandono nvarchar(max)
	declare @t_option14 nvarchar(max)
	declare @t_baddrno nvarchar(20)
	declare @t_eaddrno nvarchar(20)
	declare @t_btrandate nvarchar(10)
	declare @t_etrandate nvarchar(10)
	declare @t_plusmoney int
	declare @t_minusmoney int
	
	set @t_accy = [1]
	set @t_bdate = case when '#non'=[2] then '' else [2] end
	set @t_edate = case when '#non'=[3] then char(255) else [3] end
	set @t_bcustno = case when '#non'=[4] then '' else [4] end
	set @t_ecustno = case when '#non'=[5] then char(255) else [5] end
	set @t_bdriverno = case when '#non'=[6] then '' else [6] end
	set @t_edriverno = case when '#non'=[7] then char(255) else [7] end
	set @t_carno = case when '#non'=[8] then '' else [8] end
	set @t_po = case when '#non'=[9] then '' else [9] end
	set @t_addr = case when '#non'=[10] then '' else [10] end
	set @t_carteamno = case when '#non'=[11] then '' else [11] end
	set @t_calctype = case when '#non'=[12] then '' else [12] end
	set @t_other = case when '#non'=[13] then '' else [13] end
	set @t_calcmoney = case when '#non'=[14] then '' else [14] end
	set @t_sort8 = case when '#non'=[15] then '' else [15] end
	set @t_sort10 =  case when '#non'=[16] then '' else [16] end
	set @t_sort3 = case when '#non'=[17] then '' else [17] end
	set @t_bsalesno = case when '#non'=[18] then '' else [18] end
	set @t_esalesno = case when '#non'=[19] then char(255) else [19] end
	set @t_field5 = case when '#non'=[20] then '' else [20] end
	set @t_yproduct = case when '#non'=[21] then '' else [21] end
	set @t_yaddr = case when '#non'=[22] then '' else [22] end
	set @t_yboatname = case when '#non'=[23] then '' else [23] end
	set @t_sort6 = case when '#non'=[24] then '' else [24] end
	set @t_carkindno = case when '#non'=[25] then '' else [25] end
	set @t_sort5 = case when '#non'=[26] then '' else [26] end
	set @t_field13 = case when '#non'=[27] then '' else [27] end
	set @t_sort13 = case when '#non'=[28] then '' else [28] end
	set @t_field1 = case when '#non'=[29] then '' else [29] end
	set @t_sort1 = case when '#non'=[30] then '' else [30] end
	set @t_acomp = case when '#non'=[31] then '' else [31] end
	set @t_sort14 = case when '#non'=[32] then '' else [32] end
	set @t_trandono = case when '#non'=[33] then '' else [33] end
	set @t_option14 = case when '#non'=[34] then '' else [34] end
	set @t_baddrno = case when '#non'=[35] then '' else [35] end
	set @t_eaddrno = case when '#non'=[36] then char(255) else [36] end
	set @t_btrandate = case when '#non'=[37] then '' else [37] end
	set @t_etrandate = case when '#non'=[38] then char(255) else [38] end
	set @t_plusmoney = case when '#non'=[39] then '0' else cast([39] as int) end
	set @t_minusmoney = case when '#non'=[40]then '0' else cast([40] as int) end
	------------------------------------------------------------------------------------------------------------------
	declare @minN int
	set @minN = 21
	declare @calctypeno nvarchar(10)
	declare @carkind nvarchar(20)
	declare @carkindno nvarchar(10)
	declare @carno nvarchar(20)
	declare @caryear nvarchar(20)
	declare @cylinder int
	declare @datea nvarchar(10)
	declare @day int
	declare @driver nvarchar(20)
	declare @driverno nvarchar(20)
	declare @fieldh nvarchar(20)
	declare @fieldm nvarchar(20)
	declare @header nvarchar(20)
	declare @isDiscount int
	declare @isSum int
	declare @key nvarchar(20)
	declare @miles float
	declare @mon nvarchar(10)
	declare @money float
	declare @mount float
	declare @n int
	declare @namea nvarchar(30)
	declare @noa nvarchar(30)
	declare @product float
	declare @resverve float
	declare @sort nvarchar(max)
	declare @string nvarchar(max)
	declare @tolls float
	------------------------------------------------------------------------------------------------------------------
	--解析要計算的種類
	IF OBJECT_ID('tempdb..#carteam')is not null
	BEGIN
		set @cmd = 'drop table #carteam'
		EXECUTE sp_executesql @cmd
	END
	create table #carteam(
		noa nvarchar(10)
	)
	set @string = @t_carteamno
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #carteam select @string
			end
			break
		end
		insert into #carteam select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	IF OBJECT_ID('tempdb..#calctype')is not null
	BEGIN
		set @cmd = 'drop table #calctype'
		EXECUTE sp_executesql @cmd
	END
	create table #calctype(
		noa nvarchar(10)
	)
	set @string = @t_calctype
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #calctype select @string
			end
			break
		end
		insert into #calctype select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	IF OBJECT_ID('tempdb..#carkind')is not null
	BEGIN
		set @cmd = 'drop table #carkind'
		EXECUTE sp_executesql @cmd
	END
	create table #carkind(
		noa nvarchar(10)
	)
	set @string = @t_carkindno
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #carkind select @string
			end
			break
		end
		insert into #carkind select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end

	set @isDiscount=0
	set @string = @t_other
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				if  @string='discount'
					set  @isDiscount  =  1
			end
			break
		end
		if   LEFT(@string,@n-1)='discount'
			set  @isDiscount  =  1
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	declare @display table(
		noa nvarchar(20)
	)
	
	set @string = case 
					when len(@t_field5)>0 then @t_field5
					when LEN(@t_field13)>0 then @t_field13
					when LEN(@t_field1)>0 then @t_field1
				end					
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into @display select @string
			end
			break
		end
		insert into @display select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	--=========================================================================================================
	-------------------------------------------------------------------------------------------------------------
	--記錄欄位
	declare @field table(
		[key] nvarchar(20),
		fieldh nvarchar(10),
		fieldm nvarchar(10),
		[header] nvarchar(40),
		product float,
		isSum bit,
		sort nvarchar(10)
	)
	-------------------------------------------------------------------------------------------------------------
	--暫存資料
	IF OBJECT_ID('tempdb..#z_trana13')is not null
	BEGIN
		set @cmd = 'drop table #z_trana13'
		EXECUTE sp_executesql @cmd
	END
	create table #z_trana13(
		gno nvarchar(3),
		carno nvarchar(20),
		carkindno nvarchar(20),
		driverno nvarchar(20),
		mon nvarchar(20),
		tranmoney float,
		miles float,
		oilmount float,
		oilmoney float,
		rowheader nvarchar(20)
		
		primary key(carkindno,gno,carno,driverno,mon)
	)
	-------------------------------------------------------------------------------------------------------------
	--車輛種類
	if exists(select * from @display where noa='carkind')
	begin
		select @n= COUNT(1) from @field
		set @n = @n + 1
		set @fieldh = "h"+right("00"+CONVERT(nvarchar(10),@n),3)
		set @fieldm = "m"+right("00"+CONVERT(nvarchar(10),@n),3)
		
		insert into @field([key],fieldh,fieldm,[header],product)
			values('carkind',@fieldh,@fieldm,'類別',0)
		
		set @cmd = "alter table #z_trana13 add "+@fieldh+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_trana13 add "+@fieldm+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
	end
	--年份
	if exists(select * from @display where noa='caryear')
	begin
		select @n= COUNT(1) from @field
		set @n = @n + 1
		set @fieldh = "h"+right("00"+CONVERT(nvarchar(10),@n),3)
		set @fieldm = "m"+right("00"+CONVERT(nvarchar(10),@n),3)
		
		insert into @field([key],fieldh,fieldm,[header],product)
			values('caryear',@fieldh,@fieldm,'年份',0)
		
		set @cmd = "alter table #z_trana13 add "+@fieldh+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_trana13 add "+@fieldm+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
	end
	--汽缸
	if exists(select * from @display where noa='cylinder')
	begin
		select @n= COUNT(1) from @field
		set @n = @n + 1
		set @fieldh = "h"+right("00"+CONVERT(nvarchar(10),@n),3)
		set @fieldm = "m"+right("00"+CONVERT(nvarchar(10),@n),3)
		
		insert into @field([key],fieldh,fieldm,[header],product)
			values('cylinder',@fieldh,@fieldm,'汽缸',0)
		
		set @cmd = "alter table #z_trana13 add "+@fieldh+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_trana13 add "+@fieldm+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
	end
	--耗油比
	if exists(select * from @display where noa='rate1')
	begin
		select @n= COUNT(1) from @field
		set @n = @n + 1
		set @fieldh = "h"+right("00"+CONVERT(nvarchar(10),@n),3)
		set @fieldm = "m"+right("00"+CONVERT(nvarchar(10),@n),3)
		
		insert into @field([key],fieldh,fieldm,[header],product,sort)
			values('rate1',@fieldh,@fieldm,'耗油比',0,@fieldm+' desc')
		
		set @cmd = "alter table #z_trana13 add "+@fieldh+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_trana13 add "+@fieldm+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
	end
	--日數
	if exists(select * from @display where noa='day')
	begin
		select @n= COUNT(1) from @field
		set @n = @n + 1
		set @fieldh = "h"+right("00"+CONVERT(nvarchar(10),@n),3)
		set @fieldm = "m"+right("00"+CONVERT(nvarchar(10),@n),3)
		
		insert into @field([key],fieldh,fieldm,[header],product,sort)
			values('day',@fieldh,@fieldm,'日數',0,@fieldm+' desc')
		
		set @cmd = "alter table #z_trana13 add "+@fieldh+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_trana13 add "+@fieldm+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
	end
	--公里/升
	if exists(select * from @display where noa='rate2')
	begin
		select @n= COUNT(1) from @field
		set @n = @n + 1
		set @fieldh = "h"+right("00"+CONVERT(nvarchar(10),@n),3)
		set @fieldm = "m"+right("00"+CONVERT(nvarchar(10),@n),3)
		
		insert into @field([key],fieldh,fieldm,[header],product,sort)
			values('rate2',@fieldh,@fieldm,'公里/升',0,@fieldm+' desc')
		
		set @cmd = "alter table #z_trana13 add "+@fieldh+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_trana13 add "+@fieldm+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
	end
	--車牌
	if exists(select * from @display where noa='carno')
	begin
		select @n= COUNT(1) from @field
		set @n = @n + 1
		set @fieldh = "h"+right("00"+CONVERT(nvarchar(10),@n),3)
		set @fieldm = "m"+right("00"+CONVERT(nvarchar(10),@n),3)
		
		insert into @field([key],fieldh,fieldm,[header],product)
			values('carno',@fieldh,@fieldm,'車牌',0)
		
		set @cmd = "alter table #z_trana13 add "+@fieldh+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_trana13 add "+@fieldm+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
	end
	--司機
	if exists(select * from @display where noa='driver')
	begin
		select @n= COUNT(1) from @field
		set @n = @n + 1
		set @fieldh = "h"+right("00"+CONVERT(nvarchar(10),@n),3)
		set @fieldm = "m"+right("00"+CONVERT(nvarchar(10),@n),3)
		
		insert into @field([key],fieldh,fieldm,[header],product)
			values('driver',@fieldh,@fieldm,'司機',0)
		
		set @cmd = "alter table #z_trana13 add "+@fieldh+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_trana13 add "+@fieldm+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
	end
	--月份
	if exists(select * from @display where noa='mon')
	begin
		select @n= COUNT(1) from @field
		set @n = @n + 1
		set @fieldh = "h"+right("00"+CONVERT(nvarchar(10),@n),3)
		set @fieldm = "m"+right("00"+CONVERT(nvarchar(10),@n),3)
		
		insert into @field([key],fieldh,fieldm,[header],product)
			values('mon',@fieldh,@fieldm,'月份',0)
		
		set @cmd = "alter table #z_trana13 add "+@fieldh+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_trana13 add "+@fieldm+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
	end
	--計算類別
	declare cursor_table cursor for
	select a.noa,a.namea from calctype a
	left join calctypes b on a.noa=b.noa
	left join #calctype c on b.noa+b.noq=c.noa
	where b.noa+b.noq=c.noa
	group by a.noa,a.namea
	open cursor_table
	fetch next from cursor_table
	into @noa,@namea
	while(@@FETCH_STATUS <> -1)
	begin
		select @n= COUNT(1) from @field
		set @n = @n + 1
		set @fieldh = "h"+right("00"+CONVERT(nvarchar(10),@n),3)
		set @fieldm = "m"+right("00"+CONVERT(nvarchar(10),@n),3)
		
		insert into @field([key],fieldh,fieldm,[header],product,isSum,sort)
			values('calctype_'+@noa,@fieldh,@fieldm,@namea+'收入',1,1,'m'+@fieldm+' desc')
		
		set @cmd = "alter table #z_trana13 add "+@fieldh+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_trana13 add "+@fieldm+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_trana13 add m"+@fieldm+" float"
		EXECUTE sp_executesql @cmd
		
		fetch next from cursor_table
		into @noa,@namea
	end
	close cursor_table
	deallocate cursor_table
	--油費
	if exists(select * from @display where noa='oil')
	begin
		select @n= COUNT(1) from @field
		set @n = @n + 1
		set @fieldh = "h"+right("00"+CONVERT(nvarchar(10),@n),3)
		set @fieldm = "m"+right("00"+CONVERT(nvarchar(10),@n),3)
		
		insert into @field([key],fieldh,fieldm,[header],product,isSum,sort)
			values('oil',@fieldh,@fieldm,'油費',-1,1,'m'+@fieldm+' desc')
		
		set @cmd = "alter table #z_trana13 add "+@fieldh+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_trana13 add "+@fieldm+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_trana13 add m"+@fieldm+" float"
		EXECUTE sp_executesql @cmd
	end
	--修理費
	if exists(select * from @display where noa='fixa')
	begin
		select @n= COUNT(1) from @field
		set @n = @n + 1
		set @fieldh = "h"+right("00"+CONVERT(nvarchar(10),@n),3)
		set @fieldm = "m"+right("00"+CONVERT(nvarchar(10),@n),3)
		
		insert into @field([key],fieldh,fieldm,[header],product,isSum,sort)
			values('fixa',@fieldh,@fieldm,'修理費',-1,1,'m'+@fieldm+' desc')
		
		set @cmd = "alter table #z_trana13 add "+@fieldh+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_trana13 add "+@fieldm+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_trana13 add m"+@fieldm+" float"
		EXECUTE sp_executesql @cmd
	end
	--輪胎費
	if exists(select * from @display where noa='tire')
	begin
		select @n= COUNT(1) from @field
		set @n = @n + 1
		set @fieldh = "h"+right("00"+CONVERT(nvarchar(10),@n),3)
		set @fieldm = "m"+right("00"+CONVERT(nvarchar(10),@n),3)
		
		insert into @field([key],fieldh,fieldm,[header],product,isSum,sort)
			values('tire',@fieldh,@fieldm,'輪胎費',-1,1,'m'+@fieldm+' desc')
		
		set @cmd = "alter table #z_trana13 add "+@fieldh+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_trana13 add "+@fieldm+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_trana13 add m"+@fieldm+" float"
		EXECUTE sp_executesql @cmd
	end
	--通行費
	if exists(select * from @display where noa='tolls')
	begin
		select @n= COUNT(1) from @field
		set @n = @n + 1
		set @fieldh = "h"+right("00"+CONVERT(nvarchar(10),@n),3)
		set @fieldm = "m"+right("00"+CONVERT(nvarchar(10),@n),3)
		
		insert into @field([key],fieldh,fieldm,[header],product,isSum,sort)
			values('tolls',@fieldh,@fieldm,'通行費',-1,1,'m'+@fieldm+' desc')
		
		set @cmd = "alter table #z_trana13 add "+@fieldh+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_trana13 add "+@fieldm+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_trana13 add m"+@fieldm+" float"
		EXECUTE sp_executesql @cmd
	end
	--罰款
	if exists(select * from @display where noa='ticket')
	begin
		select @n= COUNT(1) from @field
		set @n = @n + 1
		set @fieldh = "h"+right("00"+CONVERT(nvarchar(10),@n),3)
		set @fieldm = "m"+right("00"+CONVERT(nvarchar(10),@n),3)
		
		insert into @field([key],fieldh,fieldm,[header],product,isSum,sort)
			values('ticket',@fieldh,@fieldm,'罰款',-1,1,'m'+@fieldm+' desc')
		
		set @cmd = "alter table #z_trana13 add "+@fieldh+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_trana13 add "+@fieldm+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_trana13 add m"+@fieldm+" float"
		EXECUTE sp_executesql @cmd
	end
	--寄櫃費
	if exists(select * from @display where noa='reserve')
	begin
		select @n= COUNT(1) from @field
		set @n = @n + 1
		set @fieldh = "h"+right("00"+CONVERT(nvarchar(10),@n),3)
		set @fieldm = "m"+right("00"+CONVERT(nvarchar(10),@n),3)
		
		insert into @field([key],fieldh,fieldm,[header],product,isSum,sort)
			values('reserve',@fieldh,@fieldm,'寄櫃費',-1,1,'m'+@fieldm+' desc')
		
		set @cmd = "alter table #z_trana13 add "+@fieldh+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_trana13 add "+@fieldm+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_trana13 add m"+@fieldm+" float"
		EXECUTE sp_executesql @cmd
	end
	--薪資
	if exists(select * from @display where noa='carsal')
	begin
		select @n= COUNT(1) from @field
		set @n = @n + 1
		set @fieldh = "h"+right("00"+CONVERT(nvarchar(10),@n),3)
		set @fieldm = "m"+right("00"+CONVERT(nvarchar(10),@n),3)
		
		insert into @field([key],fieldh,fieldm,[header],product,isSum,sort)
			values('carsal',@fieldh,@fieldm,'薪資',-1,1,'m'+@fieldm+' desc')
		
		set @cmd = "alter table #z_trana13 add "+@fieldh+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_trana13 add "+@fieldm+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_trana13 add m"+@fieldm+" float"
		EXECUTE sp_executesql @cmd
	end
	--保牌燃費
	if exists(select * from @display where noa='tax')
	begin
		select @n= COUNT(1) from @field
		set @n = @n + 1
		set @fieldh = "h"+right("00"+CONVERT(nvarchar(10),@n),3)
		set @fieldm = "m"+right("00"+CONVERT(nvarchar(10),@n),3)
		
		insert into @field([key],fieldh,fieldm,[header],product,isSum,sort)
			values('tax',@fieldh,@fieldm,'保牌燃費',-1,1,'m'+@fieldm+' desc')
		
		set @cmd = "alter table #z_trana13 add "+@fieldh+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_trana13 add "+@fieldm+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_trana13 add m"+@fieldm+" float"
		EXECUTE sp_executesql @cmd
	end
	--折舊
	if exists(select * from @display where noa='depreciation')
	begin
		select @n= COUNT(1) from @field
		set @n = @n + 1
		set @fieldh = "h"+right("00"+CONVERT(nvarchar(10),@n),3)
		set @fieldm = "m"+right("00"+CONVERT(nvarchar(10),@n),3)
		
		insert into @field([key],fieldh,fieldm,[header],product,isSum,sort)
			values('depreciation',@fieldh,@fieldm,'折舊',-1,1,'m'+@fieldm+' desc')
		
		set @cmd = "alter table #z_trana13 add "+@fieldh+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_trana13 add "+@fieldm+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_trana13 add m"+@fieldm+" float"
		EXECUTE sp_executesql @cmd
	end
	--淨利
	if exists(select * from @display where noa='profit')
	begin
		select @n= COUNT(1) from @field
		set @n = @n + 1
		set @fieldh = "h"+right("00"+CONVERT(nvarchar(10),@n),3)
		set @fieldm = "m"+right("00"+CONVERT(nvarchar(10),@n),3)
		
		insert into @field([key],fieldh,fieldm,[header],product,isSum,sort)
			values('profit',@fieldh,@fieldm,'淨利',0,1,'m'+@fieldm+' desc')
		
		set @cmd = "alter table #z_trana13 add "+@fieldh+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_trana13 add "+@fieldm+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_trana13 add m"+@fieldm+" float"
		EXECUTE sp_executesql @cmd
	end
	--**
	select @n= COUNT(1) from @field
	while(@n<@minN)
	begin
		set @n = @n + 1
		set @fieldh = "h"+right("00"+CONVERT(nvarchar(10),@n),3)
		set @fieldm = "m"+right("00"+CONVERT(nvarchar(10),@n),3)
		insert into @field([key],fieldh,fieldm,[header],product,isSum)
			values(null,@fieldh,@fieldm,null,null,null)
		
		set @cmd = "alter table #z_trana13 add "+@fieldh+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_trana13 add "+@fieldm+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
	end
	--************************************************************************************************************
	--出車單: 收入
	declare @tmp1 table(
		carkindno nvarchar(20),
		carno nvarchar(20),
		driverno nvarchar(20),
		datea nvarchar(20),
		calctypeno nvarchar(10),
		[money] float,
		miles float
	)
	set @cmd =
		" select isnull(e.carkindno,''),a.carno,a.driverno,isnull(a.datea,''),c.noa,"+
		" sum(isnull(round("+@t_calcmoney+",0),0)) [money],"+
		" sum(isnull(a.miles,0)) miles"+
		" from trans"+@t_accy+" a"+
		" left join #calctype b on a.calctype=b.noa"+
		" left join calctype c on left(a.calctype,1)=c.noa"+
		" left join car2 e on a.carno=e.noa"+
		" left join #carkind f on e.carkindno=f.noa"+
		" where a.calctype=b.noa  and (not f.noa is null)"+
		" and (len(@t_carno)=0 or a.carno=@t_carno)"+
		" and (a.datea between @t_bdate and @t_edate)"+
		" and (a.custno between @t_bcustno and @t_ecustno)"+
		" and (a.driverno between @t_bdriverno and @t_edriverno)"+
		" and (len(@t_po)=0 or a.po=@t_po)"+
		" group by isnull(e.carkindno,''),a.carno,a.driverno,a.datea,c.noa"	
	insert into @tmp1
	EXECUTE sp_executesql @cmd,N'@t_bdate nvarchar(10),@t_edate nvarchar(10),@t_bdriverno nvarchar(20),@t_edriverno nvarchar(20),@t_carno nvarchar(20),@t_bcustno  nvarchar(20),@t_ecustno  nvarchar(20),@t_po  nvarchar(30)',
		@t_bdate=@t_bdate,@t_edate=@t_edate,@t_bdriverno=@t_bdriverno,@t_edriverno=@t_edriverno,@t_carno=@t_carno,@t_bcustno=@t_bcustno,@t_ecustno=@t_ecustno,@t_po=@t_po
	
	declare cursor_table cursor for
	select carkindno,carno,driverno,left(datea,6),calctypeno,sum([money]),sum(miles) from @tmp1 where [money]!=0 group by carkindno,carno,driverno,left(datea,6),calctypeno
	open cursor_table
	fetch next from cursor_table
	into @carkindno,@carno,@driverno,@mon,@calctypeno,@money,@miles
	while(@@FETCH_STATUS <> -1)
	begin
		if not exists(select * from #z_trana13 where carno=@carno and carkindno=@carkindno and driverno=@driverno and mon=@mon)
		begin
			insert into #z_trana13(gno,carno,carkindno,driverno,mon)values('0',@carno,@carkindno,@driverno,@mon)
		end
			
		set @fieldm = ''
		select @fieldm=fieldm from @field where [key]='calctype_'+@calctypeno
		if LEN(@fieldm)>0
		begin
			set @cmd = "update #z_trana13 set tranmoney=isnull(tranmoney,0)+@money,miles=isnull(miles,0)+@miles,"+@fieldm+"=reverse(substring(reverse(convert(char(15),CONVERT(money,@money),1)),4,12)),m"+@fieldm+"=@money where gno='0' and carno=@carno and carkindno=@carkindno and driverno=@driverno and mon=@mon"
			execute sp_executesql @cmd,N'@carkindno nvarchar(10),@carno nvarchar(20),@driverno nvarchar(20),@mon nvarchar(10),@money float,@miles float',
				@carkindno=@carkindno,@carno=@carno,@driverno=@driverno,@mon=@mon,@money=@money,@miles=@miles
		end
		fetch next from cursor_table
		into @carkindno,@carno,@driverno,@mon,@calctypeno,@money,@miles
	end
	close cursor_table
	deallocate cursor_table
	------------------------------------------------------------------------------------------------------------------
	--加油
	declare @tmp2 table(
		carkindno nvarchar(20),
		carno nvarchar(20),
		driverno nvarchar(20),
		mon nvarchar(20),
		mount float,
		[money] float
	)
	
	set @cmd =
		" select isnull(e.carkindno,''),a.carno,a.driverno,left(a.datea,6),"+
		" sum(isnull(a.mount,0)) mount,"+
		" sum(isnull(a.money,0)) [money]"+
		" from oil a"+
		" left join car2 e on a.carno=e.noa"+
		" left join #carkind f on e.carkindno=f.noa"+
		" where (not f.noa is null)"+
		" and (len(@t_carno)=0 or a.carno=@t_carno)"+
		" and (a.datea between @t_bdate and @t_edate)"+
		" and (a.driverno between @t_bdriverno and @t_edriverno)"+
		" group by isnull(e.carkindno,''),a.carno,a.driverno,left(a.datea,6)"	
	insert into @tmp2
	EXECUTE sp_executesql @cmd,N'@t_bdate nvarchar(10),@t_edate nvarchar(10),@t_bdriverno nvarchar(20),@t_edriverno nvarchar(20),@t_carno nvarchar(20),@t_bcustno  nvarchar(20),@t_ecustno  nvarchar(20),@t_po  nvarchar(30)',
		@t_bdate=@t_bdate,@t_edate=@t_edate,@t_bdriverno=@t_bdriverno,@t_edriverno=@t_edriverno,@t_carno=@t_carno,@t_bcustno=@t_bcustno,@t_ecustno=@t_ecustno,@t_po=@t_po
	
	set @fieldm=''
	select @fieldm=fieldm from @field where [key]='oil'
	
	declare cursor_table cursor for
	select carkindno,carno,driverno,mon,mount,[money] from @tmp2 where mount!=0 and [money]!=0
	open cursor_table
	fetch next from cursor_table
	into @carkindno,@carno,@driverno,@mon,@mount,@money
	while(@@FETCH_STATUS <> -1)
	begin
		if not exists(select * from #z_trana13 where carno=@carno and carkindno=@carkindno and driverno=@driverno and mon=@mon)
		begin
			insert into #z_trana13(gno,carno,carkindno,driverno,mon)values('0',@carno,@carkindno,@driverno,@mon)
		end
		if LEN(@fieldm)>0
			set @cmd = "update #z_trana13 set "+@fieldm+"=reverse(substring(reverse(convert(char(15),CONVERT(money,@money),1)),4,12)),m"+@fieldm+"=@money,oilmount=@mount,oilmoney=@money where gno='0' and carno=@carno and carkindno=@carkindno and driverno=@driverno and mon=@mon"
		else	
			set @cmd = "update #z_trana13 set oilmount=@mount,oilmoney=@money where gno='0' and carno=@carno and carkindno=@carkindno and driverno=@driverno and mon=@mon"
		execute sp_executesql @cmd,N'@carkindno nvarchar(10),@carno nvarchar(20),@driverno nvarchar(20),@mon nvarchar(10),@mount float,@money float',
			@carkindno=@carkindno,@carno=@carno,@driverno=@driverno,@mon=@mon,@mount=@mount,@money=@money

		fetch next from cursor_table
		into @carkindno,@carno,@driverno,@mon,@mount,@money
	end
	close cursor_table
	deallocate cursor_table
	
	------------------------------------------------------------------------------------------------------------------
	--寄櫃費,通行費
	if exists(select * from @field where [key]='tolls' or [key]='resverve')
	begin
		declare @tmp3 table(
			carkindno nvarchar(20),
			carno nvarchar(20),
			driverno nvarchar(20),
			mon nvarchar(20),
			tolls float,
			resverve float
		)
		set @cmd=
			" select isnull(e.carkindno,''),a.carno,a.driverno,left(a.datea,6),"+
			" SUM(case when minusitemno='01'  then  isnull(a.minusmoney,0)  else  0  end) tolls,"+
			" SUM(case when minusitemno='02'  then  isnull(a.minusmoney,0)  else  0  end) reserve"+  
			" from carchg  a  "+
			" left join car2 e on a.carno=e.noa"+
			" left join #carkind f on e.carkindno=f.noa"+
			" where (a.minusitemno='01' or a.minusitemno='02') and (not f.noa is null)"+
			" and (len(@t_carno)=0 or a.carno=@t_carno)"+
			" and (a.datea between @t_bdate and @t_edate)"+
			" and (a.driverno between @t_bdriverno and @t_edriverno)"+
			"group by isnull(e.carkindno,''),a.carno,a.driverno,left(a.datea,6)"
		insert @tmp3
		EXECUTE sp_executesql @cmd,N'@t_bdate nvarchar(10),@t_edate nvarchar(10),@t_bdriverno nvarchar(20),@t_edriverno nvarchar(20),@t_carno nvarchar(20),@t_bcustno  nvarchar(20),@t_ecustno  nvarchar(20),@t_po  nvarchar(30)',
			@t_bdate=@t_bdate,@t_edate=@t_edate,@t_bdriverno=@t_bdriverno,@t_edriverno=@t_edriverno,@t_carno=@t_carno,@t_bcustno=@t_bcustno,@t_ecustno=@t_ecustno,@t_po=@t_po
		
		set @cmd=
			" select isnull(e.carkindno,''),a.carno,a.driverno,left(a.datea,6),"+
			" SUM(isnull(a.[money],0)) tolls,0"+ 
			" from etc a  "+
			" left join car2 e on a.carno=e.noa"+
			" left join #carkind f on e.carkindno=f.noa"+
			" where (not f.noa is null)"+
			" and (len(@t_carno)=0 or a.carno=@t_carno)"+
			" and (a.datea between @t_bdate and @t_edate)"+
			" and (a.driverno between @t_bdriverno and @t_edriverno)"+
			"group by isnull(e.carkindno,''),a.carno,a.driverno,left(a.datea,6)"
		insert @tmp3
		EXECUTE sp_executesql @cmd,N'@t_bdate nvarchar(10),@t_edate nvarchar(10),@t_bdriverno nvarchar(20),@t_edriverno nvarchar(20),@t_carno nvarchar(20),@t_bcustno  nvarchar(20),@t_ecustno  nvarchar(20),@t_po  nvarchar(30)',
			@t_bdate=@t_bdate,@t_edate=@t_edate,@t_bdriverno=@t_bdriverno,@t_edriverno=@t_edriverno,@t_carno=@t_carno,@t_bcustno=@t_bcustno,@t_ecustno=@t_ecustno,@t_po=@t_po
		
		
		declare cursor_table cursor for
		select carkindno,carno,driverno,mon,sum(isnull(tolls,0)),sum(isnull(resverve,0)) from @tmp3 where not(tolls=0 and resverve=0) group  by  carkindno,carno,driverno,mon
		open cursor_table
		fetch next from cursor_table
		into @carkindno,@carno,@driverno,@mon,@tolls,@resverve
		while(@@FETCH_STATUS <> -1)
		begin
			if not exists(select * from #z_trana13 where carno=@carno and carkindno=@carkindno and driverno=@driverno and mon=@mon)
			begin
				insert into #z_trana13(gno,carno,carkindno,driverno,mon)values('0',@carno,@carkindno,@driverno,@mon)
			end
				
			set @fieldm = ''
			select @fieldm=fieldm from @field where [key]='tolls'
			if LEN(@fieldm)>0
			begin
				set @cmd = "update #z_trana13 set "+@fieldm+"=reverse(substring(reverse(convert(char(15),CONVERT(money,@tolls),1)),4,12)),m"+@fieldm+"=@tolls where gno='0' and carno=@carno and carkindno=@carkindno and driverno=@driverno and mon=@mon"
				execute sp_executesql @cmd,N'@carkindno nvarchar(10),@carno nvarchar(20),@driverno nvarchar(20),@mon nvarchar(10),@tolls float',
					@carkindno=@carkindno,@carno=@carno,@driverno=@driverno,@mon=@mon,@tolls=@tolls
			end
			set @fieldm = ''
			select @fieldm=fieldm from @field where [key]='resverve'
			if LEN(@fieldm)>0
			begin
				set @cmd = "update #z_trana13 set "+@fieldm+"=reverse(substring(reverse(convert(char(15),CONVERT(money,@resverve),1)),4,12)),m"+@fieldm+"=@resverve where gno='0' and carno=@carno and carkindno=@carkindno and driverno=@driverno and mon=@mon"
				execute sp_executesql @cmd,N'@carkindno nvarchar(10),@carno nvarchar(20),@driverno nvarchar(20),@mon nvarchar(10),@resverve float',
					@carkindno=@carkindno,@carno=@carno,@driverno=@driverno,@mon=@mon,@resverve=@resverve
			end
			
			fetch next from cursor_table
			into @carkindno,@carno,@driverno,@mon,@tolls,@resverve
		end
		close cursor_table
		deallocate cursor_table
	end
	------------------------------------------------------------------------------------------------------------------
	--罰款
	set @fieldm = ''
	select @fieldm=fieldm from @field where [key]='ticket'
	if LEN(@fieldm)>0
	begin
		declare @tmp4 table(
			carkindno nvarchar(20),
			carno nvarchar(20),
			driverno nvarchar(20),
			mon nvarchar(20),
			[money] float
		)
		set @cmd=
			" select isnull(e.carkindno,''),a.carno,a.driverno,left(a.datea,6),"+
			" SUM(isnull(a.comppay,0))"+  
			" from ticket a  "+
			" left join car2 e on a.carno=e.noa"+
			" left join #carkind f on e.carkindno=f.noa"+
			" where isnull(a.comppay,0)>0 and (not f.noa is null)"+
			" and (len(@t_carno)=0 or a.carno=@t_carno)"+
			" and (a.datea between @t_bdate and @t_edate)"+
			" and (a.driverno between @t_bdriverno and @t_edriverno)"+
			" group by isnull(e.carkindno,''),a.carno,a.driverno,left(a.datea,6)"
		insert @tmp4
		EXECUTE sp_executesql @cmd,N'@t_bdate nvarchar(10),@t_edate nvarchar(10),@t_bdriverno nvarchar(20),@t_edriverno nvarchar(20),@t_carno nvarchar(20),@t_bcustno  nvarchar(20),@t_ecustno  nvarchar(20),@t_po  nvarchar(30)',
			@t_bdate=@t_bdate,@t_edate=@t_edate,@t_bdriverno=@t_bdriverno,@t_edriverno=@t_edriverno,@t_carno=@t_carno,@t_bcustno=@t_bcustno,@t_ecustno=@t_ecustno,@t_po=@t_po
		
		declare cursor_table cursor for
		select carkindno,carno,driverno,mon,[money] from @tmp4 where [money]!=0
		open cursor_table
		fetch next from cursor_table
		into @carkindno,@carno,@driverno,@mon,@money
		while(@@FETCH_STATUS <> -1)
		begin
			if not exists(select * from #z_trana13 where carno=@carno and carkindno=@carkindno and driverno=@driverno and mon=@mon)
			begin
				insert into #z_trana13(gno,carno,carkindno,driverno,mon)values('0',@carno,@carkindno,@driverno,@mon)
			end
			set @cmd = "update #z_trana13 set "+@fieldm+"=reverse(substring(reverse(convert(char(15),CONVERT(money,@money),1)),4,12)),m"+@fieldm+"=@money where gno='0' and carno=@carno and carkindno=@carkindno and driverno=@driverno and mon=@mon"
			execute sp_executesql @cmd,N'@carkindno nvarchar(10),@carno nvarchar(20),@driverno nvarchar(20),@mon nvarchar(10),@money float',
				@carkindno=@carkindno,@carno=@carno,@driverno=@driverno,@mon=@mon,@money=@money
			fetch next from cursor_table
			into @carkindno,@carno,@driverno,@mon,@money
		end
		close cursor_table
		deallocate cursor_table
	end
	------------------------------------------------------------------------------------------------------------------
	--薪資
	set @fieldm = ''
	select @fieldm=fieldm from @field where [key]='carsal'
	if LEN(@fieldm)>0
	begin
		declare cursor_table cursor for
		select driverno,noa,[money] from carsals 
		where (noa between left(@t_bdate,6)  and  left(@t_bdate,6))  and  (driverno  between  @t_bdriverno  and  @t_edriverno)
		open cursor_table
		fetch next from cursor_table
		into @driverno,@mon,@money
		while(@@FETCH_STATUS <> -1)
		begin
			select @carkindno='',@carno=''
			select top(1) @carkindno=carkindno,@carno=carno  from  #z_trana13  where  driverno=@driverno  and  mon=@mon
			if LEN( @carno)>0
			begin
				set @cmd = "update #z_trana13 set "+@fieldm+"=reverse(substring(reverse(convert(char(15),CONVERT(money,@money),1)),4,12)),m"+@fieldm+"=@money where gno='0' and carno=@carno and carkindno=@carkindno and driverno=@driverno and mon=@mon"
				execute sp_executesql @cmd,N'@carkindno nvarchar(10),@carno nvarchar(20),@driverno nvarchar(20),@mon nvarchar(10),@money float',
					@carkindno=@carkindno,@carno=@carno,@driverno=@driverno,@mon=@mon,@money=@money
			end
			fetch next from cursor_table
			into @driverno,@mon,@money
		end
		close cursor_table
		deallocate cursor_table
	end
	------------------------------------------------------------------------------------------------------------------
	------------------------------------------------------------------------------------------------------------------
	--修理費
	set @fieldm = ''
	select @fieldm=fieldm from @field where [key]='fixa'
	if LEN(@fieldm)>0
	begin
		declare cursor_table cursor for
		select isnull(e.carkindno,'') carkindno,a.carno,a.driverno,LEFT(datea,6)  mon
		 ,SUM(isnull(a.wmoney,0)) [money]
		 from fixa a 
		 left join car2 e on a.carno=e.noa
		 left join #carkind f on e.carkindno=f.noa
		 where 
		 isnull(a.wmoney,0)>0 and (not f.noa is null)
		 and (len(@t_carno)=0 or a.carno=@t_carno)
		 and (a.datea between @t_bdate and @t_edate)
		 and (a.driverno between @t_bdriverno and @t_edriverno)
		 group by isnull(e.carkindno,''),a.carno,a.driverno,LEFT(datea,6)
		open cursor_table
		fetch next from cursor_table
		into @carkindno,@carno,@driverno,@mon,@money
		while(@@FETCH_STATUS <> -1)
		begin
			if not exists(select *  from  #z_trana13 where carkindno=@carkindno and carno=@carno and driverno=@driverno and mon=@mon)
			begin
				insert into #z_trana13(gno,carkindno,carno,driverno,mon)values('0',@carkindno,@carno,@driverno,@mon)
			end
			set @cmd = "update #z_trana13 set "+@fieldm+"=reverse(substring(reverse(convert(char(15),CONVERT(money,@money),1)),4,12)),m"+@fieldm+"=@money where gno='0' and carno=@carno and carkindno=@carkindno and driverno=@driverno and mon=@mon"
			execute sp_executesql @cmd,N'@carkindno nvarchar(10),@carno nvarchar(20),@driverno nvarchar(20),@mon nvarchar(10),@money float',
				@carkindno=@carkindno,@carno=@carno,@driverno=@driverno,@mon=@mon,@money=@money
	
			fetch next from cursor_table
			into @carkindno,@carno,@driverno,@mon,@money
		end
		close cursor_table
		deallocate cursor_table
	end
	------------------------------------------------------------------------------------------------------------------
	--輪胎費
	set @fieldm = ''
	select @fieldm=fieldm from @field where [key]='tire'
	if LEN(@fieldm)>0
	begin
		declare cursor_table cursor for
		select isnull(e.carkindno,'') carkindno,a.carno,a.driverno,LEFT(datea,6)  mon
		 ,SUM(isnull(a.cmoney,0)) [money]
		 from fixa a 
		 left join car2 e on a.carno=e.noa
		 left join #carkind f on e.carkindno=f.noa
		 where 
		 isnull(a.cmoney,0)>0 and (not f.noa is null)
		 and (len(@t_carno)=0 or a.carno=@t_carno)
		 and (a.datea between @t_bdate and @t_edate)
		 and (a.driverno between @t_bdriverno and @t_edriverno)
		 group by isnull(e.carkindno,''),a.carno,a.driverno,LEFT(datea,6)
		open cursor_table
		fetch next from cursor_table
		into @carkindno,@carno,@driverno,@mon,@money
		while(@@FETCH_STATUS <> -1)
		begin
			if not exists(select *  from  #z_trana13 where carkindno=@carkindno and carno=@carno and driverno=@driverno and mon=@mon)
			begin
				insert into #z_trana13(gno,carkindno,carno,driverno,mon)values('0',@carkindno,@carno,@driverno,@mon)
			end
			set @cmd = "update #z_trana13 set "+@fieldm+"=reverse(substring(reverse(convert(char(15),CONVERT(money,@money),1)),4,12)),m"+@fieldm+"=@money where gno='0' and carno=@carno and carkindno=@carkindno and driverno=@driverno and mon=@mon"
			execute sp_executesql @cmd,N'@carkindno nvarchar(10),@carno nvarchar(20),@driverno nvarchar(20),@mon nvarchar(10),@money float',
				@carkindno=@carkindno,@carno=@carno,@driverno=@driverno,@mon=@mon,@money=@money
	
			fetch next from cursor_table
			into @carkindno,@carno,@driverno,@mon,@money
		end
		close cursor_table
		deallocate cursor_table
	end
	------------------------------------------------------------------------------------------------------------------
	--折舊
	set @fieldm = ''
	select @fieldm=fieldm from @field where [key]='depreciation'
	if LEN(@fieldm)>0
	begin
		declare cursor_table cursor for
		select carno,driverno,isnull(depreciation,0) from car2 
		open cursor_table
		fetch next from cursor_table
		into @carno,@driverno,@money
		while(@@FETCH_STATUS <> -1)
		begin
			select @carkindno='',@mon=''
			select @carkindno=carkindno,@mon=mon  from  #z_trana13 where carno=@carno and driverno=@driverno
			if LEN(@mon)=0
			begin
				select @driverno=''
				select @carkindno=carkindno,@mon=mon,@driverno=driverno  from  #z_trana13 where carno=@carno
			end
		
			if LEN( @carno)>0
			begin
				set @cmd = "update #z_trana13 set "+@fieldm+"=reverse(substring(reverse(convert(char(15),CONVERT(money,@money),1)),4,12)),m"+@fieldm+"=@money where gno='0' and carno=@carno and carkindno=@carkindno and driverno=@driverno and mon=@mon"
				execute sp_executesql @cmd,N'@carkindno nvarchar(10),@carno nvarchar(20),@driverno nvarchar(20),@mon nvarchar(10),@money float',
					@carkindno=@carkindno,@carno=@carno,@driverno=@driverno,@mon=@mon,@money=@money
			end
			fetch next from cursor_table
			into @carno,@driverno,@money
		end
		close cursor_table
		deallocate cursor_table
	end
	------------------------------------------------------------------------------------------------------------------
	--保牌燃費
	set @fieldm = ''
	select @fieldm=fieldm from @field where [key]='tax'
	if LEN(@fieldm)>0
	begin
		declare cursor_table cursor for
		select carno,driverno,isnull(tax,0) from car2 
		open cursor_table
		fetch next from cursor_table
		into @carno,@driverno,@money
		while(@@FETCH_STATUS <> -1)
		begin
			select @carkindno='',@mon=''
			select @carkindno=carkindno,@mon=mon  from  #z_trana13 where carno=@carno and driverno=@driverno
			if LEN(@mon)=0
			begin
				select @driverno=''
				select @carkindno=carkindno,@mon=mon,@driverno=driverno  from  #z_trana13 where carno=@carno
			end
		
			if LEN( @carno)>0
			begin
				set @cmd = "update #z_trana13 set "+@fieldm+"=reverse(substring(reverse(convert(char(15),CONVERT(money,@money),1)),4,12)),m"+@fieldm+"=@money where gno='0' and carno=@carno and carkindno=@carkindno and driverno=@driverno and mon=@mon"
				execute sp_executesql @cmd,N'@carkindno nvarchar(10),@carno nvarchar(20),@driverno nvarchar(20),@mon nvarchar(10),@money float',
					@carkindno=@carkindno,@carno=@carno,@driverno=@driverno,@mon=@mon,@money=@money
			end
			fetch next from cursor_table
			into @carno,@driverno,@money
		end
		close cursor_table
		deallocate cursor_table
	end
	------------------------------------------------------------------------------------------------------------------
	--淨利
	if exists(select * from @field where [key]='profit')
	begin
		set @cmd='0'
		declare cursor_table cursor for
		select fieldm,product from @field where product!=0
		open cursor_table
		fetch next from cursor_table
		into @fieldm,@product
		while(@@FETCH_STATUS <> -1)
		begin
			set @cmd=@cmd+"+(isnull(m"+@fieldm+",0)*("+CONVERT(nvarchar,@product)+"))"
			fetch next from cursor_table
			into @fieldm,@product
		end
		close cursor_table
		deallocate cursor_table
		
		set @fieldm = ''
		select @fieldm=fieldm from @field where [key]='profit'
		if LEN(@fieldm)>0
		begin
			set @cmd = "update #z_trana13 set "+@fieldm+"=reverse(substring(reverse(convert(char(15),CONVERT(money,"+@cmd+"),1)),4,12)),m"+@fieldm+"="+@cmd
			execute sp_executesql @cmd
		end
	end
	------------------------------------------------------------------------------------------------------------------
	
	------------------------------------------------------------------------------------------------------------------
	--小計
	declare cursor_table cursor for
	select carkindno from #z_trana13 group by carkindno
	open cursor_table
	fetch next from cursor_table
	into @carkindno
	while(@@FETCH_STATUS <> -1)
	begin
		set @fieldm=''
		select @fieldm=fieldm from @field where [key]='carno'
		set @carkind=''
		select @carkind=kind from carkind where noa=@carkindno
		if LEN(@fieldm)>0
		begin
			set @cmd="insert into #z_trana13(gno,carkindno,carno,driverno,mon,rowheader,"+@fieldm+")values('1',@carkindno,'','','',@carkind+'小計',@carkind+'小計')"
			execute sp_executesql @cmd,N'@carkindno nvarchar(10),@carkind nvarchar(20)',@carkindno=@carkindno,@carkind=@carkind
		end
		else
			insert into #z_trana13(gno,carkindno,carno,driverno,mon,rowheader)values('1',@carkindno,'','','',@carkind+'小計')

		declare cursor_table2 cursor for
		select fieldm from @field where isSum=1
		open cursor_table2
		fetch next from cursor_table2
		into @fieldm
		while(@@FETCH_STATUS <> -1)
		begin
			set @money=0
			set @cmd="select @money=sum(isnull(m"+@fieldm+",0)) from #z_trana13 where gno='0' and carkindno=@carkindno group by carkindno"
			execute sp_executesql @cmd,N'@carkindno nvarchar(10),@money float output',@carkindno=@carkindno,@money=@money output
			
			set @cmd="update #z_trana13 set "+@fieldm+"=reverse(substring(reverse(convert(char(15),CONVERT(money,@money),1)),4,12)),m"+@fieldm+"=@money where gno='1' and carkindno=@carkindno"
			execute sp_executesql @cmd,N'@carkindno nvarchar(10),@money float',@carkindno=@carkindno,@money=@money
			
			fetch next from cursor_table2
			into @fieldm
		end
		close cursor_table2
		deallocate cursor_table2
		
		
		fetch next from cursor_table
		into @carkindno
	end
	close cursor_table
	deallocate cursor_table
	--*************************************************************************************************
	update  #z_trana13  set  gno='a' where gno='0'

	set @cmd="select '0',carno,carkindno,'',mon,sum(isnull(tranmoney,0)),sum(isnull(miles,0)),sum(isnull(oilmount,0)),sum(isnull(oilmoney,0)),''"
	declare cursor_table cursor for
	select [key],fieldh,fieldm,product,isSum from @field where len(fieldh)>0 and  len(fieldm)>0
	open cursor_table
	fetch next from cursor_table
	into @key,@fieldh,@fieldm,@product,@isSum
	while(@@FETCH_STATUS <> -1)
	begin
		set @cmd=@cmd+",'',''"
		if @isSum=1 or @key='profit'
		begin
			set @cmd=@cmd+",sum(isnull(m"+@fieldm+",0))"
		end
		
		fetch next from cursor_table
		into @key,@fieldh,@fieldm,@product,@isSum
	end
	close cursor_table
	deallocate cursor_table
	print @cmd
	set @cmd=@cmd +"  from  #z_trana13  where  gno='a'  group  by  carno,carkindno,mon"
	insert into #z_trana13
	execute sp_executesql @cmd
	delete #z_trana13 where gno='a'
	
	declare cursor_table cursor for
	select [key],fieldm,isSum from @field where len(fieldm)>0
	open cursor_table
	fetch next from cursor_table
	into @key,@fieldm,@isSum
	while(@@FETCH_STATUS <> -1)
	begin
		if @isSum=1 or @key='profit'
		begin
			set @cmd="update #z_trana13 set "+@fieldm+"=reverse(substring(reverse(convert(char(15),CONVERT(money,m"+@fieldm+"),1)),4,12)) where  gno='0'"
			execute sp_executesql @cmd
		end
		
		fetch next from cursor_table
		into @key,@fieldm,@isSum
	end
	close cursor_table
	deallocate cursor_table
	------------------
	--類別
	set @fieldm = ''
	select @fieldm=fieldm from @field where [key]='carkind'
	if LEN(@fieldm)>0
	begin
		declare cursor_table cursor for
		select carkindno from #z_trana13 group by carkindno
		open cursor_table
		fetch next from cursor_table
		into @carkindno
		while(@@FETCH_STATUS <> -1)
		begin
			set @carkind=''
			select @carkind=kind from carKind where noa=@carkindno
			set @cmd="update #z_trana13 set "+@fieldm+"=@carkind where carkindno=@carkindno and gno='0'"
			execute sp_executesql @cmd,N'@carkind nvarchar(20),@carkindno nvarchar(10)',@carkind=@carkind,@carkindno=@carkindno	
			fetch next from cursor_table
			into @carkindno
		end
		close cursor_table
		deallocate cursor_table	
	end
	------------------------------------------------------------------------------------------------------------------
	--年份
	set @fieldm = ''
	select @fieldm=fieldm from @field where [key]='caryear'
	if LEN(@fieldm)>0
	begin
		declare cursor_table cursor for
		select carno from #z_trana13 group by carno
		open cursor_table
		fetch next from cursor_table
		into @carno
		while(@@FETCH_STATUS <> -1)
		begin
			set @caryear=''
			select @caryear=caryear from car2 where noa=@carno
			set @cmd="update #z_trana13 set "+@fieldm+"=@caryear where carno=@carno and gno='0'"
			execute sp_executesql @cmd,N'@carno nvarchar(20),@caryear nvarchar(10)',@carno=@carno,@caryear=@caryear	
			fetch next from cursor_table
			into @carno
		end
		close cursor_table
		deallocate cursor_table	
	end
	------------------------------------------------------------------------------------------------------------------
	--汽缸
	set @fieldm = ''
	select @fieldm=fieldm from @field where [key]='cylinder'
	if LEN(@fieldm)>0
	begin
		declare cursor_table cursor for
		select carno from #z_trana13 group by carno
		open cursor_table
		fetch next from cursor_table
		into @carno
		while(@@FETCH_STATUS <> -1)
		begin
			set @cylinder=0
			select @cylinder=cylinder from car2 where noa=@carno
			set @cmd="update #z_trana13 set "+@fieldm+"=convert(char(2),@cylinder) where carno=@carno and gno='0'"
			execute sp_executesql @cmd,N'@carno nvarchar(20),@cylinder int',@carno=@carno,@cylinder=@cylinder
			fetch next from cursor_table
			into @carno
		end
		close cursor_table
		deallocate cursor_table	
	end
	------------------------------------------------------------------------------------------------------------------
	--日數
	set @fieldm = ''
	select @fieldm=fieldm from @field where [key]='day'
	if LEN(@fieldm)>0
	begin
		declare cursor_table cursor for
		select carkindno,carno,mon from #z_trana13
		open cursor_table
		fetch next from cursor_table
		into @carkindno,@carno,@mon
		while(@@FETCH_STATUS <> -1)
		begin
			select @day=0
			select @day=count(1) from (SELECT DISTINCT datea from @tmp1 where carkindno=@carkindno and carno=@carno and LEFT(datea,6)=@mon)as a
			
			set @cmd="update #z_trana13 set "+@fieldm+"=convert(char(2),@day) where gno='0' and carkindno=@carkindno and carno=@carno and mon=@mon "
			execute sp_executesql @cmd,
				N'@day int,@carkindno nvarchar(10),@carno nvarchar(20),@mon nvarchar(10)',
				@day=@day,@carkindno=@carkindno,@carno=@carno,@mon=@mon

			fetch next from cursor_table
			into @carkindno,@carno,@mon
		end
		close cursor_table
		deallocate cursor_table	
	end
	------------------------------------------------------------------------------------------------------------------
	--車牌
	set @fieldm = ''
	select @fieldm=fieldm from @field where [key]='carno'
	if LEN(@fieldm)>0
	begin
		set @cmd="update #z_trana13 set "+@fieldm+"=carno  where gno='0'"
		execute sp_executesql @cmd
	end
	------------------------------------------------------------------------------------------------------------------
	--司機
	set @fieldm = ''
	select @fieldm=fieldm from @field where [key]='driver'
	if LEN(@fieldm)>0
	begin
		declare cursor_table cursor for
		select driverno from #z_trana13 group by driverno
		open cursor_table
		fetch next from cursor_table
		into @driverno
		while(@@FETCH_STATUS <> -1)
		begin
			set @driver=''
			select @driver=namea from driver where noa=@driverno
			set @cmd="update #z_trana13 set "+@fieldm+"=@driver where driverno=@driverno"
			execute sp_executesql @cmd,N'@driver nvarchar(20),@driverno nvarchar(20)',@driver=@driver,@driverno=@driverno
			fetch next from cursor_table
			into @driverno
		end
		close cursor_table
		deallocate cursor_table	
	end
	------------------------------------------------------------------------------------------------------------------
	--月份
	set @fieldm = ''
	select @fieldm=fieldm from @field where [key]='mon'
	if LEN(@fieldm)>0
	begin
		set @cmd="update #z_trana13 set "+@fieldm+"=mon where gno='0'"
		execute sp_executesql @cmd
	end
	------------------------------------------------------------------------------------------------------------------
	--公里/升,耗油比
	update #z_trana13 set tranmoney=isnull(tranmoney,0),miles=ISNULL(miles,0),oilmount=ISNULL(oilmount,0),oilmoney=ISNULL(oilmoney,0)
	set @fieldm=''
	select @fieldm=fieldm from @field where [key]='rate1'
	if LEN(@fieldm)>0
	begin
		set @cmd="update #z_trana13 set "+@fieldm+"=case when tranmoney=0 then '0 %' else convert(char(6),round(oilmoney/tranmoney*100,0))+' %' end  where gno='0'"
		execute sp_executesql @cmd
	end
	
	set @fieldm=''
	select @fieldm=fieldm from @field where [key]='rate2'
	if LEN(@fieldm)>0
	begin
		set @cmd="update #z_trana13 set "+@fieldm+"=case when oilmount=0 then '' else convert(char(6),CAST(round(miles/oilmount,3) as decimal(10,3))) end  where gno='0'"
		execute sp_executesql @cmd
	end
	--------------------------------------------------------------------------------
	declare cursor_table cursor for
	select fieldh,header from @field
	open cursor_table
	fetch next from cursor_table
	into @fieldh,@header
	while(@@FETCH_STATUS <> -1)
	begin
		set @cmd="update #z_trana13 set "+@fieldh+"=@header"
		execute sp_executesql @cmd,N'@header nvarchar(20)',@header=@header
		fetch next from cursor_table
		into @fieldh,@header
	end
	close cursor_table
	deallocate cursor_table
	----------------------------------------------------------------------------------
	select @fieldm='',@sort=''
	select @fieldm=fieldm,@sort=isnull(sort,'') from @field where [key]=@t_sort13
	set @cmd="select * from #z_trana13 order by carkindno,gno"+case when len(@sort)>0 then ','+@sort when len(@fieldm)>0 then ','+@fieldm else '' end
	execute sp_executesql @cmd
	drop table #z_trana13
	drop table #carkind
	drop table #calctype
	drop table #carteam;
z_trana12:--z_trana12
	SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	declare @t_accy nvarchar(10)
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_bcustno nvarchar(30)
	declare @t_ecustno nvarchar(30)
	declare @t_bdriverno nvarchar(30)
	declare @t_edriverno nvarchar(30)
	declare @t_carno nvarchar(20)
	declare @t_po nvarchar(20)
	declare @t_addr nvarchar(20)
	declare @t_carteamno nvarchar(max)
	declare @t_calctype nvarchar(max)
	declare @t_other nvarchar(max)
	declare @t_calcmoney nvarchar(max)
	declare @t_sort8 nvarchar(max)
	declare @t_sort10 nvarchar(max)
	declare @t_sort3 nvarchar(max)
	declare @t_bsalesno nvarchar(20)
	declare @t_esalesno nvarchar(20)
	declare @t_field5 nvarchar(max)
	declare @t_yproduct nvarchar(max)
	declare @t_yaddr nvarchar(max)
	declare @t_yboatname nvarchar(max)
	declare @t_sort6 nvarchar(max)
	declare @t_carkindno nvarchar(max)
	declare @t_sort5 nvarchar(max)	
	declare @t_field13 nvarchar(max)	
	declare @t_sort13 nvarchar(max)	
	declare @t_field1 nvarchar(max)	
	declare @t_sort1 nvarchar(max)	
	declare @t_acomp nvarchar(max)	
	declare @t_sort14 nvarchar(max)
	declare @t_trandono nvarchar(max)
	declare @t_option14 nvarchar(max)
	declare @t_baddrno nvarchar(20)
	declare @t_eaddrno nvarchar(20)
	declare @t_btrandate nvarchar(10)
	declare @t_etrandate nvarchar(10)
	declare @t_plusmoney int
	declare @t_minusmoney int
	
	set @t_accy = [1]
	set @t_bdate = case when '#non'=[2] then '' else [2] end
	set @t_edate = case when '#non'=[3] then char(255) else [3] end
	set @t_bcustno = case when '#non'=[4] then '' else [4] end
	set @t_ecustno = case when '#non'=[5] then char(255) else [5] end
	set @t_bdriverno = case when '#non'=[6] then '' else [6] end
	set @t_edriverno = case when '#non'=[7] then char(255) else [7] end
	set @t_carno = case when '#non'=[8] then '' else [8] end
	set @t_po = case when '#non'=[9] then '' else [9] end
	set @t_addr = case when '#non'=[10] then '' else [10] end
	set @t_carteamno = case when '#non'=[11] then '' else [11] end
	set @t_calctype = case when '#non'=[12] then '' else [12] end
	set @t_other = case when '#non'=[13] then '' else [13] end
	set @t_calcmoney = case when '#non'=[14] then '' else [14] end
	set @t_sort8 = case when '#non'=[15] then '' else [15] end
	set @t_sort10 =  case when '#non'=[16] then '' else [16] end
	set @t_sort3 = case when '#non'=[17] then '' else [17] end
	set @t_bsalesno = case when '#non'=[18] then '' else [18] end
	set @t_esalesno = case when '#non'=[19] then char(255) else [19] end
	set @t_field5 = case when '#non'=[20] then '' else [20] end
	set @t_yproduct = case when '#non'=[21] then '' else [21] end
	set @t_yaddr = case when '#non'=[22] then '' else [22] end
	set @t_yboatname = case when '#non'=[23] then '' else [23] end
	set @t_sort6 = case when '#non'=[24] then '' else [24] end
	set @t_carkindno = case when '#non'=[25] then '' else [25] end
	set @t_sort5 = case when '#non'=[26] then '' else [26] end
	set @t_field13 = case when '#non'=[27] then '' else [27] end
	set @t_sort13 = case when '#non'=[28] then '' else [28] end
	set @t_field1 = case when '#non'=[29] then '' else [29] end
	set @t_sort1 = case when '#non'=[30] then '' else [30] end
	set @t_acomp = case when '#non'=[31] then '' else [31] end
	set @t_sort14 = case when '#non'=[32] then '' else [32] end
	set @t_trandono = case when '#non'=[33] then '' else [33] end
	set @t_option14 = case when '#non'=[34] then '' else [34] end
	set @t_baddrno = case when '#non'=[35] then '' else [35] end
	set @t_eaddrno = case when '#non'=[36] then char(255) else [36] end
	set @t_btrandate = case when '#non'=[37] then '' else [37] end
	set @t_etrandate = case when '#non'=[38] then char(255) else [38] end
	set @t_plusmoney = case when '#non'=[39] then '0' else cast([39] as int) end
	set @t_minusmoney = case when '#non'=[40]then '0' else cast([40] as int) end
	-------------------------------------------------------------------------------------------------------------
	declare @n int
	declare @minN int
	set @minN = 7
	declare @gkey nvarchar(10)
	declare @gname nvarchar(20)
	declare @carno nvarchar(20)
	declare @driverno nvarchar(20)
	declare @datea nvarchar(10)
	declare @fieldh nvarchar(10)
	declare @fieldm nvarchar(10)
	declare @money float
	declare @title nvarchar(30)
	declare @tolls float
	declare @reserve float
	declare @mount float
	declare @wmoney float
	declare @cmoney float
	declare @carteamno nvarchar(20)
	declare @resultH nvarchar(20)
	declare @resultM nvarchar(10)
	declare @fieldA nvarchar(20)
	declare @fieldB nvarchar(20)
	declare @fieldC nvarchar(20)
	declare @fieldD nvarchar(20)
	declare @product float
	declare @result nvarchar(max)
	declare @typea nvarchar(10)
	declare @t_isDiscount int
	declare @mon nvarchar(10)
	declare @team nvarchar(20)
	declare @unit nvarchar(20)
	declare @custno nvarchar(20)
	declare @comp nvarchar(40)
	declare @salesno nvarchar(20)
	declare @namea nvarchar(20)
	-------------------------------------------------------------------------------------------------------------
	--解析要計算的種類
	declare @string nvarchar(max)
	IF OBJECT_ID('tempdb..#carteam')is not null
	BEGIN
		set @cmd = 'drop table #carteam'
		EXECUTE sp_executesql @cmd
	END
	create table #carteam(
		noa nvarchar(10)
	)
	set @string = @t_carteamno
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #carteam select @string
			end
			break
		end
		insert into #carteam select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	IF OBJECT_ID('tempdb..#calctype')is not null
	BEGIN
		set @cmd = 'drop table #calctype'
		EXECUTE sp_executesql @cmd
	END
	create table #calctype(
		noa nvarchar(10)
	)
	set @string = @t_calctype
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #calctype select @string
			end
			break
		end
		insert into #calctype select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	set @t_isDiscount=0
	set @string = @t_other
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				if  @string='discount'
					set  @t_isDiscount  =  1
			end
			break
		end
		if   LEFT(@string,@n-1)='discount'
			set  @t_isDiscount  =  1
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	-------------------------------------------------------------------------------------------------------------
	-------------------------------------------------------------------------------------------------------------
	--記錄欄位
	declare @field table(
		noa  nvarchar(20),
		team nvarchar(20),
		unit  nvarchar(20),
		field_mount_header nvarchar(10),
		field_mount nvarchar(10),
		field_money_header nvarchar(10),
		field_money nvarchar(10)
	)
	-------------------------------------------------------------------------------------------------------------
	-------------------------------------------------------------------------------------------------------------
	--暫存資料
	IF OBJECT_ID('tempdb..#z_trana12')is not null
	BEGIN
		set @cmd = 'drop table #z_trana12'
		EXECUTE sp_executesql @cmd
	END
	create table #z_trana12(
		gno nvarchar(3),
		salesno nvarchar(20),
		namea nvarchar(20),
		primary key(salesno,gno)
	)
	-------------------------------------------------------------------------------------------------------------
	
	-------------------------------------------------------------------------------------------------------------
	--出車單:客戶金額
	select @n= COUNT(1) from @field

	declare cursor_table cursor for
	select a.noa,a.team,a.unit from carteam a
	left join carteam b on a.noa=b.noa
	left join #carteam c on b.noa=c.noa
	where b.noa=c.noa
	group by a.noa,a.team,a.unit
	open cursor_table
	fetch next from cursor_table
	into @gkey,@gname,@unit
	while(@@FETCH_STATUS <> -1)
	begin
		set @n = @n + 1
		insert into @field(noa,team,unit,field_mount_header,field_mount,field_money_header,field_money)
			values( @gkey,@gname,@unit,
				"a"+right("00"+CONVERT(nvarchar(10),@n),3),
				"b"+right("00"+CONVERT(nvarchar(10),@n),3),
				"c"+right("00"+CONVERT(nvarchar(10),@n),3),
				"d"+right("00"+CONVERT(nvarchar(10),@n),3))
		set @cmd = "alter table #z_trana12 add a"+right("00"+CONVERT(nvarchar(10),@n),3)+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_trana12 add b"+right("00"+CONVERT(nvarchar(10),@n),3)+" float"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_trana12 add cb"+right("00"+CONVERT(nvarchar(10),@n),3)+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_trana12 add c"+right("00"+CONVERT(nvarchar(10),@n),3)+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_trana12 add d"+right("00"+CONVERT(nvarchar(10),@n),3)+" float"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_trana12 add cd"+right("00"+CONVERT(nvarchar(10),@n),3)+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		fetch next from cursor_table
		into @gkey,@gname,@unit
	end
	close cursor_table
	deallocate cursor_table
	---------------------------------------------
	--總計
	set @n = @n + 1
	insert into @field(noa,team,unit,field_mount_header,field_mount,field_money_header,field_money)
		values( CHAR(255),'總計',null,
			"a"+right("00"+CONVERT(nvarchar(10),@n),3),
			"b"+right("00"+CONVERT(nvarchar(10),@n),3),
			"c"+right("00"+CONVERT(nvarchar(10),@n),3),
			"d"+right("00"+CONVERT(nvarchar(10),@n),3))
	set @cmd = "alter table #z_trana12 add a"+right("00"+CONVERT(nvarchar(10),@n),3)+" nvarchar(20)"
	EXECUTE sp_executesql @cmd
	set @cmd = "alter table #z_trana12 add b"+right("00"+CONVERT(nvarchar(10),@n),3)+" float"
	EXECUTE sp_executesql @cmd
	set @cmd = "alter table #z_trana12 add cb"+right("00"+CONVERT(nvarchar(10),@n),3)+" nvarchar(20)"
	EXECUTE sp_executesql @cmd
	set @cmd = "alter table #z_trana12 add c"+right("00"+CONVERT(nvarchar(10),@n),3)+" nvarchar(20)"
	EXECUTE sp_executesql @cmd
	set @cmd = "alter table #z_trana12 add d"+right("00"+CONVERT(nvarchar(10),@n),3)+" float"
	EXECUTE sp_executesql @cmd
	set @cmd = "alter table #z_trana12 add cd"+right("00"+CONVERT(nvarchar(10),@n),3)+" nvarchar(20)"
	EXECUTE sp_executesql @cmd
	---------------------------------------------
	select @n= COUNT(1) from @field
	while(@n<@minN)
	begin
		set  @n = @n +  1
		insert into @field(noa,team,unit,field_mount_header,field_mount,field_money_header,field_money)
			values( null,null,null,
				"a"+right("00"+CONVERT(nvarchar(10),@n),3),
				"b"+right("00"+CONVERT(nvarchar(10),@n),3),
				"c"+right("00"+CONVERT(nvarchar(10),@n),3),
				"d"+right("00"+CONVERT(nvarchar(10),@n),3))
		set @cmd = "alter table #z_trana12 add a"+right("00"+CONVERT(nvarchar(10),@n),3)+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_trana12 add b"+right("00"+CONVERT(nvarchar(10),@n),3)+" float"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_trana12 add cb"+right("00"+CONVERT(nvarchar(10),@n),3)+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_trana12 add c"+right("00"+CONVERT(nvarchar(10),@n),3)+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_trana12 add d"+right("00"+CONVERT(nvarchar(10),@n),3)+" float"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_trana12 add cd"+right("00"+CONVERT(nvarchar(10),@n),3)+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
	end
	--------------------------------------------------------------------------------------------------------------------
	declare @tmp1 table(
		salesno nvarchar(20),
		carteamno nvarchar(10),
		mount float,
		[money] float
	)

	set @cmd =" select isnull(a.salesno,''),a.carteamno,"
	if  @t_calcmoney='a.price*a.mount'
		set  @cmd  =  @cmd  +  "sum(a.mount),"
	else
		set  @cmd  =  @cmd  +  "sum(a.mount2),"
	set @cmd =	@cmd  +" sum(round("+@t_calcmoney+",0)) money"+
		" from trans"+@t_accy+" a"+
		" left join #calctype b on a.calctype=b.noa"+
		" left join calctype c on left(a.calctype,1)=c.noa"+
		" left join #carteam d on a.carteamno=d.noa"+
		" where a.calctype=b.noa  and  a.carteamno=d.noa"+
		" and (len(@t_carno)=0 or a.carno=@t_carno)"+
		" and (a.datea between @t_bdate and @t_edate)"+
		" and (a.custno between @t_bcustno and @t_ecustno)"+
		" and (a.driverno between @t_bdriverno and @t_edriverno)"+
		" and (isnull(a.salesno,'') between @t_bsalesno and @t_esalesno)"+
		" and (len(@t_po)=0 or a.po=@t_po)"+
		" group by isnull(a.salesno,''),a.carteamno"
	insert into @tmp1
	EXECUTE sp_executesql @cmd,N'@t_bdate nvarchar(10),@t_edate nvarchar(10),@t_bdriverno nvarchar(20),@t_edriverno nvarchar(20),@t_carno nvarchar(20),@t_bcustno  nvarchar(20),@t_ecustno  nvarchar(20),@t_po nvarchar(30),@t_bsalesno nvarchar(20),@t_esalesno nvarchar(20)',		
	@t_bdate=@t_bdate,@t_edate=@t_edate,@t_bdriverno=@t_bdriverno,@t_edriverno=@t_edriverno,@t_carno=@t_carno,@t_bcustno=@t_bcustno,@t_ecustno=@t_ecustno,@t_po=@t_po,@t_bsalesno=@t_bsalesno,@t_esalesno=@t_esalesno

	-------------------------------------------------------------------------------------------------------------
	
	declare cursor_table cursor for
	select salesno,carteamno,mount,[money] from @tmp1
	open cursor_table
	fetch next from cursor_table
	into @salesno,@carteamno,@mount,@money
	while(@@FETCH_STATUS <> -1)
	begin
		if exists(select * from @field where noa=@carteamno)
		begin
			select @fieldB='',@fieldD=''
			select @fieldB=field_mount,@fieldD=field_money from @field where noa=@carteamno
			if not  exists(select  *  from  #z_trana12  where  salesno=@salesno)
			begin
				set @namea=''
				select @namea=namea from sss where noa=@salesno
				insert  into  #z_trana12(gno,salesno,namea)values('0',@salesno,@namea)
			end
			set  @cmd="update #z_trana12 set "+@fieldB+"=@mount,"+@fieldD+"=@money where gno='0' and salesno=@salesno"
			execute sp_executesql @cmd,N'@salesno nvarchar(20),@mount  float,@money float',@salesno=@salesno,@mount=@mount,@money=@money
		end
		fetch next from cursor_table
		into @salesno,@carteamno,@mount,@money
	end
	close cursor_table
	deallocate cursor_table
	-------------------------------------------
	--計算總計
	set @result=''

	declare cursor_table cursor for
	select field_money from  @field where noa!=char(255)
	open cursor_table
	fetch next from cursor_table
	into @fieldD
	while(@@FETCH_STATUS <> -1)
	begin
		if LEN(@result)=0
			set @result='isnull('+@fieldD+',0)'
		else
			set @result=@result+'+isnull('+@fieldD+',0)'
		fetch next from cursor_table
		into @fieldD
	end
	close cursor_table
	deallocate cursor_table
	
	select @fieldD=''
	select @fieldD=field_money from  @field where noa=char(255)
	set @result="update #z_trana12 set "+@fieldD+"="+@result
	execute sp_executesql @result
	----------------------------------------------------------------------------------------------------------------------
	--計算小計
	set @result="select '1',char(255),''"
	
	declare cursor_table cursor for
	select unit,team,field_mount_header,field_mount,field_money_header,field_money from  @field
	open cursor_table
	fetch next from cursor_table
	into @unit,@team,@fieldA,@fieldB,@fieldC,@fieldD
	while(@@FETCH_STATUS <> -1)
	begin
		set @result = @result+",'',sum("+@fieldB+"),'','',sum("+@fieldD+"),''"
		
		set @cmd = "update #z_trana12 set " +@fieldA+"=@unit,"+@fieldC+"=@team"
		execute sp_executesql @cmd,N'@unit nvarchar(20),@team nvarchar(20)',@unit=@unit,@team=@team
		
		fetch next from cursor_table
		into @unit,@team,@fieldA,@fieldB,@fieldC,@fieldD
	end
	close cursor_table
	deallocate cursor_table
	set @result = @result+" from #z_trana12 group by gno"
	insert into #z_trana12
	execute sp_executesql @result
	----------------------------------------------------------------------------------------------------------------------
	declare cursor_table cursor for
	select field_mount,field_money from @field
	open cursor_table
	fetch next from cursor_table
	into @fieldB,@fieldD
	while(@@FETCH_STATUS <> -1)
	begin
		set @cmd="update #z_trana12 set c"+@fieldB+"=convert(nvarchar(15),CONVERT(money,"+@fieldB+"),1),"+
						" c"+@fieldD+"=reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,"+@fieldD+"),1)),4,12))"
		EXECUTE sp_executesql @cmd
		fetch next from cursor_table
		into @fieldB,@fieldD
	end
	close cursor_table
	deallocate cursor_table

	select * from #z_trana12;

z_trana11:--z_trana11
	SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	declare @t_accy nvarchar(10)
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_bcustno nvarchar(30)
	declare @t_ecustno nvarchar(30)
	declare @t_bdriverno nvarchar(30)
	declare @t_edriverno nvarchar(30)
	declare @t_carno nvarchar(20)
	declare @t_po nvarchar(20)
	declare @t_addr nvarchar(20)
	declare @t_carteamno nvarchar(max)
	declare @t_calctype nvarchar(max)
	declare @t_other nvarchar(max)
	declare @t_calcmoney nvarchar(max)
	declare @t_sort8 nvarchar(max)
	declare @t_sort10 nvarchar(max)
	declare @t_sort3 nvarchar(max)
	declare @t_bsalesno nvarchar(20)
	declare @t_esalesno nvarchar(20)
	declare @t_field5 nvarchar(max)
	declare @t_yproduct nvarchar(max)
	declare @t_yaddr nvarchar(max)
	declare @t_yboatname nvarchar(max)
	declare @t_sort6 nvarchar(max)
	declare @t_carkindno nvarchar(max)
	declare @t_sort5 nvarchar(max)	
	declare @t_field13 nvarchar(max)	
	declare @t_sort13 nvarchar(max)	
	declare @t_field1 nvarchar(max)	
	declare @t_sort1 nvarchar(max)	
	declare @t_acomp nvarchar(max)	
	declare @t_sort14 nvarchar(max)
	declare @t_trandono nvarchar(max)
	declare @t_option14 nvarchar(max)
	declare @t_baddrno nvarchar(20)
	declare @t_eaddrno nvarchar(20)
	declare @t_btrandate nvarchar(10)
	declare @t_etrandate nvarchar(10)
	declare @t_plusmoney int
	declare @t_minusmoney int
	
	set @t_accy = [1]
	set @t_bdate = case when '#non'=[2] then '' else [2] end
	set @t_edate = case when '#non'=[3] then char(255) else [3] end
	set @t_bcustno = case when '#non'=[4] then '' else [4] end
	set @t_ecustno = case when '#non'=[5] then char(255) else [5] end
	set @t_bdriverno = case when '#non'=[6] then '' else [6] end
	set @t_edriverno = case when '#non'=[7] then char(255) else [7] end
	set @t_carno = case when '#non'=[8] then '' else [8] end
	set @t_po = case when '#non'=[9] then '' else [9] end
	set @t_addr = case when '#non'=[10] then '' else [10] end
	set @t_carteamno = case when '#non'=[11] then '' else [11] end
	set @t_calctype = case when '#non'=[12] then '' else [12] end
	set @t_other = case when '#non'=[13] then '' else [13] end
	set @t_calcmoney = case when '#non'=[14] then '' else [14] end
	set @t_sort8 = case when '#non'=[15] then '' else [15] end
	set @t_sort10 =  case when '#non'=[16] then '' else [16] end
	set @t_sort3 = case when '#non'=[17] then '' else [17] end
	set @t_bsalesno = case when '#non'=[18] then '' else [18] end
	set @t_esalesno = case when '#non'=[19] then char(255) else [19] end
	set @t_field5 = case when '#non'=[20] then '' else [20] end
	set @t_yproduct = case when '#non'=[21] then '' else [21] end
	set @t_yaddr = case when '#non'=[22] then '' else [22] end
	set @t_yboatname = case when '#non'=[23] then '' else [23] end
	set @t_sort6 = case when '#non'=[24] then '' else [24] end
	set @t_carkindno = case when '#non'=[25] then '' else [25] end
	set @t_sort5 = case when '#non'=[26] then '' else [26] end
	set @t_field13 = case when '#non'=[27] then '' else [27] end
	set @t_sort13 = case when '#non'=[28] then '' else [28] end
	set @t_field1 = case when '#non'=[29] then '' else [29] end
	set @t_sort1 = case when '#non'=[30] then '' else [30] end
	set @t_acomp = case when '#non'=[31] then '' else [31] end
	set @t_sort14 = case when '#non'=[32] then '' else [32] end
	set @t_trandono = case when '#non'=[33] then '' else [33] end
	set @t_option14 = case when '#non'=[34] then '' else [34] end
	set @t_baddrno = case when '#non'=[35] then '' else [35] end
	set @t_eaddrno = case when '#non'=[36] then char(255) else [36] end
	set @t_btrandate = case when '#non'=[37] then '' else [37] end
	set @t_etrandate = case when '#non'=[38] then char(255) else [38] end
	set @t_plusmoney = case when '#non'=[39] then '0' else cast([39] as int) end
	set @t_minusmoney = case when '#non'=[40]then '0' else cast([40] as int) end

	declare @t_date nvarchar(10)
	declare @t_bdatea nvarchar(10)
	declare @t_edatea nvarchar(10)

	set @t_bdatea = convert(nvarchar(4),convert(int,LEFT(@t_bdate,3))+1911)+'-'+SUBSTRING(@t_bdate,5,2)+'-'+RIGHT(@t_bdate,2)
	set @t_edatea = convert(nvarchar(4),convert(int,LEFT(@t_edate,3))+1911)+'-'+SUBSTRING(@t_edate,5,2)+'-'+RIGHT(@t_edate,2)
	set @t_date=@t_bdatea

	if(isdate(@t_bdatea)=0 or isdate(@t_edatea)=0)
	begin
		select '0' gno,'' [date],0 mount,'日期錯誤' memo 
		return	
	end
	if(DATEDIFF(MM,@t_bdatea,@t_edatea)>2)
	begin
		select '0' gno,'' [date],0 mount,'查詢區間不可超過三個月' memo 
		return	
	end
	declare @listDate table(
		[date] nvarchar(10),
		[mount] int,
		[memo] nvarchar(max)
	)

	while (@t_date between @t_bdatea and @t_edatea)
	begin
		insert into @listDate select right('00'+convert(nvarchar(3),convert(int,YEAR(@t_date))-1911),3)+'/'+right('0'+convert(nvarchar(2),convert(int,MONTH(@t_date))),2)+'/'+right('0'+convert(nvarchar(2),convert(int,DAY(@t_date))),2),0,''
		set @t_date= convert(date,DATEADD(DD,1,@t_date),111)
	end

	declare @detail table(
		carno nvarchar(20),
		[date] nvarchar(10)
	)
	set @cmd = "select DISTINCT a.carno,a.datea
				from trans"+@t_accy+" a
				left join car2 b on b.noa=a.carno
				where b.cartype='2' and 
					(a.datea between @t_bdate and @t_edate)
				order by a.carno,a.datea"
	insert into @detail
	execute sp_executesql @cmd,N'@t_bdate nvarchar(10),@t_edate nvarchar(10)',@t_bdate=@t_bdate,@t_edate=@t_edate
	declare @tmp table(
		[date] nvarchar(10),
		[memo] nvarchar(max)
	)

	declare @date nvarchar(10)
	declare @carno nvarchar(20)

	declare cursor_table cursor for
	select [date],carno 
	from @listDate listDate,(select carno from @detail group by carno) listCarno
	where not exists(select * from @detail where [date]= listDate.date and carno=listCarno.carno)
	open cursor_table
	fetch next from cursor_table
	into @date,@carno
	while(@@FETCH_STATUS <> -1)
	begin
		update top(1) @listDate set mount=mount+1,memo=memo+@carno+',' where [date]=@date
		fetch next from cursor_table
		into @date,@carno
	end
	close cursor_table
	deallocate cursor_table

	select '0' gno,[date],mount,case when len(memo)>0 then LEFT(memo,len(memo)-1) else memo end memo from @listDate;

z_trana10:--z_trana10
	SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	declare @t_accy nvarchar(10)
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_bcustno nvarchar(30)
	declare @t_ecustno nvarchar(30)
	declare @t_bdriverno nvarchar(30)
	declare @t_edriverno nvarchar(30)
	declare @t_carno nvarchar(20)
	declare @t_po nvarchar(20)
	declare @t_addr nvarchar(20)
	declare @t_carteamno nvarchar(max)
	declare @t_calctype nvarchar(max)
	declare @t_other nvarchar(max)
	declare @t_calcmoney nvarchar(max)
	declare @t_sort8 nvarchar(max)
	declare @t_sort10 nvarchar(max)
	declare @t_sort3 nvarchar(max)
	declare @t_bsalesno nvarchar(20)
	declare @t_esalesno nvarchar(20)
	declare @t_field5 nvarchar(max)
	declare @t_yproduct nvarchar(max)
	declare @t_yaddr nvarchar(max)
	declare @t_yboatname nvarchar(max)
	declare @t_sort6 nvarchar(max)
	declare @t_carkindno nvarchar(max)
	declare @t_sort5 nvarchar(max)	
	declare @t_field13 nvarchar(max)	
	declare @t_sort13 nvarchar(max)	
	declare @t_field1 nvarchar(max)	
	declare @t_sort1 nvarchar(max)	
	declare @t_acomp nvarchar(max)	
	declare @t_sort14 nvarchar(max)
	declare @t_trandono nvarchar(max)
	declare @t_option14 nvarchar(max)
	declare @t_baddrno nvarchar(20)
	declare @t_eaddrno nvarchar(20)
	declare @t_btrandate nvarchar(10)
	declare @t_etrandate nvarchar(10)
	declare @t_plusmoney int
	declare @t_minusmoney int
	
	set @t_accy = [1]
	set @t_bdate = case when '#non'=[2] then '' else [2] end
	set @t_edate = case when '#non'=[3] then char(255) else [3] end
	set @t_bcustno = case when '#non'=[4] then '' else [4] end
	set @t_ecustno = case when '#non'=[5] then char(255) else [5] end
	set @t_bdriverno = case when '#non'=[6] then '' else [6] end
	set @t_edriverno = case when '#non'=[7] then char(255) else [7] end
	set @t_carno = case when '#non'=[8] then '' else [8] end
	set @t_po = case when '#non'=[9] then '' else [9] end
	set @t_addr = case when '#non'=[10] then '' else [10] end
	set @t_carteamno = case when '#non'=[11] then '' else [11] end
	set @t_calctype = case when '#non'=[12] then '' else [12] end
	set @t_other = case when '#non'=[13] then '' else [13] end
	set @t_calcmoney = case when '#non'=[14] then '' else [14] end
	set @t_sort8 = case when '#non'=[15] then '' else [15] end
	set @t_sort10 =  case when '#non'=[16] then '' else [16] end
	set @t_sort3 = case when '#non'=[17] then '' else [17] end
	set @t_bsalesno = case when '#non'=[18] then '' else [18] end
	set @t_esalesno = case when '#non'=[19] then char(255) else [19] end
	set @t_field5 = case when '#non'=[20] then '' else [20] end
	set @t_yproduct = case when '#non'=[21] then '' else [21] end
	set @t_yaddr = case when '#non'=[22] then '' else [22] end
	set @t_yboatname = case when '#non'=[23] then '' else [23] end
	set @t_sort6 = case when '#non'=[24] then '' else [24] end
	set @t_carkindno = case when '#non'=[25] then '' else [25] end
	set @t_sort5 = case when '#non'=[26] then '' else [26] end
	set @t_field13 = case when '#non'=[27] then '' else [27] end
	set @t_sort13 = case when '#non'=[28] then '' else [28] end
	set @t_field1 = case when '#non'=[29] then '' else [29] end
	set @t_sort1 = case when '#non'=[30] then '' else [30] end
	set @t_acomp = case when '#non'=[31] then '' else [31] end
	set @t_sort14 = case when '#non'=[32] then '' else [32] end
	set @t_trandono = case when '#non'=[33] then '' else [33] end
	set @t_option14 = case when '#non'=[34] then '' else [34] end
	set @t_baddrno = case when '#non'=[35] then '' else [35] end
	set @t_eaddrno = case when '#non'=[36] then char(255) else [36] end
	set @t_btrandate = case when '#non'=[37] then '' else [37] end
	set @t_etrandate = case when '#non'=[38] then char(255) else [38] end
	set @t_plusmoney = case when '#non'=[39] then '0' else cast([39] as int) end
	set @t_minusmoney = case when '#non'=[40]then '0' else cast([40] as int) end
	-------------------------------------------------------------------------------------------------------------
	declare @n int
	declare @minN int
	set @minN = 20
	declare @gkey nvarchar(10)
	declare @gname nvarchar(20)
	declare @carno nvarchar(20)
	declare @driverno nvarchar(20)
	declare @datea nvarchar(10)
	declare @fieldh nvarchar(10)
	declare @fieldm nvarchar(10)
	declare @money float
	declare @title nvarchar(30)
	declare @tolls float
	declare @reserve float
	declare @mount float
	declare @wmoney float
	declare @cmoney float
	declare @carteamno nvarchar(20)
	declare @resultH nvarchar(20)
	declare @resultM nvarchar(10)
	declare @fieldA nvarchar(20)
	declare @fieldB nvarchar(20)
	declare @fieldC nvarchar(20)
	declare @fieldD nvarchar(20)
	declare @product float
	declare @result nvarchar(max)
	declare @typea nvarchar(10)
	declare  @t_isDiscount  int
	declare  @mon  nvarchar(10)
	declare  @team  nvarchar(20)
	declare  @unit  nvarchar(20)
	declare @custno nvarchar(20)
	declare @comp nvarchar(40)
	declare @total2 float
	declare @carteam nvarchar(20)
	declare @miles float
	declare @driver nvarchar(20)
	declare @caryear nvarchar(10)
	declare @carbrand nvarchar(10)
	-------------------------------------------------------------------------------------------------------------
	--解析要計算的種類
	declare @string nvarchar(max)
	IF OBJECT_ID('tempdb..#carteam')is not null
	BEGIN
		set @cmd = 'drop table #carteam'
		EXECUTE sp_executesql @cmd
	END
	create table #carteam(
		noa nvarchar(10)
	)
	set @string = @t_carteamno
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #carteam select @string
			end
			break
		end
		insert into #carteam select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	IF OBJECT_ID('tempdb..#calctype')is not null
	BEGIN
		set @cmd = 'drop table #calctype'
		EXECUTE sp_executesql @cmd
	END
	create table #calctype(
		noa nvarchar(10)
	)
	set @string = @t_calctype
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #calctype select @string
			end
			break
		end
		insert into #calctype select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	set @t_isDiscount=0
	set @string = @t_other
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				if  @string='discount'
					set  @t_isDiscount  =  1
			end
			break
		end
		if   LEFT(@string,@n-1)='discount'
			set  @t_isDiscount  =  1
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	-------------------------------------------------------------------------------------------------------------	
	-------------------------------------------------------------------------------------------------------------
	declare @tmp1 table(
		carno nvarchar(20),
		driverno nvarchar(20),
		carteamno nvarchar(20),
		carteam nvarchar(20),
		datea nvarchar(10),
		[money] float,
		miles float
	)
	set @cmd =
		" select a.carno,a.driverno,a.carteamno,isnull(e.team,''),a.datea,"+
		" sum(round("+@t_calcmoney+",0)) total,"+
		" sum(round(a.miles,0))"+
		" from trans"+@t_accy+" a"+
		" left join #calctype b on a.calctype=b.noa"+
		" left join calctype c on left(a.calctype,1)=c.noa"+
		" left join #carteam d on a.carteamno=d.noa"+
		" left join carteam e on a.carteamno=e.noa"+
		" where a.calctype=b.noa  and  a.carteamno=d.noa"+
		" and (len(@t_carno)=0 or a.carno=@t_carno)"+
		" and (a.datea between @t_bdate and @t_edate)"+
		" and (a.custno between @t_bcustno and @t_ecustno)"+
		" and (a.driverno between @t_bdriverno and @t_edriverno)"+
		" and (len(@t_po)=0 or a.po=@t_po)"+
		" group by carno,driverno,a.carteamno,isnull(e.team,''),a.datea"	
	insert into @tmp1
	EXECUTE sp_executesql @cmd,N'@t_bdate nvarchar(10),@t_edate nvarchar(10),@t_bdriverno nvarchar(20),@t_edriverno nvarchar(20),@t_carno nvarchar(20),@t_bcustno  nvarchar(20),@t_ecustno  nvarchar(20),@t_po  nvarchar(30)',
		@t_bdate=@t_bdate,@t_edate=@t_edate,@t_bdriverno=@t_bdriverno,@t_edriverno=@t_edriverno,@t_carno=@t_carno,@t_bcustno=@t_bcustno,@t_ecustno=@t_ecustno,@t_po=@t_po
	
	declare @tmp2 table(
		carno nvarchar(20),
		driverno nvarchar(20),
		mount float,
		[money] float
	)
	set @cmd=
		" select carno,driverno,sum(isnull(mount,0)),sum(isnull(money,0)) from oil "+
		" where (len(@t_carno)=0 or carno=@t_carno)"+
		" and (datea between @t_bdate and @t_edate)"+
		" and (driverno between @t_bdriverno and @t_edriverno)"+
		" and (isnull(mount,0)>0 or isnull(money,0)>0) "+
		" group by carno,driverno"	
	insert into @tmp2	
	EXECUTE sp_executesql @cmd,N'@t_bdate nvarchar(10),@t_edate nvarchar(10),@t_bdriverno nvarchar(20),@t_edriverno nvarchar(20),@t_carno nvarchar(20),@t_bcustno  nvarchar(20),@t_ecustno  nvarchar(20),@t_po  nvarchar(30)',
		@t_bdate=@t_bdate,@t_edate=@t_edate,@t_bdriverno=@t_bdriverno,@t_edriverno=@t_edriverno,@t_carno=@t_carno,@t_bcustno=@t_bcustno,@t_ecustno=@t_ecustno,@t_po=@t_po	
	------------------------------------------------------------------------------------------------------------------
	IF OBJECT_ID('tempdb..#z_trana10')is not null
	BEGIN
		set @cmd = 'drop table #z_trana10'
		EXECUTE sp_executesql @cmd
	END
	create table #z_trana10(
		gno nvarchar(3),
		carno nvarchar(20),
		driverno nvarchar(20),
		driver nvarchar(20),
		carteamno nvarchar(10),
		carteam nvarchar(20),
		[money] float,
		cmoney nvarchar(20),
		oilmount float,
		oilmoney float,
		coilmoney nvarchar(20),
		rate1 nvarchar(20),
		[day] int,
		miles float,
		rate2 nvarchar(20),
		caryear nvarchar(10),
		carbrand nvarchar(20)
	)

	declare cursor_table cursor for
	select carno,driverno,carteamno,carteam,sum([money]),sum(miles) from @tmp1 group by carno,driverno,carteamno,carteam
	open cursor_table
	fetch next from cursor_table
	into @carno,@driverno,@carteamno,@carteam,@money,@miles
	while(@@FETCH_STATUS <> -1)
	begin
		set @driver=''
		select @driver=namea from driver where noa=@driverno
		set @n = 0
		select @n=count(*) from (select distinct datea from @tmp1 where carno=@carno and driverno=@driverno and carteamno=@carteamno)as a
		insert into #z_trana10(gno,carno,driverno,driver,carteamno,carteam,[day],[money],miles)values('0',@carno,@driverno,@driver,@carteamno,@carteam,@n,@money,@miles)
		fetch next from cursor_table
		into @carno,@driverno,@carteamno,@carteam,@money,@miles
	end
	close cursor_table
	deallocate cursor_table
	
	declare cursor_table cursor for
	select carno,driverno,mount,[money] from @tmp2
	open cursor_table
	fetch next from cursor_table
	into @carno,@driverno,@mount,@money
	while(@@FETCH_STATUS <> -1)
	begin
		if not exists(select * from #z_trana10 where carno=@carno and driverno=@driverno)
		begin
			set @driver=''
			select @driver=namea from driver where noa=@driverno
			insert into #z_trana10(gno,carno,driverno,driver)values('0',@carno,@driverno,@driver)
		end
		update top(1) #z_trana10 set oilmount=@mount,oilmoney=@money where carno=@carno and driverno=@driverno
		fetch next from cursor_table
		into @carno,@driverno,@mount,@money
	end
	close cursor_table
	deallocate cursor_table
	
	declare cursor_table cursor for
	select carno from #z_trana10 group by carno
	open cursor_table
	fetch next from cursor_table
	into @carno
	while(@@FETCH_STATUS <> -1)
	begin
		select @caryear = '',@carbrand=''
		select @caryear=a.caryear,@carbrand=isnull(b.brand,'') from car2 a left join carbrand b on a.carbrandno=b.noa where a.carno=@carno
		
		update #z_trana10 set caryear=@caryear,carbrand=@carbrand,
			cmoney=reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,[money]),1)),4,12)),
			coilmoney=reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,oilmoney),1)),4,12)),
			rate1=convert(varchar(15),case when [money]=0 then 0 else ROUND(oilmoney/[money]*100,0) end),
			rate2=convert(varchar(15),convert(decimal(10, 3),case when oilmount=0 then 0 else ROUND(miles/oilmount,3) end)) 
		where carno=@carno
		
		fetch next from cursor_table
		into @carno
	end
	close cursor_table
	deallocate cursor_table
	
	set @cmd = " select gno,carteam a,caryear b,carno c,driver d,carbrand e,"+
			   " cmoney f,coilmoney g,rate1 h,[day] i,rate2 j"+	 
			   " from #z_trana10 order by ["+@t_sort10+"],carno"
	EXECUTE sp_executesql @cmd;


z_trana9:--z_trana9
	SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	declare @t_accy nvarchar(10)
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_bcustno nvarchar(30)
	declare @t_ecustno nvarchar(30)
	declare @t_bdriverno nvarchar(30)
	declare @t_edriverno nvarchar(30)
	declare @t_carno nvarchar(20)
	declare @t_po nvarchar(20)
	declare @t_addr nvarchar(20)
	declare @t_carteamno nvarchar(max)
	declare @t_calctype nvarchar(max)
	declare @t_other nvarchar(max)
	declare @t_calcmoney nvarchar(max)
	declare @t_sort8 nvarchar(max)
	declare @t_sort10 nvarchar(max)
	declare @t_sort3 nvarchar(max)
	declare @t_bsalesno nvarchar(20)
	declare @t_esalesno nvarchar(20)
	declare @t_field5 nvarchar(max)
	declare @t_yproduct nvarchar(max)
	declare @t_yaddr nvarchar(max)
	declare @t_yboatname nvarchar(max)
	declare @t_sort6 nvarchar(max)
	declare @t_carkindno nvarchar(max)
	declare @t_sort5 nvarchar(max)	
	declare @t_field13 nvarchar(max)	
	declare @t_sort13 nvarchar(max)	
	declare @t_field1 nvarchar(max)	
	declare @t_sort1 nvarchar(max)	
	declare @t_acomp nvarchar(max)	
	declare @t_sort14 nvarchar(max)
	declare @t_trandono nvarchar(max)
	declare @t_option14 nvarchar(max)
	declare @t_baddrno nvarchar(20)
	declare @t_eaddrno nvarchar(20)
	declare @t_btrandate nvarchar(10)
	declare @t_etrandate nvarchar(10)
	declare @t_plusmoney int
	declare @t_minusmoney int
	
	set @t_accy = [1]
	set @t_bdate = case when '#non'=[2] then '' else [2] end
	set @t_edate = case when '#non'=[3] then char(255) else [3] end
	set @t_bcustno = case when '#non'=[4] then '' else [4] end
	set @t_ecustno = case when '#non'=[5] then char(255) else [5] end
	set @t_bdriverno = case when '#non'=[6] then '' else [6] end
	set @t_edriverno = case when '#non'=[7] then char(255) else [7] end
	set @t_carno = case when '#non'=[8] then '' else [8] end
	set @t_po = case when '#non'=[9] then '' else [9] end
	set @t_addr = case when '#non'=[10] then '' else [10] end
	set @t_carteamno = case when '#non'=[11] then '' else [11] end
	set @t_calctype = case when '#non'=[12] then '' else [12] end
	set @t_other = case when '#non'=[13] then '' else [13] end
	set @t_calcmoney = case when '#non'=[14] then '' else [14] end
	set @t_sort8 = case when '#non'=[15] then '' else [15] end
	set @t_sort10 =  case when '#non'=[16] then '' else [16] end
	set @t_sort3 = case when '#non'=[17] then '' else [17] end
	set @t_bsalesno = case when '#non'=[18] then '' else [18] end
	set @t_esalesno = case when '#non'=[19] then char(255) else [19] end
	set @t_field5 = case when '#non'=[20] then '' else [20] end
	set @t_yproduct = case when '#non'=[21] then '' else [21] end
	set @t_yaddr = case when '#non'=[22] then '' else [22] end
	set @t_yboatname = case when '#non'=[23] then '' else [23] end
	set @t_sort6 = case when '#non'=[24] then '' else [24] end
	set @t_carkindno = case when '#non'=[25] then '' else [25] end
	set @t_sort5 = case when '#non'=[26] then '' else [26] end
	set @t_field13 = case when '#non'=[27] then '' else [27] end
	set @t_sort13 = case when '#non'=[28] then '' else [28] end
	set @t_field1 = case when '#non'=[29] then '' else [29] end
	set @t_sort1 = case when '#non'=[30] then '' else [30] end
	set @t_acomp = case when '#non'=[31] then '' else [31] end
	set @t_sort14 = case when '#non'=[32] then '' else [32] end
	set @t_trandono = case when '#non'=[33] then '' else [33] end
	set @t_option14 = case when '#non'=[34] then '' else [34] end
	set @t_baddrno = case when '#non'=[35] then '' else [35] end
	set @t_eaddrno = case when '#non'=[36] then char(255) else [36] end
	set @t_btrandate = case when '#non'=[37] then '' else [37] end
	set @t_etrandate = case when '#non'=[38] then char(255) else [38] end
	set @t_plusmoney = case when '#non'=[39] then '0' else cast([39] as int) end
	set @t_minusmoney = case when '#non'=[40]then '0' else cast([40] as int) end
	-------------------------------------------------------------------------------------------------------------
	declare @n int
	declare @minN int
	set @minN = 20
	declare @gkey nvarchar(10)
	declare @gname nvarchar(20)
	declare @carno nvarchar(20)
	declare @driverno nvarchar(20)
	declare @datea nvarchar(10)
	declare @fieldh nvarchar(10)
	declare @fieldm nvarchar(10)
	declare @money float
	declare @title nvarchar(30)
	declare @tolls float
	declare @reserve float
	declare @mount float
	declare @wmoney float
	declare @cmoney float
	declare @carteamno nvarchar(20)
	declare @resultH nvarchar(20)
	declare @resultM nvarchar(10)
	declare @fieldA nvarchar(20)
	declare @fieldB nvarchar(20)
	declare @fieldC nvarchar(20)
	declare @fieldD nvarchar(20)
	declare @product float
	declare @result nvarchar(max)
	declare @typea nvarchar(10)
	declare  @t_isDiscount  int
	declare  @mon  nvarchar(10)
	declare  @team  nvarchar(20)
	declare  @unit  nvarchar(20)
	declare @custno nvarchar(20)
	declare @comp nvarchar(40)
	declare @po nvarchar(30)
	declare @rate float
	declare @miles float
	declare @driver nvarchar(30)
	-------------------------------------------------------------------------------------------------------------
	--解析要計算的種類
	declare @string nvarchar(max)
	IF OBJECT_ID('tempdb..#carteam')is not null
	BEGIN
		set @cmd = 'drop table #carteam'
		EXECUTE sp_executesql @cmd
	END
	create table #carteam(
		noa nvarchar(10)
	)
	set @string = @t_carteamno
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #carteam select @string
			end
			break
		end
		insert into #carteam select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	IF OBJECT_ID('tempdb..#calctype')is not null
	BEGIN
		set @cmd = 'drop table #calctype'
		EXECUTE sp_executesql @cmd
	END
	create table #calctype(
		noa nvarchar(10)
	)
	set @string = @t_calctype
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #calctype select @string
			end
			break
		end
		insert into #calctype select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	set @t_isDiscount=0
	set @string = @t_other
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				if  @string='discount'
					set  @t_isDiscount  =  1
			end
			break
		end
		if   LEFT(@string,@n-1)='discount'
			set  @t_isDiscount  =  1
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	-------------------------------------------------------------------------------------------------------------

	set @cmd= 
	" select a.carno,a.driver,sum(isnull(a.miles,0))"+
	" from trans"+@t_accy+" a"+
	" left join #calctype b on a.calctype=b.noa"+
	" left join calctype c on left(a.calctype,1)=c.noa"+
	" left join #carteam d on a.carteamno=d.noa"+
	" left join cust e on a.custno=e.noa"+
	" where a.calctype=b.noa  and  a.carteamno=d.noa "+
	"	and (len(@t_carno)=0 or a.carno=@t_carno)"+
	"	and (a.datea between @t_bdate and @t_edate)"+
	"	and (a.custno between @t_bcustno and @t_ecustno)"+
	"	and (a.driverno between @t_bdriverno and @t_edriverno)"+
	"	and (len(@t_po)=0 or a.po=@t_po) and isnull(a.miles,0)>0"+
	" group by a.carno,a.driver"
	
	declare @tmp1 table(
		carno nvarchar(20),
		driver nvarchar(20),
		miles float
	)
	insert into @tmp1
	EXECUTE sp_executesql @cmd,N'@t_bdate nvarchar(10),@t_edate nvarchar(10),@t_bdriverno nvarchar(20),@t_edriverno nvarchar(20),@t_carno nvarchar(20),@t_bcustno  nvarchar(20),@t_ecustno  nvarchar(20),@t_po  nvarchar(30)',
		@t_bdate=@t_bdate,@t_edate=@t_edate,@t_bdriverno=@t_bdriverno,@t_edriverno=@t_edriverno,@t_carno=@t_carno,@t_bcustno=@t_bcustno,@t_ecustno=@t_ecustno,@t_po=@t_po
	----------------------------------------------------------------------------
	declare @tmp2 table(
		carno nvarchar(20),
		driver nvarchar(20),
		mount float
	)
	insert into @tmp2
	select carno,driver,SUM(isnull(mount,0)) 
	from oil 
	where (datea between @t_bdate and @t_edate)
		and (driverno between @t_bdriverno and @t_edriverno)
		and (len(@t_carno)=0 or carno=@t_carno)
	group by carno,driver
	
	declare @tmp table(
		carno nvarchar(20),
		miles float,
		cmiles nvarchar(20),
		mount float,
		cmount nvarchar(20),
		rate float,
		crate nvarchar(20),
		memo nvarchar(max)
	)
	declare cursor_table cursor for
	select a.carno,SUM(a.miles) miles,SUM(a.mount) mount
	from(
		select carno,SUM(miles) miles,0 mount from @tmp1 group by carno
		union all
		select carno,0,SUM(mount) from @tmp2 group by carno)as a
	group by carno
	open cursor_table
	fetch next from cursor_table
	into @carno,@miles,@mount
	while(@@FETCH_STATUS <> -1)
	begin
		set @cmd=''
		
		declare cursor_table2 cursor for
		select driver
		from(select driver from @tmp1 where carno=@carno
			union all
			select driver from @tmp2 where carno=@carno)as a
		group by driver
		open cursor_table2
		fetch next from cursor_table2
		into @driver
		while(@@FETCH_STATUS <> -1)
		begin
			set @cmd = @cmd +SPACE(2)+@driver
			fetch next from cursor_table2
			into @driver
		end
		close cursor_table2
		deallocate cursor_table2
		
		set @rate = case when @mount>0 then round(@miles/@mount,3) else 0 end
		insert into @tmp (carno,miles,mount,rate,memo)values(@carno,@miles,@mount,@rate,ltrim(@cmd))
		
		fetch next from cursor_table
		into @carno,@miles,@mount
	end
	close cursor_table
	deallocate cursor_table
	
	update @tmp set cmiles=reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,miles),1)),4,12)),
						cmount=reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,mount),1)),4,12)),
						crate=convert(nvarchar(15),CONVERT(money,rate),1)

	select '0' gno,* from @tmp order by carno;



z_trana6:--z_trana6
	SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	declare @t_accy nvarchar(10)
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_bcustno nvarchar(30)
	declare @t_ecustno nvarchar(30)
	declare @t_bdriverno nvarchar(30)
	declare @t_edriverno nvarchar(30)
	declare @t_carno nvarchar(20)
	declare @t_po nvarchar(20)
	declare @t_addr nvarchar(20)
	declare @t_carteamno nvarchar(max)
	declare @t_calctype nvarchar(max)
	declare @t_other nvarchar(max)
	declare @t_calcmoney nvarchar(max)
	declare @t_sort8 nvarchar(max)
	declare @t_sort10 nvarchar(max)
	declare @t_sort3 nvarchar(max)
	declare @t_bsalesno nvarchar(20)
	declare @t_esalesno nvarchar(20)
	declare @t_field5 nvarchar(max)
	declare @t_yproduct nvarchar(max)
	declare @t_yaddr nvarchar(max)
	declare @t_yboatname nvarchar(max)
	declare @t_sort6 nvarchar(max)
	declare @t_carkindno nvarchar(max)
	declare @t_sort5 nvarchar(max)	
	declare @t_field13 nvarchar(max)	
	declare @t_sort13 nvarchar(max)	
	declare @t_field1 nvarchar(max)	
	declare @t_sort1 nvarchar(max)	
	declare @t_acomp nvarchar(max)	
	declare @t_sort14 nvarchar(max)
	declare @t_trandono nvarchar(max)
	declare @t_option14 nvarchar(max)
	declare @t_baddrno nvarchar(20)
	declare @t_eaddrno nvarchar(20)
	declare @t_btrandate nvarchar(10)
	declare @t_etrandate nvarchar(10)
	declare @t_plusmoney int
	declare @t_minusmoney int
	
	set @t_accy = [1]
	set @t_bdate = case when '#non'=[2] then '' else [2] end
	set @t_edate = case when '#non'=[3] then char(255) else [3] end
	set @t_bcustno = case when '#non'=[4] then '' else [4] end
	set @t_ecustno = case when '#non'=[5] then char(255) else [5] end
	set @t_bdriverno = case when '#non'=[6] then '' else [6] end
	set @t_edriverno = case when '#non'=[7] then char(255) else [7] end
	set @t_carno = case when '#non'=[8] then '' else [8] end
	set @t_po = case when '#non'=[9] then '' else [9] end
	set @t_addr = case when '#non'=[10] then '' else [10] end
	set @t_carteamno = case when '#non'=[11] then '' else [11] end
	set @t_calctype = case when '#non'=[12] then '' else [12] end
	set @t_other = case when '#non'=[13] then '' else [13] end
	set @t_calcmoney = case when '#non'=[14] then '' else [14] end
	set @t_sort8 = case when '#non'=[15] then '' else [15] end
	set @t_sort10 =  case when '#non'=[16] then '' else [16] end
	set @t_sort3 = case when '#non'=[17] then '' else [17] end
	set @t_bsalesno = case when '#non'=[18] then '' else [18] end
	set @t_esalesno = case when '#non'=[19] then char(255) else [19] end
	set @t_field5 = case when '#non'=[20] then '' else [20] end
	set @t_yproduct = case when '#non'=[21] then '' else [21] end
	set @t_yaddr = case when '#non'=[22] then '' else [22] end
	set @t_yboatname = case when '#non'=[23] then '' else [23] end
	set @t_sort6 = case when '#non'=[24] then '' else [24] end
	set @t_carkindno = case when '#non'=[25] then '' else [25] end
	set @t_sort5 = case when '#non'=[26] then '' else [26] end
	set @t_field13 = case when '#non'=[27] then '' else [27] end
	set @t_sort13 = case when '#non'=[28] then '' else [28] end
	set @t_field1 = case when '#non'=[29] then '' else [29] end
	set @t_sort1 = case when '#non'=[30] then '' else [30] end
	set @t_acomp = case when '#non'=[31] then '' else [31] end
	set @t_sort14 = case when '#non'=[32] then '' else [32] end
	set @t_trandono = case when '#non'=[33] then '' else [33] end
	set @t_option14 = case when '#non'=[34] then '' else [34] end
	set @t_baddrno = case when '#non'=[35] then '' else [35] end
	set @t_eaddrno = case when '#non'=[36] then char(255) else [36] end
	set @t_btrandate = case when '#non'=[37] then '' else [37] end
	set @t_etrandate = case when '#non'=[38] then char(255) else [38] end
	set @t_plusmoney = case when '#non'=[39] then '0' else cast([39] as int) end
	set @t_minusmoney = case when '#non'=[40]then '0' else cast([40] as int) end
	-------------------------------------------------------------------------------------------------------------
	declare @n int
	declare @minN int
	set @minN = 3
	declare @gkey nvarchar(10)
	declare @gname nvarchar(20)
	declare @carno nvarchar(20)
	declare @driverno nvarchar(20)
	declare @datea nvarchar(10)
	declare @fieldh nvarchar(10)
	declare @fieldm nvarchar(10)
	declare @money float
	declare @title nvarchar(30)
	declare @tolls float
	declare @reserve float
	declare @mount float
	declare @wmoney float
	declare @cmoney float
	declare @carteamno nvarchar(20)
	declare @resultH nvarchar(20)
	declare @resultM nvarchar(10)
	declare @fieldA nvarchar(20)
	declare @fieldB nvarchar(20)
	declare @fieldC nvarchar(20)
	declare @fieldD nvarchar(20)
	declare @product float
	declare @result nvarchar(max)
	declare @typea nvarchar(10)
	declare  @t_isDiscount  int
	declare  @mon  nvarchar(10)
	declare  @team  nvarchar(20)
	declare  @unit  nvarchar(20)
	declare @custno nvarchar(20)
	declare @comp nvarchar(40)
	-------------------------------------------------------------------------------------------------------------
	--解析要計算的種類
	declare @string nvarchar(max)
	IF OBJECT_ID('tempdb..#carteam')is not null
	BEGIN
		set @cmd = 'drop table #carteam'
		EXECUTE sp_executesql @cmd
	END
	create table #carteam(
		noa nvarchar(10)
	)
	set @string = @t_carteamno
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #carteam select @string
			end
			break
		end
		insert into #carteam select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	IF OBJECT_ID('tempdb..#calctype')is not null
	BEGIN
		set @cmd = 'drop table #calctype'
		EXECUTE sp_executesql @cmd
	END
	create table #calctype(
		noa nvarchar(10)
	)
	set @string = @t_calctype
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #calctype select @string
			end
			break
		end
		insert into #calctype select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	set @t_isDiscount=0
	set @string = @t_other
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				if  @string='discount'
					set  @t_isDiscount  =  1
			end
			break
		end
		if   LEFT(@string,@n-1)='discount'
			set  @t_isDiscount  =  1
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	-------------------------------------------------------------------------------------------------------------
	-------------------------------------------------------------------------------------------------------------
	--記錄欄位
	declare @field table(
		noa  nvarchar(20),
		team nvarchar(20),
		unit  nvarchar(20),
		field_mount_header nvarchar(10),
		field_mount nvarchar(10),
		field_money_header nvarchar(10),
		field_money nvarchar(10)
	)
	-------------------------------------------------------------------------------------------------------------
	-------------------------------------------------------------------------------------------------------------
	--暫存資料
	IF OBJECT_ID('tempdb..#z_trana6')is not null
	BEGIN
		set @cmd = 'drop table #z_trana6'
		EXECUTE sp_executesql @cmd
	END
	create table #z_trana6(
		gno nvarchar(3),
		custno nvarchar(20),
		comp nvarchar(40),
		primary key(custno,gno)
	)
	-------------------------------------------------------------------------------------------------------------
	
	-------------------------------------------------------------------------------------------------------------
	--出車單:客戶金額
	select @n= COUNT(1) from @field

	declare cursor_table cursor for
	select a.noa,a.team,a.unit from carteam a
	left join carteam b on a.noa=b.noa
	left join #carteam c on b.noa=c.noa
	where b.noa=c.noa
	group by a.noa,a.team,a.unit
	open cursor_table
	fetch next from cursor_table
	into @gkey,@gname,@unit
	while(@@FETCH_STATUS <> -1)
	begin
		set @n = @n + 1
		insert into @field
		select @gkey,@gname,@unit,
				"a"+right("00"+CONVERT(nvarchar(10),@n),3),
				"b"+right("00"+CONVERT(nvarchar(10),@n),3),
				"c"+right("00"+CONVERT(nvarchar(10),@n),3),
				"d"+right("00"+CONVERT(nvarchar(10),@n),3)
		set @cmd = "alter table #z_trana6 add a"+right("00"+CONVERT(nvarchar(10),@n),3)+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_trana6 add b"+right("00"+CONVERT(nvarchar(10),@n),3)+" float"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_trana6 add cb"+right("00"+CONVERT(nvarchar(10),@n),3)+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_trana6 add c"+right("00"+CONVERT(nvarchar(10),@n),3)+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_trana6 add d"+right("00"+CONVERT(nvarchar(10),@n),3)+" float"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_trana6 add cd"+right("00"+CONVERT(nvarchar(10),@n),3)+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		fetch next from cursor_table
		into @gkey,@gname,@unit
	end
	close cursor_table
	deallocate cursor_table
	
	select @n= COUNT(1) from @field
	while(@n<@minN)
	begin
		set  @n = @n +  1
		insert into @field
		select null,null,null,
				"a"+right("00"+CONVERT(nvarchar(10),@n),3),
				"b"+right("00"+CONVERT(nvarchar(10),@n),3),
				"c"+right("00"+CONVERT(nvarchar(10),@n),3),
				"d"+right("00"+CONVERT(nvarchar(10),@n),3)
		set @cmd = "alter table #z_trana6 add a"+right("00"+CONVERT(nvarchar(10),@n),3)+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_trana6 add b"+right("00"+CONVERT(nvarchar(10),@n),3)+" float"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_trana6 add cb"+right("00"+CONVERT(nvarchar(10),@n),3)+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_trana6 add c"+right("00"+CONVERT(nvarchar(10),@n),3)+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_trana6 add d"+right("00"+CONVERT(nvarchar(10),@n),3)+" float"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_trana6 add cd"+right("00"+CONVERT(nvarchar(10),@n),3)+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
	end
	--------------------------------------------------------------------------------------------------------------------
	declare @tmp1 table(
		custno nvarchar(20),
		carteamno nvarchar(10),
		mount float,
		[money] float
	)

	set @cmd =" select a.custno,a.carteamno,"
	if  @t_calcmoney='a.price*a.mount'
		set  @cmd  =  @cmd  +  "sum(a.mount),"
	else
		set  @cmd  =  @cmd  +  "sum(a.mount2),"
	set @cmd =	@cmd  +" sum(round("+@t_calcmoney+",0)) money"+
		" from trans"+@t_accy+" a"+
		" left join #calctype b on a.calctype=b.noa"+
		" left join calctype c on left(a.calctype,1)=c.noa"+
		" left join #carteam d on a.carteamno=d.noa"+
		" where a.calctype=b.noa  and  a.carteamno=d.noa"+
		" and (len(@t_carno)=0 or a.carno=@t_carno)"+
		" and (a.datea between @t_bdate and @t_edate)"+
		" and (a.custno between @t_bcustno and @t_ecustno)"+
		" and (a.driverno between @t_bdriverno and @t_edriverno)"+
		" and (len(@t_po)=0 or a.po=@t_po)"+
		" group by a.custno,a.carteamno"
	insert into @tmp1
	EXECUTE sp_executesql @cmd,N'@t_bdate nvarchar(10),@t_edate nvarchar(10),@t_bdriverno nvarchar(20),@t_edriverno nvarchar(20),@t_carno nvarchar(20),@t_bcustno  nvarchar(20),@t_ecustno  nvarchar(20),@t_po nvarchar(30)',
		@t_bdate=@t_bdate,@t_edate=@t_edate,@t_bdriverno=@t_bdriverno,@t_edriverno=@t_edriverno,@t_carno=@t_carno,@t_bcustno=@t_bcustno,@t_ecustno=@t_ecustno,@t_po=@t_po
	
	-------------------------------------------------------------------------------------------------------------
	
	declare cursor_table cursor for
	select custno,carteamno,mount,[money] from @tmp1
	open cursor_table
	fetch next from cursor_table
	into @custno,@carteamno,@mount,@money
	while(@@FETCH_STATUS <> -1)
	begin
		if exists(select * from @field where noa=@carteamno)
		begin
			select @fieldB='',@fieldD=''
			select @fieldB=field_mount,@fieldD=field_money from @field where noa=@carteamno
			if not  exists(select  *  from  #z_trana6  where  custno=@custno)
			begin
				set @comp=''
				select @comp=nick from cust where noa=@custno
				insert  into  #z_trana6(gno,custno,comp)values('0',@custno,@comp)
			end
			set  @cmd="update #z_trana6 set "+@fieldB+"=@mount,"+@fieldD+"=@money where gno='0' and custno=@custno"
			execute sp_executesql @cmd,N'@custno nvarchar(20),@mount  float,@money float',@custno=@custno,@mount=@mount,@money=@money
		end
		fetch next from cursor_table
		into @custno,@carteamno,@mount,@money
	end
	close cursor_table
	deallocate cursor_table
	-------------------------------------------
	set @result="select '1',char(255),''"
	
	
	declare cursor_table cursor for
	select unit,team,field_mount_header,field_mount,field_money_header,field_money from  @field
	open cursor_table
	fetch next from cursor_table
	into @unit,@team,@fieldA,@fieldB,@fieldC,@fieldD
	while(@@FETCH_STATUS <> -1)
	begin
		set @result = @result+",'',sum("+@fieldB+"),'','',sum("+@fieldD+"),''"
		
		set @cmd = "update #z_trana6 set " +@fieldA+"=@unit,"+@fieldC+"=@team"
		execute sp_executesql @cmd,N'@unit nvarchar(20),@team nvarchar(20)',@unit=@unit,@team=@team
		
		fetch next from cursor_table
		into @unit,@team,@fieldA,@fieldB,@fieldC,@fieldD
	end
	close cursor_table
	deallocate cursor_table
	set @result = @result+" from #z_trana6 group by gno"
	insert into #z_trana6
	execute sp_executesql @result
	----------------------------------------------------------------------------------------------------------------------
	declare cursor_table cursor for
	select field_mount,field_money from @field
	open cursor_table
	fetch next from cursor_table
	into @fieldB,@fieldD
	while(@@FETCH_STATUS <> -1)
	begin
		set @cmd="update #z_trana6 set c"+@fieldB+"=convert(nvarchar(15),CONVERT(money,"+@fieldB+"),1),"+
						" c"+@fieldD+"=reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,"+@fieldD+"),1)),4,12))"
		EXECUTE sp_executesql @cmd
		fetch next from cursor_table
		into @fieldB,@fieldD
	end
	close cursor_table
	deallocate cursor_table
	------------------------------------------------------------------------------------------------------------------------
	select @string=''
	select @string=field_money from @field where noa=@t_sort6
	
	if LEN(@string)>0
	begin
		set @cmd = "select * from #z_trana6 order by gno,"+@string+" desc"
		print @cmd
		EXECUTE sp_executesql @cmd
	end
	else
	begin
		select * from #z_trana6 order by custno,gno
	end;
z_trana5:--z_trana5
	SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	declare @t_accy nvarchar(10)
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_bcustno nvarchar(30)
	declare @t_ecustno nvarchar(30)
	declare @t_bdriverno nvarchar(30)
	declare @t_edriverno nvarchar(30)
	declare @t_carno nvarchar(20)
	declare @t_po nvarchar(20)
	declare @t_addr nvarchar(20)
	declare @t_carteamno nvarchar(max)
	declare @t_calctype nvarchar(max)
	declare @t_other nvarchar(max)
	declare @t_calcmoney nvarchar(max)
	declare @t_sort8 nvarchar(max)
	declare @t_sort10 nvarchar(max)
	declare @t_sort3 nvarchar(max)
	declare @t_bsalesno nvarchar(20)
	declare @t_esalesno nvarchar(20)
	declare @t_field5 nvarchar(max)
	declare @t_yproduct nvarchar(max)
	declare @t_yaddr nvarchar(max)
	declare @t_yboatname nvarchar(max)
	declare @t_sort6 nvarchar(max)
	declare @t_carkindno nvarchar(max)
	declare @t_sort5 nvarchar(max)	
	declare @t_field13 nvarchar(max)	
	declare @t_sort13 nvarchar(max)	
	declare @t_field1 nvarchar(max)	
	declare @t_sort1 nvarchar(max)	
	declare @t_acomp nvarchar(max)	
	declare @t_sort14 nvarchar(max)
	declare @t_trandono nvarchar(max)
	declare @t_option14 nvarchar(max)
	declare @t_baddrno nvarchar(20)
	declare @t_eaddrno nvarchar(20)
	declare @t_btrandate nvarchar(10)
	declare @t_etrandate nvarchar(10)
	declare @t_plusmoney int
	declare @t_minusmoney int
	
	set @t_accy = [1]
	set @t_bdate = case when '#non'=[2] then '' else [2] end
	set @t_edate = case when '#non'=[3] then char(255) else [3] end
	set @t_bcustno = case when '#non'=[4] then '' else [4] end
	set @t_ecustno = case when '#non'=[5] then char(255) else [5] end
	set @t_bdriverno = case when '#non'=[6] then '' else [6] end
	set @t_edriverno = case when '#non'=[7] then char(255) else [7] end
	set @t_carno = case when '#non'=[8] then '' else [8] end
	set @t_po = case when '#non'=[9] then '' else [9] end
	set @t_addr = case when '#non'=[10] then '' else [10] end
	set @t_carteamno = case when '#non'=[11] then '' else [11] end
	set @t_calctype = case when '#non'=[12] then '' else [12] end
	set @t_other = case when '#non'=[13] then '' else [13] end
	set @t_calcmoney = case when '#non'=[14] then '' else [14] end
	set @t_sort8 = case when '#non'=[15] then '' else [15] end
	set @t_sort10 =  case when '#non'=[16] then '' else [16] end
	set @t_sort3 = case when '#non'=[17] then '' else [17] end
	set @t_bsalesno = case when '#non'=[18] then '' else [18] end
	set @t_esalesno = case when '#non'=[19] then char(255) else [19] end
	set @t_field5 = case when '#non'=[20] then '' else [20] end
	set @t_yproduct = case when '#non'=[21] then '' else [21] end
	set @t_yaddr = case when '#non'=[22] then '' else [22] end
	set @t_yboatname = case when '#non'=[23] then '' else [23] end
	set @t_sort6 = case when '#non'=[24] then '' else [24] end
	set @t_carkindno = case when '#non'=[25] then '' else [25] end
	set @t_sort5 = case when '#non'=[26] then '' else [26] end
	set @t_field13 = case when '#non'=[27] then '' else [27] end
	set @t_sort13 = case when '#non'=[28] then '' else [28] end
	set @t_field1 = case when '#non'=[29] then '' else [29] end
	set @t_sort1 = case when '#non'=[30] then '' else [30] end
	set @t_acomp = case when '#non'=[31] then '' else [31] end
	set @t_sort14 = case when '#non'=[32] then '' else [32] end
	set @t_trandono = case when '#non'=[33] then '' else [33] end
	set @t_option14 = case when '#non'=[34] then '' else [34] end
	set @t_baddrno = case when '#non'=[35] then '' else [35] end
	set @t_eaddrno = case when '#non'=[36] then char(255) else [36] end
	set @t_btrandate = case when '#non'=[37] then '' else [37] end
	set @t_etrandate = case when '#non'=[38] then char(255) else [38] end
	set @t_plusmoney = case when '#non'=[39] then '0' else cast([39] as int) end
	set @t_minusmoney = case when '#non'=[40]then '0' else cast([40] as int) end
	------------------------------------------------------------------------------------------------------------------
	declare @minN int
	set @minN = 21
	declare @calctypeno nvarchar(10)
	declare @carkind nvarchar(20)
	declare @carkindno nvarchar(10)
	declare @carno nvarchar(20)
	declare @caryear nvarchar(20)
	declare @cylinder int
	declare @day int
	declare @driver nvarchar(20)
	declare @driverno nvarchar(20)
	declare @fieldh nvarchar(20)
	declare @fieldm nvarchar(20)
	declare @header nvarchar(20)
	declare @isDiscount int
	declare @miles float
	declare @mon nvarchar(10)
	declare @money float
	declare @mount float
	declare @n int
	declare @namea nvarchar(30)
	declare @noa nvarchar(30)
	declare @product float
	declare @resverve float
	declare @sort nvarchar(max)
	declare @string nvarchar(max)
	declare @tolls float
	declare @tax float
	------------------------------------------------------------------------------------------------------------------
	--解析要計算的種類
	IF OBJECT_ID('tempdb..#carteam')is not null
	BEGIN
		set @cmd = 'drop table #carteam'
		EXECUTE sp_executesql @cmd
	END
	create table #carteam(
		noa nvarchar(10)
	)
	set @string = @t_carteamno
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #carteam select @string
			end
			break
		end
		insert into #carteam select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	IF OBJECT_ID('tempdb..#calctype')is not null
	BEGIN
		set @cmd = 'drop table #calctype'
		EXECUTE sp_executesql @cmd
	END
	create table #calctype(
		noa nvarchar(10)
	)
	set @string = @t_calctype
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #calctype select @string
			end
			break
		end
		insert into #calctype select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	IF OBJECT_ID('tempdb..#carkind')is not null
	BEGIN
		set @cmd = 'drop table #carkind'
		EXECUTE sp_executesql @cmd
	END
	create table #carkind(
		noa nvarchar(10)
	)
	set @string = @t_carkindno
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #carkind select @string
			end
			break
		end
		insert into #carkind select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end

	set @isDiscount=0
	set @string = @t_other
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				if  @string='discount'
					set  @isDiscount  =  1
			end
			break
		end
		if   LEFT(@string,@n-1)='discount'
			set  @isDiscount  =  1
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	declare @display table(
		noa nvarchar(20)
	)
	set @string = @t_field5
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into @display select @string
			end
			break
		end
		insert into @display select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	--=========================================================================================================
	-------------------------------------------------------------------------------------------------------------
	--記錄欄位
	declare @field table(
		[key] nvarchar(20),
		fieldh nvarchar(10),
		fieldm nvarchar(10),
		[header] nvarchar(40),
		product float,
		isSum bit,
		sort nvarchar(10)
	)
	-------------------------------------------------------------------------------------------------------------
	--暫存資料
	IF OBJECT_ID('tempdb..#z_trana5')is not null
	BEGIN
		set @cmd = 'drop table #z_trana5'
		EXECUTE sp_executesql @cmd
	END
	create table #z_trana5(
		gno nvarchar(3),
		carno nvarchar(20),
		carkindno nvarchar(20),
		driverno nvarchar(20),
		mon nvarchar(20),
		tranmoney float,
		miles float,
		oilmount float,
		oilmoney float,
		rowheader nvarchar(20)
		
		primary key(carkindno,carno,driverno,mon)
	)
	-------------------------------------------------------------------------------------------------------------
	--車輛種類
	if exists(select * from @display where noa='carkind')
	begin
		select @n= COUNT(1) from @field
		set @n = @n + 1
		set @fieldh = "h"+right("00"+CONVERT(nvarchar(10),@n),3)
		set @fieldm = "m"+right("00"+CONVERT(nvarchar(10),@n),3)
		
		insert into @field([key],fieldh,fieldm,[header],product)
			values('carkind',@fieldh,@fieldm,'類別',0)
		
		set @cmd = "alter table #z_trana5 add "+@fieldh+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_trana5 add "+@fieldm+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
	end
	--年份
	if exists(select * from @display where noa='caryear')
	begin
		select @n= COUNT(1) from @field
		set @n = @n + 1
		set @fieldh = "h"+right("00"+CONVERT(nvarchar(10),@n),3)
		set @fieldm = "m"+right("00"+CONVERT(nvarchar(10),@n),3)
		
		insert into @field([key],fieldh,fieldm,[header],product)
			values('caryear',@fieldh,@fieldm,'年份',0)
		
		set @cmd = "alter table #z_trana5 add "+@fieldh+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_trana5 add "+@fieldm+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
	end
	--汽缸
	if exists(select * from @display where noa='cylinder')
	begin
		select @n= COUNT(1) from @field
		set @n = @n + 1
		set @fieldh = "h"+right("00"+CONVERT(nvarchar(10),@n),3)
		set @fieldm = "m"+right("00"+CONVERT(nvarchar(10),@n),3)
		
		insert into @field([key],fieldh,fieldm,[header],product)
			values('cylinder',@fieldh,@fieldm,'汽缸',0)
		
		set @cmd = "alter table #z_trana5 add "+@fieldh+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_trana5 add "+@fieldm+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
	end
	--耗油比
	if exists(select * from @display where noa='rate1')
	begin
		select @n= COUNT(1) from @field
		set @n = @n + 1
		set @fieldh = "h"+right("00"+CONVERT(nvarchar(10),@n),3)
		set @fieldm = "m"+right("00"+CONVERT(nvarchar(10),@n),3)
		
		insert into @field([key],fieldh,fieldm,[header],product,sort)
			values('rate1',@fieldh,@fieldm,'耗油比',0,@fieldm+' desc')
		
		set @cmd = "alter table #z_trana5 add "+@fieldh+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_trana5 add "+@fieldm+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
	end
	--日數
	if exists(select * from @display where noa='day')
	begin
		select @n= COUNT(1) from @field
		set @n = @n + 1
		set @fieldh = "h"+right("00"+CONVERT(nvarchar(10),@n),3)
		set @fieldm = "m"+right("00"+CONVERT(nvarchar(10),@n),3)
		
		insert into @field([key],fieldh,fieldm,[header],product,sort)
			values('day',@fieldh,@fieldm,'日數',0,@fieldm+' desc')
		
		set @cmd = "alter table #z_trana5 add "+@fieldh+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_trana5 add "+@fieldm+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
	end
	--公里/升
	if exists(select * from @display where noa='rate2')
	begin
		select @n= COUNT(1) from @field
		set @n = @n + 1
		set @fieldh = "h"+right("00"+CONVERT(nvarchar(10),@n),3)
		set @fieldm = "m"+right("00"+CONVERT(nvarchar(10),@n),3)
		
		insert into @field([key],fieldh,fieldm,[header],product,sort)
			values('rate2',@fieldh,@fieldm,'公里/升',0,@fieldm+' desc')
		
		set @cmd = "alter table #z_trana5 add "+@fieldh+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_trana5 add "+@fieldm+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
	end
	--車牌
	if exists(select * from @display where noa='carno')
	begin
		select @n= COUNT(1) from @field
		set @n = @n + 1
		set @fieldh = "h"+right("00"+CONVERT(nvarchar(10),@n),3)
		set @fieldm = "m"+right("00"+CONVERT(nvarchar(10),@n),3)
		
		insert into @field([key],fieldh,fieldm,[header],product)
			values('carno',@fieldh,@fieldm,'車牌',0)
		
		set @cmd = "alter table #z_trana5 add "+@fieldh+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_trana5 add "+@fieldm+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
	end
	--司機
	if exists(select * from @display where noa='driver')
	begin
		select @n= COUNT(1) from @field
		set @n = @n + 1
		set @fieldh = "h"+right("00"+CONVERT(nvarchar(10),@n),3)
		set @fieldm = "m"+right("00"+CONVERT(nvarchar(10),@n),3)
		
		insert into @field([key],fieldh,fieldm,[header],product)
			values('driver',@fieldh,@fieldm,'司機',0)
		
		set @cmd = "alter table #z_trana5 add "+@fieldh+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_trana5 add "+@fieldm+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
	end
	--月份
	if exists(select * from @display where noa='mon')
	begin
		select @n= COUNT(1) from @field
		set @n = @n + 1
		set @fieldh = "h"+right("00"+CONVERT(nvarchar(10),@n),3)
		set @fieldm = "m"+right("00"+CONVERT(nvarchar(10),@n),3)
		
		insert into @field([key],fieldh,fieldm,[header],product)
			values('mon',@fieldh,@fieldm,'月份',0)
		
		set @cmd = "alter table #z_trana5 add "+@fieldh+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_trana5 add "+@fieldm+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
	end
	--計算類別
	declare cursor_table cursor for
	select a.noa,a.namea from calctype a
	left join calctypes b on a.noa=b.noa
	left join #calctype c on b.noa+b.noq=c.noa
	where b.noa+b.noq=c.noa
	group by a.noa,a.namea
	open cursor_table
	fetch next from cursor_table
	into @noa,@namea
	while(@@FETCH_STATUS <> -1)
	begin
		select @n= COUNT(1) from @field
		set @n = @n + 1
		set @fieldh = "h"+right("00"+CONVERT(nvarchar(10),@n),3)
		set @fieldm = "m"+right("00"+CONVERT(nvarchar(10),@n),3)
		
		insert into @field([key],fieldh,fieldm,[header],product,isSum,sort)
			values('calctype_'+@noa,@fieldh,@fieldm,@namea+'收入',1,1,'m'+@fieldm+' desc')
		
		set @cmd = "alter table #z_trana5 add "+@fieldh+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_trana5 add "+@fieldm+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_trana5 add m"+@fieldm+" float"
		EXECUTE sp_executesql @cmd
		
		fetch next from cursor_table
		into @noa,@namea
	end
	close cursor_table
	deallocate cursor_table
	--油費
	if exists(select * from @display where noa='oil')
	begin
		select @n= COUNT(1) from @field
		set @n = @n + 1
		set @fieldh = "h"+right("00"+CONVERT(nvarchar(10),@n),3)
		set @fieldm = "m"+right("00"+CONVERT(nvarchar(10),@n),3)
		
		insert into @field([key],fieldh,fieldm,[header],product,isSum,sort)
			values('oil',@fieldh,@fieldm,'油費',-1,1,'m'+@fieldm+' desc')
		
		set @cmd = "alter table #z_trana5 add "+@fieldh+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_trana5 add "+@fieldm+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_trana5 add m"+@fieldm+" float"
		EXECUTE sp_executesql @cmd
	end
	--修理費
	if exists(select * from @display where noa='fixa')
	begin
		select @n= COUNT(1) from @field
		set @n = @n + 1
		set @fieldh = "h"+right("00"+CONVERT(nvarchar(10),@n),3)
		set @fieldm = "m"+right("00"+CONVERT(nvarchar(10),@n),3)
		
		insert into @field([key],fieldh,fieldm,[header],product,isSum,sort)
			values('fixa',@fieldh,@fieldm,'修理費',-1,1,'m'+@fieldm+' desc')
		
		set @cmd = "alter table #z_trana5 add "+@fieldh+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_trana5 add "+@fieldm+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_trana5 add m"+@fieldm+" float"
		EXECUTE sp_executesql @cmd
	end
	--輪胎費
	if exists(select * from @display where noa='tire')
	begin
		select @n= COUNT(1) from @field
		set @n = @n + 1
		set @fieldh = "h"+right("00"+CONVERT(nvarchar(10),@n),3)
		set @fieldm = "m"+right("00"+CONVERT(nvarchar(10),@n),3)
		
		insert into @field([key],fieldh,fieldm,[header],product,isSum,sort)
			values('tire',@fieldh,@fieldm,'輪胎費',-1,1,'m'+@fieldm+' desc')
		
		set @cmd = "alter table #z_trana5 add "+@fieldh+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_trana5 add "+@fieldm+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_trana5 add m"+@fieldm+" float"
		EXECUTE sp_executesql @cmd
	end
	--通行費
	if exists(select * from @display where noa='tolls')
	begin
		select @n= COUNT(1) from @field
		set @n = @n + 1
		set @fieldh = "h"+right("00"+CONVERT(nvarchar(10),@n),3)
		set @fieldm = "m"+right("00"+CONVERT(nvarchar(10),@n),3)
		
		insert into @field([key],fieldh,fieldm,[header],product,isSum,sort)
			values('tolls',@fieldh,@fieldm,'通行費',-1,1,'m'+@fieldm+' desc')
		
		set @cmd = "alter table #z_trana5 add "+@fieldh+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_trana5 add "+@fieldm+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_trana5 add m"+@fieldm+" float"
		EXECUTE sp_executesql @cmd
	end
	--罰款
	if exists(select * from @display where noa='ticket')
	begin
		select @n= COUNT(1) from @field
		set @n = @n + 1
		set @fieldh = "h"+right("00"+CONVERT(nvarchar(10),@n),3)
		set @fieldm = "m"+right("00"+CONVERT(nvarchar(10),@n),3)
		
		insert into @field([key],fieldh,fieldm,[header],product,isSum,sort)
			values('ticket',@fieldh,@fieldm,'罰款',-1,1,'m'+@fieldm+' desc')
		
		set @cmd = "alter table #z_trana5 add "+@fieldh+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_trana5 add "+@fieldm+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_trana5 add m"+@fieldm+" float"
		EXECUTE sp_executesql @cmd
	end
	--寄櫃費
	if exists(select * from @display where noa='reserve')
	begin
		select @n= COUNT(1) from @field
		set @n = @n + 1
		set @fieldh = "h"+right("00"+CONVERT(nvarchar(10),@n),3)
		set @fieldm = "m"+right("00"+CONVERT(nvarchar(10),@n),3)
		
		insert into @field([key],fieldh,fieldm,[header],product,isSum,sort)
			values('reserve',@fieldh,@fieldm,'寄櫃費',-1,1,'m'+@fieldm+' desc')
		
		set @cmd = "alter table #z_trana5 add "+@fieldh+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_trana5 add "+@fieldm+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_trana5 add m"+@fieldm+" float"
		EXECUTE sp_executesql @cmd
	end
	--薪資
	if exists(select * from @display where noa='carsal')
	begin
		select @n= COUNT(1) from @field
		set @n = @n + 1
		set @fieldh = "h"+right("00"+CONVERT(nvarchar(10),@n),3)
		set @fieldm = "m"+right("00"+CONVERT(nvarchar(10),@n),3)
		
		insert into @field([key],fieldh,fieldm,[header],product,isSum,sort)
			values('carsal',@fieldh,@fieldm,'薪資',-1,1,'m'+@fieldm+' desc')
		
		set @cmd = "alter table #z_trana5 add "+@fieldh+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_trana5 add "+@fieldm+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_trana5 add m"+@fieldm+" float"
		EXECUTE sp_executesql @cmd
	end
	--保牌燃費
	if exists(select * from @display where noa='tax')
	begin
		select @n= COUNT(1) from @field
		set @n = @n + 1
		set @fieldh = "h"+right("00"+CONVERT(nvarchar(10),@n),3)
		set @fieldm = "m"+right("00"+CONVERT(nvarchar(10),@n),3)
		
		insert into @field([key],fieldh,fieldm,[header],product,isSum,sort)
			values('tax',@fieldh,@fieldm,'保牌燃費',-1,1,'m'+@fieldm+' desc')
		
		set @cmd = "alter table #z_trana5 add "+@fieldh+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_trana5 add "+@fieldm+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_trana5 add m"+@fieldm+" float"
		EXECUTE sp_executesql @cmd
	end
	--折舊
	if exists(select * from @display where noa='depreciation')
	begin
		select @n= COUNT(1) from @field
		set @n = @n + 1
		set @fieldh = "h"+right("00"+CONVERT(nvarchar(10),@n),3)
		set @fieldm = "m"+right("00"+CONVERT(nvarchar(10),@n),3)
		
		insert into @field([key],fieldh,fieldm,[header],product,isSum,sort)
			values('depreciation',@fieldh,@fieldm,'折舊',-1,1,'m'+@fieldm+' desc')
		
		set @cmd = "alter table #z_trana5 add "+@fieldh+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_trana5 add "+@fieldm+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_trana5 add m"+@fieldm+" float"
		EXECUTE sp_executesql @cmd
	end
	--淨利
	if exists(select * from @display where noa='profit')
	begin
		select @n= COUNT(1) from @field
		set @n = @n + 1
		set @fieldh = "h"+right("00"+CONVERT(nvarchar(10),@n),3)
		set @fieldm = "m"+right("00"+CONVERT(nvarchar(10),@n),3)
		
		insert into @field([key],fieldh,fieldm,[header],product,isSum,sort)
			values('profit',@fieldh,@fieldm,'淨利',0,1,'m'+@fieldm+' desc')
		
		set @cmd = "alter table #z_trana5 add "+@fieldh+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_trana5 add "+@fieldm+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_trana5 add m"+@fieldm+" float"
		EXECUTE sp_executesql @cmd
	end
	--**
	select @n= COUNT(1) from @field
	while(@n<@minN)
	begin
		set @n = @n + 1
		set @fieldh = "h"+right("00"+CONVERT(nvarchar(10),@n),3)
		set @fieldm = "m"+right("00"+CONVERT(nvarchar(10),@n),3)
		insert into @field([key],fieldh,fieldm,[header],product,isSum)
			values(null,@fieldh,@fieldm,null,null,null)
		
		set @cmd = "alter table #z_trana5 add "+@fieldh+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_trana5 add "+@fieldm+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
	end
	--************************************************************************************************************
	--出車單: 收入
	declare @tmp1 table(
		carkindno nvarchar(20),
		carno nvarchar(20),
		driverno nvarchar(20),
		datea nvarchar(20),
		calctypeno nvarchar(10),
		[money] float,
		miles float
	)
	set @cmd =
		" select isnull(e.carkindno,''),a.carno,a.driverno,isnull(a.datea,''),c.noa,"+
		" sum(isnull(round("+@t_calcmoney+",0),0)) [money],"+
		" sum(isnull(a.miles,0)) miles"+
		" from trans"+@t_accy+" a"+
		" left join #calctype b on a.calctype=b.noa"+
		" left join calctype c on left(a.calctype,1)=c.noa"+
		" left join car2 e on a.carno=e.noa"+
		" left join #carkind f on e.carkindno=f.noa"+
		" where a.calctype=b.noa and (not f.noa is null)"+
		" and (len(@t_carno)=0 or a.carno=@t_carno)"+
		" and (a.datea between @t_bdate and @t_edate)"+
		" and (a.custno between @t_bcustno and @t_ecustno)"+
		" and (a.driverno between @t_bdriverno and @t_edriverno)"+
		" and (len(@t_po)=0 or a.po=@t_po)"+
		" group by isnull(e.carkindno,''),a.carno,a.driverno,a.datea,c.noa"	
	insert into @tmp1
	EXECUTE sp_executesql @cmd,N'@t_bdate nvarchar(10),@t_edate nvarchar(10),@t_bdriverno nvarchar(20),@t_edriverno nvarchar(20),@t_carno nvarchar(20),@t_bcustno  nvarchar(20),@t_ecustno  nvarchar(20),@t_po  nvarchar(30)',
		@t_bdate=@t_bdate,@t_edate=@t_edate,@t_bdriverno=@t_bdriverno,@t_edriverno=@t_edriverno,@t_carno=@t_carno,@t_bcustno=@t_bcustno,@t_ecustno=@t_ecustno,@t_po=@t_po
	
	declare cursor_table cursor for
	select carkindno,carno,driverno,left(datea,6),calctypeno,sum([money]),sum(miles) from @tmp1 where [money]!=0 group by carkindno,carno,driverno,left(datea,6),calctypeno
	open cursor_table
	fetch next from cursor_table
	into @carkindno,@carno,@driverno,@mon,@calctypeno,@money,@miles
	while(@@FETCH_STATUS <> -1)
	begin
		if not exists(select * from #z_trana5 where carno=@carno and carkindno=@carkindno and driverno=@driverno and mon=@mon)
		begin
			insert into #z_trana5(gno,carno,carkindno,driverno,mon)values('0',@carno,@carkindno,@driverno,@mon)
		end
			
		set @fieldm = ''
		select @fieldm=fieldm from @field where [key]='calctype_'+@calctypeno
		if LEN(@fieldm)>0
		begin
			set @cmd = "update #z_trana5 set tranmoney=isnull(tranmoney,0)+@money,miles=isnull(miles,0)+@miles,"+@fieldm+"=reverse(substring(reverse(convert(char(15),CONVERT(money,@money),1)),4,12)),m"+@fieldm+"=@money where gno='0' and carno=@carno and carkindno=@carkindno and driverno=@driverno and mon=@mon"
			execute sp_executesql @cmd,N'@carkindno nvarchar(10),@carno nvarchar(20),@driverno nvarchar(20),@mon nvarchar(10),@money float,@miles float',
				@carkindno=@carkindno,@carno=@carno,@driverno=@driverno,@mon=@mon,@money=@money,@miles=@miles
		end
		fetch next from cursor_table
		into @carkindno,@carno,@driverno,@mon,@calctypeno,@money,@miles
	end
	close cursor_table
	deallocate cursor_table
	------------------------------------------------------------------------------------------------------------------
	--加油
	declare @tmp2 table(
		carkindno nvarchar(20),
		carno nvarchar(20),
		driverno nvarchar(20),
		mon nvarchar(20),
		mount float,
		[money] float
	)
	
	set @cmd =
		" select isnull(e.carkindno,''),a.carno,a.driverno,left(a.datea,6),"+
		" sum(isnull(a.mount,0)) mount,"+
		" sum(isnull(a.money,0)) [money]"+
		" from oil a"+
		" left join car2 e on a.carno=e.noa"+
		" left join #carkind f on e.carkindno=f.noa"+
		" where (not f.noa is null)"+
		" and (len(@t_carno)=0 or a.carno=@t_carno)"+
		" and (a.datea between @t_bdate and @t_edate)"+
		" and (a.driverno between @t_bdriverno and @t_edriverno)"+
		" group by isnull(e.carkindno,''),a.carno,a.driverno,left(a.datea,6)"	
	insert into @tmp2
	EXECUTE sp_executesql @cmd,N'@t_bdate nvarchar(10),@t_edate nvarchar(10),@t_bdriverno nvarchar(20),@t_edriverno nvarchar(20),@t_carno nvarchar(20),@t_bcustno  nvarchar(20),@t_ecustno  nvarchar(20),@t_po  nvarchar(30)',
		@t_bdate=@t_bdate,@t_edate=@t_edate,@t_bdriverno=@t_bdriverno,@t_edriverno=@t_edriverno,@t_carno=@t_carno,@t_bcustno=@t_bcustno,@t_ecustno=@t_ecustno,@t_po=@t_po
	
	set @fieldm=''
	select @fieldm=fieldm from @field where [key]='oil'
	
	declare cursor_table cursor for
	select carkindno,carno,driverno,mon,mount,[money] from @tmp2 where mount!=0 and [money]!=0
	open cursor_table
	fetch next from cursor_table
	into @carkindno,@carno,@driverno,@mon,@mount,@money
	while(@@FETCH_STATUS <> -1)
	begin
		if not exists(select * from #z_trana5 where carno=@carno and carkindno=@carkindno and driverno=@driverno and mon=@mon)
		begin
			insert into #z_trana5(gno,carno,carkindno,driverno,mon)values('0',@carno,@carkindno,@driverno,@mon)
		end
		if LEN(@fieldm)>0
			set @cmd = "update #z_trana5 set "+@fieldm+"=reverse(substring(reverse(convert(char(15),CONVERT(money,@money),1)),4,12)),m"+@fieldm+"=@money,oilmount=@mount,oilmoney=@money where gno='0' and carno=@carno and carkindno=@carkindno and driverno=@driverno and mon=@mon"
		else	
			set @cmd = "update #z_trana5 set oilmount=@mount,oilmoney=@money where gno='0' and carno=@carno and carkindno=@carkindno and driverno=@driverno and mon=@mon"
		execute sp_executesql @cmd,N'@carkindno nvarchar(10),@carno nvarchar(20),@driverno nvarchar(20),@mon nvarchar(10),@mount float,@money float',
			@carkindno=@carkindno,@carno=@carno,@driverno=@driverno,@mon=@mon,@mount=@mount,@money=@money

		fetch next from cursor_table
		into @carkindno,@carno,@driverno,@mon,@mount,@money
	end
	close cursor_table
	deallocate cursor_table
	------------------------------------------------------------------------------------------------------------------
	--公里/升,耗油比
	update #z_trana5 set tranmoney=isnull(tranmoney,0),miles=ISNULL(miles,0),oilmount=ISNULL(oilmount,0),oilmoney=ISNULL(oilmoney,0)
	set @fieldm=''
	select @fieldm=fieldm from @field where [key]='rate1'
	if LEN(@fieldm)>0
	begin
		set @cmd="update #z_trana5 set "+@fieldm+"=case when tranmoney=0 then '0 %' else convert(char(6),round(oilmoney/tranmoney*100,0))+' %' end"
		execute sp_executesql @cmd
	end
	
	set @fieldm=''
	select @fieldm=fieldm from @field where [key]='rate2'
	if LEN(@fieldm)>0
	begin
		set @cmd="update #z_trana5 set "+@fieldm+"=case when oilmount=0 then '' else convert(char(6),CAST(round(miles/oilmount,3) as decimal(10,3))) end"
		execute sp_executesql @cmd
	end
	------------------------------------------------------------------------------------------------------------------
	--寄櫃費,通行費
	if exists(select * from @field where [key]='tolls' or [key]='resverve')
	begin
		declare @tmp3 table(
			carkindno nvarchar(20),
			carno nvarchar(20),
			driverno nvarchar(20),
			mon nvarchar(20),
			tolls float,
			resverve float
		)
		set @cmd=
			" select isnull(e.carkindno,''),a.carno,a.driverno,left(a.datea,6),"+
			" SUM(case when minusitemno='01'  then  isnull(a.minusmoney,0)  else  0  end) tolls,"+
			" SUM(case when minusitemno='02'  then  isnull(a.minusmoney,0)  else  0  end) reserve"+  
			" from carchg  a  "+
			" left join car2 e on a.carno=e.noa"+
			" left join #carkind f on e.carkindno=f.noa"+
			" where (a.minusitemno='01' or a.minusitemno='02') and (not f.noa is null)"+
			" and (len(@t_carno)=0 or a.carno=@t_carno)"+
			" and (a.datea between @t_bdate and @t_edate)"+
			" and (a.driverno between @t_bdriverno and @t_edriverno)"+
			"group by isnull(e.carkindno,''),a.carno,a.driverno,left(a.datea,6)"
		insert @tmp3
		EXECUTE sp_executesql @cmd,N'@t_bdate nvarchar(10),@t_edate nvarchar(10),@t_bdriverno nvarchar(20),@t_edriverno nvarchar(20),@t_carno nvarchar(20),@t_bcustno  nvarchar(20),@t_ecustno  nvarchar(20),@t_po  nvarchar(30)',
			@t_bdate=@t_bdate,@t_edate=@t_edate,@t_bdriverno=@t_bdriverno,@t_edriverno=@t_edriverno,@t_carno=@t_carno,@t_bcustno=@t_bcustno,@t_ecustno=@t_ecustno,@t_po=@t_po
		
		
		set @cmd=
			" select isnull(e.carkindno,''),a.carno,a.driverno,left(a.datea,6),"+
			" SUM(isnull(a.[money],0)) tolls,0"+ 
			" from etc a  "+
			" left join car2 e on a.carno=e.noa"+
			" left join #carkind f on e.carkindno=f.noa"+
			" where (not f.noa is null)"+
			" and (len(@t_carno)=0 or a.carno=@t_carno)"+
			" and (a.datea between @t_bdate and @t_edate)"+
			" and (a.driverno between @t_bdriverno and @t_edriverno)"+
			"group by isnull(e.carkindno,''),a.carno,a.driverno,left(a.datea,6)"
		insert @tmp3
		EXECUTE sp_executesql @cmd,N'@t_bdate nvarchar(10),@t_edate nvarchar(10),@t_bdriverno nvarchar(20),@t_edriverno nvarchar(20),@t_carno nvarchar(20),@t_bcustno  nvarchar(20),@t_ecustno  nvarchar(20),@t_po  nvarchar(30)',
			@t_bdate=@t_bdate,@t_edate=@t_edate,@t_bdriverno=@t_bdriverno,@t_edriverno=@t_edriverno,@t_carno=@t_carno,@t_bcustno=@t_bcustno,@t_ecustno=@t_ecustno,@t_po=@t_po
		
		
		declare cursor_table cursor for
		select carkindno,carno,driverno,mon,sum(isnull(tolls,0)),sum(isnull(resverve,0)) from @tmp3 where not(tolls=0 and resverve=0) group  by  carkindno,carno,driverno,mon
		open cursor_table
		fetch next from cursor_table
		into @carkindno,@carno,@driverno,@mon,@tolls,@resverve
		while(@@FETCH_STATUS <> -1)
		begin
			if not exists(select * from #z_trana5 where carno=@carno and carkindno=@carkindno and driverno=@driverno and mon=@mon)
			begin
				insert into #z_trana5(gno,carno,carkindno,driverno,mon)values('0',@carno,@carkindno,@driverno,@mon)
			end
				
			set @fieldm = ''
			select @fieldm=fieldm from @field where [key]='tolls'
			if LEN(@fieldm)>0
			begin
				set @cmd = "update #z_trana5 set "+@fieldm+"=reverse(substring(reverse(convert(char(15),CONVERT(money,@tolls),1)),4,12)),m"+@fieldm+"=@tolls where gno='0' and carno=@carno and carkindno=@carkindno and driverno=@driverno and mon=@mon"
				execute sp_executesql @cmd,N'@carkindno nvarchar(10),@carno nvarchar(20),@driverno nvarchar(20),@mon nvarchar(10),@tolls float',
					@carkindno=@carkindno,@carno=@carno,@driverno=@driverno,@mon=@mon,@tolls=@tolls
			end
			set @fieldm = ''
			select @fieldm=fieldm from @field where [key]='resverve'
			if LEN(@fieldm)>0
			begin
				set @cmd = "update #z_trana5 set "+@fieldm+"=reverse(substring(reverse(convert(char(15),CONVERT(money,@resverve),1)),4,12)),m"+@fieldm+"=@resverve where gno='0' and carno=@carno and carkindno=@carkindno and driverno=@driverno and mon=@mon"
				execute sp_executesql @cmd,N'@carkindno nvarchar(10),@carno nvarchar(20),@driverno nvarchar(20),@mon nvarchar(10),@resverve float',
					@carkindno=@carkindno,@carno=@carno,@driverno=@driverno,@mon=@mon,@resverve=@resverve
			end
			
			fetch next from cursor_table
			into @carkindno,@carno,@driverno,@mon,@tolls,@resverve
		end
		close cursor_table
		deallocate cursor_table
	end
	------------------------------------------------------------------------------------------------------------------
	--罰款
	set @fieldm = ''
	select @fieldm=fieldm from @field where [key]='ticket'
	if LEN(@fieldm)>0
	begin
		declare @tmp4 table(
			carkindno nvarchar(20),
			carno nvarchar(20),
			driverno nvarchar(20),
			mon nvarchar(20),
			[money] float
		)
		set @cmd=
			" select isnull(e.carkindno,''),a.carno,a.driverno,left(a.datea,6),"+
			" SUM(isnull(a.comppay,0))"+  
			" from ticket a  "+
			" left join car2 e on a.carno=e.noa"+
			" left join #carkind f on e.carkindno=f.noa"+
			" where isnull(a.comppay,0)>0 and (not f.noa is null)"+
			" and (len(@t_carno)=0 or a.carno=@t_carno)"+
			" and (a.datea between @t_bdate and @t_edate)"+
			" and (a.driverno between @t_bdriverno and @t_edriverno)"+
			" group by isnull(e.carkindno,''),a.carno,a.driverno,left(a.datea,6)"
		insert @tmp4
		EXECUTE sp_executesql @cmd,N'@t_bdate nvarchar(10),@t_edate nvarchar(10),@t_bdriverno nvarchar(20),@t_edriverno nvarchar(20),@t_carno nvarchar(20),@t_bcustno  nvarchar(20),@t_ecustno  nvarchar(20),@t_po  nvarchar(30)',
			@t_bdate=@t_bdate,@t_edate=@t_edate,@t_bdriverno=@t_bdriverno,@t_edriverno=@t_edriverno,@t_carno=@t_carno,@t_bcustno=@t_bcustno,@t_ecustno=@t_ecustno,@t_po=@t_po
		
		declare cursor_table cursor for
		select carkindno,carno,driverno,mon,[money] from @tmp4 where [money]!=0
		open cursor_table
		fetch next from cursor_table
		into @carkindno,@carno,@driverno,@mon,@money
		while(@@FETCH_STATUS <> -1)
		begin
			if not exists(select * from #z_trana5 where carno=@carno and carkindno=@carkindno and driverno=@driverno and mon=@mon)
			begin
				insert into #z_trana5(gno,carno,carkindno,driverno,mon)values('0',@carno,@carkindno,@driverno,@mon)
			end
			set @cmd = "update #z_trana5 set "+@fieldm+"=reverse(substring(reverse(convert(char(15),CONVERT(money,@money),1)),4,12)),m"+@fieldm+"=@money where gno='0' and carno=@carno and carkindno=@carkindno and driverno=@driverno and mon=@mon"
			execute sp_executesql @cmd,N'@carkindno nvarchar(10),@carno nvarchar(20),@driverno nvarchar(20),@mon nvarchar(10),@money float',
				@carkindno=@carkindno,@carno=@carno,@driverno=@driverno,@mon=@mon,@money=@money
			fetch next from cursor_table
			into @carkindno,@carno,@driverno,@mon,@money
		end
		close cursor_table
		deallocate cursor_table
	end
	------------------------------------------------------------------------------------------------------------------
	--修理費
	set @fieldm = ''
	select @fieldm=fieldm from @field where [key]='fixa'
	if LEN(@fieldm)>0
	begin
		declare cursor_table cursor for
		select isnull(e.carkindno,'') carkindno,a.carno,a.driverno,LEFT(datea,6)  mon
		 ,SUM(isnull(a.wmoney,0)) [money]
		 from fixa a 
		 left join car2 e on a.carno=e.noa
		 left join #carkind f on e.carkindno=f.noa
		 where 
		 isnull(a.wmoney,0)>0 and (not f.noa is null)
		 and (len(@t_carno)=0 or a.carno=@t_carno)
		 and (a.datea between @t_bdate and @t_edate)
		 and (a.driverno between @t_bdriverno and @t_edriverno)
		 group by isnull(e.carkindno,''),a.carno,a.driverno,LEFT(datea,6)
		open cursor_table
		fetch next from cursor_table
		into @carkindno,@carno,@driverno,@mon,@money
		while(@@FETCH_STATUS <> -1)
		begin
			if not exists(select *  from  #z_trana5 where carkindno=@carkindno and carno=@carno and driverno=@driverno and mon=@mon)
			begin
				insert into #z_trana5(gno,carkindno,carno,driverno,mon)values('0',@carkindno,@carno,@driverno,@mon)
			end
			set @cmd = "update #z_trana5 set "+@fieldm+"=reverse(substring(reverse(convert(char(15),CONVERT(money,@money),1)),4,12)),m"+@fieldm+"=@money where gno='0' and carno=@carno and carkindno=@carkindno and driverno=@driverno and mon=@mon"
			execute sp_executesql @cmd,N'@carkindno nvarchar(10),@carno nvarchar(20),@driverno nvarchar(20),@mon nvarchar(10),@money float',
				@carkindno=@carkindno,@carno=@carno,@driverno=@driverno,@mon=@mon,@money=@money
	
			fetch next from cursor_table
			into @carkindno,@carno,@driverno,@mon,@money
		end
		close cursor_table
		deallocate cursor_table
	end
	------------------------------------------------------------------------------------------------------------------
	--輪胎費
	set @fieldm = ''
	select @fieldm=fieldm from @field where [key]='tire'
	if LEN(@fieldm)>0
	begin
		declare cursor_table cursor for
		select isnull(e.carkindno,'') carkindno,a.carno,a.driverno,LEFT(datea,6)  mon
		 ,SUM(isnull(a.cmoney,0)) [money]
		 from fixa a 
		 left join car2 e on a.carno=e.noa
		 left join #carkind f on e.carkindno=f.noa
		 where 
		 isnull(a.cmoney,0)>0 and (not f.noa is null)
		 and (len(@t_carno)=0 or a.carno=@t_carno)
		 and (a.datea between @t_bdate and @t_edate)
		 and (a.driverno between @t_bdriverno and @t_edriverno)
		 group by isnull(e.carkindno,''),a.carno,a.driverno,LEFT(datea,6)
		open cursor_table
		fetch next from cursor_table
		into @carkindno,@carno,@driverno,@mon,@money
		while(@@FETCH_STATUS <> -1)
		begin
			if not exists(select *  from  #z_trana5 where carkindno=@carkindno and carno=@carno and driverno=@driverno and mon=@mon)
			begin
				insert into #z_trana5(gno,carkindno,carno,driverno,mon)values('0',@carkindno,@carno,@driverno,@mon)
			end
			set @cmd = "update #z_trana5 set "+@fieldm+"=reverse(substring(reverse(convert(char(15),CONVERT(money,@money),1)),4,12)),m"+@fieldm+"=@money where gno='0' and carno=@carno and carkindno=@carkindno and driverno=@driverno and mon=@mon"
			execute sp_executesql @cmd,N'@carkindno nvarchar(10),@carno nvarchar(20),@driverno nvarchar(20),@mon nvarchar(10),@money float',
				@carkindno=@carkindno,@carno=@carno,@driverno=@driverno,@mon=@mon,@money=@money
	
			fetch next from cursor_table
			into @carkindno,@carno,@driverno,@mon,@money
		end
		close cursor_table
		deallocate cursor_table
	end
	------------------------------------------------------------------------------------------------------------------
	--折舊
	set @fieldm = ''
	select @fieldm=fieldm from @field where [key]='depreciation'
	if LEN(@fieldm)>0
	begin
		declare cursor_table cursor for
		select carno,driverno,isnull(depreciation,0) from car2 
		open cursor_table
		fetch next from cursor_table
		into @carno,@driverno,@money
		while(@@FETCH_STATUS <> -1)
		begin
			select @carkindno='',@mon=''
			select @carkindno=carkindno,@mon=mon  from  #z_trana5 where carno=@carno and driverno=@driverno
			if LEN(@mon)=0
			begin
				select @driverno=''
				select @carkindno=carkindno,@mon=mon,@driverno=driverno  from  #z_trana5 where carno=@carno
			end
		
			if LEN( @carno)>0
			begin
				set @cmd = "update #z_trana5 set "+@fieldm+"=reverse(substring(reverse(convert(char(15),CONVERT(money,@money),1)),4,12)),m"+@fieldm+"=@money where gno='0' and carno=@carno and carkindno=@carkindno and driverno=@driverno and mon=@mon"
				execute sp_executesql @cmd,N'@carkindno nvarchar(10),@carno nvarchar(20),@driverno nvarchar(20),@mon nvarchar(10),@money float',
					@carkindno=@carkindno,@carno=@carno,@driverno=@driverno,@mon=@mon,@money=@money
			end
			fetch next from cursor_table
			into @carno,@driverno,@money
		end
		close cursor_table
		deallocate cursor_table
	end
	------------------------------------------------------------------------------------------------------------------
	--保牌燃費
	set @fieldm = ''
	select @fieldm=fieldm from @field where [key]='tax'
	if LEN(@fieldm)>0
	begin
		declare cursor_table cursor for
		select carno,driverno,isnull(tax,0) from car2 
		open cursor_table
		fetch next from cursor_table
		into @carno,@driverno,@tax
		while(@@FETCH_STATUS <> -1)
		begin
			select @carkindno='',@mon=''
			select @carkindno=carkindno,@mon=mon  from  #z_trana5 where carno=@carno and driverno=@driverno
			if LEN(@mon)=0
			begin
				select @driverno=''
				select @carkindno=carkindno,@mon=mon,@driverno=driverno  from  #z_trana5 where carno=@carno
			end
		
			if LEN( @carno)>0
			begin
				set @cmd = "update #z_trana5 set "+@fieldm+"=reverse(substring(reverse(convert(char(15),CONVERT(money,@tax),1)),4,12)),m"+@fieldm+"=@tax where gno='0' and carno=@carno and carkindno=@carkindno and driverno=@driverno and mon=@mon"
				execute sp_executesql @cmd,N'@carkindno nvarchar(10),@carno nvarchar(20),@driverno nvarchar(20),@mon nvarchar(10),@tax float',
					@carkindno=@carkindno,@carno=@carno,@driverno=@driverno,@mon=@mon,@tax=@tax
			end
			fetch next from cursor_table
			into @carno,@driverno,@tax
		end
		close cursor_table
		deallocate cursor_table
	end
	------------------------------------------------------------------------------------------------------------------
	--薪資
	set @fieldm = ''
	select @fieldm=fieldm from @field where [key]='carsal'
	if LEN(@fieldm)>0
	begin
		declare cursor_table cursor for
		select driverno,noa,[money] from carsals 
		where (noa between left(@t_bdate,6)  and  left(@t_bdate,6))  and  (driverno  between  @t_bdriverno  and  @t_edriverno)
		open cursor_table
		fetch next from cursor_table
		into @driverno,@mon,@money
		while(@@FETCH_STATUS <> -1)
		begin
			select @carkindno='',@carno=''
			select top(1) @carkindno=carkindno,@carno=carno  from  #z_trana5  where  driverno=@driverno  and  mon=@mon
			if LEN( @carno)>0
			begin
				set @cmd = "update #z_trana5 set "+@fieldm+"=reverse(substring(reverse(convert(char(15),CONVERT(money,@money),1)),4,12)),m"+@fieldm+"=@money where gno='0' and carno=@carno and carkindno=@carkindno and driverno=@driverno and mon=@mon"
				execute sp_executesql @cmd,N'@carkindno nvarchar(10),@carno nvarchar(20),@driverno nvarchar(20),@mon nvarchar(10),@money float',
					@carkindno=@carkindno,@carno=@carno,@driverno=@driverno,@mon=@mon,@money=@money
			end
			fetch next from cursor_table
			into @driverno,@mon,@money
		end
		close cursor_table
		deallocate cursor_table
	end
	------------------------------------------------------------------------------------------------------------------
	--淨利
	if exists(select * from @field where [key]='profit')
	begin
		set @cmd='0'
		declare cursor_table cursor for
		select fieldm,product from @field where product!=0
		open cursor_table
		fetch next from cursor_table
		into @fieldm,@product
		while(@@FETCH_STATUS <> -1)
		begin
			set @cmd=@cmd+"+(isnull(m"+@fieldm+",0)*("+CONVERT(nvarchar,@product)+"))"
			fetch next from cursor_table
			into @fieldm,@product
		end
		close cursor_table
		deallocate cursor_table
		
		set @fieldm = ''
		select @fieldm=fieldm from @field where [key]='profit'
		if LEN(@fieldm)>0
		begin
			set @cmd = "update #z_trana5 set "+@fieldm+"=reverse(substring(reverse(convert(char(15),CONVERT(money,"+@cmd+"),1)),4,12)),m"+@fieldm+"="+@cmd
			execute sp_executesql @cmd
		end
	end
	------------------------------------------------------------------------------------------------------------------
	--類別
	set @fieldm = ''
	select @fieldm=fieldm from @field where [key]='carkind'
	if LEN(@fieldm)>0
	begin
		declare cursor_table cursor for
		select carkindno from #z_trana5 group by carkindno
		open cursor_table
		fetch next from cursor_table
		into @carkindno
		while(@@FETCH_STATUS <> -1)
		begin
			set @carkind=''
			select @carkind=kind from carKind where noa=@carkindno
			set @cmd="update #z_trana5 set "+@fieldm+"=@carkind where carkindno=@carkindno"
			execute sp_executesql @cmd,N'@carkind nvarchar(20),@carkindno nvarchar(10)',@carkind=@carkind,@carkindno=@carkindno	
			fetch next from cursor_table
			into @carkindno
		end
		close cursor_table
		deallocate cursor_table	
	end
	------------------------------------------------------------------------------------------------------------------
	--年份
	set @fieldm = ''
	select @fieldm=fieldm from @field where [key]='caryear'
	if LEN(@fieldm)>0
	begin
		declare cursor_table cursor for
		select carno from #z_trana5 group by carno
		open cursor_table
		fetch next from cursor_table
		into @carno
		while(@@FETCH_STATUS <> -1)
		begin
			set @caryear=''
			select @caryear=caryear from car2 where noa=@carno
			set @cmd="update #z_trana5 set "+@fieldm+"=@caryear where carno=@carno"
			execute sp_executesql @cmd,N'@carno nvarchar(20),@caryear nvarchar(10)',@carno=@carno,@caryear=@caryear	
			fetch next from cursor_table
			into @carno
		end
		close cursor_table
		deallocate cursor_table	
	end
	------------------------------------------------------------------------------------------------------------------
	--汽缸
	set @fieldm = ''
	select @fieldm=fieldm from @field where [key]='cylinder'
	if LEN(@fieldm)>0
	begin
		declare cursor_table cursor for
		select carno from #z_trana5 group by carno
		open cursor_table
		fetch next from cursor_table
		into @carno
		while(@@FETCH_STATUS <> -1)
		begin
			set @cylinder=0
			select @cylinder=cylinder from car2 where noa=@carno
			set @cmd="update #z_trana5 set "+@fieldm+"=convert(char(2),@cylinder) where carno=@carno"
			execute sp_executesql @cmd,N'@carno nvarchar(20),@cylinder int',@carno=@carno,@cylinder=@cylinder
			fetch next from cursor_table
			into @carno
		end
		close cursor_table
		deallocate cursor_table	
	end
	------------------------------------------------------------------------------------------------------------------
	--日數
	set @fieldm = ''
	select @fieldm=fieldm from @field where [key]='day'
	if LEN(@fieldm)>0
	begin
		declare cursor_table cursor for
		select carkindno,carno,driverno,mon from #z_trana5
		open cursor_table
		fetch next from cursor_table
		into @carkindno,@carno,@driverno,@mon
		while(@@FETCH_STATUS <> -1)
		begin
			select @day=0
			select @day=count(1) from (SELECT DISTINCT datea from @tmp1 where carkindno=@carkindno and carno=@carno and driverno=@driverno and LEFT(datea,6)=@mon)as a
			
			set @cmd="update #z_trana5 set "+@fieldm+"=convert(char(2),@day) where gno='0' and carkindno=@carkindno and carno=@carno and driverno=@driverno and mon=@mon"
			execute sp_executesql @cmd,
				N'@day int,@carkindno nvarchar(10),@carno nvarchar(20),@driverno nvarchar(20),@mon nvarchar(10)',
				@day=@day,@carkindno=@carkindno,@carno=@carno,@driverno=@driverno,@mon=@mon

			fetch next from cursor_table
			into @carkindno,@carno,@driverno,@mon
		end
		close cursor_table
		deallocate cursor_table	
	end
	------------------------------------------------------------------------------------------------------------------
	--車牌
	set @fieldm = ''
	select @fieldm=fieldm from @field where [key]='carno'
	if LEN(@fieldm)>0
	begin
		set @cmd="update #z_trana5 set "+@fieldm+"=carno"
		execute sp_executesql @cmd
	end
	------------------------------------------------------------------------------------------------------------------
	--司機
	set @fieldm = ''
	select @fieldm=fieldm from @field where [key]='driver'
	if LEN(@fieldm)>0
	begin
		declare cursor_table cursor for
		select driverno from #z_trana5 group by driverno
		open cursor_table
		fetch next from cursor_table
		into @driverno
		while(@@FETCH_STATUS <> -1)
		begin
			set @driver=''
			select @driver=namea from driver where noa=@driverno
			set @cmd="update #z_trana5 set "+@fieldm+"=@driver where driverno=@driverno"
			execute sp_executesql @cmd,N'@driver nvarchar(20),@driverno nvarchar(20)',@driver=@driver,@driverno=@driverno
			fetch next from cursor_table
			into @driverno
		end
		close cursor_table
		deallocate cursor_table	
	end
	------------------------------------------------------------------------------------------------------------------
	--月份
	set @fieldm = ''
	select @fieldm=fieldm from @field where [key]='mon'
	if LEN(@fieldm)>0
	begin
		set @cmd="update #z_trana5 set "+@fieldm+"=mon"
		execute sp_executesql @cmd
	end
	------------------------------------------------------------------------------------------------------------------
	--小計
	declare cursor_table cursor for
	select carkindno from #z_trana5 group by carkindno
	open cursor_table
	fetch next from cursor_table
	into @carkindno
	while(@@FETCH_STATUS <> -1)
	begin
		set @fieldm=''
		select @fieldm=fieldm from @field where [key]='carno'
		set @carkind=''
		select @carkind=kind from carkind where noa=@carkindno
		if LEN(@fieldm)>0
		begin
			set @cmd="insert into #z_trana5(gno,carkindno,carno,driverno,mon,rowheader,"+@fieldm+")values('1',@carkindno,'','','',@carkind+'小計',@carkind+'小計')"
			execute sp_executesql @cmd,N'@carkindno nvarchar(10),@carkind nvarchar(20)',@carkindno=@carkindno,@carkind=@carkind
		end
		else
			insert into #z_trana5(gno,carkindno,carno,driverno,mon,rowheader)values('1',@carkindno,'','','',@carkind+'小計')

		declare cursor_table2 cursor for
		select fieldm from @field where isSum=1
		open cursor_table2
		fetch next from cursor_table2
		into @fieldm
		while(@@FETCH_STATUS <> -1)
		begin
			set @money=0
			set @cmd="select @money=sum(isnull(m"+@fieldm+",0)) from #z_trana5 where gno='0' and carkindno=@carkindno group by carkindno"
			execute sp_executesql @cmd,N'@carkindno nvarchar(10),@money float output',@carkindno=@carkindno,@money=@money output
			
			set @cmd="update #z_trana5 set "+@fieldm+"=reverse(substring(reverse(convert(char(15),CONVERT(money,@money),1)),4,12)),m"+@fieldm+"=@money where gno='1' and carkindno=@carkindno"
			execute sp_executesql @cmd,N'@carkindno nvarchar(10),@money float',@carkindno=@carkindno,@money=@money
			
			fetch next from cursor_table2
			into @fieldm
		end
		close cursor_table2
		deallocate cursor_table2
		
		
		fetch next from cursor_table
		into @carkindno
	end
	close cursor_table
	deallocate cursor_table
	--*************************************************************************************************
	declare cursor_table cursor for
	select fieldh,header from @field
	open cursor_table
	fetch next from cursor_table
	into @fieldh,@header
	while(@@FETCH_STATUS <> -1)
	begin
		set @cmd="update #z_trana5 set "+@fieldh+"=@header"
		execute sp_executesql @cmd,N'@header nvarchar(20)',@header=@header
		fetch next from cursor_table
		into @fieldh,@header
	end
	close cursor_table
	deallocate cursor_table
	
	select @fieldm='',@sort=''
	select @fieldm=fieldm,@sort=isnull(sort,'') from @field where [key]=@t_sort5
	set @cmd="select * from #z_trana5 order by carkindno,gno"+case when len(@sort)>0 then ','+@sort when len(@fieldm)>0 then ','+@fieldm else '' end
	execute sp_executesql @cmd
	drop table #z_trana5
	drop table #carkind
	drop table #calctype
	drop table #carteam;
	
z_trana4:--z_trana4
	SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	declare @t_accy nvarchar(10)
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_bcustno nvarchar(30)
	declare @t_ecustno nvarchar(30)
	declare @t_bdriverno nvarchar(30)
	declare @t_edriverno nvarchar(30)
	declare @t_carno nvarchar(20)
	declare @t_po nvarchar(20)
	declare @t_addr nvarchar(20)
	declare @t_carteamno nvarchar(max)
	declare @t_calctype nvarchar(max)
	declare @t_other nvarchar(max)
	declare @t_calcmoney nvarchar(max)
	declare @t_sort8 nvarchar(max)
	declare @t_sort10 nvarchar(max)
	declare @t_sort3 nvarchar(max)
	declare @t_bsalesno nvarchar(20)
	declare @t_esalesno nvarchar(20)
	declare @t_field5 nvarchar(max)
	declare @t_yproduct nvarchar(max)
	declare @t_yaddr nvarchar(max)
	declare @t_yboatname nvarchar(max)
	declare @t_sort6 nvarchar(max)
	declare @t_carkindno nvarchar(max)
	declare @t_sort5 nvarchar(max)	
	declare @t_field13 nvarchar(max)	
	declare @t_sort13 nvarchar(max)	
	declare @t_field1 nvarchar(max)	
	declare @t_sort1 nvarchar(max)	
	declare @t_acomp nvarchar(max)	
	declare @t_sort14 nvarchar(max)
	declare @t_trandono nvarchar(max)
	declare @t_option14 nvarchar(max)
	declare @t_baddrno nvarchar(20)
	declare @t_eaddrno nvarchar(20)
	declare @t_btrandate nvarchar(10)
	declare @t_etrandate nvarchar(10)
	declare @t_plusmoney int
	declare @t_minusmoney int
	
	set @t_accy = [1]
	set @t_bdate = case when '#non'=[2] then '' else [2] end
	set @t_edate = case when '#non'=[3] then char(255) else [3] end
	set @t_bcustno = case when '#non'=[4] then '' else [4] end
	set @t_ecustno = case when '#non'=[5] then char(255) else [5] end
	set @t_bdriverno = case when '#non'=[6] then '' else [6] end
	set @t_edriverno = case when '#non'=[7] then char(255) else [7] end
	set @t_carno = case when '#non'=[8] then '' else [8] end
	set @t_po = case when '#non'=[9] then '' else [9] end
	set @t_addr = case when '#non'=[10] then '' else [10] end
	set @t_carteamno = case when '#non'=[11] then '' else [11] end
	set @t_calctype = case when '#non'=[12] then '' else [12] end
	set @t_other = case when '#non'=[13] then '' else [13] end
	set @t_calcmoney = case when '#non'=[14] then '' else [14] end
	set @t_sort8 = case when '#non'=[15] then '' else [15] end
	set @t_sort10 =  case when '#non'=[16] then '' else [16] end
	set @t_sort3 = case when '#non'=[17] then '' else [17] end
	set @t_bsalesno = case when '#non'=[18] then '' else [18] end
	set @t_esalesno = case when '#non'=[19] then char(255) else [19] end
	set @t_field5 = case when '#non'=[20] then '' else [20] end
	set @t_yproduct = case when '#non'=[21] then '' else [21] end
	set @t_yaddr = case when '#non'=[22] then '' else [22] end
	set @t_yboatname = case when '#non'=[23] then '' else [23] end
	set @t_sort6 = case when '#non'=[24] then '' else [24] end
	set @t_carkindno = case when '#non'=[25] then '' else [25] end
	set @t_sort5 = case when '#non'=[26] then '' else [26] end
	set @t_field13 = case when '#non'=[27] then '' else [27] end
	set @t_sort13 = case when '#non'=[28] then '' else [28] end
	set @t_field1 = case when '#non'=[29] then '' else [29] end
	set @t_sort1 = case when '#non'=[30] then '' else [30] end
	set @t_acomp = case when '#non'=[31] then '' else [31] end
	set @t_sort14 = case when '#non'=[32] then '' else [32] end
	set @t_trandono = case when '#non'=[33] then '' else [33] end
	set @t_option14 = case when '#non'=[34] then '' else [34] end
	set @t_baddrno = case when '#non'=[35] then '' else [35] end
	set @t_eaddrno = case when '#non'=[36] then char(255) else [36] end
	set @t_btrandate = case when '#non'=[37] then '' else [37] end
	set @t_etrandate = case when '#non'=[38] then char(255) else [38] end
	set @t_plusmoney = case when '#non'=[39] then '0' else cast([39] as int) end
	set @t_minusmoney = case when '#non'=[40]then '0' else cast([40] as int) end
	-------------------------------------------------------------------------------------------------------------
	declare @n int
	declare @noa nvarchar(10)
	declare @team nvarchar(20)
	
	declare  @t_isDiscount  bit
	-------------------------------------------------------------------------------------------------------------
	--解析要計算的種類
	declare @string nvarchar(max)
	IF OBJECT_ID('tempdb..#carteam')is not null
	BEGIN
		set @cmd = 'drop table #carteam'
		EXECUTE sp_executesql @cmd
	END
	create table #carteam(
		noa nvarchar(10)
	)
	set @string = @t_carteamno
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #carteam select @string
			end
			break
		end
		insert into #carteam select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	IF OBJECT_ID('tempdb..#calctype')is not null
	BEGIN
		set @cmd = 'drop table #calctype'
		EXECUTE sp_executesql @cmd
	END
	create table #calctype(
		noa nvarchar(10)
	)
	set @string = @t_calctype
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #calctype select @string
			end
			break
		end
		insert into #calctype select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	set @t_isDiscount=0
	set @string = @t_other
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				if  @string='discount'
					set  @t_isDiscount  =  1
			end
			break
		end
		if   LEFT(@string,@n-1)='discount'
			set  @t_isDiscount  =  1
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	-------------------------------------------------------------------------------------------------------------
	declare @tmp table(
		gno nvarchar(3),
		driverno nvarchar(20),
		namea nvarchar(20),
		total float,
		total2 float,
		diff  float
	)
	
	set @cmd = " select  '0',a.driverno,b.namea,SUM(isnull(total,0)),"
	if  @t_isDiscount=1
		set @cmd = @cmd+" SUM(isnull(round(mount2*(price2+price3)*discount,0),0)),SUM(isnull(total,0)-isnull(round(mount2*(price2+price3)*discount,0),0))"
	else
		set @cmd = @cmd+" SUM(isnull(round(mount2*(price2+price3),0),0)),SUM(isnull(total,0)-isnull(round(mount2*(price2+price3),0),0))"
	set @cmd = @cmd+
		" from  trans"+@t_accy+"  a"+
		" left join driver b on a.driverno=b.noa"+
		" left join #carteam  c on a.carteamno=c.noa"+	
		" left join #calctype d on a.calctype=d.noa"+
		" where "+
		" (a.datea  between  @t_bdate  and  @t_edate) and "+
		" (a.custno  between  @t_bcustno   and  @t_ecustno) and "+
		" (a.driverno  between  @t_bdriverno   and  @t_edriverno) and "+
		" (len(@t_carno)=0  or  a.carno=@t_carno) and "+
		" (len(@t_po)=0  or  a.po=@t_po) and "+
		"(len(@t_addr)=0 or  a.straddrno = @t_addr  or  a.straddr = @t_addr)  and"+
		" (c.noa  is  not  null) and (d.noa  is  not  null)"+
		" group by a.driverno,b.namea"
	insert into @tmp
	execute sp_executesql @cmd,N'@t_bdate nvarchar(10),@t_edate nvarchar(10),@t_bcustno nvarchar(20),@t_ecustno nvarchar(20),@t_bdriverno  nvarchar(20),@t_edriverno  nvarchar(20),@t_carno  nvarchar(20),@t_po  nvarchar(20),@t_addr  nvarchar(20)',
		@t_bdate=@t_bdate,@t_edate=@t_edate,@t_bcustno=@t_bcustno,@t_ecustno=@t_ecustno,@t_bdriverno=@t_bdriverno,@t_edriverno=@t_edriverno,@t_carno=@t_carno,@t_po=@t_po,@t_addr=@t_addr
	
	insert into @tmp
	select '1','','',SUM(total),SUM(total2),SUM(diff) from @tmp
	
	select gno,driverno,namea,
		SUBSTRING(CONVERT(varchar,CAST(total as money),1 ),1, LEN(CONVERT(varchar,CAST(total as money),1 ))-3) total,
		SUBSTRING(CONVERT(varchar,CAST(total2 as money),1 ),1, LEN(CONVERT(varchar,CAST(total2 as money),1 ))-3) total2,
		SUBSTRING(CONVERT(varchar,CAST(diff as money),1 ),1, LEN(CONVERT(varchar,CAST(diff as money),1 ))-3) diff
	from @tmp order by gno,driverno;
z_trana3:--z_trana3
	SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	declare @t_accy nvarchar(10)
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_bcustno nvarchar(30)
	declare @t_ecustno nvarchar(30)
	declare @t_bdriverno nvarchar(30)
	declare @t_edriverno nvarchar(30)
	declare @t_carno nvarchar(20)
	declare @t_po nvarchar(20)
	declare @t_addr nvarchar(20)
	declare @t_carteamno nvarchar(max)
	declare @t_calctype nvarchar(max)
	declare @t_other nvarchar(max)
	declare @t_calcmoney nvarchar(max)
	declare @t_sort8 nvarchar(max)
	declare @t_sort10 nvarchar(max)
	declare @t_sort3 nvarchar(max)
	
	set @t_accy = [1]
	set @t_bdate = case when '#non'=[2] then '' else [2] end
	set @t_edate = case when '#non'=[3] then char(255) else [3] end
	set @t_bcustno = case when '#non'=[4] then '' else [4] end
	set @t_ecustno = case when '#non'=[5] then char(255) else [5] end
	set @t_bdriverno = case when '#non'=[6] then '' else [6] end
	set @t_edriverno = case when '#non'=[7] then char(255) else [7] end
	set @t_carno = case when '#non'=[8] then '' else [8] end
	set @t_po = case when '#non'=[9] then '' else [9] end
	set @t_addr = case when '#non'=[10] then '' else [10] end
	set @t_carteamno = case when '#non'=[11] then '' else [11] end
	set @t_calctype = case when '#non'=[12] then '' else [12] end
	set @t_other = case when '#non'=[13] then '' else [13] end
	set @t_calcmoney = case when '#non'=[14] then '' else [14] end
	set @t_sort8 = case when '#non'=[15] then '' else [15] end
	set @t_sort10 =  case when '#non'=[16] then '' else [16] end
	set @t_sort3 = case when '#non'=[17] then '' else [17] end
	-------------------------------------------------------------------------------------------------------------
	declare @n int
	declare @noa nvarchar(10)
	declare @carno nvarchar(20)
	declare @mount2 float
	declare @total2 float
	declare @team nvarchar(20)
	declare @x_key nvarchar(max)
	declare @x_mount2 float
	declare @x_total2 float
	declare @driverno nvarchar(20)
	-------------------------------------------------------------------------------------------------------------
	--解析要計算的種類
	declare @string nvarchar(max)
	IF OBJECT_ID('tempdb..#carteam')is not null
	BEGIN
		set @cmd = 'drop table #carteam'
		EXECUTE sp_executesql @cmd
	END
	create table #carteam(
		noa nvarchar(10)
	)
	set @string = @t_carteamno
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #carteam select @string
			end
			break
		end
		insert into #carteam select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	IF OBJECT_ID('tempdb..#calctype')is not null
	BEGIN
		set @cmd = 'drop table #calctype'
		EXECUTE sp_executesql @cmd
	END
	create table #calctype(
		noa nvarchar(10)
	)
	set @string = @t_calctype
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #calctype select @string
			end
			break
		end
		insert into #calctype select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	-------------------------------------------------------------------------------------------------------------
	IF OBJECT_ID('tempdb..#z_trana3')is not null
	BEGIN
		set @cmd = 'drop table #z_trana3'
		EXECUTE sp_executesql @cmd
	END
	create table #z_trana3(
		gno nvarchar(3),
		trandate nvarchar(10),
		datea nvarchar(10),
		custno nvarchar(20),
		comp nvarchar(40),
		driverno nvarchar(20),
		namea nvarchar(20),
		carno nvarchar(20),
		addr nvarchar(40),
		product nvarchar(40),
		mount decimal(10,3),
		price float,
		total float,
		mount2 decimal(10,3),
		price2 float,
		price3 float,
		discount decimal(10,3),
		total2 float,
		po nvarchar(30),
		caseno nvarchar(30),
		cc  nvarchar(20),
		tt  nvarchar(20),
		noa  nvarchar(20)
	)
	
	set @cmd = 
		" select  '0',a.trandate,a.datea,a.custno,left(a.comp,4),a.driverno,a.driver,a.carno,a.straddr,a.product,"+
		" a.mount,a.price,a.total,a.mount2,a.price2,a.price3,a.discount,a.total2,a.po,a.caseno,e.typea,d.team,a.noa"+
		" from  trans"+@t_accy+"  a"+
		" left join #carteam  b on a.carteamno=b.noa"+	
		" left join #calctype c on a.calctype=c.noa"+
		" left join carteam  d on a.carteamno=d.noa"+	
		" left join calctypes e on a.calctype=e.noa+e.noq"+
		" where "+
		" (a.datea  between  @t_bdate  and  @t_edate) and "+
		" (a.custno  between  @t_bcustno   and  @t_ecustno) and "+
		" (a.driverno  between  @t_bdriverno   and  @t_edriverno) and "+
		" (len(@t_carno)=0  or  a.carno=@t_carno) and "+
		" (len(@t_po)=0  or  a.po=@t_po) and "+
		"(len(@t_addr)=0 or  a.straddrno = @t_addr  or  a.straddr = @t_addr)  and"+
		" (b.noa  is  not  null) and (c.noa  is  not  null)"
	if @t_sort3='carno'  or @t_sort3='noa' or @t_sort3='driverno' 
		set  @cmd  =  @cmd+" order  by  a.driverno,a.carno,a.noa"
	else
		set  @cmd  =  @cmd+" order  by  a.driverno,a.carno,a.["+@t_sort3+"],a.noa"
	insert into #z_trana3
	execute sp_executesql @cmd,N'@t_bdate nvarchar(10),@t_edate nvarchar(10),@t_bcustno nvarchar(20),@t_ecustno nvarchar(20),@t_bdriverno  nvarchar(20),@t_edriverno  nvarchar(20),@t_carno  nvarchar(20),@t_po  nvarchar(20),@t_addr  nvarchar(20)',
		@t_bdate=@t_bdate,@t_edate=@t_edate,@t_bcustno=@t_bcustno,@t_ecustno=@t_ecustno,@t_bdriverno=@t_bdriverno,@t_edriverno=@t_edriverno,@t_carno=@t_carno,@t_po=@t_po,@t_addr=@t_addr
		
	select @mount2=SUM(ISNULL(mount2,0)),@total2=SUM(ISNULL(total2,0)) from #z_trana3
	insert into #z_trana3 (gno,driverno,carno,mount2,total2)values('1',CHAR(255),CHAR(255),@mount2,@total2)
	
	
	if @t_sort3='carno'  or @t_sort3='noa' 
	begin 
		declare cursor_table cursor for
		select driverno,carno,max(noa),sum(isnull(mount2,0)),sum(isnull(total2,0)) from #z_trana3 where gno='0' group  by  driverno,carno
		open cursor_table
		fetch next from cursor_table
		into @driverno,@carno,@noa,@mount2,@total2
		while(@@FETCH_STATUS <> -1)
		begin
			insert  into  #z_trana3(gno,driverno,carno,noa,mount2,total2)values('0',@driverno,@carno,@noa+CHAR(255),@mount2,@total2)		
			fetch next from cursor_table
			into @driverno,@carno,@noa,@mount2,@total2
		end
		close cursor_table
		deallocate cursor_table
	end
	else
	begin
		declare cursor_table cursor for
		select driverno,carno from #z_trana3 where gno='0'  group  by  driverno,carno
		open cursor_table
		fetch next from cursor_table
		into @driverno,@carno
		while(@@FETCH_STATUS <> -1)
		begin
			set @x_key=''
			set @cmd="select @x_key=cast(max("+@t_sort3+") as  nvarchar) from  #z_trana3 where driverno=@driverno and carno=@carno"
			execute sp_executesql @cmd,N'@driverno nvarchar(20),@carno  nvarchar(20),@x_key nvarchar(max) output',@driverno=@driverno,@carno=@carno,@x_key=@x_key output 
			
			set @noa=''
			set @cmd="select @noa=max(noa) from  #z_trana3 where driverno=@driverno and carno=@carno and "+@t_sort3+"=@x_key"
			execute sp_executesql @cmd,N'@driverno nvarchar(20),@carno  nvarchar(20),@x_key nvarchar(max),@noa nvarchar(20) output',@driverno=@driverno,@carno=@carno,@x_key=@x_key,@noa=@noa output
			select @mount2=0,@total2=0
			select @mount2=sum(isnull(mount2,0)),@total2=sum(isnull(total2,0)) from #z_trana3 where driverno=@driverno and carno=@carno
			
			set @cmd="insert  into  #z_trana3(gno,driverno,carno,"+@t_sort3+",noa,mount2,total2)values('0',@driverno,@carno,char(255),CHAR(255),@mount2,@total2)"
			execute sp_executesql @cmd,N'@driverno nvarchar(20),@carno  nvarchar(20),@mount2  float,@total2  float',@driverno=@driverno,@carno=@carno,@mount2=@mount2,@total2=@total2	
			
			fetch next from cursor_table
			into @driverno,@carno
		end
		close cursor_table
		deallocate cursor_table
	end
	
	if @t_sort3='carno'  or @t_sort3='noa' or @t_sort3='driverno' 
	begin
		set @cmd = 
			" select  gno,trandate  aa,custno bb,namea cc,carno dd,addr,product ee,mount2 ff,"+
			" case when price2=0 then price3 else price2 end gg,discount hh,"+
			" reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total2),1)),4,12)) ii,"+
			" caseno jj,case when right(noa,1)=char(255) then '' else noa  end kk "+
			" from  #z_trana3  order  by driverno,carno,gno,noa"
	end
	else
	begin
		set @cmd = " select  gno,trandate  aa,custno bb,namea cc,carno dd,addr,product ee,mount2 ff,"+
			" case when price2=0 then price3 else price2 end gg,discount hh,"+
			" reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total2),1)),4,12)) ii,"+
			" caseno jj,noa kk "+
			" from  #z_trana3  order  by driverno,carno,gno,["+@t_sort3+"],noa"
	end
	EXECUTE sp_executesql @cmd;


z_trana1:--z_trana1
	;