z_carchg:--z_carchg
declare @t_bdate nvarchar(10)
declare @t_edate nvarchar(10)
declare @t_bdriverno nvarchar(20)
declare @t_edriverno nvarchar(20)
set @t_bdate = case when '#non'=[1] then '' else [1] end
set @t_edate = case when '#non'=[2] then CHAR(255) else [2] end
set @t_bdriverno = case when '#non'=[3] then '' else [3] end
set @t_edriverno = case when '#non'=[4]  then CHAR(255) else [4] end
declare @result table(
		gno  nvarchar(1),
		noa nvarchar(20),
		datea nvarchar(10),
		carno nvarchar(20),
		driverno nvarchar(20),
		driver nvarchar(50),
		item nvarchar(50),
		plus float,
		minus float,
		memo nvarchar(20)
)
insert into @result
select '0' gno,noa,datea,carno,driverno,driver,plusitem+minusitem,plusmoney,minusmoney,memo
from carchg
where (datea between @t_bdate and @t_edate) and
(driverno between @t_bdriverno and @t_edriverno)

insert into @result
select  '1' gno,'','','',driverno,'','',SUM(plus),SUM(minus),''
from @result
group by driverno

insert into @result
select  '2' gno,'','','',MAX(driverno),'','',SUM(plus),SUM(minus),''
from @result

select gno,noa,datea,carno,driverno,driver,item,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,plus),1)),4,12)) plus,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,minus),1)),4,12)) minus,
memo
from @result
order by driverno,gno,datea;