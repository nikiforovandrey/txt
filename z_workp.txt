z_workp1:--z_workp1
declare @t_noa nvarchar(30)
set @t_noa = case when '#non' = [2] then '' else [2] end
declare @tmp table(
	gno nvarchar(1),
	bnoa nvarchar(30),
	bproductno nvarchar(30),
	bproducts nvarchar(90),
	bmount float,
	bunit nvarchar(12),
	bprocess nvarchar(90),
	bordeno nvarchar(30),
	bnom nvarchar(30),
	bcuadate nvarchar(10),
	benddate nvarchar(10),
	anoq nvarchar(3),
	aproductno nvarchar(30),
	aproducts nvarchar(90),
	amount float,
	aunit nvarchar(12),
	amemo nvarchar(max)
)
insert into @tmp
select
	'0',b.noa,b.productno,b.product,b.mount,b.unit,b.process,b.ordeno,b.noa,b.cuadate,b.enddate,
	a.noq,a.productno,a.product,a.mount,a.unit,a.memo
from works[1] a
left join work[1] b on a.noa = b.noa
where (len(b.noa) =0 or b.noa = @t_noa)
order by b.productno,b.ordeno
select
	gno,bnoa,bproductno,bproducts,
	reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,bmount),1)),4,12)) bmount,
	bunit,bprocess,bordeno,bnom,bcuadate,benddate,anoq,aproductno,
	aproducts,
	reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,amount),1)),4,12)) amount,aunit,amemo
from @tmp order by bnoa;

z_workp4:--z_workp4
declare @t_bdate nvarchar(20)
declare @t_edate nvarchar(20)
set @t_bdate = case when '#non' = [3] then '' else [3] end
set @t_edate = case when '#non' = [4] then CHAR(255) else [4] end
declare @tmp table(
	gno nvarchar(1),
	datea nvarchar(10),
	mechno nvarchar(30),
	mechs nvarchar(50),
	activation float,
	borntime float,
	inmount float,
	errmount float,
	chgmo float,
	fault float,
	delay float,
	waittime float,
	waitfedtime float,
	lacksss float,
	workmount float
)
insert into @tmp(gno,datea,mechno,mechs,borntime,inmount,errmount,chgmo,
					   fault,delay,waittime,waitfedtime,lacksss,workmount)
	select
		'0',b.datea,a.noa,a.mech,isnull(c.borntime,0),isnull(b.inmount,0),isnull(b.errmount,0),
		isnull(c.chgtime,0),isnull(c.faulttime,0),isnull(c.delaytime,0),isnull(c.waittime,0),
		isnull(c.waitfedtime,0),isnull(c.lacksss,0),isnull(c.hours,0)
	from mech a 
	left join (
		select
			b.datea,b.mechno,b.mech,sum(a.mount) inmount,sum(a.errmount) errmount
		from workbs[1] a
		left join workb[1] b on a.noa = b.noa
		group by b.datea,b.mechno,b.mech
	) b on (a.noa = b.mechno)
	left join (
		select b.datea,a.mechno,sum(a.borntime) borntime,sum(a.chgtime) chgtime,sum(a.faulttime) faulttime,
				 sum(a.delaytime) delaytime,sum(a.waittime) waittime,sum(a.waitfedtime) waitfedtime,
				 sum(a.lacksss) lacksss,sum(c.hours) hours
		from cuws[1] a
		left join cuw[1] b on a.noa = b.noa
		left join cuwt[1] c on (b.noa = c.noa) and (a.mechno = c.mechno) 
		group by b.datea,a.mechno
	) c on (a.noa = c.mechno) and (c.datea = b.datea)
	where b.datea between @t_bdate and @t_edate
	order by b.datea
update @tmp set activation = case when borntime > 0 then (borntime-(chgmo+fault+delay+waittime+waitfedtime+lacksss))/borntime
										 else 0 end
insert into @tmp
	select '1',datea,'','',sum(activation),sum(borntime),sum(inmount),sum(errmount),
			 sum(chgmo),sum(fault),sum(delay),sum(waittime),sum(waitfedtime),sum(lacksss),
			 sum(workmount)
	from @tmp
	group by datea
select
	gno,datea,mechno,mechs,activation,
	reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,borntime),1)),4,12)) borntime,
	reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,inmount),1)),4,12)) inmount,
	reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,errmount),1)),4,12)) errmount,
	reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,chgmo),1)),4,12)) chgmo,
	reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,fault),1)),4,12)) fault,
	reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,delay),1)),4,12)) delay,
	reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,waittime),1)),4,12)) waittime,
	reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,waitfedtime),1)),4,12)) waitfedtime,
	reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,lacksss),1)),4,12)) lacksss,
	reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,workmount),1)),4,12)) workmount
from @tmp order by datea,gno,mechno;