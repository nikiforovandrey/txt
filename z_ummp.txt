z_ummp:--z_ummp
SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	declare @pagecount int
	declare @t_bxnoa nvarchar(20)
	declare @t_exnoa nvarchar(20)
	set @pageCount = 7
	set @t_bxnoa = case when '#non'=[1] then '' else [1] end
	set @t_exnoa = case when '#non'=[2] then CHAR(255) else [2] end
	declare @tmp table( 
			gno nvarchar(1), 
			noa nvarchar(30), 
			noq nvarchar(20), 
			datea nvarchar(10), 
			mon nvarchar(6), 
			unpay float, 
			custno nvarchar(10), 
			comp nvarchar(50), 
			[money] float, 
			chgs float, 
			paysale float, 
			checkno nvarchar(32), 
			account nvarchar(23), 
			bankno nvarchar(28), 
			bank nvarchar(52), 
			indate nvarchar(10), 
			acc2 nvarchar(50), 
			sale float, 
			total float, 
			opay float, 
			unopay float, 
			memo nvarchar(max),
			accno nvarchar(10), 
			w nvarchar(20), 
			recno int, 
			currecno int, 
			curpage int, 
			totpage int 
		) 
		set @cmd =	"select a.*,ROW_NUMBER()over(order by gno),0,0,0"+ 
		" from("+ 
		" select '0' gno,a.noa,b.noq,a.datea,a.mon,a.unpay,a.custno,a.comp,b.money,b.chgs,"+ 
		"a.paysale,b.checkno,b.account,b.bankno,b.bank,b.indate,b.acc2,a.sale,a.total,a.opay,a.unopay,b.memo,a.accno,a.worker"+ 
		" from umm a "+ 
		" left join umms b on a.noa = b.noa " + 
		" where (b.money != 0 or len(b.memo) != 0)and "+ 
		" a.noa between @t_bxnoa and @t_exnoa"+ 
		" ) a" 
		insert into @tmp 
		execute sp_executesql @cmd,N'@t_bxnoa nvarchar(20),@t_exnoa nvarchar(20)', 
		@t_bxnoa=@t_bxnoa,@t_exnoa=@t_exnoa 
	
		declare @noa nvarchar(30) 
		declare @count int 
		declare @t_count int 
		declare @recno int 
		declare @currecno int 
		declare @curpage int 
		declare @totpage int 
		declare @accno nvarchar(20) 
		declare @w nvarchar(20) 

		declare cursor_table cursor for 
		select noa,min(recno) from @tmp group by noa 
		open cursor_table 
		fetch next from cursor_table 
		into @noa,@recno 
		while(@@FETCH_STATUS <> -1) 
		begin 
			update @tmp set currecno = recno - @recno +1 where noa=@noa 
			fetch next from cursor_table 
			into @noa,@recno 
		end 
		close cursor_table 
		deallocate cursor_table 

		declare cursor_table cursor for 
		select noa,max(currecno) from @tmp group by noa 
		open cursor_table 
		fetch next from cursor_table 
		into @noa,@currecno 
		while(@@FETCH_STATUS <> -1) 
		begin 
			update @tmp set totpage = (@currecno-@currecno%@pagecount)/@pagecount+1 where noa=@noa 
			fetch next from cursor_table 
			into @noa,@currecno 
		end 
		close cursor_table 
		deallocate cursor_table 

		declare cursor_table cursor for 
		select noa,recno,currecno from @tmp 
		open cursor_table 
		fetch next from cursor_table 
		into @noa,@recno,@currecno 
		while(@@FETCH_STATUS <> -1) 
		begin 
			update @tmp set curpage = FLOOR((@currecno-1)/@pagecount)+1 where noa=@noa and recno=@recno 
			fetch next from cursor_table 
			into @noa,@recno,@currecno 
		end 
		close cursor_table 
		deallocate cursor_table 

		declare cursor_table cursor for 
		select noa,accno,w,curpage,@pagecount-[count]%@pagecount,([count]-[count]%@pagecount)/@pagecount+1 
		from(select noa,max(accno) accno,max(w) w,COUNT(1) [count], max(curpage) curpage from @tmp group by noa) a 
		where not[count]%@pagecount=0 
		open cursor_table 
		fetch next from cursor_table 
		into @noa,@accno,@w,@curpage,@count,@totpage 
		while(@@FETCH_STATUS <> -1) 
		begin 
			set @t_count = @count 
			while(@t_count>0) 
			begin 
				insert into @tmp(gno,noa,noq,accno,w,curpage,totpage)values('0',@noa,CHAR(255),@accno,@w,@curpage,@totpage) 
				set @t_count = @t_count - 1 
			end 
			fetch next from cursor_table 
			into @noa,@accno,@w,@curpage,@count,@totpage 
		end 
		close cursor_table 
		deallocate cursor_table 

		insert into @tmp 
		select '1' gno,noa,MAX(noq),'','',0,'','',0,0,0,'','','','','','',0,0,0,0,'','','',0,0,curpage,MAX(totpage)
		from @tmp
		group by noa,curpage

		select gno,noa,noq,datea,mon,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,unpay),1)),4,12)) unpay, 
		custno,comp,case when money = 0 then '' else reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,money),1)),4,12)) end money, 
		case when chgs = 0 then '' else reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,chgs),1)),4,12))end chgs,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,paysale),1)),4,12)) paysale, 
		checkno,account,bankno,bank,indate,acc2, 
		reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,sale),1)),4,12)) sale, 
		reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total),1)),4,12)) total, 
		reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,opay),1)),4,12)) opay, 
		reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,unopay),1)),4,12)) unopay, memo,
		accno,w,CONVERT(nvarchar(5),curpage)+'/'+CONVERT(nvarchar(5),totpage) page from @tmp order by noa,noq,curpage,gno;