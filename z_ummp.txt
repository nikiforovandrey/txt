z_ummp:--z_ummp
SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	declare @pagecount int
	declare @t_bxnoa nvarchar(20)
	declare @t_exnoa nvarchar(20)
	set @pageCount = 12
	set @t_bxnoa = case when '#non'=[1] then '' else [1] end
	set @t_exnoa = case when '#non'=[2] then CHAR(255) else [2] end
	declare @tmp table(
		gno nvarchar(1),
		noa nvarchar(30),
		noq nvarchar(20),
		datea nvarchar(10),
		mon nvarchar(6),
		unpay float,
		custno nvarchar(10),
		comp nvarchar(50),
		[money] float,
		chgs float,
		paysale float,
		checkno nvarchar(32),
		account nvarchar(23),
		bankno nvarchar(28),
		bank nvarchar(52),
		indate nvarchar(10),
		accno nvarchar(10),
		recno int,
		currecno int,
		curpage int,
		totpage int
	)
	set @cmd =	"select a.*,ROW_NUMBER()over(order by gno),0,0,0"+
				" from("+
				" select '0' gno,a.noa,b.noq,a.datea,a.mon,a.unpay,a.custno,a.comp,b.money,b.chgs,"+
				"b.paysale,b.checkno,b.account,b.bankno,b.bank,b.indate,a.accno"+
				" from umm a "+
				" left join umms b on a.noa = b.noa " + 
				" where "+
				" a.noa between @t_bxnoa and @t_exnoa"+
				" ) a"
	insert into @tmp
	execute sp_executesql @cmd,N'@t_bxnoa nvarchar(20),@t_exnoa nvarchar(20)',
							@t_bxnoa=@t_bxnoa,@t_exnoa=@t_exnoa

declare @noa nvarchar(30)
	declare @count int
	declare @t_count int
	declare @recno int
	declare @currecno int
	declare @curpage int
	declare @totpage int
	
	declare cursor_table cursor for
	select noa,min(recno) from @tmp group by noa
	open cursor_table
	fetch next from cursor_table
	into @noa,@recno
	while(@@FETCH_STATUS <> -1)
	begin
		update @tmp set currecno = recno - @recno +1 where noa=@noa
		fetch next from cursor_table
		into @noa,@recno
	end
	close cursor_table
	deallocate cursor_table
	
	declare cursor_table cursor for
	select noa,max(currecno) from @tmp group by noa
	open cursor_table
	fetch next from cursor_table
	into @noa,@currecno
	while(@@FETCH_STATUS <> -1)
	begin
		update @tmp set totpage = (@currecno-@currecno%@pagecount)/@pagecount+1 where noa=@noa
		fetch next from cursor_table
		into @noa,@currecno
	end
	close cursor_table
	deallocate cursor_table
	
	declare cursor_table cursor for
	select noa,recno,currecno from @tmp
	open cursor_table
	fetch next from cursor_table
	into @noa,@recno,@currecno
	while(@@FETCH_STATUS <> -1)
	begin
		update @tmp set curpage = FLOOR((@currecno-1)/@pagecount)+1 where noa=@noa and recno=@recno
		fetch next from cursor_table
		into @noa,@recno,@currecno
	end
	close cursor_table
	deallocate cursor_table

	declare cursor_table cursor for
	select noa,curpage,@pagecount-[count]%@pagecount,([count]-[count]%@pagecount)/@pagecount+1
	from(select noa,COUNT(1) [count], max(curpage) curpage from @tmp group by noa) a
	where not[count]%@pagecount=0
	open cursor_table
	fetch next from cursor_table
	into @noa,@curpage,@count,@totpage
	while(@@FETCH_STATUS <> -1)
	begin
		set @t_count = @count
		while(@t_count>0)
		begin
			insert into @tmp(gno,noa,noq,curpage,totpage)values('0',@noa,CHAR(255),@curpage,@totpage)
			set @t_count = @t_count - 1
		end
		fetch next from cursor_table
		into @noa,@curpage,@count,@totpage
	end
	close cursor_table
	deallocate cursor_table

		select gno,noa,noq,datea,mon,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,unpay),1)),4,12)) unpay,
	custno,comp,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,money),1)),4,12)) money,
	reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,chgs),1)),4,12)) chgs,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,paysale),1)),4,12)) paysale,
	checkno,account,bankno,bank,indate,accno,CONVERT(nvarchar(5),curpage)+'/'+CONVERT(nvarchar(5),totpage) page from @tmp order by noa,noq;