z_tire1:--z_tire1
declare @t_bdate nvarchar(10)
declare @t_edate nvarchar(10)
declare @t_sort nvarchar(10)
set @t_bdate = case when '#non' = [1] then '' else [1] end
set @t_edate = case when '#non' = [2] then CHAR(255) else [2] end
set @t_sort = case when '#non' = [3] then '' else [3] end
declare @tmp table(
		gno nvarchar(1),
		noa nvarchar(20),
		datea nvarchar(10),
		carno nvarchar(20),
		carplateno nvarchar(20),
		driverno nvarchar(20),
		driver nvarchar(90),
		tggno nvarchar(20),
		tgg nvarchar(90),
		p nvarchar(10),
		btireno nvarchar(20),
		actions nvarchar(10),
		etireno nvarchar(20),
		memo nvarchar(20)
)
insert into @tmp
select '0' gno,a.noa,a.datea,a.carno,a.carplateno,c.driverno,d.namea,a.tggno,a.tgg,
b.position,b.btireno,b.action,b.etireno,b.memo
from tire a
left join tires b on a.noa = b.noa
left join car2 c on a.carno = c.noa
left join driver d on d.noa = c.driverno

select *
from @tmp
order by [3];

--*************************************************************************************
z_tire2:--z_tire2
declare @t_bdate nvarchar(10)
declare @t_edate nvarchar(10)
set @t_bdate = case when '#non'=[1] then '' else [1] end
set @t_edate = case when '#non'=[2] then char(255) else [2] end
declare @csor table(
	carno nvarchar(20),
	datea nvarchar (10),
	changa decimal(10,0),
	changb decimal (10,0)
)
insert into @csor
select  a.carno,a.datea,sum(case when b.action = '02' then 1 end),sum(case when b.action = '01' then 1  end)
from tire a
left join tires b on b.noa = a.noa
group by a.carno,a.datea
declare @result table(
			gno nvarchar(1),
			noa nvarchar(30),
			a1 nvarchar(20),
			b1 decimal(10,0),
			c1 decimal(10,0),
			a2 nvarchar(20),
			b2 decimal(10,0),
			c2 decimal(10,0),
			a3 nvarchar(20),
			b3 decimal(10,0),
			c3 decimal(10,0),
			a4 nvarchar(20),
			b4 decimal(10,0),
			c4 decimal(10,0),
			a5 nvarchar(20),
			b5 decimal(10,0),
			c5 decimal(10,0),
			a6 nvarchar(20),
			b6 decimal(10,0),
			c6 decimal(10,0),
			a7 nvarchar(20),
			b7 decimal(10,0),
			c7 decimal(10,0),
			a8 nvarchar(20),
			b8 decimal(10,0),
			c8 decimal(10,0)
	)
	insert into @result
	select
		'0' gno,s1.noa,S1.a1 a1,S1.b1 b1,S1.c1 c1,S2.a2 a2,S2.b2 b2,S2.c2 c2,S3.a3 a3,S3.b3 b3,S3.c3 c3,S4.a4 a4,S4.b4 b4,
		 S4.c4 c4,S5.a5 a5,S5.b5 b5,S5.c5 c5,S6.a6 a6,S6.b6 b6,S6.c6 c6,S7.a7 a7,S7.b7 b7,S7.c7 c7,S8.a8 a8,S8.b8 b8,S8.c8 c8
	from
		(select
			ROW_NUMBER()over(order by R1.noa)as noa,datea,R1.carno a1,R1.changa b1,R1.changb c1
		from
			(select ROW_NUMBER()over(order by carno)as noa,datea,carno,changa, changb from @csor as zz  where (datea between @t_bdate and @t_edate))as R1
		where R1.noa%8=1) as S1
		
		left join
		(select
			ROW_NUMBER()over(order by R1.noa)as noa,datea,R1.carno a2,R1.changa b2,R1.changb c2
		from
			(select ROW_NUMBER()over(order by carno)as noa,datea,carno,changa, changb from @csor as zz  where (datea between @t_bdate and @t_edate))as R1
		where R1.noa%8=2) as S2
	on s1.noa=s2.noa
	left join
		(select
			ROW_NUMBER()over(order by R1.noa)as noa,datea,R1.carno a3,R1.changa b3,R1.changb c3
		from
			(select ROW_NUMBER()over(order by carno)as noa,datea,carno,changa, changb from @csor as zz  where (datea between @t_bdate and @t_edate))as R1
		where R1.noa%8=3) as S3
	on s1.noa=s3.noa
	left join
		(select
			ROW_NUMBER()over(order by R1.noa)as noa,datea,R1.carno a4,R1.changa b4,R1.changb c4
		from
			(select ROW_NUMBER()over(order by carno)as noa,datea,carno,changa, changb from @csor as zz  where (datea between @t_bdate and @t_edate))as R1
		where R1.noa%8=4) as S4
	on s1.noa=S4.noa
	left join
		(select
			ROW_NUMBER()over(order by R1.noa)as noa,datea,R1.carno a5,R1.changa b5,R1.changb c5
		from
			(select ROW_NUMBER()over(order by carno)as noa,datea,carno,changa, changb from @csor as zz  where (datea between @t_bdate and @t_edate))as R1
		where R1.noa%8=5) as S5
	on s1.noa=S5.noa
	left join
		(select
			ROW_NUMBER()over(order by R1.noa)as noa,datea,R1.carno a6,R1.changa b6,R1.changb c6
		from
			(select ROW_NUMBER()over(order by carno)as noa,datea,carno,changa, changb from @csor as zz  where (datea between @t_bdate and @t_edate))as R1
		where R1.noa%8=6) as S6
	on s1.noa=S6.noa
	left join
		(select
			ROW_NUMBER()over(order by R1.noa)as noa,datea,R1.carno a7,R1.changa b7,R1.changb c7
		from
			(select ROW_NUMBER()over(order by carno)as noa,datea,carno,changa, changb from @csor as zz  where (datea between @t_bdate and @t_edate))as R1
		where R1.noa%8=7) as S7
	on s1.noa=S7.noa
	left join
		(select
			ROW_NUMBER()over(order by R1.noa)as noa,datea,R1.carno a8,R1.changa b8,R1.changb c8
		from
			(select ROW_NUMBER()over(order by carno)as noa,datea,carno,changa, changb from @csor as zz  where (datea between @t_bdate and @t_edate))as R1
		where R1.noa%8=0) as S8
	on s1.noa=S8.noa
	
	
	select *
	from @result;