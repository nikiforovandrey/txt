z_tran09:--z_tran09	
	SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	declare @t_accy nvarchar(10)
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_btrandate nvarchar(10)
	declare @t_etrandate nvarchar(10)
	declare @t_bcustno nvarchar(20)
	declare @t_ecustno nvarchar(20)
	declare @t_bdriverno nvarchar(20)
	declare @t_edriverno nvarchar(20)
	declare @t_carno nvarchar(20)
	declare @t_po nvarchar(20)
	declare @t_baddr nvarchar(20)
	declare @t_eaddr nvarchar(20)
	declare @t_cno nvarchar(20)
	declare @t_option1  nvarchar(max)
	declare @t_option2  nvarchar(max)
	declare @t_option3  nvarchar(max)
	declare @t_carteam  nvarchar(max)
	declare @t_carkind  nvarchar(max)
	declare @t_calctype  nvarchar(max)
	declare @z_product  nvarchar(max)
	declare @z_addr  nvarchar(max)
	declare @z_boatname nvarchar(max)
	declare @z_delivery  nvarchar(max)
	declare @z_plusmoney  nvarchar(max)
	declare @z_minusmoney  nvarchar(max)
	declare @t_sort08  nvarchar(max)
	
	set @t_accy = '[1]'
	set @t_bdate = case when '#non'=[2] then '' else [2] end
	set @t_edate = case when '#non'=[3] then CHAR(255) else [3] end
	set @t_btrandate = case when '#non'=[4] then '' else [4] end
	set @t_etrandate = case when '#non'=[5] then CHAR(255) else [5] end
	set @t_bcustno = case when '#non'=[6] then '' else [6] end
	set @t_ecustno = case when '#non'=[7] then CHAR(255) else [7] end
	set @t_bdriverno = case when '#non'=[8] then '' else [8] end
	set @t_edriverno = case when '#non'=[9] then CHAR(255) else [9] end
	set @t_carno = case when '#non'=[10] then '' else [10] end
	set @t_po = case when '#non'=[11] then '' else [11] end
	set @t_baddr = case when '#non'=[12] then '' else [12] end
	set @t_eaddr = case when '#non'=[13] then CHAR(255) else [13] end
	set @t_cno = case when '#non'=[14] then '' else [14] end
	set @t_option1  = case when '#non'=[15] then '' else [15] end
	set @t_option2  = case when '#non'=[16] then '' else [16] end
	set @t_option3  = case when '#non'=[17] then '' else [17] end
	set @t_carteam  = case when '#non'=[18] then '' else [18] end
	set @t_carkind  = case when '#non'=[19] then '' else [19] end
	set @t_calctype = case when '#non'=[20] then '' else [20] end
	set @z_product = case when '#non'=[21] then '' else [21] end
	set @z_addr = case when '#non'=[22] then '' else [22] end
	set @z_boatname = case when '#non'=[23] then '' else [23] end
	set @z_delivery  = case when '#non'=[24] then '' else [24] end
	set @z_plusmoney  = case when '#non'=[25] then '' else [25] end
	set @z_minusmoney  = case when '#non'=[26] then '' else [26] end
	set @t_sort08  = case when '#non'=[27] then '' else [27] end
	----------------------------------------------------------------------------------------------
	declare @minN int
	declare @string nvarchar(max)
	declare @n int
	declare @carno nvarchar(20)
	declare @datea nvarchar(10)
	declare @carkindno  nvarchar(20)
	declare @carkind	nvarchar(20)
	declare @miles float
	declare @tranmoney float
	declare @drivermoney float
	declare @reserve float 
	declare @mount float 
	declare @money float 
	declare @unit nvarchar(20)
	declare @custno nvarchar(20)
	declare @comp  nvarchar(max)
	declare @carteamno nvarchar(20)
	declare @team  nvarchar(20)
	declare @po nvarchar(20)
	declare @trandono nvarchar(20)
	declare @noa nvarchar(20)
	declare @acomp nvarchar(max)
	declare @mount2 float
	declare @mount3 float
	declare @serial nvarchar(20)
	declare @tel nvarchar(20)
	declare @money2 float
	declare @money3 float
	declare @driver nvarchar(20)
	declare @rate float
	----------------------------------------------------------------------------------------------
	--解析要計算的種類
	IF OBJECT_ID('tempdb..#carkind')is not null
	BEGIN
		set @cmd = 'drop table #carkind'
		EXECUTE sp_executesql @cmd
	END
	create table #carkind(
		noa nvarchar(20)
	)
	set @string = @t_carkind
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #carkind select @string
			end
			break
		end
		insert into #carkind select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	IF OBJECT_ID('tempdb..#carteam')is not null
	BEGIN
		set @cmd = 'drop table #carteam'
		EXECUTE sp_executesql @cmd
	END
	create table #carteam(
		noa nvarchar(20)
	)
	set @string = @t_carteam
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #carteam select @string
			end
			break
		end
		insert into #carteam select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	IF OBJECT_ID('tempdb..#calctype')is not null
	BEGIN
		set @cmd = 'drop table #calctype'
		EXECUTE sp_executesql @cmd
	END
	create table #calctype(
		noa nvarchar(20)
	)
	set @string = @t_calctype
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #calctype select @string
			end
			break
		end
		insert into #calctype select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	----------------------------------------------------------------------------------------------
	set @cmd= 
	" select a.carno,a.driver,sum(isnull(a.miles,0))"+
	" from trans"+@t_accy+" a"+
	" left join #calctype b on a.calctype=b.noa"+
	" left join car2 c on a.carno=c.carno"+
	" left join #carkind d on c.carkindno=d.noa"+
	" where (b.noa is  not  null) and (d.noa is  not  null)"+
	"	and (len(@t_carno)=0 or a.carno=@t_carno)"+
	"	and (a.datea between @t_bdate and @t_edate)"+
	"	and (a.trandate between @t_btrandate and @t_etrandate)"+
	"	and (a.custno between @t_bcustno and @t_ecustno)"+
	"	and (a.driverno between @t_bdriverno and @t_edriverno)"+
	"	and (a.straddrno between @t_baddr and @t_eaddr)"+
	"	and (len(@t_po)=0 or a.po=@t_po) and isnull(a.miles,0)>0"+
	" group by a.carno,a.driver"
	
	declare @tmp1 table(
		carno nvarchar(20),
		driver nvarchar(20),
		miles float
	)
	insert into @tmp1
	EXECUTE sp_executesql @cmd,N'@t_bdate nvarchar(10),@t_edate nvarchar(10),@t_bdriverno nvarchar(20),@t_edriverno nvarchar(20),@t_carno nvarchar(20),@t_bcustno  nvarchar(20),@t_ecustno  nvarchar(20),@t_po  nvarchar(30),@t_btrandate  nvarchar(10),@t_etrandate  nvarchar(10),@t_baddr  nvarchar(20),@t_eaddr  nvarchar(20)',
		@t_bdate=@t_bdate,@t_edate=@t_edate,@t_bdriverno=@t_bdriverno,@t_edriverno=@t_edriverno,@t_carno=@t_carno,@t_bcustno=@t_bcustno,@t_ecustno=@t_ecustno,@t_po=@t_po,@t_btrandate=@t_btrandate,@t_etrandate=@t_etrandate,@t_baddr=@t_baddr,@t_eaddr=@t_eaddr
	----------------------------------------------------------------------------
	declare @tmp2 table(
		carno nvarchar(20),
		driver nvarchar(20),
		mount float
	)
	if  LEN(@t_bdate)>0
	begin
		insert into @tmp2
		select a.carno,a.driver,SUM(isnull(a.mount,0)) 
		from oil a
		left  join  car2  b  on  a.carno=b.carno
		left  join  #carkind  c  on  c.noa=b.carkindno  
		where (c.noa  is  not  null)
			and (a.datea between @t_bdate and @t_edate) 
			and (a.driverno between @t_bdriverno and @t_edriverno)
			and (len(@t_carno)=0 or a.carno=@t_carno)
		group by a.carno,a.driver
	end
	else
	begin
		insert into @tmp2
		select a.carno,a.driver,SUM(isnull(a.mount,0)) 
		from oil a
		left  join  car2  b  on  a.carno=b.carno
		left  join  #carkind  c  on  c.noa=b.carkindno  
		where (c.noa  is  not  null)
			and (a.datea between @t_btrandate and @t_etrandate) 
			and (a.driverno between @t_bdriverno and @t_edriverno)
			and (len(@t_carno)=0 or a.carno=@t_carno)
		group by a.carno,a.driver
	end
	
	declare @tmp table(
		carno nvarchar(20),
		miles float,
		cmiles nvarchar(20),
		mount float,
		cmount nvarchar(20),
		rate float,
		crate nvarchar(20),
		memo nvarchar(max)
	)
	declare cursor_table cursor for
	select a.carno,SUM(a.miles) miles,SUM(a.mount) mount
	from(
		select carno,SUM(miles) miles,0 mount from @tmp1 group by carno
		union all
		select carno,0,SUM(mount) from @tmp2 group by carno)as a
	group by carno
	open cursor_table
	fetch next from cursor_table
	into @carno,@miles,@mount
	while(@@FETCH_STATUS <> -1)
	begin
		set @cmd=''
		
		declare cursor_table2 cursor for
		select driver
		from(select driver from @tmp1 where carno=@carno
			union all
			select driver from @tmp2 where carno=@carno)as a
		group by driver
		open cursor_table2
		fetch next from cursor_table2
		into @driver
		while(@@FETCH_STATUS <> -1)
		begin
			set @cmd = @cmd +SPACE(2)+@driver
			fetch next from cursor_table2
			into @driver
		end
		close cursor_table2
		deallocate cursor_table2
		
		set @rate = case when @mount>0 then round(@miles/@mount,3) else 0 end
		insert into @tmp (carno,miles,mount,rate,memo)values(@carno,@miles,@mount,@rate,ltrim(@cmd))
		
		fetch next from cursor_table
		into @carno,@miles,@mount
	end
	close cursor_table
	deallocate cursor_table
	
	update @tmp set cmiles=reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,miles),1)),4,12)),
						cmount=reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,mount),1)),4,12)),
						crate=convert(nvarchar(15),CONVERT(money,rate),1)
	if len(@t_bdate)>0
		set  @cmd  =  '統計日期：'+@t_bdate+'～'+@t_edate
	else
		set  @cmd  =  '交運日期：'+@t_btrandate+'～'+@t_etrandate
	select @cmd titlea , '0' gno,* from @tmp order by carno
	drop table #carkind
	drop table #carteam
	drop table #calctype;


z_tran08:--z_tran08
	SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	declare @t_accy nvarchar(10)
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_btrandate nvarchar(10)
	declare @t_etrandate nvarchar(10)
	declare @t_bcustno nvarchar(20)
	declare @t_ecustno nvarchar(20)
	declare @t_bdriverno nvarchar(20)
	declare @t_edriverno nvarchar(20)
	declare @t_carno nvarchar(20)
	declare @t_po nvarchar(20)
	declare @t_baddr nvarchar(20)
	declare @t_eaddr nvarchar(20)
	declare @t_cno nvarchar(20)
	declare @t_option1  nvarchar(max)
	declare @t_option2  nvarchar(max)
	declare @t_option3  nvarchar(max)
	declare @t_carteam  nvarchar(max)
	declare @t_carkind  nvarchar(max)
	declare @t_calctype  nvarchar(max)
	declare @z_product  nvarchar(max)
	declare @z_addr  nvarchar(max)
	declare @z_boatname nvarchar(max)
	declare @z_delivery  nvarchar(max)
	declare @z_plusmoney  nvarchar(max)
	declare @z_minusmoney  nvarchar(max)
	declare @t_sort08  nvarchar(max)
	
	set @t_accy = '[1]'
	set @t_bdate = case when '#non'=[2] then '' else [2] end
	set @t_edate = case when '#non'=[3] then CHAR(255) else [3] end
	set @t_btrandate = case when '#non'=[4] then '' else [4] end
	set @t_etrandate = case when '#non'=[5] then CHAR(255) else [5] end
	set @t_bcustno = case when '#non'=[6] then '' else [6] end
	set @t_ecustno = case when '#non'=[7] then CHAR(255) else [7] end
	set @t_bdriverno = case when '#non'=[8] then '' else [8] end
	set @t_edriverno = case when '#non'=[9] then CHAR(255) else [9] end
	set @t_carno = case when '#non'=[10] then '' else [10] end
	set @t_po = case when '#non'=[11] then '' else [11] end
	set @t_baddr = case when '#non'=[12] then '' else [12] end
	set @t_eaddr = case when '#non'=[13] then CHAR(255) else [13] end
	set @t_cno = case when '#non'=[14] then '' else [14] end
	set @t_option1  = case when '#non'=[15] then '' else [15] end
	set @t_option2  = case when '#non'=[16] then '' else [16] end
	set @t_option3  = case when '#non'=[17] then '' else [17] end
	set @t_carteam  = case when '#non'=[18] then '' else [18] end
	set @t_carkind  = case when '#non'=[19] then '' else [19] end
	set @t_calctype = case when '#non'=[20] then '' else [20] end
	set @z_product = case when '#non'=[21] then '' else [21] end
	set @z_addr = case when '#non'=[22] then '' else [22] end
	set @z_boatname = case when '#non'=[23] then '' else [23] end
	set @z_delivery  = case when '#non'=[24] then '' else [24] end
	set @z_plusmoney  = case when '#non'=[25] then '' else [25] end
	set @z_minusmoney  = case when '#non'=[26] then '' else [26] end
	set @t_sort08  = case when '#non'=[27] then '' else [27] end
	----------------------------------------------------------------------------------------------
	declare @minN int
	declare @string nvarchar(max)
	declare @n int
	declare @carno nvarchar(20)
	declare @datea nvarchar(10)
	declare @carkindno  nvarchar(20)
	declare @carkind	nvarchar(20)
	declare @miles float
	declare @tranmoney float
	declare @drivermoney float
	declare @reserve float 
	declare @mount float 
	declare @money float 
	declare @unit nvarchar(20)
	declare @custno nvarchar(20)
	declare @comp  nvarchar(max)
	declare @carteamno nvarchar(20)
	declare @team  nvarchar(20)
	declare @po nvarchar(20)
	declare @trandono nvarchar(20)
	declare @noa nvarchar(20)
	declare @acomp nvarchar(max)
	declare @mount2 float
	declare @mount3 float
	declare @serial nvarchar(20)
	declare @tel nvarchar(20)
	declare @money2 float
	declare @money3 float
	----------------------------------------------------------------------------------------------
	--解析要計算的種類
	IF OBJECT_ID('tempdb..#carkind')is not null
	BEGIN
		set @cmd = 'drop table #carkind'
		EXECUTE sp_executesql @cmd
	END
	create table #carkind(
		noa nvarchar(20)
	)
	set @string = @t_carkind
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #carkind select @string
			end
			break
		end
		insert into #carkind select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	IF OBJECT_ID('tempdb..#carteam')is not null
	BEGIN
		set @cmd = 'drop table #carteam'
		EXECUTE sp_executesql @cmd
	END
	create table #carteam(
		noa nvarchar(20)
	)
	set @string = @t_carteam
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #carteam select @string
			end
			break
		end
		insert into #carteam select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	IF OBJECT_ID('tempdb..#calctype')is not null
	BEGIN
		set @cmd = 'drop table #calctype'
		EXECUTE sp_executesql @cmd
	END
	create table #calctype(
		noa nvarchar(20)
	)
	set @string = @t_calctype
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #calctype select @string
			end
			break
		end
		insert into #calctype select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	----------------------------------------------------------------------------------------------
	IF OBJECT_ID('tempdb..#z_tran08')is not null
	BEGIN
		set @cmd = 'drop table #z_tran08'
		EXECUTE sp_executesql @cmd
	END
	create table  #z_tran08(
			gno nvarchar(1),
			pno nvarchar(1),
			acomp nvarchar(50),
			noa nvarchar(20),
			datea nvarchar(20),
			trandate nvarchar(20),
			po nvarchar(20),
			custno nvarchar(20),
			comp nvarchar(50),
			custorde nvarchar(30),
			newcustorde nvarchar(30),
			serial nvarchar(20),
			tel nvarchar(20),
			straddr nvarchar(20),
			product nvarchar(20),
			mount decimal(18,3),
			price decimal(18,3),
			total decimal(18,3),
			carno nvarchar(20),
			isoutside int,
			caseno nvarchar(20),
			driverno nvarchar(20),
			carteamno nvarchar(20),
			calctype nvarchar(20),
			mount2 float,--公司車
			mount3 float,--外車
			total2 float,--公司車
			total3 float,--外車
			times int--車次
	)
	create index noa on #z_tran08(noa)
	set @cmd = 
		"select '0' gno,'0' pno,(@t_cno+'【請款明細表】'),a.noa,a.datea,a.trandate,a.po,a.custno,isnull(f.comp,''),a.custorde,'',isnull(f.serial,''),left(isnull(f.tel,''),20),a.straddr,a.product,"+
		"a.mount,a.price,a.total,a.carno,isnull(e.isoutside,''),a.caseno,a.driverno,a.carteamno,a.calctype,0,0,0,0,0"+
		" from  trans"+@t_accy+"  a "+
		" left join #carteam  b on a.carteamno=b.noa"+	
		" left join #calctype c on a.calctype=c.noa"+
		" left join carteam  d on a.carteamno=d.noa"+	
		" left join calctypes e on a.calctype=e.noa+e.noq"+
		" left join cust f on f.noa = a.custno "+
		" where "+
		"(isnull(a.datea,'') between @t_bdate and @t_edate) and "+
		"(isnull(a.trandate,'') between @t_btrandate and @t_etrandate) and "+
		"(isnull(a.custno,'') between @t_bcustno and @t_ecustno) and" +
		"(isnull(a.driverno,'') between @t_bdriverno and @t_edriverno) and"+
		"(len(@t_carno) = 0 or a.carno = @t_carno) and"+
		"(len(@t_po)=0 or a.po = @t_po) and"+
		"(a.straddrno between @t_baddr and @t_eaddr) and"+
		" (b.noa  is  not  null) and (c.noa  is  not  null)"
	insert into #z_tran08
	execute sp_executesql @cmd,N'@t_cno  nvarchar(50),@t_bdate nvarchar(10),@t_edate nvarchar(10),@t_bcustno nvarchar(20),@t_ecustno nvarchar(20),@t_bdriverno  nvarchar(20),@t_edriverno  nvarchar(20),@t_carno  nvarchar(20),@t_po  nvarchar(20),@t_baddr nvarchar(20),@t_eaddr nvarchar(20),@t_btrandate nvarchar(10),@t_etrandate nvarchar(10)',
		@t_cno=@t_cno,@t_bdate=@t_bdate,@t_edate=@t_edate,@t_bcustno=@t_bcustno,@t_ecustno=@t_ecustno,@t_bdriverno=@t_bdriverno,@t_edriverno=@t_edriverno,@t_carno=@t_carno,@t_po=@t_po,@t_baddr=@t_baddr,@t_eaddr=@t_eaddr,@t_btrandate=@t_btrandate,@t_etrandate=@t_etrandate
	
	declare cursor_table cursor for
	select noa,custorde from #z_tran08
	open cursor_table
	fetch next from cursor_table
	into @noa,@string
	while(@@FETCH_STATUS <> -1)
	begin
		set @n = PATINDEX('%[0-9]%',@string)
		if(@n>1)
		begin
			set @string = substring(@string,@n,len(@string)-@n+1)+LEFT(@string,@n-1)
		end
		update #z_tran08 set newcustorde=@string where  noa=@noa
		
		fetch next from cursor_table
		into @noa,@string
	end
	close cursor_table
	deallocate cursor_table
	
	declare cursor_table cursor for
	select acomp,custno,comp,serial,tel,count(1) n,sum(mount),sum(total) from #z_tran08 group by acomp,custno,comp,serial,tel
	open cursor_table
	fetch next from cursor_table
	into @acomp,@custno,@comp,@serial,@tel,@n,@mount,@money
	while(@@FETCH_STATUS <> -1)
	begin
		select @mount2=0,@mount3=0,@money2=0,@money3=0
		select @mount2=isnull(SUM(isnull(mount,0)),0),@money2=isnull(sum(isnull(total,0)),0) from  #z_tran08  a
		left join calctypes b on a.calctype=b.noa+b.noq
		where  a.custno=@custno  and  not((b.noa+b.noq)is null) and b.isoutside!=1
		select @mount3=isnull(SUM(isnull(mount,0)),0),@money3=isnull(sum(isnull(total,0)),0) from  #z_tran08  a
		left join calctypes b on a.calctype=b.noa+b.noq
		where  a.custno=@custno  and  not((b.noa+b.noq)is null) and  b.isoutside=1

		insert into #z_tran08(gno,pno,acomp,custno,comp,serial,tel,mount,total,times,mount2,total2,mount3,total3)values('1','x',@acomp,@custno,@comp,@serial,@tel,@mount,@money,@n,@mount2,@money2,@mount3,@money3)
		set @n=(@n+2)%@minN
		while(@n!=0 and @n<@minN)
		begin
			insert into #z_tran08(gno,pno,acomp,custno,comp,serial,tel)values('0','y',@acomp,@custno,@comp,@serial,@tel)
			set @n = @n+1
		end
		insert into #z_tran08(gno,pno,acomp,custno,comp,serial,tel)values('2','z',@acomp,@custno,@comp,@serial,@tel)
		fetch next from cursor_table
		into @acomp,@custno,@comp,@serial,@tel,@n,@mount,@money
	end
	close cursor_table
	deallocate cursor_table
	
	declare @h1  char(104)
	declare @h2  char(104)
	set @h1=" 日   期 "+space(1)+" 起  迄  點 "+space(1)+" 品    名 "+SPACE(1)+" 數    量 "+SPACE(1)
			+" 單    價 "+SPACE(1)+" 金    額 "+SPACE(1)+" 車  號 "+SPACE(1)+" 憑 單 號 碼 "+SPACE(1)+" 貨 櫃 號 碼 "
	set @h2=REPLICATE('=',9)+SPACE(1)+REPLICATE('=',12)+SPACE(1)+REPLICATE('=',10)+SPACE(1)+REPLICATE('=',10)+SPACE(1) 
		+REPLICATE('=',10)+SPACE(1) +REPLICATE('=',10)+SPACE(1)+REPLICATE('=',8)+SPACE(1)+REPLICATE('=',13)+SPACE(1)+REPLICATE('=',13)+SPACE(1)  
	declare @tmp table(
		gno nvarchar(3),
		pno nvarchar(3),
		acomp nvarchar(50),
		custno  nvarchar(20),
		newcustorde  nvarchar(30),
		comp  nvarchar(50),
		serial nvarchar(20),
		tel nvarchar(20),
		po nvarchar(20),
		times int,
		h1 char(1000),
		h2 char(1000),
		memo char(1000),
		t1 char(1000),
		t2 char(1000),
		t3 char(1000)
	)
	set @cmd="select gno,pno,acomp,custno,newcustorde,comp,serial,tel,isnull(po,'')"+
	",times"+
	",@h1,@h2,("+
	"cast(isnull(trandate,'') as char(9))+space(1)+cast(isnull(straddr,'') as char(12))+space(1)+cast(isnull(product,'') as char(10))"+
	"+space(1)+right(space(10)+(reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,floor(mount)),1)),4,12))+left(right(convert(nvarchar,cast(mount  as  money),2),5),4)),10)"+
	"+space(1)+right(space(10)+(reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,floor(price)),1)),4,12))+left(right(convert(nvarchar,cast(price  as  money),2),5),4)),10)"+
	"+space(1)+right(space(10)+reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total),1)),4,12)),10)"+
	"+space(1)+cast(isnull(carno,'') as char(8))"+
	"+space(1)+cast(isnull(custorde,'') as char(13))"+
	"+space(1)+cast(isnull(caseno,'') as char(13))"+
	") memo"+
	",(space(25)+'合  計：'"+
	"+space(1)+right(space(10)+(reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,floor(mount)),1)),4,12))+left(right(convert(nvarchar,cast(mount  as  money),2),5),4)),10)"+
	"+space(12)+right(space(10)+reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total),1)),4,12)),10)"+
	")"+
	",(space(25)+'公司車：'"+
	"+space(1)+right(space(10)+(reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,floor(mount2)),1)),4,12))+left(right(convert(nvarchar,cast(mount2  as  money),2),5),4)),10)"+
	"+space(12)+right(space(10)+reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total2),1)),4,12)),10)"+
	")"+
	",(space(25)+'外  車：'"+
	"+space(1)+right(space(10)+(reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,floor(mount3)),1)),4,12))+left(right(convert(nvarchar,cast(mount3  as  money),2),5),4)),10)"+
	"+space(12)+right(space(10)+reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total3),1)),4,12)),10)"+
	")"+
	"  from  #z_tran08  order  by  custno,pno,gno,"+(case when @t_sort08='custorde' then 'newcustorde' else @t_sort08 end)+",noa"
	insert into @tmp
	execute sp_executesql @cmd,N'@h1 nvarchar(max),@h2 nvarchar(max)',@h1=@h1,@h2=@h2
	update @tmp set h1=REPLACE(h1,SPACE(1),'&nbsp'+char(59))
	,h2=REPLACE(h2,SPACE(1),'&nbsp'+char(59))
	,memo=REPLACE(memo,SPACE(1),'&nbsp'+char(59))
	,t1=REPLACE(t1,SPACE(1),'&nbsp'+char(59))
	,t2=REPLACE(t2,SPACE(1),'&nbsp'+char(59))
	,t3=REPLACE(t3,SPACE(1),'&nbsp'+char(59))
	
	if len(@t_bdate)>0
		set  @cmd  =  '統計日期：'+@t_bdate+'～'+@t_edate
	else
		set  @cmd  =  '交運日期：'+@t_btrandate+'～'+@t_etrandate
	select @cmd titlea ,* from @tmp
	-------------------------------------------------------------------------------------------------------------------
	drop table #z_tran08
	drop table #carkind
	drop table #carteam
	drop table #calctype;

z_tran07:--z_tran07
	SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	declare @t_accy nvarchar(10)
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_btrandate nvarchar(10)
	declare @t_etrandate nvarchar(10)
	declare @t_bcustno nvarchar(20)
	declare @t_ecustno nvarchar(20)
	declare @t_bdriverno nvarchar(20)
	declare @t_edriverno nvarchar(20)
	declare @t_carno nvarchar(20)
	declare @t_po nvarchar(20)
	declare @t_baddr nvarchar(20)
	declare @t_eaddr nvarchar(20)
	declare @t_cno nvarchar(20)
	declare @t_option1  nvarchar(max)
	declare @t_option2  nvarchar(max)
	declare @t_option3  nvarchar(max)
	declare @t_carteam  nvarchar(max)
	declare @t_carkind  nvarchar(max)
	declare @t_calctype  nvarchar(max)
	declare @z_product  nvarchar(max)
	declare @z_addr  nvarchar(max)
	declare @z_boatname nvarchar(max)
	declare @z_delivery  nvarchar(max)
	declare @z_plusmoney  nvarchar(max)
	declare @z_minusmoney  nvarchar(max)
	
	set @t_accy = '[1]'
	set @t_bdate = case when '#non'=[2] then '' else [2] end
	set @t_edate = case when '#non'=[3] then CHAR(255) else [3] end
	set @t_btrandate = case when '#non'=[4] then '' else [4] end
	set @t_etrandate = case when '#non'=[5] then CHAR(255) else [5] end
	set @t_bcustno = case when '#non'=[6] then '' else [6] end
	set @t_ecustno = case when '#non'=[7] then CHAR(255) else [7] end
	set @t_bdriverno = case when '#non'=[8] then '' else [8] end
	set @t_edriverno = case when '#non'=[9] then CHAR(255) else [9] end
	set @t_carno = case when '#non'=[10] then '' else [10] end
	set @t_po = case when '#non'=[11] then '' else [11] end
	set @t_baddr = case when '#non'=[12] then '' else [12] end
	set @t_eaddr = case when '#non'=[13] then CHAR(255) else [13] end
	set @t_cno = case when '#non'=[14] then '' else [14] end
	set @t_option1  = case when '#non'=[15] then '' else [15] end
	set @t_option2  = case when '#non'=[16] then '' else [16] end
	set @t_option3  = case when '#non'=[17] then '' else [17] end
	set @t_carteam  = case when '#non'=[18] then '' else [18] end
	set @t_carkind  = case when '#non'=[19] then '' else [19] end
	set @t_calctype = case when '#non'=[20] then '' else [20] end
	set @z_product = case when '#non'=[21] then '' else [21] end
	set @z_addr = case when '#non'=[22] then '' else [22] end
	set @z_boatname = case when '#non'=[23] then '' else [23] end
	set @z_delivery  = case when '#non'=[24] then '' else [24] end
	set @z_plusmoney  = case when '#non'=[25] then '' else [25] end
	set @z_minusmoney  = case when '#non'=[26] then '' else [26] end
	----------------------------------------------------------------------------------------------
	----------------------------------------------------------------------------------------------
	declare @minN int
	declare @string nvarchar(max)
	declare @n int
	declare @carno nvarchar(20)
	declare @datea nvarchar(10)
	declare @carkindno  nvarchar(20)
	declare @carkind	nvarchar(20)
	declare @miles float
	declare @tranmoney float
	declare @drivermoney float
	declare @reserve float 
	declare @mount float 
	declare @money float 
	declare @unit nvarchar(20)
	declare @custno nvarchar(20)
	declare @comp  nvarchar(max)
	declare @carteamno nvarchar(20)
	declare @team  nvarchar(20)
	declare @po nvarchar(20)
	declare @trandono nvarchar(20)
	----------------------------------------------------------------------------------------------
	--解析要計算的種類
	IF OBJECT_ID('tempdb..#carkind')is not null
	BEGIN
		set @cmd = 'drop table #carkind'
		EXECUTE sp_executesql @cmd
	END
	create table #carkind(
		noa nvarchar(20)
	)
	set @string = @t_carkind
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #carkind select @string
			end
			break
		end
		insert into #carkind select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	IF OBJECT_ID('tempdb..#carteam')is not null
	BEGIN
		set @cmd = 'drop table #carteam'
		EXECUTE sp_executesql @cmd
	END
	create table #carteam(
		noa nvarchar(20)
	)
	set @string = @t_carteam
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #carteam select @string
			end
			break
		end
		insert into #carteam select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	IF OBJECT_ID('tempdb..#calctype')is not null
	BEGIN
		set @cmd = 'drop table #calctype'
		EXECUTE sp_executesql @cmd
	END
	create table #calctype(
		noa nvarchar(20)
	)
	set @string = @t_calctype
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #calctype select @string
			end
			break
		end
		insert into #calctype select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	----------------------------------------------------------------------------------------------
	IF OBJECT_ID('tempdb..#z_tran07')is not null
	BEGIN
		set @cmd = 'drop table #z_tran07'
		EXECUTE sp_executesql @cmd
	END
	create table  #z_tran07(
		gno nvarchar(3),
		p nvarchar(3),
		acomp  nvarchar(50),
		custno nvarchar(20),
		comp nvarchar(40),
		memo varchar(1000),
		noa nvarchar(20),
		trandate char(9),
		custorde char(30),
		caseno char(20),
		[money] float,
		cmoney char(7),
		po char(16),
		product char(12),
		addr char(23),
		boatname char(24),
		trandono nvarchar(20)
	)
	declare @h1 varchar(120)
	declare @h2 varchar(120)
	declare @h3 varchar(120)
	set @h1 = SPACE(1)+'運輸日期'+SPACE(1)+'憑單號碼'+SPACE(3)+'貨櫃號碼'+SPACE(5)+'金'+SPACE(3)+'額'+SPACE(1)+
			'P/O號碼'+SPACE(10)+'貨品名稱'+SPACE(5)+'起訖地點'+SPACE(16)+'船名'+SPACE(18)
	set @h2 = REPLICATE('=',9)+SPACE(1)+REPLICATE('=',10)+SPACE(1)+REPLICATE('=',12)+SPACE(1)+REPLICATE('=',7)+SPACE(1)+
			REPLICATE('=',16)+SPACE(1)++REPLICATE('=',12)+SPACE(1)++REPLICATE('=',23)+SPACE(1)++REPLICATE('=',24)
	set @h3 = REPLICATE('-',120)
	
	set @cmd= 
	" select '0','2','',a.custno,e.comp,'',a.noa,a.trandate,left(convert(char(30),a.custorde ),10),left(convert(char(30),a.caseno ),16)"+
	" ,total,reverse(substring(reverse(convert(nvarchar(10),CONVERT(money,a.total),1)),4,7))"+
	" ,a.po"+
	" ,case when g.noa is null then a.product else f.product end"+
	" ,case when g.noa is null then a.straddr else f.addr end"+
	" ,case when g.noa is null then a.boatname else g.boatname end"+
	" ,isnull(g.deliveryno,'')"+
	" from trans"+@t_accy+" a"+
	" left join #calctype b on a.calctype=b.noa"+
	" left join calctype c on left(a.calctype,1)=c.noa"+
	" left join #carteam d on a.carteamno=d.noa"+
	" left join cust e on a.custno=e.noa"+
	" left join trandos f on a.noa=f.tranno  and  a.noq=f.trannoq"+
	" left join trando g on f.noa=g.noa"+
	" where a.calctype=b.noa  and  a.carteamno=d.noa "+
	"	and (len(@t_carno)=0 or a.carno=@t_carno)"+
	"	and (a.datea between @t_bdate and @t_edate)"+
	"	and (a.trandate between @t_btrandate and @t_etrandate)"+
	"	and (a.custno between @t_bcustno and @t_ecustno)"+
	"	and (a.driverno between @t_bdriverno and @t_edriverno)"+
	"	and (len(@t_po)=0 or a.po=@t_po) and len(a.po)>0"+
	"   and (a.straddrno between @t_baddr and @t_eaddr)"+
	" and (len(@z_delivery)=0 or g.deliveryno=@z_delivery)"
	insert into #z_tran07
	EXECUTE sp_executesql @cmd,N'@t_btrandate nvarchar(10),@t_etrandate nvarchar(10),@z_delivery nvarchar(30),@t_baddr nvarchar(20),@t_eaddr nvarchar(20),@t_bdate nvarchar(10),@t_edate nvarchar(10),@t_bdriverno nvarchar(20),@t_edriverno nvarchar(20),@t_carno nvarchar(20),@t_bcustno nvarchar(20),@t_ecustno nvarchar(20),@t_po nvarchar(30)',
	@t_btrandate=@t_btrandate,@t_etrandate=@t_etrandate,@z_delivery=@z_delivery,@t_baddr=@t_baddr,@t_eaddr=@t_eaddr,@t_bdate=@t_bdate,@t_edate=@t_edate,@t_bdriverno=@t_bdriverno,@t_edriverno=@t_edriverno,@t_carno=@t_carno,@t_bcustno=@t_bcustno,@t_ecustno=@t_ecustno,@t_po=@t_po

	set @cmd="update #z_tran07 set memo=isnull(trandate,space(9))+SPACE(1)+isnull(left(custorde,10),space(10))+SPACE(1)+isnull(left(caseno,12),space(12))+SPACE(1)+isnull(right(space(7)+rtrim(cmoney),7),space(7))+SPACE(1)+isnull(po,space(16))+SPACE(1)+"
	if len(@z_product)=0
	set @cmd = @cmd + "isnull(product,space(12))+SPACE(1)+"
	else
	set @cmd = @cmd + "convert(char(12),isnull(@z_product,space(12)))+SPACE(1)+"
	if LEN(@z_addr)=0
	set @cmd = @cmd + "isnull(addr,space(23))+SPACE(1)+"	
	else
	set @cmd = @cmd + "convert(char(23),isnull(@z_addr,space(23)))+SPACE(1)+"
	if LEN(@z_boatname)=0
	set @cmd = @cmd + "isnull(boatname,space(24))"
	else
	set @cmd = @cmd + "convert(char(24),isnull(@z_boatname,space(24)))"
	EXECUTE sp_executesql  @cmd,N'@z_product nvarchar(max),@z_addr nvarchar(max),@z_boatname nvarchar(max)',
	@z_product=@z_product,@z_addr=@z_addr,@z_boatname=@z_boatname
	
	declare cursor_table cursor for
	select custno,comp,po,trandono,count(1),sum(isnull([money],0))
	from #z_tran07 group by custno,comp,po,trandono
	open cursor_table
	fetch next from cursor_table
	into @custno,@comp,@po,@trandono,@mount,@money
	while(@@FETCH_STATUS <> -1)
	begin
		insert into #z_tran07(gno,p,custno,comp,po,trandono,memo)values('0','0',@custno,@comp,@po,@trandono,@h1)
		insert into #z_tran07(gno,p,custno,comp,po,trandono,memo)values('0','1',@custno,@comp,@po,@trandono,@h2)
		insert into #z_tran07(gno,p,custno,po,trandono,memo)values('0','3',@custno,@po,@trandono,@h3)
		insert into #z_tran07(gno,p,custno,po,trandono,memo)values('0','4',@custno,@po,@trandono,'共'+right(space(5)+rtrim(CONVERT(char(5),@mount)),5)+' 只'+SPACE(11)+'合計金額：'+reverse(substring(reverse(convert(char(13),CONVERT(money,@money),1)),4,10)))
		insert into #z_tran07(gno,custno,po,trandono)values('1',@custno,@po,@trandono)
		fetch next from cursor_table
		into @custno,@comp,@po,@trandono,@mount,@money
	end
	close cursor_table
	deallocate cursor_table
	
	update  #z_tran07  set acomp=rtrim(@t_cno)+'【請款明細表】',  memo=REPLACE(memo,SPACE(1),'&nbsp'+char(59))
	
	if len(@t_bdate)>0
		set  @cmd  =  '統計日期：'+@t_bdate+'～'+@t_edate
	else
		set  @cmd  =  '交運日期：'+@t_btrandate+'～'+@t_etrandate
	select @cmd titlea,* from #z_tran07 order by custno,po,trandono,gno,p,noa
	-------------------------------------------------------------------------------------------------------------------
	drop table #z_tran07
	drop table #carkind
	drop table #carteam
	drop table #calctype;

z_tran06:--z_tran06
	SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	declare @t_accy nvarchar(10)
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_btrandate nvarchar(10)
	declare @t_etrandate nvarchar(10)
	declare @t_bcustno nvarchar(20)
	declare @t_ecustno nvarchar(20)
	declare @t_bdriverno nvarchar(20)
	declare @t_edriverno nvarchar(20)
	declare @t_carno nvarchar(20)
	declare @t_po nvarchar(20)
	declare @t_baddr nvarchar(20)
	declare @t_eaddr nvarchar(20)
	declare @t_cno nvarchar(20)
	declare @t_option1  nvarchar(max)
	declare @t_option2  nvarchar(max)
	declare @t_option3  nvarchar(max)
	declare @t_carteam  nvarchar(max)
	declare @t_carkind  nvarchar(max)
	declare @t_calctype  nvarchar(max)
	declare @z_product  nvarchar(max)
	declare @z_addr  nvarchar(max)
	declare @z_boatname nvarchar(max)
	declare @z_delivery  nvarchar(max)
	declare @z_plusmoney  nvarchar(max)
	declare @z_minusmoney  nvarchar(max)
	
	set @t_accy = '[1]'
	set @t_bdate = case when '#non'=[2] then '' else [2] end
	set @t_edate = case when '#non'=[3] then CHAR(255) else [3] end
	set @t_btrandate = case when '#non'=[4] then '' else [4] end
	set @t_etrandate = case when '#non'=[5] then CHAR(255) else [5] end
	set @t_bcustno = case when '#non'=[6] then '' else [6] end
	set @t_ecustno = case when '#non'=[7] then CHAR(255) else [7] end
	set @t_bdriverno = case when '#non'=[8] then '' else [8] end
	set @t_edriverno = case when '#non'=[9] then CHAR(255) else [9] end
	set @t_carno = case when '#non'=[10] then '' else [10] end
	set @t_po = case when '#non'=[11] then '' else [11] end
	set @t_baddr = case when '#non'=[12] then '' else [12] end
	set @t_eaddr = case when '#non'=[13] then CHAR(255) else [13] end
	set @t_cno = case when '#non'=[14] then '' else [14] end
	set @t_option1  = case when '#non'=[15] then '' else [15] end
	set @t_option2  = case when '#non'=[16] then '' else [16] end
	set @t_option3  = case when '#non'=[17] then '' else [17] end
	set @t_carteam  = case when '#non'=[18] then '' else [18] end
	set @t_carkind  = case when '#non'=[19] then '' else [19] end
	set @t_calctype = case when '#non'=[20] then '' else [20] end
	set @z_product = case when '#non'=[21] then '' else [21] end
	set @z_addr = case when '#non'=[22] then '' else [22] end
	set @z_boatname = case when '#non'=[23] then '' else [23] end
	set @z_delivery  = case when '#non'=[24] then '' else [24] end
	set @z_plusmoney  = case when '#non'=[25] then '' else [25] end
	set @z_minusmoney  = case when '#non'=[26] then '' else [26] end
	----------------------------------------------------------------------------------------------
	----------------------------------------------------------------------------------------------
	declare @minN int
	declare @string nvarchar(max)
	declare @n int
	declare @carno nvarchar(20)
	declare @datea nvarchar(10)
	declare @carkindno  nvarchar(20)
	declare @carkind	nvarchar(20)
	declare @miles float
	declare @tranmoney float
	declare @drivermoney float
	declare @reserve float 
	declare @mount float 
	declare @money float 
	declare @unit nvarchar(20)
	declare @custno nvarchar(20)
	declare @comp  nvarchar(max)
	declare @carteamno nvarchar(20)
	declare @team  nvarchar(20)
	----------------------------------------------------------------------------------------------
	--解析要計算的種類
	IF OBJECT_ID('tempdb..#carkind')is not null
	BEGIN
		set @cmd = 'drop table #carkind'
		EXECUTE sp_executesql @cmd
	END
	create table #carkind(
		noa nvarchar(20)
	)
	set @string = @t_carkind
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #carkind select @string
			end
			break
		end
		insert into #carkind select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	IF OBJECT_ID('tempdb..#carteam')is not null
	BEGIN
		set @cmd = 'drop table #carteam'
		EXECUTE sp_executesql @cmd
	END
	create table #carteam(
		noa nvarchar(20)
	)
	set @string = @t_carteam
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #carteam select @string
			end
			break
		end
		insert into #carteam select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	IF OBJECT_ID('tempdb..#calctype')is not null
	BEGIN
		set @cmd = 'drop table #calctype'
		EXECUTE sp_executesql @cmd
	END
	create table #calctype(
		noa nvarchar(20)
	)
	set @string = @t_calctype
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #calctype select @string
			end
			break
		end
		insert into #calctype select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	----------------------------------------------------------------------------------------------
	--記錄欄位
	declare @gkey  nvarchar(max)
	declare @gname  nvarchar(max)
	declare @fieldA nvarchar(max)
	declare @fieldB nvarchar(max)
	declare @fieldC nvarchar(max)
	declare @fieldD nvarchar(max)
	declare @result nvarchar(max)
	
	declare @field table(
		noa  nvarchar(20),
		team nvarchar(20),
		unit  nvarchar(20),
		field_mount_header nvarchar(10),
		field_mount nvarchar(10),
		field_money_header nvarchar(10),
		field_money nvarchar(10)
	)
	-------------------------------------------------------------------------------------------------------------
	set @minN=4
	-------------------------------------------------------------------------------------------------------------
	--暫存資料
	IF OBJECT_ID('tempdb..#z_tran06')is not null
	BEGIN
		set @cmd = 'drop table #z_tran06'
		EXECUTE sp_executesql @cmd
	END
	create table #z_tran06(
		gno nvarchar(3),
		custno nvarchar(20),
		comp nvarchar(40),
		primary key(custno,gno)
	)
	-------------------------------------------------------------------------------------------------------------
	
	-------------------------------------------------------------------------------------------------------------
	--出車單:客戶金額
	select @n= COUNT(1) from @field

	declare cursor_table cursor for
	select a.noa,a.team,a.unit from carteam a
	left join carteam b on a.noa=b.noa
	left join #carteam c on b.noa=c.noa
	where b.noa=c.noa
	group by a.noa,a.team,a.unit
	open cursor_table
	fetch next from cursor_table
	into @gkey,@gname,@unit
	while(@@FETCH_STATUS <> -1)
	begin
		set @n = @n + 1
		insert into @field
		select @gkey,@gname,@unit,
				"a"+right("00"+CONVERT(nvarchar(10),@n),3),
				"b"+right("00"+CONVERT(nvarchar(10),@n),3),
				"c"+right("00"+CONVERT(nvarchar(10),@n),3),
				"d"+right("00"+CONVERT(nvarchar(10),@n),3)
		set @cmd = "alter table #z_tran06 add a"+right("00"+CONVERT(nvarchar(10),@n),3)+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_tran06 add b"+right("00"+CONVERT(nvarchar(10),@n),3)+" float"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_tran06 add cb"+right("00"+CONVERT(nvarchar(10),@n),3)+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_tran06 add c"+right("00"+CONVERT(nvarchar(10),@n),3)+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_tran06 add d"+right("00"+CONVERT(nvarchar(10),@n),3)+" float"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_tran06 add cd"+right("00"+CONVERT(nvarchar(10),@n),3)+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		fetch next from cursor_table
		into @gkey,@gname,@unit
	end
	close cursor_table
	deallocate cursor_table
	
	select @n= COUNT(1) from @field
	while(@n<@minN)
	begin
		set  @n = @n +  1
		insert into @field
		select null,null,null,
				"a"+right("00"+CONVERT(nvarchar(10),@n),3),
				"b"+right("00"+CONVERT(nvarchar(10),@n),3),
				"c"+right("00"+CONVERT(nvarchar(10),@n),3),
				"d"+right("00"+CONVERT(nvarchar(10),@n),3)
		set @cmd = "alter table #z_tran06 add a"+right("00"+CONVERT(nvarchar(10),@n),3)+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_tran06 add b"+right("00"+CONVERT(nvarchar(10),@n),3)+" float"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_tran06 add cb"+right("00"+CONVERT(nvarchar(10),@n),3)+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_tran06 add c"+right("00"+CONVERT(nvarchar(10),@n),3)+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_tran06 add d"+right("00"+CONVERT(nvarchar(10),@n),3)+" float"
		EXECUTE sp_executesql @cmd
		set @cmd = "alter table #z_tran06 add cd"+right("00"+CONVERT(nvarchar(10),@n),3)+" nvarchar(20)"
		EXECUTE sp_executesql @cmd
	end
	--------------------------------------------------------------------------------------------------------------------
	declare @tmp1 table(
		custno nvarchar(20),
		carteamno nvarchar(10),
		mount float,
		[money] float
	)

	set @cmd =" select a.custno,a.carteamno,"
	if  @t_option1='收金額'
		set  @cmd  =  @cmd  +  "sum(a.mount), sum(round(a.mount*a.price,0)) money"
	else
		set  @cmd  =  @cmd  +  "sum(a.mount2), sum(round(a.mount2*(a.price2+a.price3),0)) money"
	set @cmd =	@cmd  +
		" from trans"+@t_accy+" a"+
		" left join #calctype b on a.calctype=b.noa"+
		" left join calctype c on left(a.calctype,1)=c.noa"+
		" left join #carteam d on a.carteamno=d.noa"+
		" where a.calctype=b.noa  and  a.carteamno=d.noa"+
		" and (len(@t_carno)=0 or a.carno=@t_carno)"+
		" and (a.datea between @t_bdate and @t_edate)"+
		" and (a.trandate between @t_btrandate and @t_etrandate)"+
		" and (a.custno between @t_bcustno and @t_ecustno)"+
		" and (a.driverno between @t_bdriverno and @t_edriverno)"+
		" and (a.straddrno between @t_baddr and @t_eaddr)"+
		" and (len(@t_po)=0 or a.po=@t_po)"+
		" group by a.custno,a.carteamno"
	insert into @tmp1
	execute sp_executesql @cmd,N'@t_bdate nvarchar(10),@t_edate nvarchar(10),@t_btrandate nvarchar(10),@t_etrandate nvarchar(10),@t_bcustno nvarchar(20),@t_ecustno nvarchar(20),@t_bdriverno  nvarchar(20),@t_edriverno  nvarchar(20),@t_carno  nvarchar(20),@t_po  nvarchar(20),@t_baddr  nvarchar(20),@t_eaddr  nvarchar(20)',
		@t_bdate=@t_bdate,@t_edate=@t_edate,@t_btrandate=@t_btrandate,@t_etrandate=@t_etrandate,@t_bcustno=@t_bcustno,@t_ecustno=@t_ecustno,@t_bdriverno=@t_bdriverno,@t_edriverno=@t_edriverno,@t_carno=@t_carno,@t_po=@t_po,@t_baddr=@t_baddr,@t_eaddr=@t_eaddr
	
	-------------------------------------------------------------------------------------------------------------
	
	declare cursor_table cursor for
	select custno,carteamno,mount,[money] from @tmp1
	open cursor_table
	fetch next from cursor_table
	into @custno,@carteamno,@mount,@money
	while(@@FETCH_STATUS <> -1)
	begin
		if exists(select * from @field where noa=@carteamno)
		begin
			select @fieldB='',@fieldD=''
			select @fieldB=field_mount,@fieldD=field_money from @field where noa=@carteamno
			if not  exists(select  *  from  #z_tran06  where  custno=@custno)
			begin
				set @comp=''
				select @comp=nick from cust where noa=@custno
				insert  into  #z_tran06(gno,custno,comp)values('0',@custno,@comp)
			end
			set  @cmd="update #z_tran06 set "+@fieldB+"=@mount,"+@fieldD+"=@money where gno='0' and custno=@custno"
			execute sp_executesql @cmd,N'@custno nvarchar(20),@mount  float,@money float',@custno=@custno,@mount=@mount,@money=@money
		end
		fetch next from cursor_table
		into @custno,@carteamno,@mount,@money
	end
	close cursor_table
	deallocate cursor_table
	-------------------------------------------
	set @result="select '1',char(255),''"
	
	
	declare cursor_table cursor for
	select unit,team,field_mount_header,field_mount,field_money_header,field_money from  @field
	open cursor_table
	fetch next from cursor_table
	into @unit,@team,@fieldA,@fieldB,@fieldC,@fieldD
	while(@@FETCH_STATUS <> -1)
	begin
		set @result = @result+",'',sum("+@fieldB+"),'','',sum("+@fieldD+"),''"
		
		set @cmd = "update #z_tran06 set " +@fieldA+"=@unit,"+@fieldC+"=@team"
		execute sp_executesql @cmd,N'@unit nvarchar(20),@team nvarchar(20)',@unit=@unit,@team=@team
		
		fetch next from cursor_table
		into @unit,@team,@fieldA,@fieldB,@fieldC,@fieldD
	end
	close cursor_table
	deallocate cursor_table
	set @result = @result+" from #z_tran06 group by gno"
	insert into #z_tran06
	execute sp_executesql @result
	----------------------------------------------------------------------------------------------------------------------
	declare cursor_table cursor for
	select field_mount,field_money from @field
	open cursor_table
	fetch next from cursor_table
	into @fieldB,@fieldD
	while(@@FETCH_STATUS <> -1)
	begin
		set @cmd="update #z_tran06 set c"+@fieldB+"=convert(nvarchar(15),CONVERT(money,"+@fieldB+"),1),"+
						" c"+@fieldD+"=reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,"+@fieldD+"),1)),4,12))"
		EXECUTE sp_executesql @cmd
		fetch next from cursor_table
		into @fieldB,@fieldD
	end
	close cursor_table
	deallocate cursor_table
	------------------------------------------------------------------------------------------------------------------------
	select * from #z_tran06 order by custno,gno
	-------------------------------------------------------------------------------------------------------------------
	drop table #z_tran06
	drop table #carkind
	drop table #carteam
	drop table #calctype;

z_tran04:--z_tran04
	SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	declare @t_accy nvarchar(10)
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_btrandate nvarchar(10)
	declare @t_etrandate nvarchar(10)
	declare @t_bcustno nvarchar(20)
	declare @t_ecustno nvarchar(20)
	declare @t_bdriverno nvarchar(20)
	declare @t_edriverno nvarchar(20)
	declare @t_carno nvarchar(20)
	declare @t_po nvarchar(20)
	declare @t_baddr nvarchar(20)
	declare @t_eaddr nvarchar(20)
	declare @t_cno nvarchar(20)
	declare @t_option1  nvarchar(max)
	declare @t_option2  nvarchar(max)
	declare @t_option3  nvarchar(max)
	declare @t_carteam  nvarchar(max)
	declare @t_carkind  nvarchar(max)
	declare @t_calctype  nvarchar(max)
	declare @z_product  nvarchar(max)
	declare @z_addr  nvarchar(max)
	declare @z_boatname nvarchar(max)
	declare @z_delivery  nvarchar(max)
	declare @z_plusmoney  nvarchar(max)
	declare @z_minusmoney  nvarchar(max)
	
	set @t_accy = '[1]'
	set @t_bdate = case when '#non'=[2] then '' else [2] end
	set @t_edate = case when '#non'=[3] then CHAR(255) else [3] end
	set @t_btrandate = case when '#non'=[4] then '' else [4] end
	set @t_etrandate = case when '#non'=[5] then CHAR(255) else [5] end
	set @t_bcustno = case when '#non'=[6] then '' else [6] end
	set @t_ecustno = case when '#non'=[7] then CHAR(255) else [7] end
	set @t_bdriverno = case when '#non'=[8] then '' else [8] end
	set @t_edriverno = case when '#non'=[9] then CHAR(255) else [9] end
	set @t_carno = case when '#non'=[10] then '' else [10] end
	set @t_po = case when '#non'=[11] then '' else [11] end
	set @t_baddr = case when '#non'=[12] then '' else [12] end
	set @t_eaddr = case when '#non'=[13] then CHAR(255) else [13] end
	set @t_cno = case when '#non'=[14] then '' else [14] end
	set @t_option1  = case when '#non'=[15] then '' else [15] end
	set @t_option2  = case when '#non'=[16] then '' else [16] end
	set @t_option3  = case when '#non'=[17] then '' else [17] end
	set @t_carteam  = case when '#non'=[18] then '' else [18] end
	set @t_carkind  = case when '#non'=[19] then '' else [19] end
	set @t_calctype = case when '#non'=[20] then '' else [20] end
	set @z_product = case when '#non'=[21] then '' else [21] end
	set @z_addr = case when '#non'=[22] then '' else [22] end
	set @z_boatname = case when '#non'=[23] then '' else [23] end
	set @z_delivery  = case when '#non'=[24] then '' else [24] end
	set @z_plusmoney  = case when '#non'=[25] then '' else [25] end
	set @z_minusmoney  = case when '#non'=[26] then '' else [26] end
	----------------------------------------------------------------------------------------------
	declare @string nvarchar(max)
	declare @n int
	declare @carno nvarchar(20)
	declare @datea nvarchar(10)
	declare @carkindno  nvarchar(20)
	declare @carkind	nvarchar(20)
	declare @miles float
	declare @tranmoney float
	declare @drivermoney float
	declare @reserve float 
	declare @mount float 
	declare @money float 
	----------------------------------------------------------------------------------------------
	--解析要計算的種類
	IF OBJECT_ID('tempdb..#carkind')is not null
	BEGIN
		set @cmd = 'drop table #carkind'
		EXECUTE sp_executesql @cmd
	END
	create table #carkind(
		noa nvarchar(20)
	)
	set @string = @t_carkind
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #carkind select @string
			end
			break
		end
		insert into #carkind select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	IF OBJECT_ID('tempdb..#carteam')is not null
	BEGIN
		set @cmd = 'drop table #carteam'
		EXECUTE sp_executesql @cmd
	END
	create table #carteam(
		noa nvarchar(20)
	)
	set @string = @t_carteam
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #carteam select @string
			end
			break
		end
		insert into #carteam select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	IF OBJECT_ID('tempdb..#calctype')is not null
	BEGIN
		set @cmd = 'drop table #calctype'
		EXECUTE sp_executesql @cmd
	END
	create table #calctype(
		noa nvarchar(20)
	)
	set @string = @t_calctype
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #calctype select @string
			end
			break
		end
		insert into #calctype select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	----------------------------------------------------------------------------------------------
	declare @tmp table(
		gno nvarchar(3),
		driverno nvarchar(20),
		namea nvarchar(20),
		total float,
		total2 float,
		diff  float
	)
	
	set @cmd = " select  '0',a.driverno,b.namea,SUM(isnull(total,0)),"
	if  len(@t_option2)>0
		set @cmd = @cmd+" SUM(isnull(round(mount2*(price2+price3)*discount,0),0)),SUM(isnull(total,0)-isnull(round(mount2*(price2+price3)*discount,0),0))"
	else
		set @cmd = @cmd+" SUM(isnull(round(mount2*(price2+price3),0),0)),SUM(isnull(total,0)-isnull(round(mount2*(price2+price3),0),0))"
	set @cmd = @cmd+
		" from  trans"+@t_accy+"  a"+
		" left join driver b on a.driverno=b.noa"+
		" left join #carteam  c on a.carteamno=c.noa"+	
		" left join #calctype d on a.calctype=d.noa"+
		" where "+
		" (a.datea  between  @t_bdate  and  @t_edate) and "+
		" (a.trandate between  @t_btrandate and  @t_etrandate) and "+
		" (a.custno  between  @t_bcustno   and  @t_ecustno) and "+
		" (a.driverno  between  @t_bdriverno   and  @t_edriverno) and "+
		" (len(@t_carno)=0  or  a.carno=@t_carno) and "+
		" (len(@t_po)=0  or  a.po=@t_po) and "+
		" (a.straddrno between @t_baddr and @t_eaddr) and"+
		" (c.noa  is  not  null) and (d.noa  is  not  null)"+
		" group by a.driverno,b.namea"
	insert into @tmp
	execute sp_executesql @cmd,N'@t_bdate nvarchar(10),@t_edate nvarchar(10),@t_btrandate nvarchar(10),@t_etrandate nvarchar(10),@t_bcustno nvarchar(20),@t_ecustno nvarchar(20),@t_bdriverno  nvarchar(20),@t_edriverno  nvarchar(20),@t_carno  nvarchar(20),@t_po  nvarchar(20),@t_baddr  nvarchar(20),@t_eaddr  nvarchar(20)',
		@t_bdate=@t_bdate,@t_edate=@t_edate,@t_btrandate=@t_btrandate,@t_etrandate=@t_etrandate,@t_bcustno=@t_bcustno,@t_ecustno=@t_ecustno,@t_bdriverno=@t_bdriverno,@t_edriverno=@t_edriverno,@t_carno=@t_carno,@t_po=@t_po,@t_baddr=@t_baddr,@t_eaddr=@t_eaddr
	
	insert into @tmp
	select '1','','',SUM(total),SUM(total2),SUM(diff) from @tmp
	
	if len(@t_bdate)>0
		set  @cmd  =  '統計日期：'+@t_bdate+'～'+@t_edate
	else
		set  @cmd  =  '交運日期：'+@t_btrandate+'～'+@t_etrandate
		
	select gno,@cmd titlea,driverno,namea,
		SUBSTRING(CONVERT(varchar,CAST(total as money),1 ),1, LEN(CONVERT(varchar,CAST(total as money),1 ))-3) total,
		SUBSTRING(CONVERT(varchar,CAST(total2 as money),1 ),1, LEN(CONVERT(varchar,CAST(total2 as money),1 ))-3) total2,
		SUBSTRING(CONVERT(varchar,CAST(diff as money),1 ),1, LEN(CONVERT(varchar,CAST(diff as money),1 ))-3) diff
	from @tmp order by gno,driverno
	-------------------------------------------------------------------------------------------------------------------
	drop table #carkind
	drop table #carteam
	drop table #calctype;

z_tran02:--z_tran02
	SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	declare @t_accy nvarchar(10)
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_btrandate nvarchar(10)
	declare @t_etrandate nvarchar(10)
	declare @t_bcustno nvarchar(20)
	declare @t_ecustno nvarchar(20)
	declare @t_bdriverno nvarchar(20)
	declare @t_edriverno nvarchar(20)
	declare @t_carno nvarchar(20)
	declare @t_po nvarchar(20)
	declare @t_baddr nvarchar(20)
	declare @t_eaddr nvarchar(20)
	declare @t_cno nvarchar(20)
	declare @t_option1  nvarchar(max)
	declare @t_option2  nvarchar(max)
	declare @t_option3  nvarchar(max)
	declare @t_carteam  nvarchar(max)
	declare @t_carkind  nvarchar(max)
	declare @t_calctype  nvarchar(max)
	declare @z_product  nvarchar(max)
	declare @z_addr  nvarchar(max)
	declare @z_boatname nvarchar(max)
	declare @z_delivery  nvarchar(max)
	declare @z_plusmoney  nvarchar(max)
	declare @z_minusmoney  nvarchar(max)
	
	set @t_accy = '[1]'
	set @t_bdate = case when '#non'=[2] then '' else [2] end
	set @t_edate = case when '#non'=[3] then CHAR(255) else [3] end
	set @t_btrandate = case when '#non'=[4] then '' else [4] end
	set @t_etrandate = case when '#non'=[5] then CHAR(255) else [5] end
	set @t_bcustno = case when '#non'=[6] then '' else [6] end
	set @t_ecustno = case when '#non'=[7] then CHAR(255) else [7] end
	set @t_bdriverno = case when '#non'=[8] then '' else [8] end
	set @t_edriverno = case when '#non'=[9] then CHAR(255) else [9] end
	set @t_carno = case when '#non'=[10] then '' else [10] end
	set @t_po = case when '#non'=[11] then '' else [11] end
	set @t_baddr = case when '#non'=[12] then '' else [12] end
	set @t_eaddr = case when '#non'=[13] then CHAR(255) else [13] end
	set @t_cno = case when '#non'=[14] then '' else [14] end
	set @t_option1  = case when '#non'=[15] then '' else [15] end
	set @t_option2  = case when '#non'=[16] then '' else [16] end
	set @t_option3  = case when '#non'=[17] then '' else [17] end
	set @t_carteam  = case when '#non'=[18] then '' else [18] end
	set @t_carkind  = case when '#non'=[19] then '' else [19] end
	set @t_calctype = case when '#non'=[20] then '' else [20] end
	set @z_product = case when '#non'=[21] then '' else [21] end
	set @z_addr = case when '#non'=[22] then '' else [22] end
	set @z_boatname = case when '#non'=[23] then '' else [23] end
	set @z_delivery  = case when '#non'=[24] then '' else [24] end
	set @z_plusmoney  = case when '#non'=[25] then '' else [25] end
	set @z_minusmoney  = case when '#non'=[26] then '' else [26] end
	----------------------------------------------------------------------------------------------
	declare @string nvarchar(max)
	declare @n int
	declare @carno nvarchar(20)
	declare @datea nvarchar(10)
	declare @carkindno  nvarchar(20)
	declare @carkind	nvarchar(20)
	declare @miles float
	declare @tranmoney float
	declare @drivermoney float
	declare @reserve float 
	declare @mount float 
	declare @money float 
	----------------------------------------------------------------------------------------------
	--解析要計算的種類
	IF OBJECT_ID('tempdb..#carkind')is not null
	BEGIN
		set @cmd = 'drop table #carkind'
		EXECUTE sp_executesql @cmd
	END
	create table #carkind(
		noa nvarchar(20)
	)
	set @string = @t_carkind
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #carkind select @string
			end
			break
		end
		insert into #carkind select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	IF OBJECT_ID('tempdb..#carteam')is not null
	BEGIN
		set @cmd = 'drop table #carteam'
		EXECUTE sp_executesql @cmd
	END
	create table #carteam(
		noa nvarchar(20)
	)
	set @string = @t_carteam
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #carteam select @string
			end
			break
		end
		insert into #carteam select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	IF OBJECT_ID('tempdb..#calctype')is not null
	BEGIN
		set @cmd = 'drop table #calctype'
		EXECUTE sp_executesql @cmd
	END
	create table #calctype(
		noa nvarchar(20)
	)
	set @string = @t_calctype
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #calctype select @string
			end
			break
		end
		insert into #calctype select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	----------------------------------------------------------------------------------------------
	declare @tmp table(
		gno nvarchar(3),
		custno nvarchar(20),
		comp nvarchar(20),
		mon  nvarchar(10),
		total float,
		total2 float,--公司
		total3 float,--外車
		diff  float,
		trdmoney1  float,--當月請款
		trdmoney2  float,--次月請款 
		unpay  float,		
		total4 float, --外車實發 
		plusmoney float,
		minusmoney float
	)
	
	set @cmd = " select  '0',a.custno,b.nick,left(a.datea,6),SUM(isnull(a.total,0)),"
	if  len(@t_option2)>0
		set @cmd = @cmd+" SUM(case when  e.isoutside=1 then 0 else isnull(round(a.mount2*(a.price2+a.price3)*a.discount,0),0) end),"+
						" SUM(case when  e.isoutside=1 then isnull(round(a.mount2*(a.price2+a.price3)*a.discount,0),0) else 0 end),"+
						" SUM(isnull(a.total,0)-isnull(round(a.mount2*(a.price2+a.price3)*a.discount,0),0)),"
	else
		set @cmd = @cmd+" SUM(case when  e.isoutside=1 then 0 else isnull(round(a.mount2*(a.price2+a.price3),0),0) end),"+
						" SUM(case when  e.isoutside=1 then isnull(round(a.mount2*(a.price2+a.price3),0),0) else 0 end),"+
						" SUM(isnull(a.total,0)-isnull(round(a.mount2*(a.price2+a.price3),0),0)),"
	set @cmd = @cmd+
		" sum(case  when g.mon=left(a.datea,6) then isnull(f.tranmoney,0) else  0  end),"+
		" sum(case  when g.mon=left(a.datea,6) then 0 else  isnull(f.tranmoney,0)  end),"+
		" 0  unpay,"+
		" SUM(case when  e.isoutside=1 then isnull(round(a.mount2*(a.price2+a.price3)*a.discount,0),0) else 0 end),"+
		" 0 plus,0 minus"+
		" from  trans"+@t_accy+"  a"+
		" left join cust b on a.custno=b.noa"+
		" left join #carteam  c on a.carteamno=c.noa"+	
		" left join #calctype d on a.calctype=d.noa"+
		" left join calctypes e on a.calctype=e.noa+e.noq"+
		" left join trds"+@t_accy+" f on a.noa=f.tranno and a.noq=f.trannoq"+
		" left join trd"+@t_accy+" g on f.noa=g.noa"+ 
		" where "+
		" (a.datea between  @t_bdate and  @t_edate) and "+
		" (a.trandate between  @t_btrandate and  @t_etrandate) and "+
		" (a.custno  between  @t_bcustno   and  @t_ecustno) and "+
		" (a.driverno  between  @t_bdriverno   and  @t_edriverno) and "+
		" (len(@t_carno)=0  or  a.carno=@t_carno) and "+
		" (len(@t_po)=0  or  a.po=@t_po) and "+
		" (a.straddrno between @t_baddr and @t_eaddr) and"+
		" (c.noa  is  not  null) and (d.noa  is  not  null)"+
		" group by a.custno,b.nick,left(a.datea,6)"
	insert into @tmp
	execute sp_executesql @cmd,N'@t_bdate nvarchar(10),@t_edate nvarchar(10),@t_btrandate nvarchar(10),@t_etrandate nvarchar(10),@t_bcustno nvarchar(20),@t_ecustno nvarchar(20),@t_bdriverno  nvarchar(20),@t_edriverno  nvarchar(20),@t_carno  nvarchar(20),@t_po  nvarchar(20),@t_baddr  nvarchar(20),@t_eaddr  nvarchar(20)',
		@t_bdate=@t_bdate,@t_edate=@t_edate,@t_btrandate=@t_btrandate,@t_etrandate=@t_etrandate,@t_bcustno=@t_bcustno,@t_ecustno=@t_ecustno,@t_bdriverno=@t_bdriverno,@t_edriverno=@t_edriverno,@t_carno=@t_carno,@t_po=@t_po,@t_baddr=@t_baddr,@t_eaddr=@t_eaddr
	-------------------------------------------------------------------------------------------------------------------
	update  @tmp  set  unpay=total-trdmoney1-trdmoney2
	-------------------------------------------------------------------------------------------------------------------
	select @n=COUNT(1) from( select mon from @tmp group by mon)as a
	if @n>1
		insert into @tmp select '1',custno,comp,CHAR(255),SUM(total),SUM(total2),SUM(total3),SUM(diff),SUM(trdmoney1),SUM(trdmoney2),SUM(unpay),SUM(total4),SUM(plusmoney),SUM(minusmoney) from @tmp group  by  custno,comp

	insert into @tmp select '2',CHAR(255),'',CHAR(255),SUM(total),SUM(total2),SUM(total3),SUM(diff),SUM(trdmoney1),SUM(trdmoney2),SUM(unpay),SUM(total4),SUM(plusmoney),SUM(minusmoney) from @tmp where gno='0'

	if len(@t_bdate)>0
		set  @cmd  =  '統計日期：'+@t_bdate+'～'+@t_edate
	else
		set  @cmd  =  '交運日期：'+@t_btrandate+'～'+@t_etrandate
	select gno,@cmd titlea,custno cc,comp dd,mon,
		reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total),1)),4,12)) total,
		reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total2),1)),4,12)) total2,
		reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total3),1)),4,12)) total3,
		reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,diff),1)),4,12)) diff,
		reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,trdmoney1),1)),4,12)) trdmoney1,
		reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,trdmoney2),1)),4,12)) trdmoney2,
		reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,unpay),1)),4,12)) unpay,
		reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total4),1)),4,12)) total4,
		reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,@z_plusmoney),1)),4,12)) plusmoney,
		reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,@z_minusmoney),1)),4,12)) minusmoney,
		(reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total4),1)),4,12))+' + '+
		reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,@z_plusmoney),1)),4,12))+' - '+
		reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,@z_minusmoney),1)),4,12))+' = '+
		reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total4+@z_plusmoney-@z_minusmoney),1)),4,12))) total5
	from @tmp order by custno,gno,mon
	-------------------------------------------------------------------------------------------------------------------
	drop table #carkind
	drop table #carteam
	drop table #calctype;

z_tran01:--z_tran01	
	SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	declare @t_accy nvarchar(10)
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_btrandate nvarchar(10)
	declare @t_etrandate nvarchar(10)
	declare @t_bcustno nvarchar(20)
	declare @t_ecustno nvarchar(20)
	declare @t_bdriverno nvarchar(20)
	declare @t_edriverno nvarchar(20)
	declare @t_carno nvarchar(20)
	declare @t_po nvarchar(20)
	declare @t_baddr nvarchar(20)
	declare @t_eaddr nvarchar(20)
	declare @t_cno nvarchar(20)
	declare @t_option1  nvarchar(max)
	declare @t_option2  nvarchar(max)
	declare @t_option3  nvarchar(max)
	declare @t_carteam  nvarchar(max)
	declare @t_carkind  nvarchar(max)
	declare @t_calctype  nvarchar(max)
	declare @z_product  nvarchar(max)
	declare @z_addr  nvarchar(max)
	declare @z_boatname nvarchar(max)
	declare @z_delivery  nvarchar(max)
	declare @z_plusmoney  nvarchar(max)
	declare @z_minusmoney  nvarchar(max)
	
	set @t_accy = '[1]'
	set @t_bdate = case when '#non'=[2] then '' else [2] end
	set @t_edate = case when '#non'=[3] then CHAR(255) else [3] end
	set @t_btrandate = case when '#non'=[4] then '' else [4] end
	set @t_etrandate = case when '#non'=[5] then CHAR(255) else [5] end
	set @t_bcustno = case when '#non'=[6] then '' else [6] end
	set @t_ecustno = case when '#non'=[7] then CHAR(255) else [7] end
	set @t_bdriverno = case when '#non'=[8] then '' else [8] end
	set @t_edriverno = case when '#non'=[9] then CHAR(255) else [9] end
	set @t_carno = case when '#non'=[10] then '' else [10] end
	set @t_po = case when '#non'=[11] then '' else [11] end
	set @t_baddr = case when '#non'=[12] then '' else [12] end
	set @t_eaddr = case when '#non'=[13] then CHAR(255) else [13] end
	set @t_cno = case when '#non'=[14] then '' else [14] end
	set @t_option1  = case when '#non'=[15] then '' else [15] end
	set @t_option2  = case when '#non'=[16] then '' else [16] end
	set @t_option3  = case when '#non'=[17] then '' else [17] end
	set @t_carteam  = case when '#non'=[18] then '' else [18] end
	set @t_carkind  = case when '#non'=[19] then '' else [19] end
	set @t_calctype = case when '#non'=[20] then '' else [20] end
	set @z_product = case when '#non'=[21] then '' else [21] end
	set @z_addr = case when '#non'=[22] then '' else [22] end
	set @z_boatname = case when '#non'=[23] then '' else [23] end
	set @z_delivery  = case when '#non'=[24] then '' else [24] end
	set @z_plusmoney  = case when '#non'=[25] then '' else [25] end
	set @z_minusmoney  = case when '#non'=[26] then '' else [26] end
	----------------------------------------------------------------------------------------------
	declare @string nvarchar(max)
	declare @n int
	declare @carno nvarchar(20)
	declare @datea nvarchar(10)
	declare @carkindno  nvarchar(20)
	declare @carkind	nvarchar(20)
	declare @miles float
	declare @tranmoney float
	declare @drivermoney float
	declare @reserve float 
	declare @mount float 
	declare @money float 
	----------------------------------------------------------------------------------------------
	--解析要計算的種類
	IF OBJECT_ID('tempdb..#carkind')is not null
	BEGIN
		set @cmd = 'drop table #carkind'
		EXECUTE sp_executesql @cmd
	END
	create table #carkind(
		noa nvarchar(20)
	)
	set @string = @t_carkind
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #carkind select @string
			end
			break
		end
		insert into #carkind select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	----------------------------------------------------------------------------------------------
	declare @t_date nvarchar(10)
	declare @t_date1 nvarchar(10)
	declare @t_date2 nvarchar(10)

	set @t_date1 = convert(nvarchar(4),convert(int,LEFT(@t_btrandate,3))+1911)+'-'+SUBSTRING(@t_btrandate,5,2)+'-'+RIGHT(@t_btrandate,2)
	set @t_date2 = convert(nvarchar(4),convert(int,LEFT(@t_etrandate,3))+1911)+'-'+SUBSTRING(@t_etrandate,5,2)+'-'+RIGHT(@t_etrandate,2)
	set @t_date=@t_date1

	if(isdate(@t_date1)=0 or isdate(@t_date2)=0)
	begin
		print '日期錯誤'
		return	
	end
	if(DATEDIFF(MM,@t_date1,@t_date2)>2)
	begin
		print '查詢區間不可超過三個月'
		return	
	end
	IF OBJECT_ID('tempdb..#listDate')is not null
	BEGIN
		set @cmd = 'drop table #listDate'
		EXECUTE sp_executesql @cmd
	END
	create table #listDate(
		[date] nvarchar(20)
	)

	while (@t_date between @t_date1 and @t_date2)
	begin
		insert into #listDate select right('00'+convert(nvarchar(3),convert(int,YEAR(@t_date))-1911),3)+'/'+right('0'+convert(nvarchar(2),convert(int,MONTH(@t_date))),2)+'/'+right('0'+convert(nvarchar(2),convert(int,DAY(@t_date))),2)
		set @t_date= convert(date,DATEADD(DD,1,@t_date),111)
	end
	----------------------------------------------------------------------------------------------
	IF OBJECT_ID('tempdb..#listCarno')is not null
	BEGIN
		set @cmd = 'drop table #listCarno'
		EXECUTE sp_executesql @cmd
	END
	create table #listCarno(
		carno nvarchar(20),	
		carkindno nvarchar(20),
		carkind nvarchar(20)																																				
	)
	set @cmd=
	" select  a.carno,isnull(c.noa,''),isnull(c.kind,'') "+ 
	" from  trans"+@t_accy+" a  "+
	" left join car2 b on a.carno=b.carno"+
	" left join carKind c on b.carkindno=c.noa"+
	" left join calctypes d on d.noa+d.noq=a.calctype"+
	" left join #carkind e on e.noa=c.noa"+ 
	" where isnull(d.isoutside,0)=0"+
	" and (e.noa is not null)"+
	" and (LEFT(a.trandate,6)  between LEFT(@t_btrandate,6)  and  LEFT(@t_etrandate,6)) "+ 
	" group  by a.carno,isnull(c.noa,''),isnull(c.kind,'') "
	
	insert into #listCarno
	execute  sp_executesql @cmd,N'@t_btrandate  nvarchar(10),@t_etrandate  nvarchar(10)',@t_btrandate=@t_btrandate,@t_etrandate=@t_etrandate
	----------------------------------------------------------------------------------------------
	IF OBJECT_ID('tempdb..#z_tran01')is not null
	BEGIN
		set @cmd = 'drop table #z_tran01'
		EXECUTE sp_executesql @cmd
	END
	create table #z_tran01 (
		gno nvarchar(3),
		carno nvarchar(20),
		carkindno nvarchar(20),
		carkind nvarchar(20),
		driverno nvarchar(20),
		driver nvarchar(20),
		datea nvarchar(10),
		miles float,
		tranmoney float,
		drivermoney float,
		oilmount float,
		oilmoney float,
		tolls float,
		ticket float,
		reserve float,
		profit  float
	)
	
	declare cursor_table cursor for
	select carno,carkindno,carkind,[date] from #listCarno,#listDate
	open cursor_table
	fetch next from cursor_table
	into @carno,@carkindno,@carkind,@datea
	while(@@FETCH_STATUS <> -1)
	begin
		insert into #z_tran01(gno,carno,carkindno,carkind,datea)values('0',@carno,@carkindno,@carkind,@datea)
		fetch next from cursor_table
		into @carno,@carkindno,@carkind,@datea
	end
	close cursor_table
	deallocate cursor_table
	-----------------------------------------------------------------------------------------------------------
	--出車單
	declare @tmp table(
		carno nvarchar(20),
		datea nvarchar(20),
		miles float,
		tranmoney float,
		drivermoney float,
		reserve float
	)
	
	set @cmd  =
	" select a.carno,a.datea"+
	" ,sum(ISNULL(miles,0))"+
	" ,sum(case when @t_option1='收金額'  then  round(a.price*a.mount,0) else round(a.price2*a.mount2,0) end)"+
	" ,sum(round(a.price2*a.mount2*a.discount,0))"+
	" ,sum(isnull(a.reserve,0))"+
	" from trans"+@t_accy+" a"+
	" left join car2 b on a.carno=b.carno"+
	" left join #carkind c on b.carkindno=c.noa"+
	" left  join  calctypes d on d.noa+d.noq=a.calctype "+
	" where (c.noa is not null)"+
	" and  isnull(d.isoutside,0)=0"+
	" and (a.trandate between @t_btrandate and @t_etrandate)"+
	" group by a.carno,a.datea"
	
	insert into @tmp
	execute sp_executesql @cmd,N'@t_option1 nvarchar(max),@t_btrandate nvarchar(10),@t_etrandate nvarchar(10)',
	@t_option1=@t_option1,@t_btrandate=@t_btrandate,@t_etrandate=@t_etrandate
	----------------------------------------------------------------------------------------------
	declare cursor_table cursor for
	select carno,datea,miles,tranmoney,drivermoney,reserve from @tmp
	open cursor_table
	fetch next from cursor_table
	into @carno,@datea,@miles,@tranmoney,@drivermoney,@reserve
	while(@@FETCH_STATUS <> -1)
	begin
		update #z_tran01 set miles=@miles,tranmoney=@tranmoney,drivermoney=@drivermoney,reserve=@reserve where carno=@carno and datea=@datea
		
		fetch next from cursor_table
		into @carno,@datea,@miles,@tranmoney,@drivermoney,@reserve
	end
	close cursor_table
	deallocate cursor_table
	-----------------------------------------------------------------------------------------------------------
	--油費
	declare cursor_table cursor for
	select a.carno,a.datea,SUM(isnull(a.mount,0)),SUM(isnull(a.[money],0))
	from oil a
	left join (select carno  from  @tmp  group  by  carno) b on a.carno=b.carno
	where (b.carno is not null)
	and (a.datea between @t_btrandate and @t_etrandate)
	group  by  a.carno,a.datea
	open cursor_table
	fetch next from cursor_table
	into @carno,@datea,@mount,@money
	while(@@FETCH_STATUS <> -1)
	begin
		update #z_tran01 set oilmount=@mount,oilmoney=@money where carno=@carno and datea=@datea
		
		fetch next from cursor_table
		into @carno,@datea,@mount,@money
	end
	close cursor_table
	deallocate cursor_table
	-----------------------------------------------------------------------------------------------------------
	--ETC
	declare cursor_table cursor for
	select a.carno,a.datea,SUM(isnull(a.[money],0))
	from etc a
	where (a.typea='ETC' or a.typea='CASH')
	and (a.datea between @t_btrandate and @t_etrandate)
	group  by  a.carno,a.datea
	open cursor_table
	fetch next from cursor_table
	into @carno,@datea,@money
	while(@@FETCH_STATUS <> -1)
	begin
		update #z_tran01 set tolls=@money where carno=@carno and datea=@datea
		
		fetch next from cursor_table
		into @carno,@datea,@money
	end
	close cursor_table
	deallocate cursor_table
	-----------------------------------------------------------------------------------------------------------
	--罰單
	declare cursor_table cursor for
	select a.carno,a.datea,SUM(isnull(a.comppay,0))
	from carborr a
	where comppay!=0
	and (a.datea between @t_btrandate and @t_etrandate)
	group  by  a.carno,a.datea
	open cursor_table
	fetch next from cursor_table
	into @carno,@datea,@money
	while(@@FETCH_STATUS <> -1)
	begin
		update #z_tran01 set ticket=@money where carno=@carno and datea=@datea
		
		fetch next from cursor_table
		into @carno,@datea,@money
	end
	close cursor_table
	deallocate cursor_table
	----------------------------------------------------------------------------------------------
	update #z_tran01 set profit=ISNULL(tranmoney,0)-ISNULL(drivermoney,0)-ISNULL(oilmoney,0)-ISNULL(tolls,0)-ISNULL(ticket,0)-ISNULL(reserve,0)
	
	insert  into  #z_tran01
	select  '1','','','','','',datea
	,SUM(ISNULL(miles,0)),SUM(ISNULL(tranmoney,0)),SUM(ISNULL(drivermoney,0)),SUM(ISNULL(oilmount,0)),SUM(ISNULL(oilmoney,0))
	,SUM(ISNULL(tolls,0)),SUM(ISNULL(ticket,0)),SUM(ISNULL(reserve,0)),SUM(ISNULL(profit,0))
	from  #z_tran01 where gno='0' group  by  datea
	
	select a.*,datea dd,c.kind 類別,b.caryear 年份,b.cylinder 汽缸
	,cast(case when isnull(tranmoney,0)=0 then 0 else round(isnull(oilmoney,0)*100/isnull(tranmoney,0),0) end as nvarchar)+'%' 耗油比
	,cast(case when isnull(oilmount,0)=0 then 0 else round(isnull(miles,0)/isnull(oilmount,0),2) end as nvarchar) 公里升
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tranmoney,0)),1)),4,12)) 收入
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(drivermoney,0)),1)),4,12)) 薪資
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(oilmoney,0)),1)),4,12)) 油費
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(oilmount,0)),1)),4,12))油量
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tolls,0)),1)),4,12)) 通行費
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(ticket,0)),1)),4,12)) 罰款
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(a.reserve,0)),1)),4,12)) 寄櫃費
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(a.profit,0)),1)),4,12)) 淨利
	from #z_tran01 a
	left join car2 b on a.carno=b.carno
	left join carKind c on b.carkindno=c.noa
	left join driver d on a.driverno=d.noa
	order  by  a.datea,gno,a.carkindno,a.carno
	----------------------------------------------------------------------------------------------
	drop table #carkind
	drop table #listDate
	drop table #z_tran01;