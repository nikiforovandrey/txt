z_tran01:--z_tran01	
	SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	declare @t_accy nvarchar(10)
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_btrandate nvarchar(10)
	declare @t_etrandate nvarchar(10)
	declare @t_bcustno nvarchar(20)
	declare @t_ecustno nvarchar(20)
	declare @t_bdriverno nvarchar(20)
	declare @t_edriverno nvarchar(20)
	declare @t_carno nvarchar(20)
	declare @t_po nvarchar(20)
	declare @t_baddr nvarchar(20)
	declare @t_eaddr nvarchar(20)
	declare @t_cno nvarchar(20)
	declare @t_option1  nvarchar(max)
	declare @t_option2  nvarchar(max)
	declare @t_option3  nvarchar(max)
	declare @t_carteam  nvarchar(max)
	declare @t_carkind  nvarchar(max)
	declare @t_calctype  nvarchar(max)
	declare @z_product  nvarchar(max)
	declare @z_addr  nvarchar(max)
	declare @z_boatname nvarchar(max)
	declare @z_delivery  nvarchar(max)
	declare @z_plusmoney  nvarchar(max)
	declare @z_minusmoney  nvarchar(max)
	
	set @t_accy = '[1]'
	set @t_bdate = case when '#non'=[2] then '' else [2] end
	set @t_edate = case when '#non'=[3] then CHAR(255) else [3] end
	set @t_btrandate = case when '#non'=[4] then '' else [4] end
	set @t_etrandate = case when '#non'=[5] then CHAR(255) else [5] end
	set @t_bcustno = case when '#non'=[6] then '' else [6] end
	set @t_ecustno = case when '#non'=[7] then CHAR(255) else [7] end
	set @t_bdriverno = case when '#non'=[8] then '' else [8] end
	set @t_edriverno = case when '#non'=[9] then CHAR(255) else [9] end
	set @t_carno = case when '#non'=[10] then '' else [10] end
	set @t_po = case when '#non'=[11] then '' else [11] end
	set @t_baddr = case when '#non'=[12] then '' else [12] end
	set @t_eaddr = case when '#non'=[13] then CHAR(255) else [13] end
	set @t_cno = case when '#non'=[14] then '' else [14] end
	set @t_option1  = case when '#non'=[15] then '' else [15] end
	set @t_option2  = case when '#non'=[16] then '' else [16] end
	set @t_option3  = case when '#non'=[17] then '' else [17] end
	set @t_carteam  = case when '#non'=[18] then '' else [18] end
	set @t_carkind  = case when '#non'=[19] then '' else [19] end
	set @t_calctype = case when '#non'=[20] then '' else [20] end
	set @z_product = case when '#non'=[21] then '' else [21] end
	set @z_addr = case when '#non'=[22] then '' else [22] end
	set @z_boatname = case when '#non'=[23] then '' else [23] end
	set @z_delivery  = case when '#non'=[24] then '' else [24] end
	set @z_plusmoney  = case when '#non'=[25] then '' else [25] end
	set @z_minusmoney  = case when '#non'=[26] then '' else [26] end
	----------------------------------------------------------------------------------------------
	declare @string nvarchar(max)
	declare @n int
	----------------------------------------------------------------------------------------------
	--解析要計算的種類
	IF OBJECT_ID('tempdb..#carkind')is not null
	BEGIN
		set @cmd = 'drop table #carkind'
		EXECUTE sp_executesql @cmd
	END
	create table #carkind(
		noa nvarchar(20)
	)
	set @string = @t_carkind
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #carkind select @string
			end
			break
		end
		insert into #carkind select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	----------------------------------------------------------------------------------------------
	declare @tmp table(
		gno nvarchar(3),
		carno nvarchar(20),
		driverno nvarchar(max),
		datea nvarchar(10),
		miles float,
		tranmoney float,
		drivermoney float,
		oilmount float,
		oilmoney float,
		tolls float,
		ticket float,
		reserve float,
		profit  float
	)
	-----------------------------------------------------------------------------------------------------------
	--出車單
	set @cmd  =
	" select '0',a.carno,a.driverno,a.datea,sum(ISNULL(miles,0))"+
	" ,sum(case when @t_option1='收金額'  then  round(a.price*a.mount,0) else round(a.price2*a.mount2,0) end)"+
	" ,sum(round(a.price2*a.mount2*a.discount,0))"+
	" ,0,0,0,0,sum(isnull(a.reserve,0)),0"+
	" from trans"+@t_accy+" a"+
	" left join car2 b on a.carno=b.carno"+
	" left join #carkind c on b.carkindno=c.noa"+
	" left  join  calctypes d on d.noa+d.noq=a.calctype "+
	" where (c.noa is not null)"+
	" and  isnull(d.isoutside,0)=0"+
	" and (a.trandate between @t_btrandate and @t_etrandate)"+
	" group by a.carno,a.driverno,a.datea"
	
	insert into @tmp
	execute sp_executesql @cmd,N'@t_option1 nvarchar(max),@t_btrandate nvarchar(10),@t_etrandate nvarchar(10)',
	@t_option1=@t_option1,@t_btrandate=@t_btrandate,@t_etrandate=@t_etrandate
	-----------------------------------------------------------------------------------------------------------
	declare @carno nvarchar(20)
	declare @driverno nvarchar(20)
	declare @datea nvarchar(10)
	declare @mount  float
	declare @money  float	
	-----------------------------------------------------------------------------------------------------------
	--油費
	declare cursor_table cursor for
	select a.carno,a.driverno,a.datea,SUM(isnull(a.mount,0)),SUM(isnull(a.[money],0))
	from oil a
	left join (select carno  from  @tmp  group  by  carno) b on a.carno=b.carno
	where (b.carno is not null)
	and (a.datea between @t_btrandate and @t_etrandate)
	group  by  a.carno,a.driverno,a.datea
	open cursor_table
	fetch next from cursor_table
	into @carno,@driverno,@datea,@mount,@money
	while(@@FETCH_STATUS <> -1)
	begin
		if not  exists(select  *  from  @tmp  where  carno=@carno  and  driverno=@driverno  and  datea=@datea)
			insert  into  @tmp(gno,carno,driverno,datea)values('0',@carno,@driverno,@datea)
		update @tmp set  oilmount=@mount,oilmoney=@money where  carno=@carno  and  driverno=@driverno  and  datea=@datea
		
		fetch next from cursor_table
		into @carno,@driverno,@datea,@mount,@money
	end
	close cursor_table
	deallocate cursor_table
	-----------------------------------------------------------------------------------------------------------
	--ETC
	declare cursor_table cursor for
	select a.carno,a.driverno,a.datea,SUM(isnull(a.[money],0))
	from etc a
	where (a.typea='ETC' or a.typea='CASH')
	and (a.datea between @t_btrandate and @t_etrandate)
	group  by  a.carno,a.driverno,a.datea
	open cursor_table
	fetch next from cursor_table
	into @carno,@driverno,@datea,@money
	while(@@FETCH_STATUS <> -1)
	begin
		if not  exists(select  *  from  @tmp  where  carno=@carno  and  driverno=@driverno  and  datea=@datea)
			insert  into  @tmp(gno,carno,driverno,datea)values('0',@carno,@driverno,@datea)
		update @tmp set  tolls=@money where  carno=@carno  and  driverno=@driverno  and  datea=@datea
		
		fetch next from cursor_table
		into @carno,@driverno,@datea,@money
	end
	close cursor_table
	deallocate cursor_table
	-----------------------------------------------------------------------------------------------------------
	--罰單
	declare cursor_table cursor for
	select a.carno,a.driverno,a.datea,SUM(isnull(a.comppay,0))
	from carborr a
	where comppay!=0
	and (a.datea between @t_btrandate and @t_etrandate)
	group  by  a.carno,a.driverno,a.datea
	open cursor_table
	fetch next from cursor_table
	into @carno,@driverno,@datea,@money
	while(@@FETCH_STATUS <> -1)
	begin
		if not  exists(select  *  from  @tmp  where  carno=@carno  and  driverno=@driverno  and  datea=@datea)
			insert  into  @tmp(gno,carno,driverno,datea)values('0',@carno,@driverno,@datea)
		update @tmp set  ticket=@money where  carno=@carno  and  driverno=@driverno  and  datea=@datea
		
		fetch next from cursor_table
		into @carno,@driverno,@datea,@money
	end
	close cursor_table
	deallocate cursor_table
	-----------------------------------------------------------------------------------------------------------
	update  @tmp set profit=ISNULL(tranmoney,0)-ISNULL(drivermoney,0)-ISNULL(oilmoney,0)-ISNULL(tolls,0)-ISNULL(ticket,0)-ISNULL(reserve,0)
	if @t_btrandate=@t_etrandate
	begin
		insert into  @tmp
		select '1','','','',SUM(isnull(miles,0)),SUM(isnull(tranmoney,0)),SUM(isnull(drivermoney,0))
		,SUM(isnull(oilmount,0)),SUM(isnull(oilmoney,0)),SUM(isnull(tolls,0)),SUM(isnull(ticket,0)),SUM(isnull(reserve,0)),SUM(isnull(profit,0))
		from @tmp where gno='0'
	end
	else
	begin
		insert into  @tmp
		select '1',carno,driverno,'',SUM(isnull(miles,0)),SUM(isnull(tranmoney,0)),SUM(isnull(drivermoney,0))
		,SUM(isnull(oilmount,0)),SUM(isnull(oilmoney,0)),SUM(isnull(tolls,0)),SUM(isnull(ticket,0)),SUM(isnull(reserve,0)),SUM(isnull(profit,0))
		from @tmp where gno='0'
		group  by  carno,driverno
	end
	
	select a.*,d.namea 司機,c.kind 類別,b.caryear 年份,b.cylinder 汽缸
	,cast(case when isnull(tranmoney,0)=0 then 0 else round(isnull(oilmoney,0)*100/isnull(tranmoney,0),0) end as nvarchar)+'%' 耗油比
	,cast(case when isnull(oilmount,0)=0 then 0 else round(isnull(miles,0)/isnull(oilmount,0),2) end as nvarchar) 公里升
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tranmoney,0)),1)),4,12)) 收入
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(drivermoney,0)),1)),4,12)) 薪資
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(oilmoney,0)),1)),4,12)) 油費
	,CONVERT(money,isnull(oilmount,0),1) 油量
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tolls,0)),1)),4,12)) 通行費
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(ticket,0)),1)),4,12)) 罰款
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(a.reserve,0)),1)),4,12)) 寄櫃費
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(a.profit,0)),1)),4,12)) 淨利
	from  @tmp a
	left join car2 b on a.carno=b.carno
	left join carKind c on b.carkindno=c.noa
	left join driver d on a.driverno=d.noa
	order  by  a.carno,a.driverno,gno;