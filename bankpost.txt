<<<<<<< HEAD
bankpost:--bankpost
	SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	declare @t_path nvarchar(max) = '[1]'
	declare @t_mm nvarchar(50) =case when '#non' = [3] then '' else [3] end
	declare @salary nvarchar(50) =case when '#non' = [4] then '' else [4] end
	declare @depdate nvarchar(50) =case when '#non' = [5] then '' else [5] end
	
	------------------------------------------------------------------------------------------------
	IF OBJECT_ID('tempdb..#z_cub_rk')is not null
	BEGIN
		drop table #z_cub_rk
	END
	
	create table #z_cub_rk (
		typea nvarchar(20),datea nvarchar(20),vcceno nvarchar(20),comp nvarchar(50),
		ordeno nvarchar(20),dime float,radius float,wi float,lengthc float,spec nvarchar(20),hard float,
		source float
	)
	
declare @tmp table(
	gno nvarchar,postname nvarchar(30),postnumber nvarchar(90),postacc nvarchar(30),deposdate nvarchar(90),
	staffno nvarchar(30),transno nvarchar(30),transacc nvarchar(30),accname nvarchar(30),id nvarchar(30),
	amount float,mon nvarchar(30)
	)
	
declare @countn float 
set @countn=(select top 1 ROW_NUMBER()over (order by b.sno) s
from  salary a, salarys b ,salawards c,acomp d
where a.noa=b.noa  and c.noq=b.noq  and a.mon=@t_mm and d.noa='d'
order by s desc )

insert into @tmp
select '0',d.acomp,left(d.account,7),RIGHT(d.account,8),'' deposdate,b.noq,a.accno,a.accno2,b.namea,b.noa,
		a.total5,a.mon
from  salary a, salarys b ,salawards c,acomp d
where a.noa=b.noa  and c.noq=b.noq  and a.mon=@t_mm and d.noa='d'
order by b.sno,a.mon

insert into @tmp
select TOP 1 '1',d.acomp,left(d.account,7),RIGHT(d.account,8),'' deposdate,b.noq,a.accno,a.accno2,b.namea,b.noa,
		a.total5,a.mon
from  salary a, salarys b ,salawards c,acomp d
where a.noa=b.noa  and c.noq=b.noq  and a.mon=@t_mm and d.noa='d'
order by b.sno,a.mon

insert into @tmp
select TOP 1 '2',d.acomp,left(d.account,7),RIGHT(d.account,8),'' deposdate,b.noq,a.accno,a.accno2,b.namea,b.noa,
		a.total5,a.mon
from  salary a, salarys b ,salawards c,acomp d
where a.noa=b.noa  and c.noq=b.noq  and a.mon=@t_mm and d.noa='d'
order by b.sno,a.mon
		
	---------------------------------------------------------------------------------------
	declare @reportno nvarchar(max) = '表單編號：LC-11-00-02-05'

	select *,@countn countn
	from @tmp
	
	drop table #z_cub_rk ;
bankpost01:--bankpost01
	SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	declare @t_path nvarchar(max) = '[1]'
	declare @t_mm nvarchar 
	declare @salary float
	declare @depdate nvarchar
	
	------------------------------------------------------------------------------------------------
	IF OBJECT_ID('tempdb..#z_cub_rk')is not null
	BEGIN
		drop table #z_cub_rk
	END
	
	create table #z_cub_rk (
		typea nvarchar(20),datea nvarchar(20),vcceno nvarchar(20),comp nvarchar(50),
		ordeno nvarchar(20),dime float,radius float,wi float,lengthc float,spec nvarchar(20),hard float,
		source float
	)
	
		declare @tmp table(
	postname nvarchar(30),postnumber nvarchar(90),postacc nvarchar(30),deposdate nvarchar(90),
	staffno nvarchar(30),transno nvarchar(30),transacc nvarchar(30),accname nvarchar(30),id nvarchar(30),
	amount float
)

insert into @tmp
select '' postname,'' postnumber,'' postacc,'' deposdate,b.noq,a.accno,a.accno2,b.namea,a.noa,
		a.total5
from  salary a, salarys b ,salawards c
where a.noa=b.noa  and c.noq=b.noq 
order by b.sno,a.mon
		
	---------------------------------------------------------------------------------------
	declare @reportno nvarchar(max) = '表單編號：LC-11-00-02-05'

SELECT '0' gno,*
from @tmp


	
	drop table #z_cub_rk ;
=======
﻿salary_media:--薪資產生郵局電子檔
declare @t_noa nvarchar(20)=[1]--單據編號

IF OBJECT_ID('tempdb..##tmp')is not null
BEGIN
   drop table ##tmp
END

create table ##tmp(
	txt nvarchar(1000)
)

insert ##tmp
select '033'+left(isnull(d.account,REPLICATE(' ',7)),7)+REPLICATE(' ',6)+RIGHT(isnull(d.account,REPLICATE(' ',8)),8)
+replace(a.datea,'/','')+left(isnull(c.account,REPLICATE(' ',7)),7)+right(isnull(c.account,REPLICATE(' ',7)),7)
+isnull(left(c.id,10),REPLICATE(' ',10))+right(REPLICATE('0',10)+replace(replace(dbo.getComma(sum(b.total5),2),',',''),'.',''),10)
+REPLICATE(' ',15) txt
from salary a left join salarys b on a.noa=b.noa
left join sss c on b.sno=c.noa left join acomp d on c.cno=d.noa
where a.noa=@t_noa
group by d.account,a.datea,c.account,c.id,b.sno
order by a.datea,b.sno

--產生檔案
declare @string varchar(500)=''
set @string='bcp "SELECT txt FROM ##tmp " queryout "C:\inetpub\wwwroot\htm\htm\PSBP-PAY-NEW.txt" -S"localhost,1799" -U"sa" -P"artsql963" -T -c -t'

EXEC master..xp_cmdshell @string

IF OBJECT_ID('tempdb..##tmp')is not null
BEGIN
   drop table ##tmp
END
;

----------------------------------------------------------------------------------------------------------------------
salaward_media:--獎金產生郵局電子檔
declare @t_noa nvarchar(20)=[1]--單據編號

IF OBJECT_ID('tempdb..##tmp')is not null
BEGIN
   drop table ##tmp
END

create table ##tmp(
	txt nvarchar(1000)
)

insert ##tmp
select '033'+left(isnull(d.account,REPLICATE(' ',7)),7)+REPLICATE(' ',6)+RIGHT(isnull(d.account,REPLICATE(' ',8)),8)
+replace(a.datea,'/','')+left(isnull(c.account,REPLICATE(' ',7)),7)+right(isnull(c.account,REPLICATE(' ',7)),7)
+isnull(left(c.id,10),REPLICATE(' ',10))+right(REPLICATE('0',10)+replace(replace(dbo.getComma(sum(b.total8),2),',',''),'.',''),10)
+REPLICATE(' ',15) txt
from salaward a left join salawards b on a.noa=b.noa
left join sss c on b.sssno=c.noa left join acomp d on c.cno=d.noa
where a.noa=@t_noa
group by d.account,a.datea,c.account,c.id,b.sssno
order by a.datea,b.sssno

--產生檔案
declare @string varchar(500)=''
set @string='bcp "SELECT txt FROM ##tmp " queryout "C:\inetpub\wwwroot\htm\htm\PSBP-PAY-NEW.txt" -S"localhost,1799" -U"sa" -P"artsql963" -T -c -t'

EXEC master..xp_cmdshell @string

IF OBJECT_ID('tempdb..##tmp')is not null
BEGIN
   drop table ##tmp
END
;
>>>>>>> adc9ba00b85864e4ce043cf63d93239b23416efc
