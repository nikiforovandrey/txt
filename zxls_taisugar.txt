zxls_taisugar:--zxls_taisugar.txt
	SET QUOTED_IDENTIFIER OFF 
	declare @cmd nvarchar(max) 
	declare @a nvarchar(max)
	declare @b nvarchar(max)
	declare @c nvarchar(max)
	declare @d nvarchar(max)
	declare @e nvarchar(max)
	declare @f nvarchar(max)
	declare @g nvarchar(max)
	declare @h nvarchar(max)
	declare @i nvarchar(max)
	declare @j nvarchar(max)
	declare @k nvarchar(max)
	declare @l nvarchar(max)
	declare @m nvarchar(max)
	declare @n nvarchar(max)
	declare @o nvarchar(max)
	declare @p nvarchar(max)
	
	declare @tmp table(
		pno int,
		noa nvarchar(20),
		datea nvarchar(10),
		oildate nvarchar(10),
		timea nvarchar(10),
		carno nvarchar(20),
		driverno nvarchar(20),
		driver nvarchar(20),
		
		oilstationno nvarchar(20),
		oilstation nvarchar(20),
		product nvarchar(20),
		price decimal(10,2),
		mount float,
		[money] float,
		bmiles float,
		emiles float,
		miles float,
		memo nvarchar(max)
	)
	declare @t_date nvarchar(10)
	declare @t_time nvarchar(10)
	declare @carno nvarchar(20)
	declare @driverno nvarchar(20)
	declare @driver nvarchar(20)
	declare @stationno nvarchar(20)
	declare @station nvarchar(20)
	select @stationno='',@station=''
	declare @bmiles float
	declare @emiles float
	declare @miles float
	declare @price float
	declare @mount float
	declare @money float
	
	declare @count int
	set @count = 1
	declare cursor_table cursor for
	select a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p from ztmpxls order by cast(s as int)
	open cursor_table
	fetch next from cursor_table
	into @a,@b,@c,@d,@e,@f,@g,@h,@i,@j,@k,@l,@m,@n,@o,@p
	while(@@FETCH_STATUS <> -1)
	begin
		if(LEN(@a)>0)
		begin
			begin try
				set @t_date = right('000'+cast(YEAR(CAST(@a as date))-1911 as nvarchar),3)+'/'+right('00'+cast(Month(CAST(@a as date)) as nvarchar),2)+'/'+right('00'+cast(Day(CAST(@a as date)) as nvarchar),2)
				set @t_time = LEFT(@b,2)+':'+SUBSTRING(@b,3,2)
				set @carno = @g
				--精算單價
				set @mount = cast(@k as float) 
				set @money = CAST(@n as float)
				set @price =  case when @mount=0 then 0 else Round(@money/@mount,2) end
				if(ROUND(@mount*@price,0)!=@money)
					set @price = case when @mount=0 then 0 else floor(@money/@mount*100)/100 end
				
				select @driverno='',@driver='',@bmiles=0
				
				set @cmd = "select @driverno=driverno,@driver=driver from view_trans"+left(@t_date,3)+" where datea=@t_date and carno=@carno"
				execute sp_executesql @cmd,N'@driverno nvarchar(20) output,@driver nvarchar(20) output,@t_date nvarchar(10),@carno nvarchar(20)'
					,@driverno=@driverno output,@driver=@driver output,@t_date=@t_date,@carno=@carno
				if(LEN(ISNULL(@driverno,''))=0)
				begin
					select @driverno=a.driverno,@driver=b.namea from car2 a 
					left join driver b on a.driverno=b.noa
					where a.carno=@g
				end
				select top(1) @bmiles=emiles from oil where carno=@carno and (oildate+timea<@t_date+@t_time) order by oildate desc,timea desc
				select @emiles=CAST(@h as float),@miles=0
				if(ISNULL(@bmiles,0)!=0)
					set @miles = @emiles-@bmiles
				
				insert into @tmp(pno,datea,oildate,timea,carno,driverno,driver,oilstationno,oilstation,product,price,mount,[money],bmiles,emiles,miles,memo)
				values(@count
				,@t_date
				,@t_date
				,@t_time
				,@carno
				,@driverno
				,@driver
				,@stationno
				,@station
				,case when PATINDEX('%92%',@i)>0 or PATINDEX('%九二%',@i)>0 then '九二'
					when PATINDEX('%95%',@i)>0 or PATINDEX('%九五%',@i)>0 then '九五'
					when PATINDEX('%98%',@i)>0 or PATINDEX('%九八%',@i)>0 then '九八'
					else '高柴' end
				,@price
				,@mount
				,@money
				,@bmiles
				,@emiles
				,@miles
				,'單價:'+@j+', 出油金額:'+@L+', 折扣:'+@m)
			end try
			begin catch
				--select ERROR_LINE(), ERROR_MESSAGE()
				if(@a='站名：')
				begin
					select @stationno=noa,@station=station from oilstation where PATINDEX('%'+LEFT(@b,2)+'%',station)>0
				end
			end catch
		end
		
		set @count = @count + 1
		fetch next from cursor_table
		into @a,@b,@c,@d,@e,@f,@g,@h,@i,@j,@k,@l,@m,@n,@o,@p
	end
	close cursor_table
	deallocate cursor_table
	
	declare @pno int
	declare @datea nvarchar(10)
	declare @curMaxNoa nvarchar(20)
	declare @noa nvarchar(20)
	declare @noq nvarchar(10)
	declare @string nvarchar(max)
	set @string = '0123456789ABCDEFGHIJKLMN'
	declare @num int
	
	declare cursor_table cursor for
	select pno,datea from @tmp
	open cursor_table
	fetch next from cursor_table
	into @pno,@datea
	while(@@FETCH_STATUS <> -1)
	begin	
		select @noa = MAX(noa) 
		from(select noa from oil where LEFT(noa,9)='BQ'+replace(@datea,'/','')
		union all
		select noa from @tmp where LEFT(noa,9)='BQ'+replace(@datea,'/','')) as a
		
		if(LEN(ISNULL(@noa,''))=0)
		begin
			set @noq='001'
		end
		else
		begin
			set @noq = right(@noa,3)
			if(right(@noq,2)='99')
			begin
				set @noq = Substring(@string,Charindex(LEFT(@noq,1),@string)+1,1)+'00'
			end
			else
			begin
				set @noq = LEFT(@noq,1) + right('00'+CAST(CAST(right(@noq,2) as int)+1 as nvarchar),2)
			end
		end
		update @tmp set noa='BQ'+replace(@datea,'/','')+@noq where pno=@pno
		fetch next from cursor_table
		into @pno,@datea
	end
	close cursor_table
	deallocate cursor_table

	insert into oil(iscustom2,rate,noa,datea,oildate,timea,carno,bmiles,emiles,miles,driverno,driver
		,oilstationno,oilstation,product,price,mount,[money],memo)
	select 1,case when ISNULL(mount,0)=0 then 0 else ROUND(ISNULL(miles,0)/ISNULL(mount,0),2)end
		,noa,datea,oildate,timea,carno,bmiles,emiles,miles,driverno,driver
		,oilstationno,oilstation,product,price,mount,[money],memo from @tmp;