z_getstp1:--z_getstp1
declare @t_bnoa nvarchar(20)
declare @t_enoa nvarchar(20)
declare @t_typea nvarchar(30)
declare @t_bdate nvarchar(20)
declare @t_edate nvarchar(20)
set @t_bnoa = case when '#non' = [2] then '' else [2] end
set @t_enoa = case when '#non' = [3] then char(255) else [3] end
set @t_typea = case when '#non' = [4] then '' else [4] end
set @t_bdate = case when '#non' = [5] then '' else [5] end
set @t_edate = case when '#non' = [6] then char(255) else [6] end
declare @t_pageline int = 5--------一頁幾行
declare @tmp table(
	gno nvarchar(1),
	idno int identity(0,1),
	orderno int,
	pageno int,
	a_noa nvarchar(30),
	a_typea nvarchar(15),
	a_datea nvarchar(90),
	a_custno nvarchar(30),
	a_custs nvarchar(90),
	a_kind nvarchar(30),
	a_tel nvarchar(90),
	a_fax nvarchar(90),
	a_trantype nvarchar(90),
	a_addr nvarchar(max),
	a_memo nvarchar(max),
	b_uno nvarchar(35),
	b_productno nvarchar(30),
	b_products nvarchar(90),
	b_class nvarchar(15),
	b_sizea nvarchar(max),
	b_mount float,
	b_weight float,
	b_memo nvarchar(max)
)
insert into @tmp
select
	'0',
	ROW_NUMBER()over(partition by a.noa order by a.noa),1
	,a.noa,a.typea,a.datea,a.custno,c.comp,a.kind,c.tel,c.fax,a.trantype,c.addr_fact,a.memo,
	b.uno,b.productno,b.product,b.class,
	case upper(left(a.kind,1)) when 'A' then cast(isnull(b.dime,0) as nvarchar) + ' x ' + cast(isnull(b.width,0) as nvarchar) + ' x ' + cast(isnull(b.lengthb,0) as nvarchar)
		when 'B' then cast(isnull(b.radius,0) as nvarchar) + ' x ' + cast(isnull(b.width,0) as nvarchar) + ' x ' + cast(isnull(b.dime,0) as nvarchar) + ' x ' + cast(isnull(b.lengthb,0) as nvarchar)
		else cast(isnull(b.lengthb,0) as nvarchar) end sizea,
	b.gmount,b.gweight,b.memo	
from view_get[1] a
left join view_gets[1] b on a.noa = b.noa
left join cust c on a.custno = c.noa
where (a.noa between @t_bnoa and @t_enoa) and (a.datea between @t_bdate and @t_edate) and (len(@t_typea)=0 or a.typea=@t_typea)
declare @a_noa nvarchar(30)
declare @a_count int
declare @idno int
declare @k int = 0 ----差幾頁
declare @pageCount int
declare @orderno int
declare @pageno int

declare cursor_table cursor for
	select a_noa,count(*),max(orderno) from @tmp group by a_noa
open cursor_table
fetch next from cursor_table
into @a_noa,@a_count,@orderno
while(@@FETCH_STATUS <> -1)
begin		
	if(@a_count > @t_pageline)
	begin
		set @k = CEILING((cast(@a_count as float)/@t_pageline))
		while(@k > 0)
		begin
			update @tmp set pageno = @k where orderno > ((@k-1)*@t_pageline) and orderno <= (@k*@t_pageline)
			set @k -=1
		end
	end
	fetch next from cursor_table
	into @a_noa,@a_count,@orderno
end
close cursor_table
deallocate cursor_table
update @tmp set orderno = orderno-((pageno-1)*@t_pageline)

declare cursor_table cursor for
	select distinct a_noa,max(orderno),pageno,min(idno),count(*) from @tmp group by a_noa,pageno
open cursor_table
fetch next from cursor_table
into @a_noa,@orderno,@pageno,@idno,@a_count
while(@@FETCH_STATUS <> -1)
begin		
	set @k = @t_pageline -(@a_count%@t_pageline)
	set @pageCount = @a_count/@t_pageline
	if(@k < @t_pageline and (@pageCount =0))
	begin
		while(@k > 0)
		begin
			insert into @tmp(gno,orderno,pageno,a_noa,a_typea,a_datea,a_custno,a_custs,a_kind,a_tel,a_fax,a_trantype,a_addr,a_memo)
				select '0',(@orderno+1),@pageno,@a_noa,a_typea,a_datea,a_custno,a_custs,a_kind,a_tel,a_fax,a_trantype,a_addr,a_memo from @tmp where idno = @idno
			set @k = @k-1
			set @orderno = @orderno +1
		end
	end
	insert into @tmp(gno,orderno,pageno,a_noa,a_typea,a_datea,a_custno,a_custs,a_kind,a_tel,a_fax,a_trantype,a_addr,a_memo,b_mount,b_weight)
		select '1',(@t_pageline+1),pageno,a_noa,a_typea,a_datea,a_custno,a_custs,a_kind,a_tel,a_fax,a_trantype,a_addr,a_memo,sum(b_mount),sum(b_weight) from @tmp where gno=0 and a_noa=@a_noa and pageno=@pageno group by a_noa,pageno,a_typea,a_datea,a_custno,a_custs,a_kind,a_tel,a_fax,a_trantype,a_addr,a_memo
	insert into @tmp(gno,orderno,pageno,a_noa,a_typea,a_datea,a_custno,a_custs,a_kind,a_tel,a_fax,a_trantype,a_addr,a_memo) 
		select '2',(@t_pageline+2),pageno,a_noa,a_typea,a_datea,a_custno,a_custs,a_kind,a_tel,a_fax,a_trantype,a_addr,a_memo from @tmp where gno=0 and a_noa=@a_noa and pageno=@pageno group by a_noa,pageno,a_typea,a_datea,a_custno,a_custs,a_kind,a_tel,a_fax,a_trantype,a_addr,a_memo 
	fetch next from cursor_table
	into @a_noa,@orderno,@pageno,@idno,@a_count
end
close cursor_table
deallocate cursor_table
update @tmp set a_kind = (case a_kind when 'A1' then '鋼捲鋼板' when 'B2' then '鋼管' when 'C3' then '鋼筋' when 'A4' then '鋼胚' end)
select
	gno,orderno,pageno,a_noa,a_typea,a_datea,a_custno,a_custs,a_kind,a_tel,a_fax,a_trantype,a_addr,a_memo,
	b_uno,b_productno,b_products,b_class,b_sizea,
	b_mount,
	b_weight,b_memo
from @tmp order by a_noa desc,pageno,gno,orderno;