z_car21:--z_car21
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_bcardealno nvarchar(20)
	declare @t_ecardealno nvarchar(20)
	declare @t_bcarownerno nvarchar(20)
	declare @t_ecarownerno nvarchar(20)
	declare @t_bcarno nvarchar(20)
	declare @t_ecarno nvarchar(20)
	declare @t_sssno nvarchar(20)
	declare @t_order nvarchar(20)
	
	set @t_bdate = case when '#non'=[3] then '' else [3] end
	set @t_edate = case when '#non'=[4] then char(255) else [4] end
	set @t_bcardealno = case when '#non'=[5] then '' else [5] end
	set @t_ecardealno  = case when '#non'=[6] then char(255) else [6] end	
	set @t_bcarownerno = case when '#non'=[7] then '' else [7] end
	set @t_ecarownerno  = case when '#non'=[8] then char(255) else [8] end	
	set @t_bcarno = case when '#non'=[16] then '' else [16] end
	set @t_ecarno  = case when '#non'=[17] then char(255) else [17] end	
	set @t_sssno  = case when '#non'=[24] then char(255) else [24] end	
	set @t_order = case when '#non'=[31] then '車行' else [31] end	

--*********************************************************************************** 

	declare @tmp table( 
		gno nvarchar(1), 
		recno int identity(1,1),--順序 
		checkdate nvarchar(10),--驗車日期 
		carno nvarchar(20),--車牌號碼 
		carowner nvarchar(20),--車主 
		passdate nvarchar(10),--發照日期 
		caryeartw nvarchar(10),--出廠 
		carbrand nvarchar(20),--廠牌 
		insurance nvarchar(10),--保險止日 
		cardeal nvarchar(20),--車行
		notice nvarchar(10)--通知  
	) 
	declare @cmd nvarchar(MAX)
--ROW_NUMBER()over(order by (case when len(@t_bdate+@t_edate)=0 then LEFT(a.checkdate,6) else a.checkdate end),a.carno)
set @cmd='select ''0'' gno, 
a.checkdate, a.carno, b.namea, a.passdate, a.caryeartw, c.brand, d.edate, e.nick ,a.notice
from car2 a 
left join carowner b on a.carownerno = b.noa 
left join carbrand c on a.carbrandno = c.noa 
left join (select noa,MAX(case when len(stopdate)>0 then stopdate else edate end) edate from carInsure group by noa) as d on a.carno = d.noa 
left join cardeal e on a.cardealno = e.noa 
where (a.checkdate between @t_bdate and @t_edate) and 
(a.cardealno between @t_bcardealno and @t_ecardealno) and 
(a.carownerno between @t_bcarownerno and @t_ecarownerno) and 
(a.carno between @t_bcarno and @t_ecarno) and 
a.carownerno!='''' and (a.enddate='''' or a.enddate is null) and (a.outdate='''' or a.outdate is null) and (a.wastedate='''' or a.wastedate is null)and (a.suspdate='''' or a.suspdate is null)' 

--婉容說不要顯示報停20130603

declare @ssscount int
set @ssscount=0

if(@t_sssno!=char(255))
begin
	while(PATINDEX('%,%',@t_sssno)>0)
	begin
		if (@ssscount=0)
			set @cmd=@cmd+' and (a.sssno='''+LEFT(@t_sssno,PATINDEX('%,%',@t_sssno)-1)+''''
		else
			set @cmd=@cmd+' or a.sssno='''+LEFT(@t_sssno,PATINDEX('%,%',@t_sssno)-1)+''''
		set @t_sssno=RIGHT(@t_sssno,LEN(@t_sssno)-PATINDEX('%,%',@t_sssno))
		set @ssscount=@ssscount+1
	end
	if (@ssscount=0)
		set @cmd=@cmd+' and a.sssno='''+@t_sssno+''''
	else
		set @cmd=@cmd+' or a.sssno='''+@t_sssno+''')'
end
	
if(@t_order='車行')
	set @cmd=@cmd+' order by a.cardealno,a.checkdate'
if(@t_order='車主')
	set @cmd=@cmd+' order by b.namea,a.checkdate'
if(@t_order='驗車日期')
	set @cmd=@cmd+' order by a.checkdate,a.noa'

insert into @tmp 
execute sp_executesql @cmd,N'@t_bdate nvarchar(10),@t_edate nvarchar(10),@t_bcardealno nvarchar(20),@t_ecardealno nvarchar(20),@t_bcarownerno nvarchar(20),@t_ecarownerno nvarchar(20),@t_bcarno nvarchar(20),@t_ecarno nvarchar(20)',
		@t_bdate=@t_bdate,@t_edate=@t_edate,@t_bcardealno=@t_bcardealno,@t_ecardealno=@t_ecardealno,@t_bcarownerno=@t_bcarownerno,@t_ecarownerno=@t_ecarownerno,@t_bcarno=@t_bcarno,@t_ecarno=@t_ecarno

--*********************************************************************************** 
select * from @tmp;
--******************************************************************************************************
z_car22:--z_car22
	declare @t_bcardealno nvarchar(20)
	declare @t_ecardealno nvarchar(20)
	declare @t_bcarownerno nvarchar(20)
	declare @t_ecarownerno nvarchar(20)
	declare @t_enddate nvarchar(10)
	
	set @t_bcardealno = case when '#non'=[5] then '' else [5] end
	set @t_ecardealno  = case when '#non'=[6] then char(255) else [6] end	
	set @t_bcarownerno = case when '#non'=[7] then '' else [7] end
	set @t_ecarownerno  = case when '#non'=[8] then char(255) else [8] end	
	set @t_enddate = case when '#non'=[15] then '' else [15] end

	declare @tmp table(
		cardealno nvarchar(20),
		cardeal nvarchar(50),
		carownerno nvarchar(20),
		carowner nvarchar(50),
		lenderno nvarchar(20),
		lender nvarchar(50),
		money int,
		installmentamount int,
		installment int,
		bkmoney int,
		surplusment int,
		surplusmoney int, 
		date nvarchar(50),
		memo nvarchar(MAX),
		carnos nvarchar(MAX)
		
)
--case說明--如果貸款止日>截止日期表示還沒還清否則已還清，沒有還清則計算剩餘還款期數(如果今天日期<計日，表示當期還沒還款，所以+1)
insert into @tmp
select a.cardealno,a.cardeal,a.noa,b.namea,a.lenderno,a.lender,a.money,a.installmentamount,a.installment,a.bkmoney,
case when a.edate > @t_enddate then
(left(a.edate,3)*12+right(left(a.edate,6),2))-(left(@t_enddate,3)*12+right(left(@t_enddate,6),2))+(case when cast(right(@t_enddate,2) as int)<=cast(a.day as int) then 1 else 0 end) else 0 end surplusment,
0 surplusmoney,a.bdate+' - '+a.edate date,a.memo,a.carnos
from carLender a left join carOwner b on a.noa=b.noa
where (a.cardealno between @t_bcardealno and @t_ecardealno) and (a.noa between @t_bcarownerno and @t_ecarownerno)
order by a.cardealno,a.noa,bdate desc
--計算貸款餘額
update @tmp
set surplusmoney=surplusment*installmentamount
where surplusment>0

--select * from @tmp
----------------------------------------------------------------------------------
declare @result table(
		gno nvarchar(1),
		cardealno nvarchar(20),
		cardeal nvarchar(50),
		carownerno nvarchar(20),
		carowner nvarchar(50),
		lenderno nvarchar(20),
		lender nvarchar(50),
		money int,
		installmentamount int,
		installment int,
		bkmoney int,
		surplusment int,
		surplusmoney int, 
		date nvarchar(50),
		memo nvarchar(MAX),
		carno nvarchar(MAX)
)

declare @cardealno nvarchar(20)
declare @cardeal nvarchar(50)
declare @carownerno nvarchar(20)
declare @carowner nvarchar(50)
declare @lenderno nvarchar(20)
declare @lender nvarchar(50)
declare @money int
declare @installmentamount int
declare @installment int
declare @bkmoney int
declare @surplusment int
declare @surplusmoney int
declare @date nvarchar(50)
declare @memo nvarchar(MAX)
declare @carnos nvarchar(MAX)
declare @count int

	declare cursor_table cursor for
	select cardealno,cardeal,carownerno,carowner,lenderno,lender,money,installmentamount,installment,bkmoney,surplusment,surplusmoney,date,memo,carnos from @tmp
	open cursor_table
	fetch next from cursor_table
	into @cardealno,@cardeal,@carownerno,@carowner,@lenderno,@lender,@money,@installmentamount,@installment,@bkmoney,@surplusment,@surplusmoney,@date,@memo,@carnos
	while(@@FETCH_STATUS <> -1)
	begin
		if(len(@carnos)>0)
		begin
			set @count=1
			while(@count>0)
			begin
				if(CHARINDEX(',',@carnos)=0)
				begin
					if(@count>1)
					begin
						insert into @result
						select '0',null,null,null,null,null,null,null,null,null,null,null,null,null,null,@carnos
					end
					else
					begin
						insert into @result
						select '0',@cardealno,@cardeal,@carownerno,@carowner,@lenderno,@lender,@money,@installmentamount,@installment,@bkmoney,@surplusment,@surplusmoney,@date,@memo,@carnos
					end
					
					set @count=0
				end
				else
				begin
					if(@count>1)
					begin
						insert into @result
						select '0',null,null,null,null,null,null,null,null,null,null,null,null,null,null,SUBSTRING(@carnos,0,CHARINDEX(',',@carnos))
					end
					else
					begin
						insert into @result
						select '0',@cardealno,@cardeal,@carownerno,@carowner,@lenderno,@lender,@money,@installmentamount,@installment,@bkmoney,@surplusment,@surplusmoney,@date,@memo,SUBSTRING(@carnos,0,CHARINDEX(',',@carnos))
					end
					set @carnos=SUBSTRING(@carnos,CHARINDEX(',',@carnos)+1,len(@carnos))
					set @count=@count+1
				end	
			end
		end
		else
		begin
			insert into @result
			select '0',@cardealno,@cardeal,@carownerno,@carowner,@lenderno,@lender,@money,@installmentamount,@installment,@bkmoney,@surplusment,@surplusmoney,@date,@memo,@carnos
		end
		insert into @result
		select '1',null,null,null,null,null,null,null,null,null,null,null,null,null,null,null
		
		fetch next from cursor_table
		into @cardealno,@cardeal,@carownerno,@carowner,@lenderno,@lender,@money,@installmentamount,@installment,@bkmoney,@surplusment,@surplusmoney,@date,@memo,@carnos
	end
	close cursor_table
	deallocate cursor_table
	
	insert into @result
	select '2',null,null,null,null,null,null,null,null,null,null,null,sum(surplusmoney),null,null,null
	from @result
	
	select a.gno,a.carownerno,a.carowner,a.cardealno,left(a.cardeal,3)cardeal,a.lenderno,left(a.lender,3)lender,
	reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.money),1)),4,12)) money,
	reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.installmentamount),1)),4,12)) installmentamount,a.installment,
	reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.bkmoney),1)),4,12)) bkmoney,a.surplusment,
	reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.surplusmoney),1)),4,12)) surplusmoney,a.date,a.memo,a.carno,
	c.brand,b.caryear from @result a left join car2 b on a.carno=b.noa left join carbrand c on b.carbrandno=c.noa;

--********************************************************************************************************************
z_car24:--z_car24
	declare @t_bcardealno nvarchar(20)
	declare @t_ecardealno nvarchar(20)
	declare @t_bcarownerno nvarchar(20)
	declare @t_ecarownerno nvarchar(20)
	declare @t_enddate nvarchar(10)
	
	set @t_bcardealno = case when '#non'=[5] then '' else [5] end
	set @t_ecardealno  = case when '#non'=[6] then char(255) else [6] end	
	set @t_bcarownerno = case when '#non'=[7] then '' else [7] end
	set @t_ecarownerno  = case when '#non'=[8] then char(255) else [8] end	
	set @t_enddate = case when '#non'=[15] then '' else [15] end

	declare @tmp table(
		cardealno nvarchar(20),
		cardeal nvarchar(50),
		carownerno nvarchar(20),
		carowner nvarchar(50),
		lenderno nvarchar(20),
		lender nvarchar(50),
		money int,
		installmentamount int,
		installment int,
		bkmoney int,
		surplusment int,
		surplusmoney int, 
		date nvarchar(50),
		memo nvarchar(MAX),
		carnos nvarchar(MAX)
		
)
--case說明--如果貸款止日>截止日期表示還沒還清否則已還清，沒有還清則計算剩餘還款期數(如果今天日期<計日，表示當期還沒還款，所以+1)
insert into @tmp
select a.cardealno,a.cardeal,a.noa,b.namea,a.lenderno,a.lender,a.money,a.installmentamount,a.installment,a.bkmoney,
case when a.edate > @t_enddate then
(left(a.edate,3)*12+right(left(a.edate,6),2))-(left(@t_enddate,3)*12+right(left(@t_enddate,6),2))+(case when cast(right(@t_enddate,2)as int)<=cast(a.day AS int) then 1 else 0 end) else 0 end surplusment,
0 surplusmoney,a.bdate+' - '+a.edate date,a.memo,a.carnos
from carLender a left join carOwner b on a.noa=b.noa
where (a.cardealno between @t_bcardealno and @t_ecardealno) and (a.noa between @t_bcarownerno and @t_ecarownerno)
order by a.noa

--計算貸款餘額
update @tmp
set surplusmoney=surplusment*installmentamount
where surplusment>0

--select * from @tmp
----------------------------------------------------------------------------------
declare @result table(
		gno nvarchar(1),
		carownerno nvarchar(20),
		carowner nvarchar(50),
		cardealno nvarchar(20),
		cardeal nvarchar(50),
		lenderno nvarchar(20),
		lender nvarchar(50),
		money int,
		installmentamount int,
		installment int,
		bkmoney int,
		surplusment int,
		surplusmoney int, 
		date nvarchar(50),
		memo nvarchar(MAX),
		carno nvarchar(MAX)
)

declare @cardealno nvarchar(20)
declare @cardeal nvarchar(50)
declare @carownerno nvarchar(20)
declare @t_carownerno nvarchar(20) 
declare @carowner nvarchar(50)
declare @lenderno nvarchar(20)
declare @lender nvarchar(50)
declare @money int
declare @installmentamount int
declare @installment int
declare @bkmoney int
declare @surplusment int
declare @surplusmoney int
declare @date nvarchar(50)
declare @memo nvarchar(MAX)
declare @carnos nvarchar(MAX)
declare @count int

set @t_carownerno='XXXX'

	declare cursor_table cursor for
	select cardealno,cardeal,carownerno,carowner,lenderno,lender,money,installmentamount,installment,bkmoney,surplusment,surplusmoney,date,memo,carnos from @tmp
	open cursor_table
	fetch next from cursor_table
	into @cardealno,@cardeal,@carownerno,@carowner,@lenderno,@lender,@money,@installmentamount,@installment,@bkmoney,@surplusment,@surplusmoney,@date,@memo,@carnos
	while(@@FETCH_STATUS <> -1)
	begin
	
		if(@carownerno!=@t_carownerno and @t_carownerno!='XXXX')
		begin
			insert into @result 
			select '2',@t_carownerno,null,null,null,null,null,null,null,null,null,null,sum(surplusmoney),null,null,null from @tmp where carownerno=@t_carownerno
		end
		set @t_carownerno=@carownerno
	
		if(len(@carnos)>0)
		begin
			set @count=1
			while(@count>0)
			begin
				if(CHARINDEX(',',@carnos)=0)
				begin
					if(@count>1)
					begin
						insert into @result
						select '0',@carownerno,null,null,null,null,null,null,null,null,null,null,null,null,null,@carnos
					end
					else
					begin
						insert into @result
						select '0',@carownerno,@carowner,@cardealno,@cardeal,@lenderno,@lender,@money,@installmentamount,@installment,@bkmoney,@surplusment,@surplusmoney,@date,@memo,@carnos
					end
					
					set @count=0
				end
				else
				begin
					if(@count>1)
					begin
						insert into @result
						select '0',@carownerno,null,null,null,null,null,null,null,null,null,null,null,null,null,SUBSTRING(@carnos,0,CHARINDEX(',',@carnos))
					end
					else
					begin
						insert into @result
						select '0',@carownerno,@carowner,@cardealno,@cardeal,@lenderno,@lender,@money,@installmentamount,@installment,@bkmoney,@surplusment,@surplusmoney,@date,@memo,SUBSTRING(@carnos,0,CHARINDEX(',',@carnos))
					end
					set @carnos=SUBSTRING(@carnos,CHARINDEX(',',@carnos)+1,len(@carnos))
					set @count=@count+1
				end	
			end
		end
		else
		begin
			insert into @result
			select '0',@carownerno,@carowner,@cardealno,@cardeal,@lenderno,@lender,@money,@installmentamount,@installment,@bkmoney,@surplusment,@surplusmoney,@date,@memo,@carnos
		end
		insert into @result
		select '1',@carownerno,null,null,null,null,null,null,null,null,null,null,null,null,null,null
		
		fetch next from cursor_table
		into @cardealno,@cardeal,@carownerno,@carowner,@lenderno,@lender,@money,@installmentamount,@installment,@bkmoney,@surplusment,@surplusmoney,@date,@memo,@carnos
	end
	
	insert into @result 
	select '2',@t_carownerno,null,null,null,null,null,null,null,null,null,null,sum(surplusmoney),null,null,null from @tmp where carownerno=@t_carownerno
	
	close cursor_table
	deallocate cursor_table
	
	insert into @result 
	select '3',@t_carownerno,null,null,null,null,null,null,null,null,null,null,sum(surplusmoney),null,null,null from @result where gno='2'

	select a.gno,a.carownerno,a.carowner,a.cardealno,left(a.cardeal,3)cardeal,a.lenderno,left(a.lender,3)lender,
	reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.money),1)),4,12)) money,
	reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.installmentamount),1)),4,12)) installmentamount,a.installment,
	reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.bkmoney),1)),4,12)) bkmoney,a.surplusment,
	reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.surplusmoney),1)),4,12)) surplusmoney,a.date,a.memo,a.carno,
	c.brand,b.caryear from @result a left join car2 b on a.carno=b.noa left join carbrand c on b.carbrandno=c.noa;
--********************************************************************************************************************

--**************************************************************************************************************************************
z_car25:--z_car25高額欠款追蹤依車號
	declare @t_bcarno nvarchar(20)
	declare @t_ecarno nvarchar(20)
	declare @t_xmon nvarchar(10)
	declare @t_sssno nvarchar(20)
	declare @t_bmoney int
	declare @t_emoney int
	declare @t_order nvarchar(20)
	
	set @t_bcarno = case when '#non'=[16] then '' else [16] end
	set @t_ecarno  = case when '#non'=[17] then char(255) else [17] end
	set @t_xmon  = case when '#non'=[18] then '' else [18] end
	set @t_sssno  = case when '#non'=[24] then char(255) else [24] end	
	set @t_bmoney = case when '#non'=[26] then -99999999 else [26] end
	set @t_emoney  = case when '#non'=[27] then 99999999 else [27] end	
	set @t_order = case when '#non'=[28] then '車號' else [28] end
--************************************************************************************
SET QUOTED_IDENTIFIER OFF
declare @result table(
		gno nvarchar(1),
		noa nvarchar(20),
		mon nvarchar(10),
		carno nvarchar(20),
		carownerno nvarchar(20),
		carowner nvarchar(20),
		cardealno nvarchar(20),
		cardeal nvarchar(20),
		indate nvarchar(10),
		caryear nvarchar(10),
		carbrandno nvarchar(20),
		carbrand nvarchar(20),
		tel nvarchar(50),
		mobile nvarchar(50),
		total float
)
declare @cmd nvarchar(MAX)

set @cmd='select ''0'' gno,isnull(e.noa,''''),isnull(e.mon,''''),isnull(e.carno,''''),a.carownerno,b.namea,a.cardealno,ISNULL(c.nick,''''),a.indate,a.caryear,a.carbrandno, 
isnull(d.brand,''''),b.tel1,b.mobile,isnull(e.total,0) 
from car2 a 
left join carOwner b on b.noa = a.carownerno 
left join cardeal c on c.noa = a.cardealno 
left join carbrand d on d.noa = a.carbrandno 
left join cara e on e.carno = a.carno 
where (e.mon=@t_xmon) and (e.carno between @t_bcarno and @t_ecarno)  and 
a.carownerno!='''' and (total between @t_bmoney and @t_emoney) 
and a.carownerno!=''H003'' and a.carownerno!=''H264'' and a.carownerno!=''H326''
and a.carownerno!=''H273'' and a.carownerno!=''H249'' and a.carownerno!=''H041'' 
and a.noa!=''1111'' and a.noa!=''1120'' and a.noa!=''1122'''

declare @ssscount int
set @ssscount=0

if(@t_sssno!=char(255))
begin
	while(PATINDEX('%,%',@t_sssno)>0)
	begin
		if (@ssscount=0)
			set @cmd=@cmd+' and (a.sssno='''+LEFT(@t_sssno,PATINDEX('%,%',@t_sssno)-1)+''''
		else
			set @cmd=@cmd+' or a.sssno='''+LEFT(@t_sssno,PATINDEX('%,%',@t_sssno)-1)+''''
		set @t_sssno=RIGHT(@t_sssno,LEN(@t_sssno)-PATINDEX('%,%',@t_sssno))
		set @ssscount=@ssscount+1
	end
	if (@ssscount=0)
		set @cmd=@cmd+' and a.sssno='''+@t_sssno+''''
	else
		set @cmd=@cmd+' or a.sssno='''+@t_sssno+''')'
end

if(@t_order='車號')
set @cmd=@cmd+' order by e.carno,total desc,gno'
if(@t_order='金額')
set @cmd=@cmd+' order by total desc,e.carno,gno'

insert into @result 
execute sp_executesql @cmd,N'@t_xmon nvarchar(10),@t_bcarno nvarchar(20),@t_ecarno nvarchar(20),@t_bmoney int,@t_emoney int',
		@t_xmon=@t_xmon,@t_bcarno=@t_bcarno,@t_ecarno=@t_ecarno,@t_bmoney=@t_bmoney,@t_emoney=@t_emoney

--20130327加入vcc未付金額
--declare @carno nvarchar(50)
--declare @unpay float
--set @cmd="
--	declare cursor_table cursor for 
--	select carno,sum(unpay) unpay from (select (case when (select count(*) from car2 where noa=substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)))>0
--	then substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo))else
--	(select top 1 carno from cara c where mon<=left(a.carno,6) and a.custno=c.carownerno order by mon desc,carno)end) 
--	carno,isnull(a.total-a.payed,0) unpay 
--	from vcc"+left(@t_xmon,3)+" a left join car2 b on 
--	(case when (select count(*) from car2 where noa=substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)))>0
--	then substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo))else
--	(select top 1 carno from cara c where mon<=left(a.carno,6) and a.custno=c.carownerno order by mon desc,carno)end)=b.noa 
--	left join carbrand d on b.carbrandno=d.noa 
--	left join carOwner e on a.custno=e.noa 
--	where left(a.custno,1)='H' and (left(a.carno,6) <= '"+@t_xmon+"')) a group by carno"
--	execute sp_executesql @cmd

--open cursor_table 
--fetch next from cursor_table 
--into @carno,@unpay
--while(@@FETCH_STATUS <> -1) 
--	begin 
--		update @result
--		set total=total+@unpay
--		where carno=@carno
		
--		fetch next from cursor_table 
--		into @carno,@unpay
--	end 
--close cursor_table 
--deallocate cursor_tabl

insert into @result 
select '2' gno,'','',CHAR(255),'','','','','','','','','','',SUM(total) 
from @result 
where gno != 1 

select gno,noa,mon,carno,carownerno,carowner,cardealno,cardeal,indate,caryear,carbrandno,carbrand,tel,mobile,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total),1)),4,12)) total
from @result; 

--**********************************************************************************

z_car26:--z_car26高額欠款追蹤依車主
	declare @t_bcarownerno nvarchar(20)
	declare @t_ecarownerno nvarchar(20)
	declare @t_xmon nvarchar(10)
	declare @t_sssno nvarchar(20)
	declare @t_bmoney int
	declare @t_emoney int
	declare @t_order nvarchar(20)
	
	set @t_bcarownerno = case when '#non'=[7] then '' else [7] end
	set @t_ecarownerno  = case when '#non'=[8] then char(255) else [8] end	
	set @t_xmon  = case when '#non'=[18] then '' else [18] end
	set @t_sssno  = case when '#non'=[24] then char(255) else [24] end
	set @t_bmoney = case when '#non'=[26] then -99999999 else [26] end
	set @t_emoney  = case when '#non'=[27] then 99999999 else [27] end
	set @t_order = case when '#non'=[29] then '車主' else [29] end	
		
--************************************************************************************
SET QUOTED_IDENTIFIER OFF
declare @result table(
		gno nvarchar(1),
		noa nvarchar(20),
		mon nvarchar(10),
		carno nvarchar(20),
		carownerno nvarchar(20),
		carowner nvarchar(20),
		cardealno nvarchar(20),
		cardeal nvarchar(20),
		indate nvarchar(10),
		caryear nvarchar(10),
		carbrandno nvarchar(20),
		carbrand nvarchar(20),
		tel nvarchar(50),
		mobile nvarchar(50),
		total float
)
declare @cmd nvarchar(MAX)

set @cmd='select ''0'' gno,isnull(e.noa,''''),isnull(e.mon,''''),isnull(e.carno,''''),a.carownerno
,b.namea,a.cardealno,ISNULL(c.nick,''''),a.indate,a.caryear,a.carbrandno,isnull(d.brand,'''')
,b.tel1,b.mobile,isnull(e.total,0)
from car2 a left join carOwner b on b.noa = a.carownerno
left join  cardeal c on c.noa = a.cardealno
left join carbrand d on d.noa = a.carbrandno
left join cara e on e.carno = a.carno
where (e.mon=@t_xmon) and (isnull(a.carownerno,'''') between @t_bcarownerno and @t_ecarownerno)  
and a.carownerno!='''' and a.carownerno!=''H003'' and a.carownerno!=''H264'' and a.carownerno!=''H326''
and a.carownerno!=''H273'' and a.carownerno!=''H249'' and a.carownerno!=''H041'' and a.noa!=''1111'' and a.noa!=''1120'' and a.noa!=''1122'''

declare @ssscount int
set @ssscount=0

if(@t_sssno!=char(255))
begin
	while(PATINDEX('%,%',@t_sssno)>0)
	begin
		if (@ssscount=0)
			set @cmd=@cmd+' and (a.sssno='''+LEFT(@t_sssno,PATINDEX('%,%',@t_sssno)-1)+''''
		else
			set @cmd=@cmd+' or a.sssno='''+LEFT(@t_sssno,PATINDEX('%,%',@t_sssno)-1)+''''
		set @t_sssno=RIGHT(@t_sssno,LEN(@t_sssno)-PATINDEX('%,%',@t_sssno))
		set @ssscount=@ssscount+1
	end
	if (@ssscount=0)
		set @cmd=@cmd+' and a.sssno='''+@t_sssno+''''
	else
		set @cmd=@cmd+' or a.sssno='''+@t_sssno+''')'
end

insert into @result
execute sp_executesql @cmd,N'@t_xmon nvarchar(10),@t_bcarownerno nvarchar(20),@t_ecarownerno nvarchar(20)',
		@t_xmon=@t_xmon,@t_bcarownerno=@t_bcarownerno,@t_ecarownerno=@t_ecarownerno

--20130327加入vcc未付金額
--declare @carownerno nvarchar(50)
--declare @unpay float
--set @cmd="
--	declare cursor_table cursor for
--	select carownerno,sum(unpay) unpay from (
--	select b.carownerno carownerno,isnull(a.total-a.payed,0) unpay 
--	from vcc"+left(@t_xmon,3)+" a left join car2 b on 
--	(case when (select count(*) from car2 where noa=substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)))>0
--	then substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo))else
--	(select top 1 carno from cara c where mon<=left(a.carno,6) and a.custno=c.carownerno order by mon desc,carno)end)=b.noa 
--	left join carbrand d on b.carbrandno=d.noa 
--	left join carOwner e on a.custno=e.noa 
--	where left(a.custno,1)='H' and (left(a.carno,6) <= '"+@t_xmon+"')) a group by carownerno"
--	execute sp_executesql @cmd
	
--open cursor_table 
--fetch next from cursor_table 
--into @carownerno,@unpay
--while(@@FETCH_STATUS <> -1) 
--	begin 
--		update @result
--		set total=total+@unpay
--		where carownerno=@carownerno
		
--		fetch next from cursor_table 
--		into @carownerno,@unpay
--	end 
--close cursor_table 
--deallocate cursor_table 

if(@t_order='車主')
	begin
		insert into @result
		select '1' gno,'',mon,'',carownerno,carowner,'','','','','','','','',SUM(total)
		from @result
		group by carownerno,carowner,mon
		
		delete @result
		where carownerno in(select carownerno from @result where gno=1 and (total not between @t_bmoney and @t_emoney))
		
		insert into @result
		select '2' gno,'','','','',CHAR(255),'','','','','','','','',SUM(total)
		from @result
		where (gno = 1)
		
		select gno,noa,mon,carno,carownerno,carowner,cardealno,cardeal,indate,caryear,carbrandno,carbrand,tel,mobile,
		reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total),1)),4,12)) total
		from @result
		order by carowner,gno
	end
if(@t_order='金額')
	begin
	
		declare @tmp table(
				gno nvarchar(1),
				noa nvarchar(20),
				mon nvarchar(10),
				carno nvarchar(20),
				carownerno nvarchar(20),
				carowner nvarchar(20),
				cardealno nvarchar(20),
				cardeal nvarchar(20),
				indate nvarchar(10),
				caryear nvarchar(10),
				carbrandno nvarchar(20),
				carbrand nvarchar(20),
				tel nvarchar(50),
				mobile nvarchar(50),
				total float
		)
		declare @t_carownerno nvarchar(30)
		declare @t_total int

		declare cursor_table cursor for 
		select carownerno,SUM(total)from @result group by carownerno order by sum(total) desc
		open cursor_table 
		fetch next from cursor_table 
		into @t_carownerno,@t_total
		while(@@FETCH_STATUS <> -1) 
			begin 
			insert into @tmp
			select * from @result where carownerno=@t_carownerno
			
			insert into @tmp
			select '1' gno,'','','',@t_carownerno,'','','','','','','','','',@t_total
			
			fetch next from cursor_table 
			into @t_carownerno,@t_total
			end 
		close cursor_table 
		deallocate cursor_table 
		
		
		delete @tmp
		where carownerno in(select carownerno from @tmp where gno=1 and (total not between @t_bmoney and @t_emoney))
		
		insert into @tmp
		select '2' gno,'','','','',CHAR(255),'','','','','','','','',SUM(total)
		from @tmp
		where (gno = 1)
		
		select gno,noa,mon,carno,carownerno,carowner,cardealno,cardeal,indate,caryear,carbrandno,carbrand,tel,mobile,
		reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total),1)),4,12)) total
		from @tmp
		
	end;
--************************************************************************************

z_car27:--z_car27車輛統計表
	declare @t_bcardealno nvarchar(20)
	declare @t_ecardealno nvarchar(20)
	declare @t_bcarspecno nvarchar(20)
	declare @t_ecarspecno nvarchar(20)
	declare @t_pdate nvarchar(20)
	declare @t_sssno nvarchar(20)
	declare @t_enddate nvarchar(10)
	declare @t_xcarspec nvarchar(MAX)
	
	set @t_bcardealno = case when '#non'=[5] then '' else [5] end
	set @t_ecardealno  = case when '#non'=[6] then char(255) else [6] end	
	set @t_bcarspecno = case when '#non'=[21] then '' else [21] end
	set @t_ecarspecno  = case when '#non'=[22] then char(255) else [22] end	
	set @t_pdate = case when '#non'=[23] then '' else [23] end
	set @t_sssno  = case when '#non'=[24] then char(255) else [24] end	
	set @t_enddate = case when '#non'=[15] then '' else [15] end
	set @t_xcarspec = case when '#non'=[40] then '' else [40] end
	
declare @result table(
		gno nvarchar(1),
		noa nvarchar(20),
		cno nvarchar(20),
		cardeal nvarchar(20),
		carno nvarchar(20),
		carownerno nvarchar(20),
		carowner nvarchar(50),
		indate nvarchar(10),
		outdate nvarchar(10),
		stopdate nvarchar(10),
		enddate nvarchar(10),
		wasted nvarchar(10),
		carkindno nvarchar(10),
		carkind nvarchar(10),
		caryear nvarchar(10),
		ton  nvarchar(20),
		carbrandno nvarchar(20),
		carbrand nvarchar(20),
		carmount int,
		palmount int 
)
declare @cmd nvarchar(MAX)

set @cmd='select ''0'' gno,a.noa,a.cardealno,ISNULL(c.nick,''''),a.carno,a.carownerno,b.namea,a.indate,a.outdate, 
a.suspdate,a.enddate,a.wastedate,a.carspecno,ISNULL(f.spec,''''),a.caryear,ISNULL(a.ton,'''')+ISNULL(a.cc,''''),a.carbrandno,isnull(d.brand,''''),0,0 
from car2 a 
left join carowner b on b.noa = a.carownerno 
left join cardeal c on c.noa = a.cardealno 
left join carbrand d on d.noa = a.carbrandno 
left join carspec f on f.noa = a.carspecno 
where a.indate<=@t_enddate and (a.cardealno between @t_bcardealno and @t_ecardealno)
and a.carownerno!='''' '

if(@t_xcarspec!='')
set @cmd=@cmd+'and CHARINDEX(a.carspecno,'''+@t_xcarspec+''')>0'
--(a.carspecno between @t_bcarspecno and @t_ecarspecno)

if(PATINDEX('%遷出%',@t_pdate)=0)
	set @cmd=@cmd+' and (outdate='''' or outdate is null)'
if(PATINDEX('%報停%',@t_pdate)=0)
	set @cmd=@cmd+' and (a.suspdate='''' or a.suspdate is null)'
if(PATINDEX('%報廢%',@t_pdate)=0)
	set @cmd=@cmd+' and (a.enddate='''' or a.enddate is null)'
if(PATINDEX('%繳銷%',@t_pdate)=0)
	set @cmd=@cmd+' and (a.wastedate='''' or a.wastedate is null)'
declare @ssscount int
set @ssscount=0

if(@t_sssno!=char(255))
begin
	while(PATINDEX('%,%',@t_sssno)>0)
	begin
		if (@ssscount=0)
			set @cmd=@cmd+' and (a.sssno='''+LEFT(@t_sssno,PATINDEX('%,%',@t_sssno)-1)+''''
		else
			set @cmd=@cmd+' or a.sssno='''+LEFT(@t_sssno,PATINDEX('%,%',@t_sssno)-1)+''''
		set @t_sssno=RIGHT(@t_sssno,LEN(@t_sssno)-PATINDEX('%,%',@t_sssno))
		set @ssscount=@ssscount+1
	end
	if (@ssscount=0)
		set @cmd=@cmd+' and a.sssno='''+@t_sssno+''''
	else
		set @cmd=@cmd+' or a.sssno='''+@t_sssno+''')'
end

insert into @result 
execute sp_executesql @cmd,N'@t_enddate nvarchar(10),@t_bcardealno nvarchar(20),@t_ecardealno nvarchar(20),@t_bcarspecno nvarchar(20),@t_ecarspecno nvarchar(20)',
		@t_enddate=@t_enddate,@t_bcardealno=@t_bcardealno,@t_ecardealno=@t_ecardealno,@t_bcarspecno=@t_bcarspecno,@t_ecarspecno=@t_ecarspecno

insert into @result
select '1' gno,'',cno,'',COUNT(distinct carno),'','','','','','','','','','','','','',0,0
from @result
group by cno

declare @cno nvarchar(20) 
declare cursor_table cursor for 
select cno from @result where gno='1'
open cursor_table 
fetch next from cursor_table 
into @cno
while(@@FETCH_STATUS <> -1) 
	begin 
	
	update @result
	set carmount=(select COUNT(*) from @result where gno='0' and PATINDEX('%-%',carno)>0 and len(carno)=6 and cno=@cno),
	palmount=(select COUNT(*) from @result where gno='0' and PATINDEX('%-%',carno)>0 and len(carno)=5 and cno=@cno)
	where cno=@cno and gno='1'

	fetch next from cursor_table 
	into @cno
	end 
close cursor_table 
deallocate cursor_table 

select *
from @result
order by cno,gno,carkindno,noa;

--***************************************************************************************
z_car28:--z_car28車籍資料列印
	declare @t_bcarno nvarchar(20)
	declare @t_ecarno nvarchar(20)
	declare @t_sssno nvarchar(20)

	set @t_bcarno = case when '#non'=[16] then '' else [16] end
	set @t_ecarno  = case when '#non'=[17] then char(255) else [17] end
	set @t_sssno  = case when '#non'=[24] then char(255) else [24] end
--************************************************************************************
declare @result table(
		gno nvarchar(1),
		noa nvarchar(20),
		carno nvarchar(20),
		carownerno nvarchar(20),
		carowner nvarchar(20),
		cardealno nvarchar(20),
		cardeal nvarchar(20),
		sex nvarchar(1),
		idno nvarchar(50),
		birthday nvarchar(10),
		tel1 nvarchar(50),
		tel2 nvarchar(50),
		fax nvarchar(50),
		mobile nvarchar(50),
		addr_conn nvarchar(MAX),
		addr_home nvarchar(MAX),
		indate nvarchar(10),
		inmoney int,
		inplace nvarchar(50),
		outdate nvarchar(10),
		outmoney int,
		outplace nvarchar(50),
		passdate nvarchar(10),
		caryear nvarchar(10),
		ton nvarchar(20),
		carbrandno nvarchar(20),
		carbrand nvarchar(50),
		caryeartw nvarchar(20),
		engineno nvarchar(20),
		passno nvarchar(20),
		weight1 float,
		weight2 float,
		carspecno nvarchar(20),
		carspec nvarchar(20),
		carmode nvarchar(20),
		memo nvarchar(MAX),
		stopdate nvarchar(10),
		wasted nvarchar(10),
		oldcarno nvarchar(10)
)
declare @cmd nvarchar(MAX)

set @cmd='select ''0'' gno,a.noa,a.carno,a.carownerno,b.namea,a.cardealno,isnull(c.nick,''''),b.sex,b.idno,b.birthday,b.tel1, 
b.tel2,b.fax,b.mobile,b.addr_conn,b.addr_home,a.indate,a.inmoney,a.inplace,a.outdate,a.outmoney,a.outplace,a.passdate,a.caryear,a.ton, 
a.carbrandno,isnull(d.brand,''''),a.caryeartw,a.engineno,/*a.passno*/ '''',a.weight1,a.weight2,a.carspecno,f.spec,a.carmode,a.memo, 
ISNULL(a.suspdate,''''),ISNULL(a.enddate,''''),ISNULL(a.oldnoa,'''') 
from car2 a 
left join carowner b on b.noa = a.carownerno 
left join cardeal c on c.noa = a.cardealno 
left join carbrand d on d.noa = a.carbrandno 
left join carspec f on a.carspecno = f.noa 
where a.carno between @t_bcarno and @t_ecarno and a.carownerno!='''' and (a.enddate='''' or a.enddate is null) and (a.outdate='''' or a.outdate is null)'

declare @ssscount int
set @ssscount=0

if(@t_sssno!=char(255))
begin
	while(PATINDEX('%,%',@t_sssno)>0)
	begin
		if (@ssscount=0)
			set @cmd=@cmd+' and (a.sssno='''+LEFT(@t_sssno,PATINDEX('%,%',@t_sssno)-1)+''''
		else
			set @cmd=@cmd+' or a.sssno='''+LEFT(@t_sssno,PATINDEX('%,%',@t_sssno)-1)+''''
		set @t_sssno=RIGHT(@t_sssno,LEN(@t_sssno)-PATINDEX('%,%',@t_sssno))
		set @ssscount=@ssscount+1
	end
	if (@ssscount=0)
		set @cmd=@cmd+' and a.sssno='''+@t_sssno+''''
	else
		set @cmd=@cmd+' or a.sssno='''+@t_sssno+''')'
end

insert into @result 
execute sp_executesql @cmd,N'@t_bcarno nvarchar(20),@t_ecarno nvarchar(20)',
		@t_bcarno=@t_bcarno,@t_ecarno=@t_ecarno

update @result
set sex=(case when sex='M' then '男' else '女' end)

select *
from @result order by noa;
--*****************************************************************************************

z_car29:--z_car29車主擁有車輛
	declare @t_bcardealno nvarchar(20)
	declare @t_ecardealno nvarchar(20)
	declare @t_bcarownerno nvarchar(20)
	declare @t_ecarownerno nvarchar(20)
	declare @t_bcarspecno nvarchar(20)
	declare @t_ecarspecno nvarchar(20)
	declare @t_pdate nvarchar(20)
	declare @t_sssno nvarchar(20)
	declare @t_enddate nvarchar(10)

	set @t_bcardealno = case when '#non'=[5] then '' else [5] end
	set @t_ecardealno  = case when '#non'=[6] then char(255) else [6] end	
	set @t_bcarownerno = case when '#non'=[7] then '' else [7] end
	set @t_ecarownerno  = case when '#non'=[8] then char(255) else [8] end	
	set @t_enddate = case when '#non'=[15] then '' else [15] end
	set @t_bcarspecno = case when '#non'=[21] then '' else [21] end
	set @t_ecarspecno  = case when '#non'=[22] then char(255) else [22] end	
	set @t_pdate = case when '#non'=[23] then '' else [23] end
	set @t_sssno  = case when '#non'=[24] then char(255) else [24] end	
	
declare @result table(
		gno nvarchar(1),
		noa nvarchar(20),
		cardealno nvarchar(20),
		[card] nvarchar(20),
		carno nvarchar(20),
		carownerno nvarchar(20),
		a nvarchar(50),
		b nvarchar(10),
		c nvarchar(10),
		d nvarchar(10),
		h nvarchar(10),
		e nvarchar(10),
		carkindno nvarchar(10),
		f nvarchar(10),
		ton  nvarchar(20),
		carbrandno nvarchar(20),
		g nvarchar(20),
		datea nvarchar(10),
		total float
)

declare @cmd nvarchar(MAX)

set @cmd='select ''0'' gno,a.noa,a.cardealno,ISNULL(c.nick,''''),a.carno,a.carownerno,b.namea,a.indate,a.outdate, 
a.suspdate,a.enddate,a.wastedate,a.carkindno,a.caryear,ISNULL(a.ton,'''')+ISNULL(a.cc,''''),a.carbrandno,isnull(d.brand,''''),isnull(f.bdate,''''),0 
from car2 a 
left join carowner b on b.noa = a.carownerno 
left join cardeal c on c.noa = a.cardealno 
left join carbrand d on d.noa = a.carbrandno 
left join (select * from carInsure where (noa+noq) in(select noa+MAX(noq) from carInsure group by noa)) f on f.noa = a.noa 
where a.indate<=@t_enddate and (a.carownerno between @t_bcarownerno and @t_ecarownerno) and 
(a.cardealno between @t_bcardealno and @t_ecardealno)and 
(a.carspecno between @t_bcarspecno and @t_ecarspecno) and a.carownerno!='''''

if(PATINDEX('%遷出%',@t_pdate)=0)
	set @cmd=@cmd+' and (outdate='''' or outdate is null)'
if(PATINDEX('%報停%',@t_pdate)=0)
	set @cmd=@cmd+' and (a.suspdate='''' or a.suspdate is null)'
if(PATINDEX('%報廢%',@t_pdate)=0)
	set @cmd=@cmd+' and (a.enddate='''' or a.enddate is null)'
if(PATINDEX('%繳銷%',@t_pdate)=0)
	set @cmd=@cmd+' and (a.wastedate='''' or a.wastedate is null)'
declare @ssscount int
set @ssscount=0

if(@t_sssno!=char(255))
begin
	while(PATINDEX('%,%',@t_sssno)>0)
	begin
		if (@ssscount=0)
			set @cmd=@cmd+' and (a.sssno='''+LEFT(@t_sssno,PATINDEX('%,%',@t_sssno)-1)+''''
		else
			set @cmd=@cmd+' or a.sssno='''+LEFT(@t_sssno,PATINDEX('%,%',@t_sssno)-1)+''''
		set @t_sssno=RIGHT(@t_sssno,LEN(@t_sssno)-PATINDEX('%,%',@t_sssno))
		set @ssscount=@ssscount+1
	end
	if (@ssscount=0)
		set @cmd=@cmd+' and a.sssno='''+@t_sssno+''''
	else
		set @cmd=@cmd+' or a.sssno='''+@t_sssno+''')'
end

insert into @result 
execute sp_executesql @cmd,N'@t_enddate nvarchar(10),@t_bcarownerno nvarchar(20),@t_ecarownerno nvarchar(20),@t_bcardealno nvarchar(20),@t_ecardealno nvarchar(20),@t_bcarspecno nvarchar(20),@t_ecarspecno nvarchar(20)',
		@t_enddate=@t_enddate,@t_bcarownerno=@t_bcarownerno,@t_ecarownerno=@t_ecarownerno,@t_bcardealno=@t_bcardealno,@t_ecardealno=@t_ecardealno,@t_bcarspecno=@t_bcarspecno,@t_ecarspecno=@t_ecarspecno

insert into @result
select '1','','','','',carownerno,'','','','','','','','','','','','',count(*)
from @result group by carownerno

select *
from @result
order by carownerno,gno,cardealno,noa;


--*****************************************************************************************

z_car99:
	-- not yet
	declare @t_bmon nvarchar(10)
	declare @t_emon nvarchar(10)
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_bcardealno nvarchar(20)
	declare @t_ecardealno nvarchar(20)
	declare @t_bcarownerno nvarchar(20)
	declare @t_ecarownerno nvarchar(20)
	declare @t_bdriverno nvarchar(20)
	declare @t_edriverno nvarchar(20)
	declare @t_bsssno nvarchar(20)
	declare @t_esssno nvarchar(20)
	declare @t_carteamno nvarchar(2)
	declare @t_carno nvarchar(20)
	declare @t_enddate nvarchar(10)
	
	set @t_bmon = case when '#non'='#non' then '' else '#non' end
	set @t_emon = case when '#non'='#non' then char(255) else '#non' end
	set @t_bdate = case when '#non'='#non' then '' else '#non' end
	set @t_edate = case when '#non'='#non' then char(255) else '#non' end
	set @t_bcardealno = case when '#non'='#non' then '' else '#non' end
	set @t_ecardealno  = case when '#non'='#non' then char(255) else '#non' end	
	set @t_bcarownerno = case when '#non'='#non' then '' else '#non' end
	set @t_ecarownerno  = case when '#non'='#non' then char(255) else '#non' end	
	set @t_bdriverno = case when '#non'='#non' then '' else '#non' end
	set @t_edriverno  = case when '#non'='#non' then char(255) else '#non' end	
	set @t_bsssno = case when '#non'='#non' then '' else '#non' end
	set @t_esssno  = case when '#non'='#non' then char(255) else '#non' end	
	set @t_carteamno = case when '#non'='#non' then '' else '#non' end	
	set @t_carno = case when '#non'='#non' then '' else '#non' end		
	set @t_enddate = case when '#non'='#non' then '' else '#non' end	
	
	declare @tmp table(
		gno nvarchar(1),
		車牌 nvarchar(20),
		車主 nvarchar(20),
		車行 nvarchar(20),
		欠款金額 int,
		過入日 nvarchar(1),
		廠牌 nvarchar(20),
		電話 nvarchar(20),
		行動 nvarchar(20)
	)	
	
	insert into @tmp
		select 
			'0' gno
		from borrs a
		left join borr b on a.noa = b.noa
		left join car2 c on b.carno = c.noa 
		left join cardeal d on c.cardealno = d.noa
		left join carOwner e on c.carownerno = e.noa
		left join carbrand f on c.carbrandno = f.noa
		where (len(@t_carno)=0 or b.carno=@t_carno)and
		      (c.cardealno between @t_bcardealno and @t_ecardealno) and
		      (c.carownerno between @t_bcarownerno and @t_ecarownerno)
	;
	------------------------------------------------------------------------------------------------
z_car30:--z_car30	
declare @t_bcardealno nvarchar(20)
declare @t_ecardealno nvarchar(20)
declare @t_xmon nvarchar(20)
set @t_bcardealno = case when '#non' = [5] then '' else [5] end
set @t_ecardealno = case when '#non' = [6] then CHAR(255) else [6] end
set @t_xmon = case when '#non' = [18] then '' else [18] end
--************************************************************************
SET QUOTED_IDENTIFIER OFF

declare @tmpa table( 
gno nvarchar(1),  
cardealno nvarchar(20), 
cardeal nvarchar(50), 
total float ,
mon nvarchar(10)
) 

insert into @tmpa 
select '0' gno,b.cardealno,c.comp,sum(a.paytotal),@t_xmon
from cara a 
left join car2 b on a.carno = b.noa 
left join cardeal c on b.cardealno = c.noa 
where @t_xmon = a.mon and
(b.cardealno between @t_bcardealno and @t_ecardealno)
group by  b.cardealno,c.comp

--20130327加入vcc未付金額
--declare @cmd nvarchar(MAX)
--declare @cardealno nvarchar(50)
--declare @unpay float
--set @cmd="
--	declare cursor_table cursor for
--	select cardealno,sum(unpay) unpay from (
--	select b.cardealno cardealno,isnull(a.total-a.payed,0) unpay 
--	from vcc"+left(@t_xmon,3)+" a left join car2 b on 
--	(case when (select count(*) from car2 where noa=substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)))>0
--	then substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo))else
--	(select top 1 carno from cara c where mon<=left(a.carno,6) and a.custno=c.carownerno order by mon desc,carno)end)=b.noa 
--	left join carbrand d on b.carbrandno=d.noa 
--	left join carOwner e on a.custno=e.noa 
--	where left(a.custno,1)='H' and b.cardealno!='' and (left(a.carno,6) <= '"+@t_xmon+"')) a group by cardealno"
--	execute sp_executesql @cmd
--open cursor_table 
--fetch next from cursor_table 
--into @cardealno,@unpay
--while(@@FETCH_STATUS <> -1) 
--	begin 
--		update @tmpa
--		set total=total+@unpay
--		where cardealno=@cardealno
		
--		fetch next from cursor_table 
--		into @cardealno,@unpay
--	end 
--close cursor_table 
--deallocate cursor_table 

insert into @tmpa
select '1' gno,'','',SUM(total) ,@t_xmon
from @tmpa

select gno,cardealno,cardeal,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total),1)),4,12)) total,mon
from @tmpa
order by gno,cardealno;
-----------------------------------------------------------------------------------------
z_car31:--z_car31
declare @t_bdate nvarchar(20)
declare @t_edate nvarchar(20)
declare @t_sssno nvarchar(20)
set @t_bdate = case when '#non' = [3] then '' else [3] end
set @t_edate = case when '#non' = [4] then CHAR(255) else [4] end
set @t_sssno  = case when '#non'=[24] then char(255) else [24] end
declare @tmp table(
        gno nvarchar(1), 
        datea nvarchar(20),
        carno nvarchar(20),
        carowner nvarchar(50),
        insurer nvarchar(50),
        moneys float,
        insuresheet nvarchar(20),
        insurecard nvarchar(20)
)
declare @cmd nvarchar(MAX)

set @cmd='select ''0'' gno,a.edate,a.noa,c.namea,a.insurer,a.money,a.insuresheet,a.insurecard 
from carInsure a left join car2 b on a.noa = b.noa left join carOwner c on c.noa = b.carownerno 
where (a.edate >= @t_bdate and a.edate <= @t_edate) and (b.outdate is null or b.outdate='''') and b.carownerno!='''' and (b.enddate='''' or b.enddate is null)'

declare @ssscount int
set @ssscount=0

if(@t_sssno!=char(255))
begin
	while(PATINDEX('%,%',@t_sssno)>0)
	begin
		if (@ssscount=0)
			set @cmd=@cmd+' and (b.sssno='''+LEFT(@t_sssno,PATINDEX('%,%',@t_sssno)-1)+''''
		else
			set @cmd=@cmd+' or b.sssno='''+LEFT(@t_sssno,PATINDEX('%,%',@t_sssno)-1)+''''
		set @t_sssno=RIGHT(@t_sssno,LEN(@t_sssno)-PATINDEX('%,%',@t_sssno))
		set @ssscount=@ssscount+1
	end
	if (@ssscount=0)
		set @cmd=@cmd+' and b.sssno='''+@t_sssno+''''
	else
		set @cmd=@cmd+' or b.sssno='''+@t_sssno+''')'
end

insert into @tmp 
execute sp_executesql @cmd,N'@t_bdate nvarchar(20),@t_edate nvarchar(20)',
		@t_bdate=@t_bdate,@t_edate=@t_edate
		
insert into @tmp 
select '1' gno,'','','','',SUM(moneys),'','' 
from @tmp 

select gno,datea,carno,carowner,insurer, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,moneys),1)),4,12)) moneys, 
insuresheet,insurecard 
from @tmp order by gno,datea;
------------------------------------------------------------------------------
z_car32:--z_car32
declare @t_binsurerno nvarchar(20)
declare @t_einsurerno nvarchar(20)
declare @t_bdate nvarchar(20)
declare @t_edate nvarchar(20)
declare @t_sssno nvarchar(20)
set @t_binsurerno = case when '#non' = [19] then '' else [19] end
set @t_einsurerno = case when '#non' = [20] then CHAR(255) else [20] end
set @t_bdate = case when '#non' = [3] then '' else [3] end
set @t_edate = case when '#non' = [4] then CHAR(255) else [4] end
set @t_sssno  = case when '#non'=[24] then char(255) else [24] end
declare @tmp table(
		gno nvarchar(20),
		xinsurerno nvarchar(20),
		insurer nvarchar(50),
		carno nvarchar(20),
		carowner nvarchar(50),
		datea nvarchar(20),
		moneys float,
		kind nvarchar(20),
		recno float
)

declare @cmd nvarchar(MAX)

set @cmd='select ''0'' gno,a.insurerno,a.insurer,a.noa,c.namea,a.edate,a.money,a.kind,ROW_NUMBER()over(PARTITION BY a.insurer order by a.noa) recno 
from carInsure a 
left join car2 b on a.noa = b.noa 
left join carOwner c on c.noa = b.carownerno 
where (a.edate >= @t_bdate and a.edate <= @t_edate) and 
(a.insurerno between @t_binsurerno and @t_einsurerno) and b.carownerno!='''' and (b.enddate='''' or b.enddate is null) and (b.outdate='''' or b.outdate is null)'

declare @ssscount int
set @ssscount=0

if(@t_sssno!=char(255))
begin
	while(PATINDEX('%,%',@t_sssno)>0)
	begin
		if (@ssscount=0)
			set @cmd=@cmd+' and (b.sssno='''+LEFT(@t_sssno,PATINDEX('%,%',@t_sssno)-1)+''''
		else
			set @cmd=@cmd+' or b.sssno='''+LEFT(@t_sssno,PATINDEX('%,%',@t_sssno)-1)+''''
		set @t_sssno=RIGHT(@t_sssno,LEN(@t_sssno)-PATINDEX('%,%',@t_sssno))
		set @ssscount=@ssscount+1
	end
	if (@ssscount=0)
		set @cmd=@cmd+' and b.sssno='''+@t_sssno+''''
	else
		set @cmd=@cmd+' or b.sssno='''+@t_sssno+''')'
end

insert into @tmp 
execute sp_executesql @cmd,N'@t_bdate nvarchar(20),@t_edate nvarchar(20),@t_binsurerno nvarchar(20),@t_einsurerno nvarchar(20)',
		@t_bdate=@t_bdate,@t_edate=@t_edate,@t_binsurerno=@t_binsurerno,@t_einsurerno=@t_einsurerno

insert into @tmp
select '1' gno,xinsurerno,'','','','',SUM(moneys),'',max(recno)
from @tmp
group by xinsurerno

select gno,xinsurerno,insurer,carno,carowner,datea,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,moneys),1)),4,12)) moneys,
kind,recno
from @tmp
order by xinsurerno,gno,carno,datea;
------------------------------------------------------------------------------
z_car33:--z_car33
	declare @t_bcarownerno nvarchar(20)
	declare @t_ecarownerno nvarchar(20)
	declare @t_enddate nvarchar(10)
	
	set @t_bcarownerno = case when '#non'=[7] then '' else [7] end
	set @t_ecarownerno  = case when '#non'=[8] then char(255) else [8] end	
	set @t_enddate = case when '#non'=[15] then '' else [15] end

	declare @tmp table( 
		cardealno nvarchar(20), 
		cardeal nvarchar(50), 
		carownerno nvarchar(20), 
		carowner nvarchar(50), 
		lenderno nvarchar(20), 
		lender nvarchar(50), 
		money int, 
		installmentamount int, 
		installment int, 
		bkmoney int, 
		surplusment int, 
		surplusmoney int, 
		bdate nvarchar(50), 
		edate nvarchar(50), 
		memo nvarchar(MAX), 
		carnos nvarchar(MAX) 
	) 
	--case說明--如果貸款止日>截止日期表示還沒還清否則已還清，沒有還清則計算剩餘還款期數(如果今天日期<計日，表示當期還沒還款，所以+1) 
	insert into @tmp 
		select a.cardealno,a.cardeal,a.noa,b.namea,a.lenderno,a.lender,a.money,a.installmentamount,a.installment,a.bkmoney, 
		case when a.edate > @t_enddate then 
		(left(a.edate,3)*12+right(left(a.edate,6),2))-(left(@t_enddate,3)*12+right(left(@t_enddate,6),2))+(case when right(@t_enddate,2)<=a.day then 1 else 0 end) else 0 end surplusment, 
		0 surplusmoney,a.bdate,a.edate,a.memo,a.carnos 
		from carLender a left join carOwner b on a.noa=b.noa 
		order by a.noa 
	
	--計算貸款餘額 
	update @tmp 
	set surplusmoney=surplusment*installmentamount 
	where surplusment>0 
	
	declare @tmpa table( 
		gno nvarchar(20), 
		carownerno nvarchar(20), 
		typea nvarchar(20), 
		asset nvarchar(100),
		gdate nvarchar(10),
		dmoney int, 
		cmoney int,  
		fdate nvarchar(10),
		memo nvarchar(MAX),
		total int
	) 
	insert into @tmpa
	select '0',noa ,typea,asset,getdate,money,null,fdate,memo,0
	from balance
	union all
	select '0',carownerno,'車輛'typea,noa,indate,cast(round(inmoney*POWER(0.800,((left(@t_enddate,3)*12)+right(left(@t_enddate,6),2))-(left(indate,3)*12+right(left(indate,6),2))),0) as int),
	(select total from cara where carno=car2.noa and carno+mon in (select carno+MAX(mon) from cara where carno=car2.noa group by carno)),@t_enddate,memo,0
	from car2 where outdate='' or (select total from cara where carno=car2.noa and carno+mon in (select carno+MAX(mon) from cara where carno=car2.noa group by carno))!=0
	and carownerno between @t_bcarownerno and @t_ecarownerno
	--where indate!='' and inmoney>0
	union all
	select '0',carownerno,'貸款'typea,carnos,bdate,null,surplusmoney,edate,memo,0
	from @tmp
	union all
	select '0',compno,'未兌現票據',gqbno,datea,0,money,indate,memo,0 from gqb
	where left(compno,1)='H' and (len(enda)=0 or enda is null or enda ='N' or enda='n') and len(indate)=9 and typea!='3'
	and (left(right('0'+CONVERT (nvarchar(7),CONVERT (VARCHAR(7),dateadd(d,-5,CONVERT(datetime ,CONVERT(nvarchar(10),CONVERT(int,left(@t_enddate,3))+1911)+right(left(@t_enddate,6),2)+right(left(@t_enddate,9),2)) ),12 )+0890000),7),3)+'/'
	+right(left(right('0'+CONVERT (nvarchar(7),CONVERT (VARCHAR(7),dateadd(d,-5,CONVERT(datetime ,CONVERT(nvarchar(10),CONVERT(int,left(@t_enddate,3))+1911)+right(left(@t_enddate,6),2)+right(left(@t_enddate,9),2)) ),12 )+0890000),7),5),2)+'/'
	+right(right('0'+CONVERT (nvarchar(7),CONVERT (VARCHAR(7),dateadd(d,-5,CONVERT(datetime ,CONVERT(nvarchar(10),CONVERT(int,left(@t_enddate,3))+1911)+right(left(@t_enddate,6),2)+right(left(@t_enddate,9),2)) ),12 )+0890000),7),2))<=indate
	union all
	select '0',custno,'借支',noa,begindate,0,unpay,enddate,memo,0 from borr 
	where unpay!=0  and custno in(select noa from carOwner) and custno!=''
	order by noa
	
	insert into @tmpa
	select '1',carownerno,'','','',SUM(dmoney),SUM(cmoney),'','',isnull(SUM(dmoney),0)-isnull(SUM(cmoney),0)
	from @tmpa
	group by carownerno
	
	select a.gno,a.carownerno,a.typea,a.asset,a.gdate,a.fdate,a.memo,b.namea
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.dmoney),1)),4,12)) dmoney
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.cmoney),1)),4,12)) cmoney
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.total),1)),4,12)) total
	from @tmpa a left join carOwner b on a.carownerno=b.noa
	where a.carownerno between @t_bcarownerno and @t_ecarownerno and a.carownerno!=''
	order by carownerno,gno;
	
--**************************************************************************************************
z_car34:--z_car34
	declare @t_bcardealno nvarchar(20)
	declare @t_ecardealno nvarchar(20)
	declare @t_bcarspecno nvarchar(20)
	declare @t_ecarspecno nvarchar(20)
	
	set @t_bcardealno = case when '#non'=[5] then '' else [5] end
	set @t_ecardealno  = case when '#non'=[6] then char(255) else [6] end	
	set @t_bcarspecno = case when '#non'=[21] then '' else [21] end
	set @t_ecarspecno  = case when '#non'=[22] then char(255) else [22] end	
--*********************************************************************************** 
declare @tmp table( 
	gno nvarchar(1), 
	cardealno nvarchar(20), 
	cardeal nvarchar(50), 
	recno int, 
	carno nvarchar(20), 
	carspecno nvarchar(20), 
	carspec nvarchar(50), 
	engineno nvarchar(50), 
	memo nvarchar(MAX) 
) 

declare @gno nvarchar(1)
declare @cardealno nvarchar(20)
declare @cardeal nvarchar(50)
declare @carno nvarchar(20)
declare @carspecno nvarchar(20)
declare @carspec nvarchar(50) 
declare @engineno nvarchar(50)

declare @recno int
declare @t_cardealno nvarchar(20) 
set @t_cardealno='XXXXXXX' 
set @gno=1

declare @now_date nvarchar(10)--前一年現在日期
set @now_date=CONVERT (VARCHAR(7), DATEADD(YEAR,-1,GETDATE()),12 )+0890000
set @now_date=left(@now_date,3)+'/'+substring(@now_date,4,2)+'/'+right(@now_date,2)

--特殊！報停一年內的車也要印出
declare cursor_table cursor for 
select a.cardealno,b.comp,a.carno,a.carspecno,c.spec,a.engineno
from car2 a left join cardeal b on a.cardealno=b.noa 
left join carspec c on a.carspecno=c.noa 
where a.carownerno!='' and (a.enddate='' or a.enddate is null) and (a.outdate='' or a.outdate is null) and a.cardealno!='' and a.carspecno!=''
and (a.suspdate='' or a.suspdate is null or a.suspdate> @now_date)
and (a.cardealno between @t_bcardealno and @t_ecardealno) and (a.carspecno between @t_bcarspecno and @t_ecarspecno) 
order by cardealno,carspecno  
open cursor_table 
fetch next from cursor_table 
into @cardealno,@cardeal,@carno,@carspecno,@carspec,@engineno
while(@@FETCH_STATUS <> -1) 
	begin 
	if(@t_cardealno!=@cardealno) 
	begin 
		
		if(@t_cardealno!='XXXXXXX' and @gno!=1)
		begin
			while((@recno-1)%30!=0)
			begin
				insert into @tmp
				select '0'gno,@t_cardealno,'',@recno,'','','','',''
				set @recno=@recno+1
			end
			insert into @tmp 
			select '1'gno,@t_cardealno,'',null,'','','','',''
		end
		set @recno=1 
		set @t_cardealno=@cardealno 
	end 

	insert into @tmp 
	select '0',@cardealno,@cardeal,@recno,@carno,@carspecno,@carspec,@engineno,''
	
	set @gno=0

	if(@recno%30=0)
	begin
		insert into @tmp 
		select '1'gno,@cardealno,'',null,'','','','',''
		set @gno=1
	end

	set @recno=@recno+1 

	fetch next from cursor_table 
	into @cardealno,@cardeal,@carno,@carspecno,@carspec,@engineno
	end 
close cursor_table 
deallocate cursor_table 
--********************最後一筆****************************
	if(@t_cardealno!='XXXXXXX')
	begin
			while((@recno-1)%30!=0)
			begin
				insert into @tmp
				select '0'gno,@t_cardealno,'',@recno,'','','','',''
				set @recno=@recno+1
			end
			insert into @tmp 
			select '1'gno,@t_cardealno,'',null,'','','','',''
		end
--******************************************************
select * from @tmp;
----------------------------------------------------
z_cara1:--z_cara1車主欠款明細
SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	declare @t_pagecount int
	declare @pagecount int
	declare @t_bmon nvarchar(10)
	declare @t_emon nvarchar(10)
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_bcarownerno nvarchar(20)
	declare @t_ecarownerno nvarchar(20)
	declare @t_bcarno nvarchar(20)
	declare @t_ecarno nvarchar(20)
	declare @t_xcarnos nvarchar(MAX) 
	declare @sql_carnos nvarchar(MAX)
	declare @t_xmemo nvarchar(MAX) 
	declare @xyear nvarchar(20)
	declare @iacc nvarchar(20)
	
	set @pageCount = 16
	set @t_bmon = case when '#non'=[1] then '' else [1] end
	set @t_emon = case when '#non'=[2] then char(255) else [2] end
	set @t_bdate = case when '#non'=[3] then '' else [3] end
	set @t_edate = case when '#non'=[4] then char(255) else [4] end	
	set @t_bcarownerno = case when '#non'=[7] then '' else [7] end
	set @t_ecarownerno  = case when '#non'=[8] then char(255) else [8] end	
	set @t_bcarno = case when '#non'=[16] then '' else [16] end
	set @t_ecarno = case when '#non'=[17] then CHAR(255) else [17] end
	set @t_xcarnos = case when '#non'=[25] then '' else [25] end
	set @sql_carnos=''
	set @t_xmemo  = case when '#non'=[30] then '' else [30] end
	set @xyear='[38]'
	set @iacc=case when '#non'=[39] then '' else [39] end
	
if(RIGHT(@t_xcarnos,1)='.')
set @t_xcarnos=left(@t_xcarnos,len(@t_xcarnos)-1)
	
while(LEN(@t_xcarnos)>0)
begin
	if(CHARINDEX('.',@t_xcarnos)=0)
	begin
		set @sql_carnos=@sql_carnos+' b.carno='''+@t_xcarnos+''' and'
		set @t_xcarnos=''
	end
	if(CHARINDEX('.',@t_xcarnos)>0)
	begin
		set @sql_carnos=@sql_carnos+' b.carno='''+left(@t_xcarnos,CHARINDEX('.',@t_xcarnos)-1)+''' or'
		set @t_xcarnos=RIGHT(@t_xcarnos,LEN(@t_xcarnos)-CHARINDEX('.',@t_xcarnos))
	end
end


declare @tmp table( 
	[gno] nvarchar(1), 
	[noa] nvarchar(30), 
	[noq] nvarchar(20), 
	[carno] nvarchar(20), 
	[carownerno] nvarchar(20), 
	[carowner] nvarchar(50), 
	[indate] nvarchar(10), 
	[carbrandno] nvarchar(20), 
	[carbrand] nvarchar(50), 
	[caryear] nvarchar(10), 
	[mobile] nvarchar(50), 
	[caritemno] nvarchar(50), 
	[caritem] nvarchar(50), 
	[mon] nvarchar(20), 
	[datea] nvarchar(20), 
	[memo] nvarchar(max), 
	[outmoney] int, 
	[inmoney] int, 
	[total] int, 
	primary key (carownerno,carno,noa,noq,gno) 
)

declare @tmpa table( 
	[gno] nvarchar(1), 
	[noa] nvarchar(30), 
	[noq] nvarchar(20), 
	[carno] nvarchar(20), 
	[carownerno] nvarchar(20), 
	[carowner] nvarchar(50), 
	[indate] nvarchar(10), 
	[carbrandno] nvarchar(20), 
	[carbrand] nvarchar(50), 
	[caryear] nvarchar(10), 
	[mobile] nvarchar(50), 
	[caritemno] nvarchar(50), 
	[caritem] nvarchar(50), 
	[mon] nvarchar(20), 
	[datea] nvarchar(20), 
	[memo] nvarchar(max), 
	[outmoney] int, 
	[inmoney] int, 
	[total] int, 
	[count] int,
	[xmemo] nvarchar(max)
) 

declare @tmpb table( 
	[gno] nvarchar(1),
	[noa] nvarchar(30), 
	[noq] nvarchar(20), 
	[carno] nvarchar(20), 
	[carownerno] nvarchar(20), 
	[carowner] nvarchar(50), 
	[indate] nvarchar(10), 
	[carbrandno] nvarchar(20), 
	[carbrand] nvarchar(50), 
	[caryear] nvarchar(10), 
	[mobile] nvarchar(50), 
	[caritemno] nvarchar(50), 
	[caritem] nvarchar(50), 
	[mon] nvarchar(20), 
	[datea] nvarchar(20), 
	[memo] nvarchar(max), 
	[outmoney] int, 
	[inmoney] int, 
	[total] int
) 

declare @gno nvarchar(1) 
declare @noa nvarchar(20) 
declare @noq nvarchar(3) 
declare @carno nvarchar(20)
declare @carownerno nvarchar(20) 
declare @carowner nvarchar(50)
declare @indate nvarchar(20) 
declare @carbrandno nvarchar(20)
declare @carbrand nvarchar(50)
declare @caryear nvarchar(20)
declare @mobile nvarchar(50)
declare @caritemno nvarchar(50)
declare @caritem nvarchar(50)
declare @mon nvarchar(10)
declare @datea nvarchar(10)
declare @memo nvarchar(Max)
declare @outmoney int 
declare @inmoney int 
declare @total int 

set @cmd =	"select a.*,0 "+ 
" from( " + 
"select '0' gno,a.noa ,a.noq,b.carno,isNull(c.carownerno,'') carownerno,isNull(d.namea,'') carowner,ISNULL(c.indate,'') indate, "+ 
"ISNULL(e.noa,'') carbrandno,ISNULL(e.brand,'') carbrand,ISNULL(c.caryear,'') caryear,ISNULL(d.mobile,'') mobile, "+ 
"a.caritemno ,a.caritem ,b.mon,a.datea,a.memo,a.outmoney,a.inmoney "+ 
"from caras a "+ 
"left join cara b on b.noa = a.noa "+ 
"left join car2 c on c.noa = b.carno "+ 
"left join carOwner d on d.noa = c.carownerno "+ 
"left join carbrand e on e.noa = c.carbrandno "+ 
" where "+ 
"(b.carno between @t_bcarno and @t_ecarno) and "+ 
"(c.carownerno between @t_bcarownerno and @t_ecarownerno) and "+ 
"(b.mon between @t_bmon and @t_emon) and"+ 
"("+@sql_carnos+" 1=1)"+
" ) a" 

--全部費用
insert into @tmp 
execute sp_executesql @cmd,N'@t_bcarno nvarchar(20),@t_ecarno nvarchar(20),@t_bcarownerno nvarchar(20),@t_ecarownerno nvarchar(20), 
@t_bmon nvarchar(10),@t_emon nvarchar(10)', 
@t_bcarno = @t_bcarno,@t_ecarno = @t_ecarno,@t_bcarownerno=@t_bcarownerno,@t_ecarownerno=@t_ecarownerno, 
@t_bmon=@t_bmon,@t_emon=@t_emon 

--1020312更新加入VCCTRAN的車主資料 --1020410加入判斷是否要顯示內帳(VCC)資料
if(left(@t_bmon,3)>='101' and @iacc='顯示')
begin
	--set @cmd="
	--select '0'gno,(select top 1 carno from cara c where mon<=left(a.carno,6) and a.custno=c.carownerno order by carno )+'-'+left(a.carno,6) noa 
	--,'999' noq 
	--,(select top 1 carno from cara c where mon<=left(a.carno,6) and a.custno=c.carownerno order by carno )carno 
	--,a.custno carownerno,a.comp carowner,b.indate,b.carbrandno,d.brand,b.caryear,e.mobile,'' caritemno,'請款' caritem 
	--,left(a.carno,6) mon,a.carno,a.memo memo,a.total outmoney ,0 inmoney,0 
	--from vcc"+left(@t_bmon,3)+" a left join car2 b on 
	--(select top 1 carno from cara c where mon<=left(a.carno,6) and a.custno=c.carownerno order by carno ) =b.noa 
	--left join carbrand d on b.carbrandno=d.noa 
	--left join carOwner e on a.custno=e.noa 
	--where left(a.custno,1)='H' and (left(a.carno,6) between '"+@t_bmon+"' and '"+@t_emon+"') 
	--and (select top 1 carno from cara c where mon<=left(a.carno,6) and a.custno=c.carownerno order by carno ) between '"+@t_bcarno+"' and '"+@t_ecarno+"'
	--and carownerno between '"+@t_bcarownerno+"' and '"+@t_ecarownerno+"'
	--and ("+@sql_carnos+" 1=1)
	--order by noa"
	
	set @cmd=" 
	select '0'gno,
	(case when (select count(*) from car2 where noa=substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)))>0
	then substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo))else
	(select top 1 carno from cara c where mon<=left(a.carno,6) and a.custno=c.carownerno order by mon desc,carno)end)
	+'-'+left(a.carno,6) noa 
	,'999' noq 
	,(case when (select count(*) from car2 where noa=substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)))>0
	then substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo))else
	(select top 1 carno from cara c where mon<=left(a.carno,6) and a.custno=c.carownerno order by mon desc,carno)end)carno 
	,a.custno carownerno,a.comp carowner,b.indate,b.carbrandno,d.brand,b.caryear,e.mobile,'' caritemno,(case when CHARINDEX('理賠',a.memo)>0 then '*其他' when CHARINDEX('請款',a.memo)>0 then '*請款' else '*發票稅費' end) caritem 
	,left(a.carno,6) mon,a.carno,a.memo memo,a.total outmoney ,a.payed inmoney,0 
	from view_vcc"+@xyear+" a left join car2 b on 
	(case when (select count(*) from car2 where noa=substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)))>0
	then substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo))else
	(select top 1 carno from cara c where mon<=left(a.carno,6) and a.custno=c.carownerno order by mon desc,carno)end) =b.noa 
	left join carbrand d on b.carbrandno=d.noa 
	left join carOwner e on a.custno=e.noa 
	where left(a.custno,1)='H' and (left(a.carno,6) between '"+@t_bmon+"' and '"+@t_emon+"') 
	and (case when (select count(*) from car2 where noa=substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)))>0
	then substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo))else
	(select top 1 carno from cara c where mon<=left(a.carno,6) and a.custno=c.carownerno order by mon desc,carno)end) between '"+@t_bcarno+"' and '"+@t_ecarno+"' 
	and carownerno between '"+@t_bcarownerno+"' and '"+@t_ecarownerno+"' 
	and ("+@sql_carnos+" 1=1) 
	order by noa"

	insert into @tmpb
	execute sp_executesql @cmd

	--插入tmpb(vcctran)
	declare cursor_table cursor for 
	select * from @tmpb 
	--where noa in(select noa from @tmp group by noa)
	open cursor_table 
	fetch next from cursor_table 
	into @gno,@noa,@noq,@carno,@carownerno,@carowner,@indate,@carbrandno,@carbrand,@caryear,@mobile,@caritemno,@caritem,@mon,@datea,@memo,@outmoney,@inmoney,@total 
	while(@@FETCH_STATUS <> -1) 
	begin 
	
	insert into @tmp 
	select @gno,@noa,(select right('00'+cast((cast(isnull(MAX(noq),0) as int)+1)as nvarchar(3)),3) from @tmp where noa=@noa),@carno,@carownerno,@carowner,@indate,@carbrandno,@carbrand,@caryear,@mobile,@caritemno,@caritem,@mon,@datea,@memo,@outmoney,@inmoney,@total  
	
	fetch next from cursor_table 
	into @gno,@noa,@noq,@carno,@carownerno,@carowner,@indate,@carbrandno,@carbrand,@caryear,@mobile,@caritemno,@caritem,@mon,@datea,@memo,@outmoney,@inmoney,@total 
	end 
	close cursor_table 
	deallocate cursor_table 
end

--月小計
insert into @tmp 
select '2',noa,'',carno,carownerno,'','','','','','','','',mon,'','',SUM(outmoney),SUM(inmoney),0 from @tmp group by noa,carownerno,carno,mon

--累計
insert into @tmp 
select '3','','',carno,carownerno,'','','','','','','','','999/99','','',SUM(outmoney),SUM(inmoney),0 from @tmp 
where gno='2'
group by carownerno,carno

--欠款累計 --20130119改成最後一個月cara的金額合計(檢查是否結轉正確)
insert into @tmp 
select '4',a.noa,'',a.carno,b.carownerno,a.carowner,b.indate,b.carbrandno,d.brand,b.caryear,c.mobile,'','','999/99',a.datea,'',0,0,a.total
from cara a
left join car2 b on b.noa = a.carno
left join carOwner c on c.noa = b.carownerno 
left join carbrand d on d.noa = b.carbrandno
where a.carno in(select carno from @tmp group by carno) and mon=@t_emon
--插入沒有欠款累計
insert into @tmp 
select '4','','',b.noa,b.carownerno,c.namea,b.indate,b.carbrandno,d.brand,b.caryear,c.mobile,'','','999/99','','',0,0,0
from car2 b 
left join carOwner c on c.noa = b.carownerno 
left join carbrand d on d.noa = b.carbrandno 
where b.noa in(select carno from @tmp where carno not in (select carno from @tmp where gno='4' group by carno)group by carno)

-----------------------------------------------------------------------------------------------
declare @count int 
declare @t_total int 
declare @t_outmoney int 
declare @t_inmoney int
declare @t_carownerno nvarchar(20)
declare @x_total int
declare @x_count int
declare @unpay int

set @count=1
declare @t_carno nvarchar(20)
set @t_carno='XXXX'
declare @t_mon nvarchar(10)
set @t_mon='001/01/01'
set @t_total=0
set @t_outmoney=0
set @t_inmoney=0
set @t_carownerno='ZZZZ'
set @x_total =0
set @x_count =0
set @t_pagecount=1
set @unpay=0

declare cursor_table cursor for 
select * from @tmp order by carownerno,carno,mon,gno,datea,noq
open cursor_table 
fetch next from cursor_table 
into @gno,@noa,@noq,@carno,@carownerno,@carowner,@indate,@carbrandno,@carbrand,@caryear,@mobile,@caritemno,@caritem,@mon,@datea,@memo,@outmoney,@inmoney,@total
while(@@FETCH_STATUS <> -1) 
	begin 
		if(@carownerno!=@t_carownerno and @t_carownerno!='ZZZZ')
		begin
			if((@t_pagecount+1)%@pageCount=1)
				begin
					insert into @tmpa
					select '8','','','',@t_carownerno,'','','','','','','','','','','',@x_count,0,@x_total,@count,@t_xmemo
				end
			else
				begin
					insert into @tmpa
					select '5','','','',@t_carownerno,'','','','','','','','','','','',@x_count,0,@x_total,@count,''
				end
			set @x_total =0
			set @x_count =0
			set @count=@count+1
			set @t_pagecount=@t_pagecount+1
			
			while (@t_pagecount%@pageCount>1 )
			begin
				insert into @tmpa
				select '6','','','',@t_carownerno,'','','','','','','','','','','',@x_count,0,@x_total,@count,''
				set @count=@count+1
				set @t_pagecount=@t_pagecount+1
			end
			
			if(@t_pagecount%@pageCount!=1)
			begin
				insert into @tmpa
				select '7','','','',@t_carownerno,'','','','','','','','','','','',@x_count,0,@x_total,@count,@t_xmemo
				set @count=@count+1
				set @t_pagecount=1
			end
		end
		
		if(@t_mon!=@mon)
		begin
			set @t_outmoney=0
			set @t_inmoney=0
		end
	
		--插入gno1-廠牌年份....等資料
		if(@t_carno!=@carno)
		begin
			insert into @tmpa
			select '1','','',@carno,@carownerno,@carowner,@indate,@carbrandno,@carbrand,@caryear,@mobile,'','',@mon,'','',0,0,0,@count,''
			
			set @t_carno=@carno
			set @count=@count+1
			set @t_pagecount=@t_pagecount+1
			set @unpay=0
			
			if(left(@t_bmon,3)>='101' and @iacc='顯示')
			begin
				--求得開始月份之前的未付金額
				set @cmd=" 
				set @unpay =isnull((select
				sum(a.total-a.payed) unpay 
				from view_vcc"+@xyear+" a left join car2 b on 
				(case when (select count(*) from car2 where noa=substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)))>0
				then substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo))else
				(select top 1 carno from cara c where mon<=left(a.carno,6) and a.custno=c.carownerno order by mon desc,carno)end) =b.noa 
				left join carbrand d on b.carbrandno=d.noa 
				left join carOwner e on a.custno=e.noa 
				where left(a.custno,1)='H' and (left(a.carno,6) < '"+@t_bmon+"') 
				and (case when (select count(*) from car2 where noa=substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)))>0
				then substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo))else
				(select top 1 carno from cara c where mon<=left(a.carno,6) and a.custno=c.carownerno order by mon desc,carno)end) = '"+@carno+"'),0)"
				execute sp_executesql @cmd,N'@unpay float OUTPUT', @unpay OUTPUT
			end
			
			set @t_total=isnull(@outmoney,0)-isnull(@inmoney,0)+@unpay
			
			--印出車牌和車主
			insert into @tmpa
			select @gno,@noa,@noq,@carno,@carownerno,@carowner,@indate,@carbrandno,@carbrand,@caryear,@mobile,@caritemno,@caritem,@mon,@datea,@memo,@outmoney+@unpay,@inmoney,@t_total,@count,''
			set @count=@count+1
			set @t_pagecount=@t_pagecount+1
			set @t_outmoney=@t_outmoney+@outmoney
			set @t_inmoney=@t_inmoney+@inmoney
		end
		else
		begin
			--之後的資料不印出001
			if(@caritemno!='001')
			begin
				--計算餘額和欠款累計
				if(@gno='0')
				begin
					set @t_total=@t_total+isnull(@outmoney,0)-isnull(@inmoney,0)
					set @t_outmoney=@t_outmoney+@outmoney
					set @t_inmoney=@t_inmoney+@inmoney
				end
				
				if(@gno='2')
				begin
					insert into @tmpa
					select @gno,@noa,@noq,@carno,@carownerno,'',@indate,@carbrandno,@carbrand,@caryear,@mobile,@caritemno,@caritem,@mon,@datea,@memo,@t_outmoney+@unpay,@t_inmoney,@t_total,@count,''
					set @count=@count+1
					set @t_pagecount=@t_pagecount+1
				end
				else if(@gno='3')
				begin
					insert into @tmpa
					select @gno,@noa,@noq,@carno,@carownerno,'',@indate,@carbrandno,@carbrand,@caryear,@mobile,@caritemno,@caritem,@mon,@datea,@memo,@outmoney+@unpay,@inmoney,@t_total,@count,''
					set @count=@count+1
					set @t_pagecount=@t_pagecount+1
				end
				else
				begin
					if(@gno='0' and @t_pagecount%@pageCount=1)
						begin
							insert into @tmpa
							select @gno,@noa,@noq,@carno,@carownerno,@carowner,@indate,@carbrandno,@carbrand,@caryear,@mobile,@caritemno,@caritem,@mon,@datea,@memo,@outmoney,@inmoney,@t_total,@count,''
						end
					else
						begin
							if(@gno='4')--20130119改成最後一個月cara的金額合計(檢查是否結轉正確)--20130312應加入VCC資料會造成金額不正確所以拿掉
							begin
								insert into @tmpa
								select @gno,@noa,@noq,'',@carownerno,'',@indate,@carbrandno,@carbrand,@caryear,@mobile,@caritemno,@caritem,@mon,@datea,@memo,@outmoney,@inmoney,@t_total,@count,''
								--select @gno,@noa,@noq,'',@carownerno,'',@indate,@carbrandno,@carbrand,@caryear,@mobile,@caritemno,@caritem,@mon,@datea,@memo,@outmoney,@inmoney,@total,@count,''
							end
							else
							begin
								insert into @tmpa
								select @gno,@noa,@noq,'',@carownerno,'',@indate,@carbrandno,@carbrand,@caryear,@mobile,@caritemno,@caritem,@mon,@datea,@memo,@outmoney,@inmoney,@t_total,@count,''
							end
						end
					
					set @count=@count+1
					set @t_pagecount=@t_pagecount+1
					if(@gno='4' and @t_pagecount%@pagecount!=1)
					begin
						insert into @tmpa
						select '6','','','',@t_carownerno,'','','','','','','','','','','',@x_count,0,@x_total,@count,''
						set @count=@count+1
						set @t_pagecount=@t_pagecount+1
					end
				end
				
			end
		end
		
		if(@gno='3')
		begin
			update @tmpa
			set outmoney=(select SUM(outmoney) from @tmpa where gno='2' and carownerno=@carownerno and carno=@carno),
				inmoney=(select SUM(inmoney) from @tmpa where gno='2' and carownerno=@carownerno and carno=@carno)
			where gno='3' and carownerno=@carownerno and carno=@carno
			
			set @x_total=@x_total+(select SUM(outmoney) from @tmpa where gno='2' and carownerno=@carownerno and carno=@carno)-(select SUM(inmoney) from @tmpa where gno='2' and carownerno=@carownerno and carno=@carno)
			set @x_count=@x_count+1
		end
		
		--set @count=@count+1
		set @t_mon=@mon
		set @t_carownerno=@carownerno
		
		fetch next from cursor_table 
		into @gno,@noa,@noq,@carno,@carownerno,@carowner,@indate,@carbrandno,@carbrand,@caryear,@mobile,@caritemno,@caritem,@mon,@datea,@memo,@outmoney,@inmoney,@total
	end 
close cursor_table 
deallocate cursor_table 
---------------------最後一筆
			if((@t_pagecount+1)%@pageCount=1)
				begin
					insert into @tmpa
					select '8','','','',@t_carownerno,'','','','','','','','','','','',@x_count,0,@x_total,@count,@t_xmemo
				end
			else
				begin
					insert into @tmpa
					select '5','','','',@t_carownerno,'','','','','','','','','','','',@x_count,0,@x_total,@count,''
				end
			set @x_total =0
			set @x_count =0
			set @count=@count+1
			set @t_pagecount=@t_pagecount+1
			
			while (@t_pagecount%@pageCount>1 )
			begin
				insert into @tmpa
				select '6','','','',@t_carownerno,'','','','','','','','','','','',@x_count,0,@x_total,@count,''
				set @count=@count+1
				set @t_pagecount=@t_pagecount+1
			end
			
			if(@t_pagecount%@pageCount!=1)
			begin
				insert into @tmpa
				select '7','','','',@t_carownerno,'','','','','','','','','','','',@x_count,0,@x_total,@count,@t_xmemo
				set @count=@count+1
				set @t_pagecount=1
			end
----------------------------------
--select gno,noa,noq,carno,carownerno,carowner,indate,carbrandno,carbrand,caryear,mobile,caritemno,caritem,mon,datea,left(memo,15) memo
--,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,outmoney),1)),4,12)) outmoney
--,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,inmoney),1)),4,12)) inmoney
--,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total),1)),4,12)) total
--,count,xmemo
--from @tmpa order by count

select gno,a.noa,noq,carno,carownerno,carowner,indate,carbrandno,carbrand,caryear,mobile,caritemno,caritem,mon,datea,left(memo,16) memo 
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,outmoney),1)),4,12)) outmoney 
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,inmoney),1)),4,12)) inmoney 
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total),1)),4,12)) total 
,count,xmemo 
from @tmpa a left join (select noa,namea from carowner) b on a.carownerno=b.noa order by b.namea,carownerno,count;

--------------------------------------------------------------------------------------------------
z_cara2:--z_cara2
declare @t_bcarownerno nvarchar(20)
declare @t_ecarownerno nvarchar(20)
declare @t_bcarno nvarchar(20)
declare @t_ecarno nvarchar(20)
declare @t_xcarnos nvarchar(MAX) 
declare @sql_carnos nvarchar(MAX)
declare @cmd nvarchar(max)
	
set @t_bcarownerno = case when '#non'=[7] then '' else [7] end
set @t_ecarownerno = case when '#non'=[8] then char(255) else [8] end	
set @t_bcarno = case when '#non'=[16] then '' else [16] end
	set @t_ecarno = case when '#non'=[17] then CHAR(255) else [17] end
	set @t_xcarnos = case when '#non'=[25] then '' else [25] end
	set @sql_carnos=''
	
if(RIGHT(@t_xcarnos,1)='.')
set @t_xcarnos=left(@t_xcarnos,len(@t_xcarnos)-1)
	
while(LEN(@t_xcarnos)>0)
begin
	if(CHARINDEX('.',@t_xcarnos)=0)
	begin
		set @sql_carnos=@sql_carnos+' a.carno='''+@t_xcarnos+''' and'
		set @t_xcarnos=''
	end
	if(CHARINDEX('.',@t_xcarnos)>0)
	begin
		set @sql_carnos=@sql_carnos+' a.carno='''+left(@t_xcarnos,CHARINDEX('.',@t_xcarnos)-1)+''' or'
		set @t_xcarnos=RIGHT(@t_xcarnos,LEN(@t_xcarnos)-CHARINDEX('.',@t_xcarnos))
	end
end

declare @tmp table(
     gno nvarchar(1),
     carownerno nvarchar(20), 
     namea nvarchar(20),
     zip nvarchar(50),
     addr nvarchar(50)
)

set @cmd ="select DISTINCT '0' gno,carownerno,namea,zip_conn,addr_conn "+
"from car2 a left join carOwner b on a.carownerno=b.noa "+
"where a.carownerno!='''' and (b.noa between @t_bcarownerno and @t_ecarownerno) "+
"and (a.noa between @t_bcarno and @t_ecarno) and ("+@sql_carnos+" 1=1)"

insert into @tmp 
execute sp_executesql @cmd,N'@t_bcarno nvarchar(20),@t_ecarno nvarchar(20),@t_bcarownerno nvarchar(20),@t_ecarownerno nvarchar(20)', 
@t_bcarno = @t_bcarno,@t_ecarno = @t_ecarno,@t_bcarownerno=@t_bcarownerno,@t_ecarownerno=@t_ecarownerno


insert into @tmp
select '1' gno,carownerno,namea,'',''
from @tmp

select *
from @tmp
order by namea,carownerno,gno;


----------------------------------------------------
z_cara3:--z_cara3車主欠款明細(信封)
SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	declare @t_pagecount int
	declare @pagecount int
	declare @t_bmon nvarchar(10)
	declare @t_emon nvarchar(10)
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_bcarownerno nvarchar(20)
	declare @t_ecarownerno nvarchar(20)
	declare @t_bcarno nvarchar(20)
	declare @t_ecarno nvarchar(20)
	declare @t_xcarnos nvarchar(MAX) 
	declare @sql_carnos nvarchar(MAX)
	declare @t_xmemo nvarchar(MAX) 
	declare @xyear nvarchar(20)
	declare @iacc nvarchar(20)
	
	set @pageCount = 16
	set @t_bmon = case when '#non'=[1] then '' else [1] end
	set @t_emon = case when '#non'=[2] then char(255) else [2] end
	set @t_bdate = case when '#non'=[3] then '' else [3] end
	set @t_edate = case when '#non'=[4] then char(255) else [4] end	
	set @t_bcarownerno = case when '#non'=[7] then '' else [7] end
	set @t_ecarownerno  = case when '#non'=[8] then char(255) else [8] end	
	set @t_bcarno = case when '#non'=[16] then '' else [16] end
	set @t_ecarno = case when '#non'=[17] then CHAR(255) else [17] end
	set @t_xcarnos = case when '#non'=[25] then '' else [25] end
	set @sql_carnos=''
	set @t_xmemo  = case when '#non'=[30] then '' else [30] end
	set @xyear='[38]'
	set @iacc=case when '#non'=[39] then '' else [39] end
	
if(RIGHT(@t_xcarnos,1)='.')
set @t_xcarnos=left(@t_xcarnos,len(@t_xcarnos)-1)
	
while(LEN(@t_xcarnos)>0)
begin
	if(CHARINDEX('.',@t_xcarnos)=0)
	begin
		set @sql_carnos=@sql_carnos+' b.carno='''+@t_xcarnos+''' and'
		set @t_xcarnos=''
	end
	if(CHARINDEX('.',@t_xcarnos)>0)
	begin
		set @sql_carnos=@sql_carnos+' b.carno='''+left(@t_xcarnos,CHARINDEX('.',@t_xcarnos)-1)+''' or'
		set @t_xcarnos=RIGHT(@t_xcarnos,LEN(@t_xcarnos)-CHARINDEX('.',@t_xcarnos))
	end
end


declare @tmp table( 
	[gno] nvarchar(1), 
	[noa] nvarchar(30), 
	[noq] nvarchar(20), 
	[carno] nvarchar(20), 
	[carownerno] nvarchar(20), 
	[carowner] nvarchar(50), 
	[indate] nvarchar(10), 
	[carbrandno] nvarchar(20), 
	[carbrand] nvarchar(50), 
	[caryear] nvarchar(10), 
	[mobile] nvarchar(50), 
	[caritemno] nvarchar(50), 
	[caritem] nvarchar(50), 
	[mon] nvarchar(20), 
	[datea] nvarchar(20), 
	[memo] nvarchar(max), 
	[outmoney] int, 
	[inmoney] int, 
	[total] int, 
	primary key (carownerno,carno,noa,noq,gno) 
)

declare @tmpa table( 
	[gno] nvarchar(2), 
	[noa] nvarchar(30), 
	[noq] nvarchar(20), 
	[carno] nvarchar(20), 
	[carownerno] nvarchar(20), 
	[carowner] nvarchar(50), 
	[indate] nvarchar(10), 
	[carbrandno] nvarchar(20), 
	[carbrand] nvarchar(50), 
	[caryear] nvarchar(10), 
	[mobile] nvarchar(50), 
	[caritemno] nvarchar(50), 
	[caritem] nvarchar(50), 
	[mon] nvarchar(20), 
	[datea] nvarchar(20), 
	[memo] nvarchar(max), 
	[outmoney] int, 
	[inmoney] int, 
	[total] int, 
	[count] int,
	[xmemo] nvarchar(max),
	page int
) 

declare @tmpc table( 
	[gno] nvarchar(1),
	[noa] nvarchar(30), 
	[noq] nvarchar(20), 
	[carno] nvarchar(20), 
	[carownerno] nvarchar(20), 
	[carowner] nvarchar(50), 
	[indate] nvarchar(10), 
	[carbrandno] nvarchar(20), 
	[carbrand] nvarchar(50), 
	[caryear] nvarchar(10), 
	[mobile] nvarchar(50), 
	[caritemno] nvarchar(50), 
	[caritem] nvarchar(50), 
	[mon] nvarchar(20), 
	[datea] nvarchar(20), 
	[memo] nvarchar(max), 
	[outmoney] int, 
	[inmoney] int, 
	[total] int
) 

declare @gno nvarchar(2) 
declare @noa nvarchar(20) 
declare @noq nvarchar(3) 
declare @carno nvarchar(20)
declare @carownerno nvarchar(20) 
declare @carowner nvarchar(50)
declare @indate nvarchar(20) 
declare @carbrandno nvarchar(20)
declare @carbrand nvarchar(50)
declare @caryear nvarchar(20)
declare @mobile nvarchar(50)
declare @caritemno nvarchar(50)
declare @caritem nvarchar(50)
declare @mon nvarchar(10)
declare @datea nvarchar(10)
declare @memo nvarchar(Max)
declare @outmoney int 
declare @inmoney int 
declare @total int 

set @cmd =	"select a.*,0 "+ 
" from( " + 
"select '0' gno,a.noa ,a.noq,b.carno,isNull(c.carownerno,'') carownerno,isNull(d.namea,'') carowner,ISNULL(c.indate,'') indate, "+ 
"ISNULL(e.noa,'') carbrandno,ISNULL(e.brand,'') carbrand,ISNULL(c.caryear,'') caryear,ISNULL(d.mobile,'') mobile, "+ 
"a.caritemno ,a.caritem ,b.mon,a.datea,a.memo,a.outmoney,a.inmoney "+ 
"from caras a "+ 
"left join cara b on b.noa = a.noa "+ 
"left join car2 c on c.noa = b.carno "+ 
"left join carOwner d on d.noa = c.carownerno "+ 
"left join carbrand e on e.noa = c.carbrandno "+ 
" where "+ 
"(b.carno between @t_bcarno and @t_ecarno) and "+ 
"(c.carownerno between @t_bcarownerno and @t_ecarownerno) and "+ 
"(b.mon between @t_bmon and @t_emon) and"+ 
"("+@sql_carnos+" 1=1)"+
" ) a" 

--全部費用
insert into @tmp 
execute sp_executesql @cmd,N'@t_bcarno nvarchar(20),@t_ecarno nvarchar(20),@t_bcarownerno nvarchar(20),@t_ecarownerno nvarchar(20), 
@t_bmon nvarchar(10),@t_emon nvarchar(10)', 
@t_bcarno = @t_bcarno,@t_ecarno = @t_ecarno,@t_bcarownerno=@t_bcarownerno,@t_ecarownerno=@t_ecarownerno, 
@t_bmon=@t_bmon,@t_emon=@t_emon 

--1020312更新加入VCCTRAN的車主資料 --1020410加入判斷是否要顯示內帳(VCC)資料
if(left(@t_bmon,3)>='101' and @iacc='顯示')
begin
	set @cmd=" 
	select '0'gno,
	(case when (select count(*) from car2 where noa=substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)))>0
	then substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo))else
	(select top 1 carno from cara c where mon<=left(a.carno,6) and a.custno=c.carownerno order by mon desc,carno)end)
	+'-'+left(a.carno,6) noa 
	,'999' noq 
	,(case when (select count(*) from car2 where noa=substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)))>0
	then substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo))else
	(select top 1 carno from cara c where mon<=left(a.carno,6) and a.custno=c.carownerno order by mon desc,carno)end)carno 
	,a.custno carownerno,a.comp carowner,b.indate,b.carbrandno,d.brand,b.caryear,e.mobile,'' caritemno,(case when CHARINDEX('理賠',a.memo)>0 then '*其他' when CHARINDEX('請款',a.memo)>0 then '*請款' else '*發票稅費' end) caritem 
	,left(a.carno,6) mon,a.carno,a.memo memo,a.total outmoney ,a.payed inmoney,0 
	from view_vcc"+@xyear+" a left join car2 b on 
	(case when (select count(*) from car2 where noa=substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)))>0
	then substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo))else
	(select top 1 carno from cara c where mon<=left(a.carno,6) and a.custno=c.carownerno order by mon desc,carno)end) =b.noa 
	left join carbrand d on b.carbrandno=d.noa 
	left join carOwner e on a.custno=e.noa 
	where left(a.custno,1)='H' and (left(a.carno,6) between '"+@t_bmon+"' and '"+@t_emon+"') 
	and (case when (select count(*) from car2 where noa=substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)))>0
	then substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo))else
	(select top 1 carno from cara c where mon<=left(a.carno,6) and a.custno=c.carownerno order by mon desc,carno)end) between '"+@t_bcarno+"' and '"+@t_ecarno+"' 
	and carownerno between '"+@t_bcarownerno+"' and '"+@t_ecarownerno+"' 
	and ("+@sql_carnos+" 1=1) 
	order by noa"

	insert into @tmpc
	execute sp_executesql @cmd
	
	--插入tmpc(vcctran)
	declare cursor_table cursor for 
	select * from @tmpc 
	--where noa in(select noa from @tmp group by noa)
	open cursor_table 
	fetch next from cursor_table 
	into @gno,@noa,@noq,@carno,@carownerno,@carowner,@indate,@carbrandno,@carbrand,@caryear,@mobile,@caritemno,@caritem,@mon,@datea,@memo,@outmoney,@inmoney,@total 
	while(@@FETCH_STATUS <> -1) 
	begin 
	
		insert into @tmp 
		select @gno,@noa,(select right('00'+cast((cast(isnull(MAX(noq),0) as int)+1)as nvarchar(3)),3) from @tmp where noa=@noa),@carno,@carownerno,@carowner,@indate,@carbrandno,@carbrand,@caryear,@mobile,@caritemno,@caritem,@mon,@datea,@memo,@outmoney,@inmoney,@total 
	
	fetch next from cursor_table 
	into @gno,@noa,@noq,@carno,@carownerno,@carowner,@indate,@carbrandno,@carbrand,@caryear,@mobile,@caritemno,@caritem,@mon,@datea,@memo,@outmoney,@inmoney,@total 
	end 
	close cursor_table 
	deallocate cursor_table 
	end

--月小計
insert into @tmp 
select '2',noa,'',carno,carownerno,'','','','','','','','',mon,'','',SUM(outmoney),SUM(inmoney),0 from @tmp group by noa,carownerno,carno,mon

--累計
insert into @tmp 
select '3','','',carno,carownerno,'','','','','','','','','999/99','','',SUM(outmoney),SUM(inmoney),0 from @tmp 
where gno='2'
group by carownerno,carno

--欠款累計 --20130119改成最後一個月cara的金額合計(檢查是否結轉正確)
insert into @tmp 
select '4',a.noa,'',a.carno,b.carownerno,a.carowner,b.indate,b.carbrandno,d.brand,b.caryear,c.mobile,'','','999/99',a.datea,'',0,0,a.total
from cara a
left join car2 b on b.noa = a.carno
left join carOwner c on c.noa = b.carownerno 
left join carbrand d on d.noa = b.carbrandno
where a.carno in(select carno from @tmp group by carno) and mon=@t_emon

--插入沒有欠款累計
insert into @tmp 
select '4','','',b.noa,b.carownerno,c.namea,b.indate,b.carbrandno,d.brand,b.caryear,c.mobile,'','','999/99','','',0,0,0
from car2 b 
left join carOwner c on c.noa = b.carownerno 
left join carbrand d on d.noa = b.carbrandno 
where b.noa in(select carno from @tmp where carno not in (select carno from @tmp where gno='4' group by carno)group by carno)

-----------------------------------------------------------------------------------------------

declare @count int 
declare @t_total int 
declare @t_outmoney int 
declare @t_inmoney int
declare @t_carownerno nvarchar(20)
declare @x_total int
declare @x_count int
declare @unpay int

set @count=1
declare @t_carno nvarchar(20)
set @t_carno='XXXX'
declare @t_mon nvarchar(10)
set @t_mon='001/01/01'
set @t_total=0
set @t_outmoney=0
set @t_inmoney=0
set @t_carownerno='ZZZZ'
set @x_total =0
set @x_count =0
set @t_pagecount=1
set @unpay=0

declare cursor_table cursor for 
select * from @tmp order by carownerno,carno,mon,gno,datea,noq
open cursor_table 
fetch next from cursor_table 
into @gno,@noa,@noq,@carno,@carownerno,@carowner,@indate,@carbrandno,@carbrand,@caryear,@mobile,@caritemno,@caritem,@mon,@datea,@memo,@outmoney,@inmoney,@total
while(@@FETCH_STATUS <> -1) 
	begin 
		if(@carownerno!=@t_carownerno and @t_carownerno!='ZZZZ')
		begin
			if((@t_pagecount+1)%@pageCount=1)
				begin
					insert into @tmpa
					select '8','','','',@t_carownerno,'','','','','','','','','','','',@x_count,0,@x_total,@count,@t_xmemo,(@t_pagecount/@pageCount)+1
					set @t_pagecount=0
				end
			else
				begin
					if(@t_pagecount%@pageCount=1 and @t_pagecount!=1)
					begin
						insert into @tmpa
						select '11','','','',@t_carownerno,'','','','','','','','','','','','','','',@count,'',(@t_pagecount/@pageCount)+1
						set @count=@count+1
					end
					insert into @tmpa
					select '5','','','',@t_carownerno,'','','','','','','','','','','',@x_count,0,@x_total,@count,'',(@t_pagecount/@pageCount)+1
				end
			set @x_total =0
			set @x_count =0
			set @count=@count+1
			set @t_pagecount=@t_pagecount+1
			
			while (@t_pagecount%@pageCount>1 )
			begin
				insert into @tmpa
				select '6','','','',@t_carownerno,'','','','','','','','','','','',@x_count,0,@x_total,@count,'',(@t_pagecount/@pageCount)+1
				set @count=@count+1
				set @t_pagecount=@t_pagecount+1
			end
			
			if(@t_pagecount%@pageCount!=1)
			begin
				insert into @tmpa
				select '7','','','',@t_carownerno,'','','','','','','','','','','',@x_count,0,@x_total,@count,@t_xmemo,(@t_pagecount/@pageCount)+1
				set @count=@count+1
				set @t_pagecount=1
			end
		end
		
		if(@t_mon!=@mon)
		begin
			set @t_outmoney=0
			set @t_inmoney=0
		end
		
		if(@t_pagecount%@pageCount=1 and @t_pagecount!=1 and (@t_carno!=@carno or @caritemno!='001'))
		begin
			insert into @tmpa
			select '11','','','',@carownerno,'','','','','','','','','','','','','','',@count,'',(@t_pagecount/@pageCount)+1
			set @count=@count+1
		end
		
		--插入gno1-廠牌年份....等資料
		if(@t_carno!=@carno)
		begin
			insert into @tmpa
			select '1','','',@carno,@carownerno,@carowner,@indate,@carbrandno,@carbrand,@caryear,@mobile,'','',@mon,'','',0,0,0,@count,'',(@t_pagecount/@pageCount)+1
			
			set @t_carno=@carno
			set @count=@count+1
			set @t_pagecount=@t_pagecount+1
			set @unpay=0
			
			if(left(@t_bmon,3)>='101' and @iacc='顯示')
			begin
				--求得開始月份之前的未付金額
				set @cmd=" 
				set @unpay =isnull((select
				sum(a.total-a.payed) unpay 
				from view_vcc"+@xyear+" a left join car2 b on 
				(case when (select count(*) from car2 where noa=substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)))>0
				then substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo))else
				(select top 1 carno from cara c where mon<=left(a.carno,6) and a.custno=c.carownerno order by mon desc,carno)end) =b.noa 
				left join carbrand d on b.carbrandno=d.noa 
				left join carOwner e on a.custno=e.noa 
				where left(a.custno,1)='H' and (left(a.carno,6) < '"+@t_bmon+"') 
				and (case when (select count(*) from car2 where noa=substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)))>0
				then substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo))else
				(select top 1 carno from cara c where mon<=left(a.carno,6) and a.custno=c.carownerno order by mon desc,carno)end) = '"+@carno+"'),0)"
				execute sp_executesql @cmd,N'@unpay float OUTPUT', @unpay OUTPUT
			end
			
			set @t_total=isnull(@outmoney,0)-isnull(@inmoney,0)+@unpay
			
			if(@t_pagecount%@pageCount=1 and @t_pagecount!=1)
			begin
				insert into @tmpa
				select '11','','','',@carownerno,'','','','','','','','','','','','','','',@count,'',(@t_pagecount/@pageCount)+1
				set @count=@count+1
			end
			
			--印出車牌和車主
			insert into @tmpa
			select @gno,@noa,@noq,@carno,@carownerno,@carowner,@indate,@carbrandno,@carbrand,@caryear,@mobile,@caritemno,@caritem,@mon,@datea,@memo,@outmoney+@unpay,@inmoney,@t_total,@count,'',(@t_pagecount/@pageCount)+1
			set @count=@count+1
			set @t_pagecount=@t_pagecount+1
			set @t_outmoney=@t_outmoney+@outmoney
			set @t_inmoney=@t_inmoney+@inmoney
		end
		else
		begin
			--之後的資料不印出001
			if(@caritemno!='001')
			begin
				--計算餘額和欠款累計
				if(@gno='0')
				begin
					set @t_total=@t_total+isnull(@outmoney,0)-isnull(@inmoney,0)
					set @t_outmoney=@t_outmoney+@outmoney
					set @t_inmoney=@t_inmoney+@inmoney
				end
				
				if(@gno='2')
				begin
					insert into @tmpa
					select @gno,@noa,@noq,@carno,@carownerno,'',@indate,@carbrandno,@carbrand,@caryear,@mobile,@caritemno,@caritem,@mon,@datea,@memo,@t_outmoney+@unpay,@t_inmoney,@t_total,@count,'',(@t_pagecount/@pageCount)+1
					set @count=@count+1
					set @t_pagecount=@t_pagecount+1
				end
				else if(@gno='3')
				begin
					insert into @tmpa
					select @gno,@noa,@noq,@carno,@carownerno,'',@indate,@carbrandno,@carbrand,@caryear,@mobile,@caritemno,@caritem,@mon,@datea,@memo,@outmoney+@unpay,@inmoney,@t_total,@count,'',(@t_pagecount/@pageCount)+1
					set @count=@count+1
					set @t_pagecount=@t_pagecount+1
				end
				else
				begin
					if(@gno='0' and @t_pagecount%@pageCount=1)
						begin
							insert into @tmpa
							select @gno,@noa,@noq,@carno,@carownerno,@carowner,@indate,@carbrandno,@carbrand,@caryear,@mobile,@caritemno,@caritem,@mon,@datea,@memo,@outmoney,@inmoney,@t_total,@count,'',(@t_pagecount/@pageCount)+1
						end
					else
						begin
							if(@gno='4')--20130119改成最後一個月cara的金額合計(檢查是否結轉正確)
							begin
								insert into @tmpa
								select @gno,@noa,@noq,'',@carownerno,'',@indate,@carbrandno,@carbrand,@caryear,@mobile,@caritemno,@caritem,@mon,@datea,@memo,@outmoney,@inmoney,@t_total,@count,'',(@t_pagecount/@pageCount)+1
								--select @gno,@noa,@noq,'',@carownerno,'',@indate,@carbrandno,@carbrand,@caryear,@mobile,@caritemno,@caritem,@mon,@datea,@memo,@outmoney,@inmoney,@total,@count,'',(@t_pagecount/@pageCount)+1
							end
							else
							begin
								insert into @tmpa
								select @gno,@noa,@noq,'',@carownerno,'',@indate,@carbrandno,@carbrand,@caryear,@mobile,@caritemno,@caritem,@mon,@datea,@memo,@outmoney,@inmoney,@t_total,@count,'',(@t_pagecount/@pageCount)+1
							end
						end
					
					set @count=@count+1
					set @t_pagecount=@t_pagecount+1
					
					if(@gno='4'  and @t_pagecount%@pagecount>1)
					begin
						if(@t_pagecount%@pageCount=1 and @t_pagecount!=1)
						begin
							insert into @tmpa
							select '11',@noa,@noq,@carno,@carownerno,@carowner,@indate,@carbrandno,@carbrand,@caryear,@mobile,@caritemno,@caritem,@mon,@datea,@memo,@outmoney,@inmoney,@total,@count,'',(@t_pagecount/@pageCount)+1
							set @count=@count+1
						end
						
						insert into @tmpa
						select '6','','','',@t_carownerno,'','','','','','','','','','','',@x_count,0,@x_total,@count,'',(@t_pagecount/@pageCount)+1
						set @count=@count+1
						set @t_pagecount=@t_pagecount+1
					end
				end
			end
		end
		
		if(@gno='3')
		begin
			update @tmpa
			set outmoney=(select SUM(outmoney) from @tmpa where gno='2' and carownerno=@carownerno and carno=@carno),
				inmoney=(select SUM(inmoney) from @tmpa where gno='2' and carownerno=@carownerno and carno=@carno)
			where gno='3' and carownerno=@carownerno and carno=@carno
			
			set @x_total=@x_total+(select SUM(outmoney) from @tmpa where gno='2' and carownerno=@carownerno and carno=@carno)-(select SUM(inmoney) from @tmpa where gno='2' and carownerno=@carownerno and carno=@carno)
			set @x_count=@x_count+1
		end
		
		--set @count=@count+1
		set @t_mon=@mon
		set @t_carownerno=@carownerno
		
		fetch next from cursor_table 
		into @gno,@noa,@noq,@carno,@carownerno,@carowner,@indate,@carbrandno,@carbrand,@caryear,@mobile,@caritemno,@caritem,@mon,@datea,@memo,@outmoney,@inmoney,@total
	end 
close cursor_table 
deallocate cursor_table 
---------------------最後一筆
			if((@t_pagecount+1)%@pageCount=1)
				begin
					insert into @tmpa
					select '8','','','',@t_carownerno,'','','','','','','','','','','',@x_count,0,@x_total,@count,@t_xmemo,(@t_pagecount/@pageCount)+1
				end
			else
				begin
					insert into @tmpa
					select '5','','','',@t_carownerno,'','','','','','','','','','','',@x_count,0,@x_total,@count,'',(@t_pagecount/@pageCount)+1
				end
			set @x_total =0
			set @x_count =0
			set @count=@count+1
			set @t_pagecount=@t_pagecount+1
			
			while (@t_pagecount%@pageCount>1 )
			begin
				insert into @tmpa
				select '6','','','',@t_carownerno,'','','','','','','','','','','',@x_count,0,@x_total,@count,'',(@t_pagecount/@pageCount)+1
				set @count=@count+1
				set @t_pagecount=@t_pagecount+1
			end
			
			if(@t_pagecount%@pageCount!=1)
			begin
				insert into @tmpa
				select '7','','','',@t_carownerno,'','','','','','','','','','','',@x_count,0,@x_total,@count,@t_xmemo,(@t_pagecount/@pageCount)+1
				set @count=@count+1
				set @t_pagecount=1
			end
---------------(信封)------------------------------------------
declare @zip nvarchar(50)
declare @addr nvarchar(200)
declare @xmemo nvarchar(MAX) 
declare @page int

declare @now_date nvarchar(10)--現在日期
set @now_date=CONVERT (VARCHAR(7), GETDATE(),12 )+0890000
set @now_date=left(@now_date,3)+'/'+substring(@now_date,4,2)+'/'+right(@now_date,2)

declare @tmpb table( 
	[gno] nvarchar(2), 
	[noa] nvarchar(30), 
	[noq] nvarchar(20), 
	[carno] nvarchar(20), 
	[carownerno] nvarchar(20), 
	[carowner] nvarchar(50), 
	[indate] nvarchar(10), 
	[carbrandno] nvarchar(20), 
	[carbrand] nvarchar(50), 
	[caryear] nvarchar(10), 
	[mobile] nvarchar(50), 
	[caritemno] nvarchar(50), 
	[caritem] nvarchar(50), 
	[mon] nvarchar(20), 
	[datea] nvarchar(20), 
	[memo] nvarchar(max), 
	[outmoney] int, 
	[inmoney] int, 
	[total] int, 
	[count] int,
	[xmemo] nvarchar(max),
	page int,
	zip nvarchar(50),
	addr nvarchar(200),
	nowdate nvarchar(10)
) 

declare cursor_table cursor for 
select * from @tmpa order by count
open cursor_table 
fetch next from cursor_table 
into @gno,@noa,@noq,@carno,@carownerno,@carowner,@indate,@carbrandno,@carbrand,@caryear,@mobile,@caritemno,@caritem,@mon,@datea,@memo,@outmoney,@inmoney,@total,@count,@xmemo,@page
while(@@FETCH_STATUS <> -1) 
	begin 
		insert into @tmpb
		select @gno,@noa,@noq,@carno,@carownerno,@carowner,@indate,@carbrandno,@carbrand,@caryear,@mobile,@caritemno,@caritem,@mon,@datea,@memo,@outmoney,@inmoney,@total,@count,@xmemo,@page,'','',@now_date
		
		if(@gno='7' or @gno='8')
		begin
			set @zip=(select zip_conn from carOwner where noa=@carownerno)
			set @addr=(select addr_conn from carOwner where noa=@carownerno)
			set @carowner=(select namea from carOwner where noa=@carownerno)
			insert into @tmpb
			select '9',@noa,@noq,@carno,@carownerno,@carowner,@indate,@carbrandno,@carbrand,@caryear,@mobile,@caritemno,@caritem,@mon,@datea,@memo,@outmoney,@inmoney,@total,0,'',1,@zip,@addr,@now_date
			insert into @tmpb
			select '10',@noa,@noq,@carno,@carownerno,@carowner,@indate,@carbrandno,@carbrand,@caryear,@mobile,@caritemno,@caritem,@mon,@datea,@memo,@outmoney,@inmoney,@total,0,'',1,@zip,@addr,@now_date
			insert into @tmpb
			select '11',@noa,@noq,@carno,@carownerno,@carowner,@indate,@carbrandno,@carbrand,@caryear,@mobile,@caritemno,@caritem,@mon,@datea,@memo,@outmoney,@inmoney,@total,0,'',1,@zip,@addr,@now_date
		end
		
		fetch next from cursor_table 
		into @gno,@noa,@noq,@carno,@carownerno,@carowner,@indate,@carbrandno,@carbrand,@caryear,@mobile,@caritemno,@caritem,@mon,@datea,@memo,@outmoney,@inmoney,@total,@count,@xmemo,@page
	end 
close cursor_table 
deallocate cursor_table 

--select gno,noa,noq,carno,carownerno,carowner,indate,carbrandno,carbrand,caryear,mobile,caritemno,caritem,mon,datea,left(memo,15) memo
--,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,outmoney),1)),4,12)) outmoney
--,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,inmoney),1)),4,12)) inmoney
--,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total),1)),4,12)) total
--,count,xmemo,zip,addr,nowdate,page
--from @tmpb order by carownerno,count

select gno,a.noa,noq,carno,carownerno,carowner,indate,carbrandno,carbrand,caryear,mobile,caritemno,caritem,mon,datea,left(memo,17) memo 
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,outmoney),1)),4,12)) outmoney 
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,inmoney),1)),4,12)) inmoney 
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total),1)),4,12)) total 
,count,xmemo,zip,addr,nowdate,page 
from @tmpb a left join (select noa,namea from carowner) b on a.carownerno=b.noa order by b.namea,carownerno,count;


--------------------------------------------------------------------------------------------------
z_carpack:--z_carpack
declare @t_bcardealno nvarchar(20) 
declare @t_ecardealno nvarchar(20) 
declare @t_enddate nvarchar(10) 
	
set @t_bcardealno = case when '#non'=[5] then '' else [5] end
set @t_ecardealno  = case when '#non'=[6] then char(255) else [6] end	
set @t_enddate = case when '#non'=[15] then '' else [15] end
	
------------------取得車頭和板台數---------------------
declare @tmp table( 
	gno nvarchar(20),
	carno nvarchar(20),
	carspecno nvarchar(20),
	cardealno nvarchar(20), 
	cardeal nvarchar(50),  
	carownerno nvarchar(20), 
	carowner nvarchar(50), 
	headmount int,
	palmount int 
) 

insert into @tmp
select '0',a.noa,a.carspecno,a.cardealno,c.comp,a.carownerno,b.namea,0,0
from car2 a 
left join carowner b on b.noa = a.carownerno 
left join cardeal c on c.noa = a.cardealno 
where a.indate<@t_enddate and (a.cardealno between @t_bcardealno and @t_ecardealno)and a.carownerno!=''
and (a.outdate='' or outdate is null) and (a.suspdate='' or a.suspdate is null)
and (a.enddate='' or a.enddate is null) and (a.wastedate='' or a.wastedate is null)
and a.cardealno!='00' and a.cardealno!='' and a.carspecno!='D12' and a.carspecno!='18' and a.carspecno!='44' and a.carspecno!='55' and a.carspecno!=''

--insert into @tmp 
--select '1' gno,'','',cardealno,'','','' ,0,0 from @tmp group by cardealno

insert into @tmp 
select '1' gno,'','',noa,'','','' ,0,0 
from cardeal where noa in(select cardealno from carpack where (cardealno between @t_bcardealno and @t_ecardealno) and edate>@t_enddate  group by cardealno)
group by noa  

declare @cardealno nvarchar(20) 
declare cursor_table cursor for 
select cardealno from @tmp where gno='1'
open cursor_table 
fetch next from cursor_table 
into @cardealno
while(@@FETCH_STATUS <> -1) 
	begin 
	
	update @tmp
	set headmount=(select COUNT(*) from @tmp where gno='0' and (carspecno='A01' or carspecno='A04' or carspecno='A25' or carspecno='B53' or carspecno='C11' or carspecno='C27' or carspecno='C51') and cardealno=@cardealno),
	palmount=(select COUNT(*) from @tmp where gno='0' and (carspecno!='A01' and carspecno!='A04' and carspecno!='A25' and carspecno!='B53' and carspecno!='C11' and carspecno!='C27' and carspecno!='C51') and cardealno=@cardealno),
	cardeal=(select comp from cardeal where noa=@cardealno)
	where cardealno=@cardealno and gno='1'

	fetch next from cursor_table 
	into @cardealno
	end 
close cursor_table 
deallocate cursor_table 

------------------取得車頭和板台數---------------------

declare @result table( 
	gno nvarchar(20),
	cardealno nvarchar(20), 
	bxdate nvarchar(20), 
	exdate nvarchar(20), 
	mount float,
	carmount float,
	money float, 
	place nvarchar(50),
	hm int,
	pm int 
) 

insert into @result 
select '0' gno,cardealno,bdate,edate,mount,carmount,money,place,0,0
from carpack
where (cardealno between @t_bcardealno and @t_ecardealno) and edate>@t_enddate
order by edate desc

insert into @result 
select '1' gno,b.cardealno,'','',isnull(sum(a.carmount),0)-(b.headmount+b.palmount),isnull(sum(a.carmount),0),0,'',b.headmount,b.palmount
from carpack a right join (select * from @tmp where gno='1') b on a.cardealno=b.cardealno
group by b.cardealno,b.headmount,b.palmount

insert into @result 
select '2' gno,'ZZZZZ','','',SUM(mount),SUM(carmount),0,'',SUM(hm),SUM(pm)
from @result
where gno='1'

select a.*,b.nick cardeal from @result a
left join cardeal b on a.cardealno=b.noa
order by cardealno,gno;

--------------------取得車頭和板台數---------------------(舊版本)
--declare @tmp table( 
--	gno nvarchar(20),
--	carno nvarchar(20),
--	cardealno nvarchar(20), 
--	cardeal nvarchar(50),  
--	carownerno nvarchar(20), 
--	carowner nvarchar(50), 
--	headmount int,
--	palmount int 
--) 

--insert into @tmp
--select '0',a.noa,a.cardealno,c.comp,a.carownerno,b.namea,0,0
--from car2 a 
--left join carowner b on b.noa = a.carownerno 
--left join cardeal c on c.noa = a.cardealno 
--where a.indate<@t_enddate and (a.cardealno between @t_bcardealno and @t_ecardealno)and a.carownerno!=''
--and (a.outdate='' or outdate is null) and (a.suspdate='' or a.suspdate is null)
--and (a.enddate='' or a.enddate is null) and (a.wastedate='' or a.wastedate is null)

--insert into @tmp 
--select '1' gno,'',cardealno,'','','' ,0,0
--from @tmp 
--group by cardealno 

--declare @cardealno nvarchar(20) 
--declare cursor_table cursor for 
--select cardealno from @tmp where gno='1'
--open cursor_table 
--fetch next from cursor_table 
--into @cardealno
--while(@@FETCH_STATUS <> -1) 
--	begin 
	
--	update @tmp
--	set headmount=(select COUNT(*) from @tmp where gno='0' and PATINDEX('%-%',carno)>0 and len(carno)=6 and cardealno=@cardealno),
--	palmount=(select COUNT(*) from @tmp where gno='0' and PATINDEX('%-%',carno)>0 and len(carno)=5 and cardealno=@cardealno),
--	cardeal=(select comp from cardeal where noa=@cardealno)
--	where cardealno=@cardealno and gno='1'

--	fetch next from cursor_table 
--	into @cardealno
--	end 
--close cursor_table 
--deallocate cursor_table 

--------------------取得車頭和板台數---------------------

--declare @result table( 
--	gno nvarchar(20),
--	cardealno nvarchar(20), 
--	bxdate nvarchar(20), 
--	exdate nvarchar(20), 
--	mount float,
--	carmount float,
--	money float, 
--	place nvarchar(50),
--	hm int,
--	pm int 
--) 

--insert into @result 
--select '0' gno,cardealno,bdate,edate,mount,carmount,money,place,0,0
--from carpack
--where (cardealno between @t_bcardealno and @t_ecardealno) and edate>@t_enddate

--insert into @result 
--select '1' gno,b.cardealno,'','',isnull(sum(a.carmount),0)-(b.headmount+b.palmount),isnull(sum(a.carmount),0),0,'',b.headmount,b.palmount
--from carpack a right join (select * from @tmp where gno='1') b on a.cardealno=b.cardealno
--group by b.cardealno,b.headmount,b.palmount

--insert into @result 
--select '2' gno,'ZZZZZ','','',SUM(mount),SUM(carmount),0,'',SUM(hm),SUM(pm)
--from @result
--where gno='1'

--select a.*,b.nick cardeal from @result a
--left join cardeal b on a.cardealno=b.noa
--order by cardealno,gno

--*****************************************************************************************
z_backup1:--z_backup1
declare @t_bmon nvarchar(20)
declare @t_emon nvarchar(20)
declare @t_bcarownerno nvarchar(20)
declare @t_ecarownerno nvarchar(20)
set @t_bmon = case when '#non' = [1] then '' else [1] end
set @t_emon = case when '#non' = [2] then CHAR(255) else [2] end
set @t_bcarownerno = case when '#non' = [7] then '' else [7] end
set @t_ecarownerno = case when '#non' = [8] then CHAR(255) else [8] end
declare @tmp table(
		gno nvarchar(1),
		noa nvarchar(30),
		noq nvarchar(20),
		mon nvarchar(10),
		datea nvarchar(10),
		carownerno nvarchar(20),
		carowner nvarchar(50),
		carno nvarchar(20),
		memo nvarchar(100),
		outmoney float,
		inmoney float,
		mount float 
) 
insert into @tmp 
select '0' gno,a.noa,b.noq,b.mon,b.datea,a.carownerno,a.carowner,b.carno,b.memo,b.outmoney,b.inmoney,0
from cara a 
left join caras b on a.noa = b.noa 
where (b.mon between @t_bmon and @t_emon) and 
(a.carownerno between @t_bcarownerno and @t_ecarownerno) and 
(b.caritem='健勞保費') 

insert into @tmp 
select '1' gno,'','','','',CHAR(255),'','','',sum(outmoney),sum(inmoney),COUNT(DISTINCT carowner)  
from @tmp 

select gno,noa,noq,mon,datea,carownerno,carowner,carno,memo, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,outmoney),1)),4,12)) outmoney, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,inmoney),1)),4,12)) inmoney,mount 
from @tmp 
order by carownerno,gno ;

----------------------------------------------------
z_cara4:--z_cara4車主欠款明細(A4)
SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	declare @t_pagecount int
	declare @pagecount int
	declare @t_bmon nvarchar(10)
	declare @t_emon nvarchar(10)
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_bcarownerno nvarchar(20)
	declare @t_ecarownerno nvarchar(20)
	declare @t_bcarno nvarchar(20)
	declare @t_ecarno nvarchar(20)
	declare @t_xcarnos nvarchar(MAX) 
	declare @sql_carnos nvarchar(MAX)
	declare @t_xmemo nvarchar(MAX) 
	declare @xyear nvarchar(20)
	declare @iacc nvarchar(20)
	
	set @pageCount = 40
	set @t_bmon = case when '#non'=[1] then '' else [1] end
	set @t_emon = case when '#non'=[2] then char(255) else [2] end
	set @t_bdate = case when '#non'=[3] then '' else [3] end
	set @t_edate = case when '#non'=[4] then char(255) else [4] end	
	set @t_bcarownerno = case when '#non'=[7] then '' else [7] end
	set @t_ecarownerno  = case when '#non'=[8] then char(255) else [8] end	
	set @t_bcarno = case when '#non'=[16] then '' else [16] end
	set @t_ecarno = case when '#non'=[17] then CHAR(255) else [17] end
	set @t_xcarnos = case when '#non'=[25] then '' else [25] end
	set @sql_carnos=''
	set @t_xmemo  = case when '#non'=[30] then '' else [30] end
	set @xyear='[38]'
	set @iacc=case when '#non'=[39] then '' else [39] end
	
if(RIGHT(@t_xcarnos,1)='.')
set @t_xcarnos=left(@t_xcarnos,len(@t_xcarnos)-1)
	
while(LEN(@t_xcarnos)>0)
begin
if(CHARINDEX('.',@t_xcarnos)=0)
begin
set @sql_carnos=@sql_carnos+' b.carno='''+@t_xcarnos+''' and'
set @t_xcarnos=''
end
if(CHARINDEX('.',@t_xcarnos)>0)
begin
set @sql_carnos=@sql_carnos+' b.carno='''+left(@t_xcarnos,CHARINDEX('.',@t_xcarnos)-1)+''' or'
set @t_xcarnos=RIGHT(@t_xcarnos,LEN(@t_xcarnos)-CHARINDEX('.',@t_xcarnos))
end
end


declare @tmp table( 
	[gno] nvarchar(1), 
	[noa] nvarchar(30), 
	[noq] nvarchar(20), 
	[carno] nvarchar(20), 
	[carownerno] nvarchar(20), 
	[carowner] nvarchar(50), 
	[indate] nvarchar(10), 
	[carbrandno] nvarchar(20), 
	[carbrand] nvarchar(50), 
	[caryear] nvarchar(10), 
	[mobile] nvarchar(50), 
	[caritemno] nvarchar(50), 
	[caritem] nvarchar(50), 
	[mon] nvarchar(20), 
	[datea] nvarchar(20), 
	[memo] nvarchar(max), 
	[outmoney] int, 
	[inmoney] int, 
	[total] int, 
	primary key (carownerno,carno,noa,noq,gno) 
)

declare @tmpa table( 
	[gno] nvarchar(1), 
	[noa] nvarchar(30), 
	[noq] nvarchar(20), 
	[carno] nvarchar(20), 
	[carownerno] nvarchar(20), 
	[carowner] nvarchar(50), 
	[indate] nvarchar(10), 
	[carbrandno] nvarchar(20), 
	[carbrand] nvarchar(50), 
	[caryear] nvarchar(10), 
	[mobile] nvarchar(50), 
	[caritemno] nvarchar(50), 
	[caritem] nvarchar(50), 
	[mon] nvarchar(20), 
	[datea] nvarchar(20), 
	[memo] nvarchar(max), 
	[outmoney] int, 
	[inmoney] int, 
	[total] int, 
	[count] int,
	[xmemo] nvarchar(max)
) 

declare @tmpb table( 
	[gno] nvarchar(1),
	[noa] nvarchar(30), 
	[noq] nvarchar(20), 
	[carno] nvarchar(20), 
	[carownerno] nvarchar(20), 
	[carowner] nvarchar(50), 
	[indate] nvarchar(10), 
	[carbrandno] nvarchar(20), 
	[carbrand] nvarchar(50), 
	[caryear] nvarchar(10), 
	[mobile] nvarchar(50), 
	[caritemno] nvarchar(50), 
	[caritem] nvarchar(50), 
	[mon] nvarchar(20), 
	[datea] nvarchar(20), 
	[memo] nvarchar(max), 
	[outmoney] int, 
	[inmoney] int, 
	[total] int
) 

declare @gno nvarchar(1) 
declare @noa nvarchar(20) 
declare @noq nvarchar(3) 
declare @carno nvarchar(20)
declare @carownerno nvarchar(20) 
declare @carowner nvarchar(50)
declare @indate nvarchar(20) 
declare @carbrandno nvarchar(20)
declare @carbrand nvarchar(50)
declare @caryear nvarchar(20)
declare @mobile nvarchar(50)
declare @caritemno nvarchar(50)
declare @caritem nvarchar(50)
declare @mon nvarchar(10)
declare @datea nvarchar(10)
declare @memo nvarchar(Max)
declare @outmoney int 
declare @inmoney int 
declare @total int 

set @cmd =	"select a.*,0 "+ 
" from( " + 
"select '0' gno,a.noa ,a.noq,b.carno,isNull(c.carownerno,'') carownerno,isNull(d.namea,'') carowner,ISNULL(c.indate,'') indate, "+ 
"ISNULL(e.noa,'') carbrandno,ISNULL(e.brand,'') carbrand,ISNULL(c.caryear,'') caryear,ISNULL(d.mobile,'') mobile, "+ 
"a.caritemno ,a.caritem ,b.mon,a.datea,a.memo,a.outmoney,a.inmoney "+ 
"from caras a "+ 
"left join cara b on b.noa = a.noa "+ 
"left join car2 c on c.noa = b.carno "+ 
"left join carOwner d on d.noa = c.carownerno "+ 
"left join carbrand e on e.noa = c.carbrandno "+ 
" where "+ 
"(b.carno between @t_bcarno and @t_ecarno) and "+ 
"(c.carownerno between @t_bcarownerno and @t_ecarownerno) and "+ 
"(b.mon between @t_bmon and @t_emon) and"+ 
"("+@sql_carnos+" 1=1)"+
" ) a" 

--全部費用
insert into @tmp 
execute sp_executesql @cmd,N'@t_bcarno nvarchar(20),@t_ecarno nvarchar(20),@t_bcarownerno nvarchar(20),@t_ecarownerno nvarchar(20), 
@t_bmon nvarchar(10),@t_emon nvarchar(10)', 
@t_bcarno = @t_bcarno,@t_ecarno = @t_ecarno,@t_bcarownerno=@t_bcarownerno,@t_ecarownerno=@t_ecarownerno, 
@t_bmon=@t_bmon,@t_emon=@t_emon 

--1020312更新加入VCCTRAN的車主資料 --1020410加入判斷是否要顯示內帳(VCC)資料
if(left(@t_bmon,3)>='101' and @iacc='顯示')
begin
	set @cmd=" 
	select '0'gno,
	(case when (select count(*) from car2 where noa=substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)))>0
	then substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo))else
	(select top 1 carno from cara c where mon<=left(a.carno,6) and a.custno=c.carownerno order by mon desc,carno)end)
	+'-'+left(a.carno,6) noa 
	,'999' noq 
	,(case when (select count(*) from car2 where noa=substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)))>0
	then substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo))else
	(select top 1 carno from cara c where mon<=left(a.carno,6) and a.custno=c.carownerno order by mon desc,carno)end)carno 
	,a.custno carownerno,a.comp carowner,b.indate,b.carbrandno,d.brand,b.caryear,e.mobile,'' caritemno,(case when CHARINDEX('理賠',a.memo)>0 then '*其他' when CHARINDEX('請款',a.memo)>0 then '*請款' else '*發票稅費' end) caritem 
	,left(a.carno,6) mon,a.carno,a.memo memo,a.total outmoney ,a.payed inmoney,0 
	from view_vcc"+@xyear+" a left join car2 b on 
	(case when (select count(*) from car2 where noa=substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)))>0
	then substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo))else
	(select top 1 carno from cara c where mon<=left(a.carno,6) and a.custno=c.carownerno order by mon desc,carno)end) =b.noa 
	left join carbrand d on b.carbrandno=d.noa 
	left join carOwner e on a.custno=e.noa 
	where left(a.custno,1)='H' and (left(a.carno,6) between '"+@t_bmon+"' and '"+@t_emon+"') 
	and (case when (select count(*) from car2 where noa=substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)))>0
	then substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo))else
	(select top 1 carno from cara c where mon<=left(a.carno,6) and a.custno=c.carownerno order by mon desc,carno)end) between '"+@t_bcarno+"' and '"+@t_ecarno+"' 
	and carownerno between '"+@t_bcarownerno+"' and '"+@t_ecarownerno+"' 
	and ("+@sql_carnos+" 1=1) 
	order by noa"

	insert into @tmpb
	execute sp_executesql @cmd

	--插入tmpb(vcctran)
	declare cursor_table cursor for 
	select * from @tmpb 
	--where noa in(select noa from @tmp group by noa)
	open cursor_table 
	fetch next from cursor_table 
	into @gno,@noa,@noq,@carno,@carownerno,@carowner,@indate,@carbrandno,@carbrand,@caryear,@mobile,@caritemno,@caritem,@mon,@datea,@memo,@outmoney,@inmoney,@total 
	while(@@FETCH_STATUS <> -1) 
	begin 
	
	insert into @tmp 
	select @gno,@noa,(select right('00'+cast((cast(isnull(MAX(noq),0) as int)+1)as nvarchar(3)),3) from @tmp where noa=@noa),@carno,@carownerno,@carowner,@indate,@carbrandno,@carbrand,@caryear,@mobile,@caritemno,@caritem,@mon,@datea,@memo,@outmoney,@inmoney,@total 
	
	fetch next from cursor_table 
	into @gno,@noa,@noq,@carno,@carownerno,@carowner,@indate,@carbrandno,@carbrand,@caryear,@mobile,@caritemno,@caritem,@mon,@datea,@memo,@outmoney,@inmoney,@total 
	end 
	close cursor_table 
	deallocate cursor_table 
end

--月小計
insert into @tmp 
select '2',noa,'',carno,carownerno,'','','','','','','','',mon,'','',SUM(outmoney),SUM(inmoney),0 from @tmp group by noa,carownerno,carno,mon

--累計
insert into @tmp 
select '3','','',carno,carownerno,'','','','','','','','','999/99','','',SUM(outmoney),SUM(inmoney),0 from @tmp 
where gno='2'
group by carownerno,carno

--欠款累計 --20130119改成最後一個月cara的金額合計(檢查是否結轉正確)
insert into @tmp 
select '4',a.noa,'',a.carno,b.carownerno,a.carowner,b.indate,b.carbrandno,d.brand,b.caryear,c.mobile,'','','999/99',a.datea,'',0,0,a.total
from cara a
left join car2 b on b.noa = a.carno
left join carOwner c on c.noa = b.carownerno 
left join carbrand d on d.noa = b.carbrandno
where a.carno in(select carno from @tmp group by carno) and mon=@t_emon

-----------------------------------------------------------------------------------------------
declare @count int 
declare @t_total int 
declare @t_outmoney int 
declare @t_inmoney int
declare @t_carownerno nvarchar(20)
declare @x_total int
declare @x_count int
declare @unpay int

set @count=1
declare @t_carno nvarchar(20)
set @t_carno='XXXX'
declare @t_mon nvarchar(10)
set @t_mon='001/01/01'
set @t_total=0
set @t_outmoney=0
set @t_inmoney=0
set @t_carownerno='ZZZZ'
set @x_total =0
set @x_count =0
set @t_pagecount=1
set @unpay=0

declare cursor_table cursor for 
select * from @tmp order by carownerno,carno,mon,gno,datea,noq
open cursor_table 
fetch next from cursor_table 
into @gno,@noa,@noq,@carno,@carownerno,@carowner,@indate,@carbrandno,@carbrand,@caryear,@mobile,@caritemno,@caritem,@mon,@datea,@memo,@outmoney,@inmoney,@total
while(@@FETCH_STATUS <> -1) 
	begin 
		if(@carownerno!=@t_carownerno and @t_carownerno!='ZZZZ')
		begin
			if((@t_pagecount+1)%@pageCount=1)
				begin
					insert into @tmpa
					select '8','','','',@t_carownerno,'','','','','','','','','','','',@x_count,0,@x_total,@count,@t_xmemo
				end
			else
				begin
					insert into @tmpa
					select '5','','','',@t_carownerno,'','','','','','','','','','','',@x_count,0,@x_total,@count,''
				end
			set @x_total =0
			set @x_count =0
			set @count=@count+1
			set @t_pagecount=@t_pagecount+1
			
			while (@t_pagecount%@pageCount>1 )
			begin
				insert into @tmpa
				select '6','','','',@t_carownerno,'','','','','','','','','','','',@x_count,0,@x_total,@count,''
				set @count=@count+1
				set @t_pagecount=@t_pagecount+1
			end
			
			if(@t_pagecount%@pageCount!=1)
			begin
				insert into @tmpa
				select '7','','','',@t_carownerno,'','','','','','','','','','','',@x_count,0,@x_total,@count,@t_xmemo
				set @count=@count+1
				set @t_pagecount=1
			end
		end
		
		if(@t_mon!=@mon)
		begin
			set @t_outmoney=0
			set @t_inmoney=0
		end
	
		--插入gno1-廠牌年份....等資料
		if(@t_carno!=@carno)
		begin
			insert into @tmpa
			select '1','','',@carno,@carownerno,@carowner,@indate,@carbrandno,@carbrand,@caryear,@mobile,'','',@mon,'','',0,0,0,@count,''
			
			set @t_carno=@carno
			set @count=@count+1
			set @t_pagecount=@t_pagecount+1
			set @unpay=0
			
			if(left(@t_bmon,3)>='101' and @iacc='顯示')
			begin
				--求得開始月份之前的未付金額
				set @cmd=" 
				set @unpay =isnull((select
				sum(a.total-a.payed) unpay 
				from view_vcc"+@xyear+" a left join car2 b on 
				(case when (select count(*) from car2 where noa=substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)))>0
				then substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo))else
				(select top 1 carno from cara c where mon<=left(a.carno,6) and a.custno=c.carownerno order by mon desc,carno)end) =b.noa 
				left join carbrand d on b.carbrandno=d.noa 
				left join carOwner e on a.custno=e.noa 
				where left(a.custno,1)='H' and (left(a.carno,6) < '"+@t_bmon+"') 
				and (case when (select count(*) from car2 where noa=substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo)))>0
				then substring(a.memo,CHARINDEX(' ',a.memo)+1,len(a.memo))else
				(select top 1 carno from cara c where mon<=left(a.carno,6) and a.custno=c.carownerno order by mon desc,carno)end) = '"+@carno+"'),0)"
				execute sp_executesql @cmd,N'@unpay float OUTPUT', @unpay OUTPUT
			end
			
			set @t_total=isnull(@outmoney,0)-isnull(@inmoney,0)+@unpay
			
			--印出車牌和車主
			insert into @tmpa
			select @gno,@noa,@noq,@carno,@carownerno,@carowner,@indate,@carbrandno,@carbrand,@caryear,@mobile,@caritemno,@caritem,@mon,@datea,@memo,@outmoney+@unpay,@inmoney,@t_total,@count,''
			set @count=@count+1
			set @t_pagecount=@t_pagecount+1
			set @t_outmoney=@t_outmoney+@outmoney
			set @t_inmoney=@t_inmoney+@inmoney
			
		end
		else
		begin
			--之後的資料不印出001
			if(@caritemno!='001')
			begin
				--計算餘額和欠款累計
				if(@gno='0')
				begin
					set @t_total=@t_total+isnull(@outmoney,0)-isnull(@inmoney,0)
					set @t_outmoney=@t_outmoney+@outmoney
					set @t_inmoney=@t_inmoney+@inmoney
				end
				
				if(@gno='2')
				begin
					insert into @tmpa
					select @gno,@noa,@noq,@carno,@carownerno,'',@indate,@carbrandno,@carbrand,@caryear,@mobile,@caritemno,@caritem,@mon,@datea,@memo,@t_outmoney+@unpay,@t_inmoney,@t_total,@count,''
					set @count=@count+1
					set @t_pagecount=@t_pagecount+1
				end
				else if(@gno='3')
				begin
					insert into @tmpa
					select @gno,@noa,@noq,@carno,@carownerno,'',@indate,@carbrandno,@carbrand,@caryear,@mobile,@caritemno,@caritem,@mon,@datea,@memo,@outmoney+@unpay,@inmoney,@t_total,@count,''
					set @count=@count+1
					set @t_pagecount=@t_pagecount+1
				end
				else
				begin
					if(@gno='0' and @t_pagecount%@pageCount=1)
						begin
							insert into @tmpa
							select @gno,@noa,@noq,@carno,@carownerno,@carowner,@indate,@carbrandno,@carbrand,@caryear,@mobile,@caritemno,@caritem,@mon,@datea,@memo,@outmoney,@inmoney,@t_total,@count,''
						end
					else
						begin
							if(@gno='4')--20130119改成最後一個月cara的金額合計(檢查是否結轉正確)
							begin
								insert into @tmpa
								select @gno,@noa,@noq,'',@carownerno,'',@indate,@carbrandno,@carbrand,@caryear,@mobile,@caritemno,@caritem,@mon,@datea,@memo,@outmoney,@inmoney,@t_total,@count,''
								--select @gno,@noa,@noq,'',@carownerno,'',@indate,@carbrandno,@carbrand,@caryear,@mobile,@caritemno,@caritem,@mon,@datea,@memo,@outmoney,@inmoney,@total,@count,''
							end
							else
							begin
								insert into @tmpa
								select @gno,@noa,@noq,'',@carownerno,'',@indate,@carbrandno,@carbrand,@caryear,@mobile,@caritemno,@caritem,@mon,@datea,@memo,@outmoney,@inmoney,@t_total,@count,''
							end
						end
					
					set @count=@count+1
					set @t_pagecount=@t_pagecount+1
					if(@gno='4')
					begin
						insert into @tmpa
						select '6','','','',@t_carownerno,'','','','','','','','','','','',@x_count,0,@x_total,@count,''
						set @count=@count+1
						set @t_pagecount=@t_pagecount+1
					end
				end
				
			end
		end
		
		if(@gno='3')
		begin
			update @tmpa
			set outmoney=(select SUM(outmoney) from @tmpa where gno='2' and carownerno=@carownerno and carno=@carno),
				inmoney=(select SUM(inmoney) from @tmpa where gno='2' and carownerno=@carownerno and carno=@carno)
			where gno='3' and carownerno=@carownerno and carno=@carno
			
			set @x_total=@x_total+(select SUM(outmoney) from @tmpa where gno='2' and carownerno=@carownerno and carno=@carno)-(select SUM(inmoney) from @tmpa where gno='2' and carownerno=@carownerno and carno=@carno)
			set @x_count=@x_count+1
		end
		
		--set @count=@count+1
		set @t_mon=@mon
		set @t_carownerno=@carownerno
		
		fetch next from cursor_table 
		into @gno,@noa,@noq,@carno,@carownerno,@carowner,@indate,@carbrandno,@carbrand,@caryear,@mobile,@caritemno,@caritem,@mon,@datea,@memo,@outmoney,@inmoney,@total
	end 
close cursor_table 
deallocate cursor_table 
---------------------最後一筆
			if((@t_pagecount+1)%@pageCount=1)
				begin
					insert into @tmpa
					select '8','','','',@t_carownerno,'','','','','','','','','','','',@x_count,0,@x_total,@count,@t_xmemo
				end
			else
				begin
					insert into @tmpa
					select '5','','','',@t_carownerno,'','','','','','','','','','','',@x_count,0,@x_total,@count,''
				end
			set @x_total =0
			set @x_count =0
			set @count=@count+1
			set @t_pagecount=@t_pagecount+1
			
			while (@t_pagecount%@pageCount>1 )
			begin
				insert into @tmpa
				select '6','','','',@t_carownerno,'','','','','','','','','','','',@x_count,0,@x_total,@count,''
				set @count=@count+1
				set @t_pagecount=@t_pagecount+1
			end
			
			if(@t_pagecount%@pageCount!=1)
			begin
				insert into @tmpa
				select '7','','','',@t_carownerno,'','','','','','','','','','','',@x_count,0,@x_total,@count,@t_xmemo
				set @count=@count+1
				set @t_pagecount=1
			end
----------------------------------
select gno,noa,noq,carno,carownerno,carowner,indate,carbrandno,carbrand,caryear,mobile,caritemno,caritem,mon,datea,left(memo,17) memo
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,outmoney),1)),4,12)) outmoney
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,inmoney),1)),4,12)) inmoney
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total),1)),4,12)) total
,count,xmemo
from @tmpa order by count;
--------------------------------------------------------------------------------------------------
z_car35:--z_car35
declare @t_bmon nvarchar(20)
declare @t_emon nvarchar(20)
declare @t_bdate nvarchar(20)
declare @t_edate nvarchar(20)
declare @t_bcardealno nvarchar(20)
declare @t_ecardealno nvarchar(20)
declare @t_bcarownerno nvarchar(20)
declare @t_ecarownerno nvarchar(20)
declare @t_bcarno nvarchar(20)
declare @t_ecarno nvarchar(20)
declare @t_bcaritemno nvarchar(20)
declare @t_ecaritemno nvarchar(20)
declare @t_order nvarchar(20)
declare @carc nvarchar(20)

set @t_bmon = case when '#non' = [1] then '' else [1] end
set @t_emon = case when '#non' = [2] then CHAR(255) else [2] end
set @t_bdate = case when '#non' = [3] then '' else [3] end
set @t_edate = case when '#non' = [4] then CHAR(255) else [4] end
set @t_bcardealno = case when '#non'=[5] then '' else [5] end
set @t_ecardealno  = case when '#non'=[6] then char(255) else [6] end
set @t_bcarownerno = case when '#non'=[7] then '' else [7] end
set @t_ecarownerno  = case when '#non'=[8] then char(255) else [8] end
set @t_bcarno = case when '#non' = [16] then '' else [16] end
set @t_ecarno = case when '#non' = [17] then CHAR(255) else [17] end
set @t_bcaritemno = case when '#non' = [32] then '' else [32] end
set @t_ecaritemno = case when '#non' = [33] then CHAR(255) else [33] end
set @t_order = case when '#non' = [34] then '車牌' else [34] end
set @carc = case when '#non'=[41] then '' else [41] end
--**********************************************************************************************
SET QUOTED_IDENTIFIER OFF
declare @cmd nvarchar(MAX)
declare @tmp table( 
	gno nvarchar(1), 
	idno int identity(0,1),
	mon nvarchar(10), 
	datea nvarchar(10), 
	carno nvarchar(20), 
	carownerno nvarchar(20), 
	carowner nvarchar(50), 
	cardealno nvarchar(20), 
	cardeal nvarchar(50), 
	caritemno nvarchar(20), 
	caritem nvarchar(20), 
	outmoney float, 
	inmoney float, 
	memo nvarchar(200) 
) 

set @cmd=" 
	select '0'gno,a.mon,a.datea,a.carno,b.carownerno,b.carowner,c.cardealno,d.nick, 
	a.caritemno,a.caritem,a.outmoney,a.inmoney,a.memo from caras a 
	left join cara b on a.noa=b.noa 
	left join car2 c on b.carno=c.noa 
	left join cardeal d on c.cardealno=d.noa 
	where (a.mon between '"+@t_bmon+"' and '"+@t_emon+"') and 
	(a.datea between '"+@t_bdate+"' and '"+@t_edate+"') and 
	(a.carno between '"+@t_bcarno+"' and '"+@t_ecarno+"') and 
	(a.caritemno between '"+@t_bcaritemno+"' and '"+@t_ecaritemno+"') and 
	(b.carownerno between '"+@t_bcarownerno+"' and '"+@t_ecarownerno+"') and 
	(c.cardealno between '"+@t_bcardealno+"' and '"+@t_ecardealno+"') "
	
if(@carc='未付立帳')
begin
	set @cmd=@cmd+"and (udate='' or udate is null)
	and caritemno!='401' and caritemno!='001' and caritemno!='002' and caritemno!='101' 
	and caritemno!='102' and caritemno!='105' and caritemno!='106' and caritemno!='111' 
	and caritemno!='112' and caritemno!='202' and caritemno!='203' 
	and ummnoa='' and a.outmoney!=0 "
end

if(@t_order='車牌')
begin
	set @cmd=@cmd+"order by a.mon,a.datea,a.carno,b.carowner "
end

if(@t_order='車主')
begin
	set @cmd=@cmd+"order by a.mon,a.datea,b.carowner,a.carno"
end

if(@t_order='車行')
begin
	set @cmd=@cmd+"order by a.mon,a.datea,c.cardealno ,a.carno"
end

insert into @tmp 
execute sp_executesql @cmd

insert into @tmp 
select '1' gno,mon,datea,'','','','','','','',SUM(outmoney),SUM(inmoney),'' 
from @tmp 
group by mon,datea

insert into @tmp 
select '2' gno,CHAR(255),CHAR(255),CHAR(255),CHAR(255),CHAR(255),CHAR(255),CHAR(255),'','',SUM(outmoney),SUM(inmoney),'' 
from @tmp where gno='0'

declare @tmpa table( 
	gno nvarchar(1), 
	idno int,
	mon nvarchar(10), 
	datea nvarchar(10), 
	carno nvarchar(20), 
	carownerno nvarchar(20), 
	carowner nvarchar(50), 
	cardealno nvarchar(20), 
	cardeal nvarchar(50), 
	caritemno nvarchar(20), 
	caritem nvarchar(20), 
	outmoney float, 
	inmoney float, 
	memo nvarchar(200) 
) 
insert into @tmpa
select * from @tmp
order by mon,datea,gno,idno

declare @mon nvarchar(20)
declare @datea nvarchar(20)
declare @carno nvarchar(20)
declare @carowner nvarchar(20)
declare @t_mon nvarchar(20)
declare @t_datea nvarchar(20)
declare @t_carno nvarchar(20)
declare @t_carowner nvarchar(20)
set @t_mon = 'qwerty'
set @t_datea = 'asdfg'
set @t_carno = 'wdfvbg'
set @t_carowner = 'plmkiuj'
	declare cursor_table cursor for
	select mon,datea,carno,carowner
	from @tmpa
	open cursor_table 
	fetch next from cursor_table
	into @mon,@datea,@carno,@carowner
	while(@@FETCH_STATUS <> -1)
	begin
		if (@mon = @t_mon) and (@datea = @t_datea) and (@t_mon != 'qwerty') and (@t_datea != 'asdfg')
		begin
			if (@carno = @t_carno) and (@carowner = @t_carowner) and ( @t_carno != 'wdfvbg') and ( @t_carowner != 'plmkiuj')
			begin
				update @tmpa set mon ='',datea = '',carno = '',carowner = '' where current of cursor_table
			end
			else 
			begin 
				set @t_carno = @carno
				set @t_carowner = @carowner
				update @tmpa set mon = '' , datea = '' where current of cursor_table
			end
		end
		else
		begin
			set @t_carno = @carno 
			set @t_carowner = @carowner
			set @t_mon = @mon
			set @t_datea = @datea
		end
	fetch next from cursor_table
	into @mon,@datea,@carno,@carowner
	end
	close cursor_table
	deallocate cursor_table

select gno,mon,datea,carno,carowner,cardealno,cardeal,caritemno,caritem,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,outmoney),1)),4,12)) outmoney,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,inmoney),1)),4,12)) inmoney,
memo,@t_order t_order
from @tmpa;
--******************************************************************************************
z_car37:--z_car37
SET QUOTED_IDENTIFIER OFF
	declare @t_bcardealno nvarchar(20)
	declare @t_ecardealno nvarchar(20)
	declare @t_xmon nvarchar(10)
	declare @t_sssno nvarchar(20)
	declare @t_year nvarchar(20)
	declare @t_tax nvarchar(20)
	declare @sheetyn nvarchar(20)
	
	set @t_bcardealno = case when '#non'=[5] then '' else [5] end
	set @t_ecardealno  = case when '#non'=[6] then char(255) else [6] end	
	set @t_xmon  = case when '#non'=[18] then '' else [18] end
	set @t_sssno  = case when '#non'=[24] then char(255) else [24] end
	set @t_year = case when '#non' = [35] then '' else [35] end
	set @t_tax = case when '#non' = [36] then '' else [36] end
	set @sheetyn = case when '#non' = [37] then '' else [37] end
--*********************************************************************************** 
	declare @tmp table( 
		recno int IDENTITY (1, 1),
		gno nvarchar(1), 		
		carno nvarchar(20),--車牌號碼 
		cardeal nvarchar(20),--車行
		mon nvarchar(10),
		memo nvarchar(MAX),
		outmoney float,
		paydate nvarchar(20),
		fareyn nvarchar(20),
		sheetyn nvarchar(20) 
	) 
	
	declare @cmd nvarchar(MAX)
	
	set @cmd="
	select '0'gno,a.carno,c.nick,a.mon,a.memo,a.outmoney,a.paydate,a.fareyn,a.sheetyn
	from caras a left join car2 b on a.carno=b.noa left join cardeal c on b.cardealno=c.noa
	where (b.cardealno between '"+@t_bcardealno+"' and '"+@t_ecardealno+"')
	and left(a.mon,3)='"+@t_year+"' and  a.fareyn=''"
	
	if(PATINDEX('%已收單%',@sheetyn)>0)
	set @cmd=@cmd+" and (a.sheetyn='Y' or a.sheetyn='y')"
	
	if(PATINDEX('%未收單%',@sheetyn)>0)
	set @cmd=@cmd+" and (a.sheetyn='N' or a.sheetyn='n' or a.sheetyn='' or a.sheetyn is null)"
	
	declare @ssscount int
	set @ssscount=0
	
	while(PATINDEX('%,%',@t_sssno)>0)
	begin
		if (@ssscount=0)
			set @cmd=@cmd+" and (b.sssno='"+LEFT(@t_sssno,PATINDEX('%,%',@t_sssno)-1)+"'"
		else
			set @cmd=@cmd+" or b.sssno='"+LEFT(@t_sssno,PATINDEX('%,%',@t_sssno)-1)+"'"
			
		set @t_sssno=RIGHT(@t_sssno,LEN(@t_sssno)-PATINDEX('%,%',@t_sssno))
		set @ssscount=@ssscount+1
	end
	
	if (@ssscount=0)
		set @cmd=@cmd+" and (b.sssno='"+@t_sssno+"'"
	else
		set @cmd=@cmd+" or b.sssno='"+@t_sssno+"'"
	
	set @cmd=@cmd+")"
	
	declare @year nvarchar(MAX)
	
	if(@t_tax='春季燃料稅')
	begin
		set @cmd=@cmd+" and(a.caritemno='502' and a.memo like '%春%')"
		set @year=@t_year+'春季燃料費'
	end
	if(@t_tax='上期牌照稅')
	begin
		set @cmd=@cmd+" and(a.caritemno='501' and a.memo like '%上%')"
		set @year=@t_year+'上期牌照稅'
	end
	if(@t_tax='夏季燃料費')
	begin
		set @cmd=@cmd+" and(a.caritemno='502' and a.memo like '%夏%')"
		set @year=@t_year+'夏季燃料費'
	end
	if(@t_tax='秋季燃料費')
	begin
		set @cmd=@cmd+" and(a.caritemno='502' and a.memo like '%秋%')"
		set @year=@t_year+'秋季燃料費'
	end
	if(@t_tax='下期牌照稅')
	begin
		set @cmd=@cmd+" and(a.caritemno='501' and a.memo like '%下%')"
		set @year=@t_year+'下期牌照稅'
	end
	if(@t_tax='冬季燃料費')
	begin
		set @cmd=@cmd+" and(a.caritemno='502' and a.memo like '%冬%')"
		set @year=@t_year+'冬季燃料費'
	end
	
	insert into @tmp 
	execute sp_executesql @cmd
	
	insert into @tmp
	select '1','','','','',sum(outmoney),'','','' from @tmp
	
	select recno,gno,carno,cardeal,mon,memo,paydate,fareyn,sheetyn,@year year,
	reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,outmoney),1)),4,12)) outmoney
	from @tmp;
--***********************************************************************************************************
z_car38:--z_car38
	declare @t_bcarownerno nvarchar(20)
	declare @t_ecarownerno nvarchar(20)
	declare @t_enddate nvarchar(10)
	
	set @t_bcarownerno = case when '#non'=[7] then '' else [7] end
	set @t_ecarownerno  = case when '#non'=[8] then char(255) else [8] end	
	set @t_enddate = case when '#non'=[15] then '' else [15] end
	
	declare @tmp table( 
		gno nvarchar(1), 		
		compno nvarchar(50),
		comp nvarchar(50),
		typea nvarchar(10),
		datea nvarchar(10),
		indate nvarchar(10),
		gqbno nvarchar(30),
		account nvarchar(30),
		bank nvarchar(30),
		money float,
		memo nvarchar(MAX) 
	)
	
	insert into @tmp
	select '0'gno,compno,comp,case when typea=1 then '收票' when typea=2 then '開票' when typea=3 then '收退' else '開退' end typea,
	datea,indate,gqbno,account,bank,money,memo
	from gqb
	where left(compno,1)='H' and (len(enda)=0 or enda is null or enda ='N' or enda='n') and len(indate)=9
	and (left(right('0'+CONVERT (nvarchar(7),CONVERT (VARCHAR(7),dateadd(d,-5,CONVERT(datetime ,CONVERT(nvarchar(10),CONVERT(int,left(@t_enddate,3))+1911)+right(left(@t_enddate,6),2)+right(left(@t_enddate,9),2)) ),12 )+0890000),7),3)+'/'
	+right(left(right('0'+CONVERT (nvarchar(7),CONVERT (VARCHAR(7),dateadd(d,-5,CONVERT(datetime ,CONVERT(nvarchar(10),CONVERT(int,left(@t_enddate,3))+1911)+right(left(@t_enddate,6),2)+right(left(@t_enddate,9),2)) ),12 )+0890000),7),5),2)+'/'
	+right(right('0'+CONVERT (nvarchar(7),CONVERT (VARCHAR(7),dateadd(d,-5,CONVERT(datetime ,CONVERT(nvarchar(10),CONVERT(int,left(@t_enddate,3))+1911)+right(left(@t_enddate,6),2)+right(left(@t_enddate,9),2)) ),12 )+0890000),7),2))<=indate
	and (compno between @t_bcarownerno and @t_ecarownerno)
	order by compno
	
	insert into @tmp 
	select '1',compno,b.namea,'','','','','','',sum(money),'' from @tmp a left join carOwner b on a.compno=b.noa
	group by compno,b.namea
	
	insert into @tmp
	select '2','ZZZZ','','','','','','','',sum(money),'' from @tmp

	select gno,compno,comp,typea,datea,indate,gqbno,account,bank,
	reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,money),1)),4,12)) money,	memo
	from @tmp order by compno,gno;
--***********************************************************************************************
z_car39:--z_car39
	declare @t_bcardealno nvarchar(20)
	declare @t_ecardealno nvarchar(20)
	declare @xyear nvarchar(10)
	
	set @t_bcardealno = case when '#non'=[5] then '' else [5] end
	set @t_ecardealno  = case when '#non'=[6] then char(255) else [6] end	
	set @xyear = case when '#non' = [35] then '' else [35] end
--**********************************************************************************************

declare @tmp table( 
		gno nvarchar(1), 		
		carno nvarchar(50),
		year nvarchar(10),
		namea nvarchar(50),
		id nvarchar(10),
		addr nvarchar(MAX),
		jan float,
		feb float,
		mar float,
		apr float,
		may float,
		jun float,
		jul float,
		aug float,
		sep float,
		oct float,
		nov float,
		dec float,
		total float,
		memo nvarchar(MAX),
		cardealno nvarchar(20),
		comp nvarchar(MAX)
	)
	insert into @tmp
	select '0',a.noa,a.year,a.namea,a.id,a.addr,a.jan,a.feb,a.mar,a.apr,a.may,a.jun,a.jul,a.aug,a.sep,a.oct,a.nov,a.dec,
	(a.jan+a.feb+a.mar+a.apr+a.may+a.jun+a.jul+a.aug+a.sep+a.oct+a.nov+a.dec)total,a.memo,b.cardealno,c.comp
	from carsalary a left join car2 b on a.noa=b.noa
	left join cardeal c on b.cardealno=c.noa
	where (b.cardealno between @t_bcardealno and @t_ecardealno) and a.year=@xyear
	
	insert into @tmp (gno,cardealno,total)
	select '1',cardealno,sum(total)
	from @tmp group by cardealno
	
	select gno,carno,year,namea,id,addr,memo,comp
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,jan),1)),4,12)) jan
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,feb),1)),4,12)) feb
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,mar),1)),4,12)) mar
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,apr),1)),4,12)) apr
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,may),1)),4,12)) may
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,jun),1)),4,12)) jun
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,jul),1)),4,12)) jul
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,aug),1)),4,12)) aug
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,sep),1)),4,12)) sep
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,oct),1)),4,12)) oct
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,nov),1)),4,12)) nov
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,dec),1)),4,12)) dec
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total),1)),4,12)) total
	from @tmp order by cardealno,gno,carno;




