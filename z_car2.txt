z_car21:--z_car21
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_bcardealno nvarchar(20)
	declare @t_ecardealno nvarchar(20)
	declare @t_bcarownerno nvarchar(20)
	declare @t_ecarownerno nvarchar(20)
	declare @t_bcarno nvarchar(20)
	declare @t_ecarno nvarchar(20)

	set @t_bdate = case when '#non'=[3] then '' else [3] end
	set @t_edate = case when '#non'=[4] then char(255) else [4] end
	set @t_bcardealno = case when '#non'=[5] then '' else [5] end
	set @t_ecardealno  = case when '#non'=[6] then char(255) else [6] end	
	set @t_bcarownerno = case when '#non'=[7] then '' else [7] end
	set @t_ecarownerno  = case when '#non'=[8] then char(255) else [8] end	
	set @t_bcarno = case when '#non'=[16] then '' else [16] end
	set @t_ecarno  = case when '#non'=[17] then char(255) else [17] end	
		
	--***********************************************************************************
	declare @tmp table(
		gno nvarchar(1),
		recno int,--順序
		checkdate nvarchar(10),--驗車日期
		carno nvarchar(20),--車牌號碼
		carowner nvarchar(20),--車主
		passdate nvarchar(10),--發照日期
		caryeartw nvarchar(10),--出廠
		carbrand nvarchar(20),--廠牌
		insurance nvarchar(10),--保險止日
		cardeal nvarchar(20)--車行
	)

	insert into @tmp
		select 
			'0' gno,
			ROW_NUMBER()over(order by (case when len(@t_bdate+@t_edate)=0 then LEFT(a.checkdate,6) else a.checkdate end),a.carno),
			a.checkdate,
			a.carno,
			b.namea,
			a.passdate,
			a.caryeartw,
			c.brand,
			d.edate,
			e.nick
		from car2 a
		left join carowner b on a.carownerno = b.noa
		left join carbrand c on a.carbrandno = c.noa
		left join (select noa,MAX(case when len(stopdate)>0 then stopdate else edate end) edate from carInsure group by noa) as d on a.carno = d.noa
		left join cardeal e on a.cardealno = e.noa
		where (a.checkdate between @t_bdate and @t_edate) and 
			  (a.cardealno between @t_bcardealno and @t_ecardealno) and
			  (a.carownerno between @t_bcarownerno and @t_ecarownerno) and 
 			 (a.carno between @t_bcarno and @t_ecarno)
 		order by a.checkdate,a.carno
	--***********************************************************************************
	select * from @tmp;

z_car22:--z_car22
	declare @t_bcardealno nvarchar(20)
	declare @t_ecardealno nvarchar(20)
	declare @t_bcarownerno nvarchar(20)
	declare @t_ecarownerno nvarchar(20)
	declare @t_enddate nvarchar(10)
	
	set @t_bcardealno = case when '#non'=[5] then '' else [5] end
	set @t_ecardealno  = case when '#non'=[6] then char(255) else [6] end	
	set @t_bcarownerno = case when '#non'=[7] then '' else [7] end
	set @t_ecarownerno  = case when '#non'=[8] then char(255) else [8] end	
	set @t_enddate = case when '#non'=[15] then '' else [15] end			
	--***********************************************************************************
	
	declare @cmb table(
	noa nvarchar(10),
	bdate nvarchar(10),
	edate nvarchar(10),
	smoney int,
	[money] int
)
insert into @cmb
select noa,LEFT(bdate,6),LEFT(edate,6),installmentamount,money
from carLender

declare @cmby table(
		noa nvarchar(10),
		byear int,
		eyear int,
		bmon int,
		emon int,
		toyear int,
		tomon int,
		a int,
		b int,
		[money] int,
		smoney int,
		paytotal int,
		loantotal int 
)
insert into @cmby
select noa,LEFT(bdate,3),LEFT(edate,3),RIGHT(bdate,2),RIGHT(edate,2), CONVERT(VARCHAR(4),SUBSTRING(CONVERT(VARCHAR ,GETDATE(),112), 1, 4)-1911),CONVERT(VARCHAR(2),SUBSTRING(CONVERT(VARCHAR ,GETDATE(),112), 5, 2)),0,0,money,smoney,0,0
from @cmb
where LEFT(bdate,3) != 0 and RIGHT(bdate,2) != 0

update @cmby set a = (eyear-byear)*12+emon-bmon, b = case when (eyear-byear)*12+emon-bmon < (toyear-byear)*12+tomon-bmon then (eyear-byear)*12+emon-bmon else (toyear-byear)*12+tomon-bmon end where noa=noa 

declare @cmbyt table(
	    noa nvarchar(10),
		byear int,
		eyear int,
		bmon int,
		emon int,
		toyear int,
		tomon int,
		a int,
		b int,
		c int,
		[money] int,
		smoney int,
		paytotal int,
		loantotal int
)
insert into @cmbyt
select noa,byear,eyear,bmon,emon,toyear,tomon,a,b,a-b,money,smoney,case when a-b=0 then money else b*smoney end,(a-b)*smoney
from @cmby
	declare @tmp table(
		gno nvarchar(1),
		cardealno nvarchar(20),
		車行 nvarchar(20),
		carownerno nvarchar(20),
		車主 nvarchar(20),
		carno nvarchar(20),--車號
		廠牌 nvarchar(20),
		年份 nvarchar(10),
		貸款公司 nvarchar(20),
		貸款金額 int,
		每期還款 int,
		期數 int,
		還款總額 int,
		所剩期數 int,
		貸款餘額 int,
		貸款起日  nvarchar(10),
		貸款迄日  nvarchar(10),
		備註  nvarchar(max)
	)
	
	insert into @tmp
		select 
			'0' gno,
			d.noa,
			d.nick,
			c.noa,
			c.namea,
			a.noa,
			e.brand,
			b.caryear,
			f.nick,
			a.money,
			a.installmentamount,
			case when a.installment != '' then a.installment  else g.a  end ,
			g.paytotal ,
			g.c ,
			g.loantotal ,
			a.bdate,
			a.edate,
			a.memo	
		from carLender a
		left join car2 b on b.noa = a.noa
		left join carOwner c on b.carownerno = c.noa
		left join cardeal d on b.cardealno = d.noa
		left join carbrand e on b.carbrandno = e.noa
		left join lender f on f.noa = a.lenderno 
		left join @cmbyt g on g.noa = a.noa
		where edate <= @t_edate and (len(@t_carno)=0 or a.noa=@t_carno) and
		      (b.carownerno between @t_bcarownerno and @t_ecarownerno) and
		      (b.cardealno between @t_bcardealno and @t_ecardealno)
		
	--**--------------------------------------------------------------------------------------------------------------
	select * from @tmp order by cardealno,carownerno,carno;
--********************************************************************************************************************

z_car23:--z_car23車主欠款明細--已移動至z_cara
SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	declare @pagecount int
	declare @t_bmon nvarchar(10)
	declare @t_emon nvarchar(10)
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_bcardealno nvarchar(20)
	declare @t_ecardealno nvarchar(20)
	declare @t_bcarownerno nvarchar(20)
	declare @t_ecarownerno nvarchar(20)
	declare @t_bdriverno nvarchar(20)
	declare @t_edriverno nvarchar(20)
	declare @t_bsssno nvarchar(20)
	declare @t_esssno nvarchar(20)
	declare @t_carteamno nvarchar(2)
	declare @t_carno nvarchar(20)
	declare @t_enddate nvarchar(10)
	set @pageCount = 12
	set @t_bmon = case when '#non'=[1] then '' else [1] end
	set @t_emon = case when '#non'=[2] then char(255) else [2] end
	set @t_bdate = case when '#non'=[3] then '' else [3] end
	set @t_edate = case when '#non'=[4] then char(255) else [4] end
	set @t_bcardealno = case when '#non'=[5] then '' else [5] end
	set @t_ecardealno  = case when '#non'=[6] then char(255) else [6] end	
	set @t_bcarownerno = case when '#non'=[7] then '' else [7] end
	set @t_ecarownerno  = case when '#non'=[8] then char(255) else [8] end	
	set @t_bdriverno = case when '#non'=[9] then '' else [9] end
	set @t_edriverno  = case when '#non'=[10] then char(255) else [10] end	
	set @t_bsssno = case when '#non'=[11] then '' else [11] end
	set @t_esssno  = case when '#non'=[12] then char(255) else [12] end	
	set @t_carteamno = case when '#non'=[13] then '' else [13] end	
	set @t_carno = case when '#non'=[14] then '' else [14] end
	set @t_enddate = case when '#non'=[15] then '' else [15] end
declare @tmp table(
		[gno] nvarchar(1),
		[noa] nvarchar(20),
		[noq] nvarchar(3),
		[carno] nvarchar(20),
		[carownerno] nvarchar(20),
		[carowner] nvarchar(20),
		[indate] nvarchar(10),
		[carbrandno] nvarchar(10),
		[carbrand] nvarchar(20),
		[caryear] nvarchar(5),
		[mobile] nvarchar(20),
		[caritem] nvarchar(10),
		[mon] nvarchar(10),
		[datea] nvarchar(10),
		[memo] nvarchar(max),
		[outmoney] int,
		[inmoney] int,
		recno int,
		currecno int,
		curpage int,
		totpage int,
		[total] int,
		[cmount] int,
		primary key (carownerno,carno,noa,noq,gno)
)

declare @tmp2 table(
		[gno] nvarchar(1),
		[noa] nvarchar(20),
		[noq] nvarchar(3),
		[carno] nvarchar(20),
		[carownerno] nvarchar(20),
		[carowner] nvarchar(20),
		[indate] nvarchar(10),
		[carbrandno] nvarchar(10),
		[carbrand] nvarchar(20),
		[caryear] nvarchar(5),
		[mobile] nvarchar(20),
		[caritem] nvarchar(10),
		[mon] nvarchar(10),
		[datea] nvarchar(10),
		[memo] nvarchar(max),
		[outmoney] int,
		[inmoney] int,
		recno int,
		currecno int,
		curpage int,
		totpage int,
		[total] int,
		[cmount] int,
		primary key (carownerno,carno,noa,noq,gno)
)

  set @cmd =	"select a.*,ROW_NUMBER()over(order by gno),0,0,0,0,0 "+
				" from( " +
				"select '0' gno,a.noa ,a.noq,b.carno,isNull(c.carownerno,'') carownerno,isNull(d.namea,'') carowner,ISNULL(c.indate,'') indate, "+
				"ISNULL(e.noa,'') carbrandno,ISNULL(e.brand,'') carbrand,ISNULL(c.caryear,'') caryear,ISNULL(d.mobile,'') mobile, "+
				"a.caritem ,b.mon,a.datea,a.memo,a.outmoney,a.inmoney "+
				"from caras a "+
				"left join cara b on b.noa = a.noa "+
				"left join car2 c on c.noa = b.carno "+
				"left join carOwner d on d.noa = c.carownerno "+
				"left join carbrand e on e.noa = c.carbrandno "+
				" where "+
				"(len(@t_carno)=0 or a.noa=@t_carno) and "+
				"(c.carownerno between @t_bcarownerno and @t_ecarownerno) and "+
				"(b.mon between @t_bmon and @t_emon) and "+
				"(b.datea between @t_bdate and @t_edate) "+
				" )  a"
				
insert into @tmp
execute sp_executesql @cmd,N'@t_bdate nvarchar(10),@t_edate nvarchar(10),@t_carno nvarchar(20),@t_bcarownerno nvarchar(20),@t_ecarownerno nvarchar(20),
							@t_bmon nvarchar(10),@t_emon nvarchar(10)',
							@t_bdate=@t_bdate,@t_edate=@t_edate,@t_carno = @t_carno,@t_bcarownerno=@t_bcarownerno,@t_ecarownerno=@t_ecarownerno,
							@t_bmon=@t_bmon,@t_emon=@t_emon

--****************************************************************************************							
	declare @carownerno nvarchar(20)
	declare @noa nvarchar(20)
	declare @noq nvarchar(3)
	declare @carno nvarchar(20)
	declare @outmoney int
	declare @inmoney int
	declare @total int
	declare @count int
	declare @t_count int
	declare @recno int
	declare @currecno int
	declare @curpage int
	declare @totpage int
	declare @cmount int
	
	declare @t_carownerno nvarchar(20)
	declare @t_noq nvarchar(3)
	declare @t_noa nvarchar(20)
	declare @t_carnos nvarchar(20)
	declare @t_outmoney1 int
	declare @t_inmoney1 int
	declare @t_total1 int
	declare @t_outmoney2 int
	declare @t_inmoney2 int
	declare @t_total2 int
	declare @t_outmoney3 int
	declare @t_inmoney3 int
	declare @t_total3 int
	declare @t_cmount int
	declare @t_currecno float
	declare @t_bcarno nvarchar(20)
	declare @t_xcarownerno nvarchar(20)
	declare @t_bnoa nvarchar(20)
	declare @t_xrecno int
	
	set @t_carownerno = 'zzzzzzzzz'
	set @t_carnos = 'bbbbbbbb'
	set @t_noa = 'aaaaaaaa'
	set @t_noq = 'sdfwer'
	set @t_outmoney1 = 0
	set @t_inmoney1 = 0
	set @t_total1 = 0
	set @t_outmoney2 = 0
	set @t_inmoney2 = 0
	set @t_total2 = 0
	set @t_outmoney3 = 0
	set @t_inmoney3 = 0
	set @t_total3 = 0
	set @t_currecno = 0
	set @t_cmount = 0
	set @t_bcarno = ''
	set @t_xcarownerno = ''
	set @t_bnoa = ''
	set @t_xrecno = 1
--**************************計算月合計以noa	
	declare cursor_table cursor for
	select carownerno,carno,noa,noq,outmoney,inmoney,total,currecno,curpage,totpage from @tmp
	open cursor_table
	fetch next from cursor_table
	into @carownerno,@carno,@noa,@noq,@outmoney,@inmoney,@total,@currecno,@curpage,@totpage
	while(@@FETCH_STATUS <> -1)
	begin
		if not(@t_noa = @noa)
		begin
			if not(@t_noa = 'aaaaaaaa')
			begin
				insert into @tmp
				select '1' gno,@t_bnoa,CHAR(255),@t_bcarno,@t_xcarownerno,'','','','','','','','','','',@t_outmoney1,@t_inmoney1,0,@t_currecno,@curpage,@totpage,@t_total1,0
			end
			set @t_noa = @noa
			set @t_outmoney1 = @outmoney 
			set @t_inmoney1 = @inmoney
			set @t_total1 = @inmoney - @outmoney
			set @t_currecno = @currecno
		end
		else
		begin
			set @t_outmoney1 = @t_outmoney1 + @outmoney
			set @t_inmoney1 = @t_inmoney1 + @inmoney
			set @t_total1 = @t_total1 + @inmoney - @outmoney
			set @t_currecno = @currecno +1
		end
		set @t_bcarno = @carno
		set @t_xcarownerno = @carownerno
		set @t_bnoa = @noa
		
		update @tmp set total = @t_total1 where  noa=@noa and noq=@noq 
		fetch next from cursor_table
		into @carownerno,@carno,@noa,@noq,@outmoney,@inmoney,@total,@currecno,@curpage,@totpage
	end
	close cursor_table
	deallocate cursor_table
		if NOT(@t_noa = 'aaaaaaaa')
	begin
		insert @tmp
		select '1' gno,@t_bnoa,CHAR(255),@t_bcarno,@t_xcarownerno,'','','','','','','','','','',@t_outmoney1,@t_inmoney1,0,@t_currecno,@curpage,@totpage,@t_total1,0
	end
	
--***************************計算欠款累額以carno		
	declare cursor_table cursor for
	select carownerno,carno,noa,noq,outmoney,inmoney,total,currecno,curpage,totpage from @tmp
	open cursor_table
	fetch next from cursor_table
	into @carownerno,@carno,@noa,@noq,@outmoney,@inmoney,@total,@currecno,@curpage,@totpage
	while(@@FETCH_STATUS <> -1)
	begin
		if not(@t_carnos = @carno)
		begin
			if not(@t_carnos = 'bbbbbbbb')
			begin
				insert into @tmp
				select '2' gno, @t_bnoa,CHAR(255),@t_bcarno,@t_xcarownerno,'','','','','','','','','','',@t_outmoney2,@t_inmoney2,0,0,0,0,@t_total2,0
				insert into @tmp
				select '3' gno, @t_bnoa,CHAR(255),@t_bcarno,@t_xcarownerno,'','','','','','','','','','',@t_outmoney2,@t_inmoney2,0,0,0,0,@t_total2,0
			end
			set @t_carnos = @carno
			set @t_outmoney2 = @outmoney 
			set @t_inmoney2 = @inmoney
			set @t_total2 = @inmoney - @outmoney
		end
		else
		begin
			set @t_outmoney2 = @t_outmoney2 + @outmoney
			set @t_inmoney2 = @t_inmoney2 + @inmoney
			set @t_total2 = @t_total2 + @inmoney - @outmoney
		end
		set @t_bcarno = @carno
		set @t_xcarownerno = @carownerno
		set @t_bnoa = @noa
		fetch next from cursor_table
		into @carownerno,@carno,@noa,@noq,@outmoney,@inmoney,@total,@currecno,@curpage,@totpage
	end
	close cursor_table
	
	deallocate cursor_table
	if NOT(@t_carnos = 'bbbbbbbb')
	begin
		insert @tmp
		select '2' gno,@t_bnoa,CHAR(255),@t_carnos,@carownerno,'','','','','','','','','','',@t_outmoney2,@t_inmoney2,0,0,0,0,@t_total2,0
		insert @tmp
		select '3' gno,@t_bnoa,CHAR(255),@t_carnos,@carownerno,'','','','','','','','','','',@t_outmoney2,@t_inmoney2,0,0,0,0,@t_total2,0
	end	
--************************************計算總欠金額以carownerno	
	declare cursor_table cursor for
	select carownerno,carno,noa,noq,outmoney,inmoney,total,cmount from @tmp 
	open cursor_table
	fetch next from cursor_table
	into @carownerno,@carno,@noa,@noq,@outmoney,@inmoney,@total,@cmount
	while(@@FETCH_STATUS <> -1)
	begin
		if not(@t_carownerno = @carownerno)
		begin
			if not(@t_carownerno = 'zzzzzzzzz')
			begin	
				select @cmount=COUNT(distinct carno) from @tmp group by carownerno
				insert into @tmp
				select '4' gno,CHAR(255),CHAR(255),CHAR(255),@t_carownerno,'','','','','','','','','','',@t_outmoney3,@t_inmoney3,0,0,0,0,@t_total3,@cmount
				
			end
			set @t_carownerno = @carownerno
			set @t_outmoney3 = @outmoney 
			set @t_inmoney3 = @inmoney
			set @t_total3 = @inmoney - @outmoney
			end
		else
		begin
			set @t_outmoney3 = @t_outmoney3 + @outmoney
			set @t_inmoney3 = @t_inmoney3 + @inmoney
			set @t_total3 = @t_total3 + @inmoney - @outmoney
			end
		update @tmp set total = @t_total3 where noa = @noa and noq = @noq 
		fetch next from cursor_table
		into @carownerno,@carno,@noa,@noq,@outmoney,@inmoney,@total,@cmount
	end
	close cursor_table
	deallocate cursor_table
	
	if NOT(@t_carownerno = 'zzzzzzzzz')
	begin
		select @cmount=COUNT(distinct carno) from @tmp group by carownerno
		insert @tmp
		select '4' gno,CHAR(255),CHAR(255),CHAR(255),@t_carownerno,'','','','','','','','','','',@t_outmoney3,@t_inmoney3,0,0,0,0,@t_total3,@cmount
		
	end	
	
	------------------------------------------*******************
	insert into @tmp2
	select gno,noa,noq,carno,carownerno,carowner,indate,carbrandno,carbrand,caryear,mobile,caritem,mon,datea,memo,outmoney,inmoney,
ROW_NUMBER() over (order by carownerno,carno,noa,noq,gno),currecno,curpage,totpage,total,cmount from @tmp	
	
	delete @tmp
	insert into @tmp
	select * from @tmp2
 	------------------------------------------********************
 
 --******************************計算currecon	
	declare cursor_table cursor for
	select carownerno,min(recno) from @tmp group by carownerno
	open cursor_table
	fetch next from cursor_table
	into @carownerno,@recno
	while(@@FETCH_STATUS <> -1)
	begin
		update @tmp set currecno = recno - @recno +1 where carownerno=@carownerno
		fetch next from cursor_table
		into @carownerno,@recno
	end
	close cursor_table
	deallocate cursor_table
	
--**************************計算totpage
	declare cursor_table cursor for
	select carownerno,max(currecno) from @tmp group by carownerno
	open cursor_table
	fetch next from cursor_table
	into @carownerno,@currecno
	while(@@FETCH_STATUS <> -1)
	begin
		update @tmp set totpage = (@currecno-@currecno%@pagecount)/@pagecount+1 where carownerno=@carownerno
		fetch next from cursor_table
		into @carownerno,@currecno
	end
	close cursor_table
	deallocate cursor_table

--**********************************計算curpage	
	declare cursor_table cursor for
	select carownerno,recno,currecno from @tmp
	open cursor_table
	fetch next from cursor_table
	into @carownerno,@recno,@currecno
	while(@@FETCH_STATUS <> -1)
	begin
		update @tmp set curpage = FLOOR((@currecno-1)/@pagecount)+1 where carownerno=@carownerno and recno=@recno
		fetch next from cursor_table
		into @carownerno,@recno,@currecno
	end
		close cursor_table
	deallocate cursor_table
	
	
	--------------------------------
select *,CONVERT(nvarchar(5),curpage)+'/'+CONVERT(nvarchar(5),totpage) page 
from @tmp 
order by carownerno, carno, noa, gno;
--**************************************************************************************************************************************
z_car25:--z_car25高額欠款追蹤依車號
	declare @t_bcarno nvarchar(20)
	declare @t_ecarno nvarchar(20)
	declare @t_xmon nvarchar(10)

	set @t_bcarno = case when '#non'=[16] then '' else [16] end
	set @t_ecarno  = case when '#non'=[17] then char(255) else [17] end
	set @t_xmon  = case when '#non'=[18] then '' else [18] end
--************************************************************************************
declare @result table(
		gno nvarchar(1),
		noa nvarchar(20),
		mon nvarchar(10),
		carno nvarchar(20),
		carownerno nvarchar(20),
		carowner nvarchar(20),
		cardealno nvarchar(20),
		cardeal nvarchar(20),
		indate nvarchar(10),
		caryear nvarchar(10),
		carbrandno nvarchar(20),
		carbrand nvarchar(20),
		tel nvarchar(20),
		mobile nvarchar(20),
		total float
)
insert into @result
select '0' gno,isnull(e.noa,''),isnull(e.mon,''),isnull(e.carno,''),a.carownerno,b.namea,a.cardealno,ISNULL(left(c.comp,3),''),a.indate,a.caryear,a.carbrandno, 
isnull(d.brand,''),b.tel1,b.mobile,isnull(e.paytotal,0)
from car2 a
left join carOwner b on b.noa = a.carownerno
left join  cardeal c on c.noa = a.cardealno
left join carbrand d on d.noa = a.carbrandno
left join cara e on e.carno = a.carno
where (e.mon=@t_xmon) and
(e.carno between @t_bcarno and @t_ecarno)
insert into @result
select '1' gno,'','',carno,'','','','','','','','','','',SUM(total)
from @result
group by carno

insert into @result
select '2' gno,'','',CHAR(255),'','','','','','','','','','',SUM(total)
from @result
where gno != 1

select *
from @result
order by carno,gno;
--**********************************************************************************

z_car26:--z_car26高額欠款追蹤依車主
	declare @t_bcarownerno nvarchar(20)
	declare @t_ecarownerno nvarchar(20)
	declare @t_xmon nvarchar(10)
	
	set @t_bcarownerno = case when '#non'=[7] then '' else [7] end
	set @t_ecarownerno  = case when '#non'=[8] then char(255) else [8] end	
	set @t_xmon  = case when '#non'=[18] then '' else [18] end
--************************************************************************************
declare @result table(
		gno nvarchar(1),
		noa nvarchar(20),
		mon nvarchar(10),
		carno nvarchar(20),
		carownerno nvarchar(20),
		carowner nvarchar(20),
		cardealno nvarchar(20),
		cardeal nvarchar(20),
		indate nvarchar(10),
		caryear nvarchar(10),
		carbrandno nvarchar(20),
		carbrand nvarchar(20),
		tel nvarchar(20),
		mobile nvarchar(20),
		total decimal(14,3)
)
insert into @result
select '0' gno,isnull(e.noa,''),isnull(e.mon,''),isnull(e.carno,''),a.carownerno,b.namea,a.cardealno,ISNULL(left(c.comp,3),''),a.indate,a.caryear,a.carbrandno, 
isnull(d.brand,''),b.tel1,b.mobile,isnull(e.paytotal,0)
from car2 a
left join carOwner b on b.noa = a.carownerno
left join  cardeal c on c.noa = a.cardealno
left join carbrand d on d.noa = a.carbrandno
left join cara e on e.carno = a.carno
where (e.mon=@t_xmon) and
(isnull(a.carownerno,'') between @t_bcarownerno and @t_ecarownerno)
insert into @result
select '1' gno,'','','','',carowner,'','','','','','','','',SUM(total)
from @result
group by carowner

insert into @result
select '2' gno,'','','','',CHAR(255),'','','','','','','','',SUM(total)
from @result
where not(gno = 1)

select *
from @result
where not(carowner = '')
order by carowner,gno;
--************************************************************************************

z_car27:--z_car27車輛統計表
	declare @t_bcardealno nvarchar(20)
	declare @t_ecardealno nvarchar(20)
	
	set @t_bcardealno = case when '#non'=[5] then '' else [5] end
	set @t_ecardealno  = case when '#non'=[6] then char(255) else [6] end	

declare @result table(
		gno nvarchar(1),
		noa nvarchar(20),
		cno nvarchar(20),
		cardeal nvarchar(20),
		carno nvarchar(20),
		carownerno nvarchar(20),
		carowner nvarchar(50),
		indate nvarchar(10),
		outdate nvarchar(10),
		stopdate nvarchar(10),
		wasted nvarchar(10),
		carkindno nvarchar(10),
		carkind nvarchar(10),
		caryear nvarchar(10),
		ton  nvarchar(20),
		carbrandno nvarchar(20),
		carbrand nvarchar(20)
)
insert into @result
select '0' gno,a.noa,a.cardealno,ISNULL(left(c.comp,3),''),a.carno,a.carownerno,b.namea,a.indate,a.outdate,
isnull(e.stopdate,''),isnull(e.wastedate,''),a.carkindno,ISNULL(f.kind,''),a.caryear,a.ton,a.carbrandno,isnull(d.brand,'')
from car2 a
left join carowner b on b.noa = a.carownerno
left join  cardeal c on c.noa = a.cardealno
left join carbrand d on d.noa = a.carbrandno
left join  carChange e on e.carno = a.carno
left join carKind f on f.noa = a.carkindno
where (a.cardealno between @t_bcardealno and @t_ecardealno)
insert into @result
select '1' gno,'',CHAR(255),'',COUNT(distinct carno),'','','','','','','','','','','',''
from @result

select *
from @result
order by cno,gno;

--***************************************************************************************
z_car28:--z_car28車籍資料列印

	declare @t_bcarno nvarchar(20)
	declare @t_ecarno nvarchar(20)

	set @t_bcarno = case when '#non'=[16] then '' else [16] end
	set @t_ecarno  = case when '#non'=[17] then char(255) else [17] end
--************************************************************************************
declare @result table(
		gno nvarchar(1),
		noa nvarchar(20),
		carno nvarchar(20),
		carownerno nvarchar(20),
		carowner nvarchar(20),
		cardealno nvarchar(20),
		cardeal nvarchar(20),
		sex nvarchar(1),
		idno nvarchar(50),
		birthday nvarchar(10),
		tel1 nvarchar(20),
		tel2 nvarchar(20),
		fax nvarchar(20),
		mobile nvarchar(20),
		addr_conn nvarchar(MAX),
		addr_home nvarchar(MAX),
		indate nvarchar(10),
		inmoney int,
		inplace nvarchar(50),
		outdate nvarchar(10),
		outmoney int,
		outplace nvarchar(50),
		passdate nvarchar(10),
		caryear nvarchar(10),
		ton nvarchar(20),
		carbrandno nvarchar(20),
		carbrand nvarchar(50),
		caryeartw nvarchar(20),
		engineno nvarchar(20),
		passno nvarchar(20),
		weight1 float,
		weight2 float,
		carkindno nvarchar(20),
		carmode nvarchar(20),
		memo nvarchar(MAX),
		stopdate nvarchar(10),
		wasted nvarchar(10),
		oldcarno nvarchar(10)
)
insert into @result
select '0' gno,a.noa,a.carno,a.carownerno,b.namea,a.cardealno,isnull(c.boss,''),b.sex,b.idno,b.birthday,b.tel1,
b.tel2,b.fax,b.mobile,b.addr_conn,b.addr_home,a.indate,a.inmoney,a.inplace,a.outdate,a.outmoney,a.outplace,a.passdate,a.caryear,a.ton,
a.carbrandno,isnull(d.brand,''),a.caryeartw,a.engineno,a.passno,a.weight1,a.weight2,a.carkindno,a.carmode,a.memo,
ISNULL(e.stopdate,''),ISNULL(e.wastedate,''),ISNULL(e.oldcarno,'')
from car2 a
left join carowner b on b.noa = a.carownerno
left join cardeal c on c.noa = a.cardealno
left join carbrand d on d.noa = a.carbrandno
left join carChange e on e.carno = a.carno
where a.carno between @t_bcarno and @t_ecarno

select *
from @result order by noa;
--*****************************************************************************************

z_car29:--z_car29車主擁有車輛
	declare @t_bmon nvarchar(10)
	declare @t_emon nvarchar(10)
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_bcardealno nvarchar(20)
	declare @t_ecardealno nvarchar(20)
	declare @t_bcarownerno nvarchar(20)
	declare @t_ecarownerno nvarchar(20)
	declare @t_bdriverno nvarchar(20)
	declare @t_edriverno nvarchar(20)
	declare @t_bsssno nvarchar(20)
	declare @t_esssno nvarchar(20)
	declare @t_carteamno nvarchar(2)
	declare @t_carno nvarchar(20)
	declare @t_enddate nvarchar(10)
	declare @t_bcarno nvarchar(20)
	declare @t_ecarno nvarchar(20)

	set @t_bmon = case when '#non'=[1] then '' else [1] end
	set @t_emon = case when '#non'=[2] then char(255) else [2] end
	set @t_bdate = case when '#non'=[3] then '' else [3] end
	set @t_edate = case when '#non'=[4] then char(255) else [4] end
	set @t_bcardealno = case when '#non'=[5] then '' else [5] end
	set @t_ecardealno  = case when '#non'=[6] then char(255) else [6] end	
	set @t_bcarownerno = case when '#non'=[7] then '' else [7] end
	set @t_ecarownerno  = case when '#non'=[8] then char(255) else [8] end	
	set @t_bdriverno = case when '#non'=[9] then '' else [9] end
	set @t_edriverno  = case when '#non'=[10] then char(255) else [10] end	
	set @t_bsssno = case when '#non'=[11] then '' else [11] end
	set @t_esssno  = case when '#non'=[12] then char(255) else [12] end	
	set @t_carteamno = case when '#non'=[13] then '' else [13] end	
	set @t_carno = case when '#non'=[14] then '' else [14] end
	set @t_enddate = case when '#non'=[15] then '' else [15] end
	set @t_bcarno = case when '#non'=[16] then '' else [16] end
	set @t_ecarno  = case when '#non'=[17] then char(255) else [17] end
declare @result table(
		gno nvarchar(1),
		noa nvarchar(20),
		cardealno nvarchar(20),
		[card] nvarchar(20),
		carno nvarchar(20),
		carownerno nvarchar(20),
		a nvarchar(50),
		b nvarchar(10),
		c nvarchar(10),
		d nvarchar(10),
		e nvarchar(10),
		carkindno nvarchar(10),
		f nvarchar(10),
		ton  nvarchar(20),
		carbrandno nvarchar(20),
		g nvarchar(20),
		datea nvarchar(10)
)
insert into @result
select '0' gno,a.noa,a.cardealno,ISNULL(left(c.comp,3),''),a.carno,a.carownerno,b.namea,a.indate,a.outdate,
isnull(e.stopdate,''),isnull(e.wastedate,''),a.carkindno,a.caryear,a.ton,a.carbrandno,isnull(d.brand,''),isnull(f.bdate,'')
from car2 a
left join carowner b on b.noa = a.carownerno
left join  cardeal c on c.noa = a.cardealno
left join carbrand d on d.noa = a.carbrandno
left join  carChange e on e.carno = a.carno
left join  carInsure f on f.noa = a.noa
where (a.carownerno between @t_bcarownerno and @t_ecarownerno) and
(a.cardealno between @t_bcardealno and @t_ecardealno)

select *
from @result
order by carownerno;


--*****************************************************************************************

z_car99:
	-- not yet
	declare @t_bmon nvarchar(10)
	declare @t_emon nvarchar(10)
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_bcardealno nvarchar(20)
	declare @t_ecardealno nvarchar(20)
	declare @t_bcarownerno nvarchar(20)
	declare @t_ecarownerno nvarchar(20)
	declare @t_bdriverno nvarchar(20)
	declare @t_edriverno nvarchar(20)
	declare @t_bsssno nvarchar(20)
	declare @t_esssno nvarchar(20)
	declare @t_carteamno nvarchar(2)
	declare @t_carno nvarchar(20)
	declare @t_enddate nvarchar(10)
	
	set @t_bmon = case when '#non'='#non' then '' else '#non' end
	set @t_emon = case when '#non'='#non' then char(255) else '#non' end
	set @t_bdate = case when '#non'='#non' then '' else '#non' end
	set @t_edate = case when '#non'='#non' then char(255) else '#non' end
	set @t_bcardealno = case when '#non'='#non' then '' else '#non' end
	set @t_ecardealno  = case when '#non'='#non' then char(255) else '#non' end	
	set @t_bcarownerno = case when '#non'='#non' then '' else '#non' end
	set @t_ecarownerno  = case when '#non'='#non' then char(255) else '#non' end	
	set @t_bdriverno = case when '#non'='#non' then '' else '#non' end
	set @t_edriverno  = case when '#non'='#non' then char(255) else '#non' end	
	set @t_bsssno = case when '#non'='#non' then '' else '#non' end
	set @t_esssno  = case when '#non'='#non' then char(255) else '#non' end	
	set @t_carteamno = case when '#non'='#non' then '' else '#non' end	
	set @t_carno = case when '#non'='#non' then '' else '#non' end		
	set @t_enddate = case when '#non'='#non' then '' else '#non' end	
	
	declare @tmp table(
		gno nvarchar(1),
		車牌 nvarchar(20),
		車主 nvarchar(20),
		車行 nvarchar(20),
		欠款金額 int,
		過入日 nvarchar(1),
		廠牌 nvarchar(20),
		電話 nvarchar(20),
		行動 nvarchar(20)
	)	
	
	insert into @tmp
		select 
			'0' gno
		from borrs a
		left join borr b on a.noa = b.noa
		left join car2 c on b.carno = c.noa 
		left join cardeal d on c.cardealno = d.noa
		left join carOwner e on c.carownerno = e.noa
		left join carbrand f on c.carbrandno = f.noa
		where (len(@t_carno)=0 or b.carno=@t_carno)and
		      (c.cardealno between @t_bcardealno and @t_ecardealno) and
		      (c.carownerno between @t_bcarownerno and @t_ecarownerno)
	;
	------------------------------------------------------------------------------------------------
z_car30:--z_car30	
declare @t_bcardealno nvarchar(20)
declare @t_ecardealno nvarchar(20)
declare @t_xmon nvarchar(20)
set @t_bcardealno = case when '#non' = [5] then '' else [5] end
set @t_ecardealno = case when '#non' = [6] then CHAR(255) else [6] end
set @t_xmon = case when '#non' = [18] then '' else [18] end
declare @tmpa table(
		gno nvarchar(1),
		mon nvarchar(20),
		carno nvarchar(20),
		cardealno nvarchar(20),
		cardeal nvarchar(50),
		inmoney float,
		outmoney float,
		total float
)
insert into @tmpa
select '0' gno,b.mon,b.carno,c.cardealno,d.comp,a.inmoney,a.outmoney,a.outmoney - a.inmoney
from caras a
left join cara b on a.noa = b.noa
left join car2 c on b.carno = c.noa
left join cardeal d on c.cardealno =  d.noa
where (LEN(@t_xmon) = 0 or @t_xmon = b.mon) and
(c.cardealno between @t_bcardealno and @t_ecardealno)

declare @tmp table(
		gno nvarchar(1),
		mon nvarchar(10),
		carno nvarchar(20),
		cardeal nvarchar(50),
		total float
)
insert into @tmp
select gno,mon,carno,cardeal,total
from @tmp

insert into @tmp
select '1' gno,'','','',SUM(total)
from @tmp

select gno,mon,carno,cardeal,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total),1)),4,12)) total
from @tmp;
-----------------------------------------------------------------------------------------
z_car31:--z_car31
declare @t_bdate nvarchar(20)
declare @t_edate nvarchar(20)
set @t_bdate = case when '#non' = [3] then '' else [3] end
set @t_edate = case when '#non' = [4] then CHAR(255) else [4] end
declare @tmp table(
        gno nvarchar(1), 
        datea nvarchar(20),
        carno nvarchar(20),
        carowner nvarchar(50),
        insurer nvarchar(50),
        moneys float,
        insuresheet nvarchar(20),
        insurecard nvarchar(20)
)
insert into @tmp
select '0' gno,a.edate,a.noa,c.namea,a.insurer,a.money,a.insuresheet,a.insurecard
from carInsure a
left join car2 b on a.noa = b.noa
left join carOwner c on c.noa = b.carownerno 
where (a.bdate >= @t_bdate and a.edate <= @t_edate)

insert into @tmp
select '1' gno,'','','','',SUM(moneys),'',''
from @tmp

select gno,carno,carowner,insurer,datea,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,moneys),1)),4,12)) moneys,
insuresheet,insurecard
from @tmp;
------------------------------------------------------------------------------
z_car32:--z_car32
declare @t_binsurerno nvarchar(20)
declare @t_einsurerno nvarchar(20)
declare @t_bdate nvarchar(20)
declare @t_edate nvarchar(20)
set @t_binsurerno = case when '#non' = [19] then '' else [19] end
set @t_einsurerno = case when '#non' = [20] then CHAR(255) else [20] end
set @t_bdate = case when '#non' = [3] then '' else [3] end
set @t_edate = case when '#non' = [4] then CHAR(255) else [4] end
declare @tmp table(
		gno nvarchar(20),
		xinsurerno nvarchar(20),
		insurer nvarchar(50),
		carno nvarchar(20),
		carowner nvarchar(50),
		datea nvarchar(20),
		moneys float,
		kind nvarchar(20),
		recno float
)
insert into @tmp
select '0' gno,a.insurerno,a.insurer,a.noa,c.namea,a.edate,a.money,a.kind,ROW_NUMBER()over(PARTITION BY a.insurer order by a.noa) recno
from carInsure a
left join car2 b on a.noa = b.noa
left join carOwner c on c.noa = b.carownerno 
where (a.bdate >= @t_bdate and a.edate <= @t_edate) and
(a.insurerno between @t_binsurerno and @t_einsurerno)

insert into @tmp
select '1' gno,xinsurerno,'','','','',SUM(moneys),'',max(recno)
from @tmp
group by xinsurerno

select gno,xinsurerno,insurer,carno,carowner,datea,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,moneys),1)),4,12)) moneys,
kind,recno
from @tmp
order by xinsurerno,gno;
