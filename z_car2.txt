z_car21:--z_car21
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_bcardealno nvarchar(20)
	declare @t_ecardealno nvarchar(20)
	declare @t_bcarownerno nvarchar(20)
	declare @t_ecarownerno nvarchar(20)
	declare @t_bcarno nvarchar(20)
	declare @t_ecarno nvarchar(20)
	declare @t_sssno nvarchar(20)

	set @t_bdate = case when '#non'=[3] then '' else [3] end
	set @t_edate = case when '#non'=[4] then char(255) else [4] end
	set @t_bcardealno = case when '#non'=[5] then '' else [5] end
	set @t_ecardealno  = case when '#non'=[6] then char(255) else [6] end	
	set @t_bcarownerno = case when '#non'=[7] then '' else [7] end
	set @t_ecarownerno  = case when '#non'=[8] then char(255) else [8] end	
	set @t_bcarno = case when '#non'=[16] then '' else [16] end
	set @t_ecarno  = case when '#non'=[17] then char(255) else [17] end	
	set @t_sssno  = case when '#non'=[24] then char(255) else [24] end	
--*********************************************************************************** 

	declare @tmp table( 
		gno nvarchar(1), 
		recno int,--順序 
		checkdate nvarchar(10),--驗車日期 
		carno nvarchar(20),--車牌號碼 
		carowner nvarchar(20),--車主 
		passdate nvarchar(10),--發照日期 
		caryeartw nvarchar(10),--出廠 
		carbrand nvarchar(20),--廠牌 
		insurance nvarchar(10),--保險止日 
		cardeal nvarchar(20)--車行 
	) 
	declare @cmd nvarchar(MAX)
	
set @cmd='select ''0'' gno, 
ROW_NUMBER()over(order by (case when len(@t_bdate+@t_edate)=0 then LEFT(a.checkdate,6) else a.checkdate end),a.carno), 
a.checkdate, a.carno, b.namea, a.passdate, a.caryeartw, c.brand, d.edate, e.nick 
from car2 a 
left join carowner b on a.carownerno = b.noa 
left join carbrand c on a.carbrandno = c.noa 
left join (select noa,MAX(case when len(stopdate)>0 then stopdate else edate end) edate from carInsure group by noa) as d on a.carno = d.noa 
left join cardeal e on a.cardealno = e.noa 
where (a.checkdate between @t_bdate and @t_edate) and 
(a.cardealno between @t_bcardealno and @t_ecardealno) and 
(a.carownerno between @t_bcarownerno and @t_ecarownerno) and 
(a.carno between @t_bcarno and @t_ecarno) and 
a.carownerno!='''' and (a.enddate='''' or a.enddate is null) and (a.outdate='''' or a.outdate is null)'

if(PATINDEX('%070120%',@t_sssno)=0)
	set @cmd=@cmd+' and a.sssno!=''070120'' and a.sssno!='''''
if(PATINDEX('%070121%',@t_sssno)=0)
	set @cmd=@cmd+' and a.sssno!=''070121'''
if(PATINDEX('%070122%',@t_sssno)=0)
	set @cmd=@cmd+' and a.sssno!=''070122'''

insert into @tmp 
execute sp_executesql @cmd,N'@t_bdate nvarchar(10),@t_edate nvarchar(10),@t_bcardealno nvarchar(20),@t_ecardealno nvarchar(20),@t_bcarownerno nvarchar(20),@t_ecarownerno nvarchar(20),@t_bcarno nvarchar(20),@t_ecarno nvarchar(20)',
		@t_bdate=@t_bdate,@t_edate=@t_edate,@t_bcardealno=@t_bcardealno,@t_ecardealno=@t_ecardealno,@t_bcarownerno=@t_bcarownerno,@t_ecarownerno=@t_ecarownerno,@t_bcarno=@t_bcarno,@t_ecarno=@t_ecarno

--*********************************************************************************** 
select * from @tmp;
--******************************************************************************************************
z_car22:--z_car22
	declare @t_bcardealno nvarchar(20)
	declare @t_ecardealno nvarchar(20)
	declare @t_bcarownerno nvarchar(20)
	declare @t_ecarownerno nvarchar(20)
	declare @t_enddate nvarchar(10)
	
	set @t_bcardealno = case when '#non'=[5] then '' else [5] end
	set @t_ecardealno  = case when '#non'=[6] then char(255) else [6] end	
	set @t_bcarownerno = case when '#non'=[7] then '' else [7] end
	set @t_ecarownerno  = case when '#non'=[8] then char(255) else [8] end	
	set @t_enddate = case when '#non'=[15] then '' else [15] end

	declare @tmp table(
		cardealno nvarchar(20),
		cardeal nvarchar(50),
		carownerno nvarchar(20),
		carowner nvarchar(50),
		lenderno nvarchar(20),
		lender nvarchar(50),
		money int,
		installmentamount int,
		installment int,
		bkmoney int,
		surplusment int,
		surplusmoney int, 
		date nvarchar(50),
		memo nvarchar(MAX),
		carnos nvarchar(MAX)
		
)
--case說明--如果貸款止日>截止日期表示還沒還清否則已還清，沒有還清則計算剩餘還款期數(如果今天日期<計日，表示當期還沒還款，所以+1)
insert into @tmp
select a.cardealno,a.cardeal,a.noa,b.namea,a.lenderno,a.lender,a.money,a.installmentamount,a.installment,a.bkmoney,
case when a.edate > @t_enddate then
(left(a.edate,3)*12+right(left(a.edate,6),2))-(left(@t_enddate,3)*12+right(left(@t_enddate,6),2))+(case when cast(right(@t_enddate,2) as int)<=cast(a.day as int) then 1 else 0 end) else 0 end surplusment,
0 surplusmoney,a.bdate+' - '+a.edate date,a.memo,a.carnos
from carLender a left join carOwner b on a.noa=b.noa
where (a.cardealno between @t_bcardealno and @t_ecardealno) and (a.noa between @t_bcarownerno and @t_ecarownerno)
order by a.cardealno,a.noa,bdate desc
--計算貸款餘額
update @tmp
set surplusmoney=surplusment*installmentamount
where surplusment>0

--select * from @tmp
----------------------------------------------------------------------------------
declare @result table(
		gno nvarchar(1),
		cardealno nvarchar(20),
		cardeal nvarchar(50),
		carownerno nvarchar(20),
		carowner nvarchar(50),
		lenderno nvarchar(20),
		lender nvarchar(50),
		money int,
		installmentamount int,
		installment int,
		bkmoney int,
		surplusment int,
		surplusmoney int, 
		date nvarchar(50),
		memo nvarchar(MAX),
		carno nvarchar(MAX)
)

declare @cardealno nvarchar(20)
declare @cardeal nvarchar(50)
declare @carownerno nvarchar(20)
declare @carowner nvarchar(50)
declare @lenderno nvarchar(20)
declare @lender nvarchar(50)
declare @money int
declare @installmentamount int
declare @installment int
declare @bkmoney int
declare @surplusment int
declare @surplusmoney int
declare @date nvarchar(50)
declare @memo nvarchar(MAX)
declare @carnos nvarchar(MAX)
declare @count int

	declare cursor_table cursor for
	select cardealno,cardeal,carownerno,carowner,lenderno,lender,money,installmentamount,installment,bkmoney,surplusment,surplusmoney,date,memo,carnos from @tmp
	open cursor_table
	fetch next from cursor_table
	into @cardealno,@cardeal,@carownerno,@carowner,@lenderno,@lender,@money,@installmentamount,@installment,@bkmoney,@surplusment,@surplusmoney,@date,@memo,@carnos
	while(@@FETCH_STATUS <> -1)
	begin
		if(len(@carnos)>0)
		begin
			set @count=1
			while(@count>0)
			begin
				if(CHARINDEX(',',@carnos)=0)
				begin
					if(@count>1)
					begin
						insert into @result
						select '0',null,null,null,null,null,null,null,null,null,null,null,null,null,null,@carnos
					end
					else
					begin
						insert into @result
						select '0',@cardealno,@cardeal,@carownerno,@carowner,@lenderno,@lender,@money,@installmentamount,@installment,@bkmoney,@surplusment,@surplusmoney,@date,@memo,@carnos
					end
					
					set @count=0
				end
				else
				begin
					if(@count>1)
					begin
						insert into @result
						select '0',null,null,null,null,null,null,null,null,null,null,null,null,null,null,SUBSTRING(@carnos,0,CHARINDEX(',',@carnos))
					end
					else
					begin
						insert into @result
						select '0',@cardealno,@cardeal,@carownerno,@carowner,@lenderno,@lender,@money,@installmentamount,@installment,@bkmoney,@surplusment,@surplusmoney,@date,@memo,SUBSTRING(@carnos,0,CHARINDEX(',',@carnos))
					end
					set @carnos=SUBSTRING(@carnos,CHARINDEX(',',@carnos)+1,len(@carnos))
					set @count=@count+1
				end	
			end
		end
		else
		begin
			insert into @result
			select '0',@cardealno,@cardeal,@carownerno,@carowner,@lenderno,@lender,@money,@installmentamount,@installment,@bkmoney,@surplusment,@surplusmoney,@date,@memo,@carnos
		end
		insert into @result
		select '1',null,null,null,null,null,null,null,null,null,null,null,null,null,null,null
		
		fetch next from cursor_table
		into @cardealno,@cardeal,@carownerno,@carowner,@lenderno,@lender,@money,@installmentamount,@installment,@bkmoney,@surplusment,@surplusmoney,@date,@memo,@carnos
	end
	close cursor_table
	deallocate cursor_table
	
	insert into @result
	select '2',null,null,null,null,null,null,null,null,null,null,null,sum(surplusmoney),null,null,null
	from @result
	
	select a.gno,a.carownerno,a.carowner,a.cardealno,left(a.cardeal,3)cardeal,a.lenderno,left(a.lender,3)lender,
	reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.money),1)),4,12)) money,
	reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.installmentamount),1)),4,12)) installmentamount,a.installment,
	reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.bkmoney),1)),4,12)) bkmoney,a.surplusment,
	reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.surplusmoney),1)),4,12)) surplusmoney,a.date,a.memo,a.carno,
	c.brand,b.caryear from @result a left join car2 b on a.carno=b.noa left join carbrand c on b.carbrandno=c.noa;

--********************************************************************************************************************
z_car24:--z_car24
	declare @t_bcardealno nvarchar(20)
	declare @t_ecardealno nvarchar(20)
	declare @t_bcarownerno nvarchar(20)
	declare @t_ecarownerno nvarchar(20)
	declare @t_enddate nvarchar(10)
	
	set @t_bcardealno = case when '#non'=[5] then '' else [5] end
	set @t_ecardealno  = case when '#non'=[6] then char(255) else [6] end	
	set @t_bcarownerno = case when '#non'=[7] then '' else [7] end
	set @t_ecarownerno  = case when '#non'=[8] then char(255) else [8] end	
	set @t_enddate = case when '#non'=[15] then '' else [15] end

	declare @tmp table(
		cardealno nvarchar(20),
		cardeal nvarchar(50),
		carownerno nvarchar(20),
		carowner nvarchar(50),
		lenderno nvarchar(20),
		lender nvarchar(50),
		money int,
		installmentamount int,
		installment int,
		bkmoney int,
		surplusment int,
		surplusmoney int, 
		date nvarchar(50),
		memo nvarchar(MAX),
		carnos nvarchar(MAX)
		
)
--case說明--如果貸款止日>截止日期表示還沒還清否則已還清，沒有還清則計算剩餘還款期數(如果今天日期<計日，表示當期還沒還款，所以+1)
insert into @tmp
select a.cardealno,a.cardeal,a.noa,b.namea,a.lenderno,a.lender,a.money,a.installmentamount,a.installment,a.bkmoney,
case when a.edate > @t_enddate then
(left(a.edate,3)*12+right(left(a.edate,6),2))-(left(@t_enddate,3)*12+right(left(@t_enddate,6),2))+(case when cast(right(@t_enddate,2)as int)<=cast(a.day AS int) then 1 else 0 end) else 0 end surplusment,
0 surplusmoney,a.bdate+' - '+a.edate date,a.memo,a.carnos
from carLender a left join carOwner b on a.noa=b.noa
where (a.cardealno between @t_bcardealno and @t_ecardealno) and (a.noa between @t_bcarownerno and @t_ecarownerno)
order by a.noa

--計算貸款餘額
update @tmp
set surplusmoney=surplusment*installmentamount
where surplusment>0

--select * from @tmp
----------------------------------------------------------------------------------
declare @result table(
		gno nvarchar(1),
		carownerno nvarchar(20),
		carowner nvarchar(50),
		cardealno nvarchar(20),
		cardeal nvarchar(50),
		lenderno nvarchar(20),
		lender nvarchar(50),
		money int,
		installmentamount int,
		installment int,
		bkmoney int,
		surplusment int,
		surplusmoney int, 
		date nvarchar(50),
		memo nvarchar(MAX),
		carno nvarchar(MAX)
)

declare @cardealno nvarchar(20)
declare @cardeal nvarchar(50)
declare @carownerno nvarchar(20)
declare @t_carownerno nvarchar(20) 
declare @carowner nvarchar(50)
declare @lenderno nvarchar(20)
declare @lender nvarchar(50)
declare @money int
declare @installmentamount int
declare @installment int
declare @bkmoney int
declare @surplusment int
declare @surplusmoney int
declare @date nvarchar(50)
declare @memo nvarchar(MAX)
declare @carnos nvarchar(MAX)
declare @count int

set @t_carownerno='XXXX'

	declare cursor_table cursor for
	select cardealno,cardeal,carownerno,carowner,lenderno,lender,money,installmentamount,installment,bkmoney,surplusment,surplusmoney,date,memo,carnos from @tmp
	open cursor_table
	fetch next from cursor_table
	into @cardealno,@cardeal,@carownerno,@carowner,@lenderno,@lender,@money,@installmentamount,@installment,@bkmoney,@surplusment,@surplusmoney,@date,@memo,@carnos
	while(@@FETCH_STATUS <> -1)
	begin
	
		if(@carownerno!=@t_carownerno and @t_carownerno!='XXXX')
		begin
			insert into @result 
			select '2',@t_carownerno,null,null,null,null,null,null,null,null,null,null,sum(surplusmoney),null,null,null from @tmp where carownerno=@t_carownerno
		end
		set @t_carownerno=@carownerno
	
		if(len(@carnos)>0)
		begin
			set @count=1
			while(@count>0)
			begin
				if(CHARINDEX(',',@carnos)=0)
				begin
					if(@count>1)
					begin
						insert into @result
						select '0',@carownerno,null,null,null,null,null,null,null,null,null,null,null,null,null,@carnos
					end
					else
					begin
						insert into @result
						select '0',@carownerno,@carowner,@cardealno,@cardeal,@lenderno,@lender,@money,@installmentamount,@installment,@bkmoney,@surplusment,@surplusmoney,@date,@memo,@carnos
					end
					
					set @count=0
				end
				else
				begin
					if(@count>1)
					begin
						insert into @result
						select '0',@carownerno,null,null,null,null,null,null,null,null,null,null,null,null,null,SUBSTRING(@carnos,0,CHARINDEX(',',@carnos))
					end
					else
					begin
						insert into @result
						select '0',@carownerno,@carowner,@cardealno,@cardeal,@lenderno,@lender,@money,@installmentamount,@installment,@bkmoney,@surplusment,@surplusmoney,@date,@memo,SUBSTRING(@carnos,0,CHARINDEX(',',@carnos))
					end
					set @carnos=SUBSTRING(@carnos,CHARINDEX(',',@carnos)+1,len(@carnos))
					set @count=@count+1
				end	
			end
		end
		else
		begin
			insert into @result
			select '0',@carownerno,@carowner,@cardealno,@cardeal,@lenderno,@lender,@money,@installmentamount,@installment,@bkmoney,@surplusment,@surplusmoney,@date,@memo,@carnos
		end
		insert into @result
		select '1',@carownerno,null,null,null,null,null,null,null,null,null,null,null,null,null,null
		
		fetch next from cursor_table
		into @cardealno,@cardeal,@carownerno,@carowner,@lenderno,@lender,@money,@installmentamount,@installment,@bkmoney,@surplusment,@surplusmoney,@date,@memo,@carnos
	end
	
	insert into @result 
	select '2',@t_carownerno,null,null,null,null,null,null,null,null,null,null,sum(surplusmoney),null,null,null from @tmp where carownerno=@t_carownerno
	
	close cursor_table
	deallocate cursor_table
	
	insert into @result 
	select '3',@t_carownerno,null,null,null,null,null,null,null,null,null,null,sum(surplusmoney),null,null,null from @result where gno='2'

	select a.gno,a.carownerno,a.carowner,a.cardealno,left(a.cardeal,3)cardeal,a.lenderno,left(a.lender,3)lender,
	reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.money),1)),4,12)) money,
	reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.installmentamount),1)),4,12)) installmentamount,a.installment,
	reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.bkmoney),1)),4,12)) bkmoney,a.surplusment,
	reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.surplusmoney),1)),4,12)) surplusmoney,a.date,a.memo,a.carno,
	c.brand,b.caryear from @result a left join car2 b on a.carno=b.noa left join carbrand c on b.carbrandno=c.noa;
--********************************************************************************************************************


--**************************************************************************************************************************************
z_car25:--z_car25高額欠款追蹤依車號
	declare @t_bcarno nvarchar(20)
	declare @t_ecarno nvarchar(20)
	declare @t_xmon nvarchar(10)
	declare @t_sssno nvarchar(20)
	
	set @t_bcarno = case when '#non'=[16] then '' else [16] end
	set @t_ecarno  = case when '#non'=[17] then char(255) else [17] end
	set @t_xmon  = case when '#non'=[18] then '' else [18] end
	set @t_sssno  = case when '#non'=[24] then char(255) else [24] end	
--************************************************************************************
declare @result table(
		gno nvarchar(1),
		noa nvarchar(20),
		mon nvarchar(10),
		carno nvarchar(20),
		carownerno nvarchar(20),
		carowner nvarchar(20),
		cardealno nvarchar(20),
		cardeal nvarchar(20),
		indate nvarchar(10),
		caryear nvarchar(10),
		carbrandno nvarchar(20),
		carbrand nvarchar(20),
		tel nvarchar(50),
		mobile nvarchar(50),
		total float
)
declare @cmd nvarchar(MAX)

set @cmd='select ''0'' gno,isnull(e.noa,''''),isnull(e.mon,''''),isnull(e.carno,''''),a.carownerno,b.namea,a.cardealno,ISNULL(left(c.comp,3),''''),a.indate,a.caryear,a.carbrandno, 
isnull(d.brand,''''),b.tel1,b.mobile,isnull(e.paytotal,0) 
from car2 a 
left join carOwner b on b.noa = a.carownerno 
left join cardeal c on c.noa = a.cardealno 
left join carbrand d on d.noa = a.carbrandno 
left join cara e on e.carno = a.carno 
where (e.mon=@t_xmon) and (e.carno between @t_bcarno and @t_ecarno) and e.paytotal>0 and 
a.carownerno!='''' and (a.enddate='''' or a.enddate is null) and (a.outdate='''' or a.outdate is null)'

if(PATINDEX('%070120%',@t_sssno)=0)
	set @cmd=@cmd+' and a.sssno!=''070120'' and a.sssno!='''''
if(PATINDEX('%070121%',@t_sssno)=0)
	set @cmd=@cmd+' and a.sssno!=''070121'''
if(PATINDEX('%070122%',@t_sssno)=0)
	set @cmd=@cmd+' and a.sssno!=''070122'''

set @cmd=@cmd+' order by total desc,e.carno,gno'

insert into @result 
execute sp_executesql @cmd,N'@t_xmon nvarchar(10),@t_bcarno nvarchar(20),@t_ecarno nvarchar(20)',
		@t_xmon=@t_xmon,@t_bcarno=@t_bcarno,@t_ecarno=@t_ecarno

insert into @result 
select '2' gno,'','',CHAR(255),'','','','','','','','','','',SUM(total) 
from @result 
where gno != 1 

select gno,noa,mon,carno,carownerno,carowner,cardealno,cardeal,indate,caryear,carbrandno,carbrand,tel,mobile,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total),1)),4,12)) total
from @result; 

--**********************************************************************************

z_car26:--z_car26高額欠款追蹤依車主
	declare @t_bcarownerno nvarchar(20)
	declare @t_ecarownerno nvarchar(20)
	declare @t_xmon nvarchar(10)
	declare @t_sssno nvarchar(20)
	
	set @t_bcarownerno = case when '#non'=[7] then '' else [7] end
	set @t_ecarownerno  = case when '#non'=[8] then char(255) else [8] end	
	set @t_xmon  = case when '#non'=[18] then '' else [18] end
	set @t_sssno  = case when '#non'=[24] then char(255) else [24] end	
--************************************************************************************
declare @result table(
		gno nvarchar(1),
		noa nvarchar(20),
		mon nvarchar(10),
		carno nvarchar(20),
		carownerno nvarchar(20),
		carowner nvarchar(20),
		cardealno nvarchar(20),
		cardeal nvarchar(20),
		indate nvarchar(10),
		caryear nvarchar(10),
		carbrandno nvarchar(20),
		carbrand nvarchar(20),
		tel nvarchar(50),
		mobile nvarchar(50),
		total float
)
declare @cmd nvarchar(MAX)

set @cmd='select ''0'' gno,isnull(e.noa,''''),isnull(e.mon,''''),isnull(e.carno,''''),a.carownerno
,b.namea,a.cardealno,ISNULL(left(c.comp,3),''''),a.indate,a.caryear,a.carbrandno,isnull(d.brand,'''')
,b.tel1,b.mobile,isnull(e.paytotal,0)
from car2 a left join carOwner b on b.noa = a.carownerno
left join  cardeal c on c.noa = a.cardealno
left join carbrand d on d.noa = a.carbrandno
left join cara e on e.carno = a.carno
where (e.mon=@t_xmon) and (isnull(a.carownerno,'''') between @t_bcarownerno and @t_ecarownerno) and e.paytotal>0 
and a.carownerno!='''' and (a.enddate='''' or a.enddate is null) and (a.outdate='''' or a.outdate is null)'

if(PATINDEX('%070120%',@t_sssno)=0)
	set @cmd=@cmd+' and a.sssno!=''070120'' and a.sssno!='''''
if(PATINDEX('%070121%',@t_sssno)=0)
	set @cmd=@cmd+' and a.sssno!=''070121'''
if(PATINDEX('%070122%',@t_sssno)=0)
	set @cmd=@cmd+' and a.sssno!=''070122'''

insert into @result
execute sp_executesql @cmd,N'@t_xmon nvarchar(10),@t_bcarownerno nvarchar(20),@t_ecarownerno nvarchar(20)',
		@t_xmon=@t_xmon,@t_bcarownerno=@t_bcarownerno,@t_ecarownerno=@t_ecarownerno

insert into @result
select '1' gno,'',mon,'','',carowner,'','','','','','','','',SUM(total)
from @result
group by carowner,mon

insert into @result
select '2' gno,'','','','',CHAR(255),'','','','','','','','',SUM(total)
from @result
where not(gno = 1)

select gno,noa,mon,carno,carownerno,carowner,cardealno,cardeal,indate,caryear,carbrandno,carbrand,tel,mobile,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total),1)),4,12)) total
from @result
order by carowner,gno;
--************************************************************************************

z_car27:--z_car27車輛統計表
	declare @t_bcardealno nvarchar(20)
	declare @t_ecardealno nvarchar(20)
	declare @t_bcarspecno nvarchar(20)
	declare @t_ecarspecno nvarchar(20)
	declare @t_pdate nvarchar(20)
	declare @t_sssno nvarchar(20)
	
	set @t_bcardealno = case when '#non'=[5] then '' else [5] end
	set @t_ecardealno  = case when '#non'=[6] then char(255) else [6] end	
	set @t_bcarspecno = case when '#non'=[21] then '' else [21] end
	set @t_ecarspecno  = case when '#non'=[22] then char(255) else [22] end	
	set @t_pdate = case when '#non'=[23] then '' else [23] end
	set @t_sssno  = case when '#non'=[24] then char(255) else [24] end	
	
declare @result table(
		gno nvarchar(1),
		noa nvarchar(20),
		cno nvarchar(20),
		cardeal nvarchar(20),
		carno nvarchar(20),
		carownerno nvarchar(20),
		carowner nvarchar(50),
		indate nvarchar(10),
		outdate nvarchar(10),
		stopdate nvarchar(10),
		wasted nvarchar(10),
		carkindno nvarchar(10),
		carkind nvarchar(10),
		caryear nvarchar(10),
		ton  nvarchar(20),
		carbrandno nvarchar(20),
		carbrand nvarchar(20)
)
declare @cmd nvarchar(MAX)

set @cmd='select ''0'' gno,a.noa,a.cardealno,ISNULL(left(c.comp,3),''''),a.carno,a.carownerno,b.namea,a.indate,a.outdate, 
a.stopdate,a.enddate,a.carspecno,ISNULL(f.spec,''''),a.caryear,ISNULL(a.ton,'''')+ISNULL(a.cc,''''),a.carbrandno,isnull(d.brand,'''') 
from car2 a 
left join carowner b on b.noa = a.carownerno 
left join cardeal c on c.noa = a.cardealno 
left join carbrand d on d.noa = a.carbrandno 
left join carspec f on f.noa = a.carspecno 
where (a.cardealno between @t_bcardealno and @t_ecardealno)and 
(a.carspecno between @t_bcarspecno and @t_ecarspecno) and a.carownerno!='''''
if(PATINDEX('%遷出%',@t_pdate)=0)
	set @cmd=@cmd+' and (outdate='''' or outdate is null)'
if(PATINDEX('%報銷%',@t_pdate)=0)
	set @cmd=@cmd+' and (a.stopdate='''' or a.stopdate is null)'
if(PATINDEX('%報停%',@t_pdate)=0)
	set @cmd=@cmd+' and (a.enddate='''' or a.enddate is null)'
if(PATINDEX('%070120%',@t_sssno)=0)
	set @cmd=@cmd+' and a.sssno!=''070120'' and a.sssno!='''''
if(PATINDEX('%070121%',@t_sssno)=0)
	set @cmd=@cmd+' and a.sssno!=''070121'''
if(PATINDEX('%070122%',@t_sssno)=0)
	set @cmd=@cmd+' and a.sssno!=''070122'''

insert into @result 
execute sp_executesql @cmd,N'@t_bcardealno nvarchar(20),@t_ecardealno nvarchar(20),@t_bcarspecno nvarchar(20),@t_ecarspecno nvarchar(20)',
		@t_bcardealno=@t_bcardealno,@t_ecardealno=@t_ecardealno,@t_bcarspecno=@t_bcarspecno,@t_ecarspecno=@t_ecarspecno

insert into @result
select '1' gno,'',cno,'',COUNT(distinct carno),'','','','','','','','','','','',''
from @result
group by cno

select *
from @result
order by cno,gno,noa;

--***************************************************************************************
z_car28:--z_car28車籍資料列印
	declare @t_bcarno nvarchar(20)
	declare @t_ecarno nvarchar(20)
	declare @t_sssno nvarchar(20)

	set @t_bcarno = case when '#non'=[16] then '' else [16] end
	set @t_ecarno  = case when '#non'=[17] then char(255) else [17] end
	set @t_sssno  = case when '#non'=[24] then char(255) else [24] end
--************************************************************************************
declare @result table(
		gno nvarchar(1),
		noa nvarchar(20),
		carno nvarchar(20),
		carownerno nvarchar(20),
		carowner nvarchar(20),
		cardealno nvarchar(20),
		cardeal nvarchar(20),
		sex nvarchar(1),
		idno nvarchar(50),
		birthday nvarchar(10),
		tel1 nvarchar(50),
		tel2 nvarchar(50),
		fax nvarchar(50),
		mobile nvarchar(50),
		addr_conn nvarchar(MAX),
		addr_home nvarchar(MAX),
		indate nvarchar(10),
		inmoney int,
		inplace nvarchar(50),
		outdate nvarchar(10),
		outmoney int,
		outplace nvarchar(50),
		passdate nvarchar(10),
		caryear nvarchar(10),
		ton nvarchar(20),
		carbrandno nvarchar(20),
		carbrand nvarchar(50),
		caryeartw nvarchar(20),
		engineno nvarchar(20),
		passno nvarchar(20),
		weight1 float,
		weight2 float,
		carspecno nvarchar(20),
		carspec nvarchar(20),
		carmode nvarchar(20),
		memo nvarchar(MAX),
		stopdate nvarchar(10),
		wasted nvarchar(10),
		oldcarno nvarchar(10)
)
declare @cmd nvarchar(MAX)

set @cmd='select ''0'' gno,a.noa,a.carno,a.carownerno,b.namea,a.cardealno,isnull(c.boss,''''),b.sex,b.idno,b.birthday,b.tel1, 
b.tel2,b.fax,b.mobile,b.addr_conn,b.addr_home,a.indate,a.inmoney,a.inplace,a.outdate,a.outmoney,a.outplace,a.passdate,a.caryear,a.ton, 
a.carbrandno,isnull(d.brand,''''),a.caryeartw,a.engineno,a.passno,a.weight1,a.weight2,a.carspecno,f.spec,a.carmode,a.memo, 
ISNULL(a.stopdate,''''),ISNULL(a.enddate,''''),ISNULL(a.oldnoa,'''') 
from car2 a 
left join carowner b on b.noa = a.carownerno 
left join cardeal c on c.noa = a.cardealno 
left join carbrand d on d.noa = a.carbrandno 
left join carspec f on a.carspecno = f.noa 
where a.carno between @t_bcarno and @t_ecarno and a.carownerno!='''' and (a.enddate='''' or a.enddate is null) and (a.outdate='''' or a.outdate is null)'

if(PATINDEX('%070120%',@t_sssno)=0)
	set @cmd=@cmd+' and a.sssno!=''070120'' and a.sssno!='''''
if(PATINDEX('%070121%',@t_sssno)=0)
	set @cmd=@cmd+' and a.sssno!=''070121'''
if(PATINDEX('%070122%',@t_sssno)=0)
	set @cmd=@cmd+' and a.sssno!=''070122'''

insert into @result 
execute sp_executesql @cmd,N'@t_bcarno nvarchar(20),@t_ecarno nvarchar(20)',
		@t_bcarno=@t_bcarno,@t_ecarno=@t_ecarno

update @result
set sex=(case when sex='M' then '男' else '女' end)

select *
from @result order by noa;
--*****************************************************************************************

z_car29:--z_car29車主擁有車輛
	declare @t_bcardealno nvarchar(20)
	declare @t_ecardealno nvarchar(20)
	declare @t_bcarownerno nvarchar(20)
	declare @t_ecarownerno nvarchar(20)
	declare @t_bcarspecno nvarchar(20)
	declare @t_ecarspecno nvarchar(20)
	declare @t_pdate nvarchar(20)
	declare @t_sssno nvarchar(20)

	set @t_bcardealno = case when '#non'=[5] then '' else [5] end
	set @t_ecardealno  = case when '#non'=[6] then char(255) else [6] end	
	set @t_bcarownerno = case when '#non'=[7] then '' else [7] end
	set @t_ecarownerno  = case when '#non'=[8] then char(255) else [8] end	
	set @t_bcarspecno = case when '#non'=[21] then '' else [21] end
	set @t_ecarspecno  = case when '#non'=[22] then char(255) else [22] end	
	set @t_pdate = case when '#non'=[23] then '' else [23] end
	set @t_sssno  = case when '#non'=[24] then char(255) else [24] end	
	
declare @result table(
		gno nvarchar(1),
		noa nvarchar(20),
		cardealno nvarchar(20),
		[card] nvarchar(20),
		carno nvarchar(20),
		carownerno nvarchar(20),
		a nvarchar(50),
		b nvarchar(10),
		c nvarchar(10),
		d nvarchar(10),
		e nvarchar(10),
		carkindno nvarchar(10),
		f nvarchar(10),
		ton  nvarchar(20),
		carbrandno nvarchar(20),
		g nvarchar(20),
		datea nvarchar(10),
		total float
)

declare @cmd nvarchar(MAX)

set @cmd='select ''0'' gno,a.noa,a.cardealno,ISNULL(left(c.comp,3),''''),a.carno,a.carownerno,b.namea,a.indate,a.outdate, 
a.stopdate,a.enddate,a.carkindno,a.caryear,ISNULL(a.ton,'''')+ISNULL(a.cc,''''),a.carbrandno,isnull(d.brand,''''),isnull(f.bdate,''''),0 
from car2 a 
left join carowner b on b.noa = a.carownerno 
left join cardeal c on c.noa = a.cardealno 
left join carbrand d on d.noa = a.carbrandno 
left join (select * from carInsure where (noa+noq) in(select noa+MAX(noq) from carInsure group by noa)) f on f.noa = a.noa 
where (a.carownerno between @t_bcarownerno and @t_ecarownerno) and 
(a.cardealno between @t_bcardealno and @t_ecardealno)and 
(a.carspecno between @t_bcarspecno and @t_ecarspecno) and a.carownerno!='''''

if(PATINDEX('%遷出%',@t_pdate)=0)
	set @cmd=@cmd+' and (outdate='''' or outdate is null)'
if(PATINDEX('%報銷%',@t_pdate)=0)
	set @cmd=@cmd+' and (a.stopdate='''' or a.stopdate is null)'
if(PATINDEX('%報停%',@t_pdate)=0)
	set @cmd=@cmd+' and (a.enddate='''' or a.enddate is null)'
if(PATINDEX('%070120%',@t_sssno)=0)
	set @cmd=@cmd+' and a.sssno!=''070120'' and a.sssno!='''''
if(PATINDEX('%070121%',@t_sssno)=0)
	set @cmd=@cmd+' and a.sssno!=''070121'''
if(PATINDEX('%070122%',@t_sssno)=0)
	set @cmd=@cmd+' and a.sssno!=''070122'''

insert into @result 
execute sp_executesql @cmd,N'@t_bcarownerno nvarchar(20),@t_ecarownerno nvarchar(20),@t_bcardealno nvarchar(20),@t_ecardealno nvarchar(20),@t_bcarspecno nvarchar(20),@t_ecarspecno nvarchar(20)',
		@t_bcarownerno=@t_bcarownerno,@t_ecarownerno=@t_ecarownerno,@t_bcardealno=@t_bcardealno,@t_ecardealno=@t_ecardealno,@t_bcarspecno=@t_bcarspecno,@t_ecarspecno=@t_ecarspecno

insert into @result
select '1','','','','',carownerno,'','','','','','','','','','','',count(*)
from @result group by carownerno

select *
from @result
order by carownerno,gno,cardealno,noa;


--*****************************************************************************************

z_car99:
	-- not yet
	declare @t_bmon nvarchar(10)
	declare @t_emon nvarchar(10)
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_bcardealno nvarchar(20)
	declare @t_ecardealno nvarchar(20)
	declare @t_bcarownerno nvarchar(20)
	declare @t_ecarownerno nvarchar(20)
	declare @t_bdriverno nvarchar(20)
	declare @t_edriverno nvarchar(20)
	declare @t_bsssno nvarchar(20)
	declare @t_esssno nvarchar(20)
	declare @t_carteamno nvarchar(2)
	declare @t_carno nvarchar(20)
	declare @t_enddate nvarchar(10)
	
	set @t_bmon = case when '#non'='#non' then '' else '#non' end
	set @t_emon = case when '#non'='#non' then char(255) else '#non' end
	set @t_bdate = case when '#non'='#non' then '' else '#non' end
	set @t_edate = case when '#non'='#non' then char(255) else '#non' end
	set @t_bcardealno = case when '#non'='#non' then '' else '#non' end
	set @t_ecardealno  = case when '#non'='#non' then char(255) else '#non' end	
	set @t_bcarownerno = case when '#non'='#non' then '' else '#non' end
	set @t_ecarownerno  = case when '#non'='#non' then char(255) else '#non' end	
	set @t_bdriverno = case when '#non'='#non' then '' else '#non' end
	set @t_edriverno  = case when '#non'='#non' then char(255) else '#non' end	
	set @t_bsssno = case when '#non'='#non' then '' else '#non' end
	set @t_esssno  = case when '#non'='#non' then char(255) else '#non' end	
	set @t_carteamno = case when '#non'='#non' then '' else '#non' end	
	set @t_carno = case when '#non'='#non' then '' else '#non' end		
	set @t_enddate = case when '#non'='#non' then '' else '#non' end	
	
	declare @tmp table(
		gno nvarchar(1),
		車牌 nvarchar(20),
		車主 nvarchar(20),
		車行 nvarchar(20),
		欠款金額 int,
		過入日 nvarchar(1),
		廠牌 nvarchar(20),
		電話 nvarchar(20),
		行動 nvarchar(20)
	)	
	
	insert into @tmp
		select 
			'0' gno
		from borrs a
		left join borr b on a.noa = b.noa
		left join car2 c on b.carno = c.noa 
		left join cardeal d on c.cardealno = d.noa
		left join carOwner e on c.carownerno = e.noa
		left join carbrand f on c.carbrandno = f.noa
		where (len(@t_carno)=0 or b.carno=@t_carno)and
		      (c.cardealno between @t_bcardealno and @t_ecardealno) and
		      (c.carownerno between @t_bcarownerno and @t_ecarownerno)
	;
	------------------------------------------------------------------------------------------------
z_car30:--z_car30	
declare @t_bcardealno nvarchar(20)
declare @t_ecardealno nvarchar(20)
declare @t_xmon nvarchar(20)
set @t_bcardealno = case when '#non' = [5] then '' else [5] end
set @t_ecardealno = case when '#non' = [6] then CHAR(255) else [6] end
set @t_xmon = case when '#non' = [18] then '' else [18] end

declare @tmpa table( 
gno nvarchar(1),  
cardealno nvarchar(20), 
cardeal nvarchar(50), 
total float ,
mon nvarchar(10)
) 

insert into @tmpa 
select '0' gno,b.cardealno,c.comp,sum(a.paytotal),@t_xmon
from cara a 
left join car2 b on a.carno = b.noa 
left join cardeal c on b.cardealno = c.noa 
where @t_xmon = a.mon and
(b.cardealno between @t_bcardealno and @t_ecardealno)
group by  b.cardealno,c.comp


insert into @tmpa
select '1' gno,'','',SUM(total) ,@t_xmon
from @tmpa

select gno,cardealno,cardeal,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total),1)),4,12)) total,mon
from @tmpa
order by gno,cardealno;
-----------------------------------------------------------------------------------------
z_car31:--z_car31
declare @t_bdate nvarchar(20)
declare @t_edate nvarchar(20)
declare @t_sssno nvarchar(20)
set @t_bdate = case when '#non' = [3] then '' else [3] end
set @t_edate = case when '#non' = [4] then CHAR(255) else [4] end
set @t_sssno  = case when '#non'=[24] then char(255) else [24] end
declare @tmp table(
        gno nvarchar(1), 
        datea nvarchar(20),
        carno nvarchar(20),
        carowner nvarchar(50),
        insurer nvarchar(50),
        moneys float,
        insuresheet nvarchar(20),
        insurecard nvarchar(20)
)
declare @cmd nvarchar(MAX)

set @cmd='select ''0'' gno,a.edate,a.noa,c.namea,a.insurer,a.money,a.insuresheet,a.insurecard 
from carInsure a left join car2 b on a.noa = b.noa left join carOwner c on c.noa = b.carownerno 
where (a.edate >= @t_bdate and a.edate <= @t_edate) and (b.outdate is null or b.outdate='''') and b.carownerno!='''' and (b.enddate='''' or b.enddate is null)'

if(PATINDEX('%070120%',@t_sssno)=0)
	set @cmd=@cmd+' and b.sssno!=''070120'' and b.sssno!='''''
if(PATINDEX('%070121%',@t_sssno)=0)
	set @cmd=@cmd+' and b.sssno!=''070121'''
if(PATINDEX('%070122%',@t_sssno)=0)
	set @cmd=@cmd+' and b.sssno!=''070122'''

insert into @tmp 
execute sp_executesql @cmd,N'@t_bdate nvarchar(20),@t_edate nvarchar(20)',
		@t_bdate=@t_bdate,@t_edate=@t_edate
		
insert into @tmp 
select '1' gno,'','','','',SUM(moneys),'','' 
from @tmp 

select gno,datea,carno,carowner,insurer, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,moneys),1)),4,12)) moneys, 
insuresheet,insurecard 
from @tmp order by gno,datea;
------------------------------------------------------------------------------
z_car32:--z_car32
declare @t_binsurerno nvarchar(20)
declare @t_einsurerno nvarchar(20)
declare @t_bdate nvarchar(20)
declare @t_edate nvarchar(20)
declare @t_sssno nvarchar(20)
set @t_binsurerno = case when '#non' = [19] then '' else [19] end
set @t_einsurerno = case when '#non' = [20] then CHAR(255) else [20] end
set @t_bdate = case when '#non' = [3] then '' else [3] end
set @t_edate = case when '#non' = [4] then CHAR(255) else [4] end
set @t_sssno  = case when '#non'=[24] then char(255) else [24] end
declare @tmp table(
		gno nvarchar(20),
		xinsurerno nvarchar(20),
		insurer nvarchar(50),
		carno nvarchar(20),
		carowner nvarchar(50),
		datea nvarchar(20),
		moneys float,
		kind nvarchar(20),
		recno float
)

declare @cmd nvarchar(MAX)

set @cmd='select ''0'' gno,a.insurerno,a.insurer,a.noa,c.namea,a.edate,a.money,a.kind,ROW_NUMBER()over(PARTITION BY a.insurer order by a.noa) recno 
from carInsure a 
left join car2 b on a.noa = b.noa 
left join carOwner c on c.noa = b.carownerno 
where (a.edate >= @t_bdate and a.edate <= @t_edate) and 
(a.insurerno between @t_binsurerno and @t_einsurerno) and b.carownerno!='''' and (b.enddate='''' or b.enddate is null) and (b.outdate='''' or b.outdate is null)'

if(PATINDEX('%070120%',@t_sssno)=0)
	set @cmd=@cmd+' and b.sssno!=''070120'' and b.sssno!='''''
if(PATINDEX('%070121%',@t_sssno)=0)
	set @cmd=@cmd+' and b.sssno!=''070121'''
if(PATINDEX('%070122%',@t_sssno)=0)
	set @cmd=@cmd+' and b.sssno!=''070122'''

insert into @tmp 
execute sp_executesql @cmd,N'@t_bdate nvarchar(20),@t_edate nvarchar(20),@t_binsurerno nvarchar(20),@t_einsurerno nvarchar(20)',
		@t_bdate=@t_bdate,@t_edate=@t_edate,@t_binsurerno=@t_binsurerno,@t_einsurerno=@t_einsurerno

insert into @tmp
select '1' gno,xinsurerno,'','','','',SUM(moneys),'',max(recno)
from @tmp
group by xinsurerno

select gno,xinsurerno,insurer,carno,carowner,datea,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,moneys),1)),4,12)) moneys,
kind,recno
from @tmp
order by xinsurerno,gno,carno,datea;
------------------------------------------------------------------------------
z_car33:--z_car33
	declare @t_bcarownerno nvarchar(20)
	declare @t_ecarownerno nvarchar(20)
	declare @t_enddate nvarchar(10)
	
	set @t_bcarownerno = case when '#non'=[7] then '' else [7] end
	set @t_ecarownerno  = case when '#non'=[8] then char(255) else [8] end	
	set @t_enddate = case when '#non'=[15] then '' else [15] end

	declare @tmp table( 
		cardealno nvarchar(20), 
		cardeal nvarchar(50), 
		carownerno nvarchar(20), 
		carowner nvarchar(50), 
		lenderno nvarchar(20), 
		lender nvarchar(50), 
		money int, 
		installmentamount int, 
		installment int, 
		bkmoney int, 
		surplusment int, 
		surplusmoney int, 
		bdate nvarchar(50), 
		edate nvarchar(50), 
		memo nvarchar(MAX), 
		carnos nvarchar(MAX) 
	) 
	--case說明--如果貸款止日>截止日期表示還沒還清否則已還清，沒有還清則計算剩餘還款期數(如果今天日期<計日，表示當期還沒還款，所以+1) 
	insert into @tmp 
		select a.cardealno,a.cardeal,a.noa,b.namea,a.lenderno,a.lender,a.money,a.installmentamount,a.installment,a.bkmoney, 
		case when a.edate > @t_enddate then 
		(left(a.edate,3)*12+right(left(a.edate,6),2))-(left(@t_enddate,3)*12+right(left(@t_enddate,6),2))+(case when right(@t_enddate,2)<=a.day then 1 else 0 end) else 0 end surplusment, 
		0 surplusmoney,a.bdate,a.edate,a.memo,a.carnos 
		from carLender a left join carOwner b on a.noa=b.noa 
		order by a.noa 
	
	--計算貸款餘額 
	update @tmp 
	set surplusmoney=surplusment*installmentamount 
	where surplusment>0 
	
	declare @tmpa table( 
		gno nvarchar(20), 
		carownerno nvarchar(20), 
		typea nvarchar(20), 
		asset nvarchar(100),
		gdate nvarchar(10),
		dmoney int, 
		cmoney int,  
		fdate nvarchar(10),
		memo nvarchar(MAX),
		total int
	) 
	insert into @tmpa
	select '0',noa ,typea,asset,getdate,money,null,fdate,memo,0
	from balance
	union
	select '0',carownerno,'車輛'typea,noa,indate,cast(round(inmoney*POWER(0.800,((left(@t_enddate,3)*12)+right(left(@t_enddate,6),2))-(left(indate,3)*12+right(left(indate,6),2))),0) as int),null,@t_enddate,memo,0
	from car2
	--where indate!='' and inmoney>0
	union 
	select '0',carownerno,'負債'typea,carnos,bdate,null,surplusmoney,edate,memo,0
	from @tmp
	order by noa
	
	insert into @tmpa
	select '1',carownerno,'','','',SUM(dmoney),SUM(cmoney),'','',isnull(SUM(dmoney),0)-isnull(SUM(cmoney),0)
	from @tmpa
	group by carownerno
	
	select a.gno,a.carownerno,a.typea,a.asset,a.gdate,a.fdate,a.memo,b.namea
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.dmoney),1)),4,12)) dmoney
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.cmoney),1)),4,12)) cmoney
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.total),1)),4,12)) total
	from @tmpa a left join carOwner b on a.carownerno=b.noa
	where a.carownerno between @t_bcarownerno and @t_ecarownerno and a.carownerno!=''
	order by carownerno,gno;
	
--**************************************************************************************************
z_car34:--z_car34
	declare @t_bcardealno nvarchar(20)
	declare @t_ecardealno nvarchar(20)
	declare @t_bcarspecno nvarchar(20)
	declare @t_ecarspecno nvarchar(20)
	
	set @t_bcardealno = case when '#non'=[5] then '' else [5] end
	set @t_ecardealno  = case when '#non'=[6] then char(255) else [6] end	
	set @t_bcarspecno = case when '#non'=[21] then '' else [21] end
	set @t_ecarspecno  = case when '#non'=[22] then char(255) else [22] end	
--*********************************************************************************** 
declare @tmp table( 
	gno nvarchar(1), 
	cardealno nvarchar(20), 
	cardeal nvarchar(50), 
	recno int, 
	carno nvarchar(20), 
	carspecno nvarchar(20), 
	carspec nvarchar(50), 
	engineno nvarchar(50), 
	memo nvarchar(MAX) 
) 

declare @gno nvarchar(1)
declare @cardealno nvarchar(20)
declare @cardeal nvarchar(50)
declare @carno nvarchar(20)
declare @carspecno nvarchar(20)
declare @carspec nvarchar(50) 
declare @engineno nvarchar(50)

declare @recno int
declare @t_cardealno nvarchar(20) 
set @t_cardealno='XXXXXXX' 
set @gno=1

declare @now_date nvarchar(10)--前一年現在日期
set @now_date=CONVERT (VARCHAR(7), DATEADD(YEAR,-1,GETDATE()),12 )+0890000
set @now_date=left(@now_date,3)+'/'+substring(@now_date,4,2)+'/'+right(@now_date,2)

--特殊！報停一年內的車也要印出
declare cursor_table cursor for 
select a.cardealno,b.comp,a.carno,a.carspecno,c.spec,a.engineno
from car2 a left join cardeal b on a.cardealno=b.noa 
left join carspec c on a.carspecno=c.noa 
where a.carownerno!='' and (a.enddate='' or a.enddate is null) and (a.outdate='' or a.outdate is null) and a.cardealno!='' and a.carspecno!=''
and (a.stopdate='' or a.stopdate is null or a.stopdate> @now_date)
and (a.cardealno between @t_bcardealno and @t_ecardealno) and (a.carspecno between @t_bcarspecno and @t_ecarspecno) 
order by cardealno,carspecno  
open cursor_table 
fetch next from cursor_table 
into @cardealno,@cardeal,@carno,@carspecno,@carspec,@engineno
while(@@FETCH_STATUS <> -1) 
	begin 
	if(@t_cardealno!=@cardealno) 
	begin 
		
		if(@t_cardealno!='XXXXXXX' and @gno!=1)
		begin
			while((@recno-1)%30!=0)
			begin
				insert into @tmp
				select '0'gno,@t_cardealno,'',@recno,'','','','',''
				set @recno=@recno+1
			end
			insert into @tmp 
			select '1'gno,@t_cardealno,'',null,'','','','',''
		end
		set @recno=1 
		set @t_cardealno=@cardealno 
	end 

	insert into @tmp 
	select '0',@cardealno,@cardeal,@recno,@carno,@carspecno,@carspec,@engineno,''
	
	set @gno=0

	if(@recno%30=0)
	begin
		insert into @tmp 
		select '1'gno,@cardealno,'',null,'','','','',''
		set @gno=1
	end

	set @recno=@recno+1 

	fetch next from cursor_table 
	into @cardealno,@cardeal,@carno,@carspecno,@carspec,@engineno
	end 
close cursor_table 
deallocate cursor_table 
--********************最後一筆****************************
	if(@t_cardealno!='XXXXXXX')
	begin
			while((@recno-1)%30!=0)
			begin
				insert into @tmp
				select '0'gno,@t_cardealno,'',@recno,'','','','',''
				set @recno=@recno+1
			end
			insert into @tmp 
			select '1'gno,@t_cardealno,'',null,'','','','',''
		end
--******************************************************
select * from @tmp;
----------------------------------------------------
z_cara:--z_cara車主欠款明細
SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	declare @pagecount int
	declare @t_bmon nvarchar(10)
	declare @t_emon nvarchar(10)
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_bcarownerno nvarchar(20)
	declare @t_ecarownerno nvarchar(20)
	declare @t_bcarno nvarchar(20)
	declare @t_ecarno nvarchar(20)
	set @pageCount = 12
	set @t_bmon = case when '#non'=[1] then '' else [1] end
	set @t_emon = case when '#non'=[2] then char(255) else [2] end
	set @t_bdate = case when '#non'=[3] then '' else [3] end
	set @t_edate = case when '#non'=[4] then char(255) else [4] end	
	set @t_bcarownerno = case when '#non'=[7] then '' else [7] end
	set @t_ecarownerno  = case when '#non'=[8] then char(255) else [8] end	
	set @t_bcarno = case when '#non'=[16] then '' else [16] end
	set @t_ecarno = case when '#non'=[17] then CHAR(255) else [17] end
declare @tmp table( 
[gno] nvarchar(1), 
[noa] nvarchar(30), 
[noq] nvarchar(20), 
[carno] nvarchar(20), 
[carownerno] nvarchar(20), 
[carowner] nvarchar(50), 
[indate] nvarchar(10), 
[carbrandno] nvarchar(20), 
[carbrand] nvarchar(50), 
[caryear] nvarchar(10), 
[mobile] nvarchar(50), 
[caritem] nvarchar(50), 
[mon] nvarchar(20), 
[datea] nvarchar(20), 
[memo] nvarchar(max), 
[outmoney] int, 
[inmoney] int, 
recno int, 
currecno int, 
curpage int, 
totpage int, 
[total] int, 
[cmount] int, 
primary key (carownerno,carno,noa,noq,gno) 
) 

declare @tmp2 table( 
[gno] nvarchar(1), 
[noa] nvarchar(30), 
[noq] nvarchar(20), 
[carno] nvarchar(20), 
[carownerno] nvarchar(20), 
[carowner] nvarchar(50), 
[indate] nvarchar(10), 
[carbrandno] nvarchar(20), 
[carbrand] nvarchar(50), 
[caryear] nvarchar(10), 
[mobile] nvarchar(50), 
[caritem] nvarchar(50), 
[mon] nvarchar(20), 
[datea] nvarchar(20), 
[memo] nvarchar(max), 
[outmoney] int, 
[inmoney] int, 
recno int, 
currecno int, 
curpage int, 
totpage int, 
[total] int, 
[cmount] int, 
primary key (carownerno,carno,noa,noq,gno) 
) 

set @cmd =	"select a.*,ROW_NUMBER()over(order by gno),0,0,0,0,0 "+ 
" from( " + 
"select '0' gno,a.noa ,a.noq,b.carno,isNull(c.carownerno,'') carownerno,isNull(d.namea,'') carowner,ISNULL(c.indate,'') indate, "+ 
"ISNULL(e.noa,'') carbrandno,ISNULL(e.brand,'') carbrand,ISNULL(c.caryear,'') caryear,ISNULL(d.mobile,'') mobile, "+ 
"a.caritem ,b.mon,a.datea,a.memo,a.outmoney,a.inmoney "+ 
"from caras a "+ 
"left join cara b on b.noa = a.noa "+ 
"left join car2 c on c.noa = b.carno "+ 
"left join carOwner d on d.noa = c.carownerno "+ 
"left join carbrand e on e.noa = c.carbrandno "+ 
" where "+ 
"(b.carno between @t_bcarno and @t_ecarno) and "+ 
"(c.carownerno between @t_bcarownerno and @t_ecarownerno) and "+ 
"(b.mon between @t_bmon and @t_emon)"+ 
" ) a" 

insert into @tmp 
execute sp_executesql @cmd,N'@t_bcarno nvarchar(20),@t_ecarno nvarchar(20),@t_bcarownerno nvarchar(20),@t_ecarownerno nvarchar(20), 
@t_bmon nvarchar(10),@t_emon nvarchar(10)', 
@t_bcarno = @t_bcarno,@t_ecarno = @t_ecarno,@t_bcarownerno=@t_bcarownerno,@t_ecarownerno=@t_ecarownerno, 
@t_bmon=@t_bmon,@t_emon=@t_emon 

--****************************************************************************************	
declare @carownerno nvarchar(20) 
declare @noa nvarchar(20) 
declare @noq nvarchar(3) 
declare @carno nvarchar(20) 
declare @outmoney int 
declare @inmoney int 
declare @total int 
declare @count int 
declare @t_count int 
declare @recno int 
declare @currecno int 
declare @curpage int 
declare @totpage int 
declare @cmount int 

declare @t_carownerno nvarchar(20) 
declare @t_noq nvarchar(3) 
declare @t_noa nvarchar(20) 
declare @t_carnos nvarchar(20) 
declare @t_outmoney1 int 
declare @t_inmoney1 int 
declare @t_total1 int 
declare @t_outmoney2 int 
declare @t_inmoney2 int 
declare @t_total2 int 
declare @t_outmoney3 int 
declare @t_inmoney3 int 
declare @t_total3 int 
declare @t_cmount int 
declare @t_currecno float 
declare @t_bxcarno nvarchar(20) 
declare @t_xcarownerno nvarchar(20) 
declare @t_bnoa nvarchar(20) 
declare @t_xrecno int 

set @t_carownerno = 'zzzzzzzzz' 
set @t_carnos = 'bbbbbbbb' 
set @t_noa = 'aaaaaaaa' 
set @t_noq = 'sdfwer' 
set @t_outmoney1 = 0 
set @t_inmoney1 = 0 
set @t_total1 = 0 
set @t_outmoney2 = 0 
set @t_inmoney2 = 0 
set @t_total2 = 0 
set @t_outmoney3 = 0 
set @t_inmoney3 = 0 
set @t_total3 = 0 
set @t_currecno = 0 
set @t_cmount = 0 
set @t_bxcarno = '' 
set @t_xcarownerno = '' 
set @t_bnoa = '' 
set @t_xrecno = 1 
--**************************計算月合計以noa	
declare cursor_table cursor for 
select carownerno,carno,noa,noq,outmoney,inmoney,total,currecno,curpage,totpage from @tmp 
open cursor_table 
fetch next from cursor_table 
into @carownerno,@carno,@noa,@noq,@outmoney,@inmoney,@total,@currecno,@curpage,@totpage 
while(@@FETCH_STATUS <> -1) 
begin 
if not(@t_noa = @noa) 
begin 
if not(@t_noa = 'aaaaaaaa') 
begin 
insert into @tmp 
select '1' gno,@t_bnoa,CHAR(255),@t_bxcarno,@t_xcarownerno,'','','','','','','','','','',@t_outmoney1,@t_inmoney1,0,@t_currecno,@curpage,@totpage,@t_total1,0 
end 
set @t_noa = @noa 
set @t_outmoney1 = @outmoney 
set @t_inmoney1 = @inmoney 
set @t_total1 = @outmoney-@inmoney 
set @t_currecno = @currecno 
end 
else 
begin 
set @t_outmoney1 = @t_outmoney1 + @outmoney 
set @t_inmoney1 = @t_inmoney1 + @inmoney 
set @t_total1 = @t_total1 + @outmoney-@inmoney 
set @t_currecno = @currecno +1 
end 
set @t_bxcarno = @carno 
set @t_xcarownerno = @carownerno 
set @t_bnoa = @noa 

update @tmp set total = @t_total1 where noa=@noa and noq=@noq 
fetch next from cursor_table 
into @carownerno,@carno,@noa,@noq,@outmoney,@inmoney,@total,@currecno,@curpage,@totpage 
end 
close cursor_table 
deallocate cursor_table 
if NOT(@t_noa = 'aaaaaaaa') 
begin 
insert @tmp 
select '1' gno,@t_bnoa,CHAR(255),@t_bxcarno,@t_xcarownerno,'','','','','','','','','','',@t_outmoney1,@t_inmoney1,0,@t_currecno,@curpage,@totpage,@t_total1,0 
end 

--***************************計算欠款累額以carno	
declare cursor_table cursor for 
select carownerno,carno,noa,noq,outmoney,inmoney,total,currecno,curpage,totpage from @tmp where gno = 0 
open cursor_table 
fetch next from cursor_table 
into @carownerno,@carno,@noa,@noq,@outmoney,@inmoney,@total,@currecno,@curpage,@totpage 
while(@@FETCH_STATUS <> -1) 
begin 
if not(@t_carnos = @carno) 
begin 
if not(@t_carnos = 'bbbbbbbb') 
begin 
insert into @tmp 
select '2' gno, @t_bnoa,CHAR(255),@t_bxcarno,@t_xcarownerno,'','','','','','','','','','',@t_outmoney2,@t_inmoney2,0,0,0,0,@t_total2,0 

insert into @tmp 
select '3' gno, @t_bnoa,CHAR(255),@t_bxcarno,@t_xcarownerno,'','','','','','','','','','',@t_outmoney2,@t_inmoney2,0,0,0,0,@t_total2,0 
end 
set @t_carnos = @carno 
set @t_outmoney2 = @outmoney 
set @t_inmoney2 = @inmoney 
set @t_total2 = @outmoney-@inmoney 
end 
else 
begin 
set @t_outmoney2 = @t_outmoney2 + @outmoney 
set @t_inmoney2 = @t_inmoney2 + @inmoney 
set @t_total2 = @t_total2 + @outmoney-@inmoney 
end 
set @t_bxcarno = @carno 
set @t_xcarownerno = @carownerno 
set @t_bnoa = @noa 
fetch next from cursor_table 
into @carownerno,@carno,@noa,@noq,@outmoney,@inmoney,@total,@currecno,@curpage,@totpage 
end 
close cursor_table 

deallocate cursor_table 
if NOT(@t_carnos = 'bbbbbbbb') 
begin 
insert @tmp 
select '2' gno,@t_bnoa,CHAR(255),@t_carnos,@carownerno,'','','','','','','','','','',@t_outmoney2,@t_inmoney2,0,0,0,0,@t_total2,0 
insert @tmp 
select '3' gno,@t_bnoa,CHAR(255),@t_carnos,@carownerno,'','','','','','','','','','',@t_outmoney2,@t_inmoney2,0,0,0,0,@t_total2,0 
end	
--************************************計算總欠金額以carownerno	
declare cursor_table cursor for 
select carownerno,carno,noa,noq,outmoney,inmoney,total,cmount from @tmp where gno = 3 
open cursor_table 
fetch next from cursor_table 
into @carownerno,@carno,@noa,@noq,@outmoney,@inmoney,@total,@cmount 
while(@@FETCH_STATUS <> -1) 
begin 
if not(@t_carownerno = @carownerno) 
begin 
if not(@t_carownerno = 'zzzzzzzzz') 
begin	
select @cmount=COUNT(distinct carno) from @tmp where carownerno=@t_carownerno group by carownerno 
insert into @tmp 
select '4' gno,CHAR(255),CHAR(255),CHAR(255),@t_carownerno,'','','','','','','','','','',@t_outmoney3,@t_inmoney3,0,0,0,0,@t_total3,@cmount 

end 
set @t_carownerno = @carownerno 
set @t_outmoney3 = @outmoney 
set @t_inmoney3 = @inmoney 
set @t_total3 = @outmoney - @inmoney 
end 
else 
begin 
set @t_outmoney3 = @t_outmoney3 + @outmoney 
set @t_inmoney3 = @t_inmoney3 + @inmoney 
set @t_total3 = @t_total3 + @outmoney - @inmoney 
end 
update @tmp set total = @t_total3 where noa = @noa and noq = @noq and gno!='1'and gno!='2' 
fetch next from cursor_table 
into @carownerno,@carno,@noa,@noq,@outmoney,@inmoney,@total,@cmount 
end 
close cursor_table 
deallocate cursor_table 

if NOT(@t_carownerno = 'zzzzzzzzz') 
begin 
select @cmount=COUNT(distinct carno) from @tmp where carownerno=@t_carownerno group by carownerno 
insert @tmp 
select '4' gno,CHAR(255),CHAR(255),CHAR(255),@t_carownerno,'','','','','','','','','','',@t_outmoney3,@t_inmoney3,0,0,0,0,@t_total3,@cmount 

end	

------------------------------------------******************* 
insert into @tmp2 
select gno,noa,noq,carno,carownerno,carowner,indate,carbrandno,carbrand,caryear,mobile,caritem,mon,datea,memo,outmoney,inmoney, 
ROW_NUMBER() over (order by carownerno,carno,noa,noq,gno),currecno,curpage,totpage,total,cmount from @tmp	

delete @tmp 
insert into @tmp 
select * from @tmp2 
------------------------------------------******************** 

--******************************計算currecon	
declare cursor_table cursor for 
select carownerno,min(recno) from @tmp group by carownerno 
open cursor_table 
fetch next from cursor_table 
into @carownerno,@recno 
while(@@FETCH_STATUS <> -1) 
begin 
update @tmp set currecno = recno - @recno +1 where carownerno=@carownerno 
fetch next from cursor_table 
into @carownerno,@recno 
end 
close cursor_table 
deallocate cursor_table 

--**************************計算totpage 
declare cursor_table cursor for 
select carownerno,max(currecno) from @tmp group by carownerno 
open cursor_table 
fetch next from cursor_table 
into @carownerno,@currecno 
while(@@FETCH_STATUS <> -1) 
begin 
update @tmp set totpage = (@currecno-@currecno%@pagecount)/@pagecount+1 where carownerno=@carownerno 
fetch next from cursor_table 
into @carownerno,@currecno 
end 
close cursor_table 
deallocate cursor_table 

--**********************************計算curpage	
declare cursor_table cursor for 
select carownerno,recno,currecno from @tmp 
open cursor_table 
fetch next from cursor_table 
into @carownerno,@recno,@currecno 
while(@@FETCH_STATUS <> -1) 
begin 
update @tmp set curpage = FLOOR((@currecno-1)/@pagecount)+1 where carownerno=@carownerno and recno=@recno 
fetch next from cursor_table 
into @carownerno,@recno,@currecno 
end 
close cursor_table 
deallocate cursor_table 


-------------------------------- 
select gno,noa,noq,carno,carownerno,carowner,indate,carbrandno, 
carbrand,caryear,mobile,caritem,mon,datea,memo, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,outmoney),1)),4,12)) outmoney, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,inmoney),1)),4,12)) inmoney, 
recno,currecno,curpage,totpage, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total),1)),4,12)) total, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,cmount),1)),4,12)) cmount, 
CONVERT(nvarchar(5),curpage)+'/'+CONVERT(nvarchar(5),totpage) page 
from @tmp 
order by carownerno, carno, noa, gno;
--------------------------------------------------------------------------------------------------
