z_workg2ordb1:--z_workg2ordb1
SET QUOTED_IDENTIFIER OFF
declare @t_bdate nvarchar(10)
declare @t_edate nvarchar(10)
declare @t_bnoa nvarchar(100)
declare @t_enoa nvarchar(100)
declare @t_workgall nvarchar(100)
declare @t_stkdate nvarchar(30)

set @t_bdate = case when '#non' =  [2] then '' else  [2] end
set @t_edate = case when '#non' =  [3] then char(255) else  [3] end
set @t_bnoa = case when '#non' =  [4] then '' else  [4] end
set @t_enoa = case when '#non' =  [5] then char(255) else  [5] end
set @t_workgall = case when '#non' =  [8] then '0' else  [8] end

set @t_stkdate=CONVERT (VARCHAR(7), GETDATE(),12 )+0890000
set @t_stkdate=left(@t_stkdate,3)+'/'+substring(@t_stkdate,4,2)+'/'+right(@t_stkdate,2)
--*********************************************************************************************
declare @cmd nvarchar(max) 
declare @tmp table(
	gno nvarchar(1),
	productno nvarchar(30),
	products nvarchar(90),
	gdemand float,
	stkmount float,
	ordcmount float,
	safemount float,
	ndemand float,
	smount float,
	sordb float,
	sordc float,
	src2 float,
	sunrc2 float
)

if(@t_workgall='1')
begin
	insert into @tmp (gno,productno,products,gdemand,stkmount,ordcmount,safemount,ndemand)
	select '0',productno,(select product from ucc where noa=tmp.productno)products 
	,sum(gdemand)gdemand
	,isnull((select sum(mount) from stkucc(@t_stkdate,'','') where productno=tmp.productno),0)stkmount
	,sum(ordcmount)ordcmount
	,isnull((select safemount from ucc where noa=tmp.productno),0) safemount
	,0 ndemand 
	from ( 
		--生產計劃毛需求
		select ws.productno,sum(ws.mount-ws.gmount) gdemand,0 ordcmount from view_work w left join view_works ws on w.noa=ws.noa 
		left join view_workg g on w.cuano=g.noa
		where g.stype!='3' and ws.productno in (select noa from ucc where typea='4' or typea='5')  and w.enda!='1' and isnull(g.ordbno,'')=''
		group by ws.productno 
		union all 
		--採購未入
		select ocs.productno,0 gdemand,sum(ocs.mount)ordcmount from view_ordcs ocs 
		where ocs.enda!='1' and ocs.productno in (select noa from ucc where typea='4' or typea='5')  
		and charindex(ocs.ordbno,(select ','+ordbno from view_workg where stype!='3' and isnull(ordbno,'')!='' FOR XML PATH('')))>0
		group by ocs.productno 
	)tmp group by productno
end
else
begin
	insert into @tmp (gno,productno,products,gdemand,stkmount,ordcmount,safemount,ndemand)
	select '0',productno,(select product from ucc where noa=tmp.productno)products 
	,sum(gdemand)gdemand 
	,isnull((select sum(mount) from stkucc(@t_stkdate,'','') where productno=tmp.productno),0)stkmount
	,sum(ordcmount)ordcmount
	,isnull((select safemount from ucc where noa=tmp.productno),0) safemount
	,0 ndemand 
	from ( 
		--生產計劃毛需求
		select ws.productno,sum(ws.mount-ws.gmount) gdemand,0 ordcmount from view_work w left join view_works ws on w.noa=ws.noa 
		left join view_workg g on w.cuano=g.noa
		where g.stype!='3' and ws.productno in (select noa from ucc where typea='4' or typea='5') and w.enda!='1' 
		and g.noa between @t_bnoa and @t_enoa and isnull(g.ordbno,'')=''
		group by ws.productno
		union all 
		--採購未入
		select ocs.productno,0 gdemand,sum(ocs.mount)ordcmount from view_ordcs ocs 
		where ocs.enda!='1' and ocs.productno in (select noa from ucc where typea='4' or typea='5')  
		and charindex(ocs.ordbno,(select ','+ordbno from view_workg where noa between @t_bnoa and @t_enoa and stype!='3' and isnull(ordbno,'')!='' FOR XML PATH('')))>0
		group by ocs.productno 
	)tmp group by productno
end

update @tmp set ndemand = (gdemand-ordcmount-stkmount+safemount) 
update @tmp set ndemand=0 where ndemand<0


declare @tmpa table(
	workgno nvarchar(90),
	productno nvarchar(30),
	smount float,
	ordbno nvarchar(90),
	sordb float,
	ordcno nvarchar(90),
	sordc float,
	src2 float,
	sunrc2 float
)

if(@t_workgall='1')
begin
	insert into @tmpa(workgno,productno,smount)
	select g.noa,ws.productno,ws.mount-ws.gmount smount
	from view_workh w left join view_workhs ws on w.noa=ws.noa 
	left join view_workg g on w.cuano=g.noa
	where g.stype='3' and 
	ws.productno in (select noa from ucc where typea='4' or typea='5') 
	and w.enda!='1' and isnull(g.ordbno,'')=''
end
else
begin
	insert into @tmpa(workgno,productno,smount)
	select g.noa,ws.productno,ws.mount-ws.gmount smount
	from view_workh w left join view_workhs ws on w.noa=ws.noa 
	left join view_workg g on w.cuano=g.noa
	where g.stype='3' and g.noa between @t_bnoa and @t_enoa and
	ws.productno in (select noa from ucc where typea='4' or typea='5') 
	and w.enda!='1' and isnull(g.ordbno,'')=''
end

declare @workgno nvarchar(max) 

declare cursor_table cursor for 
select workgno from @tmpa group by workgno
open cursor_table 
fetch next from cursor_table 
into @workgno
while(@@FETCH_STATUS <> -1) 
begin

	insert into @tmpa(ordbno,productno,sordb)
	select a.noa,b.productno,b.mount
	from view_ordb a left join view_ordbs b on a.noa=b.noa
	where charindex(@workgno,a.workgno)>0 
	and a.workgno!=''

	fetch next from cursor_table 
	into @workgno
	
end 
close cursor_table 
deallocate cursor_table 


declare @ordbno nvarchar(max) 

declare cursor_table cursor for 
select ordbno from @tmpa group by ordbno
open cursor_table 
fetch next from cursor_table 
into @ordbno
while(@@FETCH_STATUS <> -1) 
begin

	insert into @tmpa(ordcno,productno,sordc)
	select a.noa,b.productno,b.mount
	from view_ordc a left join view_ordcs b on a.noa=b.noa
	where charindex(@ordbno,b.ordbno)>0
	and b.ordbno!=''

	fetch next from cursor_table 
	into @ordbno
	
end 
close cursor_table 
deallocate cursor_table 

declare @ordcno nvarchar(max) 

declare cursor_table cursor for 
select ordcno from @tmpa group by ordcno
open cursor_table 
fetch next from cursor_table 
into @ordcno
while(@@FETCH_STATUS <> -1) 
begin

	insert into @tmpa(productno,src2)
	select b.productno,b.mount
	from view_rc2 a left join view_rc2s b on a.noa=b.noa
	where charindex(@ordcno,b.ordeno)>0
	and b.ordeno!=''

	fetch next from cursor_table 
	into @ordcno
	
end 
close cursor_table 
deallocate cursor_table 

update a
set smount=(select SUM(smount) from @tmpa where productno=a.productno)
,sordb=(select SUM(sordb) from @tmpa where productno=a.productno)
,sordc=(select SUM(sordc) from @tmpa where productno=a.productno)
,src2=(select SUM(src2) from @tmpa where productno=a.productno)
from @tmp a

insert @tmp (gno,productno,products,smount,sordb,sordc,src2)

select '0',productno,(select product from ucc where noa=a.productno)products 
,SUM(smount),SUM(sordb),SUM(sordc),SUM(src2) from @tmpa a 
where productno not in (select productno from @tmp) group by productno

update @tmp
set sunrc2=smount-src2

select gno,productno,products,
reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,gdemand),1)),0,30)) gdemand,
reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,ordcmount),1)),0,30)) ordcmount,
reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,stkmount),1)),0,30)) stkmount,
reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,safemount),1)),0,30)) safemount,
reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,ndemand),1)),0,30)) ndemand,

reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,isnull(smount,0)),1)),0,30)) smount,
reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,isnull(sordb,0)),1)),0,30)) sordb,
reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,isnull(sordc,0)),1)),0,30)) sordc,
reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,isnull(src2,0)),1)),0,30)) src2,
reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,isnull(sunrc2,0)),1)),0,30)) sunrc2
from @tmp
;
----**************************************************************************************
z_workg2ordb2:--z_workg2ordb2
SET QUOTED_IDENTIFIER OFF
declare @t_bdate nvarchar(10)
declare @t_edate nvarchar(10)
declare @t_bnoa nvarchar(100)
declare @t_enoa nvarchar(100)
declare @t_workgall nvarchar(100)
declare @t_stkdate nvarchar(30)

set @t_bdate = case when '#non' =  [2] then '' else  [2] end
set @t_edate = case when '#non' =  [3] then char(255) else  [3] end
set @t_bnoa = case when '#non' =  [4] then '' else  [4] end
set @t_enoa = case when '#non' =  [5] then char(255) else  [5] end
set @t_workgall = case when '#non' =  [8] then '0' else  [8] end

set @t_stkdate=CONVERT (VARCHAR(7), GETDATE(),12 )+0890000
set @t_stkdate=left(@t_stkdate,3)+'/'+substring(@t_stkdate,4,2)+'/'+right(@t_stkdate,2)
--*********************************************************************************************
declare @cmd nvarchar(max) 
IF OBJECT_ID('tempdb..#tmp')is not null
BEGIN
	set @cmd = 'drop table #tmp'
	EXECUTE sp_executesql @cmd
END

create table #tmp(
	gno nvarchar(1),
	productno nvarchar(30),
	products nvarchar(90),
	gdemand float,
	stkmount float,
	ordcmount float,
	safemount float,
	ndemand float,
	smount float,
	sordb float,
	sordc float,
	src2 float,
	sunrc2 float
)

if(@t_workgall='1')
begin
	insert into #tmp (gno,productno,products,gdemand,stkmount,ordcmount,safemount,ndemand)
	select '0',productno,(select product from ucc where noa=tmp.productno)products 
	,sum(gdemand)gdemand 
	,isnull((select sum(mount) from stkucc(@t_stkdate,'','') where productno=tmp.productno),0)stkmount
	,sum(ordcmount)ordcmount
	,isnull((select safemount from ucc where noa=tmp.productno),0) safemount
	,0 ndemand 
	from ( 
		--生產計劃毛需求
		select ws.productno,sum(ws.mount-ws.gmount) gdemand,0 ordcmount from view_work w left join view_works ws on w.noa=ws.noa 
		left join view_workg g on w.cuano=g.noa
		where ws.productno in (select noa from ucc where typea='4' or typea='5')  and w.enda!='1' and isnull(g.ordbno,'')=''
		group by ws.productno 
		union all 
		--採購未入
		select ocs.productno,0 gdemand,sum(ocs.mount)ordcmount from view_ordcs ocs 
		where ocs.enda!='1' and ocs.productno in (select noa from ucc where typea='4' or typea='5')  
		and charindex(ocs.ordbno,(select ','+ordbno from view_workg where isnull(ordbno,'')!='' FOR XML PATH('')))>0
		group by ocs.productno 
	)tmp group by productno
end
else
begin
	insert into #tmp(gno,productno,products,gdemand,stkmount,ordcmount,safemount,ndemand)
	select '0',productno,(select product from ucc where noa=tmp.productno)products 
	,sum(gdemand)gdemand
	,isnull((select sum(mount) from stkucc(@t_stkdate,'','') where productno=tmp.productno),0)stkmount
	,sum(ordcmount)ordcmount
	,isnull((select safemount from ucc where noa=tmp.productno),0) safemount
	,0 ndemand 
	from ( 
		--生產計劃毛需求
		select ws.productno,sum(ws.mount-ws.gmount) gdemand,0 ordcmount from view_work w left join view_works ws on w.noa=ws.noa 
		left join view_workg g on w.cuano=g.noa
		where ws.productno in (select noa from ucc where typea='4' or typea='5') and w.enda!='1' 
		and g.noa between @t_bnoa and @t_enoa and isnull(g.ordbno,'')=''
		group by ws.productno 
		union all 
		--採購未入
		select ocs.productno,0 gdemand,sum(ocs.mount)ordcmount from view_ordcs ocs 
		where ocs.enda!='1' and ocs.productno in (select noa from ucc where typea='4' or typea='5')
		and charindex(ocs.ordbno,(select ','+ordbno from view_workg where noa between @t_bnoa and @t_enoa and isnull(ordbno,'')!='' FOR XML PATH('')))>0
		group by ocs.productno 
	)tmp group by productno
end

update #tmp set ndemand = (gdemand-ordcmount-stkmount+safemount) 
update #tmp set ndemand=0 where ndemand<0

declare @tmpa table(
	workgno nvarchar(90),
	productno nvarchar(30),
	smount float,
	ordbno nvarchar(90),
	sordb float,
	ordcno nvarchar(90),
	sordc float,
	src2 float,
	sunrc2 float
)

if(@t_workgall='1')
begin
	insert into @tmpa(workgno,productno,smount)
	select g.noa,ws.productno,ws.mount-ws.gmount smount
	from view_workh w left join view_workhs ws on w.noa=ws.noa 
	left join view_workg g on w.cuano=g.noa
	where g.stype='3' and 
	ws.productno in (select noa from ucc where typea='4' or typea='5') 
	and w.enda!='1' and isnull(g.ordbno,'')=''
end
else
begin
	insert into @tmpa(workgno,productno,smount)
	select g.noa,ws.productno,ws.mount-ws.gmount smount
	from view_workh w left join view_workhs ws on w.noa=ws.noa 
	left join view_workg g on w.cuano=g.noa
	where g.stype='3' and g.noa between @t_bnoa and @t_enoa and
	ws.productno in (select noa from ucc where typea='4' or typea='5') 
	and w.enda!='1' and isnull(g.ordbno,'')=''
end

declare @xworkgno nvarchar(max) 

declare cursor_table cursor for 
select workgno from @tmpa group by workgno
open cursor_table 
fetch next from cursor_table 
into @xworkgno
while(@@FETCH_STATUS <> -1) 
begin

	insert into @tmpa(ordbno,productno,sordb)
	select a.noa,b.productno,b.mount
	from view_ordb a left join view_ordbs b on a.noa=b.noa
	where charindex(@xworkgno,a.workgno)>0 
	and a.workgno!=''

	fetch next from cursor_table 
	into @xworkgno
	
end 
close cursor_table 
deallocate cursor_table 


declare @xordbno nvarchar(max) 

declare cursor_table cursor for 
select ordbno from @tmpa group by ordbno
open cursor_table 
fetch next from cursor_table 
into @xordbno
while(@@FETCH_STATUS <> -1) 
begin

	insert into @tmpa(ordcno,productno,sordc)
	select a.noa,b.productno,b.mount
	from view_ordc a left join view_ordcs b on a.noa=b.noa
	where charindex(@xordbno,b.ordbno)>0
	and b.ordbno!=''

	fetch next from cursor_table 
	into @xordbno
	
end 
close cursor_table 
deallocate cursor_table 

declare @ordcno nvarchar(max) 

declare cursor_table cursor for 
select ordcno from @tmpa group by ordcno
open cursor_table 
fetch next from cursor_table 
into @ordcno
while(@@FETCH_STATUS <> -1) 
begin

	insert into @tmpa(productno,src2)
	select b.productno,b.mount
	from view_rc2 a left join view_rc2s b on a.noa=b.noa
	where charindex(@ordcno,b.ordeno)>0
	and b.ordeno!=''

	fetch next from cursor_table 
	into @ordcno
	
end 
close cursor_table 
deallocate cursor_table 

update a
set smount=(select SUM(smount) from @tmpa where productno=a.productno)
,sordb=(select SUM(sordb) from @tmpa where productno=a.productno)
,sordc=(select SUM(sordc) from @tmpa where productno=a.productno)
,src2=(select SUM(src2) from @tmpa where productno=a.productno)
from #tmp a

insert #tmp (gno,productno,products,smount,sordb,sordc,src2)
select '0',productno,(select product from ucc where noa=a.productno)products 
,SUM(smount),SUM(sordb),SUM(sordc),SUM(src2) from @tmpa a 
where productno not in (select productno from #tmp) group by productno

update #tmp
set sunrc2=smount-src2

select gno,productno,products,
reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,gdemand),1)),0,30)) gdemand,
reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,ordcmount),1)),0,30)) ordcmount,
reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,stkmount),1)),0,30)) stkmount,
reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,safemount),1)),0,30)) safemount,
reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,ndemand),1)),0,30)) ndemand,

reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,isnull(smount,0)),1)),0,30)) smount,
reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,isnull(sordb,0)),1)),0,30)) sordb,
reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,isnull(sordc,0)),1)),0,30)) sordc,
reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,isnull(src2,0)),1)),0,30)) src2,
reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,isnull(sunrc2,0)),1)),0,30)) sunrc2
from #tmp


--*************************************************************************************
--寫入請購單
declare @sssno nvarchar(max)=[9] --採購員編號
declare @ordbno nvarchar(max)=[10] --目前請購代號
declare @ordbum nvarchar(max) --目前請購序號
declare @typea nvarchar(max) 
declare @tggno nvarchar(max) 
declare @ordbdate nvarchar(10) 
declare @ordbnos nvarchar(MAX) --全部請購單編號
--要寫入的workg單號
declare @workgnos nvarchar(MAX)

if(@t_workgall='1') 
set @workgnos=(SELECT STUFF((select ','+noa from view_workg where isnull(ordbno,'')='' and stype!='3' FOR XML PATH('')),1,1,'')) 
else
set @workgnos=(SELECT STUFF((select ','+noa from view_workg where noa between @t_bnoa and @t_enoa and stype!='3' and isnull(ordbno,'')='' FOR XML PATH('')),1,1,'')) 

set @ordbnos=''

set @cmd="select @ordbum= isnull(right((select top 1 noa from view_ordb where CHARINDEX('"+@ordbno+"'+ REPLACE('"+@t_stkdate+"','/',''),noa)>0 order by noa desc),3),'0')"
EXEC SP_EXECUTESQL @cmd, N'@ordbum nvarchar(max) OUTPUT', @ordbum OUTPUT

--採購有效日
set @ordbdate=CONVERT (VARCHAR(7), GETDATE()+3,12 )+0890000
set @ordbdate=left(@ordbdate,3)+'/'+substring(@ordbdate,4,2)+'/'+right(@ordbdate,2)

--產生請購單
declare cursor_table cursor for 
select typea,tggno from( 
select b.typea
,case when isnull((select top 1 tggno from view_rc2s where productno=a.productno order by datea desc),'')=''
then b.tggno else (select top 1 tggno from view_rc2s where productno=a.productno order by datea desc) end tggno 
from #tmp a left join ucc b on a.productno=b.noa where a.ndemand>0
) tmp group by typea,tggno

open cursor_table 
fetch next from cursor_table 
into @typea,@tggno
while(@@FETCH_STATUS <> -1) 
begin

	EXEC("insert into ordb"+[1]+" (datea,odate,noa,kind,tggno,tgg,nick,paytype,trantype,tel,fax,cno,acomp,salesno,sales,worker,money,taxtype,total,memo,enda,isproj,workgno)
	select '"+@ordbdate+"','"+@t_stkdate+"','"+@ordbno+"'+ REPLACE('"+@t_stkdate+"','/','')+right(('000'+cast(cast('"+@ordbum+"' as int)+1 as nvarchar(10))),3) noa
	,'2' kind,'"+@tggno+"' tggno,(select comp from tgg where noa='"+@tggno+"') tgg,(select nick from tgg where noa='"+@tggno+"') nick
	,(select paytype from tgg where noa='"+@tggno+"') paytype,(select trantype from tgg where noa='"+@tggno+"') trantype
	,(select tel from tgg where noa='"+@tggno+"') tel,(select fax from tgg where noa='"+@tggno+"') fax
	,(select cno from sss where noa='"+@sssno+"') cno,(select comp from sss where noa='"+@sssno+"') acomp
	,'"+@sssno+"' salesno,(select namea from sss where noa='"+@sssno+"') sales,(select namea from nhpe where noa='"+@sssno+"') worker
	,(select sum(isnull(a.ndemand,0)*isnull(b.inprice,0)) total from #tmp a left join ucc b on a.productno=b.noa where a.ndemand>0 and b.typea='"+@typea+"' and b.tggno=tggno)money,'5' taxtype
	,(select sum(isnull(a.ndemand,0)*isnull(b.inprice,0)) total from #tmp a left join ucc b on a.productno=b.noa where a.ndemand>0 and b.typea='"+@typea+"' and b.tggno=tggno)total
	,'"+@t_stkdate+"'+' 物料需求表("+@workgnos+") 轉來 'memo,0,1,'"+@workgnos+"'")
	
	--0315要在寫入原始請購量 ordbs.omount ，不給修改
	EXEC("insert into ordbs"+[1]+"(datea,noa,no3,productno,product,unit,mount,omount,price,total,tggno,enda,kind,memo,smount)
	select '"+@ordbdate+"','"+@ordbno+"'+ REPLACE('"+@t_stkdate+"','/','')+right(('000'+cast(cast('"+@ordbum+"' as int)+1 as nvarchar(10))),3) noa
	,right('000'+cast(ROW_NUMBER() OVER (ORDER BY a.productno DESC) as nvarchar(10)),3) no3
	,a.productno,a.products,b.unit
	,case when isnull(b.stdmount,0)>0 then ceiling(isnull(a.ndemand,0)/isnull(b.stdmount,0))*isnull(b.stdmount,0) else isnull(a.ndemand,0) end ndemand
	,case when isnull(b.stdmount,0)>0 then ceiling(isnull(a.ndemand,0)/isnull(b.stdmount,0))*isnull(b.stdmount,0) else isnull(a.ndemand,0) end ndemand
	,isnull((select top 1 ub.price from ucctgg ua left join ucctggs ub on ua.noa=ub.noa  where ua.tggno='"+@tggno+"' and ua.productno=a.productno and a.ndemand >= ub.mount order by ub.mount desc),0) inprice
	,isnull(a.ndemand,0)*isnull((select top 1 ub.price from ucctgg ua left join ucctggs ub on ua.noa=ub.noa  where ua.tggno='"+@tggno+"' and ua.productno=a.productno and a.ndemand >= ub.mount order by ub.mount desc),0) total
	,'"+@tggno+"',0, '2' kind
	,isnull((select ordcmemo+' ' from ucctgg where productno=a.productno and tggno='"+@tggno+"'),'')+isnull((select '廠商料號:'+productno2 from ucctgg where productno=a.productno and tggno='"+@tggno+"'),'')
	,cast(a.gdemand as nvarchar(30))+','+cast(a.stkmount as nvarchar(30))+','+cast(a.ordcmount as nvarchar(30))+','+cast(a.safemount as nvarchar(30))+','+cast(a.ndemand as nvarchar(30))
	+','+cast(isnull(a.smount,0) as nvarchar(30))+','+cast(isnull(a.sordb,0) as nvarchar(30))+','+cast(isnull(a.sordc,0) as nvarchar(30))+','+cast(isnull(a.src2,0) as nvarchar(30))+','+cast(isnull(a.sunrc2,0) as nvarchar(30)) 
	from #tmp a left join ucc b on a.productno=b.noa where a.ndemand>0 and b.typea='"+@typea+"' and (case when isnull((select top 1 tggno from view_rc2s where productno=a.productno order by datea desc),'')='' then b.tggno else (select top 1 tggno from view_rc2s where productno=a.productno order by datea desc) end)='"+@tggno+"'")

	set @ordbnos=@ordbnos+@ordbno+ REPLACE(@t_stkdate,'/','')+right(('000'+cast(cast(@ordbum as int)+1 as nvarchar(10))),3)+','
	
	set @ordbum=right(('000'+cast(cast(@ordbum as int)+1 as nvarchar(10))),3)
	fetch next from cursor_table 
	into @typea,@tggno
	
end 
close cursor_table 
deallocate cursor_table 

declare @accy nvarchar(MAX)
declare @workgno nvarchar(MAX)

if(len(@ordbnos)>0)
begin
	declare cursor_table cursor for 
	select accy,noa from view_workg where charindex(noa,@workgnos)>0 
	open cursor_table 
	fetch next from cursor_table 
	into @accy,@workgno
	while(@@FETCH_STATUS <> -1) 
	begin
		
		EXEC("update workg"+@accy+"
		set ordbno=left('"+@ordbnos+"',len('"+@ordbnos+"')-1)
		where noa='"+@workgno+"'")
			
		fetch next from cursor_table 
		into @accy,@workgno
	end 
	close cursor_table 
	deallocate cursor_table 
end
--虛擬begin---------------------------------------------------------------------------------------------------------------
if(@t_workgall='1') 
set @workgnos=(SELECT STUFF((select ','+noa from view_workg where isnull(ordbno,'')='' and stype='3' FOR XML PATH('')),1,1,'')) 
else
set @workgnos=(SELECT STUFF((select ','+noa from view_workg where noa between @t_bnoa and @t_enoa and stype='3' and isnull(ordbno,'')='' FOR XML PATH('')),1,1,'')) 

set @ordbnos=''

set @cmd="select @ordbum= isnull(right((select top 1 noa from view_ordb where CHARINDEX('"+@ordbno+"'+ REPLACE('"+@t_stkdate+"','/',''),noa)>0 order by noa desc),3),'0')"
EXEC SP_EXECUTESQL @cmd, N'@ordbum nvarchar(max) OUTPUT', @ordbum OUTPUT

--採購有效日
set @ordbdate=CONVERT (VARCHAR(7), GETDATE()+3,12 )+0890000
set @ordbdate=left(@ordbdate,3)+'/'+substring(@ordbdate,4,2)+'/'+right(@ordbdate,2)

--產生請購單
declare cursor_table cursor for 
select typea,tggno from( 
select b.typea
,case when isnull((select top 1 tggno from view_rc2s where productno=a.productno order by datea desc),'')=''
then b.tggno else (select top 1 tggno from view_rc2s where productno=a.productno order by datea desc) end tggno 
from #tmp a left join ucc b on a.productno=b.noa where isnull(a.smount,0)>0
) tmp group by typea,tggno

open cursor_table 
fetch next from cursor_table 
into @typea,@tggno
while(@@FETCH_STATUS <> -1) 
begin

	EXEC("insert into ordb"+[1]+" (datea,odate,noa,kind,tggno,tgg,nick,paytype,trantype,tel,fax,cno,acomp,salesno,sales,worker,money,taxtype,total,memo,enda,isproj,workgno)
	select '"+@ordbdate+"','"+@t_stkdate+"','"+@ordbno+"'+ REPLACE('"+@t_stkdate+"','/','')+right(('000'+cast(cast('"+@ordbum+"' as int)+1 as nvarchar(10))),3) noa
	,'2' kind,'"+@tggno+"' tggno,(select comp from tgg where noa='"+@tggno+"') tgg,(select nick from tgg where noa='"+@tggno+"') nick
	,(select paytype from tgg where noa='"+@tggno+"') paytype,(select trantype from tgg where noa='"+@tggno+"') trantype
	,(select tel from tgg where noa='"+@tggno+"') tel,(select fax from tgg where noa='"+@tggno+"') fax
	,(select cno from sss where noa='"+@sssno+"') cno,(select comp from sss where noa='"+@sssno+"') acomp
	,'"+@sssno+"' salesno,(select namea from sss where noa='"+@sssno+"') sales,(select namea from nhpe where noa='"+@sssno+"') worker
	,(select sum(isnull(a.smount,0)*isnull(b.inprice,0)) total from #tmp a left join ucc b on a.productno=b.noa where a.smount>0 and b.typea='"+@typea+"' and b.tggno=tggno)money,'5' taxtype
	,(select sum(isnull(a.smount,0)*isnull(b.inprice,0)) total from #tmp a left join ucc b on a.productno=b.noa where a.smount>0 and b.typea='"+@typea+"' and b.tggno=tggno)total
	,'"+@t_stkdate+"'+' 物料需求表("+@workgnos+") 轉來 'memo,0,1,'"+@workgnos+"'")
	
	--0315要在寫入原始請購量 ordbs.omount ，不給修改
	EXEC("insert into ordbs"+[1]+"(datea,noa,no3,productno,product,unit,mount,omount,price,total,tggno,enda,kind,memo,smount)
	select '"+@ordbdate+"','"+@ordbno+"'+ REPLACE('"+@t_stkdate+"','/','')+right(('000'+cast(cast('"+@ordbum+"' as int)+1 as nvarchar(10))),3) noa
	,right('000'+cast(ROW_NUMBER() OVER (ORDER BY a.productno DESC) as nvarchar(10)),3) no3
	,a.productno,a.products,b.unit
	,case when isnull(b.stdmount,0)>0 then ceiling(isnull(a.smount,0)/isnull(b.stdmount,0))*isnull(b.stdmount,0) else isnull(a.smount,0) end smount
	,case when isnull(b.stdmount,0)>0 then ceiling(isnull(a.smount,0)/isnull(b.stdmount,0))*isnull(b.stdmount,0) else isnull(a.smount,0) end smount
	,isnull((select top 1 ub.price from ucctgg ua left join ucctggs ub on ua.noa=ub.noa  where ua.tggno='"+@tggno+"' and ua.productno=a.productno and isnull(a.smount,0) >= ub.mount order by ub.mount desc),0) inprice
	,isnull(a.smount,0)*isnull((select top 1 ub.price from ucctgg ua left join ucctggs ub on ua.noa=ub.noa  where ua.tggno='"+@tggno+"' and ua.productno=a.productno and isnull(a.smount) >= ub.mount order by ub.mount desc),0) total
	,'"+@tggno+"',0, '2' kind
	,isnull((select ordcmemo+' ' from ucctgg where productno=a.productno and tggno='"+@tggno+"'),'')+isnull((select '廠商料號:'+productno2 from ucctgg where productno=a.productno and tggno='"+@tggno+"'),'')
	,cast(a.gdemand as nvarchar(30))+','+cast(a.stkmount as nvarchar(30))+','+cast(a.ordcmount as nvarchar(30))+','+cast(a.safemount as nvarchar(30))+','+cast(a.ndemand as nvarchar(30)) 
	+','+cast(isnull(a.smount,0) as nvarchar(30))+','+cast(isnull(a.sordb,0) as nvarchar(30))+','+cast(isnull(a.sordc,0) as nvarchar(30))+','+cast(isnull(a.src2,0) as nvarchar(30))+','+cast(isnull(a.sunrc2,0) as nvarchar(30))
	from #tmp a left join ucc b on a.productno=b.noa where isnull(a.smount,0)>0 and b.typea='"+@typea+"' and (case when isnull((select top 1 tggno from view_rc2s where productno=a.productno order by datea desc),'')='' then b.tggno else (select top 1 tggno from view_rc2s where productno=a.productno order by datea desc) end)='"+@tggno+"'")

	set @ordbnos=@ordbnos+@ordbno+ REPLACE(@t_stkdate,'/','')+right(('000'+cast(cast(@ordbum as int)+1 as nvarchar(10))),3)+','
	
	set @ordbum=right(('000'+cast(cast(@ordbum as int)+1 as nvarchar(10))),3)
	fetch next from cursor_table 
	into @typea,@tggno
	
end 
close cursor_table 
deallocate cursor_table 

if(len(@ordbnos)>0)
begin
	declare cursor_table cursor for 
	select accy,noa from view_workg where charindex(noa,@workgnos)>0 
	open cursor_table 
	fetch next from cursor_table 
	into @accy,@workgno
	while(@@FETCH_STATUS <> -1) 
	begin
		
		EXEC("update workg"+@accy+"
		set ordbno=left('"+@ordbnos+"',len('"+@ordbnos+"')-1)
		where noa='"+@workgno+"'")
			
		fetch next from cursor_table 
		into @accy,@workgno
	end 
	close cursor_table 
	deallocate cursor_table 
end
---虛擬end-------------------------------------------------------------------------------------------------------------------
IF OBJECT_ID('tempdb..#tmp')is not null
BEGIN
	set @cmd = 'drop table #tmp'
	EXECUTE sp_executesql @cmd
END
;
--****************************************************************************************************
z_workg2ordb3:--z_workg2ordb3
declare @t_bnoa nvarchar(100)
declare @t_enoa nvarchar(100)

set @t_bnoa = case when '#non' =  [4] then '' else  [4] end
set @t_enoa = case when '#non' =  [5] then char(255) else  [5] end

--*********************************************************************************************
declare @workgno nvarchar(100)

declare @tmp table(
	gno nvarchar(1),
	ordbno nvarchar(30),
	noq nvarchar(30),
	workgno nvarchar(MAX),
	productno nvarchar(30),
	products nvarchar(90),
	smount nvarchar(MAX),
	gdemand float,
	stkmount float,
	ordcmount float,
	safemount float,
	ndemand float,
	xsmount float,
	sordb float,
	sordc float,
	src2 float,
	sunrc2 float
)

declare cursor_table cursor for 
select noa from view_workg where noa between @t_bnoa and @t_enoa 
open cursor_table 
fetch next from cursor_table 
into @workgno
while(@@FETCH_STATUS <> -1) 
	begin
		if ((select count(*) from @tmp where charindex(@workgno,workgno)>0)=0)
		begin
			insert into @tmp (gno,ordbno,noq,workgno,productno,products,smount)
			select '0',b.noa,b.no3,a.workgno,b.productno,b.product,b.smount
			from view_ordb a left join view_ordbs b on a.noa=b.noa  where charindex(@workgno,a.workgno)>0 		
		 end
		fetch next from cursor_table 
		into @workgno
	end 
close cursor_table 
deallocate cursor_table 

update @tmp
set gdemand=dbo.split(smount,',',0)
,ordcmount=dbo.split(smount,',',1)
,stkmount=dbo.split(smount,',',2)
,safemount=dbo.split(smount,',',3)
,ndemand=dbo.split(smount,',',4)
,xsmount=dbo.split(smount,',',5)
,sordb=dbo.split(smount,',',6)
,sordc=dbo.split(smount,',',7)
,src2=dbo.split(smount,',',8)
,sunrc2=dbo.split(smount,',',9)

insert into @tmp (gno,workgno)
select '1'gno,workgno from @tmp group by workgno

select gno,productno,products,workgno,smount,ordbno,
reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,gdemand),1)),0,30)) gdemand,
reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,ordcmount),1)),0,30)) ordcmount,
reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,stkmount),1)),0,30)) stkmount,
reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,safemount),1)),0,30)) safemount,
reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,ndemand),1)),0,30)) ndemand,

reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,xsmount),1)),0,30)) xsmount,
reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,sordb),1)),0,30)) sordb,
reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,sordc),1)),0,30)) sordc,
reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,src2),1)),0,30)) src2,
reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,sunrc2),1)),0,30)) sunrc2
from @tmp order by workgno,gno,ordbno,noq
;