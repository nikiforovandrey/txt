z_workg2ordb1:--z_workg2ordb1
SET QUOTED_IDENTIFIER OFF
declare @t_bdate nvarchar(10)
declare @t_edate nvarchar(10)
declare @t_bnoa nvarchar(100)
declare @t_enoa nvarchar(100)
declare @t_workgall nvarchar(100)
declare @t_stkdate nvarchar(30)

set @t_bdate = case when '#non' =  [2] then '' else  [2] end
set @t_edate = case when '#non' =  [3] then char(255) else  [3] end
set @t_bnoa = case when '#non' =  [4] then '' else  [4] end
set @t_enoa = case when '#non' =  [5] then char(255) else  [5] end
set @t_workgall = case when '#non' =  [8] then '0' else  [8] end

set @t_stkdate=CONVERT (VARCHAR(7), GETDATE(),12 )+0890000
set @t_stkdate=left(@t_stkdate,3)+'/'+substring(@t_stkdate,4,2)+'/'+right(@t_stkdate,2)
--*********************************************************************************************
declare @cmd nvarchar(max) 
declare @tmp table(
	gno nvarchar(1),
	productno nvarchar(30),
	products nvarchar(90),
	gdemand float,
	stkmount float,
	ordcmount float,
	safemount float,
	ndemand float
)

if(@t_workgall='1')
begin
	insert into @tmp
	select '0',productno,(select product from ucc where noa=tmp.productno)products 
	,sum(gdemand)gdemand 
	,isnull((select sum(mount) from stkucc(@t_stkdate,'','') where productno=tmp.productno),0)stkmount
	,sum(ordcmount)ordcmount
	,isnull((select safemount from ucc where noa=tmp.productno),0) safemount
	,0 ndemand 
	from ( 
		--生產計劃毛需求
		select ws.productno,sum(ws.mount-ws.gmount) gdemand,0 ordcmount from view_work w left join view_works ws on w.noa=ws.noa 
		left join view_workg g on w.cuano=g.noa
		where ws.productno in (select noa from ucc where typea='4' or typea='5')  and w.enda!='1' and isnull(g.ordbno,'')=''
		group by ws.productno 
		union all 
		--採購未入
		select ocs.productno,0 gdemand,sum(ocs.mount)ordcmount from view_ordcs ocs 
		where ocs.enda!='1' and ocs.productno in (select noa from ucc where typea='4' or typea='5')  
		and charindex(ocs.ordbno,(select ','+ordbno from view_workg where isnull(ordbno,'')='' FOR XML PATH('')))>0
		group by ocs.productno 
	)tmp group by productno
end
else
begin
	insert into @tmp
	select '0',productno,(select product from ucc where noa=tmp.productno)products 
	,sum(gdemand)gdemand 
	,isnull((select sum(mount) from stkucc(@t_stkdate,'','') where productno=tmp.productno),0)stkmount
	,sum(ordcmount)ordcmount
	,isnull((select safemount from ucc where noa=tmp.productno),0) safemount
	,0 ndemand 
	from ( 
		--生產計劃毛需求
		select ws.productno,sum(ws.mount-ws.gmount) gdemand,0 ordcmount from view_work w left join view_works ws on w.noa=ws.noa 
		left join view_workg g on w.cuano=g.noa
		where ws.productno in (select noa from ucc where typea='4' or typea='5') and w.enda!='1' 
		and g.noa between @t_bnoa and @t_enoa and isnull(g.ordbno,'')=''
		group by ws.productno 
		union all 
		--採購未入
		select ocs.productno,0 gdemand,sum(ocs.mount)ordcmount from view_ordcs ocs 
		where ocs.enda!='1' and ocs.productno in (select noa from ucc where typea='4' or typea='5')  
		and charindex(ocs.ordbno,(select ','+ordbno from view_workg where noa between @t_bnoa and @t_enoa and isnull(ordbno,'')='' FOR XML PATH('')))>0
		group by ocs.productno 
	)tmp group by productno
end

update @tmp set ndemand = (gdemand-ordcmount-stkmount+safemount) 
update @tmp set ndemand=0 where ndemand<0

select gno,productno,products,
reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,gdemand),1)),0,30)) gdemand,
reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,ordcmount),1)),0,30)) ordcmount,
reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,stkmount),1)),0,30)) stkmount,
reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,safemount),1)),0,30)) safemount,
reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,ndemand),1)),0,30)) ndemand
from @tmp
;
----**************************************************************************************
z_workg2ordb2:--z_workg2ordb2
SET QUOTED_IDENTIFIER OFF
declare @t_bdate nvarchar(10)
declare @t_edate nvarchar(10)
declare @t_bnoa nvarchar(100)
declare @t_enoa nvarchar(100)
declare @t_workgall nvarchar(100)
declare @t_stkdate nvarchar(30)

set @t_bdate = case when '#non' =  [2] then '' else  [2] end
set @t_edate = case when '#non' =  [3] then char(255) else  [3] end
set @t_bnoa = case when '#non' =  [4] then '' else  [4] end
set @t_enoa = case when '#non' =  [5] then char(255) else  [5] end
set @t_workgall = case when '#non' =  [8] then '0' else  [8] end

set @t_stkdate=CONVERT (VARCHAR(7), GETDATE(),12 )+0890000
set @t_stkdate=left(@t_stkdate,3)+'/'+substring(@t_stkdate,4,2)+'/'+right(@t_stkdate,2)
--*********************************************************************************************
declare @cmd nvarchar(max) 
IF OBJECT_ID('tempdb..#tmp')is not null
BEGIN
	set @cmd = 'drop table #tmp'
	EXECUTE sp_executesql @cmd
END

create table #tmp(
	gno nvarchar(1),
	productno nvarchar(30),
	products nvarchar(90),
	gdemand float,
	stkmount float,
	ordcmount float,
	safemount float,
	ndemand float
)

if(@t_workgall='1')
begin
	insert into #tmp
	select '0',productno,(select product from ucc where noa=tmp.productno)products 
	,sum(gdemand)gdemand 
	,isnull((select sum(mount) from stkucc(@t_stkdate,'','') where productno=tmp.productno),0)stkmount
	,sum(ordcmount)ordcmount
	,isnull((select safemount from ucc where noa=tmp.productno),0) safemount
	,0 ndemand 
	from ( 
		--生產計劃毛需求
		select ws.productno,sum(ws.mount-ws.gmount) gdemand,0 ordcmount from view_work w left join view_works ws on w.noa=ws.noa 
		left join view_workg g on w.cuano=g.noa
		where ws.productno in (select noa from ucc where typea='4' or typea='5')  and w.enda!='1' and isnull(g.ordbno,'')=''
		group by ws.productno 
		union all 
		--採購未入
		select ocs.productno,0 gdemand,sum(ocs.mount)ordcmount from view_ordcs ocs 
		where ocs.enda!='1' and ocs.productno in (select noa from ucc where typea='4' or typea='5')  
		and charindex(ocs.ordbno,(select ','+ordbno from view_workg where isnull(ordbno,'')='' FOR XML PATH('')))>0
		group by ocs.productno 
	)tmp group by productno
end
else
begin
	insert into #tmp
	select '0',productno,(select product from ucc where noa=tmp.productno)products 
	,sum(gdemand)gdemand 
	,isnull((select sum(mount) from stkucc(@t_stkdate,'','') where productno=tmp.productno),0)stkmount
	,sum(ordcmount)ordcmount
	,isnull((select safemount from ucc where noa=tmp.productno),0) safemount
	,0 ndemand 
	from ( 
		--生產計劃毛需求
		select ws.productno,sum(ws.mount-ws.gmount) gdemand,0 ordcmount from view_work w left join view_works ws on w.noa=ws.noa 
		left join view_workg g on w.cuano=g.noa
		where ws.productno in (select noa from ucc where typea='4' or typea='5') and w.enda!='1' 
		and g.noa between @t_bnoa and @t_enoa and isnull(g.ordbno,'')=''
		group by ws.productno 
		union all 
		--採購未入
		select ocs.productno,0 gdemand,sum(ocs.mount)ordcmount from view_ordcs ocs 
		where ocs.enda!='1' and ocs.productno in (select noa from ucc where typea='4' or typea='5')
		and charindex(ocs.ordbno,(select ','+ordbno from view_workg where noa between @t_bnoa and @t_enoa and isnull(ordbno,'')='' FOR XML PATH('')))>0
		group by ocs.productno 
	)tmp group by productno
end

update #tmp set ndemand = (gdemand-ordcmount-stkmount+safemount) 
update #tmp set ndemand=0 where ndemand<0

select gno,productno,products,
reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,gdemand),1)),0,30)) gdemand,
reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,ordcmount),1)),0,30)) ordcmount,
reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,stkmount),1)),0,30)) stkmount,
reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,safemount),1)),0,30)) safemount,
reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,ndemand),1)),0,30)) ndemand
from #tmp


--*************************************************************************************
--寫入請購單
declare @sssno nvarchar(max)=[9] --採購員編號
declare @ordbno nvarchar(max)=[10] --目前請購代號
declare @ordbum nvarchar(max) --目前請購序號
declare @typea nvarchar(max) 
declare @tggno nvarchar(max) 
declare @ordbdate nvarchar(10) 
declare @ordbnos nvarchar(MAX) --全部請購單編號
--要寫入的workg單號
declare @workgnos nvarchar(MAX)=(SELECT STUFF((select ','+noa from view_workg where noa between @t_bnoa and @t_enoa and isnull(ordbno,'')='' FOR XML PATH('')),1,1,''))

set @ordbnos=''

set @cmd="select @ordbum= isnull(right((select top 1 noa from view_ordb where CHARINDEX('"+@ordbno+"'+ REPLACE('"+@t_stkdate+"','/',''),noa)>0 order by noa desc),3),'0')"
EXEC SP_EXECUTESQL @cmd, N'@ordbum nvarchar(max) OUTPUT', @ordbum OUTPUT

--採購有效日
set @ordbdate=CONVERT (VARCHAR(7), GETDATE()+3,12 )+0890000
set @ordbdate=left(@ordbdate,3)+'/'+substring(@ordbdate,4,2)+'/'+right(@ordbdate,2)

--產生請購單
declare cursor_table cursor for 
select typea,tggno from( 
select b.typea
,case when isnull((select top 1 tggno from view_rc2s where productno=a.productno order by datea desc),'')=''
then b.tggno else (select top 1 tggno from view_rc2s where productno=a.productno order by datea desc) end tggno 
from #tmp a left join ucc b on a.productno=b.noa where a.ndemand>0
) tmp group by typea,tggno

open cursor_table 
fetch next from cursor_table 
into @typea,@tggno
while(@@FETCH_STATUS <> -1) 
begin

	EXEC("insert into ordb"+[1]+" (datea,odate,noa,kind,tggno,tgg,nick,paytype,trantype,tel,fax,cno,acomp,salesno,sales,worker,money,taxtype,total,memo,enda)
	select '"+@ordbdate+"','"+@t_stkdate+"','"+@ordbno+"'+ REPLACE('"+@t_stkdate+"','/','')+right(('000'+cast(cast('"+@ordbum+"' as int)+1 as nvarchar(10))),3) noa
	,case when '"+@typea+"'='4' then '1' else '2' end kind,'"+@tggno+"' tggno,(select comp from tgg where noa='"+@tggno+"') tgg,(select nick from tgg where noa='"+@tggno+"') nick
	,(select paytype from tgg where noa='"+@tggno+"') paytype,(select trantype from tgg where noa='"+@tggno+"') trantype
	,(select tel from tgg where noa='"+@tggno+"') tel,(select fax from tgg where noa='"+@tggno+"') fax
	,(select cno from sss where noa='"+@sssno+"') cno,(select comp from sss where noa='"+@sssno+"') acomp
	,'"+@sssno+"' salesno,(select namea from sss where noa='"+@sssno+"') sales,(select namea from nhpe where noa='"+@sssno+"') worker
	,(select sum(isnull(a.ndemand,0)*isnull(b.inprice,0)) total from #tmp a left join ucc b on a.productno=b.noa where a.ndemand>0 and b.typea='"+@typea+"' and b.tggno=tggno)money,'5' taxtype
	,(select sum(isnull(a.ndemand,0)*isnull(b.inprice,0)) total from #tmp a left join ucc b on a.productno=b.noa where a.ndemand>0 and b.typea='"+@typea+"' and b.tggno=tggno)total
	,'"+@t_stkdate+"'+' 物料需求表("+@workgnos+") 轉來 'memo,0")

	EXEC("insert into ordbs"+[1]+"(datea,noa,no3,productno,product,unit,mount,price,total,tggno,enda,kind,memo)
	select '"+@ordbdate+"','"+@ordbno+"'+ REPLACE('"+@t_stkdate+"','/','')+right(('000'+cast(cast('"+@ordbum+"' as int)+1 as nvarchar(10))),3) noa
	,right('000'+cast(ROW_NUMBER() OVER (ORDER BY a.productno DESC) as nvarchar(10)),3) no3
	,a.productno,a.products,b.unit,isnull(a.ndemand,0)ndemand
	,isnull((select top 1 ub.price from ucctgg ua left join ucctggs ub on ua.noa=ub.noa  where ua.tggno='"+@tggno+"' and ua.productno=a.productno and a.ndemand >= ub.mount order by ub.mount desc),0) inprice
	,isnull(a.ndemand,0)*isnull((select top 1 ub.price from ucctgg ua left join ucctggs ub on ua.noa=ub.noa  where ua.tggno='"+@tggno+"' and ua.productno=a.productno and a.ndemand >= ub.mount order by ub.mount desc),0) total
	,'"+@tggno+"',0,case when '"+@typea+"'='4' then '1' else '2' end kind
	,isnull((select ordcmemo+' ' from ucctgg where productno=a.productno and tggno='"+@tggno+"'),'')+isnull((select '廠商料號:'+productno2 from ucctgg where productno=a.productno and tggno='"+@tggno+"'),'')
	from #tmp a left join ucc b on a.productno=b.noa where a.ndemand>0 and b.typea='"+@typea+"' and (case when isnull((select top 1 tggno from view_rc2s where productno=a.productno order by datea desc),'')='' then b.tggno else (select top 1 tggno from view_rc2s where productno=a.productno order by datea desc) end)='"+@tggno+"'")

	set @ordbnos=@ordbnos+@ordbno+ REPLACE(@t_stkdate,'/','')+right(('000'+cast(cast(@ordbum as int)+1 as nvarchar(10))),3)+','
	
	set @ordbum=right(('000'+cast(cast(@ordbum as int)+1 as nvarchar(10))),3)
	fetch next from cursor_table 
	into @typea,@tggno
	
end 
close cursor_table 
deallocate cursor_table 

declare @accy nvarchar(MAX)
declare @workgno nvarchar(MAX)

if(len(@ordbnos)>0)
begin
	declare cursor_table cursor for 
	select accy,noa from view_workg where charindex(noa,@workgnos)>0 
	open cursor_table 
	fetch next from cursor_table 
	into @accy,@workgno
	while(@@FETCH_STATUS <> -1) 
	begin
		
		EXEC("update workg"+@accy+"
		set ordbno=left('"+@ordbnos+"',len('"+@ordbnos+"')-1)
		where noa='"+@workgno+"'")
			
		fetch next from cursor_table 
		into @accy,@workgno
	end 
	close cursor_table 
	deallocate cursor_table 
end


IF OBJECT_ID('tempdb..#tmp')is not null
BEGIN
	set @cmd = 'drop table #tmp'
	EXECUTE sp_executesql @cmd
END
;
