ucachg:--ucachg
SET QUOTED_IDENTIFIER OFF
declare @t_accy nvarchar(10)
declare @t_ucachgNoa nvarchar(30)
declare @t_worker nvarchar(30)
set @t_accy = [1]
set @t_ucachgNoa = [2]
set @t_worker = [3]
declare @UcachgTmp table(
	productno nvarchar(30),
	spec nvarchar(40),
	typea nvarchar(15),
	orgproductno nvarchar(30),
	orgproduct nvarchar(90),
	orgprocessno nvarchar(30),
	orgprocess nvarchar(90),
	newproductno nvarchar(30),
	newproduct nvarchar(90),
	newunit nvarchar(12),
	newmount float,
	newweight float,
	newmtype nvarchar(15),
	newprocessno nvarchar(30),
	newprocess nvarchar(90),
	newloss float,
	newmemo nvarchar(max),
	ucanoq nvarchar(3)
)
insert into @UcachgTmp
	select
		a.productno,a.spec,a.typea,b.orgproductno,b.orgproduct,b.orgprocessno,
		b.orgprocess,b.productno,b.product,b.unit,b.mount,b.weight,
		b.mtype,b.processno,b.process,b.loss,b.memo,b.ucanoq
	from ucachg a
	left join ucachgs b on a.noa = b.noa
	where a.noa = @t_ucachgNoa
	order by a.productno
declare @productno nvarchar(30)
declare @spec nvarchar(40)
declare @typea nvarchar(15)
declare @orgproductno nvarchar(30)
declare @orgproduct nvarchar(90)
declare @orgprocessno nvarchar(30)
declare @orgprocess nvarchar(90)
declare @newproductno nvarchar(30)
declare @newproduct nvarchar(90)
declare @newunit nvarchar(12)
declare @newmount float
declare @newweight float
declare @newmtype nvarchar(15)
declare @newprocessno nvarchar(30)
declare @newprocess nvarchar(90)
declare @newloss float
declare @newmemo nvarchar(max)
declare @ucanoq nvarchar(3)
declare @newNoq nvarchar(3)
declare cursor_table cursor for
	select * from @UcachgTmp
open cursor_table
fetch next from cursor_table
into @productno,@spec,@typea,@orgproductno,@orgproduct,@orgprocessno,
	  @orgprocess,@newproductno,@newproduct,@newunit,@newmount,@newweight,
	  @newmtype,@newprocessno,@newprocess,@newloss,@newmemo,@ucanoq
while(@@FETCH_STATUS <> -1)
begin
	select @newNoq = RIGHT(REPLICATE('0', 3) + CAST(isnull(max(noq),0)+1 as NVARCHAR), 3) from ucaorgs where noa = @t_ucachgNoa
	insert into ucaorgs(noa,noq,ucaproductno,ucaspec,ucatypea,ucanoq,productno,
								product,unit,mount,weight,mtype,processno,process,loss,memo)
			select @t_ucachgNoa,@newNoq,a.noa,a.spec,a.typea,b.noq,b.productno,b.product,
			b.unit,b.mount,b.weight,b.mtype,b.processno,b.process,b.loss,b.memo
			from uca a
			left join ucas b on a.noa = b.noa
			where (a.noa = @productno) and (b.noq = @ucanoq)
	update ucas set productno=@newproductno,product=@newproduct,unit=@newunit,mount=@newmount,
						  weight=@newweight,mtype=@newmtype,processno=@newprocessno,process=@newprocess,
						  loss=@newloss,memo=@newmemo where (noa = @productno) and (noq = @ucanoq) and (productno = @orgproductno)
	update uca set worker2 = @t_worker where (noa = @productno)
	fetch next from cursor_table
	into @productno,@spec,@typea,@orgproductno,@orgproduct,@orgprocessno,
		  @orgprocess,@newproductno,@newproduct,@newunit,@newmount,@newweight,
		  @newmtype,@newprocessno,@newprocess,@newloss,@newmemo,@ucanoq
end
close cursor_table
deallocate cursor_table
-------------------------------------------------------------------;
ucachgb:--ucachgb
SET QUOTED_IDENTIFIER OFF
declare @t_accy nvarchar(10)
declare @t_ucachgNoa nvarchar(30)
declare @t_worker nvarchar(30)
set @t_accy = [1]
set @t_ucachgNoa = [2]
set @t_worker = [3]
declare @UcachgTmp table(
	productno nvarchar(30),
	typea nvarchar(15),
	orgproductno nvarchar(30),
	orgproduct nvarchar(90),
	orgprocessno nvarchar(30),
	orgprocess nvarchar(90),
	newproductno nvarchar(30),
	newproduct nvarchar(90),
	newunit nvarchar(12),
	newmount float,
	newweight float,
	newmtype nvarchar(15),
	newprocessno nvarchar(30),
	newprocess nvarchar(90),
	newloss float,
	newmemo nvarchar(max)
)
insert into @UcachgTmp
	select
		a.productno,a.typea,b.orgproductno,b.orgproduct,b.orgprocessno,
		b.orgprocess,b.productno,b.product,b.unit,b.mount,b.weight,
		b.mtype,b.processno,b.process,b.loss,b.memo
	from ucachg a
	left join ucachgs b on a.noa = b.noa
	where a.noa = @t_ucachgNoa
	order by a.productno
declare @productno nvarchar(30)
declare @typea nvarchar(15)
declare @orgproductno nvarchar(30)
declare @orgproduct nvarchar(90)
declare @orgprocessno nvarchar(30)
declare @orgprocess nvarchar(90)
declare @newproductno nvarchar(30)
declare @newproduct nvarchar(90)
declare @newunit nvarchar(12)
declare @newmount float
declare @newweight float
declare @newmtype nvarchar(15)
declare @newprocessno nvarchar(30)
declare @newprocess nvarchar(90)
declare @newloss float
declare @newmemo nvarchar(max)
declare @newNoq nvarchar(3)
declare @w_noa nvarchar(30)
declare @w_noq nvarchar(3)
declare cursor_table cursor for
	select * from @UcachgTmp
open cursor_table
fetch next from cursor_table
into @productno,@typea,@orgproductno,@orgproduct,@orgprocessno,
	  @orgprocess,@newproductno,@newproduct,@newunit,@newmount,@newweight,
	  @newmtype,@newprocessno,@newprocess,@newloss,@newmemo
while(@@FETCH_STATUS <> -1)
begin
	declare cursor_table2 cursor for
		select a.noa,b.noq
			from uca a
			left join ucas b on a.noa = b.noa
			where ((len(@productno) > 0 and a.noa = @productno) or (len(@productno) = 0)) and a.typea = @typea and b.productno = @orgproductno
	open cursor_table2
	fetch next from cursor_table2
	into @w_noa,@w_noq
	while(@@FETCH_STATUS <> -1)
	begin
		select @newNoq = RIGHT(REPLICATE('0', 3) + CAST(isnull(max(noq),0)+1 as NVARCHAR), 3) from ucaorgs where noa = @t_ucachgNoa
		insert into ucaorgs(noa,noq,ucaproductno,ucaspec,ucatypea,ucanoq,productno,
									product,unit,mount,weight,mtype,processno,process,loss,memo)
				select @t_ucachgNoa,@newNoq,a.noa,a.spec,a.typea,b.noq,b.productno,b.product,
				b.unit,b.mount,b.weight,b.mtype,b.processno,b.process,b.loss,b.memo
				from uca a
				left join ucas b on a.noa = b.noa
				where (a.noa = @w_noa) and (b.noq = @w_noq)
		update ucas set productno=@newproductno,product=@newproduct,unit=@newunit,mount=@newmount,
						  weight=@newweight,mtype=@newmtype,processno=@newprocessno,process=@newprocess,
						  loss=@newloss,memo=@newmemo where (noa = @w_noa) and (noq = @w_noq)
		update uca set worker2 = @t_worker where noa = @w_noa
		fetch next from cursor_table2
		into @w_noa,@w_noq
	end
	close cursor_table2
	deallocate cursor_table2
	fetch next from cursor_table
	into @productno,@typea,@orgproductno,@orgproduct,@orgprocessno,
		  @orgprocess,@newproductno,@newproduct,@newunit,@newmount,@newweight,
		  @newmtype,@newprocessno,@newprocess,@newloss,@newmemo
end
close cursor_table
deallocate cursor_table
-------------------------------------------------------------------;