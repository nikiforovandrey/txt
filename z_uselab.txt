z_uselab1:--z_uselab1
declare @t_bcustno nvarchar(35)
declare @t_ecustno nvarchar(35)
set @t_bcustno = case when '#non'= [2] then '' else  [2] end
set @t_ecustno = case when '#non'= [3] then char(255) else [3] end
select 
	'0' gno,a.noa,a.comp,
	SUBSTRING(a.zip_home,1,1) z1,
	SUBSTRING(a.zip_home,2,1) z2,
	SUBSTRING(a.zip_home,3,1) z3,
	SUBSTRING(a.zip_home,4,1) z4,
	SUBSTRING(a.zip_home,5,1) z5,
	a.addr_home addr
from cust a where (a.noa between @t_bcustno and @t_ecustno) order by noa;
---------********************************************************-----------
z_uselab2:--z_uselab2
declare @t_bsmon nvarchar(10)
declare @t_esmon nvarchar(10)
set @t_bsmon = case when '#non' = [3] then '' else [3] end
set @t_esmon = case when '#non' = [4] then '' else [4] end
declare @tmp table( 
	gno nvarchar(1), 
	custno nvarchar(20), 
	comp nvarchar(max),
	addr nvarchar(max),
	zipcode nvarchar(15), 
	money float, 
	total float, 
	payed float, 
	popay float,
	opay float,
	unopay float
) 

insert into @tmp
select '0'gno,a.noa,a.comp,a.addr_home,a.zip_home
	--前期
	--trd
	,isnull((select SUM(unpay) from view_trd102 where custno=a.noa and (case when len(mon)=0 then left(datea,6) else mon end) < @t_bsmon),0)
	--vcc
	+isnull((select SUM(unpay) from view_vcc102 where (case when custno2!='' then custno2 else custno end)=a.noa and (case when len(mon)=0 then left(datea,6) else mon end) < @t_bsmon and (left(kind,4)!='健勞勞退')),0)
	-isnull((select sum(paysale) from umms where len(vccno)>8 and right(vccno,6)<@t_bsmon and left(vccno,len(vccno)-7)=a.noa),0)
	--cara
	+isnull((select outmoney-inmoney from cara ca left join caras cb on ca.noa=cb.noa where ca.carownerno=a.noa and ca.mon=@t_bsmon and cb.caritemno='001'),0)
	money
	--本期
	--trd
	,isnull((select SUM(total) from view_trd102 where custno=a.noa and (case when len(mon)=0 then left(datea,6) else mon end) between @t_bsmon and @t_esmon),0)
	--vcc
	+isnull((select SUM(total) from view_vcc102 where (case when custno2!='' then custno2 else custno end)=a.noa and (case when len(mon)=0 then left(datea,6) else mon end) between @t_bsmon and @t_esmon and (left(kind,4)!='健勞勞退')),0)
	--cara
	+isnull((select outmoney from cara ca left join caras cb on ca.noa=cb.noa where ca.carownerno=a.noa and ca.mon between @t_bsmon and @t_esmon and cb.caritemno!='001'),0)
	total
	--trd
	,isnull((select SUM(payed) from view_trd102 where custno=a.noa and (case when len(mon)=0 then left(datea,6) else mon end) between @t_bsmon and @t_esmon),0)
	--vcc
	+isnull((select SUM(payed) from view_vcc102 where (case when custno2!='' then custno2 else custno end)=a.noa and (case when len(mon)=0 then left(datea,6) else mon end) between @t_bsmon and @t_esmon and (left(kind,4)!='健勞勞退')),0)
	+isnull((select sum(paysale) from umms where len(vccno)>8 and right(vccno,6) between @t_bsmon and @t_esmon and left(vccno,len(vccno)-7)=a.noa),0)
	--cara
	+isnull((select inmoney from cara ca left join caras cb on ca.noa=cb.noa where ca.carownerno=a.noa and ca.mon between @t_bsmon and @t_esmon and cb.caritemno!='001'),0)
	payed
	--前期預收
	,isnull((select SUM(opay-unopay) from umm where custno=a.noa and (case when len(mon)=0 then left(datea,6) else mon end) < @t_bsmon),0) popay
	--本期預收
	,isnull((select SUM(opay)  from umm where custno=a.noa and (case when len(mon)=0 then left(datea,6) else mon end) between @t_bsmon and @t_esmon),0) opay
	--本期預收沖帳
	,isnull((select SUM(unopay)  from umm where custno=a.noa and (case when len(mon)=0 then left(datea,6) else mon end) between @t_bsmon and @t_esmon),0) unopay
from (select noa,comp,addr_home,zip_home from cust union all select noa,namea,addr_home,zip_home from carOwner)a
delete @tmp where money=0 and total=0 and payed=0
select 
	'0' gno,a.custno,a.comp,
	SUBSTRING(a.zipcode,1,1) z1,
	SUBSTRING(a.zipcode,2,1) z2,
	SUBSTRING(a.zipcode,3,1) z3,
	SUBSTRING(a.zipcode,4,1) z4,
	SUBSTRING(a.zipcode,5,1) z5,
	a.addr
from @tmp a where isnull((money+total-payed),0) > 0;
