z_workcp1:--z_workcp1
declare @t_noa nvarchar(50)
declare @t_bdate nvarchar(20)
declare @t_edate nvarchar(20)
declare @t_btggno nvarchar(20)
declare @t_etggno nvarchar(20)
declare @t_merger nvarchar(30)

set @t_noa = case when '#non' = [2] then '' else [2] end
set @t_bdate = case when '#non' = [3] then '' else [3] end
set @t_edate = case when '#non' = [4] then CHAR(255) else [4] end
set @t_btggno = case when '#non' = [5] then '' else [5] end
set @t_etggno = case when '#non' = [6] then CHAR(255) else [6] end
set @t_merger = case when '#non' = [7] then '' else [7] end

--declare @tmp table(
--	gno nvarchar(1),
--	bnoa nvarchar(30),
--	btggno nvarchar(30),
--	btggs nvarchar(90),
--	bstoreno nvarchar(30),
--	bstores nvarchar(90),
--	bproductno nvarchar(30),
--	bproducts nvarchar(90),
--	aproductno nvarchar(30),
--	aproducts nvarchar(90),
--	amount float,
--	aunit nvarchar(12),
--	amemo nvarchar(max)
--)
--insert into @tmp
--	select
--		'0',b.noa,b.tggno,b.tgg,b.storeno,b.store,b.productno,b.product,a.productno,a.product,a.mount,a.unit,a.memo
--	from workcs[1] a
--	left join workc[1] b on a.noa = b.noa
--	where b.tggno between @t_btggno and @t_etggno
--	order by b.noa,b.productno
--insert into @tmp(gno,bnoa)
--	select '1',bnoa from @tmp group by bnoa
--select * from @tmp order by bnoa,gno,btggno
--*******************************************************************************
declare @tmp table( 
	gno nvarchar(1), 
	noa nvarchar(30),
	workno nvarchar(30),
	tggno nvarchar(30), 
	tggs nvarchar(90), 
	storeno nvarchar(30), 
	stores nvarchar(90), 
	productno nvarchar(30), 
	products nvarchar(90), 
	mount float, 
	unit nvarchar(12),
	memo nvarchar(max) 
) 

if(len(@t_merger)=0) 
begin 
	insert into @tmp 
	select'2',a.noa,a.workno,b.tggno,b.tgg,b.storeno,b.store,a.productno,a.product,a.mount,a.unit,a.memo 
	from view_workcs[1] a left join view_workc[1] b on a.noa = b.noa 
	where (len(@t_noa)=0 or a.noa=@t_noa) and 
	a.datea between @t_bdate and @t_edate and
	b.tggno between @t_btggno and @t_etggno 
	order by a.noa,a.productno 
	
	insert into @tmp(gno,tggno,storeno) 
	select '1',tggno,storeno
	from @tmp a group by tggno,storeno 
end 
else
begin 
	insert into @tmp (gno,tggno,storeno,productno,products,mount,unit) 
	select '4',b.tggno,b.storeno,a.productno,a.product,sum(a.mount),a.unit
	from view_workcs[1] a left join view_workc[1] b on a.noa = b.noa 
	where (len(@t_noa)=0 or a.noa=@t_noa) and 
	a.datea between @t_bdate and @t_edate and 
	b.tggno between @t_btggno and @t_etggno 
	group by b.tggno,b.storeno,a.productno,a.product,a.unit
	
	insert into @tmp(gno,tggno,storeno)
	select '3',tggno,storeno
	from @tmp a group by tggno,storeno 
end 

insert into @tmp(gno,tggno,tggs,storeno,stores) 
	select '0',tggno,(select nick from tgg where noa=a.tggno)
	,storeno ,(select top 1 store from store where noa=a.storeno)
	from @tmp a group by tggno,storeno 
	
insert into @tmp(gno,tggno,storeno) 
	select '5',tggno,storeno
	from @tmp a group by tggno,storeno 

select * from @tmp order by tggno,storeno,gno;



--******************************************************************************************************
z_workcp2:--z_workcp2
declare @t_noa nvarchar(50)
declare @t_bdate nvarchar(20)
declare @t_edate nvarchar(20)
declare @t_btggno nvarchar(20)
declare @t_etggno nvarchar(20)

set @t_noa = case when '#non' = [2] then '' else [2] end
set @t_bdate = case when '#non' = [3] then '' else [3] end
set @t_edate = case when '#non' = [4] then CHAR(255) else [4] end
set @t_btggno = case when '#non' = [5] then '' else [5] end
set @t_etggno = case when '#non' = [6] then CHAR(255) else [6] end

--declare @tmp table(
--	gno nvarchar(1),
--	tggno nvarchar(30),
--	tggs nvarchar(90),
--	addrs_comp nvarchar(max),
--	addrs_fact nvarchar(max),
--	addrs_invo nvarchar(max),
--	tel nvarchar(50),
--	fax nvarchar(50),
--	process nvarchar(30),
--	bproductno nvarchar(30),
--	bproducts nvarchar(90),
--	bcuadate nvarchar(10),
--	buindate nvarchar(10),
--	bmount float,
--	bunit nvarchar(12),
--	bprice float,
--	btotal float,
--	anoq nvarchar(3),
--	aproductno nvarchar(30),
--	aproducts nvarchar(90),
--	acuadate nvarchar(10),
--	amount float,
--	aunit nvarchar(12)
--)
--insert into @tmp
--select
--	'0',b.tggno,d.comp,d.addr_comp,d.addr_fact,d.addr_invo,d.tel,d.fax,
--	b.process,b.productno,b.product,c.cuadate,c.uindate,
--	c.mount,c.unit,c.price,(isnull(c.mount,0)*isnull(c.price,0)) total,
--	a.noq,a.productno,a.product,b.cuadate,a.mount,a.unit
--from workcs[1] a
--left join workc[1] b on a.noa = b.noa
--left join work[1] c on b.workno = c.noa
--left join tgg d on b.tggno = d.noa
--select * from @tmp

declare @tmp table( 
gno nvarchar(1), 
tggno nvarchar(30), 
tggs nvarchar(90), 
addrs_comp nvarchar(max), 
addrs_fact nvarchar(max), 
addrs_invo nvarchar(max), 
tel nvarchar(50), 
fax nvarchar(50), 
procesno nvarchar(30), 
process nvarchar(30), 
bproductno nvarchar(30), 
bproducts nvarchar(90), 
bcuadate nvarchar(10), 
buindate nvarchar(10), 
bmount float, 
bunit nvarchar(12), 
bprice float, 
btotal float, 
aworkno nvarchar(60), 
aproductno nvarchar(30), 
aproducts nvarchar(90), 
acuadate nvarchar(10), 
amount float, 
aunit nvarchar(12) 
) 
insert into @tmp (gno,tggno,tggs,addrs_comp,addrs_fact,addrs_invo,tel,fax,aworkno) 
select '0',wc.tggno,tgg.comp,tgg.addr_comp,tgg.addr_fact,tgg.addr_invo,tgg.tel,tgg.fax,''
from view_workcs102 wc left join view_work102 wa on wc.workno=wa.noa 
left join tgg on wc.tggno=tgg.noa 
where (len(@t_noa)=0 or wc.noa=@t_noa) and wc.datea between @t_bdate and @t_edate and wc.tggno between @t_btggno and @t_etggno 
group by wc.tggno,tgg.comp,tgg.addr_comp,tgg.addr_fact,tgg.addr_invo,tgg.tel,tgg.fax 

insert into @tmp 
select '1',wc.tggno,'','','','','','', 
wa.processno,wa.process,wa.productno,wa.product,wa.cuadate,wa.uindate,wa.mount,wa.unit,wa.price,wa.mount*wa.price total 
,wc.workno,'','','','','' 
from view_workcs102 wc left join view_work102 wa on wc.workno=wa.noa 
left join tgg on wc.tggno=tgg.noa 
where (len(@t_noa)=0 or wc.noa=@t_noa) and wc.datea between @t_bdate and @t_edate and wc.tggno between @t_btggno and @t_etggno 
group by wc.tggno,wa.processno,wa.process,wa.productno,wa.product,wa.cuadate,wa.uindate,wa.mount,wa.unit,wa.price 
,wc.workno
insert into @tmp 
select '2',wc.tggno,tgg.comp,tgg.addr_comp,tgg.addr_fact,tgg.addr_invo,tgg.tel,tgg.fax, 
wa.processno,wa.process,wa.productno,wa.product,wa.cuadate,wa.uindate,wa.mount,wa.unit,wa.price,wa.mount*wa.price total 
,wc.workno,wc.productno,wc.product,wc.datea,wc.mount,wc.unit 
from view_workcs102 wc left join view_work102 wa on wc.workno=wa.noa 
left join tgg on wc.tggno=tgg.noa 
where (len(@t_noa)=0 or wc.noa=@t_noa) and wc.datea between @t_bdate and @t_edate and wc.tggno between @t_btggno and @t_etggno 

insert into @tmp (gno,tggno,aworkno) 
select '3',wc.tggno,'ZZZZZZZZZ'
from view_workcs102 wc left join view_work102 wa on wc.workno=wa.noa 
left join tgg on wc.tggno=tgg.noa 
where (len(@t_noa)=0 or wc.noa=@t_noa) and wc.datea between @t_bdate and @t_edate and wc.tggno between @t_btggno and @t_etggno 
group by wc.tggno 

select * from @tmp order by tggno,aworkno,gno,procesno,process;