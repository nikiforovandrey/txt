z_ordbp1:--z_ordbp1
declare @t_bnoa nvarchar(20)
declare @t_enoa nvarchar(20)
declare @t_pageline int = 15   --------一頁幾行
set @t_bnoa = case when '#non' = [2] then '' else [2] end
set @t_enoa = case when '#non' = [3] then CHAR(255) else [3] end
declare @tmp table(
		gno nvarchar(1),
		idno int identity(0,1),
		orderno int,
		pageno int,
		noa nvarchar(30),
		noq nvarchar(20),
		odate nvarchar(10),
		tno nvarchar(20),
		tgg nvarchar(50),
		tel nvarchar(20),
		fax nvarchar(20),
		addr nvarchar(60),
		kind nvarchar(20),
		trantype nvarchar(20),
		paytype nvarchar(20),
		datea nvarchar(10),
		uno nvarchar(20),
		pno nvarchar(20),
		product nvarchar(50),
		spec nvarchar(20),
		size nvarchar(50),
		mount float,
		weightb float,
		price float,
		total float,
		ordeno nvarchar(20),
		tmemo nvarchar(200),
		moneys float,
		tax float,
		ttotal float,
		tmount nvarchar(200),
		memo nvarchar(200)
)
insert into @tmp
select '0' gno,
	ROW_NUMBER()over(partition by a.noa order by a.noa),1,
	a.noa,b.no3,a.odate,a.tggno,a.tgg,a.tel,a.fax,a.addr,
	a.kind,a.trantype,
	a.paytype,a.datea,b.uno,b.productno,b.product,b.spec,
	(case when b.radius<=0 then CAST(b.dime AS nvarchar)+'x'+CAST(b.width AS nvarchar)+'x'+CAST(b.lengthb AS nvarchar) else CAST(b.dime AS nvarchar)+'x'+CAST(b.width AS nvarchar)+'x'+CAST(b.lengthb AS nvarchar)+'x'+CAST(b.radius AS nvarchar) end) size,
	b.mount,b.weight,b.price,b.total,b.ordeno,b.memo,a.money,a.tax,a.total,0,a.memo
from view_ordb[1] a
left join view_ordbs[1] b on a.noa = b.noa
where a.noa between @t_bnoa and @t_enoa
declare @noa nvarchar(20)
declare @count int
declare @idno int
declare @k int = 0 ----差幾頁
declare @pageCount int
declare @orderno int
declare @pageno int

declare cursor_table cursor for
	select noa,count(*),max(orderno) from @tmp group by noa
open cursor_table
fetch next from cursor_table
into @noa,@count,@orderno
while(@@FETCH_STATUS <> -1)
begin		
	if(@count > @t_pageline)
	begin
		set @k = CEILING((cast(@count as float)/@t_pageline))
		while(@k > 0)
		begin
			update @tmp set pageno = @k where orderno > ((@k-1)*@t_pageline) and orderno <= (@k*@t_pageline)
			set @k -=1
		end
	end
	fetch next from cursor_table
	into @noa,@count,@orderno
end
close cursor_table
deallocate cursor_table
update @tmp set orderno = orderno-((pageno-1)*@t_pageline)
declare cursor_table cursor for
	select distinct noa,max(orderno),pageno,min(idno),count(*) from @tmp group by noa,pageno
open cursor_table
fetch next from cursor_table
into @noa,@orderno,@pageno,@idno,@count
while(@@FETCH_STATUS <> -1)
begin		
	set @k = @t_pageline -(@count%@t_pageline)
	set @pageCount = @count/@t_pageline
	if(@k < @t_pageline and (@pageCount =0))
	begin
		while(@k > 0)
		begin
			insert into @tmp(gno,orderno,pageno,noa,memo,kind,tgg)
				select '0',(@orderno+1),@pageno,@noa,memo,kind,tgg from @tmp where idno = @idno
			set @k = @k-1
			set @orderno = @orderno +1
		end
	end
	insert into @tmp(gno,orderno,pageno,noa,kind,tgg,moneys,tax,ttotal)
		select '1',(@t_pageline+1),pageno,noa,kind,tgg,sum(isnull(total,0)),max(isnull(tax,0)) ,max(isnull(ttotal,0)) from @tmp where gno=0 and noa=@noa and pageno=@pageno group by noa,pageno,kind,tgg
	insert into @tmp(gno,orderno,pageno,noa,kind,memo) 
		select '2',(@t_pageline+2),pageno,noa,kind,memo from @tmp where gno=0 and noa=@noa and pageno=@pageno group by noa,pageno,kind,memo
	fetch next from cursor_table
	into @noa,@orderno,@pageno,@idno,@count
end
close cursor_table
deallocate cursor_table
update @tmp set kind = (case kind when '1' then '原料' when '2' then '物料' when '3' then '費用' when '4' then '費用(製)' 
			when '5' then '維修' when '6' then '加工' end)
select gno,noa,noq,odate,tno,tgg,tel,fax,addr,kind,trantype,paytype,datea,uno,pno,product,spec,size,
reverse(substring(reverse(convert(nvarchar(max),CONVERT(money,mount),1)),4,30)) mount,
reverse(substring(reverse(convert(nvarchar(max),CONVERT(money,weightb),1)),4,30)) weightb,
reverse(substring(reverse(convert(nvarchar(max),CONVERT(money,price),1)),4,30)) price,
reverse(substring(reverse(convert(nvarchar(max),CONVERT(money,total),1)),4,30)) total,ordeno,tmemo,
reverse(substring(reverse(convert(nvarchar(max),CONVERT(money,moneys),1)),4,30)) moneys,
reverse(substring(reverse(convert(nvarchar(max),CONVERT(money,tax),1)),4,30)) tax,
reverse(substring(reverse(convert(nvarchar(max),CONVERT(money,ttotal),1)),4,30)) ttotal,
reverse(substring(reverse(convert(nvarchar(max),CONVERT(money,tmount),1)),4,30)) tmount,memo
from @tmp order by noa desc,datea desc,pageno,gno,orderno;
--**************************************************************************************************************
z_ordbp2:--z_ordbp2
declare @tmp table(
	gno nvarchar(1),
	productno nvarchar(30),
	products nvarchar(90),
	stype nvarchar(15),
	ordeno nvarchar(30),
	ordbmount float,
	ordbunit nvarchar(12),
	ordcmount float,
	ordcunit nvarchar(12),
	price float,
	tggno nvarchar(30),
	tggs nvarchar(90),
	coin nvarchar(15),
	taxtype nvarchar(15),
	odate nvarchar(10),
	datea nvarchar(10),
	kind nvarchar(15),
	noa nvarchar(30),
	trandate nvarchar(10)
)
insert into @tmp
	select 
		'0',a.productno,a.product,c.stype,c.ordeno,c.ordbmount,c.ordbunit,
		a.mount,a.unit,a.price,b.tggno,b.tgg,b.coin,b.taxtype,b.odate,b.datea,
		b.kind,b.noa,b.trandate
	from view_ordcs[1] a
	left join view_ordc[1] b on a.noa = b.noa
	left join (
		select a.noa ordbno,d.noa ordeno,d.no2 no2,b.no3 no3,c.stype stype,
				b.mount ordbmount,b.unit ordbunit
		from view_ordb[1] a
		left join view_ordbs[1] b on a.noa = b.noa
		left join view_orde[1] c on b.ordeno = c.noa
		left join view_ordes[1] d on (c.noa = d.noa) and (b.no2 = d.no2)
		group by a.noa,d.noa,d.no2,b.no3,c.stype,b.mount,b.unit
	) c on (a.ordbno = c.ordbno) and (a.no3 = c.no3)
update @tmp set stype = (
		case stype when '1' then '內銷' when '2' then '代工' when '3' then '外銷' when '4' then '計畫生產' end
)
update @tmp set taxtype = (
		case taxtype when '1' then '應稅' when '2' then '零稅率' when '3' then '內含' when '4' then '免稅' 
		when '5' then '自訂' when '6' then '作廢' end
)
update @tmp set kind = (
		case kind when '1' then '原料' when '2' then '物料' 
		when 'A1' then '鋼捲鋼板' when 'B2' then '鋼管' when 'C3' then '鋼筋' when 'A4' then '鋼胚'  
		end
)
select * from @tmp;
----**************************************************************************************
