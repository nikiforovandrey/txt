workusave:--workusave
declare @t_noa nvarchar(50) = [1]
declare @condition nvarchar(20)=[2]--動作 0 刪除, 1 新增
declare @cmd nvarchar(max)
declare @tmp table(
	workfno nvarchar(100),
	workfnoq nvarchar(10),
	workfyear nvarchar(10),
	mount float
)

	insert into @tmp 
	select a.workfno,a.workfnoq,b.accy
	,isnull((select SUM(mount) from view_workus where workfno=a.workfno and workfnoq=a.workfnoq and (@condition='1' or noa!=@t_noa)),0)
	from view_workus a 
	outer apply(select top 1 accy from view_workf where noa=a.workfno) b 
	where a.noa=@t_noa
	group by a.workfno,a.workfnoq,b.accy
	 
declare @workfno nvarchar(50)
declare @workfnoq nvarchar(10)
declare @workfyear nvarchar(10)
declare @mount float
declare cursor_table cursor for
select a.workfno,a.workfnoq,a.workfyear,a.mount from @tmp a
open cursor_table
fetch next from cursor_table
into @workfno,@workfnoq,@workfyear,@mount
while(@@FETCH_STATUS <> -1)
begin
set @cmd = 'update workfs' + @workfyear + ' set tmount=@mount where noa=N''' + @workfno + ''' and noq=N''' + @workfnoq + ''''
execute sp_executesql @cmd,N'@mount float ',@mount=@mount
fetch next from cursor_table
into @workfno,@workfnoq,@workfyear,@mount
end
close cursor_table
deallocate cursor_table
;