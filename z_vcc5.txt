z_vcc5:--z_vcc5
SET QUOTED_IDENTIFIER OFF
declare @cmd nvarchar(max)
declare @pagecount int
declare @t_tel nvarchar(20)
declare @t_addr nvarchar(50)
declare @t_accy nvarchar(10)
declare @t_bxnoa nvarchar(10)
declare @t_exnoa nvarchar(10)
declare @t_bdate nvarchar(10)
declare @t_edate nvarchar(10)
declare @t_bcustno nvarchar(20)
declare @t_ecustno nvarchar(20)
set @pageCount = 5
set @t_tel ='[1]'
set @t_addr ='[2]'
set @t_accy ='[3]'
set @t_bxnoa = case when '#non' = [4] then '' else [4] end
set @t_exnoa = case when '#non' = [5] then CHAR(255) else [5] end
set @t_bdate = case when '#non' = [6] then '' else [6] end
set @t_edate = case when '#non' = [7] then CHAR(255) else [7] end
set @t_bcustno = case when '#non' = [8] then '' else [8] end
set @t_ecustno = case when '#non' = [9] then CHAR(255) else [9] end
declare @result table(
		gno nvarchar(1),
		noa nvarchar(30),
		noq nvarchar(20),
		custno nvarchar(20),
		comp nvarchar(50),
		datea nvarchar(10),
		tel nvarchar(10),
		addr_conn nvarchar(50),
		addr nvarchar(50),
		serial nvarchar(10),
		product nvarchar(50),
		spec nvarchar(10),
		unit nvarchar(10),
		mount int,
		price int,
		total int,
		memo nvarchar(20),
		pay nvarchar(10),
		tax int,
		mney int,
		total2 int,
		trantype nvarchar(10),
		invono nvarchar(15),
		recno int,
		currecno int,
		curpage int,
		totpage int
)

set @cmd =	"select a.*,ROW_NUMBER()over(order by gno),0,0,0"+
				" from("+
				" select '0' gno,a.noa,b.noq,a.custno,a.comp,a.datea,c.tel,c.addr_comp,a.addr,c.serial,"+
				" b.product,b.spec,b.unit,b.mount,b.price,b.total total,b.memo,a.pay,a.tax,a.money,a.total total2,a.trantype,a.invono"+
				" from vcc"+@t_accy+ " a "+
				" left join vccs"+@t_accy+" b on a.noa = b.noa " + 
				" left join cust c on c.noa = a.custno" + 
				" where "+
				" (isnull(a.noa,'') between @t_bxnoa and @t_exnoa) and "+
				" (isnull(a.datea,'') between @t_bdate and @t_edate) and "+
				" (isnull(a.custno,'') between @t_bcustno and @t_ecustno)"+
				" ) a "

	insert into @result
	execute sp_executesql @cmd,N'@t_bxnoa nvarchar(20),@t_exnoa nvarchar(20),@t_bdate nvarchar(20),@t_edate nvarchar(20),@t_bcustno nvarchar(20),@t_ecustno nvarchar(20)',
							@t_bxnoa=@t_bxnoa,@t_exnoa=@t_exnoa,@t_bdate=@t_bdate,@t_edate=@t_edate,@t_bcustno=@t_bcustno,@t_ecustno=@t_ecustno

	
	declare @noa nvarchar(30)
	declare @count int
	declare @t_count int
	declare @recno int
	declare @currecno int
	declare @curpage int
	declare @totpage int
	
	declare cursor_table cursor for
	select noa,min(recno) from @result group by noa
	open cursor_table
	fetch next from cursor_table
	into @noa,@recno
	while(@@FETCH_STATUS <> -1)
	begin
		update @result set currecno = recno - @recno +1 where noa=@noa
		fetch next from cursor_table
		into @noa,@recno
	end
	close cursor_table
	deallocate cursor_table
	
	declare cursor_table cursor for
	select noa,max(currecno) from @result group by noa
	open cursor_table
	fetch next from cursor_table
	into @noa,@currecno
	while(@@FETCH_STATUS <> -1)
	begin
		update @result set totpage = (@currecno-@currecno%@pagecount)/@pagecount+1 where noa=@noa
		fetch next from cursor_table
		into @noa,@currecno
	end
	close cursor_table
	deallocate cursor_table
	
	declare cursor_table cursor for
	select noa,recno,currecno from @result
	open cursor_table
	fetch next from cursor_table
	into @noa,@recno,@currecno
	while(@@FETCH_STATUS <> -1)
	begin
		update @result set curpage = FLOOR((@currecno-1)/@pagecount)+1 where noa=@noa and recno=@recno
		fetch next from cursor_table
		into @noa,@recno,@currecno
	end
	close cursor_table
	deallocate cursor_table

	declare cursor_table cursor for
	select noa,curpage,@pagecount-[count]%@pagecount,([count]-[count]%@pagecount)/@pagecount+1
	from(select noa,COUNT(1) [count], max(curpage) curpage from @result group by noa) a
	where not[count]%@pagecount=0
	open cursor_table
	fetch next from cursor_table
	into @noa,@curpage,@count,@totpage
	while(@@FETCH_STATUS <> -1)
	begin
		set @t_count = @count
		while(@t_count>0)
		begin
			insert into @result(gno,noa,noq,curpage,totpage)values('0',@noa,CHAR(255),@curpage,@totpage)
			set @t_count = @t_count - 1
		end
		fetch next from cursor_table
		into @noa,@curpage,@count,@totpage
	end
	close cursor_table
	deallocate cursor_table

	select gno,noa,noq,custno,comp,datea,tel,addr_conn,addr,serial,product,spec,unit,mount,price,total,memo,
	pay,tax,mney,total2,trantype,invono,CONVERT(nvarchar(5),curpage)+'/'+CONVERT(nvarchar(5),totpage) page from @result order by noa,noq;
