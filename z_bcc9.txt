z_bcc9:--z_bcc9
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_bbccno nvarchar(20)
	declare @t_ebccno nvarchar(20)

	set @t_bdate = case when '#non'=[1] then '' else [1] end
	set @t_edate = case when '#non'=[2] then char(255) else [2] end
	set @t_bbccno = case when '#non'=[3] then '' else [3] end
	set @t_ebccno = case when '#non'=[4] then char(255) else [4] end

	--*****************************************************************************************	
--盤存的資料
declare @t_result table(
		bccno nvarchar(20),
		bccname nvarchar(50),
		datea nvarchar(10),
		mount decimal (14,2)
)
--輸出資料
declare @result table(
		gno nvarchar(1),
		bccno nvarchar(20),
		bccname nvarchar(50),
		mount1 decimal (14,2),
		mount2 decimal (14,2),
		mount3 decimal (14,2),
		mount4 decimal (14,2),
		mount5 decimal (14,2)
)

declare @gno nvarchar(1)
declare	@bccno nvarchar(20)
declare	@bccname nvarchar(50)
declare	@datea nvarchar(10)
declare	@mount decimal (14,2)
declare	@mount2 decimal (14,2)
declare	@mount3 decimal (14,2)
declare	@mount4 decimal (14,2)


--計算有盤存的上期餘額
--取最後一筆有盤存的資料

declare bcc_table cursor for
select b.bccno from bcce a left join bcces b on a.noa=b.noa where b.bccno between @t_bbccno and @t_ebccno and a.datea < @t_bdate group by b.bccno
open bcc_table
fetch next from bcc_table
into @bccno
while(@@FETCH_STATUS <> -1)
begin
	insert into @t_result
	select top 1 b.bccno,b.bccname,a.datea,b.mount
	from bcce a left join bcces b on a.noa=b.noa
	where b.bccno =@bccno and a.datea < @t_bdate
	order by a.datea desc
	fetch next from bcc_table
	into @bccno

end
close bcc_table
deallocate bcc_table

--計算盤存到資料之前的入領料
declare bcc_table cursor for
select bccno,bccname,datea,mount from @t_result
open bcc_table
fetch next from bcc_table
into @bccno,@bccname,@datea,@mount
while(@@FETCH_STATUS <> -1)
begin

	set @mount=@mount
		--入料
		+isnull((select sum(b.mount) mount
		from bccin a left join bccins b on a.noa=b.noa
		where b.bccno=@bccno and  a.datea between @datea and @t_bdate
		group by b.bccno),0)
		--領料&耗用
		-isnull((select sum(b.mount-b.bkbcc) mount1
		from bccout a left join bccouts b on a.noa=b.noa
		where b.bccno=@bccno and  a.datea between @datea and @t_bdate
		group by b.bccno),0)
	--存入有盤存的期初
	insert into @result
	select '0',@bccno,@bccname,@mount,0,0,0,0

	fetch next from bcc_table
	into @bccno,@bccname,@datea,@mount

end
close bcc_table
deallocate bcc_table


--計算沒有盤存的上期餘額

declare bcc_table cursor for
select noa,product,datea,beginmount from bcc where noa not in (select c.noa bccno from bcce a left join bcces b on a.noa=b.noa right join bcc c on c.noa=b.bccno where b.bccno between @t_bbccno and @t_ebccno and a.datea < @t_bdate)
open bcc_table
fetch next from bcc_table
into @bccno,@bccname,@datea,@mount
while(@@FETCH_STATUS <> -1)
begin

	set @mount=@mount
		--入料
		+isnull((select sum(b.mount) mount
		from bccin a left join bccins b on a.noa=b.noa
		where b.bccno=@bccno and  a.datea < @t_bdate
		group by b.bccno),0)
		--領料&耗用
		-isnull((select sum(b.mount-b.bkbcc) mount1
		from bccout a left join bccouts b on a.noa=b.noa
		where b.bccno=@bccno and  a.datea < @t_bdate
		group by b.bccno),0)
	--存入沒有盤存的期初
	insert into @result
	select '0',@bccno,@bccname,@mount,0,0,0,0

	fetch next from bcc_table
	into @bccno,@bccname,@datea,@mount

end
close bcc_table
deallocate bcc_table


--計算本月入庫&領料&耗料

declare bcc_table cursor for
select bccno,mount1 from @result
open bcc_table
fetch next from bcc_table
into @bccno,@mount
while(@@FETCH_STATUS <> -1)
begin
	
	--入庫
	set @mount2 = (select isnull(sum(b.mount),0)
	from bccin a left join bccins b on a.noa=b.noa
	where b.bccno=@bccno and  a.datea between @t_bdate and @t_edate
	group by b.bccno)
	--領料
	set @mount3 = (select isnull(sum(b.mount),0) 
	from bccout a left join bccouts b on a.noa=b.noa
	where b.bccno=@bccno and  a.datea between @t_bdate and @t_edate
	group by b.bccno)
	--耗料
	set @mount4 = (select isnull(sum(b.mount-b.bkbcc),0)
	from bccout a left join bccouts b on a.noa=b.noa
	where b.bccno=@bccno and  a.datea between @t_bdate and @t_edate
	group by b.bccno)
	
	update @result 
	set mount2=@mount2,mount3=@mount3,mount4=@mount4,mount5=@mount+@mount2-@mount4
	where current of bcc_table

	fetch next from bcc_table
	into @bccno,@mount

end
close bcc_table
deallocate bcc_table

select * from @result;

--************使用資料表說明*************--
--在日期之前有盤存的資材
--select b.bccno
--from bcce a left join bcces b on a.noa=b.noa
--where b.bccno between @t_bbccno and @t_ebccno and a.datea < @t_bdate
--group by b.bccno
--在日期之前沒有盤存的資材
--select noa
--from bcc
--where noa not in
--(select c.noa bccno
--from bcce a left join bcces b on a.noa=b.noa right join bcc c on c.noa=b.bccno
--where b.bccno between @t_bbccno and @t_ebccno and a.datea < @t_bdate)
----入庫
--select a.datea,b.bccno,b.bccname,sum(b.mount) mount
--from bccin a left join bccins b on a.noa=b.noa
--group by a.datea,b.bccno,b.bccname
----領料
--select a.datea,b.bccno,b.bccname,sum(b.mount-b.bkbcc) mount
--from bccout a left join bccouts b on a.noa=b.noa
--group by a.datea,b.bccno,b.bccname
----盤點
--select a.datea,b.bccno,b.bccname,sum(b.mount) mount
--from bcce a left join bcces b on a.noa=b.noa
--group by a.datea,b.bccno,b.bccname