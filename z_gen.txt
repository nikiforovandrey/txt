z_gen1:--z_gen1
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_bpno nvarchar(20)
	declare @t_epno nvarchar(20)
	declare @t_aberrant nvarchar(20)

	set @t_bdate = case when '#non'=[2] then '' else [2] end
	set @t_edate = case when '#non'=[3] then char(255) else [3] end
	set @t_bpno = case when '#non'=[4] then '' else [4] end
	set @t_epno = case when '#non'=[5] then char(255) else [5] end
	set @t_aberrant = case when '#non'=[13] then '' else [13] end
	
	--*****************************************************************************************	
declare @tmp table( 
	gno nvarchar(1),
	pno nvarchar(50),
	product nvarchar(50),
	unit nvarchar(10),
	bmount float, 
	bweight float, 
	bprice float,
	bmoney float, 
	rcmount float, 
	rcweight float, 
	rcmoney float, 
	gmount float, 
	gweight float, 
	gcost float,
	vcmount float, 
	vcweight float, 
	vcmoney float, 
	vccost float,
	lmount float, 
	lweight float, 
	lprice float, 
	lmoney float
) 

--期初抓inas編號0000
--ina,get做調整用(只在期初用)
--worka,workc,cut,cubt領料
--workb,workd,cuts,cubu生產
--rc2進貨--vcc銷貨
insert into @tmp (gno,pno,product,unit,bmount,bweight,bprice,rcmount,rcweight,rcmoney,gmount,gweight,vcmount,vcweight,vcmoney)
select '0'gon,noa,product,unit
,isnull((select mount from view_inas[1] i where charindex('0000',i.noa)>0 and i.productno=a.noa),0)
+isnull((select sum(ib.mount) from view_ina[1] ia left join view_inas[1] ib on ia.noa=ib.noa where ia.datea<@t_bdate and ib.productno=a.noa and charindex('0000',ia.noa)=0),0)--ina
-isnull((select sum(gb.mount) from view_get[1] ga left join view_gets[1] gb on ga.noa=gb.noa where ga.datea<@t_bdate and gb.productno=a.noa),0)--get
-isnull((select sum((case when wa.typea='1' then 1 else -1 end)*wb.mount) from view_worka[1] wa left join view_workas[1] wb on wa.noa=wb.noa where wa.datea<@t_bdate and wb.productno=a.noa),0)--worka
--+isnull((select sum(wb.mount) from view_workb[1] wa left join view_workbs[1] wb on wa.noa=wb.noa where wa.datea<@t_bdate and wb.productno=a.noa),0)--workb
-isnull((select sum((case when wa.typea='1' then 1 else -1 end)*wb.mount) from view_workc[1] wa left join view_workcs[1] wb on wa.noa=wb.noa where wa.datea<@t_bdate and wb.productno=a.noa),0)--workc
--+isnull((select sum(wb.mount+wb.inmount-wb.outmount) from view_workd[1] wa left join view_workds[1] wb on wa.noa=wb.noa where wa.datea<@t_bdate and wb.productno=a.noa),0)--workd
-isnull((select sum(mount) from view_cut[1] where datea<@t_bdate and productno=a.noa),0)--cut
-isnull((select sum(cb.mount) from view_cub[1] ca left join view_cubt[1] cb on ca.noa=cb.noa where ca.datea<@t_bdate and cb.productno=a.noa),0)--cubt
--+isnull((select sum(cb.mount) from view_cut[1] ca left join view_cuts[1] cb on ca.noa=cb.noa where ca.datea<@t_bdate and cb.productno=a.noa),0)--cuts
--+isnull((select sum(cb.mount) from view_cub[1] ca left join view_cubu[1] cb on ca.noa=cb.noa where ca.datea<@t_bdate and cb.productno=a.noa),0)--cubu
+isnull((select sum((case when ra.typea='1' then 1 else -1 end)*rb.mount) from view_rc2[1] ra left join view_rc2s[1] rb on ra.noa=rb.noa where ra.datea<@t_bdate and rb.productno=a.noa),0)--rc2
-isnull((select sum((case when va.typea='1' then 1 else -1 end)*vb.mount) from view_vcc[1] va left join view_vccs[1] vb on va.noa=vb.noa where va.datea<@t_bdate and vb.productno=a.noa),0)--vcc
bigenmount
,isnull((select weight from view_inas[1] i where charindex('0000',i.noa)>0 and i.productno=a.noa),0)
+isnull((select sum(ib.weight) from view_ina[1] ia left join view_inas[1] ib on ia.noa=ib.noa where ia.datea<@t_bdate and ib.productno=a.noa and charindex('0000',ia.noa)=0),0)--ina
-isnull((select sum(gb.gweight) from view_get[1] ga left join view_gets[1] gb on ga.noa=gb.noa where ga.datea<@t_bdate and gb.productno=a.noa),0)--get
-isnull((select sum((case when wa.typea='1' then 1 else -1 end)*wb.weight) from view_worka[1] wa left join view_workas[1] wb on wa.noa=wb.noa where wa.datea<@t_bdate and wb.productno=a.noa),0)--worka
--+isnull((select sum(wb.weight) from view_workb[1] wa left join view_workbs[1] wb on wa.noa=wb.noa where wa.datea<@t_bdate and wb.productno=a.noa),0)--workb
-isnull((select sum((case when wa.typea='1' then 1 else -1 end)*wb.weight) from view_workc[1] wa left join view_workcs[1] wb on wa.noa=wb.noa where wa.datea<@t_bdate and wb.productno=a.noa),0)--workc
--+isnull((select sum(wb.weight) from view_workd[1] wa left join view_workds[1] wb on wa.noa=wb.noa where wa.datea<@t_bdate and wb.productno=a.noa),0)--workd
-isnull((select sum(gweight) from view_cut[1] where datea<@t_bdate and productno=a.noa),0)--cut
-isnull((select sum(cb.weight) from view_cub[1] ca left join view_cubt[1] cb on ca.noa=cb.noa where ca.datea<@t_bdate and cb.productno=a.noa),0)--cubt
--+isnull((select sum(cb.weight) from view_cut[1] ca left join view_cuts[1] cb on ca.noa=cb.noa where ca.datea<@t_bdate and cb.productno=a.noa),0)--cuts
--+isnull((select sum(cb.weight) from view_cub[1] ca left join view_cubu[1] cb on ca.noa=cb.noa where ca.datea<@t_bdate and cb.productno=a.noa),0)--cubu
+isnull((select sum((case when ra.typea='1' then 1 else -1 end)*rb.weight) from view_rc2[1] ra left join view_rc2s[1] rb on ra.noa=rb.noa where ra.datea<@t_bdate and rb.productno=a.noa),0)--rc2
-isnull((select sum((case when va.typea='1' then 1 else -1 end)*vb.weight) from view_vcc[1] va left join view_vccs[1] vb on va.noa=vb.noa where va.datea<@t_bdate and vb.productno=a.noa),0)--vcc
bigeweight
,case when 
	
	(isnull((select mount from view_inas[1] i where charindex('0000',i.noa)>0 and i.productno=a.noa),0)
	+isnull((select sum(ib.mount) from view_ina[1] ia left join view_inas[1] ib on ia.noa=ib.noa where ia.datea<@t_bdate and ib.productno=a.noa and charindex('0000',ia.noa)=0),0)--ina
	+isnull((select sum((case when ra.typea='1' then 1 else -1 end)*rb.mount) from view_rc2[1] ra left join view_rc2s[1] rb on ra.noa=rb.noa where ra.datea<@t_bdate and rb.productno=a.noa),0)--rc2
	)=0 
then 0 
else
	(isnull((select total from view_inas[1] i where charindex('0000',i.noa)>0 and i.productno=a.noa),0)
	+isnull((select sum(ib.total) from view_ina[1] ia left join view_inas[1] ib on ia.noa=ib.noa where ia.datea<@t_bdate and ib.productno=a.noa and charindex('0000',ia.noa)=0),0)--ina
	+isnull((select sum((case when ra.typea='1' then 1 else -1 end)*rb.total) from view_rc2[1] ra left join view_rc2s[1] rb on ra.noa=rb.noa where ra.datea<@t_bdate and rb.productno=a.noa),0)--rc2
	)/
	(isnull((select mount from view_inas[1] i where charindex('0000',i.noa)>0 and i.productno=a.noa),0)
	+isnull((select sum(ib.mount) from view_ina[1] ia left join view_inas[1] ib on ia.noa=ib.noa where ia.datea<@t_bdate and ib.productno=a.noa and charindex('0000',ia.noa)=0),0)--ina
	+isnull((select sum((case when ra.typea='1' then 1 else -1 end)*rb.mount) from view_rc2[1] ra left join view_rc2s[1] rb on ra.noa=rb.noa where ra.datea<@t_bdate and rb.productno=a.noa),0)--rc2
	)
end
bigenprice
,isnull((select sum((case when ra.typea='1' then 1 else -1 end)*rb.mount) from view_rc2[1] ra left join view_rc2s[1] rb on ra.noa=rb.noa where (ra.datea between @t_bdate and @t_edate) and rb.productno=a.noa),0)
rcmount--進貨數量
,isnull((select sum((case when ra.typea='1' then 1 else -1 end)*rb.weight) from view_rc2[1] ra left join view_rc2s[1] rb on ra.noa=rb.noa where (ra.datea between @t_bdate and @t_edate) and rb.productno=a.noa),0)
rcweight--進貨重量
,isnull((select sum((case when ra.typea='1' then 1 else -1 end)*rb.total) from view_rc2[1] ra left join view_rc2s[1] rb on ra.noa=rb.noa where (ra.datea between @t_bdate and @t_edate) and rb.productno=a.noa),0)
rcmoney--進貨金額
,isnull((select sum(wb.mount) from view_worka[1] wa left join view_workas[1] wb on wa.noa=wb.noa where (wa.datea between @t_bdate and @t_edate) and wb.productno=a.noa),0)--worka
+isnull((select sum(wb.mount) from view_workc[1] wa left join view_workcs[1] wb on wa.noa=wb.noa where (wa.datea between @t_bdate and @t_edate) and wb.productno=a.noa),0)--workc
+isnull((select sum(mount) from view_cut[1] where (datea between @t_bdate and @t_edate) and productno=a.noa),0)--cut
+isnull((select sum(cb.mount) from view_cub[1] ca left join view_cubt[1] cb on ca.noa=cb.noa where (ca.datea between @t_bdate and @t_edate) and cb.productno=a.noa),0)--cubt
gmount--領料數量
,isnull((select sum((case when wa.typea='1' then 1 else -1 end)*wb.weight) from view_worka[1] wa left join view_workas[1] wb on wa.noa=wb.noa where (wa.datea between @t_bdate and @t_edate) and wb.productno=a.noa),0)--worka
+isnull((select sum((case when wa.typea='1' then 1 else -1 end)*wb.weight) from view_workc[1] wa left join view_workcs[1] wb on wa.noa=wb.noa where (wa.datea between @t_bdate and @t_edate) and wb.productno=a.noa),0)--workc
+isnull((select sum(gweight) from view_cut[1] where (datea between @t_bdate and @t_edate) and productno=a.noa),0)--cut
+isnull((select sum(cb.weight) from view_cub[1] ca left join view_cubt[1] cb on ca.noa=cb.noa where (ca.datea between @t_bdate and @t_edate) and cb.productno=a.noa),0)--cubt
gweight--領料重量
,isnull((select sum((case when va.typea='1' then 1 else -1 end)*vb.mount) from view_vcc[1] va left join view_vccs[1] vb on va.noa=vb.noa where (va.datea between @t_bdate and @t_edate) and vb.productno=a.noa),0)
vcmount--銷貨數量
,isnull((select sum((case when va.typea='1' then 1 else -1 end)*vb.weight) from view_vcc[1] va left join view_vccs[1] vb on va.noa=vb.noa where (va.datea between @t_bdate and @t_edate) and vb.productno=a.noa),0)
vcweight--銷貨重量
,isnull((select sum((case when va.typea='1' then 1 else -1 end)*vb.total) from view_vcc[1] va left join view_vccs[1] vb on va.noa=vb.noa where (va.datea between @t_bdate and @t_edate) and vb.productno=a.noa),0)
vcmoney--銷貨金額
from ucc a where (a.typea='4' or a.typea='5') --原物料
and (a.noa between @t_bpno and @t_epno) 

--計算期初金額
update @tmp
set bmoney=bprice* bmount

--計算領用成本
update @tmp
set gcost= case when (bmount+rcmount)=0 then 0 else (bmoney+rcmoney)/(bmount+rcmount)*gmount end


--計算銷售成本
update @tmp
set vccost=case when bmount+rcmount=0 then 0 else ((bmoney+rcmoney)/(bmount+rcmount))*vcmount end



--計算期末
update @tmp
set lmount=bmount+rcmount-vcmount-gmount,lweight=bweight+rcweight-vcweight-gweight
,lmoney=bmoney+rcmoney-vccost-gcost

update @tmp
set lprice=case when lmount=0 then 0 else lmoney/lmount end 

delete @tmp
where bmount=0 and bmoney=0 and rcmount=0 and rcmoney=0 and gmount=0 and gcost=0 and vcmount=0 and vcmoney=0 --and bweight=0 and rcweight=0 and gweight=0 and vcweight=0    

if(len(@t_aberrant)!=0)
delete @tmp where lmount>=0 and lmoney>=0 --and lweight>=0 

insert into @tmp
select '1','','','',sum(bmount),sum(bweight),0,sum(bmoney)
,sum(rcmount),sum(rcweight),sum(rcmoney)
,sum(gmount),sum(gweight),sum(gcost)
,sum(vcmount),sum(vcweight),sum(vcmoney),sum(vccost)
,sum(lmount),sum(lweight),0,sum(lmoney)
from @tmp

select 
gno,pno,product,unit
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(bmount,2)),1)),0,30)) bmount
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(bweight,2)),1)),0,30)) bweight
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(bmoney,2)),1)),0,30)) bmoney

,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(rcmount,2)),1)),0,30)) rcmount
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(rcweight,2)),1)),0,30)) rcweight
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(rcmoney,2)),1)),0,30)) rcmoney

,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(gmount,2)),1)),0,30)) gmount
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(gweight,2)),1)),0,30)) gweight
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(gcost,2)),1)),0,30)) gcost

,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(vcmount,2)),1)),0,30)) vcmount
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(vcweight,2)),1)),0,30)) vcweight
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(vcmoney,2)),1)),0,30)) vcmoney
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(vccost,2)),1)),0,30)) vccost

,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(lmount,2)),1)),0,30)) lmount
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(lweight,2)),1)),0,30)) lweight
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(lprice,2)),1)),0,30)) lprice
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(lmoney,2)),1)),0,30)) lmoney

from @tmp order by gno,pno;
--*********************************************************************************************
z_gen2:--z_gen2
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_bpno nvarchar(20)
	declare @t_epno nvarchar(20)
	declare @t_aberrant nvarchar(20)

	set @t_bdate = case when '#non'=[2] then '' else [2] end
	set @t_edate = case when '#non'=[3] then char(255) else [3] end
	set @t_bpno = case when '#non'=[4] then '' else [4] end
	set @t_epno = case when '#non'=[5] then char(255) else [5] end
	set @t_aberrant = case when '#non'=[13] then '' else [13] end
	
	--*****************************************************************************************	
declare @tmp table( 
	gno nvarchar(1),
	pno nvarchar(50),
	product nvarchar(50),
	unit nvarchar(10),
	bmount float, 
	bweight float, 
	bprice float,
	bmoney float, 
	brmount float, 
	brweight float, 
	brmoney float, 
	rcmount float, 
	rcweight float, 
	rcmoney float, 
	vcmount float, 
	vcweight float, 
	vcmoney float, 
	vccost float,
	profit float, 
	lmount float, 
	lweight float, 
	lprice float, 
	lmoney float
) 

--期初抓inas編號0000
--ina,get做調整用(只在期初用)
--worka,workc,cut,cubt領料
--workb,workd,cuts,cubu生產
--rc2進貨--vcc銷貨

insert into @tmp (gno,pno,product,unit,bmount,bweight,bprice,brmount,brweight,brmoney,rcmount,rcweight,rcmoney,vcmount,vcweight,vcmoney)
select '0'gon,noa,product,unit
,isnull((select mount from view_inas[1] i where charindex('0000',i.noa)>0 and i.productno=a.noa),0)
+isnull((select sum(ib.mount) from view_ina[1] ia left join view_inas[1] ib on ia.noa=ib.noa where ia.datea<@t_bdate and ib.productno=a.noa and charindex('0000',ia.noa)=0),0)--ina
-isnull((select sum(gb.mount) from view_get[1] ga left join view_gets[1] gb on ga.noa=gb.noa where ga.datea<@t_bdate and gb.productno=a.noa),0)--get
-isnull((select sum((case when wa.typea='1' then 1 else -1 end)*wb.mount) from view_worka[1] wa left join view_workas[1] wb on wa.noa=wb.noa where wa.datea<@t_bdate and wb.productno=a.noa),0)--worka
+isnull((select sum(wb.mount) from view_workb[1] wa left join view_workbs[1] wb on wa.noa=wb.noa where wa.datea<@t_bdate and wb.productno=a.noa),0)--workb
-isnull((select sum((case when wa.typea='1' then 1 else -1 end)*wb.mount) from view_workc[1] wa left join view_workcs[1] wb on wa.noa=wb.noa where wa.datea<@t_bdate and wb.productno=a.noa),0)--workc
+isnull((select sum(wb.mount+wb.inmount-wb.outmount) from view_workd[1] wa left join view_workds[1] wb on wa.noa=wb.noa where wa.datea<@t_bdate and wb.productno=a.noa),0)--workd
-isnull((select sum(mount) from view_cut[1] where datea<@t_bdate and productno=a.noa),0)--cut
-isnull((select sum(cb.mount) from view_cub[1] ca left join view_cubt[1] cb on ca.noa=cb.noa where ca.datea<@t_bdate and cb.productno=a.noa),0)--cubt
+isnull((select sum(cb.mount) from view_cut[1] ca left join view_cuts[1] cb on ca.noa=cb.noa where ca.datea<@t_bdate and cb.productno=a.noa),0)--cuts
+isnull((select sum(cb.mount) from view_cub[1] ca left join view_cubu[1] cb on ca.noa=cb.noa where ca.datea<@t_bdate and cb.productno=a.noa),0)--cubu
+isnull((select sum((case when ra.typea='1' then 1 else -1 end)*rb.mount) from view_rc2[1] ra left join view_rc2s[1] rb on ra.noa=rb.noa where ra.datea<@t_bdate and rb.productno=a.noa),0)--rc2
-isnull((select sum((case when va.typea='1' then 1 else -1 end)*vb.mount) from view_vcc[1] va left join view_vccs[1] vb on va.noa=vb.noa where va.datea<@t_bdate and vb.productno=a.noa),0)--vcc
bigenmount
,isnull((select weight from view_inas[1] i where charindex('0000',i.noa)>0 and i.productno=a.noa),0)
+isnull((select sum(ib.weight) from view_ina[1] ia left join view_inas[1] ib on ia.noa=ib.noa where ia.datea<@t_bdate and ib.productno=a.noa and charindex('0000',ia.noa)=0),0)--ina
-isnull((select sum(gb.gweight) from view_get[1] ga left join view_gets[1] gb on ga.noa=gb.noa where ga.datea<@t_bdate and gb.productno=a.noa),0)--get
-isnull((select sum((case when wa.typea='1' then 1 else -1 end)*wb.weight) from view_worka[1] wa left join view_workas[1] wb on wa.noa=wb.noa where wa.datea<@t_bdate and wb.productno=a.noa),0)--worka
+isnull((select sum(wb.weight) from view_workb[1] wa left join view_workbs[1] wb on wa.noa=wb.noa where wa.datea<@t_bdate and wb.productno=a.noa),0)--workb
-isnull((select sum((case when wa.typea='1' then 1 else -1 end)*wb.weight) from view_workc[1] wa left join view_workcs[1] wb on wa.noa=wb.noa where wa.datea<@t_bdate and wb.productno=a.noa),0)--workc
+isnull((select sum(wb.weight) from view_workd[1] wa left join view_workds[1] wb on wa.noa=wb.noa where wa.datea<@t_bdate and wb.productno=a.noa),0)--workd
-isnull((select sum(gweight) from view_cut[1] where datea<@t_bdate and productno=a.noa),0)--cut
-isnull((select sum(cb.weight) from view_cub[1] ca left join view_cubt[1] cb on ca.noa=cb.noa where ca.datea<@t_bdate and cb.productno=a.noa),0)--cubt
+isnull((select sum(cb.weight) from view_cut[1] ca left join view_cuts[1] cb on ca.noa=cb.noa where ca.datea<@t_bdate and cb.productno=a.noa),0)--cuts
+isnull((select sum(cb.weight) from view_cub[1] ca left join view_cubu[1] cb on ca.noa=cb.noa where ca.datea<@t_bdate and cb.productno=a.noa),0)--cubu
+isnull((select sum((case when ra.typea='1' then 1 else -1 end)*rb.weight) from view_rc2[1] ra left join view_rc2s[1] rb on ra.noa=rb.noa where ra.datea<@t_bdate and rb.productno=a.noa),0)--rc2
-isnull((select sum((case when va.typea='1' then 1 else -1 end)*vb.weight) from view_vcc[1] va left join view_vccs[1] vb on va.noa=vb.noa where va.datea<@t_bdate and vb.productno=a.noa),0)--vcc
bigeweight
,case when 
	
	(isnull((select mount from view_inas[1] i where charindex('0000',i.noa)>0 and i.productno=a.noa),0)
	+isnull((select sum(ib.mount) from view_ina[1] ia left join view_inas[1] ib on ia.noa=ib.noa where ia.datea<@t_bdate and ib.productno=a.noa and charindex('0000',ia.noa)=0),0)--ina
	+isnull((select sum((case when ra.typea='1' then 1 else -1 end)*rb.mount) from view_rc2[1] ra left join view_rc2s[1] rb on ra.noa=rb.noa where ra.datea<@t_bdate and rb.productno=a.noa),0)--rc2
	
	+isnull((select sum(wb.mount) from view_workb[1] wa left join view_workbs[1] wb on wa.noa=wb.noa where wa.datea<@t_bdate and wb.productno=a.noa),0)--workb
	+isnull((select sum(wb.mount+wb.inmount-wb.outmount) from view_workd[1] wa left join view_workds[1] wb on wa.noa=wb.noa where wa.datea<@t_bdate and wb.productno=a.noa),0)--workd
	+isnull((select sum(cb.mount) from view_cut[1] ca left join view_cuts[1] cb on ca.noa=cb.noa where ca.datea<@t_bdate and cb.productno=a.noa),0)--cuts
	+isnull((select sum(cb.mount) from view_cub[1] ca left join view_cubu[1] cb on ca.noa=cb.noa where ca.datea<@t_bdate and cb.productno=a.noa),0)--cubu
	)=0 
then 0 
else
	(isnull((select total from view_inas[1] i where charindex('0000',i.noa)>0 and i.productno=a.noa),0)
	+isnull((select sum(ib.total) from view_ina[1] ia left join view_inas[1] ib on ia.noa=ib.noa where ia.datea<@t_bdate and ib.productno=a.noa and charindex('0000',ia.noa)=0),0)--ina
	+isnull((select sum((case when ra.typea='1' then 1 else -1 end)*rb.total) from view_rc2[1] ra left join view_rc2s[1] rb on ra.noa=rb.noa where ra.datea<@t_bdate and rb.productno=a.noa),0)--rc2
	
	+isnull((select sum(wc.costa+wc.costb+wc.costc+wc.costd)  from view_workb[1] wa left join view_workbs[1] wb on wa.noa=wb.noa left join wcost[1] wc on wb.noa=wc.noa and wb.productno=wc.productno
	where wa.datea<@t_bdate and wb.productno=a.noa)
	,0)--workb
	+isnull((select sum(wc.costa+wc.costb+wc.costc+wc.costd)  from view_workd[1] wa left join view_workds[1] wb on wa.noa=wb.noa left join wcost[1] wc on wb.noa=wc.noa and wb.productno=wc.productno
	where wa.datea<@t_bdate and wb.productno=a.noa)
	,0)--workd
	
	+isnull((select sum(cb.mount) from view_cut[1] ca left join view_cuts[1] cb on ca.noa=cb.noa where ca.datea<@t_bdate and cb.productno=a.noa)
	*(select beginmoney/beginmount from costs where mon=LEFT(@t_bdate,6) and productno=a.noa)
	,0)--cuts
	+isnull((select sum(cb.mount) from view_cub[1] ca left join view_cubu[1] cb on ca.noa=cb.noa where ca.datea<@t_bdate and cb.productno=a.noa)
	*(select beginmoney/beginmount from costs where mon=LEFT(@t_bdate,6) and productno=a.noa)
	,0)--cubu
	
	)/(isnull((select mount from view_inas[1] i where charindex('0000',i.noa)>0 and i.productno=a.noa),0)
	+isnull((select sum(ib.mount) from view_ina[1] ia left join view_inas[1] ib on ia.noa=ib.noa where ia.datea<@t_bdate and ib.productno=a.noa and charindex('0000',ia.noa)=0),0)--ina
	+isnull((select sum((case when ra.typea='1' then 1 else -1 end)*rb.mount) from view_rc2[1] ra left join view_rc2s[1] rb on ra.noa=rb.noa where ra.datea<@t_bdate and rb.productno=a.noa),0)--rc2
	
	+isnull((select sum(wb.mount) from view_workb[1] wa left join view_workbs[1] wb on wa.noa=wb.noa where wa.datea<@t_bdate and wb.productno=a.noa),0)--workb
	+isnull((select sum(wb.mount+wb.inmount-wb.outmount) from view_workd[1] wa left join view_workds[1] wb on wa.noa=wb.noa where wa.datea<@t_bdate and wb.productno=a.noa),0)--workd
	+isnull((select sum(cb.mount) from view_cut[1] ca left join view_cuts[1] cb on ca.noa=cb.noa where ca.datea<@t_bdate and cb.productno=a.noa),0)--cuts
	+isnull((select sum(cb.mount) from view_cub[1] ca left join view_cubu[1] cb on ca.noa=cb.noa where ca.datea<@t_bdate and cb.productno=a.noa),0)--cubu
	)
end
bigenprice

,isnull((select sum(wb.mount) from view_workb[1] wa left join view_workbs[1] wb on wa.noa=wb.noa where (wa.datea between @t_bdate and @t_edate) and wb.productno=a.noa),0)
+isnull((select sum(wb.mount+wb.inmount-wb.outmount) from view_workd[1] wa left join view_workds[1] wb on wa.noa=wb.noa where (wa.datea between @t_bdate and @t_edate) and wb.productno=a.noa),0)

brmount--生產數量
,isnull((select sum(wb.bweight) from view_workb[1] wa left join view_workbs[1] wb on wa.noa=wb.noa where (wa.datea between @t_bdate and @t_edate) and wb.productno=a.noa),0)
+isnull((select sum(wb.bweight) from view_workd[1] wa left join view_workds[1] wb on wa.noa=wb.noa where (wa.datea between @t_bdate and @t_edate) and wb.productno=a.noa),0)

brweight--生產重量
,isnull((select sum(wc.costa+wc.costb+wc.costc+wc.costd)  from view_workb[1] wa left join view_workbs[1] wb on wa.noa=wb.noa left join wcost[1] wc on wb.noa=wc.noa and wb.productno=wc.productno
where (wa.datea between @t_bdate and @t_edate) and wb.productno=a.noa)
,0)--workb
+isnull((select sum(wc.costa+wc.costb+wc.costc+wc.costd)  from view_workd[1] wa left join view_workds[1] wb on wa.noa=wb.noa left join wcost[1] wc on wb.noa=wc.noa and wb.productno=wc.productno
where (wa.datea between @t_bdate and @t_edate) and wb.productno=a.noa)
,0)--workd
brmoney--生產金額

,isnull((select sum((case when ra.typea='1' then 1 else -1 end)*rb.mount) from view_rc2[1] ra left join view_rc2s[1] rb on ra.noa=rb.noa where (ra.datea between @t_bdate and @t_edate) and rb.productno=a.noa),0)
rcmount--進貨數量
,isnull((select sum((case when ra.typea='1' then 1 else -1 end)*rb.weight) from view_rc2[1] ra left join view_rc2s[1] rb on ra.noa=rb.noa where (ra.datea between @t_bdate and @t_edate) and rb.productno=a.noa),0)
rcweight--進貨重量
,isnull((select sum((case when ra.typea='1' then 1 else -1 end)*rb.total) from view_rc2[1] ra left join view_rc2s[1] rb on ra.noa=rb.noa where (ra.datea between @t_bdate and @t_edate) and rb.productno=a.noa),0)
rcmoney--進貨金額

,isnull((select sum((case when va.typea='1' then 1 else -1 end)*vb.mount) from view_vcc[1] va left join view_vccs[1] vb on va.noa=vb.noa where (va.datea between @t_bdate and @t_edate) and vb.productno=a.noa),0)
vcmount--銷貨數量
,isnull((select sum((case when va.typea='1' then 1 else -1 end)*vb.weight) from view_vcc[1] va left join view_vccs[1] vb on va.noa=vb.noa where (va.datea between @t_bdate and @t_edate) and vb.productno=a.noa),0)
vcweight--銷貨重量
,isnull((select sum((case when va.typea='1' then 1 else -1 end)*vb.total) from view_vcc[1] va left join view_vccs[1] vb on va.noa=vb.noa where (va.datea between @t_bdate and @t_edate) and vb.productno=a.noa),0)
vcmoney--銷貨金額
from (select noa,product,unit,typea from ucc union select noa,product,unit,(case when typea='1' then '2' else '1' end)typea from uca where noa not in (select noa from ucc))a  
where (a.typea='2' or a.typea='6' or a.typea='7') --製成品&下腳品&加工
and (a.noa between @t_bpno and @t_epno) 

--計算期初金額
update @tmp
set bmoney=bprice* bmount

--計算銷售成本
update @tmp
set vccost=
case when bmount+brmount+rcmount=0 then 0 else ((bmoney+brmoney+rcmoney)/(bmount+brmount+rcmount))*vcmount end

--毛利率
update @tmp
set profit=case when vcmoney=0 then 0 else ((vcmoney-vccost)/vcmoney)*100 end

--計算期末
update @tmp
set lmount=bmount+brmount+rcmount-vcmount,lweight=bweight+brweight+rcweight-vcweight
,lmoney=bmoney+brmoney+rcmoney-vccost

update @tmp
set lprice=case when lmount=0 then 0 else lmoney/lmount end 

delete @tmp
where bmount=0 and bmoney=0 and brmoney=0 and brmoney=0 and rcmount=0 and rcmoney=0 and vcmount=0 and vcmoney=0 and vccost=0-- and bweight=0 and brweight=0 and rcweight=0 and vcweight=0

if(len(@t_aberrant)!=0)
	delete @tmp where lmount>=0 and lmoney>=0 --and lweight>=0 

insert into @tmp
select '1','','','',sum(bmount),sum(bweight),0,sum(bmoney)
,sum(brmount),sum(brweight),sum(brmoney)
,sum(rcmount),sum(rcweight),sum(rcmoney)
,sum(vcmount),sum(vcweight),sum(vcmoney),sum(vccost),case when sum(vcmoney)=0 then 0 else ((sum(vcmoney)-sum(vccost))/sum(vcmoney))*100 end
,sum(lmount),sum(lweight),0,sum(lmoney)
from @tmp

select 
gno,pno,product,unit
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(bmount,2)),1)),0,30)) bmount
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(bweight,2)),1)),0,30)) bweight
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(bmoney,2)),1)),0,30)) bmoney

,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(brmount,2)),1)),0,30)) brmount
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(brweight,2)),1)),0,30)) brweight
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(brmoney,2)),1)),0,30)) brmoney

,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(rcmount,2)),1)),0,30)) rcmount
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(rcweight,2)),1)),0,30)) rcweight
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(rcmoney,2)),1)),0,30)) rcmoney

,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(vcmount,2)),1)),0,30)) vcmount
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(vcweight,2)),1)),0,30)) vcweight
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(vcmoney,2)),1)),0,30)) vcmoney
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(vccost,2)),1)),0,30)) vccost
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(profit,2)),1)),0,30)) profit

,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(lmount,2)),1)),0,30)) lmount
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(lweight,2)),1)),0,30)) lweight
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(lprice,2)),1)),0,30)) lprice
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(lmoney,2)),1)),0,30)) lmoney

from @tmp order by gno,pno;
--*********************************************************************************************
z_gen3:--z_gen3
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_bpno nvarchar(20)
	declare @t_epno nvarchar(20)
	declare @t_aberrant nvarchar(20)

	set @t_bdate = case when '#non'=[2] then '' else [2] end
	set @t_edate = case when '#non'=[3] then char(255) else [3] end
	set @t_bpno = case when '#non'=[4] then '' else [4] end
	set @t_epno = case when '#non'=[5] then char(255) else [5] end
	set @t_aberrant = case when '#non'=[13] then '' else [13] end
	
	--*****************************************************************************************	
declare @tmp table( 
	gno nvarchar(1),
	pno nvarchar(50),
	product nvarchar(50),
	unit nvarchar(10),
	bmount float, 
	bweight float, 
	bmoney float, 
	rcmount float, 
	rcweight float, 
	rcmoney float, 
	vcmount float, 
	vcweight float, 
	vcmoney float, 
	vccost float,
	profit float, 
	lmount float, 
	lweight float, 
	lprice float, 
	lmoney float
) 

--期初抓inas
insert into @tmp (gno,pno,product,unit,bmount,bweight,bmoney,rcmount,rcweight,rcmoney,vcmount,vcweight,vcmoney)
select '0'gon,noa,product,unit
,isnull((select mount from view_inas[1] i where charindex('0000',i.noa)>0 and i.productno=a.noa),0)--產品的期初
+isnull((select sum((case when ra.typea='1' then 1 else -1 end)*rb.mount) from view_rc2[1] ra left join view_rc2s[1] rb on ra.noa=rb.noa where ra.datea<@t_bdate and rb.productno=a.noa),0)
-isnull((select sum((case when va.typea='1' then 1 else -1 end)*vb.mount) from view_vcc[1] va left join view_vccs[1] vb on va.noa=vb.noa where va.datea<@t_bdate and vb.productno=a.noa),0)
bigenmount
,isnull((select weight from view_inas[1] i where charindex('0000',i.noa)>0 and i.productno=a.noa),0)--產品的期初
+isnull((select sum((case when ra.typea='1' then 1 else -1 end)*rb.weight) from view_rc2[1] ra left join view_rc2s[1] rb on ra.noa=rb.noa where ra.datea<@t_bdate and rb.productno=a.noa),0)
-isnull((select sum((case when va.typea='1' then 1 else -1 end)*vb.weight) from view_vcc[1] va left join view_vccs[1] vb on va.noa=vb.noa where va.datea<@t_bdate and vb.productno=a.noa),0)
bigeweight
,isnull((select total from view_inas[1] i where charindex('0000',i.noa)>0 and i.productno=a.noa),0)--產品的期初
+isnull((select sum((case when ra.typea='1' then 1 else -1 end)*rb.total) from view_rc2[1] ra left join view_rc2s[1] rb on ra.noa=rb.noa where ra.datea<@t_bdate and rb.productno=a.noa),0)
-isnull((select sum((case when va.typea='1' then 1 else -1 end)*vb.total) from view_vcc[1] va left join view_vccs[1] vb on va.noa=vb.noa where va.datea<@t_bdate and vb.productno=a.noa),0)
bigenmoney
,isnull((select sum((case when ra.typea='1' then 1 else -1 end)*rb.mount) from view_rc2[1] ra left join view_rc2s[1] rb on ra.noa=rb.noa where (ra.datea between @t_bdate and @t_edate) and rb.productno=a.noa),0)
rcmount--進貨數量
,isnull((select sum((case when ra.typea='1' then 1 else -1 end)*rb.weight) from view_rc2[1] ra left join view_rc2s[1] rb on ra.noa=rb.noa where (ra.datea between @t_bdate and @t_edate) and rb.productno=a.noa),0)
rcweight--進貨重量
,isnull((select sum((case when ra.typea='1' then 1 else -1 end)*rb.total) from view_rc2[1] ra left join view_rc2s[1] rb on ra.noa=rb.noa where (ra.datea between @t_bdate and @t_edate) and rb.productno=a.noa),0)
rcmoney--進貨金額

,isnull((select sum((case when va.typea='1' then 1 else -1 end)*vb.mount) from view_vcc[1] va left join view_vccs[1] vb on va.noa=vb.noa where (va.datea between @t_bdate and @t_edate) and vb.productno=a.noa),0)
vcmount--銷貨數量
,isnull((select sum((case when va.typea='1' then 1 else -1 end)*vb.weight) from view_vcc[1] va left join view_vccs[1] vb on va.noa=vb.noa where (va.datea between @t_bdate and @t_edate) and vb.productno=a.noa),0)
vcweight--銷貨重量
,isnull((select sum((case when va.typea='1' then 1 else -1 end)*vb.total) from view_vcc[1] va left join view_vccs[1] vb on va.noa=vb.noa where (va.datea between @t_bdate and @t_edate) and vb.productno=a.noa),0)
vcmoney--銷貨金額

from ucc a where a.typea='1' --產品
and (a.noa between @t_bpno and @t_epno) 


--計算成本
update @tmp
set vccost=
case when bmount+rcmount=0 then 0 else ((bmoney+rcmoney)/(bmount+rcmount))*vcmount end

--毛利率
update @tmp
set profit=case when vcmoney=0 then 0 else ((vcmoney-vccost)/vcmoney)*100 end

--期末
update @tmp
set lmount=bmount+rcmount-vcmount,lweight=bweight+rcweight-vcweight
,lmoney=bmoney+rcmoney-vccost
update @tmp
set lprice=case when lmount=0 then 0 else lmoney/lmount end 

delete @tmp
where bmount=0 and bmoney=0 and rcmount=0 and rcmoney=0 and vcmount=0 and vcmoney=0 and vccost=0 --and bweight=0 and rcweight=0 and vcweight=0

if(len(@t_aberrant)!=0)
delete @tmp where lmount>=0 and lmoney>=0 --and lweight>=0 

insert into @tmp
select '1','','','',sum(bmount),sum(bweight),sum(bmoney)
,sum(rcmount),sum(rcweight),sum(rcmoney)
,sum(vcmount),sum(vcweight),sum(vcmoney),sum(vccost),case when sum(vcmoney)=0 then 0 else ((sum(vcmoney)-sum(vccost))/sum(vcmoney))*100 end
,sum(lmount),sum(lweight),0,sum(lmoney)
from @tmp

select 
gno,pno,product,unit
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,round(bmount,0)),1)),4,12)) bmount
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(bweight,2)),1)),0,30)) bweight
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,round(bmoney,0)),1)),4,12)) bsmoney

,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,round(rcmount,0)),1)),4,12)) rcmount
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(rcweight,2)),1)),0,30)) rcweight
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,round(rcmoney,0)),1)),4,12)) rcmoney

,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,round(vcmount,0)),1)),4,12)) vcmount
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(vcweight,2)),1)),0,30)) vcweight
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,round(vcmoney,0)),1)),4,12)) vcmoney
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,round(vccost,0)),1)),4,12)) vccost
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(profit,2)),1)),0,30)) profit

,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,round(lmount,0)),1)),4,12)) lmount
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(lweight,2)),1)),0,30)) lweight
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(lprice,2)),1)),0,30)) lprice
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,round(lmoney,0)),1)),4,12)) lmoney

from @tmp order by gno,pno;
--*********************************************************************************************
z_gen4:--z_gen4
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_bpno nvarchar(20)
	declare @t_epno nvarchar(20)

	set @t_bdate = case when '#non'=[2] then '' else [2] end
	set @t_edate = case when '#non'=[3] then char(255) else [3] end
	set @t_bpno = case when '#non'=[4] then '' else [4] end
	set @t_epno = case when '#non'=[5] then char(255) else [5] end
	
	--*****************************************************************************************	
declare @tmp table( 
	gno nvarchar(1),
	pno nvarchar(50),
	product nvarchar(50),
	unit nvarchar(10),
	mon nvarchar(10),
	datea nvarchar(10),
	item nvarchar(10),--排序用
	memo nvarchar(MAX),
	
	rcmount float, 
	rcweight float,
	rcprice float,
	rcmoney float,
	
	vcgmount float, 
	vcgweight float, 
	vcgcost float, 
	vcmoney float, 
	vcprice float,
	
	lmount float, 
	lweight float, 
	lprice float, 
	lmoney float
) 

--插入期初
--期初抓inas編號0000
--ina,get做調整用
--worka,workc,cut,cubt領料
--workb,workd,cuts,cubu生產
--rc2進貨--vcc銷貨
insert into @tmp (gno,pno,product,unit,mon,datea,item,memo,rcmount,rcweight,rcprice)
select '0',a.noa,a.product,a.unit,'000/00','000/00/00','1','上期結轉'
,isnull((select mount from view_inas[1] i where charindex('0000',i.noa)>0 and i.productno=a.noa),0)
+isnull((select sum(ib.mount) from view_ina[1] ia left join view_inas[1] ib on ia.noa=ib.noa where ia.datea<@t_bdate and ib.productno=a.noa and charindex('0000',ia.noa)=0),0)--ina
-isnull((select sum(gb.mount) from view_get[1] ga left join view_gets[1] gb on ga.noa=gb.noa where ga.datea<@t_bdate and gb.productno=a.noa),0)--get
-isnull((select sum((case when wa.typea='1' then 1 else -1 end)*wb.mount) from view_worka[1] wa left join view_workas[1] wb on wa.noa=wb.noa where wa.datea<@t_bdate and wb.productno=a.noa),0)--worka
--+isnull((select sum(wb.mount) from view_workb[1] wa left join view_workbs[1] wb on wa.noa=wb.noa where wa.datea<@t_bdate and wb.productno=a.noa),0)--workb
-isnull((select sum((case when wa.typea='1' then 1 else -1 end)*wb.mount) from view_workc[1] wa left join view_workcs[1] wb on wa.noa=wb.noa where wa.datea<@t_bdate and wb.productno=a.noa),0)--workc
--+isnull((select sum(wb.mount+wb.inmount-wb.outmount) from view_workd[1] wa left join view_workds[1] wb on wa.noa=wb.noa where wa.datea<@t_bdate and wb.productno=a.noa),0)--workd
-isnull((select sum(mount) from view_cut[1] where datea<@t_bdate and productno=a.noa),0)--cut
-isnull((select sum(cb.mount) from view_cub[1] ca left join view_cubt[1] cb on ca.noa=cb.noa where ca.datea<@t_bdate and cb.productno=a.noa),0)--cubt
--+isnull((select sum(cb.mount) from view_cut[1] ca left join view_cuts[1] cb on ca.noa=cb.noa where ca.datea<@t_bdate and cb.productno=a.noa),0)--cuts
--+isnull((select sum(cb.mount) from view_cub[1] ca left join view_cubu[1] cb on ca.noa=cb.noa where ca.datea<@t_bdate and cb.productno=a.noa),0)--cubu
+isnull((select sum((case when ra.typea='1' then 1 else -1 end)*rb.mount) from view_rc2[1] ra left join view_rc2s[1] rb on ra.noa=rb.noa where ra.datea<@t_bdate and rb.productno=a.noa),0)--rc2
-isnull((select sum((case when va.typea='1' then 1 else -1 end)*vb.mount) from view_vcc[1] va left join view_vccs[1] vb on va.noa=vb.noa where va.datea<@t_bdate and vb.productno=a.noa),0)--vcc
bigenmount
,isnull((select weight from view_inas[1] i where charindex('0000',i.noa)>0 and i.productno=a.noa),0)
+isnull((select sum(ib.weight) from view_ina[1] ia left join view_inas[1] ib on ia.noa=ib.noa where ia.datea<@t_bdate and ib.productno=a.noa and charindex('0000',ia.noa)=0),0)--ina
-isnull((select sum(gb.gweight) from view_get[1] ga left join view_gets[1] gb on ga.noa=gb.noa where ga.datea<@t_bdate and gb.productno=a.noa),0)--get
-isnull((select sum((case when wa.typea='1' then 1 else -1 end)*wb.weight) from view_worka[1] wa left join view_workas[1] wb on wa.noa=wb.noa where wa.datea<@t_bdate and wb.productno=a.noa),0)--worka
--+isnull((select sum(wb.weight) from view_workb[1] wa left join view_workbs[1] wb on wa.noa=wb.noa where wa.datea<@t_bdate and wb.productno=a.noa),0)--workb
-isnull((select sum((case when wa.typea='1' then 1 else -1 end)*wb.weight) from view_workc[1] wa left join view_workcs[1] wb on wa.noa=wb.noa where wa.datea<@t_bdate and wb.productno=a.noa),0)--workc
--+isnull((select sum(wb.weight) from view_workd[1] wa left join view_workds[1] wb on wa.noa=wb.noa where wa.datea<@t_bdate and wb.productno=a.noa),0)--workd
-isnull((select sum(gweight) from view_cut[1] where datea<@t_bdate and productno=a.noa),0)--cut
-isnull((select sum(cb.weight) from view_cub[1] ca left join view_cubt[1] cb on ca.noa=cb.noa where ca.datea<@t_bdate and cb.productno=a.noa),0)--cubt
--+isnull((select sum(cb.weight) from view_cut[1] ca left join view_cuts[1] cb on ca.noa=cb.noa where ca.datea<@t_bdate and cb.productno=a.noa),0)--cuts
--+isnull((select sum(cb.weight) from view_cub[1] ca left join view_cubu[1] cb on ca.noa=cb.noa where ca.datea<@t_bdate and cb.productno=a.noa),0)--cubu
+isnull((select sum((case when ra.typea='1' then 1 else -1 end)*rb.weight) from view_rc2[1] ra left join view_rc2s[1] rb on ra.noa=rb.noa where ra.datea<@t_bdate and rb.productno=a.noa),0)--rc2
-isnull((select sum((case when va.typea='1' then 1 else -1 end)*vb.weight) from view_vcc[1] va left join view_vccs[1] vb on va.noa=vb.noa where va.datea<@t_bdate and vb.productno=a.noa),0)--vcc
bigeweight
,case when 
	(isnull((select mount from view_inas[1] i where charindex('0000',i.noa)>0 and i.productno=a.noa),0)
	+isnull((select sum(ib.mount) from view_ina[1] ia left join view_inas[1] ib on ia.noa=ib.noa where ia.datea<@t_bdate and ib.productno=a.noa and charindex('0000',ia.noa)=0),0)--ina
	+isnull((select sum((case when ra.typea='1' then 1 else -1 end)*rb.mount) from view_rc2[1] ra left join view_rc2s[1] rb on ra.noa=rb.noa where ra.datea<@t_bdate and rb.productno=a.noa),0)--rc2
	)=0 
then 0 
else
	(isnull((select total from view_inas[1] i where charindex('0000',i.noa)>0 and i.productno=a.noa),0)
	+isnull((select sum(ib.total) from view_ina[1] ia left join view_inas[1] ib on ia.noa=ib.noa where ia.datea<@t_bdate and ib.productno=a.noa and charindex('0000',ia.noa)=0),0)--ina
	+isnull((select sum((case when ra.typea='1' then 1 else -1 end)*rb.total) from view_rc2[1] ra left join view_rc2s[1] rb on ra.noa=rb.noa where ra.datea<@t_bdate and rb.productno=a.noa),0)--rc2
	)/
	(isnull((select mount from view_inas[1] i where charindex('0000',i.noa)>0 and i.productno=a.noa),0)
	+isnull((select sum(ib.mount) from view_ina[1] ia left join view_inas[1] ib on ia.noa=ib.noa where ia.datea<@t_bdate and ib.productno=a.noa and charindex('0000',ia.noa)=0),0)--ina
	+isnull((select sum((case when ra.typea='1' then 1 else -1 end)*rb.mount) from view_rc2[1] ra left join view_rc2s[1] rb on ra.noa=rb.noa where ra.datea<@t_bdate and rb.productno=a.noa),0)--rc2
	)
end
bigenprice
from ucc a where (a.typea='4' or a.typea='5') --原物料
and (a.noa between @t_bpno and @t_epno) 

--更新金額
update @tmp
set rcmoney=rcprice*rcmount

update @tmp
set lmount=rcmount,lweight=rcweight,lmoney=rcmoney,lprice=rcprice

----插入進料
--ina調整用
insert into @tmp (gno,pno,product,unit,mon,datea,item,memo,rcmount,rcweight,rcprice,rcmoney)
select '1'gno,u.noa,u.product,u.unit,left(ia.datea,6),ia.datea,2,'進料 '+ia.noa,ib.mount,ib.weight,ib.price,ib.total
from view_ina[1] ia left join view_inas[1] ib on ia.noa=ib.noa left join ucc u on ib.productno=u.noa
where (u.typea='4' or u.typea='5') --原物料
and (u.noa between @t_bpno and @t_epno) 
and (ia.datea between @t_bdate and @t_edate)
--rc2
insert into @tmp (gno,pno,product,unit,mon,datea,item,memo,rcmount,rcweight,rcprice,rcmoney)
select '1'gno,u.noa,u.product,u.unit,left(ra.datea,6),ra.datea,2,'進料 '+ra.noa,rb.mount,rb.weight,rb.price,rb.total
from view_rc2[1] ra left join view_rc2s[1] rb on ra.noa=rb.noa left join ucc u on rb.productno=u.noa
where (u.typea='4' or u.typea='5') --原物料
and (u.noa between @t_bpno and @t_epno) 
and (ra.datea between @t_bdate and @t_edate)
and ra.typea='1'

insert into @tmp (gno,pno,product,unit,mon,datea,item,memo,rcmount,rcweight,rcprice,rcmoney)
select '1'gno,u.noa,u.product,u.unit,left(ra.datea,6),ra.datea,3,'進料退出 '+ra.noa,-1*rb.mount,-1*rb.weight,rb.price,-1*rb.total
from view_rc2[1] ra left join view_rc2s[1] rb on ra.noa=rb.noa left join ucc u on rb.productno=u.noa
where (u.typea='4' or u.typea='5') --原物料
and (u.noa between @t_bpno and @t_epno) 
and (ra.datea between @t_bdate and @t_edate)
and ra.typea!='1' and rb.mount!=0 and rb.weight!=0

insert into @tmp (gno,pno,product,unit,mon,datea,item,memo,rcmount,rcweight,rcprice,rcmoney)
select '1'gno,u.noa,u.product,u.unit,left(ra.datea,6),ra.datea,3,'進料折讓 '+ra.noa,rb.mount,rb.weight,rb.price,-1*rb.total
from view_rc2[1] ra left join view_rc2s[1] rb on ra.noa=rb.noa left join ucc u on rb.productno=u.noa
where (u.typea='4' or u.typea='5') --原物料
and (u.noa between @t_bpno and @t_epno) 
and (ra.datea between @t_bdate and @t_edate)
and ra.typea!='1' and rb.mount=0 and rb.weight=0


--插入領用
--get調整用
insert into @tmp (gno,pno,product,unit,mon,datea,item,memo,vcgmount,vcgweight)
select '1'gno,u.noa,u.product,u.unit,left(ga.datea,6),ga.datea,5,'領料 '+ga.noa,gb.mount,gb.weight
from view_get[1] ga left join view_gets[1] gb on ga.noa=gb.noa left join ucc u on gb.productno=u.noa
where (u.typea='4' or u.typea='5') --原物料
and (u.noa between @t_bpno and @t_epno) 
and (ga.datea between @t_bdate and @t_edate)
--worka
insert into @tmp (gno,pno,product,unit,mon,datea,item,memo,vcgmount,vcgweight)
select '1'gno,u.noa,u.product,u.unit,left(wa.datea,6),wa.datea,5,'領料 '+wa.noa,wb.mount,wb.weight
from view_worka[1] wa left join view_workas[1] wb on wa.noa=wb.noa left join ucc u on wb.productno=u.noa
where (u.typea='4' or u.typea='5') --原物料
and wa.typea='1'
and (u.noa between @t_bpno and @t_epno) 
and (wa.datea between @t_bdate and @t_edate)
--workc
insert into @tmp (gno,pno,product,unit,mon,datea,item,memo,vcgmount,vcgweight)
select '1'gno,u.noa,u.product,u.unit,left(wa.datea,6),wa.datea,5,'領料 '+wa.noa,wb.mount,wb.weight
from view_workc[1] wa left join view_workcs[1] wb on wa.noa=wb.noa left join ucc u on wb.productno=u.noa
where (u.typea='4' or u.typea='5') --原物料
and wa.typea='1'
and (u.noa between @t_bpno and @t_epno) 
and (wa.datea between @t_bdate and @t_edate)
--cut
insert into @tmp (gno,pno,product,unit,mon,datea,item,memo,vcgmount,vcgweight)
select '1'gno,u.noa,u.product,u.unit,left(ca.datea,6),ca.datea,5,'領料 '+ca.noa,ca.mount,ca.gweight
from view_cut[1] ca left join ucc u on ca.productno=u.noa
where (u.typea='4' or u.typea='5') --原物料
and (u.noa between @t_bpno and @t_epno) 
and (ca.datea between @t_bdate and @t_edate)
--cubt
insert into @tmp (gno,pno,product,unit,mon,datea,item,memo,vcgmount,vcgweight)
select '1'gno,u.noa,u.product,u.unit,left(ca.datea,6),ca.datea,5,'領料 '+ca.noa,cb.mount,cb.gweight
from view_cub[1] ca left join view_cubt[1] cb on ca.noa=cb.noa left join ucc u on cb.productno=u.noa
where (u.typea='4' or u.typea='5') --原物料
and (u.noa between @t_bpno and @t_epno) 
and (ca.datea between @t_bdate and @t_edate)
--vcc
insert into @tmp (gno,pno,product,unit,mon,datea,item,memo,vcgmount,vcgweight,vcmoney,vcprice)
select '1'gno,u.noa,u.product,u.unit,left(va.datea,6),va.datea,6,'直接銷售 '+va.noa,vb.mount,vb.weight,vb.total,vb.price
from view_vcc[1] va left join view_vccs[1] vb on va.noa=vb.noa left join ucc u on vb.productno=u.noa
where (u.typea='4' or u.typea='5') --原物料
and (u.noa between @t_bpno and @t_epno) 
and (va.datea between @t_bdate and @t_edate)
and va.typea='1'

--插入月份合計
insert into @tmp
select '2',pno,product,unit,mon,'','','本月合計'
,SUM(rcmount),SUM(rcweight),null,SUM(rcmoney) 
,SUM(vcgmount),SUM(vcgweight),SUM(vcgcost),SUM(vcmoney),null,null,null,null,null
from @tmp where gno='1' group by pno,product,unit,mon

--插入產品合計
insert into @tmp 
select '3',pno,product,unit,'999/99','','','合計' 
,SUM(rcmount),SUM(rcweight),null,SUM(rcmoney) 
,SUM(vcgmount),SUM(vcgweight),SUM(vcgcost),SUM(vcmoney),null,null,null,null,null 
from @tmp where gno='2' group by pno,product,unit 

insert into @tmp 
select '3',pno,product,unit,'999/99','','','合計' 
,SUM(rcmount),SUM(rcweight),null,SUM(rcmoney) 
,SUM(vcgmount),SUM(vcgweight),SUM(vcgcost),SUM(vcmoney),null,null,null,null,null 
from @tmp where gno='0'
and pno+product+unit not in (select pno+product+unit from @tmp where gno='3')
group by pno,product,unit 


declare @gno nvarchar(1),@pno nvarchar(50),@product nvarchar(50),@unit nvarchar(10),
	@mon nvarchar(10),@datea nvarchar(10),@item nvarchar(10),@memo nvarchar(max),
	@rcmount float,@rcweight float,@rcprice float,@rcmoney float,
	@vcgmount float,@vcgweight float,@vcgcost float,@vcmoney float,@vcprice float,
	@lmount float,@lweight float,@lprice float,@lmoney float
	
declare @t_price float,@t_mount float,@t_weight float,@t_money float

declare cursor_table cursor for 
select * from @tmp order by pno,mon,gno,datea,item
open cursor_table 
fetch next from cursor_table 
into @gno,@pno,@product,@unit,@mon,@datea,@item,@memo,@rcmount,@rcweight,@rcprice,@rcmoney,
@vcgmount,@vcgweight,@vcgcost,@vcmoney,@vcprice,@lmount,@lweight,@lprice,@lmoney
while(@@FETCH_STATUS <> -1) 
begin 
	if(@gno=0)
	begin
		set @t_price=@lprice
		set @t_mount=@lmount
		set @t_weight=@lweight
		set @t_money=@lmoney
	end
	else
	begin
		if(charindex('進料',@memo)>0)
		begin
			set @t_mount=@t_mount+@rcmount
			set @t_weight=@t_weight+@rcweight
			set @t_money=@t_money+@rcmoney
			set @t_price=case when @t_money=0 then 0 else @t_money/@t_mount end
			
			update @tmp
			set lmount=@t_mount,lweight=@t_weight,lmoney=@t_money,lprice=@t_price
			where datea=@datea and pno=@pno and memo=@memo
		end
		
		if(charindex('領料',@memo)>0 or charindex('直接銷售',@memo)>0)
		begin
			set @t_mount=@t_mount-@vcgmount
			set @t_weight=@t_weight-@vcgweight
			set @vcgcost=@t_price* @vcgmount
			set @t_money=@t_money-@vcgcost
			set @t_price=case when @t_money=0 then 0 else @t_money/@t_mount end
			
			update @tmp
			set lmount=@t_mount,lweight=@t_weight,lmoney=@t_money,lprice=@t_price,vcgcost=@vcgcost
			where datea=@datea and pno=@pno and memo=@memo
		end
		
		if(@gno='3' or @gno='2')
		begin
			update @tmp
			set lmount=@t_mount,lweight=@t_weight,lmoney=@t_money,lprice=@t_price,vcgcost=@vcgcost
			where datea=@datea and pno=@pno and memo=@memo
		end
		
	end
	
	fetch next from cursor_table 
	into @gno,@pno,@product,@unit,@mon,@datea,@item,@memo,@rcmount,@rcweight,@rcprice,@rcmoney,
	@vcgmount,@vcgweight,@vcgcost,@vcmoney,@vcprice,@lmount,@lweight,@lprice,@lmoney
end 
close cursor_table 
deallocate cursor_table 


select gno,pno,product,unit,mon,datea,item,memo

,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(rcmount,2)),1)),0,30)) rcmount
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(rcweight,2)),1)),0,30)) rcweight
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(rcprice,2)),1)),0,30)) rcprice
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(rcmoney,2)),1)),0,30)) rcmoney

,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(vcgmount,2)),1)),0,30)) vcgmount
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(vcgweight,2)),1)),0,30)) vcgweight
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(vcgcost,2)),1)),0,30)) vcgcost
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(vcmoney,2)),1)),0,30)) vcmoney
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(vcprice,2)),1)),0,30)) vcprice

,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(lmount,2)),1)),0,30)) lmount
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(lweight,2)),1)),0,30)) lweight
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(lprice,2)),1)),0,30)) lprice
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(lmoney,2)),1)),0,30)) lmoney

from @tmp order by pno,mon,gno,datea,item;
--*********************************************************************************************
z_gen5:--z_gen5
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_bpno nvarchar(20)
	declare @t_epno nvarchar(20)

	set @t_bdate = case when '#non'=[2] then '' else [2] end
	set @t_edate = case when '#non'=[3] then char(255) else [3] end
	set @t_bpno = case when '#non'=[4] then '' else [4] end
	set @t_epno = case when '#non'=[5] then char(255) else [5] end
	
	--*****************************************************************************************	
declare @tmp table( 
	gno nvarchar(1),
	pno nvarchar(50),
	product nvarchar(50),
	unit nvarchar(10),
	mon nvarchar(10),
	datea nvarchar(10),
	item nvarchar(10),--排序用
	memo nvarchar(MAX),
	
	bmount float, 
	bweight float,
	bprice float,
	bmoney float,
	
	vcmount float, 
	vcweight float, 
	vccost float, 
	vcmoney float, 
	vcprice float,
	
	lmount float, 
	lweight float, 
	lprice float, 
	lmoney float
) 

--插入期初
--期初抓inas編號0000
--ina,get做調整用
--worka,workc,cut,cubt領料
--workb,workd,cuts,cubu生產
--rc2進貨--vcc銷貨
insert into @tmp (gno,pno,product,unit,mon,datea,item,memo,bmount,bweight,bprice)
select '0',a.noa,a.product,a.unit,'000/00','000/00/00','1','上期結轉'
,isnull((select mount from view_inas[1] i where charindex('0000',i.noa)>0 and i.productno=a.noa),0)
+isnull((select sum(ib.mount) from view_ina[1] ia left join view_inas[1] ib on ia.noa=ib.noa where ia.datea<@t_bdate and ib.productno=a.noa and charindex('0000',ia.noa)=0),0)--ina
-isnull((select sum(gb.mount) from view_get[1] ga left join view_gets[1] gb on ga.noa=gb.noa where ga.datea<@t_bdate and gb.productno=a.noa),0)--get
-isnull((select sum((case when wa.typea='1' then 1 else -1 end)*wb.mount) from view_worka[1] wa left join view_workas[1] wb on wa.noa=wb.noa where wa.datea<@t_bdate and wb.productno=a.noa),0)--worka
+isnull((select sum(wb.mount) from view_workb[1] wa left join view_workbs[1] wb on wa.noa=wb.noa where wa.datea<@t_bdate and wb.productno=a.noa),0)--workb
-isnull((select sum((case when wa.typea='1' then 1 else -1 end)*wb.mount) from view_workc[1] wa left join view_workcs[1] wb on wa.noa=wb.noa where wa.datea<@t_bdate and wb.productno=a.noa),0)--workc
+isnull((select sum(wb.mount+wb.inmount-wb.outmount) from view_workd[1] wa left join view_workds[1] wb on wa.noa=wb.noa where wa.datea<@t_bdate and wb.productno=a.noa),0)--workd
-isnull((select sum(mount) from view_cut[1] where datea<@t_bdate and productno=a.noa),0)--cut
-isnull((select sum(cb.mount) from view_cub[1] ca left join view_cubt[1] cb on ca.noa=cb.noa where ca.datea<@t_bdate and cb.productno=a.noa),0)--cubt
+isnull((select sum(cb.mount) from view_cut[1] ca left join view_cuts[1] cb on ca.noa=cb.noa where ca.datea<@t_bdate and cb.productno=a.noa),0)--cuts
+isnull((select sum(cb.mount) from view_cub[1] ca left join view_cubu[1] cb on ca.noa=cb.noa where ca.datea<@t_bdate and cb.productno=a.noa),0)--cubu
+isnull((select sum((case when ra.typea='1' then 1 else -1 end)*rb.mount) from view_rc2[1] ra left join view_rc2s[1] rb on ra.noa=rb.noa where ra.datea<@t_bdate and rb.productno=a.noa),0)--rc2
-isnull((select sum((case when va.typea='1' then 1 else -1 end)*vb.mount) from view_vcc[1] va left join view_vccs[1] vb on va.noa=vb.noa where va.datea<@t_bdate and vb.productno=a.noa),0)--vcc
bigenmount
,isnull((select weight from view_inas[1] i where charindex('0000',i.noa)>0 and i.productno=a.noa),0)
+isnull((select sum(ib.weight) from view_ina[1] ia left join view_inas[1] ib on ia.noa=ib.noa where ia.datea<@t_bdate and ib.productno=a.noa and charindex('0000',ia.noa)=0),0)--ina
-isnull((select sum(gb.gweight) from view_get[1] ga left join view_gets[1] gb on ga.noa=gb.noa where ga.datea<@t_bdate and gb.productno=a.noa),0)--get
-isnull((select sum((case when wa.typea='1' then 1 else -1 end)*wb.weight) from view_worka[1] wa left join view_workas[1] wb on wa.noa=wb.noa where wa.datea<@t_bdate and wb.productno=a.noa),0)--worka
+isnull((select sum(wb.weight) from view_workb[1] wa left join view_workbs[1] wb on wa.noa=wb.noa where wa.datea<@t_bdate and wb.productno=a.noa),0)--workb
-isnull((select sum((case when wa.typea='1' then 1 else -1 end)*wb.weight) from view_workc[1] wa left join view_workcs[1] wb on wa.noa=wb.noa where wa.datea<@t_bdate and wb.productno=a.noa),0)--workc
+isnull((select sum(wb.weight) from view_workd[1] wa left join view_workds[1] wb on wa.noa=wb.noa where wa.datea<@t_bdate and wb.productno=a.noa),0)--workd
-isnull((select sum(gweight) from view_cut[1] where datea<@t_bdate and productno=a.noa),0)--cut
-isnull((select sum(cb.weight) from view_cub[1] ca left join view_cubt[1] cb on ca.noa=cb.noa where ca.datea<@t_bdate and cb.productno=a.noa),0)--cubt
+isnull((select sum(cb.weight) from view_cut[1] ca left join view_cuts[1] cb on ca.noa=cb.noa where ca.datea<@t_bdate and cb.productno=a.noa),0)--cuts
+isnull((select sum(cb.weight) from view_cub[1] ca left join view_cubu[1] cb on ca.noa=cb.noa where ca.datea<@t_bdate and cb.productno=a.noa),0)--cubu
+isnull((select sum((case when ra.typea='1' then 1 else -1 end)*rb.weight) from view_rc2[1] ra left join view_rc2s[1] rb on ra.noa=rb.noa where ra.datea<@t_bdate and rb.productno=a.noa),0)--rc2
-isnull((select sum((case when va.typea='1' then 1 else -1 end)*vb.weight) from view_vcc[1] va left join view_vccs[1] vb on va.noa=vb.noa where va.datea<@t_bdate and vb.productno=a.noa),0)--vcc
bigeweight
,case when 
	(isnull((select mount from view_inas[1] i where charindex('0000',i.noa)>0 and i.productno=a.noa),0)
	+isnull((select sum(ib.mount) from view_ina[1] ia left join view_inas[1] ib on ia.noa=ib.noa where ia.datea<@t_bdate and ib.productno=a.noa and charindex('0000',ia.noa)=0),0)--ina
	+isnull((select sum((case when ra.typea='1' then 1 else -1 end)*rb.mount) from view_rc2[1] ra left join view_rc2s[1] rb on ra.noa=rb.noa where ra.datea<@t_bdate and rb.productno=a.noa),0)--rc2
	
	+isnull((select sum(wb.mount) from view_workb[1] wa left join view_workbs[1] wb on wa.noa=wb.noa where wa.datea<@t_bdate and wb.productno=a.noa),0)--workb
	+isnull((select sum(wb.mount+wb.inmount-wb.outmount) from view_workd[1] wa left join view_workds[1] wb on wa.noa=wb.noa where wa.datea<@t_bdate and wb.productno=a.noa),0)--workd
	+isnull((select sum(cb.mount) from view_cut[1] ca left join view_cuts[1] cb on ca.noa=cb.noa where ca.datea<@t_bdate and cb.productno=a.noa),0)--cuts
	+isnull((select sum(cb.mount) from view_cub[1] ca left join view_cubu[1] cb on ca.noa=cb.noa where ca.datea<@t_bdate and cb.productno=a.noa),0)--cubu
	)=0 
then 0 
else
	(isnull((select total from view_inas[1] i where charindex('0000',i.noa)>0 and i.productno=a.noa),0)
	+isnull((select sum(ib.total) from view_ina[1] ia left join view_inas[1] ib on ia.noa=ib.noa where ia.datea<@t_bdate and ib.productno=a.noa and charindex('0000',ia.noa)=0),0)--ina
	+isnull((select sum((case when ra.typea='1' then 1 else -1 end)*rb.total) from view_rc2[1] ra left join view_rc2s[1] rb on ra.noa=rb.noa where ra.datea<@t_bdate and rb.productno=a.noa),0)--rc2
	+isnull((select sum(wc.costa+wc.costb+wc.costc+wc.costd)  from view_workb[1] wa left join view_workbs[1] wb on wa.noa=wb.noa left join wcost[1] wc on wb.noa=wc.noa and wb.productno=wc.productno
	where wa.datea<@t_bdate and wb.productno=a.noa)
	,0)--workb
	+isnull((select sum(wc.costa+wc.costb+wc.costc+wc.costd)  from view_workd[1] wa left join view_workds[1] wb on wa.noa=wb.noa left join wcost[1] wc on wb.noa=wc.noa and wb.productno=wc.productno
	where wa.datea<@t_bdate and wb.productno=a.noa)
	,0)--workd
	+isnull((select sum(cb.mount) from view_cut[1] ca left join view_cuts[1] cb on ca.noa=cb.noa where ca.datea<@t_bdate and cb.productno=a.noa)
	*(select case when beginmount=0 then 0 else beginmoney/beginmount end from costs where mon=LEFT(@t_bdate,6) and productno=a.noa)
	,0)--cuts
	+isnull((select sum(cb.mount)from view_cub[1] ca left join view_cubu[1] cb on ca.noa=cb.noa where ca.datea<@t_bdate and cb.productno=a.noa)
	*(select case when beginmount=0 then 0 else beginmoney/beginmount end from costs where mon=LEFT(@t_bdate,6) and productno=a.noa)
	,0)--cubu
	)/
	(isnull((select mount from view_inas[1] i where charindex('0000',i.noa)>0 and i.productno=a.noa),0)
	+isnull((select sum(ib.mount) from view_ina[1] ia left join view_inas[1] ib on ia.noa=ib.noa where ia.datea<@t_bdate and ib.productno=a.noa and charindex('0000',ia.noa)=0),0)--ina
	+isnull((select sum((case when ra.typea='1' then 1 else -1 end)*rb.mount) from view_rc2[1] ra left join view_rc2s[1] rb on ra.noa=rb.noa where ra.datea<@t_bdate and rb.productno=a.noa),0)--rc2
	
	+isnull((select sum(wb.mount) from view_workb[1] wa left join view_workbs[1] wb on wa.noa=wb.noa where wa.datea<@t_bdate and wb.productno=a.noa),0)--workb
	+isnull((select sum(wb.mount+wb.inmount-wb.outmount) from view_workd[1] wa left join view_workds[1] wb on wa.noa=wb.noa where wa.datea<@t_bdate and wb.productno=a.noa),0)--workd
	+isnull((select sum(cb.mount) from view_cut[1] ca left join view_cuts[1] cb on ca.noa=cb.noa where ca.datea<@t_bdate and cb.productno=a.noa),0)--cuts
	+isnull((select sum(cb.mount) from view_cub[1] ca left join view_cubu[1] cb on ca.noa=cb.noa where ca.datea<@t_bdate and cb.productno=a.noa),0)--cubu
	)
end
bigenprice
from (select noa,product,unit,typea from ucc union select noa,product,unit,(case when typea='1' then '2' else '1' end)typea from uca where noa not in (select noa from ucc)) a where (a.typea='2' or a.typea='6' or a.typea='7') --製成品&下腳品&加工
and (a.noa between @t_bpno and @t_epno) 


--更新金額
update @tmp
set bmoney=bprice*bmount

update @tmp
set lmount=bmount,lmoney=bmoney,lprice=bprice


----插入生產
--workb
insert into @tmp (gno,pno,product,unit,mon,datea,item,memo,bmount,bweight,bprice,bmoney)
select '1'gno,u.noa,u.product,u.unit,left(wa.datea,6),wa.datea,2,'生產 '+wa.noa,wb.mount,wb.weight
,isnull((select (wc.costa+wc.costb+wc.costc+wc.costd)/wc.mount from wcost[1] wc where wc.noa=wb.noa and wc.productno=wb.productno ),0) price
,isnull((select (wc.costa+wc.costb+wc.costc+wc.costd) from wcost[1] wc where wc.noa=wb.noa and wc.productno=wb.productno ),0)
from view_workb[1] wa left join view_workbs[1] wb on wa.noa=wb.noa left join 
(select noa,product,unit,typea from ucc union select noa,product,unit,(case when typea='1' then '2' else '1' end)typea from uca) u on wb.productno=u.noa
where (u.typea='2' or u.typea='6' or u.typea='7') --製成品&下腳品&加工
and (u.noa between @t_bpno and @t_epno) 
and (wa.datea between @t_bdate and @t_edate)

--workd
insert into @tmp (gno,pno,product,unit,mon,datea,item,memo,bmount,bweight,bprice,bmoney)
select '1'gno,u.noa,u.product,u.unit,left(wa.datea,6),wa.datea,2,'委外生產 '+wa.noa,wb.mount+wb.inmount-wb.outmount,wb.weight
,isnull((select (wc.costa+wc.costb+wc.costc+wc.costd)/wc.mount from wcost[1] wc where wc.noa=wb.noa and wc.productno=wb.productno ),0) price
,isnull((select (wc.costa+wc.costb+wc.costc+wc.costd) from wcost[1] wc where wc.noa=wb.noa and wc.productno=wb.productno ),0)
from view_workd[1] wa left join view_workds[1] wb on wa.noa=wb.noa left join 
(select noa,product,unit,typea from ucc union select noa,product,unit,(case when typea='1' then '2' else '1' end)typea from uca) u on wb.productno=u.noa
where (u.typea='2' or u.typea='6' or u.typea='7') --製成品&下腳品&加工
and (u.noa between @t_bpno and @t_epno) 
and (wa.datea between @t_bdate and @t_edate)

--cuts
insert into @tmp (gno,pno,product,unit,mon,datea,item,memo,bmount,bweight,bprice,bmoney)
select '1'gno,u.noa,u.product,u.unit,left(ca.datea,6),ca.datea,2,'裁剪生產 '+ca.noa,cb.mount,cb.weight
,(select price from costs[1] cs where cs.mon=left(ca.datea,6) and cs.productno=u.noa) price
,cb.mount*(select price from costs[1] cs where cs.mon=left(ca.datea,6) and cs.productno=u.noa)
from view_cut[1] ca left join view_cuts[1] cb on ca.noa=cb.noa left join 
(select noa,product,unit,typea from ucc union select noa,product,unit,(case when typea='1' then '2' else '1' end)typea from uca) u on cb.productno=u.noa
where (u.typea='2' or u.typea='6' or u.typea='7') --製成品&下腳品&加工
and (u.noa between @t_bpno and @t_epno) 
and (ca.datea between @t_bdate and @t_edate)

--cubu
insert into @tmp (gno,pno,product,unit,mon,datea,item,memo,bmount,bweight,bprice,bmoney)
select '1'gno,u.noa,u.product,u.unit,left(ca.datea,6),ca.datea,2,'配料生產 '+ca.noa,cb.mount,cb.weight
,(select price from costs[1] cs where cs.mon=left(ca.datea,6) and cs.productno=u.noa) price
,cb.mount *(select price from costs[1] cs where cs.mon=left(ca.datea,6) and cs.productno=u.noa)
from view_cub[1] ca left join view_cubu[1] cb on ca.noa=cb.noa left join 
(select noa,product,unit,typea from ucc union select noa,product,unit,(case when typea='1' then '2' else '1' end)typea from uca) u on cb.productno=u.noa
where (u.typea='2' or u.typea='6' or u.typea='7') --製成品&下腳品&加工
and (u.noa between @t_bpno and @t_epno) 
and (ca.datea between @t_bdate and @t_edate)

----插入報廢
insert into @tmp (gno,pno,product,unit,mon,datea,item,memo,bmount,bweight,bprice,bmoney)
select '1'gno,u.noa,u.product,u.unit,left(wa.datea,6),wa.datea,6,'報廢 '+wa.noa,-1*wa.discardmount,-1*wa.discardmount
,(select price from costs[1] cs where cs.mon=left(wa.datea,6) and cs.productno=u.noa)
, -1*wa.discardmount *(select price from costs[1] cs where cs.mon=left(wa.datea,6) and cs.productno=u.noa) money
from view_workx[1] wa left join 
(select noa,product,unit,typea from ucc union select noa,product,unit,(case when typea='1' then '2' else '1' end)typea from uca) u on wa.productno=u.noa
where (u.typea='2' or u.typea='6' or u.typea='7') --製成品&下腳品&加工
and (u.noa between @t_bpno and @t_epno) 
and (wa.datea between @t_bdate and @t_edate)


----插入銷售
--vcc
insert into @tmp (gno,pno,product,unit,mon,datea,item,memo,vcmount,vcweight,vcmoney,vcprice)
select '1'gno,u.noa,u.product,u.unit,left(va.datea,6),va.datea,3,'銷售 '+va.noa,vb.mount,vb.weight,vb.total,vb.price
from view_vcc[1] va left join view_vccs[1] vb on va.noa=vb.noa left join 
(select noa,product,unit,typea from ucc union select noa,product,unit,(case when typea='1' then '2' else '1' end)typea from uca) u on vb.productno=u.noa
where (u.typea='2' or u.typea='6' or u.typea='7') --製成品&下腳品&加工
and (u.noa between @t_bpno and @t_epno) 
and (va.datea between @t_bdate and @t_edate)
and va.typea='1' and vb.mount!=0 --and vb.weight!=0

insert into @tmp (gno,pno,product,unit,mon,datea,item,memo,vcmount,vcweight,vcmoney,vcprice)
select '1'gno,u.noa,u.product,u.unit,left(va.datea,6),va.datea,4,'退回 '+va.noa,-1*vb.mount,-1*vb.weight,-1*vb.total,vb.price
from view_vcc[1] va left join view_vccs[1] vb on va.noa=vb.noa left join 
(select noa,product,unit,typea from ucc union select noa,product,unit,(case when typea='1' then '2' else '1' end)typea from uca) u on vb.productno=u.noa
where (u.typea='2' or u.typea='6' or u.typea='7') --製成品&下腳品&加工
and (u.noa between @t_bpno and @t_epno) 
and (va.datea between @t_bdate and @t_edate)
and va.typea!='1' and vb.mount!=0 --and vb.weight!=0

insert into @tmp (gno,pno,product,unit,mon,datea,item,memo,vcmount,vcweight,vcmoney,vcprice)
select '1'gno,u.noa,u.product,u.unit,left(va.datea,6),va.datea,5,'折讓 '+va.noa,-1*vb.mount,-1*vb.weight,-1*vb.total,vb.price
from view_vcc[1] va left join view_vccs[1] vb on va.noa=vb.noa left join 
(select noa,product,unit,typea from ucc union select noa,product,unit,(case when typea='1' then '2' else '1' end)typea from uca) u on vb.productno=u.noa
where (u.typea='2' or u.typea='6' or u.typea='7') --製成品&下腳品&加工
and (u.noa between @t_bpno and @t_epno) 
and (va.datea between @t_bdate and @t_edate)
and va.typea!='1' and vb.mount=0 --and vb.weight=0

--插入月份合計
insert into @tmp
select '2',pno,product,unit,mon,'','','本月合計'
,SUM(bmount),SUM(bweight),null,SUM(bmoney) 
,SUM(vcmount),SUM(vcweight),SUM(vccost),SUM(vcmoney),null,null,null,null,null
from @tmp where gno='1' group by pno,product,unit,mon

--插入產品合計
insert into @tmp 
select '3',pno,product,unit,'999/99','','','合計' 
,SUM(bmount),SUM(bweight),null,SUM(bmoney) 
,SUM(vcmount),SUM(vcweight),SUM(vccost),SUM(vcmoney),null,null,null,null,null 
from @tmp where gno='2' group by pno,product,unit 

insert into @tmp 
select '3',pno,product,unit,'999/99','','','合計' 
,SUM(bmount),SUM(bweight),null,SUM(bmoney) 
,SUM(vcmount),SUM(vcweight),SUM(vccost),SUM(vcmoney),null,null,null,null,null 
from @tmp where gno='0'
and pno+product+unit not in (select pno+product+unit from @tmp where gno='3')
group by pno,product,unit 


declare @gno nvarchar(1),@pno nvarchar(50),@product nvarchar(50),@unit nvarchar(10),
	@mon nvarchar(10),@datea nvarchar(10),@item nvarchar(10),@memo nvarchar(max),
	@bmount float,@bweight float,@bprice float,@bmoney float,
	@vcmount float,@vcweight float,@vccost float,@vcmoney float,@vcprice float,
	@lmount float,@lweight float,@lprice float,@lmoney float
	
declare @t_price float,@t_mount float,@t_weight float,@t_money float

declare cursor_table cursor for 
select * from @tmp order by pno,mon,gno,datea,item
open cursor_table 
fetch next from cursor_table 
into @gno,@pno,@product,@unit,@mon,@datea,@item,@memo,@bmount,@bweight,@bprice,@bmoney,
@vcmount,@vcweight,@vccost,@vcmoney,@vcprice,@lmount,@lweight,@lprice,@lmoney
while(@@FETCH_STATUS <> -1) 
begin 
	if(@gno=0)
	begin
		set @t_price=@lprice
		set @t_mount=@lmount
		set @t_weight=@lweight
		set @t_money=@lmoney
	end
	else
	begin
		if(charindex('生產',@memo)>0 or charindex('報廢',@memo)>0)
		begin
			set @t_mount=@t_mount+@bmount
			set @t_weight=@t_weight+@bweight
			set @t_money=@t_money+@bmoney
			set @t_price=case when @t_money=0 then 0 else @t_money/@t_mount  end
			
			update @tmp
			set lmount=@t_mount,lweight=@t_weight,lmoney=@t_money,lprice=@t_price
			where datea=@datea and pno=@pno and memo=@memo
		end
		
		if(charindex('銷售',@memo)>0 or charindex('退回',@memo)>0 or charindex('折讓',@memo)>0)
		begin
			set @t_mount=@t_mount-@vcmount
			set @t_weight=@t_weight-@vcweight
			set @vccost=@t_price*@vcmount
			set @t_money=@t_money-@vccost
			set @t_price=case when @t_money=0 then 0 else @t_money/@t_mount end
			
			update @tmp
			set lmount=@t_mount,lweight=@t_weight,lmoney=@t_money,lprice=@t_price,vccost=@vccost
			where datea=@datea and pno=@pno and memo=@memo
		end
	
		if(@gno='3' or @gno='2')
		begin
			update @tmp
			set lmount=@t_mount,lweight=@t_weight,lmoney=@t_money,lprice=@t_price,vccost=@vccost
			where mon=@mon and pno=@pno and memo=@memo
		end
	end
	
	fetch next from cursor_table 
	into @gno,@pno,@product,@unit,@mon,@datea,@item,@memo,@bmount,@bweight,@bprice,@bmoney,
	@vcmount,@vcweight,@vccost,@vcmoney,@vcprice,@lmount,@lweight,@lprice,@lmoney
end 
close cursor_table 
deallocate cursor_table 

select gno,pno,product,unit,mon,datea,item,memo

,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,round(bmount,0)),1)),4,12)) bmount
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(bweight,2)),1)),0,30)) bweight
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(bprice,2)),1)),0,30)) bprice
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,round(bmoney,0)),1)),4,12)) bmoney

,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,round(vcmount,0)),1)),4,12)) vcmount
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(vcweight,2)),1)),0,30)) vcweight
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,round(vccost,0)),1)),4,12)) vccost
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,round(vcmoney,0)),1)),4,12)) vcmoney
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(vcprice,2)),1)),0,30)) vcprice

,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,round(lmount,0)),1)),4,12)) lmount
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(lweight,2)),1)),0,30)) lweight
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(lprice,2)),1)),0,30)) lprice
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,round(lmoney,0)),1)),4,12)) lmoney

from @tmp order by pno,mon,gno,datea,item;
--*********************************************************************************************
z_gen6:--z_gen6
declare @bordeno nvarchar(30) 
declare @eordeno nvarchar(30) 

set @bordeno = case when '#non'=[6] then '' else [6] end
set @eordeno = case when '#non'=[7] then char(255) else [7] end

declare @end table(
	recno int identity(0,1),
	gno nvarchar(50),
	ordeno nvarchar(50),
	no2 nvarchar(50),
	productno nvarchar(50),
	product nvarchar(50),
	mount float,
	total float,
	inmount float,--入庫
	acost float,--原料成本
	bcost float,--人工成本
	ccost float,--費用成本
	dcost float,--委外成本
	cost float--成本
)

insert into @end
select '0',ob.noa,ob.no2,ob.productno,ob.product,ob.mount,ob.total,0,0,0,0,0,0
from view_orde102 oa left join view_ordes102 ob on oa.noa=ob.noa 
where oa.noa between @bordeno and @eordeno and ob.noa!=''

--更新入庫數量
update a
set inmount=isnull(c.mount,0)
from @end a
left JOIN view_work102 b on a.ordeno=b.ordeno and a.no2=b.no2 and a.productno=b.productno
left JOIN (
select workno,productno,SUM(mount)mount from(
select workno,productno,mount from view_workbs102 union all select workno,productno,mount+inmount-outmount from view_workds102
)tmp group by workno,productno
)c on b.noa=c.workno and a.productno=c.productno

--更新原料成本
update a
set acost=isnull(c.costa,0)
from @end a
left JOIN view_work102 b on a.ordeno=b.ordeno and a.no2=b.no2 and a.productno=b.productno
left JOIN (select workno,productno,SUM(costa)costa from wcost102 group by workno,productno) c on b.noa=c.workno and a.productno=c.productno

--更新人工成本
update a
set bcost=isnull(c.costb,0)
from @end a
left JOIN view_work102 b on a.ordeno=b.ordeno and a.no2=b.no2 and a.productno=b.productno
left JOIN (select workno,productno,SUM(costb)costb from wcost102 group by workno,productno) c on b.noa=c.workno and a.productno=c.productno

--更新費用成本
update a
set ccost=isnull(c.costc,0)
from @end a
left JOIN view_work102 b on a.ordeno=b.ordeno and a.no2=b.no2 and a.productno=b.productno
left JOIN (select workno,productno,SUM(costc)costc from wcost102 group by workno,productno) c on b.noa=c.workno and a.productno=c.productno

--更新委外成本
update a
set dcost=isnull(c.costd,0)
from @end a
left JOIN view_work102 b on a.ordeno=b.ordeno and a.no2=b.no2 and a.productno=b.productno
left JOIN (select workno,productno,SUM(costd)costd from wcost102 group by workno,productno) c on b.noa=c.workno and a.productno=c.productno

update @end
set cost=acost+bcost+ccost+dcost

select gno,ordeno,no2,productno pno,product
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,mount),1)),0,30)) mount
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,inmount),1)),0,30)) inmount
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,mount-inmount),1)),0,30)) unmount
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total),1)),4,12)) total
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(acost,2)),1)),0,30)) acost
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(bcost,2)),1)),0,30)) bcost
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(ccost,2)),1)),0,30)) ccost
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(dcost,2)),1)),0,30)) dcost
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(cost,2)),1)),0,30)) cost
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(total-cost,0)),1)),4,30)) rate
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(case when total!=0 then ((total-cost)/total)*100 else 0 end,2)),1)),0,30)) prate
from @end order by ordeno

;
----*******************************************************************************************
z_gen7:--z_gen7
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_bpno nvarchar(20)
	declare @t_epno nvarchar(20)
	declare @t_bordeno nvarchar(20)
	declare @t_eordeno nvarchar(20)
	declare @t_bcuano nvarchar(20)
	declare @t_ecuano nvarchar(20)
	declare @t_bworkno nvarchar(20)
	declare @t_eworkno nvarchar(20)
	declare @t_bmon nvarchar(10)
	declare @t_emon nvarchar(10)

	set @t_bdate = case when '#non'=[2] then '' else [2] end
	set @t_edate = case when '#non'=[3] then char(255) else [3] end
	set @t_bpno = case when '#non'=[4] then '' else [4] end
	set @t_epno = case when '#non'=[5] then char(255) else [5] end
	set @t_bordeno = case when '#non'=[6] then '' else [6] end
	set @t_eordeno = case when '#non'=[7] then char(255) else [7] end
	set @t_bcuano = case when '#non'=[8] then '' else [8] end
	set @t_ecuano = case when '#non'=[9] then char(255) else [9] end
	set @t_bworkno = case when '#non'=[10] then '' else [10] end
	set @t_eworkno = case when '#non'=[11] then char(255) else [11] end
	set @t_bmon = case when '#non'=[15] then '' else [15] end
	set @t_emon = case when '#non'=[16] then char(255) else [16] end
	
	--*****************************************************************************************	
	select '0'gno,a.datea,b.ordeno,a.workno,a.noa
	,(case when a.seq='1' then '領料' when a.seq='2' then '委出' when a.seq='3' then '入庫' when a.seq='4' then '委入' else '' end) typea
	,a.productno pno,u.product
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,a.mount),1)),0,30)) mount
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,a.costa),1)),0,30)) costa
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,a.costb),1)),0,30)) costb
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,a.costc),1)),0,30)) costc
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,a.costd),1)),0,30)) costd
	,REPLACE(REPLACE(REPLACE(a.memo,'B','</BR> B'),'C','</BR>C'),'D','</BR>D') memo
	,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,a.costa+a.costb+a.costc+a.costd),1)),0,30)) costt
	from wcost[1] a left join work[1] b on a.workno=b.noa
	left join (select noa,product from ucc union select noa,product from uca where noa not in (select noa from ucc) union select productno noa,productno+'在製品' from ucat where productno not in (select noa from uca)) u on a.productno=u.noa
	where (a.datea between @t_bdate and @t_edate) 
	and (a.productno between @t_bpno and @t_epno)
	and (b.ordeno between @t_bordeno and @t_eordeno)
	and (b.cuano between @t_bcuano and @t_ecuano)
	and (a.workno between @t_bworkno and @t_eworkno)
	and (a.mon between @t_bmon and @t_emon)
	order by a.datea,case when a.seq='2' then '3' when a.seq='3' then '2' else a.seq end,a.productno
;
	--*****************************************************************************************	
	z_gen8:--z_gen8
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_bpno nvarchar(20)
	declare @t_epno nvarchar(20)

	set @t_bdate = case when '#non'=[2] then '' else [2] end
	set @t_edate = case when '#non'=[3] then char(255) else [3] end
	set @t_bpno = case when '#non'=[4] then '' else [4] end
	set @t_epno = case when '#non'=[5] then char(255) else [5] end
	
	--*****************************************************************************************	
declare @tmp table( 
	gno nvarchar(1),
	pno nvarchar(50),
	product nvarchar(50),
	unit nvarchar(10),
	mon nvarchar(10),
	datea nvarchar(10),
	item nvarchar(10),--排序用
	memo nvarchar(MAX),
	
	rcmount float, 
	rcweight float,
	rcprice float,
	rcmoney float,

	vcmount float, 
	vcweight float, 
	vccost float, 
	vcmoney float, 
	vcprice float,
	
	lmount float, 
	lweight float, 
	lprice float, 
	lmoney float
) 

--插入期初
--期初抓inas編號0000
--ina,get做調整用
--worka,workc,cut,cubt領料
--workb,workd,cuts,cubu生產
--rc2進貨--vcc銷貨
insert into @tmp (gno,pno,product,unit,mon,datea,item,memo,rcmount,rcweight,rcprice)
select '0',a.noa,a.product,a.unit,'000/00','000/00/00','1','上期結轉'
,isnull((select mount from view_inas[1] i where charindex('0000',i.noa)>0 and i.productno=a.noa),0)
+isnull((select sum(ib.mount) from view_ina[1] ia left join view_inas[1] ib on ia.noa=ib.noa where ia.datea<@t_bdate and ib.productno=a.noa and charindex('0000',ia.noa)=0),0)--ina
-isnull((select sum(gb.mount) from view_get[1] ga left join view_gets[1] gb on ga.noa=gb.noa where ga.datea<@t_bdate and gb.productno=a.noa),0)--get
+isnull((select sum((case when ra.typea='1' then 1 else -1 end)*rb.mount) from view_rc2[1] ra left join view_rc2s[1] rb on ra.noa=rb.noa where ra.datea<@t_bdate and rb.productno=a.noa),0)--rc2
-isnull((select sum((case when va.typea='1' then 1 else -1 end)*vb.mount) from view_vcc[1] va left join view_vccs[1] vb on va.noa=vb.noa where va.datea<@t_bdate and vb.productno=a.noa),0)--vcc
bigenmount
,isnull((select weight from view_inas[1] i where charindex('0000',i.noa)>0 and i.productno=a.noa),0)
+isnull((select sum(ib.weight) from view_ina[1] ia left join view_inas[1] ib on ia.noa=ib.noa where ia.datea<@t_bdate and ib.productno=a.noa and charindex('0000',ia.noa)=0),0)--ina
-isnull((select sum(gb.gweight) from view_get[1] ga left join view_gets[1] gb on ga.noa=gb.noa where ga.datea<@t_bdate and gb.productno=a.noa),0)--get
+isnull((select sum((case when ra.typea='1' then 1 else -1 end)*rb.weight) from view_rc2[1] ra left join view_rc2s[1] rb on ra.noa=rb.noa where ra.datea<@t_bdate and rb.productno=a.noa),0)--rc2
-isnull((select sum((case when va.typea='1' then 1 else -1 end)*vb.weight) from view_vcc[1] va left join view_vccs[1] vb on va.noa=vb.noa where va.datea<@t_bdate and vb.productno=a.noa),0)--vcc
bigeweight
,case when 
	(isnull((select mount from view_inas[1] i where charindex('0000',i.noa)>0 and i.productno=a.noa),0)
	+isnull((select sum(ib.mount) from view_ina[1] ia left join view_inas[1] ib on ia.noa=ib.noa where ia.datea<@t_bdate and ib.productno=a.noa and charindex('0000',ia.noa)=0),0)--ina
	+isnull((select sum((case when ra.typea='1' then 1 else -1 end)*rb.mount) from view_rc2[1] ra left join view_rc2s[1] rb on ra.noa=rb.noa where ra.datea<@t_bdate and rb.productno=a.noa),0)--rc2
	)=0 
then 0 
else
	(isnull((select total from view_inas[1] i where charindex('0000',i.noa)>0 and i.productno=a.noa),0)
	+isnull((select sum(ib.total) from view_ina[1] ia left join view_inas[1] ib on ia.noa=ib.noa where ia.datea<@t_bdate and ib.productno=a.noa and charindex('0000',ia.noa)=0),0)--ina
	+isnull((select sum((case when ra.typea='1' then 1 else -1 end)*rb.total) from view_rc2[1] ra left join view_rc2s[1] rb on ra.noa=rb.noa where ra.datea<@t_bdate and rb.productno=a.noa),0)--rc2
	)/
	(isnull((select mount from view_inas[1] i where charindex('0000',i.noa)>0 and i.productno=a.noa),0)
	+isnull((select sum(ib.mount) from view_ina[1] ia left join view_inas[1] ib on ia.noa=ib.noa where ia.datea<@t_bdate and ib.productno=a.noa and charindex('0000',ia.noa)=0),0)--ina
	+isnull((select sum((case when ra.typea='1' then 1 else -1 end)*rb.mount) from view_rc2[1] ra left join view_rc2s[1] rb on ra.noa=rb.noa where ra.datea<@t_bdate and rb.productno=a.noa),0)--rc2
	)
end
bigenprice
from ucc a where (a.typea='1') --商品
and (a.noa between @t_bpno and @t_epno) 


--更新金額
update @tmp
set rcmoney=rcprice*rcmount

update @tmp
set lmount=rcmount,lweight=rcweight,lmoney=rcmoney,lprice=rcprice

--插入進貨
--rc2
insert into @tmp (gno,pno,product,unit,mon,datea,item,memo,rcmount,rcweight,rcprice,rcmoney)
select '1'gno,u.noa,u.product,u.unit,left(ra.datea,6),ra.datea,2,'進貨 '+ra.noa,rb.mount,rb.weight,rb.price,rb.total
from view_rc2[1] ra left join view_rc2s[1] rb on ra.noa=rb.noa left join ucc u on rb.productno=u.noa
where (u.typea='1' ) --商品
and (u.noa between @t_bpno and @t_epno) 
and (ra.datea between @t_bdate and @t_edate)
and ra.typea='1' and rb.mount!=0

insert into @tmp (gno,pno,product,unit,mon,datea,item,memo,rcmount,rcweight,rcprice,rcmoney)
select '1'gno,u.noa,u.product,u.unit,left(ra.datea,6),ra.datea,3,'進貨退出 '+ra.noa,-1*rb.mount,-1*rb.weight,rb.price,-1*rb.total
from view_rc2[1] ra left join view_rc2s[1] rb on ra.noa=rb.noa left join ucc u on rb.productno=u.noa
where (u.typea='1' ) --商品
and (u.noa between @t_bpno and @t_epno) 
and (ra.datea between @t_bdate and @t_edate)
and ra.typea!='1' and rb.mount!=0 --and rb.weight!=0

insert into @tmp (gno,pno,product,unit,mon,datea,item,memo,rcmount,rcweight,rcprice,rcmoney)
select '1'gno,u.noa,u.product,u.unit,left(ra.datea,6),ra.datea,3,'進貨折讓 '+ra.noa,rb.mount,rb.weight,rb.price,-1*rb.total
from view_rc2[1] ra left join view_rc2s[1] rb on ra.noa=rb.noa left join ucc u on rb.productno=u.noa
where (u.typea='1' ) --商品
and (u.noa between @t_bpno and @t_epno) 
and (ra.datea between @t_bdate and @t_edate)
and ra.typea!='1' and rb.mount=0 --and rb.weight=0

----插入銷售
--vcc
insert into @tmp (gno,pno,product,unit,mon,datea,item,memo,vcmount,vcweight,vcmoney,vcprice)
select '1'gno,u.noa,u.product,u.unit,left(va.datea,6),va.datea,3,'銷售 '+va.noa,vb.mount,vb.weight,vb.total,vb.price
from view_vcc[1] va left join view_vccs[1] vb on va.noa=vb.noa left join 
ucc u on vb.productno=u.noa
where (u.typea='1') --商品
and (u.noa between @t_bpno and @t_epno) 
and (va.datea between @t_bdate and @t_edate)
and va.typea='1' and vb.mount!=0 --and vb.weight!=0

insert into @tmp (gno,pno,product,unit,mon,datea,item,memo,vcmount,vcweight,vcmoney,vcprice)
select '1'gno,u.noa,u.product,u.unit,left(va.datea,6),va.datea,4,'退回 '+va.noa,-1*vb.mount,-1*vb.weight,-1*vb.total,vb.price
from view_vcc[1] va left join view_vccs[1] vb on va.noa=vb.noa left join 
ucc u on vb.productno=u.noa
where (u.typea='1') --商品
and (u.noa between @t_bpno and @t_epno) 
and (va.datea between @t_bdate and @t_edate)
and va.typea!='1' and vb.mount!=0 --and vb.weight!=0

insert into @tmp (gno,pno,product,unit,mon,datea,item,memo,vcmount,vcweight,vcmoney,vcprice)
select '1'gno,u.noa,u.product,u.unit,left(va.datea,6),va.datea,5,'折讓 '+va.noa,-1*vb.mount,-1*vb.weight,-1*vb.total,vb.price
from view_vcc[1] va left join view_vccs[1] vb on va.noa=vb.noa left join 
ucc u on vb.productno=u.noa
where (u.typea='1') --商品
and (u.noa between @t_bpno and @t_epno) 
and (va.datea between @t_bdate and @t_edate)
and va.typea!='1' and vb.mount=0 --and vb.weight=0

--插入月份合計
insert into @tmp
select '2',pno,product,unit,mon,'','','本月合計'
,SUM(rcmount),SUM(rcweight),null,SUM(rcmoney) 
,SUM(vcmount),SUM(vcweight),SUM(vccost),SUM(vcmoney),null,null,null,null,null
from @tmp where gno='1' group by pno,product,unit,mon

--插入產品合計
insert into @tmp 
select '3',pno,product,unit,'999/99','','','合計' 
,SUM(rcmount),SUM(rcweight),null,SUM(rcmoney) 
,SUM(vcmount),SUM(vcweight),SUM(vccost),SUM(vcmoney),null,null,null,null,null 
from @tmp where gno='2' group by pno,product,unit 

insert into @tmp 
select '3',pno,product,unit,'999/99','','','合計' 
,SUM(rcmount),SUM(rcweight),null,SUM(rcmoney) 
,SUM(vcmount),SUM(vcweight),SUM(vccost),SUM(vcmoney),null,null,null,null,null 
from @tmp where gno='0'
and pno+product+unit not in (select pno+product+unit from @tmp where gno='3')
group by pno,product,unit 

declare @gno nvarchar(1),@pno nvarchar(50),@product nvarchar(50),@unit nvarchar(10),
	@mon nvarchar(10),@datea nvarchar(10),@item nvarchar(10),@memo nvarchar(max),
	@bmount float,@bweight float,@bprice float,@bmoney float,
	@vcmount float,@vcweight float,@vccost float,@vcmoney float,@vcprice float,
	@lmount float,@lweight float,@lprice float,@lmoney float
	
declare @t_price float,@t_mount float,@t_weight float,@t_money float

declare cursor_table cursor for 
select * from @tmp order by pno,mon,gno,datea,item
open cursor_table 
fetch next from cursor_table 
into @gno,@pno,@product,@unit,@mon,@datea,@item,@memo,@bmount,@bweight,@bprice,@bmoney,
@vcmount,@vcweight,@vccost,@vcmoney,@vcprice,@lmount,@lweight,@lprice,@lmoney
while(@@FETCH_STATUS <> -1) 
begin 
	if(@gno=0)
	begin
		set @t_price=@lprice
		set @t_mount=@lmount
		set @t_weight=@lweight
		set @t_money=@lmoney
	end
	else
	begin
		if(charindex('進貨',@memo)>0 )
		begin
			set @t_mount=@t_mount+@bmount
			set @t_weight=@t_weight+@bweight
			set @t_money=@t_money+@bmoney
			set @t_price=case when @t_money=0 then 0 else @t_money/@t_mount  end
			
			update @tmp
			set lmount=@t_mount,lweight=@t_weight,lmoney=@t_money,lprice=@t_price
			where datea=@datea and pno=@pno and memo=@memo
		end
		
		if(charindex('銷售',@memo)>0 or charindex('退回',@memo)>0 or charindex('折讓',@memo)>0)
		begin
			set @t_mount=@t_mount-@vcmount
			set @t_weight=@t_weight-@vcweight
			set @vccost=@t_price*@vcmount
			set @t_money=@t_money-@vccost
			set @t_price=case when @t_money=0 then 0 else @t_money/@t_mount end
			
			update @tmp
			set lmount=@t_mount,lweight=@t_weight,lmoney=@t_money,lprice=@t_price,vccost=@vccost
			where datea=@datea and pno=@pno and memo=@memo
		end
	
		if(@gno='3' or @gno='2')
		begin
			update @tmp
			set lmount=@t_mount,lweight=@t_weight,lmoney=@t_money,lprice=@t_price,vccost=@vccost
			where datea=@datea and pno=@pno and memo=@memo
		end
	end
	
	fetch next from cursor_table 
	into @gno,@pno,@product,@unit,@mon,@datea,@item,@memo,@bmount,@bweight,@bprice,@bmoney,
	@vcmount,@vcweight,@vccost,@vcmoney,@vcprice,@lmount,@lweight,@lprice,@lmoney
end 
close cursor_table 
deallocate cursor_table 

select gno,pno,product,unit,mon,datea,item,memo

,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(rcmount,2)),1)),0,30)) rcmount
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(rcweight,2)),1)),0,30)) rcweight
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(rcprice,2)),1)),0,30)) rcprice
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(rcmoney,2)),1)),0,30)) rcmoney

,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,round(vcmount,0)),1)),4,12)) vcmount
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(vcweight,2)),1)),0,30)) vcweight
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,round(vccost,0)),1)),4,12)) vccost
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,round(vcmoney,0)),1)),4,12)) vcmoney
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(vcprice,2)),1)),0,30)) vcprice

,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,round(lmount,0)),1)),4,12)) lmount
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(lweight,2)),1)),0,30)) lweight
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(lprice,2)),1)),0,30)) lprice
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,round(lmoney,0)),1)),4,12)) lmoney

from @tmp order by pno,mon,gno,datea,item;

--*****************************************************************************************	
	z_gen9:--z_gen9
	declare @t_bpno nvarchar(20)
	declare @t_epno nvarchar(20)
	declare @t_xall nvarchar(10)
	declare @t_xdate nvarchar(10)

	set @t_bpno = case when '#non'=[4] then '' else [4] end
	set @t_epno = case when '#non'=[5] then char(255) else [5] end
	set @t_xall = case when '#non'=[12] then char(255) else [12] end
	set @t_xdate = case when '#non'=[14] then '' else [14] end
	
declare @tmp table( 
	gno nvarchar(1),
	typea nvarchar(50),
	pno nvarchar(50),
	product nvarchar(50),
	unit nvarchar(10),
	mount float, 
	weight float, 
	price float, 
	money float
) 

if(@t_xall='全部' or @t_xall='原物料')
	insert into @tmp (gno,typea,pno,product,unit,mount,weight,price)
	select '0','原物料',a.noa,a.product,a.unit
	,isnull((select mount from view_inas[1] i where charindex('0000',i.noa)>0 and i.productno=a.noa),0)
	+isnull((select sum(ib.mount) from view_ina[1] ia left join view_inas[1] ib on ia.noa=ib.noa where ia.datea<=@t_xdate and ib.productno=a.noa and charindex('0000',ia.noa)=0),0)--ina
	-isnull((select sum(gb.mount) from view_get[1] ga left join view_gets[1] gb on ga.noa=gb.noa where ga.datea<=@t_xdate and gb.productno=a.noa),0)--get
	-isnull((select sum((case when wa.typea='1' then 1 else -1 end)*wb.mount) from view_worka[1] wa left join view_workas[1] wb on wa.noa=wb.noa where wa.datea<=@t_xdate and wb.productno=a.noa),0)--worka
	--+isnull((select sum(wb.mount) from view_workb[1] wa left join view_workbs[1] wb on wa.noa=wb.noa where wa.datea<=@t_xdate and wb.productno=a.noa),0)--workb
	-isnull((select sum((case when wa.typea='1' then 1 else -1 end)*wb.mount) from view_workc[1] wa left join view_workcs[1] wb on wa.noa=wb.noa where wa.datea<=@t_xdate and wb.productno=a.noa),0)--workc
	--+isnull((select sum(wb.mount+wb.inmount-wb.outmount) from view_workd[1] wa left join view_workds[1] wb on wa.noa=wb.noa where wa.datea<=@t_xdate and wb.productno=a.noa),0)--workd
	-isnull((select sum(mount) from view_cut[1] where datea<=@t_xdate and productno=a.noa),0)--cut
	-isnull((select sum(cb.mount) from view_cub[1] ca left join view_cubt[1] cb on ca.noa=cb.noa where ca.datea<=@t_xdate and cb.productno=a.noa),0)--cubt
	--+isnull((select sum(cb.mount) from view_cut[1] ca left join view_cuts[1] cb on ca.noa=cb.noa where ca.datea<=@t_xdate and cb.productno=a.noa),0)--cuts
	--+isnull((select sum(cb.mount) from view_cub[1] ca left join view_cubu[1] cb on ca.noa=cb.noa where ca.datea<=@t_xdate and cb.productno=a.noa),0)--cubu
	+isnull((select sum((case when ra.typea='1' then 1 else -1 end)*rb.mount) from view_rc2[1] ra left join view_rc2s[1] rb on ra.noa=rb.noa where ra.datea<=@t_xdate and rb.productno=a.noa),0)--rc2
	-isnull((select sum((case when va.typea='1' then 1 else -1 end)*vb.mount) from view_vcc[1] va left join view_vccs[1] vb on va.noa=vb.noa where va.datea<=@t_xdate and vb.productno=a.noa),0)--vcc
	bigenmount
	,isnull((select weight from view_inas[1] i where charindex('0000',i.noa)>0 and i.productno=a.noa),0)
	+isnull((select sum(ib.weight) from view_ina[1] ia left join view_inas[1] ib on ia.noa=ib.noa where ia.datea<=@t_xdate and ib.productno=a.noa and charindex('0000',ia.noa)=0),0)--ina
	-isnull((select sum(gb.gweight) from view_get[1] ga left join view_gets[1] gb on ga.noa=gb.noa where ga.datea<=@t_xdate and gb.productno=a.noa),0)--get
	-isnull((select sum((case when wa.typea='1' then 1 else -1 end)*wb.weight) from view_worka[1] wa left join view_workas[1] wb on wa.noa=wb.noa where wa.datea<=@t_xdate and wb.productno=a.noa),0)--worka
	--+isnull((select sum(wb.weight) from view_workb[1] wa left join view_workbs[1] wb on wa.noa=wb.noa where wa.datea<=@t_xdate and wb.productno=a.noa),0)--workb
	-isnull((select sum((case when wa.typea='1' then 1 else -1 end)*wb.weight) from view_workc[1] wa left join view_workcs[1] wb on wa.noa=wb.noa where wa.datea<=@t_xdate and wb.productno=a.noa),0)--workc
	--+isnull((select sum(wb.weight) from view_workd[1] wa left join view_workds[1] wb on wa.noa=wb.noa where wa.datea<=@t_xdate and wb.productno=a.noa),0)--workd
	-isnull((select sum(gweight) from view_cut[1] where datea<=@t_xdate and productno=a.noa),0)--cut
	-isnull((select sum(cb.weight) from view_cub[1] ca left join view_cubt[1] cb on ca.noa=cb.noa where ca.datea<=@t_xdate and cb.productno=a.noa),0)--cubt
	--+isnull((select sum(cb.weight) from view_cut[1] ca left join view_cuts[1] cb on ca.noa=cb.noa where ca.datea<=@t_xdate and cb.productno=a.noa),0)--cuts
	--+isnull((select sum(cb.weight) from view_cub[1] ca left join view_cubu[1] cb on ca.noa=cb.noa where ca.datea<=@t_xdate and cb.productno=a.noa),0)--cubu
	+isnull((select sum((case when ra.typea='1' then 1 else -1 end)*rb.weight) from view_rc2[1] ra left join view_rc2s[1] rb on ra.noa=rb.noa where ra.datea<=@t_xdate and rb.productno=a.noa),0)--rc2
	-isnull((select sum((case when va.typea='1' then 1 else -1 end)*vb.weight) from view_vcc[1] va left join view_vccs[1] vb on va.noa=vb.noa where va.datea<=@t_xdate and vb.productno=a.noa),0)--vcc
	bigeweight
	,case when 
		(isnull((select mount from view_inas[1] i where charindex('0000',i.noa)>0 and i.productno=a.noa),0)
		+isnull((select sum(ib.mount) from view_ina[1] ia left join view_inas[1] ib on ia.noa=ib.noa where ia.datea<=@t_xdate and ib.productno=a.noa and charindex('0000',ia.noa)=0),0)--ina
		+isnull((select sum((case when ra.typea='1' then 1 else -1 end)*rb.mount) from view_rc2[1] ra left join view_rc2s[1] rb on ra.noa=rb.noa where ra.datea<=@t_xdate and rb.productno=a.noa),0)--rc2
		)=0 
	then 0 
	else
		(isnull((select total from view_inas[1] i where charindex('0000',i.noa)>0 and i.productno=a.noa),0)
		+isnull((select sum(ib.total) from view_ina[1] ia left join view_inas[1] ib on ia.noa=ib.noa where ia.datea<=@t_xdate and ib.productno=a.noa and charindex('0000',ia.noa)=0),0)--ina
		+isnull((select sum((case when ra.typea='1' then 1 else -1 end)*rb.total) from view_rc2[1] ra left join view_rc2s[1] rb on ra.noa=rb.noa where ra.datea<=@t_xdate and rb.productno=a.noa),0)--rc2
		)/
		(isnull((select mount from view_inas[1] i where charindex('0000',i.noa)>0 and i.productno=a.noa),0)
		+isnull((select sum(ib.mount) from view_ina[1] ia left join view_inas[1] ib on ia.noa=ib.noa where ia.datea<=@t_xdate and ib.productno=a.noa and charindex('0000',ia.noa)=0),0)--ina
		+isnull((select sum((case when ra.typea='1' then 1 else -1 end)*rb.mount) from view_rc2[1] ra left join view_rc2s[1] rb on ra.noa=rb.noa where ra.datea<=@t_xdate and rb.productno=a.noa),0)--rc2
		)
	end
	bigenprice
	from ucc a where (a.typea='4' or a.typea='5') --原物料
	and (a.noa between @t_bpno and @t_epno) 

-----
if(@t_xall='全部' or @t_xall='製成品')
	insert into @tmp (gno,typea,pno,product,unit,mount,weight,price)
	select '0','製成品',a.noa,a.product,a.unit
	,isnull((select mount from view_inas[1] i where charindex('0000',i.noa)>0 and i.productno=a.noa),0)
	+isnull((select sum(ib.mount) from view_ina[1] ia left join view_inas[1] ib on ia.noa=ib.noa where ia.datea<=@t_xdate and ib.productno=a.noa and charindex('0000',ia.noa)=0),0)--ina
	-isnull((select sum(gb.mount) from view_get[1] ga left join view_gets[1] gb on ga.noa=gb.noa where ga.datea<=@t_xdate and gb.productno=a.noa),0)--get
	-isnull((select sum((case when wa.typea='1' then 1 else -1 end)*wb.mount) from view_worka[1] wa left join view_workas[1] wb on wa.noa=wb.noa where wa.datea<=@t_xdate and wb.productno=a.noa),0)--worka
	+isnull((select sum(wb.mount) from view_workb[1] wa left join view_workbs[1] wb on wa.noa=wb.noa where wa.datea<=@t_xdate and wb.productno=a.noa),0)--workb
	-isnull((select sum((case when wa.typea='1' then 1 else -1 end)*wb.mount) from view_workc[1] wa left join view_workcs[1] wb on wa.noa=wb.noa where wa.datea<=@t_xdate and wb.productno=a.noa),0)--workc
	+isnull((select sum(wb.mount+wb.inmount-wb.outmount) from view_workd[1] wa left join view_workds[1] wb on wa.noa=wb.noa where wa.datea<=@t_xdate and wb.productno=a.noa),0)--workd
	-isnull((select sum(mount) from view_cut[1] where datea<=@t_xdate and productno=a.noa),0)--cut
	-isnull((select sum(cb.mount) from view_cub[1] ca left join view_cubt[1] cb on ca.noa=cb.noa where ca.datea<=@t_xdate and cb.productno=a.noa),0)--cubt
	+isnull((select sum(cb.mount) from view_cut[1] ca left join view_cuts[1] cb on ca.noa=cb.noa where ca.datea<=@t_xdate and cb.productno=a.noa),0)--cuts
	+isnull((select sum(cb.mount) from view_cub[1] ca left join view_cubu[1] cb on ca.noa=cb.noa where ca.datea<=@t_xdate and cb.productno=a.noa),0)--cubu
	+isnull((select sum((case when ra.typea='1' then 1 else -1 end)*rb.mount) from view_rc2[1] ra left join view_rc2s[1] rb on ra.noa=rb.noa where ra.datea<=@t_xdate and rb.productno=a.noa),0)--rc2
	-isnull((select sum((case when va.typea='1' then 1 else -1 end)*vb.mount) from view_vcc[1] va left join view_vccs[1] vb on va.noa=vb.noa where va.datea<=@t_xdate and vb.productno=a.noa),0)--vcc
	bigenmount
	,isnull((select weight from view_inas[1] i where charindex('0000',i.noa)>0 and i.productno=a.noa),0)
	+isnull((select sum(ib.weight) from view_ina[1] ia left join view_inas[1] ib on ia.noa=ib.noa where ia.datea<=@t_xdate and ib.productno=a.noa and charindex('0000',ia.noa)=0),0)--ina
	-isnull((select sum(gb.gweight) from view_get[1] ga left join view_gets[1] gb on ga.noa=gb.noa where ga.datea<=@t_xdate and gb.productno=a.noa),0)--get
	-isnull((select sum((case when wa.typea='1' then 1 else -1 end)*wb.weight) from view_worka[1] wa left join view_workas[1] wb on wa.noa=wb.noa where wa.datea<=@t_xdate and wb.productno=a.noa),0)--worka
	+isnull((select sum(wb.weight) from view_workb[1] wa left join view_workbs[1] wb on wa.noa=wb.noa where wa.datea<=@t_xdate and wb.productno=a.noa),0)--workb
	-isnull((select sum((case when wa.typea='1' then 1 else -1 end)*wb.weight) from view_workc[1] wa left join view_workcs[1] wb on wa.noa=wb.noa where wa.datea<=@t_xdate and wb.productno=a.noa),0)--workc
	+isnull((select sum(wb.weight) from view_workd[1] wa left join view_workds[1] wb on wa.noa=wb.noa where wa.datea<=@t_xdate and wb.productno=a.noa),0)--workd
	-isnull((select sum(gweight) from view_cut[1] where datea<=@t_xdate and productno=a.noa),0)--cut
	-isnull((select sum(cb.weight) from view_cub[1] ca left join view_cubt[1] cb on ca.noa=cb.noa where ca.datea<=@t_xdate and cb.productno=a.noa),0)--cubt
	+isnull((select sum(cb.weight) from view_cut[1] ca left join view_cuts[1] cb on ca.noa=cb.noa where ca.datea<=@t_xdate and cb.productno=a.noa),0)--cuts
	+isnull((select sum(cb.weight) from view_cub[1] ca left join view_cubu[1] cb on ca.noa=cb.noa where ca.datea<=@t_xdate and cb.productno=a.noa),0)--cubu
	+isnull((select sum((case when ra.typea='1' then 1 else -1 end)*rb.weight) from view_rc2[1] ra left join view_rc2s[1] rb on ra.noa=rb.noa where ra.datea<=@t_xdate and rb.productno=a.noa),0)--rc2
	-isnull((select sum((case when va.typea='1' then 1 else -1 end)*vb.weight) from view_vcc[1] va left join view_vccs[1] vb on va.noa=vb.noa where va.datea<=@t_xdate and vb.productno=a.noa),0)--vcc
	bigeweight
	,case when 
		(isnull((select mount from view_inas[1] i where charindex('0000',i.noa)>0 and i.productno=a.noa),0)
		+isnull((select sum(ib.mount) from view_ina[1] ia left join view_inas[1] ib on ia.noa=ib.noa where ia.datea<=@t_xdate and ib.productno=a.noa and charindex('0000',ia.noa)=0),0)--ina
		+isnull((select sum((case when ra.typea='1' then 1 else -1 end)*rb.mount) from view_rc2[1] ra left join view_rc2s[1] rb on ra.noa=rb.noa where ra.datea<=@t_xdate and rb.productno=a.noa),0)--rc2
		
		+isnull((select sum(wb.mount) from view_workb[1] wa left join view_workbs[1] wb on wa.noa=wb.noa where wa.datea<=@t_xdate and wb.productno=a.noa),0)--workb
		+isnull((select sum(wb.mount+wb.inmount-wb.outmount) from view_workd[1] wa left join view_workds[1] wb on wa.noa=wb.noa where wa.datea<=@t_xdate and wb.productno=a.noa),0)--workd
		+isnull((select sum(cb.mount) from view_cut[1] ca left join view_cuts[1] cb on ca.noa=cb.noa where ca.datea<=@t_xdate and cb.productno=a.noa),0)--cuts
		+isnull((select sum(cb.mount) from view_cub[1] ca left join view_cubu[1] cb on ca.noa=cb.noa where ca.datea<=@t_xdate and cb.productno=a.noa),0)--cubu
		)=0 
	then 0 
	else
		(isnull((select total from view_inas[1] i where charindex('0000',i.noa)>0 and i.productno=a.noa),0)
		+isnull((select sum(ib.total) from view_ina[1] ia left join view_inas[1] ib on ia.noa=ib.noa where ia.datea<=@t_xdate and ib.productno=a.noa and charindex('0000',ia.noa)=0),0)--ina
		+isnull((select sum((case when ra.typea='1' then 1 else -1 end)*rb.total) from view_rc2[1] ra left join view_rc2s[1] rb on ra.noa=rb.noa where ra.datea<=@t_xdate and rb.productno=a.noa),0)--rc2
		+isnull((select sum(wc.costa+wc.costb+wc.costc+wc.costd)  from view_workb[1] wa left join view_workbs[1] wb on wa.noa=wb.noa left join wcost[1] wc on wb.noa=wc.noa and wb.productno=wc.productno
		where wa.datea<=@t_xdate and wb.productno=a.noa)
		,0)--workb
		+isnull((select sum(wc.costa+wc.costb+wc.costc+wc.costd)  from view_workd[1] wa left join view_workds[1] wb on wa.noa=wb.noa left join wcost[1] wc on wb.noa=wc.noa and wb.productno=wc.productno
		where wa.datea<=@t_xdate and wb.productno=a.noa)
		,0)--workd
		+isnull((select sum(cb.mount) from view_cut[1] ca left join view_cuts[1] cb on ca.noa=cb.noa where ca.datea<=@t_xdate and cb.productno=a.noa)
		*(select beginmoney/beginmount from costs where mon=LEFT(@t_xdate,6) and productno=a.noa)
		,0)--cuts
		+isnull((select sum(cb.mount)from view_cub[1] ca left join view_cubu[1] cb on ca.noa=cb.noa where ca.datea<=@t_xdate and cb.productno=a.noa)
		*(select beginmoney/beginmount from costs where mon=LEFT(@t_xdate,6) and productno=a.noa)
		,0)--cubu
		)/
		(isnull((select mount from view_inas[1] i where charindex('0000',i.noa)>0 and i.productno=a.noa),0)
		+isnull((select sum(ib.mount) from view_ina[1] ia left join view_inas[1] ib on ia.noa=ib.noa where ia.datea<=@t_xdate and ib.productno=a.noa and charindex('0000',ia.noa)=0),0)--ina
		+isnull((select sum((case when ra.typea='1' then 1 else -1 end)*rb.mount) from view_rc2[1] ra left join view_rc2s[1] rb on ra.noa=rb.noa where ra.datea<=@t_xdate and rb.productno=a.noa),0)--rc2
		
		+isnull((select sum(wb.mount) from view_workb[1] wa left join view_workbs[1] wb on wa.noa=wb.noa where wa.datea<=@t_xdate and wb.productno=a.noa),0)--workb
		+isnull((select sum(wb.mount+wb.inmount-wb.outmount) from view_workd[1] wa left join view_workds[1] wb on wa.noa=wb.noa where wa.datea<=@t_xdate and wb.productno=a.noa),0)--workd
		+isnull((select sum(cb.mount) from view_cut[1] ca left join view_cuts[1] cb on ca.noa=cb.noa where ca.datea<=@t_xdate and cb.productno=a.noa),0)--cuts
		+isnull((select sum(cb.mount) from view_cub[1] ca left join view_cubu[1] cb on ca.noa=cb.noa where ca.datea<=@t_xdate and cb.productno=a.noa),0)--cubu
		)
	end
	bigenprice
	from (select noa,product,unit,typea from ucc union select noa,product,unit,(case when typea='1' then '2' else '1' end)typea from uca where noa not in (select noa from ucc)) a where (a.typea='2' or a.typea='6' or a.typea='7') --製成品&下腳品&加工
	and (a.noa between @t_bpno and @t_epno) 

------
if(@t_xall='全部' or @t_xall='商品')
	insert into @tmp (gno,typea,pno,product,unit,mount,weight,price)
	select '0','商品',a.noa,a.product,a.unit
	,isnull((select mount from view_inas[1] i where charindex('0000',i.noa)>0 and i.productno=a.noa),0)
	+isnull((select sum(ib.mount) from view_ina[1] ia left join view_inas[1] ib on ia.noa=ib.noa where ia.datea<=@t_xdate and ib.productno=a.noa and charindex('0000',ia.noa)=0),0)--ina
	-isnull((select sum(gb.mount) from view_get[1] ga left join view_gets[1] gb on ga.noa=gb.noa where ga.datea<=@t_xdate and gb.productno=a.noa),0)--get
	+isnull((select sum((case when ra.typea='1' then 1 else -1 end)*rb.mount) from view_rc2[1] ra left join view_rc2s[1] rb on ra.noa=rb.noa where ra.datea<=@t_xdate and rb.productno=a.noa),0)--rc2
	-isnull((select sum((case when va.typea='1' then 1 else -1 end)*vb.mount) from view_vcc[1] va left join view_vccs[1] vb on va.noa=vb.noa where va.datea<=@t_xdate and vb.productno=a.noa),0)--vcc
	bigenmount
	,isnull((select weight from view_inas[1] i where charindex('0000',i.noa)>0 and i.productno=a.noa),0)
	+isnull((select sum(ib.weight) from view_ina[1] ia left join view_inas[1] ib on ia.noa=ib.noa where ia.datea<=@t_xdate and ib.productno=a.noa and charindex('0000',ia.noa)=0),0)--ina
	-isnull((select sum(gb.gweight) from view_get[1] ga left join view_gets[1] gb on ga.noa=gb.noa where ga.datea<=@t_xdate and gb.productno=a.noa),0)--get
	+isnull((select sum((case when ra.typea='1' then 1 else -1 end)*rb.weight) from view_rc2[1] ra left join view_rc2s[1] rb on ra.noa=rb.noa where ra.datea<=@t_xdate and rb.productno=a.noa),0)--rc2
	-isnull((select sum((case when va.typea='1' then 1 else -1 end)*vb.weight) from view_vcc[1] va left join view_vccs[1] vb on va.noa=vb.noa where va.datea<=@t_xdate and vb.productno=a.noa),0)--vcc
	bigeweight
	,case when 
		(isnull((select mount from view_inas[1] i where charindex('0000',i.noa)>0 and i.productno=a.noa),0)
		+isnull((select sum(ib.mount) from view_ina[1] ia left join view_inas[1] ib on ia.noa=ib.noa where ia.datea<=@t_xdate and ib.productno=a.noa and charindex('0000',ia.noa)=0),0)--ina
		+isnull((select sum((case when ra.typea='1' then 1 else -1 end)*rb.mount) from view_rc2[1] ra left join view_rc2s[1] rb on ra.noa=rb.noa where ra.datea<=@t_xdate and rb.productno=a.noa),0)--rc2
		)=0 
	then 0 
	else
		(isnull((select total from view_inas[1] i where charindex('0000',i.noa)>0 and i.productno=a.noa),0)
		+isnull((select sum(ib.total) from view_ina[1] ia left join view_inas[1] ib on ia.noa=ib.noa where ia.datea<=@t_xdate and ib.productno=a.noa and charindex('0000',ia.noa)=0),0)--ina
		+isnull((select sum((case when ra.typea='1' then 1 else -1 end)*rb.total) from view_rc2[1] ra left join view_rc2s[1] rb on ra.noa=rb.noa where ra.datea<=@t_xdate and rb.productno=a.noa),0)--rc2
		)/
		(isnull((select mount from view_inas[1] i where charindex('0000',i.noa)>0 and i.productno=a.noa),0)
		+isnull((select sum(ib.mount) from view_ina[1] ia left join view_inas[1] ib on ia.noa=ib.noa where ia.datea<=@t_xdate and ib.productno=a.noa and charindex('0000',ia.noa)=0),0)--ina
		+isnull((select sum((case when ra.typea='1' then 1 else -1 end)*rb.mount) from view_rc2[1] ra left join view_rc2s[1] rb on ra.noa=rb.noa where ra.datea<=@t_xdate and rb.productno=a.noa),0)--rc2
		)
	end
	bigenprice
	from ucc a where (a.typea='1') --商品
	and (a.noa between @t_bpno and @t_epno) 
----

--更新金額
update @tmp
set money=price*mount

select gno,typea,pno,product,unit
,case when @t_xall='全部' then '' else '('+@t_xall+')' end xtall
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(mount,2)),1)),0,30)) mount
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(weight,2)),1)),0,30)) weight
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(price,2)),1)),0,30)) price
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(money,2)),1)),0,30)) money

from @tmp order by pno;