z_gen3:--z_gen3
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_bpno nvarchar(20)
	declare @t_epno nvarchar(20)

	set @t_bdate = case when '#non'=[2] then '' else [2] end
	set @t_edate = case when '#non'=[3] then char(255) else [3] end
	set @t_bpno = case when '#non'=[4] then '' else [4] end
	set @t_epno = case when '#non'=[5] then char(255) else [5] end
	
	--*****************************************************************************************	
declare @tmp table( 
	gno nvarchar(1),
	pno nvarchar(50),
	product nvarchar(50),
	unit nvarchar(10),
	bmount float, 
	bweight float, 
	bmoney float, 
	rcmount float, 
	rcweight float, 
	rcmoney float, 
	vcmount float, 
	vcweight float, 
	vcmoney float, 
	vccost float,
	profit float, 
	lmount float, 
	lweight float, 
	lprice float, 
	lmoney float
) 

--期初抓inas
insert into @tmp (gno,pno,product,unit,bmount,bweight,bmoney,rcmount,rcweight,rcmoney,vcmount,vcweight,vcmoney)
select '0'gon,noa,product,unit
,isnull((select mount from view_inas[1] i where charindex('0000',i.noa)>0 and i.productno=a.noa),0)--產品的期初
+isnull((select sum((case when ra.typea='1' then 1 else -1 end)*rb.mount) from view_rc2[1] ra left join view_rc2s[1] rb on ra.noa=rb.noa where ra.datea<@t_bdate and rb.productno=a.noa),0)
-isnull((select sum((case when va.typea='1' then 1 else -1 end)*vb.mount) from view_vcc[1] va left join view_vccs[1] vb on va.noa=vb.noa where va.datea<@t_bdate and vb.productno=a.noa),0)
bigenmount
,isnull((select weight from view_inas[1] i where charindex('0000',i.noa)>0 and i.productno=a.noa),0)--產品的期初
+isnull((select sum((case when ra.typea='1' then 1 else -1 end)*rb.weight) from view_rc2[1] ra left join view_rc2s[1] rb on ra.noa=rb.noa where ra.datea<@t_bdate and rb.productno=a.noa),0)
-isnull((select sum((case when va.typea='1' then 1 else -1 end)*vb.weight) from view_vcc[1] va left join view_vccs[1] vb on va.noa=vb.noa where va.datea<@t_bdate and vb.productno=a.noa),0)
bigeweight
,isnull((select money from view_inas[1] i where charindex('0000',i.noa)>0 and i.productno=a.noa),0)--產品的期初
+isnull((select sum((case when ra.typea='1' then 1 else -1 end)*rb.total) from view_rc2[1] ra left join view_rc2s[1] rb on ra.noa=rb.noa where ra.datea<@t_bdate and rb.productno=a.noa),0)
-isnull((select sum((case when va.typea='1' then 1 else -1 end)*vb.total) from view_vcc[1] va left join view_vccs[1] vb on va.noa=vb.noa where va.datea<@t_bdate and vb.productno=a.noa),0)
bigenmoney
,isnull((select sum((case when ra.typea='1' then 1 else -1 end)*rb.mount) from view_rc2[1] ra left join view_rc2s[1] rb on ra.noa=rb.noa where (ra.datea between @t_bdate and @t_edate) and rb.productno=a.noa),0)
rcmount--進貨數量
,isnull((select sum((case when ra.typea='1' then 1 else -1 end)*rb.weight) from view_rc2[1] ra left join view_rc2s[1] rb on ra.noa=rb.noa where (ra.datea between @t_bdate and @t_edate) and rb.productno=a.noa),0)
rcweight--進貨重量
,isnull((select sum((case when ra.typea='1' then 1 else -1 end)*rb.total) from view_rc2[1] ra left join view_rc2s[1] rb on ra.noa=rb.noa where (ra.datea between @t_bdate and @t_edate) and rb.productno=a.noa),0)
rcmoney--進貨金額

,isnull((select sum((case when va.typea='1' then 1 else -1 end)*vb.mount) from view_vcc[1] va left join view_vccs[1] vb on va.noa=vb.noa where (va.datea between @t_bdate and @t_edate) and vb.productno=a.noa),0)
vcmount--銷貨數量
,isnull((select sum((case when va.typea='1' then 1 else -1 end)*vb.weight) from view_vcc[1] va left join view_vccs[1] vb on va.noa=vb.noa where (va.datea between @t_bdate and @t_edate) and vb.productno=a.noa),0)
vcweight--銷貨重量
,isnull((select sum((case when va.typea='1' then 1 else -1 end)*vb.total) from view_vcc[1] va left join view_vccs[1] vb on va.noa=vb.noa where (va.datea between @t_bdate and @t_edate) and vb.productno=a.noa),0)
vcmoney--銷貨金額

from ucc a where a.typea='1' --產品
and (a.noa between @t_bpno and @t_epno) 


--計算成本
update @tmp
set vccost=
case when UPPER(unit)!='KG' then
case when bmount+rcmount=0 then 0 else ((bmoney+rcmoney)/(bmount+rcmount))*vcmount end
else
case when bweight+rcweight=0 then 0 else ((bmoney+rcmoney)/(bweight+rcweight))*vcweight end
end

--毛利率
update @tmp
set profit=case when vcmoney=0 then 0 else ((vcmoney-vccost)/vcmoney)*100 end

--期末
update @tmp
set lmount=bmount+rcmoney-vcmoney,lweight=bweight+rcweight-vcweight
,lmoney=bmoney+rcmoney-vccost
update @tmp
set lprice=case when UPPER(unit)!='KG' 
then case when lmount=0 then 0 else lmoney/lmount end 
else case when lweight=0 then 0 else lmoney/lweight end
end

insert into @tmp
select '1','','','',sum(bmount),sum(bweight),sum(bmoney)
,sum(rcmount),sum(rcweight),sum(rcmoney)
,sum(vcmount),sum(vcweight),sum(vcmoney),sum(vccost),case when sum(vcmoney)=0 then 0 else ((sum(vcmoney)-sum(vccost))/sum(vcmoney))*100 end
,sum(lmount),sum(lweight),0,sum(lmoney)
from @tmp

select 
gno,pno,product,unit
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,bmount),1)),4,12)) bmount
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(bweight,2)),1)),0,30)) bweight
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,bmoney),1)),4,12)) bmoney

,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,rcmount),1)),4,12)) rcmount
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(rcweight,2)),1)),0,30)) rcweight
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,rcmoney),1)),4,12)) rcmoney

,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,vcmount),1)),4,12)) vcmount
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(vcweight,2)),1)),0,30)) vcweight
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,vcmoney),1)),4,12)) vcmoney
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,vccost),1)),4,12)) vccost
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(profit,2)),1)),0,30)) profit

,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,lmount),1)),4,12)) lmount
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(lweight,2)),1)),0,30)) lweight
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(lprice,2)),1)),0,30)) lprice
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,lmoney),1)),4,12)) lmoney

from @tmp
;
--*********************************************************************************************