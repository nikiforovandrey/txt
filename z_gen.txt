z_gen1:--z_gen1
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_bpno nvarchar(20)
	declare @t_epno nvarchar(20)

	set @t_bdate = case when '#non'=[2] then '' else [2] end
	set @t_edate = case when '#non'=[3] then char(255) else [3] end
	set @t_bpno = case when '#non'=[4] then '' else [4] end
	set @t_epno = case when '#non'=[5] then char(255) else [5] end
	
	--*****************************************************************************************	
declare @tmp table( 
	gno nvarchar(1),
	pno nvarchar(50),
	product nvarchar(50),
	unit nvarchar(10),
	bmount float, 
	bweight float, 
	bprice float,
	bmoney float, 
	rcmount float, 
	rcweight float, 
	rcmoney float, 
	gmount float, 
	gweight float, 
	gcost float,
	vcmount float, 
	vcweight float, 
	vcmoney float, 
	vccost float,
	lmount float, 
	lweight float, 
	lprice float, 
	lmoney float
) 

--期初抓inas編號0000
--ina,get做調整用(只在期初用)
--worka,workc,cut,cubt領料
--workb,workd,cuts,cubu生產
--rc2進貨--vcc銷貨
insert into @tmp (gno,pno,product,unit,bmount,bweight,bprice,rcmount,rcweight,rcmoney,gmount,gweight,vcmount,vcweight,vcmoney)
select '0'gon,noa,product,unit
,isnull((select mount from view_inas[1] i where charindex('0000',i.noa)>0 and i.productno=a.noa),0)
+isnull((select sum(ib.mount) from view_ina[1] ia left join view_inas[1] ib on ia.noa=ib.noa where ia.datea<@t_bdate and ib.productno=a.noa and charindex('0000',ia.noa)=0),0)--ina
-isnull((select sum(gb.mount) from view_get[1] ga left join view_gets[1] gb on ga.noa=gb.noa where ga.datea<@t_bdate and gb.productno=a.noa),0)--get
-isnull((select sum(wb.mount) from view_worka[1] wa left join view_workas[1] wb on wa.noa=wb.noa where wa.datea<@t_bdate and wb.productno=a.noa),0)--worka
--+isnull((select sum(wb.mount) from view_workb[1] wa left join view_workbs[1] wb on wa.noa=wb.noa where wa.datea<@t_bdate and wb.productno=a.noa),0)--workb
-isnull((select sum(wb.mount) from view_workc[1] wa left join view_workcs[1] wb on wa.noa=wb.noa where wa.datea<@t_bdate and wb.productno=a.noa),0)--workc
--+isnull((select sum(wb.mount) from view_workd[1] wa left join view_workds[1] wb on wa.noa=wb.noa where wa.datea<@t_bdate and wb.productno=a.noa),0)--workd
-isnull((select sum(mount) from view_cut[1] where datea<@t_bdate and productno=a.noa),0)--cut
-isnull((select sum(cb.mount) from view_cub[1] ca left join view_cubt[1] cb on ca.noa=cb.noa where ca.datea<@t_bdate and cb.productno=a.noa),0)--cubt
--+isnull((select sum(cb.mount) from view_cut[1] ca left join view_cuts[1] cb on ca.noa=cb.noa where ca.datea<@t_bdate and cb.productno=a.noa),0)--cuts
--+isnull((select sum(cb.mount) from view_cub[1] ca left join view_cubu[1] cb on ca.noa=cb.noa where ca.datea<@t_bdate and cb.productno=a.noa),0)--cubu
+isnull((select sum((case when ra.typea='1' then 1 else -1 end)*rb.mount) from view_rc2[1] ra left join view_rc2s[1] rb on ra.noa=rb.noa where ra.datea<@t_bdate and rb.productno=a.noa),0)--rc2
-isnull((select sum((case when va.typea='1' then 1 else -1 end)*vb.mount) from view_vcc[1] va left join view_vccs[1] vb on va.noa=vb.noa where va.datea<@t_bdate and vb.productno=a.noa),0)--vcc
bigenmount
,isnull((select weight from view_inas[1] i where charindex('0000',i.noa)>0 and i.productno=a.noa),0)
+isnull((select sum(ib.weight) from view_ina[1] ia left join view_inas[1] ib on ia.noa=ib.noa where ia.datea<@t_bdate and ib.productno=a.noa and charindex('0000',ia.noa)=0),0)--ina
-isnull((select sum(gb.gweight) from view_get[1] ga left join view_gets[1] gb on ga.noa=gb.noa where ga.datea<@t_bdate and gb.productno=a.noa),0)--get
-isnull((select sum(wb.weight) from view_worka[1] wa left join view_workas[1] wb on wa.noa=wb.noa where wa.datea<@t_bdate and wb.productno=a.noa),0)--worka
--+isnull((select sum(wb.weight) from view_workb[1] wa left join view_workbs[1] wb on wa.noa=wb.noa where wa.datea<@t_bdate and wb.productno=a.noa),0)--workb
-isnull((select sum(wb.weight) from view_workc[1] wa left join view_workcs[1] wb on wa.noa=wb.noa where wa.datea<@t_bdate and wb.productno=a.noa),0)--workc
--+isnull((select sum(wb.weight) from view_workd[1] wa left join view_workds[1] wb on wa.noa=wb.noa where wa.datea<@t_bdate and wb.productno=a.noa),0)--workd
-isnull((select sum(gweight) from view_cut[1] where datea<@t_bdate and productno=a.noa),0)--cut
-isnull((select sum(cb.weight) from view_cub[1] ca left join view_cubt[1] cb on ca.noa=cb.noa where ca.datea<@t_bdate and cb.productno=a.noa),0)--cubt
--+isnull((select sum(cb.weight) from view_cut[1] ca left join view_cuts[1] cb on ca.noa=cb.noa where ca.datea<@t_bdate and cb.productno=a.noa),0)--cuts
--+isnull((select sum(cb.weight) from view_cub[1] ca left join view_cubu[1] cb on ca.noa=cb.noa where ca.datea<@t_bdate and cb.productno=a.noa),0)--cubu
+isnull((select sum((case when ra.typea='1' then 1 else -1 end)*rb.weight) from view_rc2[1] ra left join view_rc2s[1] rb on ra.noa=rb.noa where ra.datea<@t_bdate and rb.productno=a.noa),0)--rc2
-isnull((select sum((case when va.typea='1' then 1 else -1 end)*vb.weight) from view_vcc[1] va left join view_vccs[1] vb on va.noa=vb.noa where va.datea<@t_bdate and vb.productno=a.noa),0)--vcc
bigeweight
,case when 
	(case when UPPER(a.unit)!='KG' then
	(isnull((select mount from view_inas[1] i where charindex('0000',i.noa)>0 and i.productno=a.noa),0)
	+isnull((select sum(ib.mount) from view_ina[1] ia left join view_inas[1] ib on ia.noa=ib.noa where ia.datea<@t_bdate and ib.productno=a.noa and charindex('0000',ia.noa)=0),0)--ina
	+isnull((select sum((case when ra.typea='1' then 1 else -1 end)*rb.mount) from view_rc2[1] ra left join view_rc2s[1] rb on ra.noa=rb.noa where ra.datea<@t_bdate and rb.productno=a.noa),0)--rc2
	)
	else
	(isnull((select weight from view_inas[1] i where charindex('0000',i.noa)>0 and i.productno=a.noa),0)
	+isnull((select sum(ib.weight) from view_ina[1] ia left join view_inas[1] ib on ia.noa=ib.noa where ia.datea<@t_bdate and ib.productno=a.noa and charindex('0000',ia.noa)=0),0)--ina
	+isnull((select sum((case when ra.typea='1' then 1 else -1 end)*rb.weight) from view_rc2[1] ra left join view_rc2s[1] rb on ra.noa=rb.noa where ra.datea<@t_bdate and rb.productno=a.noa),0)--rc2
	)end)=0 
then 0 
else
	(isnull((select money from view_inas[1] i where charindex('0000',i.noa)>0 and i.productno=a.noa),0)
	+isnull((select sum(ib.money) from view_ina[1] ia left join view_inas[1] ib on ia.noa=ib.noa where ia.datea<@t_bdate and ib.productno=a.noa and charindex('0000',ia.noa)=0),0)--ina
	+isnull((select sum((case when ra.typea='1' then 1 else -1 end)*rb.total) from view_rc2[1] ra left join view_rc2s[1] rb on ra.noa=rb.noa where ra.datea<@t_bdate and rb.productno=a.noa),0)--rc2
	)/(case when UPPER(a.unit)!='KG' then
	(isnull((select mount from view_inas[1] i where charindex('0000',i.noa)>0 and i.productno=a.noa),0)
	+isnull((select sum(ib.mount) from view_ina[1] ia left join view_inas[1] ib on ia.noa=ib.noa where ia.datea<@t_bdate and ib.productno=a.noa and charindex('0000',ia.noa)=0),0)--ina
	+isnull((select sum((case when ra.typea='1' then 1 else -1 end)*rb.mount) from view_rc2[1] ra left join view_rc2s[1] rb on ra.noa=rb.noa where ra.datea<@t_bdate and rb.productno=a.noa),0)--rc2
	)
	else
	(isnull((select weight from view_inas[1] i where charindex('0000',i.noa)>0 and i.productno=a.noa),0)
	+isnull((select sum(ib.weight) from view_ina[1] ia left join view_inas[1] ib on ia.noa=ib.noa where ia.datea<@t_bdate and ib.productno=a.noa and charindex('0000',ia.noa)=0),0)--ina
	+isnull((select sum((case when ra.typea='1' then 1 else -1 end)*rb.weight) from view_rc2[1] ra left join view_rc2s[1] rb on ra.noa=rb.noa where ra.datea<@t_bdate and rb.productno=a.noa),0)--rc2
	)end)
end
bigenprice
,isnull((select sum((case when ra.typea='1' then 1 else -1 end)*rb.mount) from view_rc2[1] ra left join view_rc2s[1] rb on ra.noa=rb.noa where (ra.datea between @t_bdate and @t_edate) and rb.productno=a.noa),0)
rcmount--進貨數量
,isnull((select sum((case when ra.typea='1' then 1 else -1 end)*rb.weight) from view_rc2[1] ra left join view_rc2s[1] rb on ra.noa=rb.noa where (ra.datea between @t_bdate and @t_edate) and rb.productno=a.noa),0)
rcweight--進貨重量
,isnull((select sum((case when ra.typea='1' then 1 else -1 end)*rb.total) from view_rc2[1] ra left join view_rc2s[1] rb on ra.noa=rb.noa where (ra.datea between @t_bdate and @t_edate) and rb.productno=a.noa),0)
rcmoney--進貨金額
,isnull((select sum(wb.mount) from view_worka[1] wa left join view_workas[1] wb on wa.noa=wb.noa where (wa.datea between @t_bdate and @t_edate) and wb.productno=a.noa),0)--worka
+isnull((select sum(wb.mount) from view_workc[1] wa left join view_workcs[1] wb on wa.noa=wb.noa where (wa.datea between @t_bdate and @t_edate) and wb.productno=a.noa),0)--workc
+isnull((select sum(mount) from view_cut[1] where (datea between @t_bdate and @t_edate) and productno=a.noa),0)--cut
+isnull((select sum(cb.mount) from view_cub[1] ca left join view_cubt[1] cb on ca.noa=cb.noa where (ca.datea between @t_bdate and @t_edate) and cb.productno=a.noa),0)--cubt
gmount--領料數量
,isnull((select sum(wb.weight) from view_worka[1] wa left join view_workas[1] wb on wa.noa=wb.noa where (wa.datea between @t_bdate and @t_edate) and wb.productno=a.noa),0)--worka
+isnull((select sum(wb.weight) from view_workc[1] wa left join view_workcs[1] wb on wa.noa=wb.noa where (wa.datea between @t_bdate and @t_edate) and wb.productno=a.noa),0)--workc
+isnull((select sum(gweight) from view_cut[1] where (datea between @t_bdate and @t_edate) and productno=a.noa),0)--cut
+isnull((select sum(cb.weight) from view_cub[1] ca left join view_cubt[1] cb on ca.noa=cb.noa where (ca.datea between @t_bdate and @t_edate) and cb.productno=a.noa),0)--cubt
gweight--領料重量
,isnull((select sum((case when va.typea='1' then 1 else -1 end)*vb.mount) from view_vcc[1] va left join view_vccs[1] vb on va.noa=vb.noa where (va.datea between @t_bdate and @t_edate) and vb.productno=a.noa),0)
vcmount--銷貨數量
,isnull((select sum((case when va.typea='1' then 1 else -1 end)*vb.weight) from view_vcc[1] va left join view_vccs[1] vb on va.noa=vb.noa where (va.datea between @t_bdate and @t_edate) and vb.productno=a.noa),0)
vcweight--銷貨重量
,isnull((select sum((case when va.typea='1' then 1 else -1 end)*vb.total) from view_vcc[1] va left join view_vccs[1] vb on va.noa=vb.noa where (va.datea between @t_bdate and @t_edate) and vb.productno=a.noa),0)
vcmoney--銷貨金額
from ucc a where (a.typea='4' or a.typea='5') --原物料
and (a.noa between @t_bpno and @t_epno) 

--計算期初金額
update @tmp
set bmoney=bprice*(case when UPPER(unit)!='KG' then bmount else bweight end)

--計算領用成本
update @tmp
set gcost=
case when UPPER(unit)!='KG' 
then case when (bmount+rcmount)=0 then 0 else (bmoney+rcmoney)/(bmount+rcmount)*gmount end
else case when (bweight+rcweight)=0 then 0 else (bmoney+rcmoney)/(bweight+rcweight)*gweight end
end

--計算銷售成本
update @tmp
set vccost=
case when UPPER(unit)!='KG'
then case when bmount+rcmount=0 then 0 else ((bmoney+rcmoney)/(bmount+rcmount))*vcmount end
else case when bweight+rcweight=0 then 0 else ((bmoney+rcmoney)/(bweight+rcweight))*vcweight end
end


--計算期末
update @tmp
set lmount=bmount+rcmount-vcmount-gmount,lweight=bweight+rcweight-vcweight-gweight
,lmoney=bmoney+rcmoney-vccost-gcost

update @tmp
set lprice=case when UPPER(unit)!='KG' 
then case when lmount=0 then 0 else lmoney/lmount end 
else case when lweight=0 then 0 else lmoney/lweight end
end

insert into @tmp
select '1','','','',sum(bmount),sum(bweight),0,sum(bmoney)
,sum(rcmount),sum(rcweight),sum(rcmoney)
,sum(gmount),sum(gweight),sum(gcost)
,sum(vcmount),sum(vcweight),sum(vcmoney),sum(vccost)
,sum(lmount),sum(lweight),0,sum(lmoney)
from @tmp

select 
gno,pno,product,unit
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,round(bmount,0)),1)),4,12)) bmount
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(bweight,2)),1)),0,30)) bweight
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,round(bmoney,0)),1)),4,12)) bmoney

,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,round(rcmount,0)),1)),4,12)) rcmount
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(rcweight,2)),1)),0,30)) rcweight
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,round(rcmoney,0)),1)),4,12)) rcmoney

,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,round(gmount,0)),1)),4,12)) gmount
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(gweight,2)),1)),0,30)) gweight
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,round(gcost,0)),1)),4,12)) gcost

,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,round(vcmount,0)),1)),4,12)) vcmount
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(vcweight,2)),1)),0,30)) vcweight
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,round(vcmoney,0)),1)),4,12)) vcmoney
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,round(vccost,0)),1)),4,12)) vccost

,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,round(lmount,0)),1)),4,12)) lmount
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(lweight,2)),1)),0,30)) lweight
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(lprice,2)),1)),0,30)) lprice
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,round(lmoney,0)),1)),4,12)) lmoney

from @tmp;
--*********************************************************************************************
z_gen2:--z_gen2
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_bpno nvarchar(20)
	declare @t_epno nvarchar(20)

	set @t_bdate = case when '#non'=[2] then '' else [2] end
	set @t_edate = case when '#non'=[3] then char(255) else [3] end
	set @t_bpno = case when '#non'=[4] then '' else [4] end
	set @t_epno = case when '#non'=[5] then char(255) else [5] end
	
	--*****************************************************************************************	
declare @tmp table( 
	gno nvarchar(1),
	pno nvarchar(50),
	product nvarchar(50),
	unit nvarchar(10),
	bmount float, 
	bweight float, 
	bprice float,
	bmoney float, 
	rcmount float, 
	rcweight float, 
	rcmoney float, 
	vcmount float, 
	vcweight float, 
	vcmoney float, 
	vccost float,
	profit float, 
	lmount float, 
	lweight float, 
	lprice float, 
	lmoney float
) 

--期初抓inas編號0000
--ina,get做調整用(只在期初用)
--worka,workc,cut,cubt領料
--workb,workd,cuts,cubu生產
--rc2進貨--vcc銷貨

insert into @tmp (gno,pno,product,unit,bmount,bweight,bprice,rcmount,rcweight,rcmoney,vcmount,vcweight,vcmoney)
select '0'gon,noa,product,unit
,isnull((select mount from view_inas[1] i where charindex('0000',i.noa)>0 and i.productno=a.noa),0)
+isnull((select sum(ib.mount) from view_ina[1] ia left join view_inas[1] ib on ia.noa=ib.noa where ia.datea<@t_bdate and ib.productno=a.noa and charindex('0000',ia.noa)=0),0)--ina
-isnull((select sum(gb.mount) from view_get[1] ga left join view_gets[1] gb on ga.noa=gb.noa where ga.datea<@t_bdate and gb.productno=a.noa),0)--get
-isnull((select sum(wb.mount) from view_worka[1] wa left join view_workas[1] wb on wa.noa=wb.noa where wa.datea<@t_bdate and wb.productno=a.noa),0)--worka
+isnull((select sum(wb.mount) from view_workb[1] wa left join view_workbs[1] wb on wa.noa=wb.noa where wa.datea<@t_bdate and wb.productno=a.noa),0)--workb
-isnull((select sum(wb.mount) from view_workc[1] wa left join view_workcs[1] wb on wa.noa=wb.noa where wa.datea<@t_bdate and wb.productno=a.noa),0)--workc
+isnull((select sum(wb.mount) from view_workd[1] wa left join view_workds[1] wb on wa.noa=wb.noa where wa.datea<@t_bdate and wb.productno=a.noa),0)--workd
-isnull((select sum(mount) from view_cut[1] where datea<@t_bdate and productno=a.noa),0)--cut
-isnull((select sum(cb.mount) from view_cub[1] ca left join view_cubt[1] cb on ca.noa=cb.noa where ca.datea<@t_bdate and cb.productno=a.noa),0)--cubt
+isnull((select sum(cb.mount) from view_cut[1] ca left join view_cuts[1] cb on ca.noa=cb.noa where ca.datea<@t_bdate and cb.productno=a.noa),0)--cuts
+isnull((select sum(cb.mount) from view_cub[1] ca left join view_cubu[1] cb on ca.noa=cb.noa where ca.datea<@t_bdate and cb.productno=a.noa),0)--cubu
+isnull((select sum((case when ra.typea='1' then 1 else -1 end)*rb.mount) from view_rc2[1] ra left join view_rc2s[1] rb on ra.noa=rb.noa where ra.datea<@t_bdate and rb.productno=a.noa),0)--rc2
-isnull((select sum((case when va.typea='1' then 1 else -1 end)*vb.mount) from view_vcc[1] va left join view_vccs[1] vb on va.noa=vb.noa where va.datea<@t_bdate and vb.productno=a.noa),0)--vcc
bigenmount
,isnull((select weight from view_inas[1] i where charindex('0000',i.noa)>0 and i.productno=a.noa),0)
+isnull((select sum(ib.weight) from view_ina[1] ia left join view_inas[1] ib on ia.noa=ib.noa where ia.datea<@t_bdate and ib.productno=a.noa and charindex('0000',ia.noa)=0),0)--ina
-isnull((select sum(gb.gweight) from view_get[1] ga left join view_gets[1] gb on ga.noa=gb.noa where ga.datea<@t_bdate and gb.productno=a.noa),0)--get
-isnull((select sum(wb.weight) from view_worka[1] wa left join view_workas[1] wb on wa.noa=wb.noa where wa.datea<@t_bdate and wb.productno=a.noa),0)--worka
+isnull((select sum(wb.weight) from view_workb[1] wa left join view_workbs[1] wb on wa.noa=wb.noa where wa.datea<@t_bdate and wb.productno=a.noa),0)--workb
-isnull((select sum(wb.weight) from view_workc[1] wa left join view_workcs[1] wb on wa.noa=wb.noa where wa.datea<@t_bdate and wb.productno=a.noa),0)--workc
+isnull((select sum(wb.weight) from view_workd[1] wa left join view_workds[1] wb on wa.noa=wb.noa where wa.datea<@t_bdate and wb.productno=a.noa),0)--workd
-isnull((select sum(gweight) from view_cut[1] where datea<@t_bdate and productno=a.noa),0)--cut
-isnull((select sum(cb.weight) from view_cub[1] ca left join view_cubt[1] cb on ca.noa=cb.noa where ca.datea<@t_bdate and cb.productno=a.noa),0)--cubt
+isnull((select sum(cb.weight) from view_cut[1] ca left join view_cuts[1] cb on ca.noa=cb.noa where ca.datea<@t_bdate and cb.productno=a.noa),0)--cuts
+isnull((select sum(cb.weight) from view_cub[1] ca left join view_cubu[1] cb on ca.noa=cb.noa where ca.datea<@t_bdate and cb.productno=a.noa),0)--cubu
+isnull((select sum((case when ra.typea='1' then 1 else -1 end)*rb.weight) from view_rc2[1] ra left join view_rc2s[1] rb on ra.noa=rb.noa where ra.datea<@t_bdate and rb.productno=a.noa),0)--rc2
-isnull((select sum((case when va.typea='1' then 1 else -1 end)*vb.weight) from view_vcc[1] va left join view_vccs[1] vb on va.noa=vb.noa where va.datea<@t_bdate and vb.productno=a.noa),0)--vcc
bigeweight
,case when 
	(case when UPPER(a.unit)!='KG' then
	(isnull((select mount from view_inas[1] i where charindex('0000',i.noa)>0 and i.productno=a.noa),0)
	+isnull((select sum(ib.mount) from view_ina[1] ia left join view_inas[1] ib on ia.noa=ib.noa where ia.datea<@t_bdate and ib.productno=a.noa and charindex('0000',ia.noa)=0),0)--ina
	+isnull((select sum((case when ra.typea='1' then 1 else -1 end)*rb.mount) from view_rc2[1] ra left join view_rc2s[1] rb on ra.noa=rb.noa where ra.datea<@t_bdate and rb.productno=a.noa),0)--rc2
	
	+isnull((select sum(wb.mount) from view_workb[1] wa left join view_workbs[1] wb on wa.noa=wb.noa where wa.datea<@t_bdate and wb.productno=a.noa),0)--workb
	+isnull((select sum(wb.mount) from view_workd[1] wa left join view_workds[1] wb on wa.noa=wb.noa where wa.datea<@t_bdate and wb.productno=a.noa),0)--workd
	)
	else
	(isnull((select weight from view_inas[1] i where charindex('0000',i.noa)>0 and i.productno=a.noa),0)
	+isnull((select sum(ib.weight) from view_ina[1] ia left join view_inas[1] ib on ia.noa=ib.noa where ia.datea<@t_bdate and ib.productno=a.noa and charindex('0000',ia.noa)=0),0)--ina
	+isnull((select sum((case when ra.typea='1' then 1 else -1 end)*rb.weight) from view_rc2[1] ra left join view_rc2s[1] rb on ra.noa=rb.noa where ra.datea<@t_bdate and rb.productno=a.noa),0)--rc2
	
	+isnull((select sum(wb.bweight) from view_workb[1] wa left join view_workbs[1] wb on wa.noa=wb.noa where wa.datea<@t_bdate and wb.productno=a.noa),0)--workb
	+isnull((select sum(wb.bweight) from view_workd[1] wa left join view_workds[1] wb on wa.noa=wb.noa where wa.datea<@t_bdate and wb.productno=a.noa),0)--workd
	)end)=0 
then 0 
else
	(isnull((select money from view_inas[1] i where charindex('0000',i.noa)>0 and i.productno=a.noa),0)
	+isnull((select sum(ib.money) from view_ina[1] ia left join view_inas[1] ib on ia.noa=ib.noa where ia.datea<@t_bdate and ib.productno=a.noa and charindex('0000',ia.noa)=0),0)--ina
	+isnull((select sum((case when ra.typea='1' then 1 else -1 end)*rb.total) from view_rc2[1] ra left join view_rc2s[1] rb on ra.noa=rb.noa where ra.datea<@t_bdate and rb.productno=a.noa),0)--rc2
	
	+isnull(
	(select (case when UPPER(a.unit)!='KG' then sum(wb.mount) else sum(wb.bweight) end ) from view_workb[1] wa left join view_workbs[1] wb on wa.noa=wb.noa where wa.datea<@t_bdate and wb.productno=a.noa)
	*(select beginprice from costs where mon=LEFT(@t_bdate,6) and productno=a.noa)
	,0)--workb
	+isnull((select sum(wb.total) from view_workd[1] wa left join view_workds[1] wb on wa.noa=wb.noa where wa.datea<@t_bdate and wb.productno=a.noa),0)--workd
	
	)/(case when UPPER(a.unit)!='KG' then
	(isnull((select mount from view_inas[1] i where charindex('0000',i.noa)>0 and i.productno=a.noa),0)
	+isnull((select sum(ib.mount) from view_ina[1] ia left join view_inas[1] ib on ia.noa=ib.noa where ia.datea<@t_bdate and ib.productno=a.noa and charindex('0000',ia.noa)=0),0)--ina
	+isnull((select sum((case when ra.typea='1' then 1 else -1 end)*rb.mount) from view_rc2[1] ra left join view_rc2s[1] rb on ra.noa=rb.noa where ra.datea<@t_bdate and rb.productno=a.noa),0)--rc2
	
	+isnull((select sum(wb.mount) from view_workb[1] wa left join view_workbs[1] wb on wa.noa=wb.noa where wa.datea<@t_bdate and wb.productno=a.noa),0)--workb
	+isnull((select sum(wb.mount) from view_workd[1] wa left join view_workds[1] wb on wa.noa=wb.noa where wa.datea<@t_bdate and wb.productno=a.noa),0)--workd
	)
	else
	(isnull((select weight from view_inas[1] i where charindex('0000',i.noa)>0 and i.productno=a.noa),0)
	+isnull((select sum(ib.weight) from view_ina[1] ia left join view_inas[1] ib on ia.noa=ib.noa where ia.datea<@t_bdate and ib.productno=a.noa and charindex('0000',ia.noa)=0),0)--ina
	+isnull((select sum((case when ra.typea='1' then 1 else -1 end)*rb.weight) from view_rc2[1] ra left join view_rc2s[1] rb on ra.noa=rb.noa where ra.datea<@t_bdate and rb.productno=a.noa),0)--rc2
	+isnull((select sum(wb.bweight) from view_workb[1] wa left join view_workbs[1] wb on wa.noa=wb.noa where wa.datea<@t_bdate and wb.productno=a.noa),0)--workb
	+isnull((select sum(wb.bweight) from view_workd[1] wa left join view_workds[1] wb on wa.noa=wb.noa where wa.datea<@t_bdate and wb.productno=a.noa),0)--workd
	)end)
end
bigenprice
,isnull((select sum((case when ra.typea='1' then 1 else -1 end)*rb.mount) from view_rc2[1] ra left join view_rc2s[1] rb on ra.noa=rb.noa where (ra.datea between @t_bdate and @t_edate) and rb.productno=a.noa),0)
+isnull((select sum(wb.mount) from view_workb[1] wa left join view_workbs[1] wb on wa.noa=wb.noa where (wa.datea between @t_bdate and @t_edate) and wb.productno=a.noa),0)
+isnull((select sum(wb.mount) from view_workd[1] wa left join view_workds[1] wb on wa.noa=wb.noa where (wa.datea between @t_bdate and @t_edate) and wb.productno=a.noa),0)

rcmount--進貨數量(含生產)
,isnull((select sum((case when ra.typea='1' then 1 else -1 end)*rb.weight) from view_rc2[1] ra left join view_rc2s[1] rb on ra.noa=rb.noa where (ra.datea between @t_bdate and @t_edate) and rb.productno=a.noa),0)
+isnull((select sum(wb.bweight) from view_workb[1] wa left join view_workbs[1] wb on wa.noa=wb.noa where (wa.datea between @t_bdate and @t_edate) and wb.productno=a.noa),0)
+isnull((select sum(wb.bweight) from view_workd[1] wa left join view_workds[1] wb on wa.noa=wb.noa where (wa.datea between @t_bdate and @t_edate) and wb.productno=a.noa),0)

rcweight--進貨重量(含生產)
,isnull((select sum((case when ra.typea='1' then 1 else -1 end)*rb.total) from view_rc2[1] ra left join view_rc2s[1] rb on ra.noa=rb.noa where (ra.datea between @t_bdate and @t_edate) and rb.productno=a.noa),0)
+isnull(
(select (case when UPPER(a.unit)!='KG' then sum(wb.mount) else sum(wb.bweight) end ) from view_workb[1] wa left join view_workbs[1] wb on wa.noa=wb.noa where (wa.datea between @t_bdate and @t_edate) and wb.productno=a.noa)
*(select lastprice from costs where mon=LEFT(@t_bdate,6) and productno=a.noa)
,0)--workb
+isnull((select sum(wb.total) from view_workd[1] wa left join view_workds[1] wb on wa.noa=wb.noa where (wa.datea between @t_bdate and @t_edate) and wb.productno=a.noa),0)--workd
rcmoney--進貨金額(含生產)

,isnull((select sum((case when va.typea='1' then 1 else -1 end)*vb.mount) from view_vcc[1] va left join view_vccs[1] vb on va.noa=vb.noa where (va.datea between @t_bdate and @t_edate) and vb.productno=a.noa),0)
vcmount--銷貨數量
,isnull((select sum((case when va.typea='1' then 1 else -1 end)*vb.weight) from view_vcc[1] va left join view_vccs[1] vb on va.noa=vb.noa where (va.datea between @t_bdate and @t_edate) and vb.productno=a.noa),0)
vcweight--銷貨重量
,isnull((select sum((case when va.typea='1' then 1 else -1 end)*vb.total) from view_vcc[1] va left join view_vccs[1] vb on va.noa=vb.noa where (va.datea between @t_bdate and @t_edate) and vb.productno=a.noa),0)
vcmoney--銷貨金額
from ucc a where (a.typea='2' or a.typea='6' or a.typea='7') --製成品&下腳品&加工
and (a.noa between @t_bpno and @t_epno) 


--計算期初金額
update @tmp
set bmoney=bprice*(case when UPPER(unit)!='KG' then bmount else bweight end)


--計算銷售成本
update @tmp
set vccost=
case when UPPER(unit)!='KG'
then case when bmount+rcmount=0 then 0 else ((bmoney+rcmoney)/(bmount+rcmount))*vcmount end
else case when bweight+rcweight=0 then 0 else ((bmoney+rcmoney)/(bweight+rcweight))*vcweight end
end

--毛利率
update @tmp
set profit=case when vcmoney=0 then 0 else ((vcmoney-vccost)/vcmoney)*100 end

--計算期末
update @tmp
set lmount=bmount+rcmount-vcmount,lweight=bweight+rcweight-vcweight
,lmoney=bmoney+rcmoney-vccost

update @tmp
set lprice=case when UPPER(unit)!='KG' 
then case when lmount=0 then 0 else lmoney/lmount end 
else case when lweight=0 then 0 else lmoney/lweight end
end

insert into @tmp
select '1','','','',sum(bmount),sum(bweight),0,sum(bmoney)
,sum(rcmount),sum(rcweight),sum(rcmoney)
,sum(vcmount),sum(vcweight),sum(vcmoney),sum(vccost),case when sum(vcmoney)=0 then 0 else ((sum(vcmoney)-sum(vccost))/sum(vcmoney))*100 end
,sum(lmount),sum(lweight),0,sum(lmoney)
from @tmp

select 
gno,pno,product,unit
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,round(bmount,0)),1)),4,12)) bmount
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(bweight,2)),1)),0,30)) bweight
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,round(bmoney,0)),1)),4,12)) bmoney

,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,round(rcmount,0)),1)),4,12)) rcmount
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(rcweight,2)),1)),0,30)) rcweight
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,round(rcmoney,0)),1)),4,12)) rcmoney

,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,round(vcmount,0)),1)),4,12)) vcmount
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(vcweight,2)),1)),0,30)) vcweight
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,round(vcmoney,0)),1)),4,12)) vcmoney
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,round(vccost,0)),1)),4,12)) vccost
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(profit,2)),1)),0,30)) profit

,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,round(lmount,0)),1)),4,12)) lmount
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(lweight,2)),1)),0,30)) lweight
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(lprice,2)),1)),0,30)) lprice
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,round(lmoney,0)),1)),4,12)) lmoney

from @tmp;
--*********************************************************************************************
z_gen3:--z_gen3
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_bpno nvarchar(20)
	declare @t_epno nvarchar(20)

	set @t_bdate = case when '#non'=[2] then '' else [2] end
	set @t_edate = case when '#non'=[3] then char(255) else [3] end
	set @t_bpno = case when '#non'=[4] then '' else [4] end
	set @t_epno = case when '#non'=[5] then char(255) else [5] end
	
	--*****************************************************************************************	
declare @tmp table( 
	gno nvarchar(1),
	pno nvarchar(50),
	product nvarchar(50),
	unit nvarchar(10),
	bmount float, 
	bweight float, 
	bmoney float, 
	rcmount float, 
	rcweight float, 
	rcmoney float, 
	vcmount float, 
	vcweight float, 
	vcmoney float, 
	vccost float,
	profit float, 
	lmount float, 
	lweight float, 
	lprice float, 
	lmoney float
) 

--期初抓inas
insert into @tmp (gno,pno,product,unit,bmount,bweight,bmoney,rcmount,rcweight,rcmoney,vcmount,vcweight,vcmoney)
select '0'gon,noa,product,unit
,isnull((select mount from view_inas[1] i where charindex('0000',i.noa)>0 and i.productno=a.noa),0)--產品的期初
+isnull((select sum((case when ra.typea='1' then 1 else -1 end)*rb.mount) from view_rc2[1] ra left join view_rc2s[1] rb on ra.noa=rb.noa where ra.datea<@t_bdate and rb.productno=a.noa),0)
-isnull((select sum((case when va.typea='1' then 1 else -1 end)*vb.mount) from view_vcc[1] va left join view_vccs[1] vb on va.noa=vb.noa where va.datea<@t_bdate and vb.productno=a.noa),0)
bigenmount
,isnull((select weight from view_inas[1] i where charindex('0000',i.noa)>0 and i.productno=a.noa),0)--產品的期初
+isnull((select sum((case when ra.typea='1' then 1 else -1 end)*rb.weight) from view_rc2[1] ra left join view_rc2s[1] rb on ra.noa=rb.noa where ra.datea<@t_bdate and rb.productno=a.noa),0)
-isnull((select sum((case when va.typea='1' then 1 else -1 end)*vb.weight) from view_vcc[1] va left join view_vccs[1] vb on va.noa=vb.noa where va.datea<@t_bdate and vb.productno=a.noa),0)
bigeweight
,isnull((select money from view_inas[1] i where charindex('0000',i.noa)>0 and i.productno=a.noa),0)--產品的期初
+isnull((select sum((case when ra.typea='1' then 1 else -1 end)*rb.total) from view_rc2[1] ra left join view_rc2s[1] rb on ra.noa=rb.noa where ra.datea<@t_bdate and rb.productno=a.noa),0)
-isnull((select sum((case when va.typea='1' then 1 else -1 end)*vb.total) from view_vcc[1] va left join view_vccs[1] vb on va.noa=vb.noa where va.datea<@t_bdate and vb.productno=a.noa),0)
bigenmoney
,isnull((select sum((case when ra.typea='1' then 1 else -1 end)*rb.mount) from view_rc2[1] ra left join view_rc2s[1] rb on ra.noa=rb.noa where (ra.datea between @t_bdate and @t_edate) and rb.productno=a.noa),0)
rcmount--進貨數量
,isnull((select sum((case when ra.typea='1' then 1 else -1 end)*rb.weight) from view_rc2[1] ra left join view_rc2s[1] rb on ra.noa=rb.noa where (ra.datea between @t_bdate and @t_edate) and rb.productno=a.noa),0)
rcweight--進貨重量
,isnull((select sum((case when ra.typea='1' then 1 else -1 end)*rb.total) from view_rc2[1] ra left join view_rc2s[1] rb on ra.noa=rb.noa where (ra.datea between @t_bdate and @t_edate) and rb.productno=a.noa),0)
rcmoney--進貨金額

,isnull((select sum((case when va.typea='1' then 1 else -1 end)*vb.mount) from view_vcc[1] va left join view_vccs[1] vb on va.noa=vb.noa where (va.datea between @t_bdate and @t_edate) and vb.productno=a.noa),0)
vcmount--銷貨數量
,isnull((select sum((case when va.typea='1' then 1 else -1 end)*vb.weight) from view_vcc[1] va left join view_vccs[1] vb on va.noa=vb.noa where (va.datea between @t_bdate and @t_edate) and vb.productno=a.noa),0)
vcweight--銷貨重量
,isnull((select sum((case when va.typea='1' then 1 else -1 end)*vb.total) from view_vcc[1] va left join view_vccs[1] vb on va.noa=vb.noa where (va.datea between @t_bdate and @t_edate) and vb.productno=a.noa),0)
vcmoney--銷貨金額

from ucc a where a.typea='1' --產品
and (a.noa between @t_bpno and @t_epno) 


--計算成本
update @tmp
set vccost=
case when UPPER(unit)!='KG' then
case when bmount+rcmount=0 then 0 else ((bmoney+rcmoney)/(bmount+rcmount))*vcmount end
else
case when bweight+rcweight=0 then 0 else ((bmoney+rcmoney)/(bweight+rcweight))*vcweight end
end

--毛利率
update @tmp
set profit=case when vcmoney=0 then 0 else ((vcmoney-vccost)/vcmoney)*100 end

--期末
update @tmp
set lmount=bmount+rcmount-vcmount,lweight=bweight+rcweight-vcweight
,lmoney=bmoney+rcmoney-vccost
update @tmp
set lprice=case when UPPER(unit)!='KG' 
then case when lmount=0 then 0 else lmoney/lmount end 
else case when lweight=0 then 0 else lmoney/lweight end
end

insert into @tmp
select '1','','','',sum(bmount),sum(bweight),sum(bmoney)
,sum(rcmount),sum(rcweight),sum(rcmoney)
,sum(vcmount),sum(vcweight),sum(vcmoney),sum(vccost),case when sum(vcmoney)=0 then 0 else ((sum(vcmoney)-sum(vccost))/sum(vcmoney))*100 end
,sum(lmount),sum(lweight),0,sum(lmoney)
from @tmp

select 
gno,pno,product,unit
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,round(bmount,0)),1)),4,12)) bmount
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(bweight,2)),1)),0,30)) bweight
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,round(bmoney,0)),1)),4,12)) bmoney

,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,round(rcmount,0)),1)),4,12)) rcmount
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(rcweight,2)),1)),0,30)) rcweight
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,round(rcmoney,0)),1)),4,12)) rcmoney

,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,round(vcmount,0)),1)),4,12)) vcmount
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(vcweight,2)),1)),0,30)) vcweight
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,round(vcmoney,0)),1)),4,12)) vcmoney
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,round(vccost,0)),1)),4,12)) vccost
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(profit,2)),1)),0,30)) profit

,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,round(lmount,0)),1)),4,12)) lmount
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(lweight,2)),1)),0,30)) lweight
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(lprice,2)),1)),0,30)) lprice
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,round(lmoney,0)),1)),4,12)) lmoney

from @tmp;
--*********************************************************************************************
z_gen4:--z_gen4
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_bpno nvarchar(20)
	declare @t_epno nvarchar(20)

	set @t_bdate = case when '#non'=[2] then '' else [2] end
	set @t_edate = case when '#non'=[3] then char(255) else [3] end
	set @t_bpno = case when '#non'=[4] then '' else [4] end
	set @t_epno = case when '#non'=[5] then char(255) else [5] end
	
	--*****************************************************************************************	
declare @tmp table( 
	gno nvarchar(1),
	pno nvarchar(50),
	product nvarchar(50),
	unit nvarchar(10),
	mon nvarchar(10),
	datea nvarchar(10),
	memo nvarchar(MAX),
	
	rcmount float, 
	rcweight float,
	rcprice float,
	rcmoney float,
	
	vcgmount float, 
	vcgweight float, 
	vcgcost float, 
	vcmoney float, 
	vcprice float,
	
	lmount float, 
	lweight float, 
	lprice float, 
	lmoney float
) 

--插入期初
--期初抓inas編號0000
--ina,get做調整用
--worka,workc,cut,cubt領料
--workb,workd,cuts,cubu生產
--rc2進貨--vcc銷貨
insert into @tmp (gno,pno,product,unit,mon,datea,memo,rcmount,rcweight,rcprice)
select '0',a.noa,a.product,a.unit,'000/00','000/00/00','上期結轉'
,isnull((select mount from view_inas102 i where charindex('0000',i.noa)>0 and i.productno=a.noa),0)
+isnull((select sum(ib.mount) from view_ina102 ia left join view_inas102 ib on ia.noa=ib.noa where ia.datea<@t_bdate and ib.productno=a.noa and charindex('0000',ia.noa)=0),0)--ina
-isnull((select sum(gb.mount) from view_get102 ga left join view_gets102 gb on ga.noa=gb.noa where ga.datea<@t_bdate and gb.productno=a.noa),0)--get
-isnull((select sum(wb.mount) from view_worka102 wa left join view_workas102 wb on wa.noa=wb.noa where wa.datea<@t_bdate and wb.productno=a.noa),0)--worka
--+isnull((select sum(wb.mount) from view_workb102 wa left join view_workbs102 wb on wa.noa=wb.noa where wa.datea<@t_bdate and wb.productno=a.noa),0)--workb
-isnull((select sum(wb.mount) from view_workc102 wa left join view_workcs102 wb on wa.noa=wb.noa where wa.datea<@t_bdate and wb.productno=a.noa),0)--workc
--+isnull((select sum(wb.mount) from view_workd102 wa left join view_workds102 wb on wa.noa=wb.noa where wa.datea<@t_bdate and wb.productno=a.noa),0)--workd
-isnull((select sum(mount) from view_cut102 where datea<@t_bdate and productno=a.noa),0)--cut
-isnull((select sum(cb.mount) from view_cub102 ca left join view_cubt102 cb on ca.noa=cb.noa where ca.datea<@t_bdate and cb.productno=a.noa),0)--cubt
--+isnull((select sum(cb.mount) from view_cut102 ca left join view_cuts102 cb on ca.noa=cb.noa where ca.datea<@t_bdate and cb.productno=a.noa),0)--cuts
--+isnull((select sum(cb.mount) from view_cub102 ca left join view_cubu102 cb on ca.noa=cb.noa where ca.datea<@t_bdate and cb.productno=a.noa),0)--cubu
+isnull((select sum((case when ra.typea='1' then 1 else -1 end)*rb.mount) from view_rc2102 ra left join view_rc2s102 rb on ra.noa=rb.noa where ra.datea<@t_bdate and rb.productno=a.noa),0)--rc2
-isnull((select sum((case when va.typea='1' then 1 else -1 end)*vb.mount) from view_vcc102 va left join view_vccs102 vb on va.noa=vb.noa where va.datea<@t_bdate and vb.productno=a.noa),0)--vcc
bigenmount
,isnull((select weight from view_inas102 i where charindex('0000',i.noa)>0 and i.productno=a.noa),0)
+isnull((select sum(ib.weight) from view_ina102 ia left join view_inas102 ib on ia.noa=ib.noa where ia.datea<@t_bdate and ib.productno=a.noa and charindex('0000',ia.noa)=0),0)--ina
-isnull((select sum(gb.gweight) from view_get102 ga left join view_gets102 gb on ga.noa=gb.noa where ga.datea<@t_bdate and gb.productno=a.noa),0)--get
-isnull((select sum(wb.weight) from view_worka102 wa left join view_workas102 wb on wa.noa=wb.noa where wa.datea<@t_bdate and wb.productno=a.noa),0)--worka
--+isnull((select sum(wb.weight) from view_workb102 wa left join view_workbs102 wb on wa.noa=wb.noa where wa.datea<@t_bdate and wb.productno=a.noa),0)--workb
-isnull((select sum(wb.weight) from view_workc102 wa left join view_workcs102 wb on wa.noa=wb.noa where wa.datea<@t_bdate and wb.productno=a.noa),0)--workc
--+isnull((select sum(wb.weight) from view_workd102 wa left join view_workds102 wb on wa.noa=wb.noa where wa.datea<@t_bdate and wb.productno=a.noa),0)--workd
-isnull((select sum(gweight) from view_cut102 where datea<@t_bdate and productno=a.noa),0)--cut
-isnull((select sum(cb.weight) from view_cub102 ca left join view_cubt102 cb on ca.noa=cb.noa where ca.datea<@t_bdate and cb.productno=a.noa),0)--cubt
--+isnull((select sum(cb.weight) from view_cut102 ca left join view_cuts102 cb on ca.noa=cb.noa where ca.datea<@t_bdate and cb.productno=a.noa),0)--cuts
--+isnull((select sum(cb.weight) from view_cub102 ca left join view_cubu102 cb on ca.noa=cb.noa where ca.datea<@t_bdate and cb.productno=a.noa),0)--cubu
+isnull((select sum((case when ra.typea='1' then 1 else -1 end)*rb.weight) from view_rc2102 ra left join view_rc2s102 rb on ra.noa=rb.noa where ra.datea<@t_bdate and rb.productno=a.noa),0)--rc2
-isnull((select sum((case when va.typea='1' then 1 else -1 end)*vb.weight) from view_vcc102 va left join view_vccs102 vb on va.noa=vb.noa where va.datea<@t_bdate and vb.productno=a.noa),0)--vcc
bigeweight
,case when 
	(case when UPPER(a.unit)!='KG' then
	(isnull((select mount from view_inas102 i where charindex('0000',i.noa)>0 and i.productno=a.noa),0)
	+isnull((select sum(ib.mount) from view_ina102 ia left join view_inas102 ib on ia.noa=ib.noa where ia.datea<@t_bdate and ib.productno=a.noa and charindex('0000',ia.noa)=0),0)--ina
	+isnull((select sum((case when ra.typea='1' then 1 else -1 end)*rb.mount) from view_rc2102 ra left join view_rc2s102 rb on ra.noa=rb.noa where ra.datea<@t_bdate and rb.productno=a.noa),0)--rc2
	)
	else
	(isnull((select weight from view_inas102 i where charindex('0000',i.noa)>0 and i.productno=a.noa),0)
	+isnull((select sum(ib.weight) from view_ina102 ia left join view_inas102 ib on ia.noa=ib.noa where ia.datea<@t_bdate and ib.productno=a.noa and charindex('0000',ia.noa)=0),0)--ina
	+isnull((select sum((case when ra.typea='1' then 1 else -1 end)*rb.weight) from view_rc2102 ra left join view_rc2s102 rb on ra.noa=rb.noa where ra.datea<@t_bdate and rb.productno=a.noa),0)--rc2
	)end)=0 
then 0 
else
	(isnull((select money from view_inas102 i where charindex('0000',i.noa)>0 and i.productno=a.noa),0)
	+isnull((select sum(ib.money) from view_ina102 ia left join view_inas102 ib on ia.noa=ib.noa where ia.datea<@t_bdate and ib.productno=a.noa and charindex('0000',ia.noa)=0),0)--ina
	+isnull((select sum((case when ra.typea='1' then 1 else -1 end)*rb.total) from view_rc2102 ra left join view_rc2s102 rb on ra.noa=rb.noa where ra.datea<@t_bdate and rb.productno=a.noa),0)--rc2
	)/(case when UPPER(a.unit)!='KG' then
	(isnull((select mount from view_inas102 i where charindex('0000',i.noa)>0 and i.productno=a.noa),0)
	+isnull((select sum(ib.mount) from view_ina102 ia left join view_inas102 ib on ia.noa=ib.noa where ia.datea<@t_bdate and ib.productno=a.noa and charindex('0000',ia.noa)=0),0)--ina
	+isnull((select sum((case when ra.typea='1' then 1 else -1 end)*rb.mount) from view_rc2102 ra left join view_rc2s102 rb on ra.noa=rb.noa where ra.datea<@t_bdate and rb.productno=a.noa),0)--rc2
	)
	else
	(isnull((select weight from view_inas102 i where charindex('0000',i.noa)>0 and i.productno=a.noa),0)
	+isnull((select sum(ib.weight) from view_ina102 ia left join view_inas102 ib on ia.noa=ib.noa where ia.datea<@t_bdate and ib.productno=a.noa and charindex('0000',ia.noa)=0),0)--ina
	+isnull((select sum((case when ra.typea='1' then 1 else -1 end)*rb.weight) from view_rc2102 ra left join view_rc2s102 rb on ra.noa=rb.noa where ra.datea<@t_bdate and rb.productno=a.noa),0)--rc2
	)end)
end
bigenprice
from ucc a where (a.typea='4' or a.typea='5') --原物料
and (a.noa between @t_bpno and @t_epno) 

--更新金額
update @tmp
set rcmoney=rcprice*(case when UPPER(unit)!='KG' then rcmount else rcweight end)

update @tmp
set lmount=rcmount,lweight=rcweight,lmoney=rcmoney,lprice=rcprice

----插入進料
--ina調整用
insert into @tmp (gno,pno,product,unit,mon,datea,memo,rcmount,rcweight,rcprice,rcmoney)
select '1'gno,u.noa,u.product,u.unit,left(ia.datea,6),ia.datea,'進料 '+ia.noa,ib.mount,ib.weight,ib.price,ib.money
from view_ina102 ia left join view_inas102 ib on ia.noa=ib.noa left join ucc u on ib.productno=u.noa
where (u.typea='4' or u.typea='5') --原物料
and (u.noa between @t_bpno and @t_epno) 
and (ia.datea between @t_bdate and @t_edate)
--rc2
insert into @tmp (gno,pno,product,unit,mon,datea,memo,rcmount,rcweight,rcprice,rcmoney)
select '1'gno,u.noa,u.product,u.unit,left(ra.datea,6),ra.datea,'進料 '+ra.noa,rb.mount,rb.weight,rb.price,rb.total
from view_rc2102 ra left join view_rc2s102 rb on ra.noa=rb.noa left join ucc u on rb.productno=u.noa
where (u.typea='4' or u.typea='5') --原物料
and (u.noa between @t_bpno and @t_epno) 
and (ra.datea between @t_bdate and @t_edate)

--插入領用
--get調整用
insert into @tmp (gno,pno,product,unit,mon,datea,memo,vcgmount,vcgweight)
select '1'gno,u.noa,u.product,u.unit,left(ga.datea,6),ga.datea,'領料 '+ga.noa,gb.mount,gb.weight
from view_get102 ga left join view_gets102 gb on ga.noa=gb.noa left join ucc u on gb.productno=u.noa
where (u.typea='4' or u.typea='5') --原物料
and (u.noa between @t_bpno and @t_epno) 
and (ga.datea between @t_bdate and @t_edate)
--worka
insert into @tmp (gno,pno,product,unit,mon,datea,memo,vcgmount,vcgweight)
select '1'gno,u.noa,u.product,u.unit,left(wa.datea,6),wa.datea,'領料 '+wa.noa,wb.mount,wb.weight
from view_worka102 wa left join view_workas102 wb on wa.noa=wb.noa left join ucc u on wb.productno=u.noa
where (u.typea='4' or u.typea='5') --原物料
and (u.noa between @t_bpno and @t_epno) 
and (wa.datea between @t_bdate and @t_edate)
--workc
insert into @tmp (gno,pno,product,unit,mon,datea,memo,vcgmount,vcgweight)
select '1'gno,u.noa,u.product,u.unit,left(wa.datea,6),wa.datea,'領料 '+wa.noa,wb.mount,wb.weight
from view_workc102 wa left join view_workcs102 wb on wa.noa=wb.noa left join ucc u on wb.productno=u.noa
where (u.typea='4' or u.typea='5') --原物料
and (u.noa between @t_bpno and @t_epno) 
and (wa.datea between @t_bdate and @t_edate)
--cut
insert into @tmp (gno,pno,product,unit,mon,datea,memo,vcgmount,vcgweight)
select '1'gno,u.noa,u.product,u.unit,left(ca.datea,6),ca.datea,'領料 '+ca.noa,ca.mount,ca.gweight
from view_cut102 ca left join ucc u on ca.productno=u.noa
where (u.typea='4' or u.typea='5') --原物料
and (u.noa between @t_bpno and @t_epno) 
and (ca.datea between @t_bdate and @t_edate)
--cubt
insert into @tmp (gno,pno,product,unit,mon,datea,memo,vcgmount,vcgweight)
select '1'gno,u.noa,u.product,u.unit,left(ca.datea,6),ca.datea,'領料 '+ca.noa,cb.mount,cb.gweight
from view_cub102 ca left join view_cubt102 cb on ca.noa=cb.noa left join ucc u on cb.productno=u.noa
where (u.typea='4' or u.typea='5') --原物料
and (u.noa between @t_bpno and @t_epno) 
and (ca.datea between @t_bdate and @t_edate)
--vcc
insert into @tmp (gno,pno,product,unit,mon,datea,memo,vcgmount,vcgweight,vcmoney,vcprice)
select '1'gno,u.noa,u.product,u.unit,left(va.datea,6),va.datea,'直接銷售 '+va.noa,vb.mount,vb.weight,vb.total,vb.price
from view_vcc102 va left join view_vccs102 vb on va.noa=vb.noa left join ucc u on vb.productno=u.noa
where (u.typea='4' or u.typea='5') --原物料
and (u.noa between @t_bpno and @t_epno) 
and (va.datea between @t_bdate and @t_edate)

--插入月份合計
insert into @tmp
select '2',pno,product,unit,mon,'','本月合計'
,SUM(rcmount),SUM(rcweight),null,SUM(rcmoney) 
,SUM(vcgmount),SUM(vcgweight),SUM(vcgcost),SUM(vcmoney),null,null,null,null,null
from @tmp where gno='1' group by pno,product,unit,mon

--插入產品合計
insert into @tmp
select '3',pno,product,unit,mon,'','合計'
,SUM(rcmount),SUM(rcweight),null,SUM(rcmoney) 
,SUM(vcgmount),SUM(vcgweight),SUM(vcgcost),SUM(vcmoney),null,null,null,null,null
from @tmp where gno='2' group by pno,product,unit,mon


declare @gno nvarchar(1),@pno nvarchar(50),@product nvarchar(50),@unit nvarchar(10),
	@mon nvarchar(10),@datea nvarchar(10),@memo nvarchar(max),
	@rcmount float,@rcweight float,@rcprice float,@rcmoney float,
	@vcgmount float,@vcgweight float,@vcgcost float,@vcmoney float,@vcprice float,
	@lmount float,@lweight float,@lprice float,@lmoney float
	
declare @t_price float,@t_mount float,@t_weight float,@t_money float

declare cursor_table cursor for 
select * from @tmp order by pno,mon,gno,datea
open cursor_table 
fetch next from cursor_table 
into @gno,@pno,@product,@unit,@mon,@datea,@memo,@rcmount,@rcweight,@rcprice,@rcmoney,
@vcgmount,@vcgweight,@vcgcost,@vcmoney,@vcprice,@lmount,@lweight,@lprice,@lmoney
while(@@FETCH_STATUS <> -1) 
begin 
	if(@gno=0)
	begin
		set @t_price=@lprice
		set @t_mount=@lmount
		set @t_weight=@lweight
		set @t_money=@lmoney
	end
	else
	begin
		if(charindex('進料',@memo)>0)
		begin
			set @t_mount=@t_mount+@rcmount
			set @t_weight=@t_weight+@rcweight
			set @t_money=@t_money+@rcmoney
			set @t_price=case when @t_money=0 then 0 else @t_money/(case when UPPER(@unit)!='KG' then @t_mount else @t_weight end) end
			
			update @tmp
			set lmount=@t_mount,lweight=@t_weight,lmoney=@t_money,lprice=@t_price
			where datea=@datea and pno=@pno and memo=@memo
		end
		
		if(charindex('領料',@memo)>0 or charindex('直接銷售',@memo)>0)
		begin
			set @t_mount=@t_mount-@vcgmount
			set @t_weight=@t_weight-@vcgweight
			set @vcgcost=@t_price*(case when UPPER(@unit)!='KG' then @vcgmount else @vcgweight end)
			set @t_money=@t_money-@vcgcost
			set @t_price=case when @t_money=0 then 0 else @t_money/(case when UPPER(@unit)!='KG' then @t_mount else @t_weight end)end
			
			update @tmp
			set lmount=@t_mount,lweight=@t_weight,lmoney=@t_money,lprice=@t_price,vcgcost=@vcgcost
			where datea=@datea and pno=@pno and memo=@memo
		end
		
		if(@gno='3')
		begin
			update @tmp
			set lmount=@t_mount,lweight=@t_weight,lmoney=@t_money,lprice=@t_price,vcgcost=@vcgcost
			where datea=@datea and pno=@pno and memo=@memo
		end
		
	end
	
	fetch next from cursor_table 
	into @gno,@pno,@product,@unit,@mon,@datea,@memo,@rcmount,@rcweight,@rcprice,@rcmoney,
	@vcgmount,@vcgweight,@vcgcost,@vcmoney,@vcprice,@lmount,@lweight,@lprice,@lmoney
end 
close cursor_table 
deallocate cursor_table 


select gno,pno,product,unit,mon,datea,memo

,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,round(rcmount,0)),1)),4,12)) rcmount
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(rcweight,2)),1)),0,30)) rcweight
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(rcprice,2)),1)),0,30)) rcprice
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,round(rcmoney,0)),1)),4,12)) rcmoney

,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,round(vcgmount,0)),1)),4,12)) vcgmount
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(vcgweight,2)),1)),0,30)) vcgweight
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,round(vcgcost,0)),1)),4,12)) vcgcost
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,round(vcmoney,0)),1)),4,12)) vcmoney
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(vcprice,2)),1)),0,30)) vcprice

,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,round(lmount,0)),1)),4,12)) lmount
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(lweight,2)),1)),0,30)) lweight
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,round(lprice,2)),1)),0,30)) lprice
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,round(lmoney,0)),1)),4,12)) lmoney

from @tmp order by pno,mon,gno,datea;
--*********************************************************************************************