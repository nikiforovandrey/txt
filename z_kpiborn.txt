z_kpiborn1:--z_kpiborn1
declare @t_bdate nvarchar(20)
declare @t_edate nvarchar(20)
set @t_bdate = case when '#non' = [2] then '[1]/01/01' else [2] end
set @t_edate = case when '#non' = [3] then '[1]/01/31' else [3] end
declare @kpi_tmp table(
	gno nvarchar(1),
	idno int identity(0,1),
	kpitype int, ----0 = % , 1 = other
	kpi_name nvarchar(max),
	kpi_formula nvarchar(max),
	kpi_value float,
	kpi_unit nvarchar(max)
)
insert into @kpi_tmp
	select '0',0,'生產準時率','生產準時筆數/應生產筆數',round(cast(sum(a.diffdate) as float)/cast(count(a.diffdate) as float),4),''
	from (
		select
			case when 
				DATEDIFF(day ,CONVERT(datetime,cast(cast(left(a.uindate,3) as int)+1911 as nvarchar)+right(a.uindate,6)),
						CONVERT(datetime,cast(cast(left(a.enddate,3) as int)+1911 as nvarchar)+right(a.enddate,6))) <=0 then 1
			else 0 end diffdate
		from work[1] a
		where (a.datea between @t_bdate and @t_edate) and
		 (len(ltrim(rtrim(a.uindate))) > 0) and isnull(a.enddate,'') != ''
	) a
insert into @kpi_tmp
	select '0',0,'生產良率','(良品-不良品)/良品',round(cast(sum(a.mount)-sum(a.errmount) as float)/cast(sum(a.mount) as float),4),''
	from (
		select
			sum(b.errmount) errmount,sum(b.mount) mount
		from workd[1] a
		left join workds[1] b on a.noa = b.noa
		where (a.datea between @t_bdate and @t_edate)
	) a
insert into @kpi_tmp
	select '0',0,'機台稼動率','(負荷時間-停機時間)/負荷時間',
	case when a.borntime > 0 then round((a.borntime-stoptime)/a.borntime,4) else 0 end,''
	from (
		select sum(a.borntime) borntime,(sum(a.chgtime)+sum(a.faulttime)+sum(a.delaytime)+sum(a.waittime)+
				sum(a.waitfedtime)+	sum(a.lacksss)) stoptime
		from cuws[1] a
		left join cuw[1] b on a.noa = b.noa
		where b.datea between @t_bdate and @t_edate 
	) a
insert into @kpi_tmp
	select '0',1,'人員生產效率','總產值(數量)/員工總人數',round(cast(sum(mount) as float)/cast(sum(ssstotal) as float),4),' 單位/人'
	from (
		select sum(a.mount) mount ,0 ssstotal
		from work[1] a
		where (a.datea between @t_bdate and @t_edate)
		union
		select 0 mount, count(*) ssstotal
		from sss
	) a
insert into @kpi_tmp
	select '0',0,'生產逾期率','生產逾期筆數/應生產筆數',round(cast(sum(a.diffdate) as float)/cast(count(a.diffdate) as float),4),''
	from (
		select
			case when 
				DATEDIFF(day ,CONVERT(datetime,cast(cast(left(a.uindate,3) as int)+1911 as nvarchar)+right(a.uindate,6)),
						CONVERT(datetime,cast(cast(left(a.enddate,3) as int)+1911 as nvarchar)+right(a.enddate,6))) >0 then 1
			else 0 end diffdate
		from work[1] a
		where (a.datea between @t_bdate and @t_edate) and
		 (len(ltrim(rtrim(a.uindate))) > 0) and isnull(a.enddate,'') != ''
	) a
insert into @kpi_tmp
	select '0',0,'生產重工率','重工數量/應生產數',round(cast(sum(a.rmount) as float)/cast(sum(a.mount) as float),4),''
	from (
		select
			sum(a.mount) mount,sum(a.rmount) rmount
		from work[1] a
		where (a.datea between @t_bdate and @t_edate)
	) a
insert into @kpi_tmp
	select '0',0,'生產比重率','',0,''
insert into @kpi_tmp
	select '0',0,'生產用料比','產出量/投入量',round(cast(sum(a.mount) as float)/cast(sum(b.mount) as float),4),''
	from work[1] a
	left join works[1] b on a.noa = b.noa
	where (a.datea between @t_bdate and @t_edate)
insert into @kpi_tmp
	select '0',1,'生產製造費用比','製造費用/製造數量',round(cast(sum(a.makes_money) as float)/cast(sum(a.mount) as float),4),' /單位'
	from (
		select
			sum(a.makes*a.hours) makes_money,sum(a.mount) mount
		from work[1] a
		where (a.datea between @t_bdate and @t_edate)
	) a
insert into @kpi_tmp
	select '0',1,'生產直接人工成本比','直接人工費用/製造數量',round(cast(sum(a.wages_money) as float)/cast(sum(a.mount) as float),4),' /單位'
	from (
		select
			sum(a.wages*a.hours) wages_money,sum(a.mount) mount
		from work[1] a
		where (a.datea between @t_bdate and @t_edate)
	) a
select gno,idno,kpi_name,kpi_formula,
	case when kpitype=0 then cast(isnull(kpi_value,0)*100 as nvarchar) + '%' else cast(isnull(kpi_value,0) as nvarchar)+kpi_unit end kpi_value,
	@t_bdate t_bdate,@t_edate t_edate
from @kpi_tmp;