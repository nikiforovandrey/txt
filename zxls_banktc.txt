zxls_banktc:--zxls_banktc
	SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	declare @workerno nvarchar(20)
	declare @worker nvarchar(20)
	
	set @workerno=[1]
	set @worker=[2]
	
	declare @nn int
	declare @a nvarchar(max)
	declare @b nvarchar(max)
	declare @c nvarchar(max)
	declare @d nvarchar(max)
	declare @e nvarchar(max)
	declare @f nvarchar(max)
	declare @g nvarchar(max)
	declare @h nvarchar(max)
	declare @i nvarchar(max)
	declare @j nvarchar(max)
	
	declare @bankno nvarchar(20)
	declare @bank nvarchar(50)
	declare @account nvarchar(50)
	declare @datea nvarchar(10)
	declare @memo nvarchar(max)
	declare @money1 float
	declare @money2 float
	declare @money3 float
	declare @transbank nvarchar(20)
	declare @memo2 nvarchar(max)
	declare @checkno nvarchar(20)
	declare @timea nvarchar(20)
	
	declare @tmps table(
		noq nvarchar(10),
		account nvarchar(50),
		datea nvarchar(10),
		memo nvarchar(max),
		money1 float,
		money2 float,
		money3 float,
		transbank nvarchar(20),
		memo2 nvarchar(max),
		checkno nvarchar(20),
		timea nvarchar(20)
	)
	
	set @nn = 1

	declare cursor_table cursor for
	select a,b,c,d,e,f,g,h,i,j from ztmpxls
	open cursor_table
	fetch next from cursor_table
	into @a,@b,@c,@d,@e,@f,@g,@h,@i,@j
	while(@@FETCH_STATUS <> -1)
	begin
		if(@nn<=999)--資料筆數,不得超過999,否則NOQ編碼有問題
		begin
			begin try
				set @account = REPLACE(@a,'=','')
				set @datea = LEFT(@b,3)+'/'+SUBSTRING(@b,4,2)+'/'+SUBSTRING(@b,6,2)
				set @memo = @c
				set @money1 = CAST(@d as float)
				set @money2 = CAST(@e as float)
				set @money3 = CAST(@f as float)
				set @transbank = @g
				set @memo2 = REPLACE(@h,'=','')
				set @checkno = @i
				set @timea = @j
				set @checkno = ''
				if LEN(rtrim(Ltrim(@i)))>0
				begin
					select @checkno= gqbno from gqb where ([money]=@money1 or [money]=@money2) and CHARINDEX(rtrim(Ltrim(@i)),gqbno)>0 
					set @checkno = case when len(isnull(@checkno,''))=0 then RTRIM(LTRIM(@i)) else @checkno end
				end
				if LEN(@account)>0 and len(@datea)>0
				begin
					insert into @tmps(noq,account,datea,memo,money1,money2,money3,transbank,memo2,checkno,timea)
					select right('000'+CAST(@nn as nvarchar),3),@account,@datea,@memo,@money1,@money2,@money3,@transbank,@memo2,@checkno,@timea
					set @nn = @nn +1
				end
			end try
			begin catch
				--do nothing
			end catch	
		end
		
		fetch next from cursor_table
		into @a,@b,@c,@d,@e,@f,@g,@h,@i,@j
	end
	close cursor_table
	deallocate cursor_table
	
	declare @noa nvarchar(20)
	
	set @datea = right('000'+cast(year(GETDATE())-1911 as nvarchar),3)+'/'
	+right('00'+cast(month(GETDATE()) as nvarchar),2)+'/'
	+right('00'+cast(day(GETDATE()) as nvarchar),2)
	set @noa = ''
	select @noa = max(noa) from banktmp where datea=@datea and noa like replace(@datea,'/','')+'[0-9][0-9][0-9]'
	if @noa is null
	begin
		set @noa = replace(@datea,'/','')+'001'
	end
	else
	begin
		set @noa = replace(@datea,'/','') + right('000'+ cast(cast(RIGHT(@noa,3) as int)+1 as nvarchar),3)
	end
	select @bankno = '', @bank = '', @account = ''
	select top 1 @account = account from @tmps where len(account)>0
	if len(@account)>0
	begin
		select @bankno=noa,@bank=bank,@account=account from bank where replace(account,'-','')=@account
	end

	--insert data
	insert into banktmps(noa,noq,account,datea,memo,money1,money2,money3,transbank,memo2,checkno,timea)
	select @noa,noq,account,datea,memo,money1,money2,money3,transbank,memo2,checkno,timea 
	from @tmps
	--insert into 
	insert into banktmp(noa,datea,bankno,bank,account,worker)
	select @noa,@datea,@bankno,@bank,@account,@worker;