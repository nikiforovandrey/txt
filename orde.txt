post:--orde
--訂單轉出貨單
SET QUOTED_IDENTIFIER OFF
declare @noa nvarchar(20)=[2]--單據編號[2]
declare @year nvarchar(20)=[1]--年度[1]
declare @condition nvarchar(20)=[3]--動作 0 刪除, 1 新增[3]
-----------------------------------------------------------------------
declare @cmd nvarchar(max)
declare @odate nvarchar(20)
declare @vccno nvarchar(50)
declare @autovcc nvarchar(50)=(select totalus from view_orde where noa=@noa)
declare @quatno nvarchar(50)=(select quatno from view_orde where noa=@noa)
declare @stype nvarchar(50)=(select stype from view_orde where noa=@noa)

if(@condition='0')
begin
	if(@autovcc=1)
	begin
		set @vccno=(select quatno from view_orde where noa=@noa)
		--刪除產生的vcc
		set @cmd="delete vcc"+@year+" where noa='"+@vccno+"'"
		EXECUTE sp_executesql @cmd
		set @cmd="delete vccs"+@year+" where noa='"+@vccno+"'"
		EXECUTE sp_executesql @cmd
		
		--清除quatno
		set @cmd="update orde"+@year+" set quatno='' where noa='"+@noa+"'"
		EXECUTE sp_executesql @cmd
		
	end
end

if(@condition='1')
begin
	--取得訂單日期
	if(@autovcc=1)
	begin
		select @odate=odate from view_orde where noa=@noa
		
		--檢查ordeno的quatno是否已有編號(表示編輯)
		if(LEN(@quatno)=0)
		begin
			--取得當天最後一個出貨單號
			select @vccno=MAX(noa) from view_vcc where noa like 'D'+REPLACE(@odate,'/','')+'%'
			
			--新的出貨單號(後面號碼+1)
			set @vccno='D'+REPLACE(@odate,'/','')+
			+right('000'+cast(cast(RIGHT(isnull(@vccno,'000'),3) as int)+1 as nvarchar(10)),3)
		end
		else
		begin
			set @vccno=@quatno
		end
		
		--將orde的內容轉至vcc
		set @cmd="insert vcc"+@year+"(noa,ordeno,typea,stype,datea,custno,comp,nick,tel,fax,post,addr,post2,addr2,salesno,sales
		,cno,acomp,invono,paytype,trantype,money,tax,taxtype,total,worker,worker2,unpay,payed,memo,mon)
		select '"+@vccno+"' noa,noa ordeno,'1' typea,'"+@stype+"' stype,odate,custno,comp,nick,tel,fax,post,addr,post2,addr2,salesno,sales
		,cno,acomp,postname invono,paytype,trantype,money,tax,taxtype,total,worker,worker2,total unpay,0 payed,memo,mon
		from orde"+@year+" where noa='"+@noa+"'"
		EXECUTE sp_executesql @cmd
		
		set @cmd="insert vccs"+@year+"(noa,noq,datea,typea,productno,product,unit,spec,mount,weight
		,lengthb,width,dime,radius,size,price,total,memo,ordeno,no2,storeno,store,custno)
		select '"+@vccno+"' noa,a.no2 noq,'"+@odate+"','1' typea,a.productno,a.product,a.unit
		,(select spec from ucc where noa=a.productno) spec
		,a.mount,a.weight,a.lengthb,a.width,a.dime,a.radius,a.size
		,a.price,a.total,a.memo,a.noa ordeno,a.no2
		,(select top 1 noa from store where noa=b.cno)storeno
		,(select top 1 store from store where noa=b.cno) store,b.custno
		from ordes"+@year+" a left join orde"+@year+" b on a.noa=b.noa where a.noa='"+@noa+"'"
		EXECUTE sp_executesql @cmd
		
		if(LEN(@quatno)=0)
		begin
			--資料寫入dno 避免下次自動產生出現問題
			insert dno(tablea,noa,usera)
			select 'vcc',@vccno,'z001'
			
			set @cmd="update orde"+@year+" set quatno='"+@vccno+"' where noa='"+@noa+"'"
			EXECUTE sp_executesql @cmd
		end
	end
end;

apv:--orde_apv
	SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	declare @t_userno nvarchar(max)
	declare @t_ordeno nvarchar(max)
	
	set @t_userno = [1]
	set @t_ordeno = [2]
	
	declare @namea nvarchar(20)
	declare @credit float
	declare @total float
	declare @accy nvarchar(20)
	declare @apv nvarchar(max)
	declare @tmp table(
		err int,
		msg nvarchar(max),
		ordeno nvarchar(max),
		userno nvarchar(max),
		namea nvarchar(max)
	)
	if (select COUNT(1) from @tmp)=0 and not exists(select * from nhpe where noa=@t_userno)
	begin
		insert into @tmp(err,msg)values(2,'【'+isnull(@t_userno,'')+'】查無使用者')
	end
	select @namea=namea,@credit=isnull(credit,0) from nhpe where noa=@t_userno
	-------------------------------------------------------------------------------------------------------
	if (select COUNT(1) from @tmp)=0 and not exists(select noa from view_orde where noa=@t_ordeno)
	begin
		insert into @tmp(err,msg)values(3,'【'+isnull(@t_ordeno,'')+'】查無訂單')
	end
	select @accy=accy,@total=isnull(total,0),@apv=apv from view_orde where noa=@t_ordeno
	-------------------------------------------------------------------------------------------------------
	if (select COUNT(1) from @tmp)=0 and LEN(ISNULL(@apv,''))>0
	begin
		insert into @tmp(err,msg)values(4,'訂單【'+@t_ordeno+'】已被【'+@apv+'】核准')
	end
	-------------------------------------------------------------------------------------------------------
	if (select COUNT(1) from @tmp)=0 and @credit<@total
	begin
		insert into @tmp(err,msg)values(5,'【'+isnull(@t_userno,'')+' '+isnull(@namea,'')+'】使用者額度不足')
	end
	-------------------------------------------------------------------------------------------------------
	if (select COUNT(1) from @tmp)=0 and (@credit>=@total and ISNULL(@credit,0)>0)
	begin
		set @cmd = "update orde"+@accy+" set apv=@namea where noa=@t_ordeno"
		execute sp_executesql @cmd,N'@namea nvarchar(20),@t_ordeno nvarchar(20)'
			,@namea=@namea,@t_ordeno=@t_ordeno
		insert into @tmp(err,ordeno,userno,namea)values(1,@t_ordeno,@t_userno,@namea)
		insert into drun(datea,timea,usera,action,noa,tablea,title,memo)
		values(CONVERT(nvarchar,GETDATE(),111),left(CONVERT(nvarchar,GETDATE(),108),5),@t_userno,'apv',@t_ordeno,'orde','核準','')
	end
	
	select * from @tmp;