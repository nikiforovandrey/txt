z_fixa3:--z_fixa3
	declare @t_accy nvarchar(10)
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_carno nvarchar(20)
	declare @t_carplateno nvarchar(20)
	declare @t_bdriverno nvarchar(20)
	declare @t_edriverno nvarchar(20)
	declare @t_money nvarchar(20)
	declare @t_btggno nvarchar(20)
	declare @t_etggno nvarchar(20)
	
	set @t_accy = [1]
	set @t_bdate = case when '#non'=[2] then '' else [2] end
	set @t_edate = case when '#non'=[3] then char(255) else [3] end
	set @t_carno = case when '#non'=[4] then '' else [4] end
	set @t_carplateno = case when '#non'=[5] then '' else [5] end
	set @t_bdriverno = case when '#non'=[6] then '' else [6] end
	set @t_edriverno = case when '#non'=[7] then char(255) else [7] end
	set @t_money = case when '#non'=[8] then '' else [8] end 
	set @t_btggno = case when '#non'=[9] then '' else [9] end
	set @t_etggno = case when '#non'=[10] then char(255) else [10] end
	----------------------------------------------------------------------------------------------------------
	return;
	
z_fixa2:--z_fixa2
	declare @t_accy nvarchar(10)
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_carno nvarchar(20)
	declare @t_carplateno nvarchar(20)
	declare @t_bdriverno nvarchar(20)
	declare @t_edriverno nvarchar(20)
	declare @t_money nvarchar(20)
	declare @t_btggno nvarchar(20)
	declare @t_etggno nvarchar(20)
	
	set @t_accy = [1]
	set @t_bdate = case when '#non'=[2] then '' else [2] end
	set @t_edate = case when '#non'=[3] then char(255) else [3] end
	set @t_carno = case when '#non'=[4] then '' else [4] end
	set @t_carplateno = case when '#non'=[5] then '' else [5] end
	set @t_bdriverno = case when '#non'=[6] then '' else [6] end
	set @t_edriverno = case when '#non'=[7] then char(255) else [7] end
	set @t_money = case when '#non'=[8] then '' else [8] end 
	set @t_btggno = case when '#non'=[9] then '' else [9] end
	set @t_etggno = case when '#non'=[10] then char(255) else [10] end
	----------------------------------------------------------------------------------------------------------
	return;

z_fixa1:--z_fixa1
	declare @t_accy nvarchar(10)
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_carno nvarchar(20)
	declare @t_carplateno nvarchar(20)
	declare @t_bdriverno nvarchar(20)
	declare @t_edriverno nvarchar(20)
	declare @t_money nvarchar(20)
	declare @t_btggno nvarchar(20)
	declare @t_etggno nvarchar(20)
	
	set @t_accy = [1]
	set @t_bdate = case when '#non'=[2] then '' else [2] end
	set @t_edate = case when '#non'=[3] then char(255) else [3] end
	set @t_carno = case when '#non'=[4] then '' else [4] end
	set @t_carplateno = case when '#non'=[5] then '' else [5] end
	set @t_bdriverno = case when '#non'=[6] then '' else [6] end
	set @t_edriverno = case when '#non'=[7] then char(255) else [7] end
	set @t_money = case when '#non'=[8] then '' else [8] end 
	set @t_btggno = case when '#non'=[9] then '' else [9] end
	set @t_etggno = case when '#non'=[10] then char(255) else [10] end
	----------------------------------------------------------------------------------------------------------
	declare @n  int
	begin try
		set  @n  =  cast(@t_money  as  int)
	end  try
	begin catch
		set  @n  =  0
	end catch
	
	declare @carno nvarchar(20)
	declare @carplateno nvarchar(20)
	declare @carplate nvarchar(20)
	declare @product nvarchar(50)
	declare @money float
	declare @money2 float
	----------------------------------------------------------------------------------------------------------
	declare @tmp1 table(
		carno  nvarchar(20),
		carplateno  nvarchar(20),
		wmoney float,
		cmoney  float,
		[money] float,
		tax float,
		discount  float,
		total  float	
	)
	insert  into  @tmp1
	select  a.carno,a.carplateno,sum(isnull(a.wmoney,0)),sum(isnull(a.cmoney,0)),sum(isnull(a.[money],0))
	,sum(isnull(a.tax,0)),sum(isnull(a.discount,0)),sum(isnull(a.total,0))
	from  fixa  a
	where  (a.fixadate  between  @t_bdate  and  @t_edate)
	and (len(@t_carno)=0 or a.carno=@t_carno)
	and (len(@t_carplateno)=0 or a.carplateno=@t_carplateno)
	and (a.driverno between @t_bdriverno and @t_edriverno)
	group  by  a.carno,a.driverno,a.carplateno
	
	declare @tmp2 table(
		carno  nvarchar(20),
		carplateno  nvarchar(20),
		productno  nvarchar(20),
		product  nvarchar(50),
		unit  nvarchar(20),
		price  float,
		mount  float,
		[money] float
	)
	insert  into  @tmp2
	select  b.carno,b.carplateno,a.productno,a.product,a.unit,a.price,a.mount,a.[money]
	from  fixas  a
	left  join  fixa  b  on  a.noa=b.noa
	where  (b.fixadate  between  @t_bdate  and  @t_edate)  and  ISNULL(a.[money],0)>=@n
	and (len(@t_carno)=0 or b.carno=@t_carno)
	and (len(@t_carplateno)=0 or b.carplateno=@t_carplateno)
	and (b.driverno between @t_bdriverno and @t_edriverno)
	----------------------------------------------------------------------------------------------------------
	declare @tmp table(
		gno nvarchar(3),
		carno  nvarchar(20),
		money1 float,
		carplateno nvarchar(20),
		carplate nvarchar(20),
		money2 float,
		product nvarchar(40),
		money3 float--
	)
	declare cursor_table cursor for
	select carno,sum(total) from @tmp1 where len(isnull(carplateno,''))=0  group  by  carno 
	open cursor_table
	fetch next from cursor_table
	into @carno,@money
	while(@@FETCH_STATUS <> -1)
	begin
		insert into @tmp(carno,money1)values(@carno,@money)

		fetch next from cursor_table
		into @carno,@money
	end
	close cursor_table
	deallocate cursor_table

	declare cursor_table cursor for
	select carno,carplateno,sum(total) from @tmp1 where len(isnull(carplateno,''))>0  group  by  carno,carplateno 
	open cursor_table
	fetch next from cursor_table
	into @carno,@carplateno,@money
	while(@@FETCH_STATUS <> -1)
	begin
		if  exists(select  *  from  @tmp  where  carno=@carno  and  (carplateno  is  null))
			update  @tmp  set  carplateno=@carplateno,money2=@money  where  carno=@carno  and  (carplateno  is  null)
		else
			insert into @tmp(carno,carplateno,money2)values(@carno,@carplateno,@money)

		fetch next from cursor_table
		into @carno,@carplateno,@money
	end
	close cursor_table
	deallocate cursor_table
	
	declare cursor_table cursor for
	select carno,carplateno,product,[money] from @tmp2
	open cursor_table
	fetch next from cursor_table
	into @carno,@carplateno,@product,@money
	while(@@FETCH_STATUS <> -1)
	begin
		if exists(select * from @tmp where carno=@carno and (product is null))
			update top(1) @tmp set product=@product,money3=@money where  carno=@carno and (product is null)
		else
			insert into @tmp (carno,product,money3)values(@carno,@product,@money)
		
		fetch next from cursor_table
		into @carno,@carplateno,@product,@money
	end
	close cursor_table
	deallocate cursor_table
	
	declare cursor_table cursor for
	select carplateno from @tmp where len(isnull(carplateno,''))>0 group by carplateno
	open cursor_table
	fetch next from cursor_table
	into @carplateno
	while(@@FETCH_STATUS <> -1)
	begin
		set @carplate = ''
		select @carplate=carplate  from  carplate  where  noa=@carplateno
		update @tmp  set  carplate=@carplate   where  carplateno=@carplateno
		fetch next from cursor_table
		into @carplateno
	end
	close cursor_table
	deallocate cursor_table
	update @tmp set gno='0'
	
	insert into @tmp 
	select '1',carno,SUM(ISNULL(money1,0)),'','',SUM(ISNULL(money2,0)),'',SUM(ISNULL(money3,0))
	from  @tmp  where  gno='0'  group  by  carno
	insert into @tmp 
	select '2',CHAR(255),SUM(ISNULL(money1,0)),'','',SUM(ISNULL(money2,0)),'',SUM(ISNULL(money3,0))
	from  @tmp  where  gno='0'
	

	select  *,carno cc
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,money1),1)),4,12)) cm1
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,money2),1)),4,12)) cm2
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,money3),1)),4,12)) cm3
	from  @tmp 
	order by carno,gno,carplateno desc,money1 desc;

	

z_fixa4:--z_fixa4
	declare @t_accy nvarchar(10)
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_carno nvarchar(20)
	declare @t_carplateno nvarchar(20)
	declare @t_bdriverno nvarchar(20)
	declare @t_edriverno nvarchar(20)
	declare @t_money nvarchar(20)
	declare @t_btggno nvarchar(20)
	declare @t_etggno nvarchar(20)
	
	set @t_accy = [1]
	set @t_bdate = case when '#non'=[2] then '' else [2] end
	set @t_edate = case when '#non'=[3] then char(255) else [3] end
	set @t_carno = case when '#non'=[4] then '' else [4] end
	set @t_carplateno = case when '#non'=[5] then '' else [5] end
	set @t_bdriverno = case when '#non'=[6] then '' else [6] end
	set @t_edriverno = case when '#non'=[7] then char(255) else [7] end
	set @t_money = case when '#non'=[8] then '' else [8] end 
	set @t_btggno = case when '#non'=[9] then '' else [9] end
	set @t_etggno = case when '#non'=[10] then char(255) else [10] end
	----------------------------------------------------------------------------------------------------------
	declare @tggno nvarchar(20)
	declare @comp nvarchar(40)
	declare @nick nvarchar(20)
	declare @noa nvarchar(20)
	declare @money float
	declare @tax float
	declare @discount float
	declare @total float
	
	declare @tmp table(
		gno nvarchar(3),
		noa nvarchar(20),
		fixadate  nvarchar(10),
		tggno nvarchar(20),
		comp nvarchar(20),
		nick nvarchar(20),
		[money] float,
		tax float,
		discount float,
		total float,
		fixdate  nvarchar(10),
		productno  nvarchar(20),
		product  nvarchar(50),
		mount  float,
		price  float,
		moneys  float
	)
	insert  into  @tmp
	select '0',a.noa,b.fixadate, b.tggno,'','',b.[money],b.tax,b.discount,b.total,b.fixadate,a.productno,a.product,a.mount,a.price,a.[money]  from  fixas  a
	left  join  fixa  b  on  a.noa=b.noa
	where  (b.fixadate between  @t_bdate  and  @t_edate)
	and  (b.tggno  between  @t_btggno  and  @t_etggno)
	order by b.tggno,b.fixadate,a.noa,a.noq
	
	declare cursor_table cursor for
	select tggno from @tmp where  gno='0' group by tggno
	open cursor_table
	fetch next from cursor_table
	into @tggno
	while(@@FETCH_STATUS <> -1)
	begin
		select @money=0,@tax=0,@discount=0,@total=0 

		declare cursor_table2 cursor for
		select noa from @tmp where  gno='0' and tggno=@tggno group by noa
		open cursor_table2
		fetch next from cursor_table2
		into @noa
		while(@@FETCH_STATUS <> -1)
		begin
			select  top(1) @money=@money+[money]
			,@tax=@tax+[tax]
			,@discount=@discount+[discount]
			,@total=@total+[total]
			from @tmp where noa=@noa

			insert  into  @tmp(gno,noa,tggno)values('1',@noa,@tggno)
			
			fetch next from cursor_table2
			into @noa
		end
		close cursor_table2
		deallocate cursor_table2

		insert  into  @tmp(gno,noa,tggno,[money],tax,discount,total)values('2',CHAR(255),@tggno,@money,@tax,@discount,@total)
		
		select @comp='',@nick=''
		select @comp=comp,@nick=nick from tgg where noa=@tggno
		update @tmp set comp=@comp,nick=@nick where tggno=@tggno
		fetch next from cursor_table
		into @tggno
	end
	close cursor_table
	deallocate cursor_table
	
	-----------------------------------------------------------------------------------------------
	select a.*
	,fixadate  dd
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,[money]),1)),4,12)) m1
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,tax),1)),4,12)) t1
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,discount),1)),4,12)) d1
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total),1)),4,12)) t2
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,moneys),1)),4,12)) m2
	from @tmp  a order by tggno,noa,gno;