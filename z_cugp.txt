z_cugp1:--z_cugp1
declare @t_bstation nvarchar(50)
declare @t_estation nvarchar(50)

set @t_bstation = case when '#non' = [2] then '' else  [2] end
set @t_estation = case when '#non' = [3] then CHAR(255) else  [3] end
---------------------------------------------------------------------------------------------------------------------------------
declare @tmp table(
	gno  nvarchar(1),
	sidno int identity(1,1),
	idno nvarchar(50),
	workno nvarchar(50),
	processno nvarchar(50),
	processs nvarchar(50),
	stationno nvarchar(50),
	stations nvarchar(50),
	productno nvarchar(50),
	products nvarchar(90),
	mount float,
	hours float,
	days float,
	workdate nvarchar(50),
	enddate nvarchar(50),
	datea nvarchar(50),
	ghours float ,
	gens float 
)

--插入已排程的製令且未完工
insert into @tmp
select '0',a.noq,a.workno,a.processno,a.process,b.stationno,b.station,a.productno,a.product,a.mount,a.hours,a.days,a.cuadate,a.uindate,a.uindate,c.hours,c.gen
from cugs[1] a left join work[1] b on a.workno=b.noa  left join station c on b.stationno=c.noa
where b.enda!='1' and (b.stationno between @t_bstation and @t_estation) 
order by a.noa,a.noq

--插入未排程的製令
insert into @tmp
select '2','',a.noa,a.processno,a.process,a.stationno,a.station,a.productno,a.product,a.mount,a.hours,round(a.mount/(b.hours*b.gen),0),cuadate,uindate,'',b.hours,b.gen
from view_work[1] a left join station b on a.stationno=b.noa
where enda!='1' and (a.stationno between @t_bstation and @t_estation)  and a.noa not in (select workno from cugs[1])
and a.stationno!=''
order by a.stationno,case when a.cuadate='' then '999/99/99' else a.cuadate end,case when a.uindate='' then '999/99/99' else a.uindate end,a.hours,a.rank,a.productno

declare @t_stationno nvarchar(50)
declare @stationno nvarchar(50)
declare @sidno nvarchar(50)
declare @noq int
set @t_stationno='XXX___XXXX'
--寫入idno
declare cursor_table cursor for 
select stationno,sidno from @tmp where gno='2' order by stationno,sidno
open cursor_table 
fetch next from cursor_table 
into @stationno,@sidno
while(@@FETCH_STATUS <> -1) 
begin 
	if(@t_stationno='XXX___XXXX' or @t_stationno!=@stationno)
	begin
		set @noq=1
	end
	
	update @tmp
	set idno= right('0000'+cast(@noq as nvarchar(50)),4)
	where sidno=@sidno
	
	set @noq=@noq+1
	set @t_stationno=@stationno

	fetch next from cursor_table 
	into @stationno,@sidno
end 
close cursor_table 
deallocate cursor_table 

--今天日期
declare @now_date nvarchar(30)
set @now_date=CONVERT (VARCHAR(7), GETDATE(),12 )+0890000
set @now_date=left(@now_date,3)+'/'+substring(@now_date,4,2)+'/'+right(@now_date,2)

insert into @tmp (gno,stationno,stations,datea,ghours,gens)
select '1',stationno,MAX(stations),@now_date,MAX(ghours),MAX(gens) from @tmp group by stationno
insert into @tmp (gno,stationno,stations)
select '3',stationno,MAX(stations) from @tmp group by stationno

update a
set datea=(select MAX(datea) from @tmp where stationno=a.stationno)
from @tmp a where gno='0' or gno='1'

select gno,idno,workno,processno,processs,stationno,stations,productno,products
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,mount),1)),0,15)) mount 
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,hours),1)),0,15)) hours 
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,days),1)),0,15)) days 
,workdate,enddate,datea
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,ghours),1)),0,15)) ghours 
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,gens),1)),0,15)) gens 
from @tmp
order by stationno,gno,idno;

