z_kpibcc1:--z_kpibcc1
declare @t_bdate nvarchar(20)
declare @t_edate nvarchar(20)
set @t_bdate = case when '#non' = [2] then '[1]/01/01' else [2] end
set @t_edate = case when '#non' = [3] then '[1]/01/31' else [3] end

declare @kpi_tmp table(
	gno nvarchar(1),
	idno int,
	bno nvarchar(max),
	bcc nvarchar(max),
	kpi_name nvarchar(max),
	kpi_value float
)

insert into @kpi_tmp
select '0',1,b.bccno,MAX(b.bccname),'進貨良率',round((sum(b.mount)-sum(b.errmount))/sum(b.mount),4)*100
from bccin a left join bccins b on a.noa=b.noa
where a.datea between @t_bdate and @t_edate and a.typea='1'--進貨
group by b.bccno

insert into @kpi_tmp
select '0',2,productno,MAX(product)product,'平均進貨天數',AVG(xdays) from (
select ob.productno,ob.product
,datediff(d,CONVERT(datetime,CONVERT(nvarchar(10),CONVERT(int,left(oa.odate,3))+1911)+'/'+right(left(oa.odate,6),2)+'/'+right(oa.odate,2))
,CONVERT(datetime,CONVERT(nvarchar(10),CONVERT(int,left(bb.datea,3))+1911)+'/'+right(left(bb.datea,6),2)+'/'+right(bb.datea,2))) xdays
from ordc102 oa left join ordcs102 ob on oa.noa=ob.noa left join bccins bb on ob.noa=bb.ordcno and ob.no2=bb.no2
where oa.odate between @t_bdate and @t_edate
)tmp group by productno

insert into @kpi_tmp
select '0',3,productno,MAX(product)product,'進貨準時率'
,cast((select count(*) from ordc102 oc left join ordcs102 od on oc.noa=od.noa left join bccins bs on od.noa=bs.ordcno and od.no2=bs.no2 
where oc.odate between @t_bdate and @t_edate and bs.datea=oc.trandate and od.productno=ob.productno) as float)
/COUNT(*) *100 
from ordc102 oa left join ordcs102 ob on oa.noa=ob.noa
where oa.odate between @t_bdate and @t_edate 
group by ob.productno 

insert into @kpi_tmp
select '0',4,b.bccno,MAX(b.bccname),'退貨比率',
case when sum(case when a.typea='1' then b.total else 0 end)=0  and sum(case when a.typea='1' then 0 else b.total end)>0 then 100
when sum(case when a.typea='1' then b.total else 0 end)=0  and sum(case when a.typea='1' then 0 else b.total end)=0 then 0
else sum(case when a.typea='1' then 0 else b.total end)/sum(case when a.typea='1' then b.total else 0 end) *100 end
from bccin a left join bccins b on a.noa=b.noa
where a.datea between @t_bdate and @t_edate
group by b.bccno


declare @t_pbdate nvarchar(20)
declare @t_pedate nvarchar(20)
set @t_pbdate=right('0'+cast(cast(left(@t_bdate,3) as int)-1 as nvarchar(20)),3)+right(@t_bdate,6)
set @t_pedate=right('0'+cast(cast(left(@t_edate,3) as int)-1 as nvarchar(20)),3)+right(@t_edate,6)

insert into @kpi_tmp
select '0',5,b.bccno,MAX(b.bccname),'進貨成本降低率',
(isnull((select sum((case when c.typea='1' then 1 else -1 end) * d.total)
from bccin c left join bccins d on c.noa=d.noa where c.datea between @t_pbdate and @t_pedate and d.bccno=b.bccno ),0)
-sum((case when a.typea='1' then 1 else -1 end) * b.total))
/sum((case when a.typea='1' then 1 else -1 end) * b.total) *100
from bccin a left join bccins b on a.noa=b.noa
where a.datea between @t_bdate and @t_edate
group by b.bccno

declare @t_pbdate3 nvarchar(20)
set @t_pbdate3=
			left(right('0'+CONVERT (nvarchar(7),CONVERT (VARCHAR(7),dateadd(m,-3,CONVERT(datetime ,CONVERT(nvarchar(10),CONVERT(int,left(@t_bdate,3))+1911)+right(left(@t_bdate,6),2)+right(@t_bdate,2)) ),12 )+0890000),7),3)+'/'
			+right(left(right('0'+CONVERT (nvarchar(7),CONVERT (VARCHAR(7),dateadd(m,-3,CONVERT(datetime ,CONVERT(nvarchar(10),CONVERT(int,left(@t_bdate,3))+1911)+right(left(@t_bdate,6),2)+right(@t_bdate,2)) ),12 )+0890000),7),5),2)+'/'
			+right(right('0'+CONVERT (nvarchar(7),CONVERT (VARCHAR(7),dateadd(m,-3,CONVERT(datetime ,CONVERT(nvarchar(10),CONVERT(int,left(@t_bdate,3))+1911)+right(left(@t_bdate,6),2)+right(@t_bdate,2)) ),12 )+0890000),7),2)

insert into @kpi_tmp
--總存貨
select '0',6,bccno,MAX(bccname),'潛在呆滯率',
	--呆滯存貨
	isnull((select SUM(mount) from (
		--之前進/退貨
		select a.datea,b.bccno,b.bccname
		,(case when a.typea='1' then 1 else -1 end )*b.mount mount
		from bccin a left join bccins b on a.noa=b.noa where a.datea < @t_pbdate3
		union all
		--之前領料
		select a.datea,b.bccno,b.bccname,-1*(mount-bkbcc) mount
		from bccout a left join bccouts b on a.noa=b.noa where a.datea < @t_pbdate3
		union all
		--進期領料
		select a.datea,b.bccno,b.bccname,-1*(mount-bkbcc) mount
		from bccout a left join bccouts b on a.noa=b.noa 
		where a.datea between @t_bdate and @t_edate
	)tmp where tmp.bccno=tmpa.bccno),0)
/SUM(mount) *100 from (
--進/退貨
select a.datea,b.bccno,b.bccname
,(case when a.typea='1' then 1 else -1 end )*b.mount mount
from bccin a left join bccins b on a.noa=b.noa 
union all
--領料
select a.datea,b.bccno,b.bccname,-1*(mount-bkbcc) mount
from bccout a left join bccouts b on a.noa=b.noa 
)tmpa where datea <= @t_edate group by bccno


insert into @kpi_tmp(gno,bno,bcc)
select '1',bno,MAX(bcc)
from @kpi_tmp group by bno

select gno,idno,bno,bcc,kpi_name
,case when idno=2 then
reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,kpi_value),1)),4,30)) +' 天'
else
reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,kpi_value),1)),0,30)) +' %' 
end kpi_value
,@t_bdate bdate,@t_edate edate from @kpi_tmp order by bno,gno,idno;
--******************************************************************************************
z_kpibcc2:--z_kpibcc2
declare @t_bdate nvarchar(20)
declare @t_edate nvarchar(20)
set @t_bdate = case when '#non' = [2] then '[1]/01/01' else [2] end
set @t_edate = case when '#non' = [3] then '[1]/01/31' else [3] end

declare @kpi_tmp table(
	gno nvarchar(1),
	idno int,
	tggno nvarchar(max),
	tggs nvarchar(max),
	kpi_name nvarchar(max),
	kpi_value float
)

insert into @kpi_tmp
select '0',1,a.tggno,MAX(a.tgg),'進貨良率',round((sum(b.mount)-sum(b.errmount))/sum(b.mount),4)*100
from bccin a left join bccins b on a.noa=b.noa
where a.datea between @t_bdate and @t_edate and a.typea='1'--進貨
group by tggno

insert into @kpi_tmp
select '0',2,tggno,MAX(tgg),'進貨準時率',
cast((select COUNT(*)from bccin a right join ordc[1] b on a.ordcno=b.noa where (b.odate between @t_bdate and @t_edate) and a.datea=b.trandate and b.tggno=tmp.tggno)as float)--准時數
/COUNT(*)--預計進貨筆數(採購筆數)
*100 from ordc[1] tmp where odate between @t_bdate and @t_edate group by tmp.tggno

insert into @kpi_tmp
select '0',3,a.tggno,MAX(a.tgg),'退貨比率',
case when sum(case when a.typea='1' then b.total else 0 end)=0  and sum(case when a.typea='1' then 0 else b.total end)>0 then 100
when sum(case when a.typea='1' then b.total else 0 end)=0  and sum(case when a.typea='1' then 0 else b.total end)=0 then 0
else sum(case when a.typea='1' then 0 else b.total end)/sum(case when a.typea='1' then b.total else 0 end) *100 end
from bccin a left join bccins b on a.noa=b.noa
where a.datea between @t_bdate and @t_edate
group by a.tggno

insert into @kpi_tmp(gno,tggno,tggs)
select '1',tggno,MAX(tggs)
from @kpi_tmp group by tggno

select gno,idno,tggno,tggs,kpi_name
,reverse(substring(reverse(convert(nvarchar(30),CONVERT(money,kpi_value),1)),0,30)) +' %' kpi_value
,@t_bdate bdate,@t_edate edate from @kpi_tmp order by tggno,gno,idno;