z_salaward1:--z_salaward1
declare @show_year nvarchar(10)
declare @linknoa nvarchar(30)
declare @before_year nvarchar(10)
declare @before_linknoa nvarchar(30)
declare @t_bsssno nvarchar(20)
declare @t_esssno nvarchar(20)
set @show_year = case when '#non'=[2] then '' else [2] end
set @before_year = CAST(@show_year as int)-1
set @t_bsssno = case when '#non'=[3] then '' else [3] end
set @t_esssno = case when '#non'=[4] then char(255) else [4] end
select @linknoa = noa from salaward where (year = @show_year) and (typea = '年終')
select @before_linknoa = noa from salaward where (year = @before_year) and (typea = '年終')
declare @tmp table(
	gno nvarchar(1),
	idno int identity(0,1),
	part nvarchar(50),
	b_year int,
	b_mon int,
	senior nvarchar(20),
	sssno nvarchar(20),
	namea nvarchar(50),
	salary nvarchar(20),
	boa nvarchar(20),
	bot nvarchar(20),
	bos nvarchar(20),
	boo nvarchar(20),
	total nvarchar(20),
	oldmidmon nvarchar(20),
	total1 nvarchar(20),
	total6 nvarchar(20),
	total5 nvarchar(20),
	total7 nvarchar(20),
	total8 nvarchar(20),
	first nvarchar(20),
	second nvarchar(20),
	memo2 nvarchar(MAX)
)
insert into @tmp 
	select 
		'1' gno ,a.part,left(a.indate,3) b_year,right(left(a.indate,6),2) b_mon,
		'' senior,a.sssno,a.namea,a.salary,a.bo_traffic,a.bo_special,a.bo_admin,a.bo_oth,
		a.money as total,a.oldmidmon,
		isnull(c.total6,0),a.total6,a.total5,a.total7,a.total8,a.firstmoney,a.secondmoney,a.memo2
	from salawards a
	left join salawards c on c.noa = @before_linknoa
	where (a.noa = @linknoa) and (a.sssno between @t_bsssno and @t_esssno)
update @tmp set senior = (
	case when ((@show_year-b_year)=0 and (12-b_mon) = 0) then '未滿一月' else (
		case when (@show_year-b_year) >0 then cast((@show_year-b_year) as nvarchar) + ' 年 ' else '' end + 
		case when (12-b_mon) >0 then cast((12-b_mon) as nvarchar) + ' 月' else '' end
	)
	end
)
insert into @tmp(gno,part,senior,namea,salary,bot,bos,boa,boo,total,oldmidmon,
				 total1,total6,total5,total7,total8,first,second,memo2)
	select
		'0' gno,part,senior,namea,
		reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,salary),1)),4,12)) salary,
		reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,bot),1)),4,12)) bot,
		reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,bos),1)),4,12)) bos,
		reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,boa),1)),4,12)) boa,
		reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,boo),1)),4,12)) boo,
		reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total),1)),4,12)) total,
		reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,oldmidmon),1)),4,12)) oldmidmon,
		reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total1),1)),4,12)) total1,
		reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total6),1)),4,12)) total6,
		reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total5),1)),4,12)) total5,
		reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total7),1)),4,12)) total7,
		reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total8),1)),4,12)) total8,
		reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,first),1)),4,12)) first,
		reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,second),1)),4,12)) second,
		memo2
	from @tmp
select
	gno,part,senior,namea,salary,
	case when (bot = '0') then '' else bot end bot,
	case when (bos = '0') then '' else bos end bos,
	case when (boa = '0') then '' else boa end boa,
	case when (boo = '0') then '' else boo end boo,
	total,oldmidmon,total1,total6,total5,total7,total8,first,second,memo2
from @tmp where gno = 0;
--*************************************************************************************************************
z_salaward2:--z_salaward2
declare @show_year nvarchar(10)
declare @linknoa nvarchar(30)
declare @t_bsssno nvarchar(20)
declare @t_esssno nvarchar(20)
set @show_year = case when '#non'=[2] then '' else [2] end
set @t_bsssno = case when '#non'=[3] then '' else [3] end
set @t_esssno = case when '#non'=[4] then char(255) else [4] end
select @linknoa = noa from salaward where (year = @show_year) and (typea = '秋節')
declare @tmp table(
	gno nvarchar(1),
	idno int identity(1,1),
	part nvarchar(50),
	namea nvarchar(50),
	salary nvarchar(20),
	adjustmoney nvarchar(20),
	sugmoney nvarchar(20),
	chkmoney nvarchar(20),
	memo nvarchar(max)
)
insert into @tmp
	select '0' gno,'' part,namea,salary,adjustmoney,sugmoney,chkmoney,memo2
	from salawards where (noa = @linknoa) and (sssno between @t_bsssno and @t_esssno)
insert into @tmp
	select '1','','',SUM(cast(salary as int)),SUM(cast(adjustmoney as int)),
			SUM(cast(sugmoney as int)),SUM(cast(chkmoney as int)),''
	from @tmp where gno = 0
---整理資料(加入千分位)
update @tmp set salary = reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,salary),1)),4,12)) where (salary > 0)
update @tmp set adjustmoney = reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,adjustmoney),1)),4,12)) where (adjustmoney > 0)
update @tmp set sugmoney = reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,sugmoney),1)),4,12)) where (sugmoney > 0)
update @tmp set chkmoney = reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,chkmoney),1)),4,12)) where (chkmoney > 0)
---整理資料(0為空)
update @tmp set salary = '' where (salary = '0')
update @tmp set adjustmoney = '' where (adjustmoney = '0')
update @tmp set sugmoney = '' where (sugmoney = '0')
update @tmp set chkmoney = '' where (chkmoney = '0')
select * from @tmp;