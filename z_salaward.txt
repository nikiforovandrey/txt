z_salaward1:--z_salaward1
declare @year nvarchar(10)
declare @before_year nvarchar(10)
declare @t_bsssno nvarchar(20)
declare @t_esssno nvarchar(20)

set @year = case when '#non'=[2] then '' else [2] end
set @before_year = CAST(@year as int)-1
set @t_bsssno = case when '#non'=[3] then '' else [3] end
set @t_esssno = case when '#non'=[4] then char(255) else [4] end

------------------------------------------------------今年基本年終資料
declare @tmp table( 
gno nvarchar(1), 
part nvarchar(50), 
senior nvarchar(20), 
sssno nvarchar(20), 
namea nvarchar(50), 
indate nvarchar(10),
salary float, 
boa float, 
bot float, 
bos float, 
boo float, 
total float, 
oldmidmon float, 
oldtotal float, 
total6 float, 
total5 float, 
total7 float, 
total8 float, 
first float, 
second float, 
memo2 nvarchar(MAX) 
) 
insert into @tmp 
select '0' gno ,b.part,'' senior,b.sssno,b.namea,b.indate
,b.salary,b.bo_traffic,b.bo_special,b.bo_admin,b.bo_oth,b.money as total,b.oldmidmon 
,'',b.total6,b.total5,b.total7,b.total8,b.firstmoney,b.secondmoney,b.memo2 
from salaward a left join salawards b on a.noa=b.noa
where (a.year = @year) and (typea='年終') and (b.sssno between @t_bsssno and @t_esssno) 

------------------------------------------------------------------------------------------
--年資
update @tmp 
set senior = ( 
case when (CAST(left(indate,3) as int)=0) then '未滿一月' else ( 
	case when (@year-CAST(left(indate,3) as int)) >0 then cast((@year-CAST(left(indate,3) as int)) as nvarchar) + ' 年 ' else '' end + 
	case when (12-CAST(right(left(indate,6),2) as int)) >0 then cast((12-CAST(right(left(indate,6),2) as int)) as nvarchar) + ' 月' else '' end )
end) 
-------------------------------------------------------------------------------------------
--去年年終
declare @sssno nvarchar(20) 

declare cursor_table cursor for
	select sssno from @tmp
	open cursor_table
	fetch next from cursor_table
	into @sssno
	while(@@FETCH_STATUS <> -1)
	begin
		update @tmp
		set oldtotal=(select total8 from salaward a left join salawards b on a.noa=b.noa where (a.year = @before_year) and (typea='年終') and (b.sssno =@sssno) )
		where sssno=@sssno
		fetch next from cursor_table
		into @sssno
	end
close cursor_table
deallocate cursor_table
------------------------------------------------------------------
--插入總計
insert into @tmp 
select '1' gno ,'','','','',''
,sum(salary),sum(bot),sum(bos),sum(boa),sum(boo),sum(total),sum(oldmidmon) 
,sum(oldtotal),sum(total6),sum(total5),sum(total7),sum(total8),sum(first),sum(second),'' 
from @tmp where gno='0'


-------------------------------------
select gno,part,senior,namea, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,salary),1)),4,12)) salary, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,bot),1)),4,12)) bot, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,bos),1)),4,12)) bos, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,boa),1)),4,12)) boa, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,boo),1)),4,12)) boo, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total),1)),4,12)) total, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,oldmidmon),1)),4,12)) oldmidmon, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,oldtotal),1)),4,12)) total1, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total6),1)),4,12)) total6, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total5),1)),4,12)) total5, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total7),1)),4,12)) total7, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total8),1)),4,12)) total8, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,first),1)),4,12)) first, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,second),1)),4,12)) second, 
memo2,(select worker from salaward where (year = @year) and (typea = '年終'))worker 
from @tmp;
--*************************************************************************************************************
z_salaward2:--z_salaward2
declare @year nvarchar(10)
declare @t_bsssno nvarchar(20)
declare @t_esssno nvarchar(20)

set @year = case when '#non'=[2] then '' else [2] end
set @t_bsssno = case when '#non'=[3] then '' else [3] end
set @t_esssno = case when '#non'=[4] then char(255) else [4] end

declare @tmp table( 
gno nvarchar(1), 
idno int identity(1,1),
part nvarchar(50), 
namea nvarchar(50), 
salary float, 
adjustmoney float, 
sugmoney float, 
chkmoney float, 
memo nvarchar(max) 
) 
insert into @tmp 
select '0' gno,part,namea,salary,adjustmoney,sugmoney,chkmoney,memo2 
from salaward a left join salawards b on a.noa=b.noa 
where (a.year = @year) and (a.typea='秋節') and (b.sssno between @t_bsssno and @t_esssno) 

insert into @tmp 
select '1','','',SUM(salary),SUM(adjustmoney), SUM(sugmoney),SUM(chkmoney),'' 
from @tmp where gno = '0'

select gno,idno,part,namea,memo
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,salary),1)),4,12)) salary
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,adjustmoney),1)),4,12)) adjustmoney
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,sugmoney),1)),4,12)) sugmoney
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,chkmoney),1)),4,12)) chkmoney
,(select worker from salaward where (year = @year) and (typea = '秋節'))worker 
from @tmp;