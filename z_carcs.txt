z_carcs04:--z_carcs04
	SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	declare @t_accy nvarchar(10)
	declare @t_btrandate nvarchar(10)
	declare @t_etrandate nvarchar(10)
	
	set @t_accy = '[1]'
	set @t_btrandate = case when '#non'=[2] then '' else [2] end
	set @t_etrandate = case when '#non'=[3] then CHAR(255) else [3] end
	---------------------------------------------------------------------------------
	declare @t_pageCount int
	declare @t_pageCount2 int
	set @t_pageCount = 5 --一頁顯示幾欄
	set @t_pageCount2 = 6 --一頁顯示幾欄
	--------------------------------------------------------------------
	IF OBJECT_ID('tempdb..#tmp')is not null
	BEGIN
		drop table #tmp
	END
	create table #tmp(
		page int,
		pno int,
		gno nvarchar(10),
		item nvarchar(40),
		--營運明細
		cc1 nvarchar(20),
		cp1 nvarchar(40),
		ma1 float, --靠行車
		mb1 float, --公司車
		cc2 nvarchar(20),
		cp2 nvarchar(40),
		ma2 float, --靠行車
		mb2 float, --公司車
		cc3 nvarchar(20),
		cp3 nvarchar(40),
		ma3 float, --靠行車
		mb3 float, --公司車
		cc4 nvarchar(20),
		cp4 nvarchar(40),
		ma4 float, --靠行車
		mb4 float, --公司車
		cc5 nvarchar(20),
		cp5 nvarchar(40),
		ma5 float, --靠行車
		mb5 float, --公司車
		--業績收入
		dd1 nvarchar(20),
		dp1 nvarchar(40),
		mc1 float, --靠行車
		dd2 nvarchar(20),
		dp2 nvarchar(40),
		mc2 float, --靠行車
		dd3 nvarchar(20),
		dp3 nvarchar(40),
		mc3 float, --靠行車
		dd4 nvarchar(20),
		dp4 nvarchar(40),
		mc4 float, --靠行車
		dd5 nvarchar(20),
		dp5 nvarchar(40),
		mc5 float, --靠行車
		dd6 nvarchar(20),
		dp6 nvarchar(40),
		mc6 float --靠行車
	)
	--租車
	declare @tmpa table(
		custno nvarchar(20),
		money1 float,--靠行車
		money2 float--公司車
	)
	insert into @tmpa
	select isnull(b.custno,'')
	,SUM(case when ISNULL(c.isoutside,0)=0 then a.inmoney else 0 end) 
	,SUM(case when ISNULL(c.isoutside,0)=1 then a.inmoney else 0 end) 
	from carcsas a
	left join carcsa b on a.noa=b.noa
	left join calctypes c on c.noa+c.noq=a.calctype
	where (isnull(b.trandate,'') between @t_btrandate and @t_etrandate)
	group by isnull(b.custno,'')
	--內銷
	declare @tmpb table(
		custno nvarchar(20),
		money1 float,--靠行車
		money2 float--公司車
	)
	insert into @tmpb
	select isnull(a.custno,'')
	,SUM(case when ISNULL(c.isoutside,0)=0 then a.inmoney else 0 end) 
	,SUM(case when ISNULL(c.isoutside,0)=1 then a.inmoney else 0 end) 
	from carcsb a
	left join calctypes c on c.noa+c.noq=a.calctype
	where (isnull(a.datea,'') between @t_btrandate and @t_etrandate)
	group by isnull(a.custno,'')
	--外銷
	declare @tmpc table(
		custno nvarchar(20),
		money1 float,--靠行車
		money2 float--公司車
	)
	insert into @tmpc
	select isnull(a.custno,'')
	,SUM(case when ISNULL(c.isoutside,0)=0 then a.inmoney else 0 end) 
	,SUM(case when ISNULL(c.isoutside,0)=1 then a.inmoney else 0 end) 
	from carcsc a
	left join calctypes c on c.noa+c.noq=a.calctype
	where (isnull(a.trandate,'') between @t_btrandate and @t_etrandate)
	group by isnull(a.custno,'')
	---------------------------------------------------------------------------
	declare @listCust table(
		page int,
		n int,
		custno nvarchar(20)
	)
	insert into @listCust
	select null,null,custno from @tmpa
	union 
	select null,null,custno from @tmpb
	union 
	select null,null,custno from @tmpc
	order by custno
	
	declare @custno nvarchar(20)
	declare @n int
	declare @page int
	
	set @n = 0
	declare cursor_table cursor for
	select custno from @listCust
	open cursor_table
	fetch next from cursor_table
	into @custno
	while(@@FETCH_STATUS <> -1)
	begin
		update @listCust set page = floor(@n/@t_pageCount),n=@n%@t_pageCount where custno=@custno
		set @n = @n + 1
		fetch next from cursor_table
		into @custno
	end
	close cursor_table
	deallocate cursor_table
	insert into @listCust(page,n,custno)values(floor(@n/@t_pageCount),@n%@t_pageCount,'合計')
	--------------------------------------------------------------------------------------------------
	declare @listCust2 table(
		page int,
		n int,
		custno nvarchar(20)
	)
	insert into @listCust2
	select null,null,custno from @tmpa
	union 
	select null,null,custno from @tmpb
	union 
	select null,null,custno from @tmpc
	order by custno
	
	set @n = 0
	declare cursor_table cursor for
	select custno from @listCust2
	open cursor_table
	fetch next from cursor_table
	into @custno
	while(@@FETCH_STATUS <> -1)
	begin
		update @listCust2 set page = floor(@n/@t_pageCount2),n=@n%@t_pageCount2 where custno=@custno
		set @n = @n + 1
		fetch next from cursor_table
		into @custno
	end
	close cursor_table
	deallocate cursor_table
	insert into @listCust2(page,n,custno)values(floor(@n/@t_pageCount2),@n%@t_pageCount2,'共同費用')
	set @n = @n + 1
	insert into @listCust2(page,n,custno)values(floor(@n/@t_pageCount2),@n%@t_pageCount2,'合計')
	--------------------------------------------------------------------------------------------------
	declare @money1 float
	declare @money2 float
	declare @comp nvarchar(20)
	
	declare @tot_page int
	declare @tot_n int
	select @tot_page=null,@tot_n=null
	select @tot_page=page,@tot_n=n from @listCust where custno='合計'
	
	declare cursor_table cursor for
	select page,n,custno from @listCust
	open cursor_table
	fetch next from cursor_table
	into @page,@n,@custno
	while(@@FETCH_STATUS <> -1)
	begin	
		if not exists(select * from #tmp where page=@page)
		begin
			insert into #tmp(page,pno,gno)values(@page,1,'1')
			insert into #tmp(page,pno,gno,item)values(@page,2,'2','內銷收入（未稅）')
			insert into #tmp(page,pno,gno,item)values(@page,3,'2','外銷收入（未稅）')
			insert into #tmp(page,pno,gno,item)values(@page,4,'2','租車收入（未稅）')	
			insert into #tmp(page,pno,gno,item)values(@page,5,'2','【收入總計】')	
		end
		select @comp = case when @custno='合計' then '合計' else '' end
		select @comp = nick from cust where noa=@custno
		set @cmd = "update #tmp set cc"+CAST(@n+1 as nvarchar)+"=@custno,cp"+CAST(@n+1 as nvarchar)+"=isnull(@comp,'')"
		+" where page=@page"
		execute sp_executesql @cmd,N'@custno nvarchar(20),@comp nvarchar(40),@page int'
		,@custno=@custno,@comp=@comp,@page=@page
		
		--內銷 pno=2
		declare cursor_table2 cursor for
		select money1,money2 from @tmpb where custno=@custno
		open cursor_table2
		fetch next from cursor_table2
		into @money1,@money2
		while(@@FETCH_STATUS <> -1)
		begin			
			set @cmd = "update #tmp set"
				+" ma"+CAST(@n+1 as nvarchar)+"=@money1"
				+",mb"+CAST(@n+1 as nvarchar)+"=@money2"
				+" where page=@page and pno=2"
			execute sp_executesql @cmd,N'@money1 float,@money2 float,@page int'
			,@money1=@money1,@money2=@money2,@page=@page
			
			set @cmd = "update #tmp set"
				+" ma"+CAST(@tot_n+1 as nvarchar)+"= isnull(ma"+CAST(@tot_n+1 as nvarchar)+",0) + @money1"
				+",mb"+CAST(@tot_n+1 as nvarchar)+"= isnull(mb"+CAST(@tot_n+1 as nvarchar)+",0) + @money2"
				+" where page=@tot_page and pno=2"
			execute sp_executesql @cmd,N'@money1 float,@money2 float,@tot_page int'
			,@money1=@money1,@money2=@money2,@tot_page=@tot_page
			
			fetch next from cursor_table2
			into @money1,@money2
		end
		close cursor_table2
		deallocate cursor_table2
		--外銷  pno=3
		declare cursor_table2 cursor for
		select money1,money2 from @tmpc where custno=@custno
		open cursor_table2
		fetch next from cursor_table2
		into @money1,@money2
		while(@@FETCH_STATUS <> -1)
		begin			
			set @cmd = "update #tmp set"
				+" ma"+CAST(@n+1 as nvarchar)+"=@money1"
				+",mb"+CAST(@n+1 as nvarchar)+"=@money2"
				+" where page=@page and pno=3"
			execute sp_executesql @cmd,N'@money1 float,@money2 float,@page int'
			,@money1=@money1,@money2=@money2,@page=@page
			
			set @cmd = "update #tmp set"
				+" ma"+CAST(@tot_n+1 as nvarchar)+"= isnull(ma"+CAST(@tot_n+1 as nvarchar)+",0) + @money1"
				+",mb"+CAST(@tot_n+1 as nvarchar)+"= isnull(mb"+CAST(@tot_n+1 as nvarchar)+",0) + @money2"
				+" where page=@tot_page and pno=3"
			execute sp_executesql @cmd,N'@money1 float,@money2 float,@tot_page int'
			,@money1=@money1,@money2=@money2,@tot_page=@tot_page
			
			fetch next from cursor_table2
			into @money1,@money2
		end
		close cursor_table2
		deallocate cursor_table2
		--租車  pno=4
		declare cursor_table2 cursor for
		select money1,money2 from @tmpa where custno=@custno
		open cursor_table2
		fetch next from cursor_table2
		into @money1,@money2
		while(@@FETCH_STATUS <> -1)
		begin		
			set @cmd = "update #tmp set"
				+" ma"+CAST(@n+1 as nvarchar)+"=@money1"
				+",mb"+CAST(@n+1 as nvarchar)+"=@money2"
				+" where page=@page and pno=4"
			execute sp_executesql @cmd,N'@money1 float,@money2 float,@page int'
			,@money1=@money1,@money2=@money2,@page=@page
			
			set @cmd = "update #tmp set"
				+" ma"+CAST(@tot_n+1 as nvarchar)+"= isnull(ma"+CAST(@tot_n+1 as nvarchar)+",0) + @money1"
				+",mb"+CAST(@tot_n+1 as nvarchar)+"= isnull(mb"+CAST(@tot_n+1 as nvarchar)+",0) + @money2"
				+" where page=@tot_page and pno=4"
			execute sp_executesql @cmd,N'@money1 float,@money2 float,@tot_page int'
			,@money1=@money1,@money2=@money2,@tot_page=@tot_page
			
			fetch next from cursor_table2
			into @money1,@money2
		end
		close cursor_table2
		deallocate cursor_table2
		--【收入總計】
		declare cursor_table2 cursor for
		select sum(isnull(money1,0)),sum(isnull(money2,0))
		from(select custno,money1,money2 from @tmpa
		union all
		select custno,money1,money2 from @tmpb
		union all
		select custno,money1,money2 from @tmpc)as a
		where custno=@custno
		group by custno
		open cursor_table2
		fetch next from cursor_table2
		into @money1,@money2
		while(@@FETCH_STATUS <> -1)
		begin		
			set @cmd = "update #tmp set"
				+" ma"+CAST(@n+1 as nvarchar)+"=@money1"
				+",mb"+CAST(@n+1 as nvarchar)+"=@money2"
				+" where page=@page and pno=5"
			execute sp_executesql @cmd,N'@money1 float,@money2 float,@page int'
			,@money1=@money1,@money2=@money2,@page=@page
			
			set @cmd = "update #tmp set"
				+" ma"+CAST(@tot_n+1 as nvarchar)+"= isnull(ma"+CAST(@tot_n+1 as nvarchar)+",0) + @money1"
				+",mb"+CAST(@tot_n+1 as nvarchar)+"= isnull(mb"+CAST(@tot_n+1 as nvarchar)+",0) + @money2"
				+" where page=@tot_page and pno=5"
			execute sp_executesql @cmd,N'@money1 float,@money2 float,@tot_page int'
			,@money1=@money1,@money2=@money2,@tot_page=@tot_page
			
			fetch next from cursor_table2
			into @money1,@money2
		end
		close cursor_table2
		deallocate cursor_table2
		fetch next from cursor_table
		into @page,@n,@custno
	end
	close cursor_table
	deallocate cursor_table
	----------------------------------------------------------------------------------
	select @tot_page=null,@tot_n=null
	select @tot_page=page,@tot_n=n from @listCust2 where custno='合計'
	
	declare @tot_page2 int
	declare @tot_n2 int
	select @tot_page2=null,@tot_n2=null
	select @tot_page2=page,@tot_n2=n from @listCust2 where custno='共同費用'
	
	declare cursor_table cursor for
	select page,n,custno from @listCust2
	open cursor_table
	fetch next from cursor_table
	into @page,@n,@custno
	while(@@FETCH_STATUS <> -1)
	begin	
		if not exists(select * from #tmp where page=@page and pno=6)
		begin		
			insert into #tmp(page,pno,gno)values(@page,6,'3')
		end
		
		if not exists(select * from #tmp where page=@page and pno=7)
		begin		
			insert into #tmp(page,pno,gno,item)values(@page,7,'4','內銷租車手續費收入10%')
		end
		if not exists(select * from #tmp where page=@page and pno=8)
		begin		
			insert into #tmp(page,pno,gno,item)values(@page,8,'4','外銷手續費收入12%')
		end
		if not exists(select * from #tmp where page=@page and pno=9)
		begin		
			insert into #tmp(page,pno,gno,item)values(@page,9,'4','公司車手續費收入10%')
		end
		if not exists(select * from #tmp where page=@page and pno=10)
		begin		
			insert into #tmp(page,pno,gno,item)values(@page,10,'4','5%營業稅收入')
		end
		if not exists(select * from #tmp where page=@page and pno=11)
		begin		
			insert into #tmp(page,pno,gno,item)values(@page,11,'4','<<收入合計>>')
		end
		if not exists(select * from #tmp where page=@page and pno=12)
		begin		
			insert into #tmp(page,pno,gno,item)values(@page,12,'4','減零用金支出(6032)')
		end
		if not exists(select * from #tmp where page=@page and pno=13)
		begin		
			insert into #tmp(page,pno,gno,item)values(@page,13,'4','減租金(6011)')
		end
		if not exists(select * from #tmp where page=@page and pno=14)
		begin		
			insert into #tmp(page,pno,gno,item)values(@page,14,'4','減勞退及勞健保費')
		end
		if not exists(select * from #tmp where page=@page and pno=15)
		begin		
			insert into #tmp(page,pno,gno,item)values(@page,15,'4','減電話費')
		end
		if not exists(select * from #tmp where page=@page and pno=16)
		begin		
			insert into #tmp(page,pno,gno,item)values(@page,16,'4','減薪資')
		end
		if not exists(select * from #tmp where page=@page and pno=17)
		begin		
			insert into #tmp(page,pno,gno,item)values(@page,17,'4','減8%稅費')
		end
		if not exists(select * from #tmp where page=@page and pno=18)
		begin		
			insert into #tmp(page,pno,gno,item)values(@page,18,'4','減水電費(6018)')
		end
		if not exists(select * from #tmp where page=@page and pno=19)
		begin		
			insert into #tmp(page,pno,gno,item)values(@page,19,'4','減保證金利息')
		end
		if not exists(select * from #tmp where page=@page and pno=20)
		begin		
			insert into #tmp(page,pno,gno,item)values(@page,20,'4','<<支出合計>>')
		end
		if not exists(select * from #tmp where page=@page and pno=21)
		begin		
			insert into #tmp(page,pno,gno,item)values(@page,21,'4','【淨利】')
		end
		
		select @comp = case when @custno='合計' then '合計'
							when @custno='共同費用' then '共同費用'
							else '' end
		select @comp = nick from cust where noa=@custno
		set @cmd = "update #tmp set dd"+CAST(@n+1 as nvarchar)+"=@custno,dp"+CAST(@n+1 as nvarchar)+"=isnull(@comp,'')"
		+" where page=@page"
		execute sp_executesql @cmd,N'@custno nvarchar(20),@comp nvarchar(40),@page int'
		,@custno=@custno,@comp=@comp,@page=@page
		
		
		declare cursor_table2 cursor for
		select round(sum(isnull(money1,0))*0.1,0),round(sum(isnull(money2,0))*0.1,0)
		from(select custno,money1,money2 from @tmpa
		union all
		select custno,money1,money2 from @tmpb)as a
		where custno=@custno
		group by custno
		open cursor_table2
		fetch next from cursor_table2
		into @money1,@money2
		while(@@FETCH_STATUS <> -1)
		begin		
			--內租車手續費收入 10%
			set @cmd = "update #tmp set mc"+CAST(@n+1 as nvarchar)+"=@money1"
				+" where page=@page and pno=7"
			execute sp_executesql @cmd,N'@money1 float,@page int'
			,@money1=@money1,@page=@page
			
			set @cmd = "update #tmp set"
				+" mc"+CAST(@tot_n+1 as nvarchar)+"= isnull(mc"+CAST(@tot_n+1 as nvarchar)+",0) + @money1"
				+" where page=@tot_page and pno=7"
			execute sp_executesql @cmd,N'@money1 float,@tot_page int'
			,@money1=@money1,@tot_page=@tot_page
			--收入合計
			set @cmd = "update #tmp set mc"+CAST(@n+1 as nvarchar)+"= isnull(mc"+CAST(@n+1 as nvarchar)+",0) + @money1"
				+" where page=@page and pno=11"
			execute sp_executesql @cmd,N'@money1 float,@page int'
			,@money1=@money1,@page=@page
			
			set @cmd = "update #tmp set"
				+" mc"+CAST(@tot_n+1 as nvarchar)+"= isnull(mc"+CAST(@tot_n+1 as nvarchar)+",0) + @money1"
				+" where page=@tot_page and pno=11"
			execute sp_executesql @cmd,N'@money1 float,@tot_page int'
			,@money1=@money1,@tot_page=@tot_page
			
			
			fetch next from cursor_table2
			into @money1,@money2
		end
		close cursor_table2
		deallocate cursor_table2
		
		
		--外銷手續費收入12%
		declare cursor_table2 cursor for
		select round(money1*0.12,0) from @tmpc where custno=@custno
		open cursor_table2
		fetch next from cursor_table2
		into @money1
		while(@@FETCH_STATUS <> -1)
		begin				
			set @cmd = "update #tmp set mc"+CAST(@n+1 as nvarchar)+"=@money1"
				+" where page=@page and pno=8"
			execute sp_executesql @cmd,N'@money1 float,@page int'
			,@money1=@money1,@page=@page
			
			set @cmd = "update #tmp set"
				+" mc"+CAST(@tot_n+1 as nvarchar)+"= isnull(mc"+CAST(@tot_n+1 as nvarchar)+",0) + @money1"
				+" where page=@tot_page and pno=8"
			execute sp_executesql @cmd,N'@money1 float,@tot_page int'
			,@money1=@money1,@tot_page=@tot_page
			--收入合計
			set @cmd = "update #tmp set mc"+CAST(@n+1 as nvarchar)+"= isnull(mc"+CAST(@n+1 as nvarchar)+",0) + @money1"
				+" where page=@page and pno=11"
			execute sp_executesql @cmd,N'@money1 float,@page int'
			,@money1=@money1,@page=@page
			
			set @cmd = "update #tmp set"
				+" mc"+CAST(@tot_n+1 as nvarchar)+"= isnull(mc"+CAST(@tot_n+1 as nvarchar)+",0) + @money1"
				+" where page=@tot_page and pno=11"
			execute sp_executesql @cmd,N'@money1 float,@tot_page int'
			,@money1=@money1,@tot_page=@tot_page
			fetch next from cursor_table2
			into @money1
		end
		close cursor_table2
		deallocate cursor_table2
		--公司車手續費收入10%
		--5%營業稅收入
		declare cursor_table2 cursor for
		select round(sum(isnull(money1,0))*0.05,0),round(sum(isnull(money2,0))*0.1,0)
		from(select custno,money1,money2 from @tmpa
		union all
		select custno,money1,money2 from @tmpb
		union all
		select custno,money1,money2 from @tmpc)as a
		where custno=@custno
		group by custno
		open cursor_table2
		fetch next from cursor_table2
		into @money1,@money2
		while(@@FETCH_STATUS <> -1)
		begin	
			--公司車手續費收入10%			
			set @cmd = "update #tmp set mc"+CAST(@n+1 as nvarchar)+"=@money2"
				+" where page=@page and pno=9"
			execute sp_executesql @cmd,N'@money2 float,@page int'
			,@money2=@money2,@page=@page
			
			set @cmd = "update #tmp set"
				+" mc"+CAST(@tot_n+1 as nvarchar)+"= isnull(mc"+CAST(@tot_n+1 as nvarchar)+",0) + @money2"
				+" where page=@tot_page and pno=9"
			execute sp_executesql @cmd,N'@money2 float,@tot_page int'
			,@money2=@money2,@tot_page=@tot_page
			--收入合計
			set @cmd = "update #tmp set mc"+CAST(@n+1 as nvarchar)+"= isnull(mc"+CAST(@n+1 as nvarchar)+",0) + @money2"
				+" where page=@page and pno=11"
			execute sp_executesql @cmd,N'@money2 float,@page int'
			,@money2=@money2,@page=@page
			
			set @cmd = "update #tmp set"
				+" mc"+CAST(@tot_n+1 as nvarchar)+"= isnull(mc"+CAST(@tot_n+1 as nvarchar)+",0) + @money2"
				+" where page=@tot_page and pno=11"
			execute sp_executesql @cmd,N'@money2 float,@tot_page int'
			,@money2=@money2,@tot_page=@tot_page
			--5%營業稅收入
			set @cmd = "update #tmp set mc"+CAST(@n+1 as nvarchar)+"=@money1"
				+" where page=@page and pno=10"
			execute sp_executesql @cmd,N'@money1 float,@page int'
			,@money1=@money1,@page=@page
			
			set @cmd = "update #tmp set"
				+" mc"+CAST(@tot_n+1 as nvarchar)+"= isnull(mc"+CAST(@tot_n+1 as nvarchar)+",0) + @money1"
				+" where page=@tot_page and pno=10"
			execute sp_executesql @cmd,N'@money1 float,@tot_page int'
			,@money1=@money1,@tot_page=@tot_page
			--收入合計
			set @cmd = "update #tmp set mc"+CAST(@n+1 as nvarchar)+"= isnull(mc"+CAST(@n+1 as nvarchar)+",0) + @money1"
				+" where page=@page and pno=11"
			execute sp_executesql @cmd,N'@money1 float,@page int'
			,@money1=@money1,@page=@page
			
			set @cmd = "update #tmp set"
				+" mc"+CAST(@tot_n+1 as nvarchar)+"= isnull(mc"+CAST(@tot_n+1 as nvarchar)+",0) + @money1"
				+" where page=@tot_page and pno=11"
			execute sp_executesql @cmd,N'@money1 float,@tot_page int'
			,@money1=@money1,@tot_page=@tot_page
			
			fetch next from cursor_table2
			into @money1,@money2
		end
		close cursor_table2
		deallocate cursor_table2
		--減8%稅費
		declare cursor_table2 cursor for
		select round(sum(isnull(money1,0))*0.08,0)
		from(select custno,money1,money2 from @tmpa
		union all
		select custno,money1,money2 from @tmpb
		union all
		select custno,money1,money2 from @tmpc)as a
		where custno=@custno
		group by custno
		open cursor_table2
		fetch next from cursor_table2
		into @money1
		while(@@FETCH_STATUS <> -1)
		begin	
			--減8%稅費		
			set @cmd = "update #tmp set mc"+CAST(@n+1 as nvarchar)+"= isnull(mc"+CAST(@n+1 as nvarchar)+",0) + @money1"
				+" where page=@page and pno=17"
			execute sp_executesql @cmd,N'@money1 float,@page int'
			,@money1=@money1,@page=@page
			
			set @cmd = "update #tmp set"
				+" mc"+CAST(@tot_n+1 as nvarchar)+"= isnull(mc"+CAST(@tot_n+1 as nvarchar)+",0) + @money1"
				+" where page=@tot_page and pno=17"
			execute sp_executesql @cmd,N'@money1 float,@tot_page int'
			,@money1=@money1,@tot_page=@tot_page
			--<<支出合計>>
			set @cmd = "update #tmp set mc"+CAST(@n+1 as nvarchar)+"= isnull(mc"+CAST(@n+1 as nvarchar)+",0) + @money1"
				+" where page=@page and pno=20"
			execute sp_executesql @cmd,N'@money1 float,@page int'
			,@money1=@money1,@page=@page
			
			set @cmd = "update #tmp set"
				+" mc"+CAST(@tot_n+1 as nvarchar)+"= isnull(mc"+CAST(@tot_n+1 as nvarchar)+",0) + @money1"
				+" where page=@tot_page and pno=20"
			execute sp_executesql @cmd,N'@money1 float,@tot_page int'
			,@money1=@money1,@tot_page=@tot_page	
			
			fetch next from cursor_table2
			into @money1
		end
		close cursor_table2
		deallocate cursor_table2
		fetch next from cursor_table
		into @page,@n,@custno
	end
	close cursor_table
	deallocate cursor_table
	---------------------------------------------------------------
	--減零用金支出
	declare cursor_table cursor for
	select a.[money]
	from chgcashs a
	left join chgcash b on a.noa=b.noa
	where isnull(a.partno,'')='09' --中鋼辦公室
	and (isnull(b.dc,'')='1' or isnull(b.dc,'')='4') --耗用OR申請
	and (isnull(b.datea,'') between @t_btrandate and @t_etrandate)
	and left(a.acc1,4)='6032'
	open cursor_table
	fetch next from cursor_table
	into @money1
	while(@@FETCH_STATUS <> -1)
	begin	
		--減零用金支出
		set @cmd = "update #tmp set mc"+CAST(@tot_n2+1 as nvarchar)+"=isnull(mc"+CAST(@tot_n2+1 as nvarchar)+",0) + @money1"
			+" where page=@tot_page2 and pno=12"
		execute sp_executesql @cmd,N'@money1 float,@tot_page2 int'
		,@money1=@money1,@tot_page2=@tot_page2
		
		set @cmd = "update #tmp set"
			+" mc"+CAST(@tot_n+1 as nvarchar)+"= isnull(mc"+CAST(@tot_n+1 as nvarchar)+",0) + @money1"
			+" where page=@tot_page and pno=12"
		execute sp_executesql @cmd,N'@money1 float,@tot_page int'
		,@money1=@money1,@tot_page=@tot_page
		--<<支出合計>>
		set @cmd = "update #tmp set mc"+CAST(@tot_n2+1 as nvarchar)+"= isnull(mc"+CAST(@tot_n2+1 as nvarchar)+",0) + @money1"
			+" where page=@tot_page2 and pno=20"
		execute sp_executesql @cmd,N'@money1 float,@tot_page2 int'
		,@money1=@money1,@tot_page2=@tot_page2
		
		set @cmd = "update #tmp set"
			+" mc"+CAST(@tot_n+1 as nvarchar)+"= isnull(mc"+CAST(@tot_n+1 as nvarchar)+",0) + @money1"
			+" where page=@tot_page and pno=20"
		execute sp_executesql @cmd,N'@money1 float,@tot_page int'
		,@money1=@money1,@tot_page=@tot_page
		
		fetch next from cursor_table
		into @money1
	end
	close cursor_table
	deallocate cursor_table
	--減租金
	declare cursor_table cursor for
	select a.[money]
	from chgcashs a
	left join chgcash b on a.noa=b.noa
	where isnull(a.partno,'')='09' --中鋼辦公室
	and (isnull(b.dc,'')='1' or isnull(b.dc,'')='4') --耗用OR申請
	and (isnull(b.datea,'') between @t_btrandate and @t_etrandate)
	and left(a.acc1,4)='6011'
	open cursor_table
	fetch next from cursor_table
	into @money1
	while(@@FETCH_STATUS <> -1)
	begin	
		--減租金
		set @cmd = "update #tmp set mc"+CAST(@tot_n2+1 as nvarchar)+"=isnull(mc"+CAST(@tot_n2+1 as nvarchar)+",0) + @money1"
			+" where page=@tot_page2 and pno=13"
		execute sp_executesql @cmd,N'@money1 float,@tot_page2 int'
		,@money1=@money1,@tot_page2=@tot_page2
		
		set @cmd = "update #tmp set"
			+" mc"+CAST(@tot_n+1 as nvarchar)+"= isnull(mc"+CAST(@tot_n+1 as nvarchar)+",0) + @money1"
			+" where page=@tot_page and pno=13"
		execute sp_executesql @cmd,N'@money1 float,@tot_page int'
		,@money1=@money1,@tot_page=@tot_page
		--<<支出合計>>
		set @cmd = "update #tmp set mc"+CAST(@tot_n2+1 as nvarchar)+"= isnull(mc"+CAST(@tot_n2+1 as nvarchar)+",0) + @money1"
			+" where page=@tot_page2 and pno=20"
		execute sp_executesql @cmd,N'@money1 float,@tot_page2 int'
		,@money1=@money1,@tot_page2=@tot_page2
		
		set @cmd = "update #tmp set"
			+" mc"+CAST(@tot_n+1 as nvarchar)+"= isnull(mc"+CAST(@tot_n+1 as nvarchar)+",0) + @money1"
			+" where page=@tot_page and pno=20"
		execute sp_executesql @cmd,N'@money1 float,@tot_page int'
		,@money1=@money1,@tot_page=@tot_page
		
		fetch next from cursor_table
		into @money1
	end
	close cursor_table
	deallocate cursor_table
	--減水電費
	declare cursor_table cursor for
	select a.[money]
	from chgcashs a
	left join chgcash b on a.noa=b.noa
	where isnull(a.partno,'')='09' --中鋼辦公室
	and (isnull(b.dc,'')='1' or isnull(b.dc,'')='4') --耗用OR申請
	and (isnull(b.datea,'') between @t_btrandate and @t_etrandate)
	and left(a.acc1,4)='6018'
	open cursor_table
	fetch next from cursor_table
	into @money1
	while(@@FETCH_STATUS <> -1)
	begin	
		--減水電費
		set @cmd = "update #tmp set mc"+CAST(@tot_n2+1 as nvarchar)+"=isnull(mc"+CAST(@tot_n2+1 as nvarchar)+",0) + @money1"
			+" where page=@tot_page2 and pno=18"
		execute sp_executesql @cmd,N'@money1 float,@tot_page2 int'
		,@money1=@money1,@tot_page2=@tot_page2
		
		set @cmd = "update #tmp set"
			+" mc"+CAST(@tot_n+1 as nvarchar)+"= isnull(mc"+CAST(@tot_n+1 as nvarchar)+",0) + @money1"
			+" where page=@tot_page and pno=18"
		execute sp_executesql @cmd,N'@money1 float,@tot_page int'
		,@money1=@money1,@tot_page=@tot_page
		--<<支出合計>>
		set @cmd = "update #tmp set mc"+CAST(@tot_n2+1 as nvarchar)+"= isnull(mc"+CAST(@tot_n2+1 as nvarchar)+",0) + @money1"
			+" where page=@tot_page2 and pno=20"
		execute sp_executesql @cmd,N'@money1 float,@tot_page2 int'
		,@money1=@money1,@tot_page2=@tot_page2
		
		set @cmd = "update #tmp set"
			+" mc"+CAST(@tot_n+1 as nvarchar)+"= isnull(mc"+CAST(@tot_n+1 as nvarchar)+",0) + @money1"
			+" where page=@tot_page and pno=20"
		execute sp_executesql @cmd,N'@money1 float,@tot_page int'
		,@money1=@money1,@tot_page=@tot_page
		
		fetch next from cursor_table
		into @money1
	end
	close cursor_table
	deallocate cursor_table
	---------------------------------------------------------------
	select * 
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,ma1),1)),4,12)) cma1
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,ma2),1)),4,12)) cma2
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,ma3),1)),4,12)) cma3
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,ma4),1)),4,12)) cma4
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,ma5),1)),4,12)) cma5
	
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,mb1),1)),4,12)) cmb1
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,mb2),1)),4,12)) cmb2
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,mb3),1)),4,12)) cmb3
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,mb4),1)),4,12)) cmb4
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,mb5),1)),4,12)) cmb5
	
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,mc1),1)),4,12)) cmc1
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,mc2),1)),4,12)) cmc2
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,mc3),1)),4,12)) cmc3
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,mc4),1)),4,12)) cmc4
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,mc5),1)),4,12)) cmc5
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,mc6),1)),4,12)) cmc6
	from #tmp order by page,pno;
	
z_carcs1:--z_carcs1
declare @t_bdate nvarchar(20)
declare @t_edate nvarchar(20)
declare @t_bcarno nvarchar(20)
declare @t_ecarno nvarchar(20)
declare @t_bdriverno nvarchar(20)
declare @t_edriverno nvarchar(20)
declare @t_typea nvarchar(20)
set @t_bdate = case when '#non' = [2] then '' else [2] end
set @t_edate = case when '#non' = [3] then CHAR(255) else [3] end
set @t_bcarno = case when '#non' = [4] then '' else [4] end
set @t_ecarno = case when '#non' = [5] then CHAR(255) else [5] end
set @t_bdriverno = case when '#non' = [6] then '' else [6] end
set @t_edriverno = case when '#non' = [7] then CHAR(255) else [7] end
set @t_typea = case when '#non' = [8] then '' else [8] end
declare @tmp table(
		gno nvarchar(1),
		noa nvarchar(20),
		carno nvarchar(20),
		datea nvarchar(20),
		driverno nvarchar(20),
		driver nvarchar(20),
		outmount float,
		outmoney float,
		typea nvarchar(20),
		addr nvarchar(90)
)
insert into @tmp
select '0' gno,a.noa,a.carno,b.datea,a.driverno,a.driver,a.mount,a.outmoney,'出租車' typea,a.addr
from carcsas a
left join carcsa  b on a.noa = b.noa
where (b.datea between @t_bdate and @t_edate) and
(a.carno between @t_bcarno and @t_ecarno) and
(a.driverno between @t_bdriverno and @t_edriverno)and
(@t_typea like '%1%')
union all
select '0' gno,noa,carno,datea,driverno,driver,outmount,outmoney,'內銷車' typea,addr
from carcsb
where (datea between @t_bdate and @t_edate) and
(carno between @t_bcarno and @t_ecarno) and
(driverno between @t_bdriverno and @t_edriverno) and
(@t_typea like '%2%')
union all
select '0' gno,noa,carno,datea,driverno,driver,outmount,outmoney,'外銷車' typea,addr
from carcsc
where (datea between @t_bdate and @t_edate) and
(carno between @t_bcarno and @t_ecarno) and
(driverno between @t_bdriverno and @t_edriverno) and
(@t_typea like '%3%')

insert into @tmp
select '1' gno,'',carno,'','','',sum(outmount),sum(outmoney),'',''
from @tmp
group by carno



select gno,noa,carno,datea,driver,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,outmount),1)),4,12)) outmount,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,outmoney),1)),4,12)) outmoney,
typea,addr
from @tmp
order by carno,gno;
-------------------------------------------------------------------------------------------------
z_carcs2:--z_carcs2 
declare @t_bdate nvarchar(20) 
declare @t_edate nvarchar(20) 
declare @t_bcarno nvarchar(20) 
declare @t_ecarno nvarchar(20) 
declare @t_bdriverno nvarchar(20) 
declare @t_edriverno nvarchar(20) 
declare @t_typea nvarchar(20)
declare @t_cartypea nvarchar(20) 
declare  @cmd nvarchar(max)
declare @string nvarchar(max)
declare @n int
set @t_bdate = case when '#non' = [2] then '' else [2] end 
set @t_edate = case when '#non' = [3] then CHAR(255) else [3] end 
set @t_bcarno = case when '#non' = [4] then '' else [4] end 
set @t_ecarno = case when '#non' = [5] then CHAR(255) else [5] end 
set @t_bdriverno = case when '#non' = [6] then '' else [6] end 
set @t_edriverno = case when '#non' = [7] then CHAR(255) else [7] end 
set @t_typea = case when '#non' = [8] then '' else [8] end 
set @t_cartypea = case when '#non' = [23] then '' else [23] end 
IF OBJECT_ID('tempdb..#cartypea')is not null
	BEGIN
		set @cmd = 'drop table #cartypea'
		EXECUTE sp_executesql @cmd
	END
	create table #cartypea(
		noa nvarchar(20)
	)
	set @string = @t_cartypea	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #cartypea select @string
			end
			break
		end
		insert into #cartypea select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
declare @tmp table( 
gno nvarchar(1), 
noa nvarchar(20), 
carno nvarchar(20), 
datea nvarchar(20), 
driverno nvarchar(20), 
driver nvarchar(20), 
addr nvarchar(90), 
cardeal nvarchar(10), 
weightb float, 
inprice float, 
inmount float, 
inmoney float, 
outprice float, 
discount float, 
outmount float, 
outmoney float, 
typea nvarchar(20)
) 
insert into @tmp 
select '0' gno,a.noa,a.carno,e.datea,a.driverno,a.driver,a.addr,case when LEN(b.nick)> 0 then b.nick else left(b.comp,3) end, 
a.weight,a.inprice,a.mount,a.inmoney,a.outprice,a.discount,a.mount,a.outmoney,'出租車' typea
from carcsas a 
left join cardeal b on a.cardealno = b.noa 
left join car2 c on c.carno = a.carno
left join #cartypea d on d.noa = c.cartype
left join carcsa e on a.noa = e.noa
where (e.datea between @t_bdate and @t_edate) and 
(a.carno between @t_bcarno and @t_ecarno) and 
(a.driverno between @t_bdriverno and @t_edriverno)and 
(@t_typea like '%1%' ) and 
(d.noa is not null)
union all 
select '0' gno,a.noa,a.carno,a.datea,a.driverno,a.driver,a.addr,case when LEN(b.nick)> 0 then b.nick else left(b.comp,3) end, 
a.weight,a.inprice,a.inmount,a.inmoney,a.outprice,a.discount,a.outmount,a.outmoney,'內銷車' typea
from carcsb a 
left join cust b on a.carno = b.noa 
left join car2 c on c.carno = a.carno
left join #cartypea d on d.noa = c.cartype
where (datea between @t_bdate and @t_edate) and 
(a.carno between @t_bcarno and @t_ecarno) and 
(a.driverno between @t_bdriverno and @t_edriverno)and 
(@t_typea like '%2%') and 
(d.noa  is  not  null)
union all 
select '0' gno,a.noa,a.carno,a.datea,a.driverno,a.driver,a.addr,case when LEN(b.nick)> 0 then b.nick else left(b.comp,3) end, 
a.weight,a.inprice,a.inmount,a.inmoney,a.outprice,a.discount,a.outmount,a.outmoney,'外銷車' typea
from carcsc a 
left join cust b on a.custno = b.noa 
left join car2 c on c.carno = a.carno
left join #cartypea d on d.noa = c.cartype
where (datea between @t_bdate and @t_edate) and 
(a.carno between @t_bcarno and @t_ecarno) and 
(a.driverno between @t_bdriverno and @t_edriverno)and 
(@t_typea like '%3%') and 
(d.noa  is  not  null)


insert into @tmp 
select '1' gno,'',carno,'','','','', 
'',sum(weightb),sum(inprice),sum(inmount),sum(inmoney),sum(outprice),0,sum(outmount),sum(outmoney),'' 
from @tmp 
group by carno 

insert into @tmp 
select '2' gno,'',CHAR(255),'','','','', 
'',sum(weightb),sum(inprice),sum(inmount),sum(inmoney),sum(outprice),0,sum(outmount),sum(outmoney),'' 
from @tmp 
where gno = 0

select gno,noa,carno,datea,driver,addr,cardeal, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,weightb),1)),4,12)) weightb, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,inprice),1)),4,12)) inprice, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,inmount),1)),4,12)) inmount, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,inmoney),1)),4,12)) inmoney, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,outprice),1)),4,12)) outprice, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,discount),1)),4,12)) discount, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,outmount),1)),4,12)) outmount, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,outmoney),1)),4,12)) outmoney, 
typea 
from @tmp 
order by carno,gno 

drop table #cartypea;
--------------------------------------------------------------------------------------------------------------------------------------------------------
z_carcs3:--z_carcs3
declare @t_bdate nvarchar(20)
declare @t_edate nvarchar(20)
declare @t_bcarno nvarchar(20)
declare @t_ecarno nvarchar(20)
declare @t_bdriverno nvarchar(20)
declare @t_edriverno nvarchar(20)
declare @t_typea nvarchar(20)
set @t_bdate = case when '#non' = [2] then '' else [2] end
set @t_edate = case when '#non' = [3] then CHAR(255) else [3] end
set @t_bcarno = case when '#non' = [4] then '' else [4] end
set @t_ecarno = case when '#non' = [5] then CHAR(255) else [5] end
set @t_bdriverno = case when '#non' = [6] then '' else [6] end
set @t_edriverno = case when '#non' = [7] then CHAR(255) else [7] end
set @t_typea = case when '#non' = [8] then '' else [8] end
declare @tmpa table(
		gno nvarchar(1),
		noa nvarchar(20),
		carnoa nvarchar(20),--靠行車
		carnob nvarchar(20)--公司車
)
insert into @tmpa
select '0' gno,noa,case when cartype = '1' then carno else '' end,case when cartype = '2' then carno else '' end
from car2

declare @tmp table(
		gno nvarchar(1),
		c01 float, 
		c02 float,
		c03 float,
		c04 float,
		c05 float,
		c06 float,
		c07 float,
		c08 float,
		c09 float,
		c10 float,
		d01 float, 
		d02 float,
		d03 float,
		d04 float,
		d05 float,
		d06 float,
		d07 float,
		d08 float,
		d09 float,
		d10 float,
		e01 float, 
		e02 float,
		e03 float,
		e04 float,
		e05 float,
		e06 float,
		e07 float,
		e08 float,
		e09 float,
		e10 float
)
insert into @tmp
select '0',
case when a.cardealno = '18' and a.carno = b.carnoa then a.outmoney end,
case when a.cardealno = '18' and a.carno = b.carnob then a.outmoney end,
case when a.cardealno = '16' and a.carno = b.carnoa then a.outmoney end,
case when a.cardealno = '16' and a.carno = b.carnob then a.outmoney end,
case when a.cardealno = '21' and a.carno = b.carnoa then a.outmoney end,
case when a.cardealno = '21' and a.carno = b.carnob then a.outmoney end,
case when a.cardealno = '14' and a.carno = b.carnoa then a.outmoney end,
case when a.cardealno = '14' and a.carno = b.carnob then a.outmoney end,0,0,
--case when c.cardealno = '18' and c.carno = b.carnoa then c.outmoney end,
--case when c.cardealno = '18' and c.carno = b.carnob then c.outmoney end,
--case when c.cardealno = '16' and c.carno = b.carnoa then c.outmoney end,
--case when c.cardealno = '16' and c.carno = b.carnob then c.outmoney end,
--case when c.cardealno = '21' and c.carno = b.carnoa then c.outmoney end,
--case when c.cardealno = '21' and c.carno = b.carnob then c.outmoney end,
--case when c.cardealno = '14' and c.carno = b.carnoa then c.outmoney end,
--case when c.cardealno = '14' and c.carno = b.carnob then c.outmoney end,
0,0,0,0,0,0,0,0,0,0,0,0,
case when d.cardealno = '18' and d.carno = b.carnoa then d.outmoney end,
case when d.cardealno = '18' and d.carno = b.carnob then d.outmoney end,
case when d.cardealno = '16' and d.carno = b.carnoa then d.outmoney end,
case when d.cardealno = '16' and d.carno = b.carnob then d.outmoney end,
case when d.cardealno = '21' and d.carno = b.carnoa then d.outmoney end,
case when d.cardealno = '21' and d.carno = b.carnob then d.outmoney end,
case when d.cardealno = '14' and d.carno = b.carnoa then d.outmoney end,
case when d.cardealno = '14' and d.carno = b.carnob then d.outmoney end,0,0
from carcsas  a 
left join @tmpa b on a.carno = b.noa
left join carcsb c on c.carno = b.noa
left join carcsc d on d.carno = b.noa

insert into @tmp
select '1' gno,sum(c01),sum(c02),sum(c03),sum(c04),sum(c05),sum(c06),sum(c07),
sum(c08),sum(c01)+sum(c03)+sum(c05)+sum(c07),sum(c02)+sum(c04)+sum(c06)+sum(c08),
sum(d01),sum(d02),sum(d03),sum(d04),sum(d05),sum(d06),sum(d07),
sum(d08),sum(d01)+sum(d03)+sum(d05)+sum(d07),sum(d02)+sum(d04)+sum(d06)+sum(d08),
sum(e01),sum(e02),sum(e03),sum(e04),sum(e05),sum(e06),sum(e07),
sum(e08),sum(e01)+sum(e03)+sum(e05)+sum(e07),sum(e02)+sum(e04)+sum(e06)+sum(e08)
from @tmp






select  '0'gno,c01,c02,c03,c04,c05,c06,c07,c08,c09,c10,
d01,d02,d03,d04,d05,d06,d07,d08,d09,d10,e01,e02,e03,e04,e05,e06,e07,e08,e09,e10
from @tmp
where gno = 1;
--******************************************************************************************
z_tran03:--z_tran03
		SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	declare @t_accy nvarchar(10)
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_btrandate nvarchar(10)
	declare @t_etrandate nvarchar(10)
	declare @t_bcustno nvarchar(20)
	declare @t_ecustno nvarchar(20)
	declare @t_bdriverno nvarchar(20)
	declare @t_edriverno nvarchar(20)
	declare @t_carno nvarchar(20)
	declare @t_po nvarchar(20)
	declare @t_baddr nvarchar(20)
	declare @t_eaddr nvarchar(20)
	declare @t_cno nvarchar(20)
	declare @t_carteam  nvarchar(max)
	declare @t_carkind  nvarchar(max)
	declare @t_calctype  nvarchar(max)
	declare @t_sort08  nvarchar(max)
	declare @t_field05  nvarchar(max)
	declare @t_sort03  nvarchar(max)
	
	set @t_accy = '[1]'
	set @t_bdate = case when '#non'=[2]then '' else [2] end
	set @t_edate = case when '#non'=[3] then CHAR(255) else [3] end
	set @t_btrandate = case when '#non'=[9] then '' else [9] end
	set @t_etrandate = case when '#non'=[10] then CHAR(255) else [10] end
	set @t_bcustno = case when '#non'=[11] then '' else [11] end
	set @t_ecustno = case when '#non'=[12] then CHAR(255) else [12] end
	set @t_bdriverno = case when '#non'=[6] then '' else [6] end
	set @t_edriverno = case when '#non'=[7] then CHAR(255) else [7] end
	set @t_carno = case when '#non'=[13] then '' else [13] end
	set @t_po = case when '#non'=[14] then '' else [14] end
	set @t_baddr = case when '#non'=[15] then '' else [15] end
	set @t_eaddr = case when '#non'=[16] then CHAR(255) else [16] end
	set @t_carteam  = case when '#non'=[17] then '' else [17] end
	set @t_carkind  = case when '#non'=[22] then '' else [22] end
	set @t_calctype = case when '#non'=[18] then '' else [18] end
	set @t_sort08  = case when '#non'=[19] then '' else [19] end
	set @t_field05  = case when '#non'=[20] then '' else [20] end
	set @t_sort03 = case when '#non'=[21] then '' else [21] end
	----------------------------------------------------------------------------------------------
	--解析要計算的種類
	declare @string nvarchar(max)
	declare @n int
	IF OBJECT_ID('tempdb..#carkind')is not null
	BEGIN
		set @cmd = 'drop table #carkind'
		EXECUTE sp_executesql @cmd
	END
	create table #carkind(
		noa nvarchar(20)
	)
	set @string = @t_carkind
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #carkind select @string
			end
			break
		end
		insert into #carkind select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	IF OBJECT_ID('tempdb..#carteam')is not null
	BEGIN
		set @cmd = 'drop table #carteam'
		EXECUTE sp_executesql @cmd
	END
	create table #carteam(
		noa nvarchar(20)
	)
	set @string = @t_carteam
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #carteam select @string
			end
			break
		end
		insert into #carteam select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	IF OBJECT_ID('tempdb..#calctype')is not null
	BEGIN
		set @cmd = 'drop table #calctype'
		EXECUTE sp_executesql @cmd
	END
	create table #calctype(
		noa nvarchar(20)
	)
	set @string = @t_calctype
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into #calctype select @string
			end
			break
		end
		insert into #calctype select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	
	declare @display table(
		noa nvarchar(20)
	)
	set @string = @t_field05
	while(1=1)
	begin
		set @n = PATINDEX('%,%',@string)
		if @n=0
		begin
			if LEN(@string)>0
			begin
				insert into @display select @string
			end
			break
		end
		insert into @display select LEFT(@string,@n-1)	
		set @string = SUBSTRING(@string,@n+1,LEN(@string)-@n)
	end
	----------------------------------------------------------------------------------------------
	declare @mount2 float
	declare @total2 float
	declare @driverno nvarchar(20)
	declare @carno nvarchar(20)
	declare @noa nvarchar(20)
	declare @x_key nvarchar(20)
	----------------------------------------------------------------------------------------------
	IF OBJECT_ID('tempdb..#z_tran03')is not null
	BEGIN
		set @cmd = 'drop table #z_tran03'
		EXECUTE sp_executesql @cmd
	END
	create table #z_tran03(
		gno nvarchar(3),
		trandate nvarchar(10),
		datea nvarchar(10),
		custno nvarchar(20),
		comp nvarchar(40),
		driverno nvarchar(20),
		namea nvarchar(20),
		carno nvarchar(20),
		addr nvarchar(40),
		product nvarchar(40),
		mount decimal(10,3),
		price float,
		total float,
		mount2 decimal(10,3),
		price2 float,
		price3 float,
		discount decimal(10,3),
		total2 float,
		po nvarchar(30),
		caseno nvarchar(30),
		cc  nvarchar(20),
		tt  nvarchar(20),
		noa  nvarchar(20)
	)
	
	set @cmd = 
		" select  '0',a.trandate,a.datea,a.custno,left(a.comp,4),a.driverno,a.driver,a.carno,a.straddr,a.product,"+
		" a.mount,a.price,a.total,a.mount2,a.price2,a.price3,a.discount,a.total2,a.po,a.caseno,e.typea,d.team,a.noa"+
		" from  trans"+@t_accy+"  a"+
		" left join #carteam  b on a.carteamno=b.noa"+	
		" left join #calctype c on a.calctype=c.noa"+
		" left join carteam  d on a.carteamno=d.noa"+	
		" left join calctypes e on a.calctype=e.noa+e.noq"+
		" where "+
		" (a.datea  between  @t_bdate  and  @t_edate) and "+
		" (a.trandate  between  @t_btrandate  and  @t_etrandate) and "+
		" (a.custno  between  @t_bcustno   and  @t_ecustno) and "+
		" (a.driverno  between  @t_bdriverno   and  @t_edriverno) and "+
		" (len(@t_carno)=0  or  a.carno=@t_carno) and "+
		" (len(@t_po)=0  or  a.po=@t_po) and "+
		" (a.straddrno between @t_baddr and @t_eaddr) and"+
		" (b.noa  is  not  null) and (c.noa  is  not  null)"
	if @t_sort03='carno'  or @t_sort03='noa' or @t_sort03='driverno' 
		set  @cmd  =  @cmd+" order  by  a.driverno,a.carno,a.noa"
	else
		set  @cmd  =  @cmd+" order  by  a.driverno,a.carno,a.["+@t_sort03+"],a.noa"
	insert into #z_tran03
	execute sp_executesql @cmd,N'@t_bdate nvarchar(10),@t_edate nvarchar(10),@t_btrandate nvarchar(10),@t_etrandate nvarchar(10),@t_bcustno nvarchar(20),@t_ecustno nvarchar(20),@t_bdriverno  nvarchar(20),@t_edriverno  nvarchar(20),@t_carno  nvarchar(20),@t_po  nvarchar(20),@t_baddr  nvarchar(20),@t_eaddr  nvarchar(20)',
		@t_bdate=@t_bdate,@t_edate=@t_edate,@t_btrandate=@t_btrandate,@t_etrandate=@t_etrandate,@t_bcustno=@t_bcustno,@t_ecustno=@t_ecustno,@t_bdriverno=@t_bdriverno,@t_edriverno=@t_edriverno,@t_carno=@t_carno,@t_po=@t_po,@t_baddr=@t_baddr,@t_eaddr=@t_eaddr
		
	select @mount2=SUM(ISNULL(mount2,0)),@total2=SUM(ISNULL(total2,0)) from #z_tran03
	insert into #z_tran03 (gno,driverno,carno,mount2,total2)values('1',CHAR(255),CHAR(255),@mount2,@total2)
	
	
	if @t_sort03='carno'  or @t_sort03='noa' 
	begin 
		declare cursor_table cursor for
		select driverno,carno,max(noa),sum(isnull(mount2,0)),sum(isnull(total2,0)) from #z_tran03 where gno='0' group  by  driverno,carno
		open cursor_table
		fetch next from cursor_table
		into @driverno,@carno,@noa,@mount2,@total2
		while(@@FETCH_STATUS <> -1)
		begin
			insert  into  #z_tran03(gno,driverno,carno,noa,mount2,total2)values('0',@driverno,@carno,@noa+CHAR(255),@mount2,@total2)		
			fetch next from cursor_table
			into @driverno,@carno,@noa,@mount2,@total2
		end
		close cursor_table
		deallocate cursor_table
	end
	else
	begin
		declare cursor_table cursor for
		select driverno,carno from #z_tran03 where gno='0'  group  by  driverno,carno
		open cursor_table
		fetch next from cursor_table
		into @driverno,@carno
		while(@@FETCH_STATUS <> -1)
		begin
			set @x_key=''
			set @cmd="select @x_key=cast(max("+@t_sort03+") as  nvarchar) from  #z_tran03 where driverno=@driverno and carno=@carno"
			execute sp_executesql @cmd,N'@driverno nvarchar(20),@carno  nvarchar(20),@x_key nvarchar(max) output',@driverno=@driverno,@carno=@carno,@x_key=@x_key output 
			
			set @noa=''
			set @cmd="select @noa=max(noa) from  #z_tran03 where driverno=@driverno and carno=@carno and "+@t_sort03+"=@x_key"
			execute sp_executesql @cmd,N'@driverno nvarchar(20),@carno  nvarchar(20),@x_key nvarchar(max),@noa nvarchar(20) output',@driverno=@driverno,@carno=@carno,@x_key=@x_key,@noa=@noa output
			select @mount2=0,@total2=0
			select @mount2=sum(isnull(mount2,0)),@total2=sum(isnull(total2,0)) from #z_tran03 where driverno=@driverno and carno=@carno
			
			set @cmd="insert  into  #z_tran03(gno,driverno,carno,"+@t_sort03+",noa,mount2,total2)values('0',@driverno,@carno,char(255),CHAR(255),@mount2,@total2)"
			execute sp_executesql @cmd,N'@driverno nvarchar(20),@carno  nvarchar(20),@mount2  float,@total2  float',@driverno=@driverno,@carno=@carno,@mount2=@mount2,@total2=@total2	
			
			fetch next from cursor_table
			into @driverno,@carno
		end
		close cursor_table
		deallocate cursor_table
	end
	
	if len(@t_bdate)>0
		set  @string  =  '統計日期：'+@t_bdate+'～'+@t_edate
	else
		set  @string   =  '交運日期：'+@t_btrandate+'～'+@t_etrandate
		
	if @t_sort03='carno'  or @t_sort03='noa' or @t_sort03='driverno' 
	begin
		set @cmd = 
			" select @string titlea, gno,trandate  aa,custno bb,namea cc,carno dd,addr,product ee,mount2 ff,"+
			" case when price2=0 then price3 else price2 end gg,discount hh,"+
			" reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total2),1)),4,12)) ii,"+
			" caseno jj,case when right(noa,1)=char(255) then '' else noa  end kk "+
			" from  #z_tran03  order  by driverno,carno,gno,noa"
	end
	else
	begin
		set @cmd = " select @string titlea, gno,trandate  aa,custno bb,namea cc,carno dd,addr,product ee,mount2 ff,"+
			" case when price2=0 then price3 else price2 end gg,discount hh,"+
			" reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total2),1)),4,12)) ii,"+
			" caseno jj,noa kk "+
			" from  #z_tran03  order  by driverno,carno,gno,["+@t_sort03+"],noa"
	end
	EXECUTE sp_executesql @cmd,N'@string nvarchar(max)',@string=@string
	drop table #z_tran03
	drop table #carkind
	drop table #calctype
	drop table #carteam;
	----------------------------------------------------------------------------------------
	z_carcsa1:--z_carcsa1
SET QUOTED_IDENTIFIER OFF 
declare @cmd nvarchar(max) 
declare @t_xmon nvarchar(20)
declare @t_xinterval nvarchar(20)
declare @t_bcustno nvarchar(20)
declare @t_ecustno nvarchar(20)
set @t_xmon = case when '#non' = [24] then '' else [24] end
set @t_xinterval = case when '#non'=[25] then '' when '全部'=[25] then '' else [25] end 
set @t_bcustno = case when '#non'=[11] then '' else [11] end
set @t_ecustno = case when '#non'=[12] then CHAR(255) else [12] end
declare @tmp table( 
gno nvarchar(1), 
cno nvarchar(20), 
acomp nvarchar(50), 
custno nvarchar(20), 
comp nvarchar(50), 
serial nvarchar(20), 
datea nvarchar(10), 
mon nvarchar(10), 
ordeno nvarchar(20), 
cartype nvarchar(20), 
btime nvarchar(10), 
onti nvarchar(20), 
etime nvarchar(20), 
typea nvarchar(20), 
times nvarchar(20), 
inplus float, 
inmoney float,
outmoney float, 
carno nvarchar(50) 
) 
set @cmd = "select '0' gno,isnull(a.cno,''),'',a.custno,a.comp,b.serial,a.trandate,a.mon,a.ordeno,a.cartype,a.btime,a.ontime,a.etime,a.typea, 
a.times,a.inplus,a.inmoney,a.outmoney,case when charindex(',',a.carno) >0 then substring(a.carno,0,charindex(',',a.carno)) else a.carno end 
from carcsa a 
left join cust b on a.custno = b.noa 
where (LEN(@t_xmon) = 0 or @t_xmon = a.mon) and 
(LEN(@t_xinterval) = 0 or @t_xinterval = a.interval) and 
(a.custno between @t_bcustno and @t_ecustno) " 

insert into @tmp 
execute sp_executesql @cmd,N'@t_xmon nvarchar(20),@t_xinterval nvarchar(20),@t_bcustno nvarchar(20),@t_ecustno nvarchar(20)' 
,@t_xmon=@t_xmon,@t_xinterval=@t_xinterval,@t_bcustno = @t_bcustno,@t_ecustno = @t_ecustno 

insert into @tmp 
select '1' gno,'','',custno,MAX(comp),'','','','','','','','','',0,SUM(inplus),SUM(inmoney),SUM(outmoney),'' 
from @tmp 
group by custno 

select gno,cno,acomp,custno,comp,serial,datea,mon,ordeno,cartype,btime,onti,etime,typea,times, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,inplus),1)),4,12)) inplus, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,inmoney),1)),4,12)) inmoney, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,outmoney),1)),4,12)) outmoney, 
carno 
from @tmp 
order by custno,gno;
-------------------------------------------------------------------------------------------------
z_carcsc1:--z_carcsc1 
declare @t_bdate nvarchar(20)  
declare @t_edate nvarchar(20)  
set @t_bdate = case when '#non' = [2] then '' else [2] end 
set @t_edate = case when '#non' = [3] then CHAR(255) else [3] end 
declare @tmp table( 
gno nvarchar(1), 
serial nvarchar(20), 
custno nvarchar(20), 
comp nvarchar(50), 
boatno nvarchar(20), 
boatname nvarchar(10), 
tranno nvarchar(30), 
addr nvarchar(50), 
trandate nvarchar(20), 
inmount float, 
inprice float, 
inmoney float 
) 
insert into @tmp
select '0' gno,a.custno,b.serial,a.comp,a.boatno,a.boat,a.tranno,a.addr,a.trandate,a.inmount,a.inprice,a.inmoney 
from carcsc a 
left join cust b on a.custno = b.noa 
where a.trandate between @t_bdate and @t_edate
insert into @tmp 
select '1' gno,'',custno,'','','','','','',SUM(inmount),0,SUM(inmoney) 
from @tmp 
group by custno 

select gno,serial,custno,comp,boatno,boatname,tranno,addr,trandate, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,inmount),1)),4,12)) inmount, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,inprice),1)),4,12)) inprice, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,inmoney),1)),4,12)) inmoney 
from @tmp 
order by custno,gno ;
--------------------------------------------------------------------------------------------------
z_carcsb1:--z_carcsb1
declare @t_bdate nvarchar(20) 
declare @t_edate nvarchar(20)
declare @t_bcustno nvarchar(20) 
declare @t_ecustno nvarchar(20) 
set @t_bdate = case when '#non' = [2] then '' else [2] end 
set @t_edate = case when '#non' = [3] then CHAR(255) else [3] end 
set @t_bcustno = case when '#non' = [11] then '' else [11] end 
set @t_ecustno = case when '#non' = [12] then CHAR(255) else [12] end 
declare @tmp table( 
gno nvarchar(1), 
datea nvarchar(20),
serial nvarchar(20), 
custno nvarchar(20), 
comp nvarchar(50), 
tranno nvarchar(20), 
inmount float, 
inmoney float
) 
insert into @tmp
select '0' gno,a.datea,b.serial,a.custno,a.comp,a.carno,a.inmount,a.inmoney
from carcsb a 
left join cust b on a.custno = b.noa 
where (a.datea between @t_bdate and @t_edate) and 
(a.custno between @t_bcustno and @t_ecustno)


insert into @tmp 
select '1' gno,'','',custno,'',COUNT(tranno),SUM(inmount),SUM(inmoney)
from @tmp 
group by custno 

insert into @tmp 
select '2' gno,'','',CHAR(255),'',COUNT(tranno),SUM(inmount),SUM(inmoney)
from @tmp 
where gno != '1'


select gno,datea,serial,custno,comp,tranno,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,inmount),1)),4,12)) inmount, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,inmoney),1)),4,12)) inmoney 
from @tmp 
order by custno,gno ;
--------------------------------------------------------------------------------------------------
