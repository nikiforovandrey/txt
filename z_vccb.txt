z_vccb1:--z_vccb1
declare @i int
declare @countrecord int
declare @typea nvarchar(10)
declare @t_noa nvarchar(50)
set @i = 0
set @countrecord = 0
set @typea = ''
set @t_noa = case when '#non' = [1] then '' else [1] end
declare @tmp table(
	gno nvarchar(1),
	idno int identity(0,1),
	noa nvarchar(15),
	noq nvarchar(10),
	ticketday nvarchar(50),
    cno nvarchar(20),
    comp_name nvarchar(90),
    comp_serial nvarchar(20),
    comp_addr nvarchar(50),
    custno nvarchar(20),
    comp nvarchar(90),
    tggno nvarchar(20),
    tgg nvarchar(90),
    serial nvarchar(20),
    addr nvarchar(50),
	t_serial nvarchar(20),
	t_s1 nvarchar(10),
	t_s2 nvarchar(10),
	t_s3 nvarchar(10),
	t_s4 nvarchar(10),
	t_s5 nvarchar(10),
	t_s6 nvarchar(10),
	t_s7 nvarchar(10),
	t_s8 nvarchar(10),
	t_name nvarchar(100),
	t_addr nvarchar(max),
	typea nvarchar(10),
	typea1 nvarchar(20),
	typea2 nvarchar(20),
	b_year nvarchar(10),
	b_mon nvarchar(10),
	b_day nvarchar(10),
	productno nvarchar(30),
	product nvarchar(80),
	mount float,
	price float,
	total float,
	tax float,
	taxtype nvarchar(10),
	taxtype1 nvarchar(10),
	taxtype2 nvarchar(10),
	taxtype3 nvarchar(10),
	b_name nvarchar(100),
	b_serial nvarchar(20),
	b_addr nvarchar(max)
)
insert into @tmp
	select '0',a.noa,b.noq,a.datea,a.cno,c.acomp,c.serial,c.addr,a.custno,a.comp,a.tggno,a.tgg,a.serial,a.addr,'','','','','','','','','','','',typea,'','',CAST(left(b.idate,3) as int) b_year,
		   CAST(substring(b.idate,5,2) as int) b_mon,
		   CAST(RIGHT(b.idate,2) as int) b_day,b.productno,b.product,
		   b.mount,b.price,b.total,b.tax,b.taxtype,'','','','','',''
	from vccb a
	left join vccbs b on a.noa = b.noa
	left join acomp c on a.cno = c.noa
	where (len(@t_noa) = 0 or (a.noa = @t_noa))
	order by b.noa,b.noq
update @tmp set typea1 = '&#10004' + CHAR(59) where (typea = 1 or typea = 3)
update @tmp set typea2 = '&#10004' + CHAR(59) where (typea = 2 or typea = 4)
update @tmp set taxtype1 = '&#10004' + CHAR(59) where (taxtype = '應稅')
update @tmp set taxtype2 = '&#10004' + CHAR(59) where (taxtype = '零稅率')
update @tmp set taxtype3 = '&#10004' + CHAR(59) where (taxtype = '免稅')
select @countrecord = COUNT(*) from @tmp
while(@i < @countrecord)
begin
	select @typea = typea from @tmp where idno = @i
	if(@typea = 1 or @typea = 2)
	begin
		update @tmp set t_s1 = LEFT(comp_serial,1) where idno = @i
		update @tmp set t_s2 = SUBSTRING(comp_serial,2,1) where idno = @i
		update @tmp set t_s3 = SUBSTRING(comp_serial,3,1) where idno = @i
		update @tmp set t_s4 = SUBSTRING(comp_serial,4,1) where idno = @i
		update @tmp set t_s5 = SUBSTRING(comp_serial,5,1) where idno = @i
		update @tmp set t_s6 = SUBSTRING(comp_serial,6,1) where idno = @i
		update @tmp set t_s7 = SUBSTRING(comp_serial,7,1) where idno = @i
		update @tmp set t_s8 = RIGHT(comp_serial,1) where idno = @i
		update @tmp set t_name = comp_name where idno = @i
		update @tmp set t_addr = comp_addr where idno = @i
		update @tmp set b_name = comp where idno = @i
		update @tmp set b_serial = serial where idno = @i
		update @tmp set b_addr = addr where idno = @i
	end
	else if(@typea = 3 or @typea = 4)
	begin
		update @tmp set t_s1 = LEFT(serial,1) where idno = @i
		update @tmp set t_s2 = SUBSTRING(serial,2,1) where idno = @i
		update @tmp set t_s3 = SUBSTRING(serial,3,1) where idno = @i
		update @tmp set t_s4 = SUBSTRING(serial,4,1) where idno = @i
		update @tmp set t_s5 = SUBSTRING(serial,5,1) where idno = @i
		update @tmp set t_s6 = SUBSTRING(serial,6,1) where idno = @i
		update @tmp set t_s7 = SUBSTRING(serial,7,1) where idno = @i
		update @tmp set t_s8 = RIGHT(serial,1) where idno = @i
		update @tmp set t_name = tgg where idno = @i
		update @tmp set t_addr = addr where idno = @i
		update @tmp set b_name = comp_name where idno = @i
		update @tmp set b_serial = comp_serial where idno = @i
		update @tmp set b_addr = comp_addr where idno = @i
	end	
	set @i +=1
end
insert into @tmp(gno,noa,ticketday,total,tax,b_name,b_serial,b_addr)
	select '1',noa,ticketday,
	SUM(total),SUM(tax),b_name,b_serial,b_addr from @tmp
	group by noa,ticketday,b_name,b_serial,b_addr
select 
	gno,noa,idno,t_s1,t_s2,t_s3,t_s4,t_s5,t_s6,t_s7,t_s8,
	t_name,t_addr,
	left(ticketday,3) + ' 年 ' + substring(ticketday,5,2) + ' 月 ' + right(ticketday,2) + ' 日 ' ticketday,
	typea1,typea2,b_year,b_mon,b_day,productno,product,
	reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,mount),1)),4,12)) mount, 
	reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,price),1)),4,12)) price,
	reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total),1)),4,12)) total,
	reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,tax),1)),4,12)) tax,
	taxtype1,taxtype2,taxtype3,b_name,b_serial,b_addr
from @tmp order by noa,gno,idno;