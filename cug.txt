earlyday:--更新子階應開工日
SET QUOTED_IDENTIFIER OFF
declare @workno nvarchar(50)=[1]--要改變子階的workno非子階
declare @earlyday nvarchar(50)=[2] --要提前的天數
-----------------------------------------------------------------------
declare @accy nvarchar(10)=(select accy from view_work where noa=@workno)

--更新work
EXEC("update work"+@accy+"
set cuadate=left(right('0'+CONVERT (nvarchar(7),CONVERT (VARCHAR(7),dateadd(d,"+@earlyday+",CONVERT(datetime ,CONVERT(nvarchar(10),CONVERT(int,left(cuadate,3))+1911)+right(left(cuadate,6),2)+right(cuadate,2)) ),12 )+0890000),7),3)+'/'
+right(left(right('0'+CONVERT (nvarchar(7),CONVERT (VARCHAR(7),dateadd(d,"+@earlyday+",CONVERT(datetime ,CONVERT(nvarchar(10),CONVERT(int,left(cuadate,3))+1911)+right(left(cuadate,6),2)+right(cuadate,2)) ),12 )+0890000),7),5),2)+'/'
+right(right('0'+CONVERT (nvarchar(7),CONVERT (VARCHAR(7),dateadd(d,"+@earlyday+",CONVERT(datetime ,CONVERT(nvarchar(10),CONVERT(int,left(cuadate,3))+1911)+right(left(cuadate,6),2)+right(cuadate,2)) ),12 )+0890000),7),2)
,uindate=left(right('0'+CONVERT (nvarchar(7),CONVERT (VARCHAR(7),dateadd(d,"+@earlyday+",CONVERT(datetime ,CONVERT(nvarchar(10),CONVERT(int,left(uindate,3))+1911)+right(left(uindate,6),2)+right(uindate,2)) ),12 )+0890000),7),3)+'/'
+right(left(right('0'+CONVERT (nvarchar(7),CONVERT (VARCHAR(7),dateadd(d,"+@earlyday+",CONVERT(datetime ,CONVERT(nvarchar(10),CONVERT(int,left(uindate,3))+1911)+right(left(uindate,6),2)+right(uindate,2)) ),12 )+0890000),7),5),2)+'/'
+right(right('0'+CONVERT (nvarchar(7),CONVERT (VARCHAR(7),dateadd(d,"+@earlyday+",CONVERT(datetime ,CONVERT(nvarchar(10),CONVERT(int,left(uindate,3))+1911)+right(left(uindate,6),2)+right(uindate,2)) ),12 )+0890000),7),2)
where cuano+'-'+cuanoq=(select cuano+'-'+cuanoq from view_work where noa='"+@workno+"')
and rank=(select cast(rank as int)+1 from view_work where noa='"+@workno+"') and stationno!='' and cuadate!=''
")

EXEC("update works"+@accy+"
set cuadate=left(right('0'+CONVERT (nvarchar(7),CONVERT (VARCHAR(7),dateadd(d,"+@earlyday+",CONVERT(datetime ,CONVERT(nvarchar(10),CONVERT(int,left(cuadate,3))+1911)+right(left(cuadate,6),2)+right(cuadate,2)) ),12 )+0890000),7),3)+'/'
+right(left(right('0'+CONVERT (nvarchar(7),CONVERT (VARCHAR(7),dateadd(d,"+@earlyday+",CONVERT(datetime ,CONVERT(nvarchar(10),CONVERT(int,left(cuadate,3))+1911)+right(left(cuadate,6),2)+right(cuadate,2)) ),12 )+0890000),7),5),2)+'/'
+right(right('0'+CONVERT (nvarchar(7),CONVERT (VARCHAR(7),dateadd(d,"+@earlyday+",CONVERT(datetime ,CONVERT(nvarchar(10),CONVERT(int,left(cuadate,3))+1911)+right(left(cuadate,6),2)+right(cuadate,2)) ),12 )+0890000),7),2)
where noa in(
	select noa from view_work where cuano+'-'+cuanoq=(select cuano+'-'+cuanoq from view_work where noa='"+@workno+"')
	and rank=(select cast(rank as int)+1 from view_work where noa='"+@workno+"') and stationno!='') and cuadate!=''
")

--更新cugu
declare @worksno nvarchar(50)
declare cursor_table cursor for 
select accy,workno from view_cugu where workno in (
select noa from view_work where cuano+'-'+cuanoq=(select cuano+'-'+cuanoq from view_work where noa='"+@workno+"')
and rank=(select cast(rank as int)+1 from view_work where noa='"+@workno+"') and stationno!='') group by accy,workno
open cursor_table 
fetch next from cursor_table 
into @accy,@worksno
while(@@FETCH_STATUS <> -1) 
begin 
	EXEC("update cugu"+@accy+" 
	set datea=left(right('0'+CONVERT (nvarchar(7),CONVERT (VARCHAR(7),dateadd(d,"+@earlyday+",CONVERT(datetime ,CONVERT(nvarchar(10),CONVERT(int,left(datea,3))+1911)+right(left(datea,6),2)+right(datea,2)) ),12 )+0890000),7),3)+'/'
	+right(left(right('0'+CONVERT (nvarchar(7),CONVERT (VARCHAR(7),dateadd(d,"+@earlyday+",CONVERT(datetime ,CONVERT(nvarchar(10),CONVERT(int,left(datea,3))+1911)+right(left(datea,6),2)+right(datea,2)) ),12 )+0890000),7),5),2)+'/'
	+right(right('0'+CONVERT (nvarchar(7),CONVERT (VARCHAR(7),dateadd(d,"+@earlyday+",CONVERT(datetime ,CONVERT(nvarchar(10),CONVERT(int,left(datea,3))+1911)+right(left(datea,6),2)+right(datea,2)) ),12 )+0890000),7),2)
	where workno='"+@worksno+"' and datea!='' ")
	
	fetch next from cursor_table 
	into @accy,@worksno
end 
close cursor_table 
deallocate cursor_table 
;
--*******************************************************************************************
delcugunoq:--刪除拆分的cugunoq
SET QUOTED_IDENTIFIER OFF
declare @cugunoq nvarchar(MAX)=[1]

declare @tmp table(
	cugunoq nvarchar(MAX)
)

while(CHARINDEX('&',@cugunoq)>0)
begin
	insert @tmp
	select LEFT(@cugunoq,CHARINDEX('&',@cugunoq)-1)
	set @cugunoq=SUBSTRING(@cugunoq,CHARINDEX('&',@cugunoq)+1,LEN(@cugunoq))
end

insert @tmp select @cugunoq

declare @accy nvarchar(10)
declare @noq nvarchar(90)
declare cursor_table cursor for 
select b.accy,b.noq from @tmp a left join view_cugu b on a.cugunoq=b.noq where b.noq!=''
open cursor_table 
fetch next from cursor_table 
into @accy,@noq
while(@@FETCH_STATUS <> -1) 
begin 
	EXEC("delete cugu"+@accy+" where noq='"+@noq+"' ")
	
	fetch next from cursor_table 
	into @accy,@noq
end 
close cursor_table 
deallocate cursor_table
;
--******************************************************************************************************
workreal:--轉正式製令
SET QUOTED_IDENTIFIER OFF
declare @table nvarchar(MAX)=[1]
declare @chgno nvarchar(MAX)=[2]

declare @tmp table(
	workj nvarchar(MAX),
	workno nvarchar(MAX)
)

if(@table='cug')
begin
	insert @tmp (workj)
	select workno from view_cugs where noa=@chgno and workno!='' group by workno
end

if(@table='workg')
begin
	insert @tmp (workj)
	select noa from view_work where cuano=@chgno group by noa
end

if(@table='workgs')
begin
	insert @tmp (workj)
	select noa from view_work where cuano+'-'+cuanoq=@chgno group by noa
end

update @tmp set workno=LEFT(workj,1)+RIGHT(workj,len(workj)-2)

declare @accy nvarchar(10)
declare @workno nvarchar(90)
declare @noa nvarchar(90)

--work noa nom
--works noa
declare cursor_table cursor for 
select a.workno,b.accy,b.noa from @tmp a left join view_work b on a.workj=b.noa where b.noa!=''
open cursor_table 
fetch next from cursor_table 
into @workno,@accy,@noa
while(@@FETCH_STATUS <> -1) 
begin 
	EXEC("update work"+@accy+" set noa='"+@workno+"' where noa='"+@noa+"' ")
	EXEC("update work"+@accy+" set nom='"+@workno+"' where nom='"+@noa+"' ")
	EXEC("update works"+@accy+" set noa='"+@workno+"' where noa='"+@noa+"' ")
	
	fetch next from cursor_table 
	into @workno,@accy,@noa
end 
close cursor_table 
deallocate cursor_table

--workgs workno
declare cursor_table cursor for 
select a.workno,b.accy,b.workno from @tmp a left join view_workgs b on a.workj=b.workno where b.workno!=''
open cursor_table 
fetch next from cursor_table 
into @workno,@accy,@noa
while(@@FETCH_STATUS <> -1) 
begin 
	EXEC("update workgs"+@accy+" set workno='"+@workno+"' where workno='"+@noa+"' ")
	
	fetch next from cursor_table 
	into @workno,@accy,@noa
end 
close cursor_table 
deallocate cursor_table

--cugu workno
declare cursor_table cursor for 
select a.workno,b.accy,b.workno from @tmp a left join view_cugu b on a.workj=b.workno where b.workno!=''
group by a.workno,b.accy,b.workno
open cursor_table 
fetch next from cursor_table 
into @workno,@accy,@noa
while(@@FETCH_STATUS <> -1) 
begin 
	EXEC("update cugu"+@accy+" set workno='"+@workno+"' where workno='"+@noa+"' ")
	EXEC("update cugu"+@accy+" set nom='"+@workno+"' where nom='"+@noa+"' ")
	
	fetch next from cursor_table 
	into @workno,@accy,@noa
end 
close cursor_table 
deallocate cursor_table

--cugs workno
declare cursor_table cursor for 
select a.workno,b.accy,b.workno from @tmp a left join view_cugs b on a.workj=b.workno where b.workno!=''
group by a.workno,b.accy,b.workno
open cursor_table 
fetch next from cursor_table 
into @workno,@accy,@noa
while(@@FETCH_STATUS <> -1) 
begin 
	EXEC("update cugs"+@accy+" set workno='"+@workno+"' where workno='"+@noa+"' ")
	
	fetch next from cursor_table 
	into @workno,@accy,@noa
end 
close cursor_table 
deallocate cursor_table
;
--******************************************************************************************************
workrealall:--批次轉正式製令
SET QUOTED_IDENTIFIER OFF
declare @bdate nvarchar(MAX)=case when '#non'=[1] then '' else [1] end
declare @edate nvarchar(MAX)=case when '#non'=[2] then CHAR(255) else [2] end
declare @bcuano nvarchar(MAX)=case when '#non'=[3] then '' else [3] end
declare @ecuano nvarchar(MAX)=case when '#non'=[4] then CHAR(255) else [4] end
declare @bworkno nvarchar(MAX)=case when '#non'=[5] then '' else [5] end
declare @eworkno nvarchar(MAX)=case when '#non'=[6] then CHAR(255) else [6] end
declare @sigtngg nvarchar(MAX)=case when '#non'=[7] then '0' else [7] end
declare @worker nvarchar(MAX)=case when '#non'=[8] then '' else [8] end

declare @tmp table(
	workj nvarchar(MAX),
	workno nvarchar(MAX)
)

insert @tmp (workj)
select noa from view_work 
where (cuadate between @bdate and @edate) and (cuano between @bcuano and @ecuano) and (noa between @bworkno and @eworkno)
and len(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(SUBSTRING(noa,2,1),'0',''),'1',''),'2',''),'3',''),'4',''),'5',''),'6',''),'7',''),'8',''),'9',''))!=0
group by noa

update @tmp set workno=LEFT(workj,1)+RIGHT(workj,len(workj)-2)

declare @accy nvarchar(10)
declare @workno nvarchar(90)
declare @noa nvarchar(90)
declare @tggno nvarchar(90)
declare @signno nvarchar(90)

declare @now_date nvarchar(10)
set @now_date=CONVERT (VARCHAR(7), GETDATE(),12 )+0890000
set @now_date=left(@now_date,3)+'/'+substring(@now_date,4,2)+'/'+substring(@now_date,6,2)

declare @now_time nvarchar(10)
set @now_time=SUBSTRING(CONVERT(VARCHAR(20), GETDATE(), 120), 12, 2)+':'+SUBSTRING(CONVERT(VARCHAR(20), GETDATE(), 120), 15, 2)

--work noa nom
--works noa
declare cursor_table cursor for 
select a.workno,b.accy,b.noa,isnull(b.tggno,'') from @tmp a left join view_work b on a.workj=b.noa where b.noa!=''
open cursor_table 
fetch next from cursor_table 
into @workno,@accy,@noa,@tggno
while(@@FETCH_STATUS <> -1) 
begin 
	EXEC("update work"+@accy+" set noa='"+@workno+"' where noa='"+@noa+"' ")
	EXEC("update work"+@accy+" set nom='"+@workno+"' where nom='"+@noa+"' ")
	EXEC("update works"+@accy+" set noa='"+@workno+"' where noa='"+@noa+"' ")
	
	if(@tggno!='' and @sigtngg='1')
	begin
		select @signno=REPLACE(@now_date,'/','')+right('00000'+cast(cast(isnull(right(MAX(noa),5),0) as int)+1 as NVARCHAR(10)),5) 
		from sign where left(noa,7)=REPLACE(@now_date,'/','')
		
		insert sign(noa,datea,timea,form,sender,memo,checker,receiver,memochecker,zno,zno2,enda)
		select @signno,@now_date,@now_time,'批次轉正式製令',@worker
		,'應開工日：'+(select cuadate from view_work where noa=@workno)
		+',製品編號：'+(select productno from view_work where noa=@workno)
		+',製品名稱：'+(select product from view_work where noa=@workno)
		,isnull((select case when nick!='' then nick else left(comp,4) end from tgg where noa=@tggno),@tggno)
		,'','',@workno,'work;noa;'+@accy,'N'
		
		insert dno(tablea,noa,usera)
		select 'sign',@signno,@worker
	end
	
	fetch next from cursor_table 
	into @workno,@accy,@noa,@tggno
end 
close cursor_table 
deallocate cursor_table

--workgs workno
declare cursor_table cursor for 
select a.workno,b.accy,b.workno from @tmp a left join view_workgs b on a.workj=b.workno where b.workno!=''
open cursor_table 
fetch next from cursor_table 
into @workno,@accy,@noa
while(@@FETCH_STATUS <> -1) 
begin 
	EXEC("update workgs"+@accy+" set workno='"+@workno+"' where workno='"+@noa+"' ")
	
	fetch next from cursor_table 
	into @workno,@accy,@noa
end 
close cursor_table 
deallocate cursor_table

--cugu workno
declare cursor_table cursor for 
select a.workno,b.accy,b.workno from @tmp a left join view_cugu b on a.workj=b.workno where b.workno!=''
group by a.workno,b.accy,b.workno
open cursor_table 
fetch next from cursor_table 
into @workno,@accy,@noa
while(@@FETCH_STATUS <> -1) 
begin 
	EXEC("update cugu"+@accy+" set workno='"+@workno+"' where workno='"+@noa+"' ")
	EXEC("update cugu"+@accy+" set nom='"+@workno+"' where nom='"+@noa+"' ")
	
	fetch next from cursor_table 
	into @workno,@accy,@noa
end 
close cursor_table 
deallocate cursor_table

--cugs workno
declare cursor_table cursor for 
select a.workno,b.accy,b.workno from @tmp a left join view_cugs b on a.workj=b.workno where b.workno!=''
group by a.workno,b.accy,b.workno
open cursor_table 
fetch next from cursor_table 
into @workno,@accy,@noa
while(@@FETCH_STATUS <> -1) 
begin 
	EXEC("update cugs"+@accy+" set workno='"+@workno+"' where workno='"+@noa+"' ")
	
	fetch next from cursor_table 
	into @workno,@accy,@noa
end 
close cursor_table 
deallocate cursor_table
;
--******************************************************************************************************
cugtchange:--產能批次調整
SET QUOTED_IDENTIFIER OFF
declare @bstationno nvarchar(MAX)=case when '#non'=[1] then '' else [1] end
declare @estationno nvarchar(MAX)=case when '#non'=[2] then CHAR(255) else [2] end
declare @bdate nvarchar(MAX)=case when '#non'=[3] then '' else [3] end
declare @edate nvarchar(MAX)=case when '#non'=[4] then CHAR(255) else [4] end
declare @saturday nvarchar(MAX)=case when '#non'=[5] then '0' else [5] end
declare @sunday nvarchar(MAX)=case when '#non'=[6] then '0' else [6] end
declare @gen nvarchar(MAX)=case when '#non'=[7] then '0' else [7] end
declare @worker nvarchar(MAX)=case when '#non'=[8] then '' else [8] end

declare @stationno nvarchar(MAX)
declare @tdate nvarchar(MAX)=@bdate
declare @accy nvarchar(MAX)
declare @noq nvarchar(MAX)
declare @week nvarchar(MAX)

declare station_table cursor for 
select noa from station where noa between @bstationno and @estationno
open station_table 
fetch next from station_table 
into @stationno
while(@@FETCH_STATUS <> -1) 
begin 
	
	while (@tdate<=@edate)
	begin
		SELECT @week=DATEPART(WEEKDAY, cast(cast(left(@tdate,3) as int)+1911 as nvarchar(10))+RIGHT(@tdate,6))
		
		if(@week=1 and @sunday='0')
		begin
			set @tdate=cast(cast(left(@tdate,3) as int)+1911 as nvarchar(10))+RIGHT(@tdate,6)
			set @tdate=convert(varchar(10),dateadd(day,1,@tdate),120)
			set @tdate=cast(cast(left(@tdate,4) as int)-1911 as nvarchar(10))+'/'+left(right(@tdate,5),2)+'/'+right(@tdate,2)	
			continue
		end
		if(@week=7 and @saturday='0')
		begin
			set @tdate=cast(cast(left(@tdate,3) as int)+1911 as nvarchar(10))+RIGHT(@tdate,6)
			set @tdate=convert(varchar(10),dateadd(day,1,@tdate),120)
			set @tdate=cast(cast(left(@tdate,4) as int)-1911 as nvarchar(10))+'/'+left(right(@tdate,5),2)+'/'+right(@tdate,2)	
			continue
		end
	
		if((select count(*) from view_cugt where noa=@stationno and datea=@tdate)>0)
		begin
			select top 1 @accy=accy from view_cugt where noa=@stationno and datea=@tdate
			exec("update cugt"+@accy+" set gen="+@gen+" ,worker='"+@worker+"' 
			where noa='"+@stationno+"' and datea='"+@tdate+"'")
		end
		else 
		begin
			set @accy=LEFT(@tdate,3)
			select @noq=right('000'+cast(cast(isnull((MAX(noq)),0) as int)+1 as NVARCHAR(10)),3) 
			from view_cugt where accy=@accy and noa=@stationno
			exec("insert cugt"+@accy+" (noa,noq,stationno,datea,gen,worker,memo)
			select '"+@stationno+"','"+@noq+"','"+@stationno+"','"+@tdate+"',"+@gen+",'"+@worker+"',''")
		end
	
		set @tdate=cast(cast(left(@tdate,3) as int)+1911 as nvarchar(10))+RIGHT(@tdate,6)
		set @tdate=convert(varchar(10),dateadd(day,1,@tdate),120)
		set @tdate=cast(cast(left(@tdate,4) as int)-1911 as nvarchar(10))+'/'+left(right(@tdate,5),2)+'/'+right(@tdate,2)	
	end
	
	fetch next from station_table 
	into @stationno
end 
close station_table 
deallocate station_table
;