----------------------------------------------------------------------------------------------------------
z_addr1:--z_addr1
declare @t_bxcustno nvarchar(20)
declare @t_excustno nvarchar(20)
declare @t_xhistory nvarchar(20)
declare @t_xunusual1 nvarchar(20)
set @t_bxcustno = case when '#non' = [1] then '' else [1] end
set @t_excustno = case when '#non' = [2] then CHAR(255) else [2] end
set @t_xhistory = case when '#non' = [3] then '' else [3] end
set @t_xunusual1 = case when '#non' = [4] then '' else [4] end
declare @tmpa table(
		gno nvarchar(1),
		n nvarchar(2),
		p nvarchar(20),
		noa nvarchar(30),
		noq nvarchar(30),
		addr nvarchar(50),
		productno nvarchar(30),
		product nvarchar(50),
		datea nvarchar(20),
		custprice float,
		driverprice1 float,
		driverprice2 float,
		memo nvarchar(30)
)
insert into @tmpa
select '0','1',ROW_NUMBER()over(PARTITION BY a.noa order by a.noa,datea desc) p,a.noa,b.noq,a.addr,a.productno,a.product,b.datea,b.custprice,b.driverprice,b.driverprice2,b.memo
from addr a
left join addrs b on a.noa = b.noa
where (substring(a.noa,1,case when PATINDEX('%-%',a.noa) > 0 then PATINDEX('%-%',a.noa)-1 else len(a.noa) end) between @t_bxcustno and @t_excustno)

declare @tmp table(
		gno nvarchar(1),
		n nvarchar(2),
		p nvarchar(20),
		noa nvarchar(30),
		noq nvarchar(30),
		addr nvarchar(50),
		productno nvarchar(30),
		product nvarchar(50),
		datea nvarchar(20),
		custprice float,
		driverprice1 float,
		driverprice2 float,
		memo nvarchar(30)
)


if @t_xhistory = 'history'
begin
	if len(@t_xunusual1)>0
	begin
		if @t_xunusual1 = 'unusual1,unusual2'
		begin
			insert into @tmp
			select *
			from @tmpa 
			where ((driverprice1 > driverprice2) or ((driverprice1 > custprice) or (driverprice2 > custprice)))
			order by noa,n,noq
		end
		if @t_xunusual1 = 'unusual1' 
		begin
			insert into @tmp
			select *
			from @tmpa 
			where (driverprice1 > driverprice2) 
			order by noa,n,noq
		end
		if @t_xunusual1 = 'unusual2'
		begin
			insert into @tmp
			select *
			from @tmpa 
			where ((driverprice1 > custprice) or (driverprice2 > custprice))
			order by noa,n,noq
		end
	end
	else 
	begin
		insert into @tmp
		select *
		from @tmpa 
		order by noa,n,noq
	end
end
else 
begin
	if len(@t_xunusual1) > 0
	begin
		if @t_xunusual1 = 'unusual1,unusual2'
		begin
			insert into @tmp
			select *
			from @tmpa 
			where ((driverprice1 > driverprice2) or ((driverprice1 > custprice) or (driverprice2 > custprice)))
			and p = 1
		end
		if @t_xunusual1 = 'unusual1'
		begin
			insert into @tmp
			select *
			from @tmpa 
			where (driverprice1 > driverprice2)
			and p = 1
		end
		if @t_xunusual1 = 'unusual2'
		begin
			insert into @tmp
			select *
			from @tmpa 
			where ((driverprice1 > custprice) or (driverprice2 > custprice))
			and p = 1
		end
	end
	else
	begin
		insert into @tmp
		select *
		from @tmpa 
		where p = 1
	end
	
end

insert into @tmp
select '1','0','',b.noa,'',b.addr,b.productno,b.product,'',0,0,0,''
from @tmp a
left join addr b on a.noa = b.noa
where (substring(b.noa,1,case when PATINDEX('%-%',b.noa) > 0 then PATINDEX('%-%',b.noa)-1 else len(b.noa) end) between @t_bxcustno and @t_excustno)
group by b.noa,b.addr,b.productno,b.product


select gno,n,p,noa,addr,productno,product,datea,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,custprice),1)),4,12)) custprice,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,driverprice1),1)),4,12)) driverprice1,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,driverprice2),1)),4,12)) driverprice2,
memo
from @tmp 
order by noa,n;
-----------------------------------------------------------------------------------------------------------------------------------------------------------