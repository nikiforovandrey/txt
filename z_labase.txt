z_labase1:--z_labase1 
declare @t_bxmon nvarchar(10) 
declare @t_exmon nvarchar(10) 
declare @t_bxsssno nvarchar(20) 
declare @t_exsssno nvarchar(20)
declare @t_bxcomp nvarchar(20) 
declare @t_excomp nvarchar(20)
declare @t_bxcustno nvarchar(20) 
declare @t_excustno nvarchar(20)
declare @t_xsss nvarchar(20) 
set @t_bxmon = case when '#non' = [1] then '' else [1] end 
set @t_exmon = case when '#non' = [2] then CHAR(255) else [2] end 
set @t_bxsssno = case when '#non' = [3] then '' else [3] end 
set @t_exsssno = case when '#non' = [4] then CHAR(255) else [4] end 
set @t_bxcomp = case when '#non' = [5] then '' else [5] end 
set @t_excomp = case when '#non' = [6] then CHAR(255) else [6] end 
set @t_bxcustno = case when '#non' = [7] then '' else [7] end 
set @t_excustno = case when '#non' = [8] then CHAR(255) else [8] end
set @t_xsss = case when '#non' = [9] then '' else [9] end 
declare @tmp table( 
gno nvarchar(1), 
mon nvarchar(10), 
comp nvarchar(90), 
he_comp int, 
la_comp int, 
re_comp int, 
he_self int,
la_self int,
re_self int,
selftotal int, 
comptotal int, 
total int 
) 

if @t_xsss = '寄保'
begin
insert into @tmp 
select '0' gno,a.mon,a.comp,SUM(a.he_comp),SUM(a.la_comp),SUM(a.re_comp),sum(a.he_person),
SUM(a.la_person),SUM(a.re_person),sum(a.he_person)+SUM(a.la_person)+SUM(a.re_person),
 SUM(a.he_comp)+SUM(a.la_comp)+SUM(a.re_comp),sum(a.he_person)+SUM(a.la_person)+SUM(a.re_person)+
 SUM(a.he_comp)+SUM(a.la_comp)+SUM(a.re_comp)
from salinsures a 
left join labase b on a.noa = b.noa 
where (a.mon between @t_bxmon and @t_exmon) and 
(a.comp between @t_bxcomp and @t_excomp) and
(b.noa between @t_bxsssno and @t_exsssno) and
(b.issssp = 1) 
group by a.mon,a.comp 
end
else if @t_xsss = '非寄保'
begin
insert into @tmp 
select '0' gno,a.mon,a.comp,SUM(a.he_comp),SUM(a.la_comp),SUM(a.re_comp),sum(a.he_person),
SUM(a.la_person),SUM(a.re_person),sum(a.he_person)+SUM(a.la_person)+SUM(a.re_person),
 SUM(a.he_comp)+SUM(a.la_comp)+SUM(a.re_comp),sum(a.he_person)+SUM(a.la_person)+SUM(a.re_person)+
 SUM(a.he_comp)+SUM(a.la_comp)+SUM(a.re_comp)
from salinsures a 
left join labase b on a.noa = b.noa 
where (a.mon between @t_bxmon and @t_exmon) and 
(a.comp between @t_bxcomp and @t_excomp) and
(b.noa between @t_bxsssno and @t_exsssno) and
(b.issssp = 0) 
group by a.mon,a.comp 
end
else 
begin
insert into @tmp 
select '0' gno,a.mon,a.comp,SUM(a.he_comp),SUM(a.la_comp),SUM(a.re_comp),sum(a.he_person),
SUM(a.la_person),SUM(a.re_person),sum(a.he_person)+SUM(a.la_person)+SUM(a.re_person),
 SUM(a.he_comp)+SUM(a.la_comp)+SUM(a.re_comp),sum(a.he_person)+SUM(a.la_person)+SUM(a.re_person)+
 SUM(a.he_comp)+SUM(a.la_comp)+SUM(a.re_comp)
from salinsures a 
left join labase b on a.noa = b.noa 
where (a.mon between @t_bxmon and @t_exmon) and 
(a.comp between @t_bxcomp and @t_excomp) and
(b.noa between @t_bxsssno and @t_exsssno) 
group by a.mon,a.comp 
end
select gno,mon,comp, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,he_self),1)),4,12)) he_self, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,he_comp),1)),4,12)) he_comp, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,la_self),1)),4,12)) la_self,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,la_comp),1)),4,12)) la_comp, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,re_self),1)),4,12)) re_self,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,re_comp),1)),4,12)) re_comp, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,selftotal),1)),4,12)) selftotal, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,comptotal),1)),4,12)) comptotal, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total),1)),4,12)) total 
from @tmp ;
--------------------------------------------------------------------------------------------------
z_labase2:--z_labase2
declare @t_bxmon nvarchar(10) 
declare @t_exmon nvarchar(10) 
declare @t_bxsssno nvarchar(20) 
declare @t_exsssno nvarchar(20)
declare @t_bxcomp nvarchar(20) 
declare @t_excomp nvarchar(20)
declare @t_bxcustno nvarchar(20) 
declare @t_excustno nvarchar(20)
declare @t_xsss nvarchar(20) 
set @t_bxmon = case when '#non' = [1] then '' else [1] end 
set @t_exmon = case when '#non' = [2] then CHAR(255) else [2] end 
set @t_bxsssno = case when '#non' = [3] then '' else [3] end 
set @t_exsssno = case when '#non' = [4] then CHAR(255) else [4] end 
set @t_bxcomp = case when '#non' = [5] then '' else [5] end 
set @t_excomp = case when '#non' = [6] then CHAR(255) else [6] end 
set @t_bxcustno = case when '#non' = [7] then '' else [7] end 
set @t_excustno = case when '#non' = [8] then CHAR(255) else [8] end
set @t_xsss = case when '#non' = [9] then '' else [9] end 
declare @tmp table( 
gno nvarchar(1), 
mon nvarchar(10), 
comp nvarchar(90), 
namea nvarchar(50),
he_comp int, 
la_comp int, 
re_comp int, 
he_self int,
la_self int,
re_self int,
selftotal int, 
comptotal int, 
total int 
) 

if @t_xsss = '寄保'
begin
insert into @tmp 
select '0' gno,a.mon,a.comp,b.namea,SUM(a.he_comp),SUM(a.la_comp),SUM(a.re_comp),sum(a.he_person),
SUM(a.la_person),SUM(a.re_person),sum(a.he_person)+SUM(a.la_person)+SUM(a.re_person),
 SUM(a.he_comp)+SUM(a.la_comp)+SUM(a.re_comp),sum(a.he_person)+SUM(a.la_person)+SUM(a.re_person)+
 SUM(a.he_comp)+SUM(a.la_comp)+SUM(a.re_comp)
from salinsures a 
left join labase b on a.noa = b.noa 
where (a.mon between @t_bxmon and @t_exmon) and 
(a.comp between @t_bxcomp and @t_excomp) and
(a.noa between @t_bxsssno and @t_exsssno) and
(b.issssp = 1) 
group by a.mon,a.comp,b.namea 
end
else if @t_xsss = '非寄保'
begin
insert into @tmp 
select '0' gno,a.mon,a.comp,b.namea,SUM(a.he_comp),SUM(a.la_comp),SUM(a.re_comp),sum(a.he_person),
SUM(a.la_person),SUM(a.re_person),sum(a.he_person)+SUM(a.la_person)+SUM(a.re_person),
 SUM(a.he_comp)+SUM(a.la_comp)+SUM(a.re_comp),sum(a.he_person)+SUM(a.la_person)+SUM(a.re_person)+
 SUM(a.he_comp)+SUM(a.la_comp)+SUM(a.re_comp)
from salinsures a 
left join labase b on a.noa = b.noa 
where (a.mon between @t_bxmon and @t_exmon) and 
(a.comp between @t_bxcomp and @t_excomp) and
(b.noa between @t_bxsssno and @t_exsssno) and
(b.issssp = 0) 
group by a.mon,a.comp,b.namea
end
else 
begin
insert into @tmp 
select '0' gno,a.mon,a.comp,b.namea,SUM(a.he_comp),SUM(a.la_comp),SUM(a.re_comp),sum(a.he_person),
SUM(a.la_person),SUM(a.re_person),sum(a.he_person)+SUM(a.la_person)+SUM(a.re_person),
 SUM(a.he_comp)+SUM(a.la_comp)+SUM(a.re_comp),sum(a.he_person)+SUM(a.la_person)+SUM(a.re_person)+
 SUM(a.he_comp)+SUM(a.la_comp)+SUM(a.re_comp)
from salinsures a 
left join labase b on a.noa = b.noa 
where (a.mon between @t_bxmon and @t_exmon) and 
(a.comp between @t_bxcomp and @t_excomp) and
(b.noa between @t_bxsssno and @t_exsssno) 
group by a.mon,a.comp,b.namea 
end
select gno,mon,comp,namea,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,he_self),1)),4,12)) he_self, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,he_comp),1)),4,12)) he_comp, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,la_self),1)),4,12)) la_self,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,la_comp),1)),4,12)) la_comp, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,re_self),1)),4,12)) re_self,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,re_comp),1)),4,12)) re_comp, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,selftotal),1)),4,12)) selftotal, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,comptotal),1)),4,12)) comptotal, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total),1)),4,12)) total 
from @tmp ;
-------------------------------------------------------------------------------------------------
z_labase3:--z_labase3
declare @t_bxmon nvarchar(10) 
declare @t_exmon nvarchar(10) 
declare @t_bxsssno nvarchar(20) 
declare @t_exsssno nvarchar(20)
declare @t_bxcomp nvarchar(20) 
declare @t_excomp nvarchar(20)
declare @t_bxcustno nvarchar(20) 
declare @t_excustno nvarchar(20)
declare @t_xsss nvarchar(20) 
declare @t_cmon nvarchar(20) 
set @t_bxmon = case when '#non' = [1] then '' else [1] end 
set @t_exmon = case when '#non' = [2] then CHAR(255) else [2] end 
set @t_bxsssno = case when '#non' = [3] then '' else [3] end 
set @t_exsssno = case when '#non' = [4] then CHAR(255) else [4] end 
set @t_bxcomp = case when '#non' = [5] then '' else [5] end 
set @t_excomp = case when '#non' = [6] then CHAR(255) else [6] end 
set @t_bxcustno = case when '#non' = [7] then '' else [7] end 
set @t_excustno = case when '#non' = [8] then CHAR(255) else [8] end
set @t_xsss = case when '#non' = [9] then '' else [9] end
set @t_cmon = case when '#non' = [11] then '' else [11] end  
declare @tmp table( 
gno nvarchar(1), 
mon nvarchar(10), 
comp nvarchar(90), 
namea nvarchar(50),
he_comp int, 
la_comp int, 
re_comp int, 
he_self int,
la_self int,
re_self int,
selftotal int, 
comptotal int, 
total int 
) 
if @t_xsss = '寄保'
begin
insert into @tmp 
select '0' gno,a.mon,a.comp,b.namea,SUM(a.he_comp),SUM(a.la_comp),SUM(a.re_comp),sum(a.he_person),
SUM(a.la_person),SUM(a.re_person),sum(a.he_person)+SUM(a.la_person)+SUM(a.re_person),
 SUM(a.he_comp)+SUM(a.la_comp)+SUM(a.re_comp),sum(a.he_person)+SUM(a.la_person)+SUM(a.re_person)+
 SUM(a.he_comp)+SUM(a.la_comp)+SUM(a.re_comp)
from salinsures a 
left join labase b on a.noa = b.noa 
where 
(isnull(a.comp,'') between @t_bxcomp and @t_excomp) and
(b.issssp = 1) 
group by a.mon,a.comp,b.namea 
end
else if @t_xsss = '非寄保'
begin
insert into @tmp
select '0' gno,a.mon,a.comp,b.namea,SUM(a.he_comp),SUM(a.la_comp),SUM(a.re_comp),sum(a.he_person),
SUM(a.la_person),SUM(a.re_person),sum(a.he_person)+SUM(a.la_person)+SUM(a.re_person),
 SUM(a.he_comp)+SUM(a.la_comp)+SUM(a.re_comp),sum(a.he_person)+SUM(a.la_person)+SUM(a.re_person)+
 SUM(a.he_comp)+SUM(a.la_comp)+SUM(a.re_comp)
from salinsures a 
left join labase b on a.noa = b.noa 
where  (isnull(a.comp,'') between @t_bxcomp and @t_excomp) and
(b.issssp = 0) 
group by a.mon,a.comp,b.namea
end 
else 
begin
insert into @tmp
select '0' gno,a.mon,a.comp,b.namea,SUM(a.he_comp),SUM(a.la_comp),SUM(a.re_comp),sum(a.he_person),
SUM(a.la_person),SUM(a.re_person),sum(a.he_person)+SUM(a.la_person)+SUM(a.re_person),
 SUM(a.he_comp)+SUM(a.la_comp)+SUM(a.re_comp),sum(a.he_person)+SUM(a.la_person)+SUM(a.re_person)+
 SUM(a.he_comp)+SUM(a.la_comp)+SUM(a.re_comp)
from salinsures a 
left join labase b on a.noa = b.noa 
where  (isnull(a.comp,'') between @t_bxcomp and @t_excomp)
group by a.mon,a.comp,b.namea
end 

select gno,mon,comp,namea,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,he_self),1)),4,12)) he_self, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,he_comp),1)),4,12)) he_comp, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,la_self),1)),4,12)) la_self,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,la_comp),1)),4,12)) la_comp, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,re_self),1)),4,12)) re_self,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,re_comp),1)),4,12)) re_comp, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,selftotal),1)),4,12)) selftotal, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,comptotal),1)),4,12)) comptotal, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total),1)),4,12)) total 
from @tmp 
where (LEN(@t_cmon) = 0 or @t_cmon = mon)
order by mon,gno;
-------------------------------------------------------------------------------------------------
z_labase4:--z_labase4
declare @t_xyear nvarchar(20)
set @t_xyear = case when '#non' =  [10] then '' else  [10] end
declare @tmpa table(-----基本資料
		gno nvarchar(1),
		noa nvarchar(30),
		namea nvarchar(50),
		id nvarchar(20),
		addr nvarchar(50)
)
insert into @tmpa
select '0' gno,a.noa,a.namea,a.id,a.addr_conn --員工
from sss a
union 
select '0' gno,a.noa,a.namea,a.id,a.addr_conn --寄保
from sssp a
union
select '0' gno,a.noa,a.namea,a.idno,a.addr_conn --司機
from driver a
union 
select '0' gno,a.noa,a.namea,a.idno,a.addr_conn --車主
from carOwner a

declare @tmp table (
		gno nvarchar(1),
		mon nvarchar(10),
		[year] nvarchar(10),
		namea nvarchar(50),
		id nvarchar(20),
		addr nvarchar(50),
		re1 float,
		re2 float,
		re3 float,
		re4 float,
		re5 float,
		re6 float,
		re7 float,
		re8 float,
		re9 float,
		rea float,
		reb float,
		rec float,
		red float,
		memo1 nvarchar(50),
		memo2 nvarchar(50),
		memo3 nvarchar(50),
		memo4 nvarchar(50),
		memo5 nvarchar(50),
		memo6 nvarchar(50),
		memo7 nvarchar(50),
		memo8 nvarchar(50),
		memo9 nvarchar(50),
		memoa nvarchar(50),
		memob nvarchar(50),
		memoc nvarchar(50)
)
insert into @tmp
select '0' gno,a.mon,LEFT(a.mon,3),b.namea,b.id,b.addr,isnull(case when right(a.mon,2) = '01' then a.sa_retire end,0),
isnull(case when right(a.mon,2) = '02' then a.sa_retire end,0),isnull(case when right(a.mon,2) = '03' then a.sa_retire end,0),
isnull(case when right(a.mon,2) = '04' then a.sa_retire end,0),
isnull(case when right(a.mon,2) = '05' then a.sa_retire end,0),isnull(case when right(a.mon,2) = '06' then a.sa_retire end,0),
isnull(case when right(a.mon,2) = '07' then a.sa_retire end,0),isnull(case when right(a.mon,2) = '08' then a.sa_retire end,0),
isnull(case when right(a.mon,2) = '09' then a.sa_retire end,0),isnull(case when right(a.mon,2) = '10' then a.sa_retire end,0),
isnull(case when right(a.mon,2) = '11' then a.sa_retire end,0),isnull(case when right(a.mon,2) = '12' then a.sa_retire end,0),
isnull(case when right(a.mon,2) = '01' then a.sa_retire end,0)+
isnull(case when right(a.mon,2) = '02' then a.sa_retire end,0)+isnull(case when right(a.mon,2) = '03' then a.sa_retire end,0)+
isnull(case when right(a.mon,2) = '04' then a.sa_retire end,0)+
isnull(case when right(a.mon,2) = '05' then a.sa_retire end,0)+isnull(case when right(a.mon,2) = '06' then a.sa_retire end,0)+
isnull(case when right(a.mon,2) = '07' then a.sa_retire end,0)+isnull(case when right(a.mon,2) = '08' then a.sa_retire end,0)+
isnull(case when right(a.mon,2) = '09' then a.sa_retire end,0)+isnull(case when right(a.mon,2) = '10' then a.sa_retire end,0)+
isnull(case when right(a.mon,2) = '11' then a.sa_retire end,0)+isnull(case when right(a.mon,2) = '12' then a.sa_retire end,0),
case when right(a.mon,2) = '01' then a.memo end,case when right(a.mon,2) = '02' then a.memo end,
case when right(a.mon,2) = '03' then a.memo end,case when right(a.mon,2) = '04' then a.memo end,
case when right(a.mon,2) = '05' then a.memo end,case when right(a.mon,2) = '06' then a.memo end,
case when right(a.mon,2) = '07' then a.memo end,case when right(a.mon,2) = '08' then a.memo end,
case when right(a.mon,2) = '09' then a.memo end,case when right(a.mon,2) = '10' then a.memo end,
case when right(a.mon,2) = '11' then a.memo end,case when right(a.mon,2) = '12' then a.memo end
from salinsures a
left join @tmpa b on a.noa = b.noa
where (LEN(@t_xyear) = 0 or @t_xyear = LEFT(a.mon,3))

insert into @tmp
select '1' gno,'','',namea,'','',0,0,0,0,0,0,0,0,0,0,0,0,0,'','','','','','','','','','','',''
from @tmp

select gno,mon,year,namea,id,addr,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,re1),1)),4,12)) re1,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,re2),1)),4,12)) re2,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,re3),1)),4,12)) re3,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,re4),1)),4,12)) re4,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,re5),1)),4,12)) re5,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,re6),1)),4,12)) re6,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,re7),1)),4,12)) re7,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,re8),1)),4,12)) re8,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,re9),1)),4,12)) re9,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,rea),1)),4,12)) rea,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,reb),1)),4,12)) reb,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,rec),1)),4,12)) rec,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,red),1)),4,12)) red,
memo1,memo2,memo3,memo4,memo5,memo6,memo7,memo8,memo9,memoa,memob,memoc
from @tmp
order by namea,gno desc;



---------------------------------------------------------------------------------------------------

z_labase5:--z_labase5
declare @t_bxcomp nvarchar(20)
declare @t_excomp nvarchar(20)
set @t_bxcomp = case when '#non' = [5] then '' else [5] end
set @t_excomp = case when '#non' = [6] then CHAR(255) else [6] end

declare @tmp table( 
	gno nvarchar(1), 
	cno nvarchar(20), 
	acomp nvarchar(50), 
	noa nvarchar(20), 
	namea nvarchar(50), 
	id nvarchar(20), 
	birthday nvarchar(10), 
	indate nvarchar(10), 
	bdate nvarchar(10), 
	salary float,
	osalary float,
	ocomp nvarchar(50),
	edate nvarchar(10),  
	addr nvarchar(MAX), 
	memo nvarchar(MAX),
	child nvarchar(1),
	elab nvarchar(1)
) 

insert into @tmp 
select '0',b.cno,c.acomp,a.noa,a.namea,b.id,b.birthday,b.indate,b.health_bdate,a.salary
,(select top 1 salary from salinsures where noa=a.noa order by mon desc) osalary
,(select top 1 comp from salinsures where noa=a.noa order by mon desc)ocomp
,b.health_edate,b.addr_conn,a.memo ,'0',(case when b.health_edate!='' then '1' else '0' end)
from labase a left join (
select noa,cno,id,birthday,indate,health_bdate,health_edate,labor1_bdate,labor1_edate,labor2_bdate,labor2_edate,addr_conn from sss
union
select noa,cno,id,birthday,indate,health_bdate,health_edate,labor1_bdate,labor1_edate,labor2_bdate,labor2_edate,addr_conn from sssp
union
select noa,cno,idno id,birthday,indate,health_bdate,health_edate,labor1_bdate,labor1_edate,labor2_bdate,labor2_edate,addr_conn from driver
union
select noa,cno,idno id,birthday,indate,health_bdate,health_edate,labor1_bdate,labor1_edate,labor2_bdate,labor2_edate,addr_conn from carOwner
) b on a.noa=b.noa
left join acomp c on b.cno=c.noa
where (b.cno between @t_bxcomp and @t_excomp) 


insert into @tmp
select '0',b.cno,b.acomp,a.noa,' 眷：'+a.namea,a.id,a.birthday,'','',null,null,'','','','','1',b.elab
from labases a left join @tmp b on a.noa=b.noa

insert into @tmp
select '1',cno,'','','','','','','',null,null,'','','','','','0' from @tmp
where elab='1'
group by cno,elab

insert into @tmp
select '2',cno,'','','','','','','',null,null,'','','','','','3' from @tmp
group by cno
 
select gno,cno,acomp,noa,(case when child='1' then '' else noa end)xnoa,namea,id,birthday,indate,bdate,ocomp,edate,addr,memo,child,elab,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,salary),1)),4,12)) salary,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,osalary),1)),4,12)) osalary
from @tmp order by cno,elab,gno,noa,child;

---------------------------------------------------------------------------------------------------

z_labase6:--z_labase6
declare @t_bxmon nvarchar(10)
declare @t_exmon nvarchar(10) 
set @t_bxmon = case when '#non' = [1] then '' else [1] end 
set @t_exmon = case when '#non' = [2] then CHAR(255) else [2] end 
declare @tmp table(
	gno nvarchar(1),
	noa nvarchar(30),
	namea nvarchar(50),
	isforeign nvarchar(15),
	issssp nvarchar(15),
	insur_fund float,
	insur_disaster float,
	bdate nvarchar(20),
	salary nvarchar(15),
	custno nvarchar(20),
	comp nvarchar(50),
	sa_retire nvarchar(15),
	re_comp nvarchar(15),
	re_person nvarchar(15),
	sa_labor nvarchar(15),
	as_labor nvarchar(15),
	la_person nvarchar(15),
	la_comp nvarchar(15),
	sa_health nvarchar(15),
	as_health nvarchar(15),
	he_person nvarchar(15),
	he_comp nvarchar(15),
	tax float,
	mount float,
	disaster float,
	worker nvarchar(50),
	memo nvarchar(200)
)
declare @tmpa table(
	gno nvarchar(15),
	noa nvarchar(30),
	namea nvarchar(50),
	isforeign nvarchar(15),
	issssp nvarchar(15),
	insur_fund float,
	insur_disaster float,
	bdate nvarchar(20),
	salary nvarchar(15),
	custno nvarchar(20),
	comp nvarchar(50),
	sa_retire nvarchar(15),
	re_comp nvarchar(15),
	re_person nvarchar(15),
	sa_labor nvarchar(15),
	as_labor nvarchar(15),
	la_person nvarchar(15),
	la_comp nvarchar(15),
	sa_health nvarchar(15),
	as_health nvarchar(15),
	he_person nvarchar(15),
	he_comp nvarchar(15),
	tax float,
	mount float,
	disaster float,
	worker nvarchar(50),
	memo nvarchar(200),
	b_noa nvarchar(15),
	b_noq nvarchar(15),
	b_prefix nvarchar(15),
	b_namea nvarchar(15),
	b_birthday nvarchar(15),
	b_id nvarchar(15),
	b_ch_money nvarchar(15),
	b_as_health nvarchar(15),
	b_indate nvarchar(15),
	b_outdate nvarchar(15)
)
insert into @tmp
select '0' gno, noa,namea,case isforeign
when '1' then '外勞'
else '非外勞'
end,
case issssp
when '1' then '寄保'
else '非寄保'
end,
insur_fund,insur_disaster,bdate,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,salary),1)),4,12)) salary,custno,comp,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,sa_retire),1)),4,12)) sa_retire,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,re_comp),1)),4,12)) re_comp,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,re_person),1)),4,12)) re_person,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,sa_labor),1)),4,12)) sa_labor,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,as_labor),1)),4,12)) as_labor,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,la_person),1)),4,12)) la_person,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,la_comp),1)),4,12)) la_comp,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,sa_health),1)),4,12)) sa_health,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,as_health),1)),4,12)) as_health,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,he_person),1)),4,12)) he_person,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,he_comp),1)),4,12)) he_comp,
tax,mount,disaster,worker,memo
from labase
where (left(bdate,len(bdate)-3) between @t_bxmon and @t_exmon)
insert into @tmpa
select * from @tmp a left join labases on a.noa = labases.noa
insert into @tmpa
select '1' gno,noa,max(namea),'','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','' from @tmpa
group by noa
select * from @tmpa order by noa,gno;
---------------------------------------------------------------------------------------------------

z_labase7:--z_labase7
declare @t_bxmon nvarchar(10)
declare @t_exmon nvarchar(10) 
set @t_bxmon = case when '#non' = [1] then '' else [1] end 
set @t_exmon = case when '#non' = [2] then CHAR(255) else [2] end 
declare @tmp table(
	gno nvarchar(1),
	noa nvarchar(10),
	mon nvarchar(10),
	namea nvarchar(50),
	he_person nvarchar(15),
	he_comp nvarchar(15),
	la_person nvarchar(15),
	la_comp nvarchar(15),
	re_person nvarchar(15),
	re_comp nvarchar(15),
	total1 nvarchar(15),
	total2 nvarchar(15),
	payc nvarchar(20),
	pay nvarchar(15),
	unpay nvarchar(15),
	salary nvarchar(15),
	sa_retire nvarchar(15),
	sa_labor nvarchar(15),
	sa_health nvarchar(15),
	mount decimal(7, 0),
	disaster decimal(7, 0),
	comp nvarchar(90)
)

insert into @tmp
select '0' gno, noa,mon,(select namea from labase where labase.noa = a.noa) namea,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,he_person),1)),4,12)) he_person,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,he_comp),1)),4,12)) he_comp,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,la_person),1)),4,12)) la_person,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,la_comp),1)),4,12)) la_comp,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,re_person),1)),4,12)) re_person,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,re_comp),1)),4,12)) re_comp,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total1),1)),4,12)) total1,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total2),1)),4,12)) total2,
payc,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,pay),1)),4,12)) pay,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,unpay),1)),4,12)) unpay,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,salary),1)),4,12)) salary,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,sa_retire),1)),4,12)) sa_retire,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,sa_labor),1)),4,12)) sa_labor,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,sa_health),1)),4,12)) sa_health,
mount,disaster,comp
from salinsures a
where (mon between @t_bxmon and @t_exmon)
select * from @tmp;
-----------------------------------------------------------------------------------------------
z_labase8:--z_labase8
declare @t_bxmon nvarchar(20)
declare @t_exmon nvarchar(20)
declare @t_bcustno nvarchar(20)
declare @t_ecustno nvarchar(20)
declare @t_bcarownerno nvarchar(20)
declare @t_ecarownerno nvarchar(20)
declare @t_accy nvarchar(10)
declare @t_xtypea nvarchar(20)
set @t_accy = '[14]'
set @t_bxmon = case when '#non' = [1] then '' else [1] end
set @t_exmon = case when '#non' = [2] then CHAR(255) else [2] end
set @t_bcustno = case when '#non' = [7] then '' else [7] end
set @t_ecustno = case when '#non' = [8] then '' else [8] end
set @t_bcarownerno = case when '#non' = [12] then '' else [12] end
set @t_ecarownerno = case when '#non' = [13] then '' else [13] end
set @t_xtypea = case when '#non' = [15] then '' else [15] end 
declare @distinctcount1 int
declare @distinctcount2 int
set @distinctcount1 = 0
set @distinctcount2 = 0
if (@t_bcarownerno = '' and @t_ecarownerno = '' and @t_bcustno = '' and @t_ecustno = '' ) 
begin 
set @t_ecustno=CHAR(255) 
set @t_ecarownerno=CHAR(255) 
end 
declare @tmp table( 
gno nvarchar(1), 
noa nvarchar(30), 
noq nvarchar(20), 
mon nvarchar(10), 
datea nvarchar(10), 
typea nvarchar(20), 
custno nvarchar(20), 
comp nvarchar(50), 
carno nvarchar(20), 
memo nvarchar(100), 
outmoney float, 
inmoney float, 
cust nvarchar(20), 
smount nvarchar(20), 
custmo float, 
mount float 
) 
if(@t_xtypea = '監理部') 
begin 
insert into @tmp 
select '0' gno,a.noa,b.noq,b.mon,b.datea,'車主寄保' typea,a.carownerno,a.carowner,b.carno,b.memo,b.outmoney,b.inmoney,'',a.carownerno,0,0 
from cara a 
left join caras b on a.noa = b.noa 
where (b.mon between @t_bxmon and @t_exmon) and 
(a.carownerno between @t_bcarownerno and @t_ecarownerno) and 
caritem='健勞保費' 
end 
else if(@t_xtypea = '非監理部') 
begin 
insert into @tmp 
select '0' gno,a.noa,'',a.mon,a.datea,'一般寄保' typea,a.custno,a.comp,a.carno,a.memo,a.money,0,a.custno,'',0,0 
from vcc102 a 
where (a.mon between @t_bxmon and @t_exmon) and 
(a.custno between @t_bcustno and @t_ecustno) and 
memo='健勞勞退' 
end 
else 
begin 
insert into @tmp 
select '0' gno,a.noa,b.noq,b.mon,b.datea,'車主寄保' typea,a.carownerno,a.carowner,b.carno,b.memo,b.outmoney,b.inmoney,'',a.carownerno,0,0 
from cara a 
left join caras b on a.noa = b.noa 
where (b.mon between @t_bxmon and @t_exmon) and 
(a.carownerno between @t_bcarownerno and @t_ecarownerno) and 
caritem='健勞保費' 

union 
select '0' gno,a.noa,'',a.mon,a.datea,'一般寄保' typea,a.custno,a.comp,a.carno,a.memo,a.money,0,a.custno,'',0,0 
from vcc[14] a 
where (a.mon between @t_bxmon and @t_exmon) and 
(a.custno between @t_bcustno and @t_ecustno) and 
memo='健勞勞退' 
end 
insert into @tmp 
select '1' gno,'','','','','',custno,'','','',SUM(outmoney),SUM(inmoney),'','',0,0 
from @tmp 
group by custno 

select @distinctcount1 = COUNT(DISTINCT cust ) from @tmp where (gno !=1) and cust != ''
select @distinctcount2 = COUNT(DISTINCT smount)  from @tmp where (gno !=1) and smount != ''
insert into @tmp 
select '2' gno,'','','','','',CHAR(255),'','','',SUM(outmoney),SUM(inmoney),'','',@distinctcount1,@distinctcount2
from @tmp 
where gno != 1 

select gno,noa,noq,mon,datea,typea,custno,comp,carno,memo, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,outmoney),1)),4,12)) outmoney, 
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,inmoney),1)),4,12)) inmoney,custmo,mount,cust,smount 
from @tmp 
order by custno,gno;
