tran_sum:--tran_sum
	SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	declare @t_mon nvarchar(10) = [1]
	-----------------------------------------------------------------------------------------
	IF OBJECT_ID('tempdb..#z_trana')is not null
	BEGIN
		set @cmd = 'drop table #z_trana'
		EXECUTE sp_executesql @cmd
	END
	create table #z_trana(
		tranaccy nvarchar(10),
		tranno nvarchar(20),
		trannoq nvarchar(10),
		
		carno nvarchar(20),
		driverno nvarchar(20),
		custno nvarchar(20),
		carteamno nvarchar(20),
		trandate nvarchar(10),
		
		insures float,--勞健保(公司負擔)
		money1 float,--應收運費
		money2 float,--應付運費
		custplus float,--客戶加項
		custminus float,--客戶減項
		driverplus float,--司機加項
		driverminus float,--司機減項
		reserve float,--寄櫃費
		tolls float,--通行費
		etc float,--ETC
		oil float,--油費
		wmoney float,--工資
		wmoneycar float,--工資 車頭  大昌用
		wmoneyplate float,--工資 板台  大昌用
		cmoney float,--輪胎
		dmoney float,--材料
		emoney float,--費用
		ticket float,--罰單(公司負擔)
		bonus float,--達成獎金
		tax float,--保牌燃費
		depreciation float,--折舊
		driverpay float,--司機付
		
		profit float --毛利
	)
	--CREATE INDEX no1 ON #z_trana (tranaccy,tranno,trannoq)
	--CREATE INDEX no2 ON #z_trana (carno)
	--CREATE INDEX no3 ON #z_trana (carno,driverno)
	--CREATE INDEX no4 ON #z_trana (carno,trandate)
	--出車單************************************************************************
	insert into #z_trana(tranaccy,tranno,trannoq,carno,driverno,custno,carteamno,trandate,money1,money2,reserve,tolls)
	select accy,noa,noq  ,carno,driverno,custno,carteamno,trandate,total,total2,reserve,tolls
	from view_trans where LEFT(trandate,6)=@t_mon
	--折舊、保牌燃費************************************************************************
	declare @tmp1 table(
		carno nvarchar(20),
		tax float,--保牌燃費
		depreciation float,--折舊
		tax1 float,--修正用
		depreciation1 float,--修正用
		tax2 float,--修正用
		depreciation2 float--修正用
	)
	insert into @tmp1(carno,tax,depreciation)
	select a.carno,sum(isnull(b.tax,0)) mm1,sum(isnull(b.depreciation,0)) mm2 
	from cart a right join carts b on a.noa=b.noa 
	where b.mon=@t_mon and not(isnull(b.depreciation,0)=0 and isnull(b.tax,0)=0)
	group by a.carno
		
	update #z_trana set tax=case when b.money1=0 then 0 else round(a.money1/b.money1*c.tax,0) end
		,depreciation=case when b.money1=0 then 0 else round(a.money1/b.money1*c.depreciation,0) end
	from #z_trana a
	right join (select carno,SUM(money1) money1 from #z_trana where isnull(money1,0)>0 group by carno) b on a.carno=b.carno
	right join @tmp1 c on a.carno=c.carno
	where isnull(a.money1,0)>0
	--==修正金額
	update @tmp1 set tax1=b.mm1,depreciation1=b.mm2
	from @tmp1 a
	right join (select carno,SUM(ISNULL(tax,0)) mm1,sum(isnull(depreciation,0)) mm2 from #z_trana group by carno) b on a.carno=b.carno
	
	update @tmp1 set tax2 = ISNULL(tax,0)-ISNULL(tax1,0),depreciation2=ISNULL(depreciation,0)-ISNULL(depreciation1,0)	
	delete @tmp1 where ISNULL(tax2,0)=0 and ISNULL(depreciation2,0)=0	
	--==在平均分攤金額再加總時,多少會有誤差,因此依money1一次補1調整,LOOP 直到沒誤差
	update #z_trana set tax = a.tax + case when d.tax2<0 then -1 else 1 end * (floor(ABS(d.tax2)/c.nn)+case when (cast(ABS(d.tax2) as int)%c.nn)>=b.recno then 1 else 0 end)
		,depreciation = a.depreciation + case when d.depreciation2<0 then -1 else 1 end * (floor(ABS(d.depreciation2)/c.nn)+case when (cast(ABS(d.depreciation2) as int)%c.nn)>=b.recno then 1 else 0 end)
	from #z_trana a
	right join(select ROW_NUMBER()over(partition by carno order by money1) recno
		,tranaccy,tranno,trannoq from #z_trana where money1!=0) b on a.tranaccy=b.tranaccy 
		and a.tranno=b.tranno and a.trannoq=b.trannoq
	right join(select carno,COUNT(1) nn from #z_trana where money1!=0 group by carno) c on a.carno=c.carno
	right join @tmp1 d on a.carno=d.carno	
	--==無出車單的另外寫入
	update @tmp1 set tax1=b.mm1,depreciation1=b.mm2
	from @tmp1 a
	right join (select carno,SUM(ISNULL(tax,0)) mm1,sum(isnull(depreciation,0)) mm2 from #z_trana group by carno) b on a.carno=b.carno
	
	update @tmp1 set tax2 = ISNULL(tax,0)-ISNULL(tax1,0),depreciation2=ISNULL(depreciation,0)-ISNULL(depreciation1,0)	
	delete @tmp1 where ISNULL(tax2,0)=0 and ISNULL(depreciation2,0)=0	
	insert into #z_trana(carno,tax,depreciation)
	select carno,tax2,depreciation2 from @tmp1
	--************************************************************************
	--油費************************************************************************
	declare @tmp2 table(
		carno nvarchar(20),
		oil float,
		oil1 float,--修正用
		oil2 float--修正用
	)
	insert into @tmp2(carno,oil)
	select carno,SUM(ISNULL([money],0)) [money] 
	from oil 
	where left(oildate,6)=@t_mon and ISNULL([money],0)!=0
	group by carno
	
	update #z_trana set oil=case when b.money1=0 then 0 else round(a.money1/b.money1*c.oil,0) end
	from #z_trana a
	right join (select carno,SUM(money1) money1 from #z_trana where isnull(money1,0)>0 group by carno) b on a.carno=b.carno
	right join @tmp2 c on a.carno=c.carno
	where isnull(a.money1,0)>0
	--==修正金額
	update @tmp2 set oil1=b.mm1
	from @tmp2 a
	right join (select carno,SUM(ISNULL(oil,0)) mm1 from #z_trana group by carno) b on a.carno=b.carno
	
	update @tmp2 set oil2= ISNULL(oil,0)-ISNULL(oil1,0)	
	delete @tmp2 where ISNULL(oil2,0)=0 
	--==在平均分攤金額再加總時,多少會有誤差,因此依money1一次補1調整,LOOP 直到沒誤差
	update #z_trana set oil = a.oil + case when d.oil2<0 then -1 else 1 end * (floor(ABS(d.oil2)/c.nn)+case when (cast(ABS(d.oil2) as int)%c.nn)>=b.recno then 1 else 0 end)
	from #z_trana a
	right join(select ROW_NUMBER()over(partition by carno order by money1) recno
		,tranaccy,tranno,trannoq from #z_trana where money1!=0) b on a.tranaccy=b.tranaccy 
		and a.tranno=b.tranno and a.trannoq=b.trannoq
	right join(select carno,COUNT(1) nn from #z_trana where money1!=0 group by carno) c on a.carno=c.carno
	right join @tmp2 d on a.carno=d.carno	
	--==無出車單的另外寫入
	update @tmp2 set oil1=b.mm1
	from @tmp2 a
	right join (select carno,SUM(ISNULL(oil,0)) mm1 from #z_trana group by carno) b on a.carno=b.carno
	update @tmp2 set oil2= ISNULL(oil,0)-ISNULL(oil1,0)	
	delete @tmp2 where ISNULL(oil2,0)=0 
	insert into #z_trana(carno,oil)
	select carno,oil2 from @tmp2
	--************************************************************************
	--維修************************************************************************
	declare @tmp3 table(
		carno nvarchar(20),
		wmoney float,
		wmoneycar float,
		wmoneyplate float,
		cmoney float,
		dmoney float,
		emoney float,
		wmoney1 float,--修正用
		wmoneycar1 float,--修正用
		wmoneyplate1 float,--修正用
		cmoney1 float,--修正用
		dmoney1 float,--修正用
		emoney1 float,--修正用
		wmoney2 float,--修正用
		wmoneycar2 float,--修正用
		wmoneyplate2 float,--修正用
		cmoney2 float,--修正用
		dmoney2 float,--修正用
		emoney2 float--修正用
	)
	insert into @tmp3(carno,wmoney,wmoneycar,wmoneyplate,cmoney,dmoney,emoney)
	select carno,SUM(ISNULL(wmoney,0))
		,SUM(case when len(isnull(carplateno,''))=0 then ISNULL(wmoney,0) else 0 end)
		,SUM(case when len(isnull(carplateno,''))>0 then ISNULL(wmoney,0) else 0 end)
		,SUM(ISNULL(cmoney,0)),SUM(ISNULL(dmoney,0)),SUM(ISNULL(emoney,0))  
	from fixa
	where LEFT(fixadate,6)=@t_mon and not(ISNULL(wmoney,0)=0 and ISNULL(cmoney,0)=0 and ISNULL(dmoney,0)=0 and ISNULL(emoney,0)=0)
	group by carno
	
	update #z_trana set wmoney=case when b.money1=0 then 0 else round(a.money1/b.money1*c.wmoney,0) end
		,wmoneycar=case when b.money1=0 then 0 else round(a.money1/b.money1*c.wmoneycar,0) end
		,wmoneyplate=case when b.money1=0 then 0 else round(a.money1/b.money1*c.wmoneyplate,0) end
		,cmoney=case when b.money1=0 then 0 else round(a.money1/b.money1*c.cmoney,0) end
		,dmoney=case when b.money1=0 then 0 else round(a.money1/b.money1*c.dmoney,0) end
		,emoney=case when b.money1=0 then 0 else round(a.money1/b.money1*c.emoney,0) end
	from #z_trana a
	right join (select carno,SUM(money1) money1 from #z_trana where isnull(money1,0)>0 group by carno) b on a.carno=b.carno
	right join @tmp3 c on a.carno=c.carno
	where isnull(a.money1,0)>0
	--==修正金額
	update @tmp3 set wmoney1=b.mm1,cmoney1=b.mm2,dmoney1=b.mm3,emoney1=b.mm4,wmoneycar1=b.mm5,wmoneyplate1=b.mm6
	from @tmp3 a
	right join (select carno,SUM(ISNULL(wmoney,0)) mm1,SUM(ISNULL(cmoney,0)) mm2 
		,SUM(ISNULL(dmoney,0)) mm3 ,SUM(ISNULL(emoney,0)) mm4
		,SUM(ISNULL(wmoneycar,0)) mm5,SUM(ISNULL(wmoneyplate,0)) mm6 
		from #z_trana group by carno) b on a.carno=b.carno
	
	update @tmp3 set wmoney2= ISNULL(wmoney,0)-ISNULL(wmoney1,0)
		,wmoneycar2= ISNULL(wmoneycar,0)-ISNULL(wmoneycar1,0)
		,wmoneyplate2= ISNULL(wmoneyplate,0)-ISNULL(wmoneyplate1,0)
		,cmoney2= ISNULL(cmoney,0)-ISNULL(cmoney1,0)
		,dmoney2= ISNULL(dmoney,0)-ISNULL(dmoney1,0)
		,emoney2= ISNULL(emoney,0)-ISNULL(emoney1,0)	
	delete @tmp3 where ISNULL(wmoney2,0)=0 and ISNULL(cmoney2,0)=0 and ISNULL(dmoney2,0)=0 and ISNULL(emoney2,0)=0 
	--==在平均分攤金額再加總時,多少會有誤差,因此依money1一次補1調整,LOOP 直到沒誤差
	update #z_trana set wmoney = a.wmoney + case when d.wmoney2<0 then -1 else 1 end * (floor(ABS(d.wmoney2)/c.nn)+case when (cast(ABS(d.wmoney2) as int)%c.nn)>=b.recno then 1 else 0 end)
		,wmoneycar = a.wmoneycar + case when d.wmoneycar2<0 then -1 else 1 end * (floor(ABS(d.wmoneycar2)/c.nn)+case when (cast(ABS(d.wmoneycar2) as int)%c.nn)>=b.recno then 1 else 0 end)
		,wmoneyplate = a.wmoneyplate + case when d.wmoneyplate2<0 then -1 else 1 end * (floor(ABS(d.wmoneyplate2)/c.nn)+case when (cast(ABS(d.wmoneyplate2) as int)%c.nn)>=b.recno then 1 else 0 end)
		,cmoney = a.cmoney + case when d.cmoney2<0 then -1 else 1 end * (floor(ABS(d.cmoney2)/c.nn)+case when (cast(ABS(d.cmoney2) as int)%c.nn)>=b.recno then 1 else 0 end)
		,dmoney = a.dmoney + case when d.dmoney2<0 then -1 else 1 end * (floor(ABS(d.dmoney2)/c.nn)+case when (cast(ABS(d.dmoney2) as int)%c.nn)>=b.recno then 1 else 0 end)
		,emoney = a.emoney + case when d.emoney2<0 then -1 else 1 end * (floor(ABS(d.emoney2)/c.nn)+case when (cast(ABS(d.emoney2) as int)%c.nn)>=b.recno then 1 else 0 end)
	from #z_trana a
	right join(select ROW_NUMBER()over(partition by carno order by money1) recno
		,tranaccy,tranno,trannoq from #z_trana where money1!=0) b on a.tranaccy=b.tranaccy 
		and a.tranno=b.tranno and a.trannoq=b.trannoq
	right join(select carno,COUNT(1) nn from #z_trana where money1!=0 group by carno) c on a.carno=c.carno
	right join @tmp3 d on a.carno=d.carno	
	--==無出車單的另外寫入
	update @tmp3 set wmoney1=b.mm1,cmoney1=b.mm2,dmoney1=b.mm3,emoney1=b.mm4,wmoneycar1=b.mm5,wmoneyplate1=b.mm6
	from @tmp3 a
	right join (select carno,SUM(ISNULL(wmoney,0)) mm1,SUM(ISNULL(cmoney,0)) mm2 
		,SUM(ISNULL(dmoney,0)) mm3 ,SUM(ISNULL(emoney,0)) mm4
		,SUM(ISNULL(wmoneycar,0)) mm5,SUM(ISNULL(wmoneyplate,0)) mm6 
		from #z_trana group by carno) b on a.carno=b.carno
	
	update @tmp3 set wmoney2= ISNULL(wmoney,0)-ISNULL(wmoney1,0)
		,wmoneycar2= ISNULL(wmoneycar,0)-ISNULL(wmoneycar1,0)
		,wmoneyplate2= ISNULL(wmoneyplate,0)-ISNULL(wmoneyplate1,0)
		,cmoney2= ISNULL(cmoney,0)-ISNULL(cmoney1,0)
		,dmoney2= ISNULL(dmoney,0)-ISNULL(dmoney1,0)
		,emoney2= ISNULL(emoney,0)-ISNULL(emoney1,0)	
	delete @tmp3 where ISNULL(wmoney2,0)=0 and ISNULL(cmoney2,0)=0 and ISNULL(dmoney2,0)=0 and ISNULL(emoney2,0)=0 
	insert into #z_trana(carno,wmoney,wmoneycar,wmoneyplate,cmoney,dmoney,emoney)
	select carno,wmoney2,wmoneycar2,wmoneyplate2,cmoney2,dmoney2,emoney2 from @tmp3
	--************************************************************************
	--罰單************************************************************************
	declare @tmp4 table(
		carno nvarchar(20),
		driverno nvarchar(20),
		ticket float,
		ticket1 float,--修正用
		ticket2 float--修正用
	)
	insert into @tmp4(carno,driverno,ticket)
	select carno,ISNULL(driverno,''),sum(isnull(comppay,0)) 
	from carborr
	where left(datea,6)=@t_mon and typea='罰單' and isnull(comppay,0)!=0
	group by carno,ISNULL(driverno,''),isnull(driverno,'')
	
	update #z_trana set ticket=case when b.money1=0 then 0 else round(a.money1/b.money1*c.ticket,0) end
	from #z_trana a
	right join (select carno,SUM(money1) money1 from #z_trana where isnull(money1,0)>0 group by carno) b on a.carno=b.carno
	right join @tmp4 c on a.carno=c.carno and a.driverno=c.driverno
	where isnull(a.money1,0)>0
	--==修正金額
	update @tmp4 set ticket1=b.mm1
	from @tmp4 a
	right join (select carno,driverno,SUM(ISNULL(ticket,0)) mm1 from #z_trana group by carno,driverno) b on a.carno=b.carno and a.driverno=b.driverno
	
	update @tmp4 set ticket2= ISNULL(ticket,0)-ISNULL(ticket1,0)	
	delete @tmp4 where ISNULL(ticket2,0)=0 
	--==在平均分攤金額再加總時,多少會有誤差,因此依money1一次補1調整,LOOP 直到沒誤差
	update #z_trana set ticket = a.ticket + case when d.ticket2<0 then -1 else 1 end * (floor(ABS(d.ticket2)/c.nn)+case when (cast(ABS(d.ticket2) as int)%c.nn)>=b.recno then 1 else 0 end)
	from #z_trana a
	right join(select ROW_NUMBER()over(partition by carno,driverno order by money1) recno
		,tranaccy,tranno,trannoq from #z_trana where money1!=0) b on a.tranaccy=b.tranaccy 
		and a.tranno=b.tranno and a.trannoq=b.trannoq
	right join(select carno,driverno,COUNT(1) nn from #z_trana where money1!=0 group by carno,driverno) c on a.carno=c.carno and a.driverno=c.driverno
	right join @tmp4 d on a.carno=d.carno and a.driverno=d.driverno	
	--==無出車單的另外寫入
	update @tmp4 set ticket1=b.mm1
	from @tmp4 a
	right join (select carno,driverno,SUM(ISNULL(ticket,0)) mm1 from #z_trana group by carno,driverno) b on a.carno=b.carno and a.driverno=b.driverno
	update @tmp4 set ticket2= ISNULL(ticket,0)-ISNULL(ticket1,0)	
	delete @tmp4 where ISNULL(ticket2,0)=0  
	insert into #z_trana(carno,driverno,ticket)
	select carno,driverno,ticket2 from @tmp4
	--************************************************************************
	--ETC************************************************************************
	declare @tmp5 table(
		carno nvarchar(20),
		datea nvarchar(10),
		etc float,
		etc1 float,--修正用
		etc2 float--修正用
	)
	insert into @tmp5(carno,datea,etc)
	select carno,datea,SUM(ISNULL([money],0)) [money] 
	from etc
	where left(datea,6)=@t_mon and ISNULL([money],0)!=0
	group by carno,datea
	
	update #z_trana set etc=case when b.money1=0 then 0 else round(a.money1/b.money1*c.etc,0) end
	from #z_trana a
	right join (select carno,SUM(money1) money1 from #z_trana where isnull(money1,0)>0 group by carno) b on a.carno=b.carno
	right join @tmp5 c on a.carno=c.carno and a.trandate=c.datea
	where isnull(a.money1,0)>0
	
	--select * from @tmp5
	----==修正金額
	update @tmp5 set etc1=b.mm1
	from @tmp5 a
	right join (select carno,trandate,SUM(ISNULL(etc,0)) mm1 from #z_trana group by carno,trandate) b on a.carno=b.carno and a.datea=b.trandate
	update @tmp5 set etc2= ISNULL(etc,0)-ISNULL(etc1,0)	
	delete @tmp5 where ISNULL(etc2,0)=0 
	--==在平均分攤金額再加總時,多少會有誤差,因此依money1一次補1調整,LOOP 直到沒誤差
	update #z_trana set etc = a.etc + case when d.etc2<0 then -1 else 1 end * (floor(ABS(d.etc2)/c.nn)+case when (cast(ABS(d.etc2) as int)%c.nn)>=b.recno then 1 else 0 end)
	from #z_trana a
	right join(select ROW_NUMBER()over(partition by carno,trandate order by money1) recno
		,tranaccy,tranno,trannoq from #z_trana where money1!=0) b on a.tranaccy=b.tranaccy 
		and a.tranno=b.tranno and a.trannoq=b.trannoq
	right join(select carno,trandate,COUNT(1) nn from #z_trana where money1!=0 group by carno,trandate) c on a.carno=c.carno and a.trandate=c.trandate
	right join @tmp5 d on a.carno=d.carno and a.trandate=d.datea	
	--==無出車單的另外寫入
	update @tmp5 set etc1=b.mm1
	from @tmp5 a
	right join (select carno,trandate,SUM(ISNULL(etc,0)) mm1 from #z_trana group by carno,trandate) b on a.carno=b.carno and a.datea=b.trandate
	update @tmp5 set etc2= ISNULL(etc,0)-ISNULL(etc1,0)	
	delete @tmp5 where ISNULL(etc2,0)=0 
	insert into #z_trana(carno,trandate,etc)
	select carno,datea,etc from @tmp5
	--************************************************************************
	--達成獎金************************************************************************
	declare @tmp6 table(
		driverno nvarchar(20),
		bonus float,
		bonus1 float,--修正用
		bonus2 float--修正用
	)
	insert into @tmp6(driverno,bonus)
	select driverno,SUM(ISNULL(bonus,0)) 
	from carsals
	where noa=@t_mon and ISNULL(bonus,0)!=0
	group by driverno
	
	update #z_trana set bonus=case when b.money2=0 then 0 else round(a.money2/b.money2*c.bonus,0) end
	from #z_trana a
	right join (select carno,SUM(money2) money2 from #z_trana where isnull(money2,0)>0 group by carno) b on a.carno=b.carno
	right join @tmp6 c on a.driverno=c.driverno
	where isnull(a.money2,0)>0
	--==修正金額
	update @tmp6 set bonus1=b.mm1
	from @tmp6 a
	right join (select driverno,SUM(ISNULL(bonus,0)) mm1 from #z_trana group by driverno) b on a.driverno=b.driverno
	update @tmp6 set bonus2= ISNULL(bonus,0)-ISNULL(bonus1,0)	
	delete @tmp6 where ISNULL(bonus2,0)=0 
	--==在平均分攤金額再加總時,多少會有誤差,因此依money2一次補1調整,LOOP 直到沒誤差
	update #z_trana set bonus = a.bonus + case when d.bonus2<0 then -1 else 1 end * (floor(ABS(d.bonus2)/c.nn)+case when (cast(ABS(d.bonus2) as int)%c.nn)>=b.recno then 1 else 0 end)
	from #z_trana a
	right join(select ROW_NUMBER()over(partition by driverno order by money2) recno
		,tranaccy,tranno,trannoq from #z_trana where money2!=0) b on a.tranaccy=b.tranaccy 
		and a.tranno=b.tranno and a.trannoq=b.trannoq
	right join(select driverno,COUNT(1) nn from #z_trana where money2!=0 group by driverno) c on a.driverno=c.driverno
	right join @tmp6 d on a.driverno=d.driverno	
	--==無出車單的另外寫入
	update @tmp6 set bonus1=b.mm1
	from @tmp6 a
	right join (select driverno,SUM(ISNULL(bonus,0)) mm1 from #z_trana group by driverno) b on a.driverno=b.driverno
	update @tmp6 set bonus2= ISNULL(bonus,0)-ISNULL(bonus1,0)	
	delete @tmp6 where ISNULL(bonus2,0)=0 
	insert into #z_trana(driverno,bonus)
	select driverno,bonus2 from @tmp6
	--************************************************************************
	--勞健保
	declare @tmp7 table(
		driverno nvarchar(20),
		insures float,
		insures1 float,--修正用
		insures2 float--修正用
	)
	insert into @tmp7(driverno,insures)
	select a.noa,SUM(ISNULL(a.total2,0)) 
	from salinsures a
	right join driver b on a.noa=b.noa
	where mon=@t_mon and ISNULL(a.total2,0)!=0
	group by a.noa
	
	update #z_trana set insures=case when b.money2=0 then 0 else round(a.money2/b.money2*c.insures,0) end
	from #z_trana a
	right join (select carno,SUM(money2) money2 from #z_trana where isnull(money2,0)>0 group by carno) b on a.carno=b.carno
	right join @tmp7 c on a.driverno=c.driverno
	where isnull(a.money2,0)>0
	--==修正金額
	update @tmp7 set insures1=b.mm1
	from @tmp7 a
	right join (select driverno,SUM(ISNULL(insures,0)) mm1 from #z_trana group by driverno) b on a.driverno=b.driverno
	update @tmp7 set insures2= ISNULL(insures,0)-ISNULL(insures1,0)	
	delete @tmp7 where ISNULL(insures2,0)=0 
	--==在平均分攤金額再加總時,多少會有誤差,因此依money2一次補1調整,LOOP 直到沒誤差
	update #z_trana set insures = a.insures + case when d.insures2<0 then -1 else 1 end * (floor(ABS(d.insures2)/c.nn)+case when (cast(ABS(d.insures2) as int)%c.nn)>=b.recno then 1 else 0 end)
	from #z_trana a
	right join(select ROW_NUMBER()over(partition by driverno order by money2) recno
		,tranaccy,tranno,trannoq from #z_trana where money2!=0) b on a.tranaccy=b.tranaccy 
		and a.tranno=b.tranno and a.trannoq=b.trannoq
	right join(select driverno,COUNT(1) nn from #z_trana where money2!=0 group by driverno) c on a.driverno=c.driverno
	right join @tmp7 d on a.driverno=d.driverno	
	--==無出車單的另外寫入
	update @tmp7 set insures1=b.mm1
	from @tmp7 a
	right join (select driverno,SUM(ISNULL(insures,0)) mm1 from #z_trana group by driverno) b on a.driverno=b.driverno
	update @tmp7 set insures2= ISNULL(insures,0)-ISNULL(insures1,0)	
	delete @tmp7 where ISNULL(insures2,0)=0 
	insert into #z_trana(driverno,insures)
	select driverno,insures2 from @tmp7
	--************************************************************************
	--客戶加減項************************************************************************
	declare @tmp8 table(
		custno nvarchar(20),
		custplus float,
		custminus float,
		custplus1 float,--修正用
		custminus1 float,--修正用
		custplus2 float,--修正用
		custminus2 float--修正用
	)
	insert into @tmp8(custno,custplus,custminus)
	select custno,SUM(ISNULL(plusmoney,0)),SUM(ISNULL(minusmoney,0)) 
	from custchg
	where left(datea,6)=@t_mon and not(ISNULL(plusmoney,0)=0 and ISNULL(minusmoney,0)=0)
	--排除 代收、付,暫收
	and (left(acc1,4)!='2195') and (left(acc1,4)!='1191') 
	and (left(acc1,4)!='2191') and (left(acc1,4)!='1149') 
	and (left(acc1,4)!='1194') and (left(acc1,4)!='1129') 
	and (left(acc1,4)!='4201') and (left(acc1,4)!='4202') 
	group by custno
	
	update #z_trana set custplus=case when b.money1=0 then 0 else round(a.money1/b.money1*c.custplus,0) end
		,custminus=case when b.money1=0 then 0 else round(a.money1/b.money1*c.custminus,0) end
	from #z_trana a
	right join (select custno,SUM(money1) money1 from #z_trana where isnull(money1,0)>0 group by custno) b on a.custno=b.custno
	right join @tmp8 c on a.custno=c.custno
	where isnull(a.money1,0)>0
	--==修正金額
	update @tmp8 set custplus1=b.mm1,custminus1=b.mm2
	from @tmp8 a
	right join (select custno,SUM(ISNULL(custplus,0)) mm1,SUM(ISNULL(custminus,0)) mm2 from #z_trana group by custno) b on a.custno=b.custno
	update @tmp8 set custplus2= ISNULL(custplus,0)-ISNULL(custplus1,0),custminus2= ISNULL(custminus,0)-ISNULL(custminus1,0)	
	delete @tmp8 where ISNULL(custplus2,0)=0 and ISNULL(custminus2,0)=0 
	--==在平均分攤金額再加總時,多少會有誤差,因此依money1一次補1調整,LOOP 直到沒誤差
	update #z_trana set custplus = a.custplus + case when d.custplus2<0 then -1 else 1 end * (floor(ABS(d.custplus2)/c.nn)+case when (cast(ABS(d.custplus2) as int)%c.nn)>=b.recno then 1 else 0 end)
		,custminus = a.custminus + case when d.custminus2<0 then -1 else 1 end * (floor(ABS(d.custminus2)/c.nn)+case when (cast(ABS(d.custminus2) as int)%c.nn)>=b.recno then 1 else 0 end)
	from #z_trana a
	right join(select ROW_NUMBER()over(partition by custno order by money1) recno
		,tranaccy,tranno,trannoq from #z_trana where money1!=0) b on a.tranaccy=b.tranaccy 
		and a.tranno=b.tranno and a.trannoq=b.trannoq
	right join(select custno,COUNT(1) nn from #z_trana where money1!=0 group by custno) c on a.custno=c.custno
	right join @tmp8 d on a.custno=d.custno	
	--==無出車單的另外寫入
	update @tmp8 set custplus=b.mm1,custminus=b.mm2
	from @tmp8 a
	right join (select custno,SUM(ISNULL(custplus,0)) mm1,SUM(ISNULL(custminus,0)) mm2 from #z_trana group by custno) b on a.custno=b.custno
	update @tmp8 set custplus2= ISNULL(custplus,0)-ISNULL(custplus1,0),custminus2= ISNULL(custminus,0)-ISNULL(custminus1,0)	
	delete @tmp8 where ISNULL(custplus2,0)=0 and ISNULL(custminus2,0)=0 
	insert into #z_trana(custno,custplus,custminus)
	select custno,custplus2,custminus2 from @tmp8
	--************************************************************************
	--司機加減項************************************************************************
	declare @tmp9 table(
		driverno nvarchar(20),
		driverplus float,
		driverminus float,
		driverplus1 float,--修正用
		driverminus1 float,--修正用
		driverplus2 float,--修正用
		driverminus2 float--修正用
	)
	insert into @tmp9(driverno,driverplus,driverminus)
	select driverno,SUM(ISNULL(plusmoney,0)),SUM(ISNULL(minusmoney,0)) 
	from carchg
	where left(datea,6)=@t_mon and not(ISNULL(plusmoney,0)=0 and ISNULL(minusmoney,0)=0)
	--排除 代收、付,暫收
	and (left(acc1,4)!='2195') and (left(acc1,4)!='1191') 
	and (left(acc1,4)!='2191') and (left(acc1,4)!='1149') 
	and (left(acc1,4)!='1194') and (left(acc1,4)!='1129') 
	and (left(acc1,4)!='4201') and (left(acc1,4)!='4202') 
	--有付款廠商的就判斷為代收、代付
	and len(isnull(tggno,''))=0
	group by driverno
	
	update #z_trana set driverplus=case when b.money2=0 then 0 else round(a.money2/b.money2*c.driverplus,0) end
		,driverminus=case when b.money2=0 then 0 else round(a.money2/b.money2*c.driverminus,0) end
	from #z_trana a
	right join (select driverno,SUM(money2) money2 from #z_trana where isnull(money2,0)>0 group by driverno) b on a.driverno=b.driverno
	right join @tmp9 c on a.driverno=c.driverno
	where isnull(a.money2,0)>0
	--==修正金額
	update @tmp9 set driverplus1=b.mm1,driverminus1=b.mm2
	from @tmp9 a
	right join (select driverno,SUM(ISNULL(driverplus,0)) mm1,SUM(ISNULL(driverminus,0)) mm2 
		from #z_trana group by driverno) b on a.driverno=b.driverno
	update @tmp9 set driverplus2= ISNULL(driverplus,0)-ISNULL(driverplus1,0),driverminus2= ISNULL(driverminus,0)-ISNULL(driverminus1,0)	
	delete @tmp9 where ISNULL(driverplus2,0)=0 and ISNULL(driverminus2,0)=0 
	--==在平均分攤金額再加總時,多少會有誤差,因此依money2一次補1調整,LOOP 直到沒誤差
	update #z_trana set driverplus = a.driverplus + case when d.driverplus2<0 then -1 else 1 end * (floor(ABS(d.driverplus2)/c.nn)+case when (cast(ABS(d.driverplus2) as int)%c.nn)>=b.recno then 1 else 0 end)
		,driverminus = a.driverminus + case when d.driverminus2<0 then -1 else 1 end * (floor(ABS(d.driverminus2)/c.nn)+case when (cast(ABS(d.driverminus2) as int)%c.nn)>=b.recno then 1 else 0 end)
	from #z_trana a
	right join(select ROW_NUMBER()over(partition by driverno order by money2) recno
		,tranaccy,tranno,trannoq from #z_trana where money2!=0) b on a.tranaccy=b.tranaccy 
		and a.tranno=b.tranno and a.trannoq=b.trannoq
	right join(select driverno,COUNT(1) nn from #z_trana where money2!=0 group by driverno) c on a.driverno=c.driverno
	right join @tmp9 d on a.driverno=d.driverno	
	--==無出車單的另外寫入
	update @tmp9 set driverplus1=b.mm1,driverminus1=b.mm2
	from @tmp9 a
	right join (select driverno,SUM(ISNULL(driverplus,0)) mm1,SUM(ISNULL(driverminus,0)) mm2 
		from #z_trana group by driverno) b on a.driverno=b.driverno
	update @tmp9 set driverplus2= ISNULL(driverplus,0)-ISNULL(driverplus1,0),driverminus2= ISNULL(driverminus,0)-ISNULL(driverminus1,0)	
	delete @tmp9 where ISNULL(driverplus2,0)=0 and ISNULL(driverminus2,0)=0 
	insert into #z_trana(driverno,driverplus,driverminus)
	select driverno,driverplus2,driverminus2 from @tmp9
	--************************************************************************
	--司機付************************************************************************
	declare @tmp10 table(
		carno nvarchar(20),
		driverno nvarchar(20),
		driverpay float,
		driverpay1 float,--修正用
		driverpay2 float--修正用
	)
	insert into @tmp10(carno,driverno,driverpay)
	select carno,ISNULL(driverno,''),sum(isnull(driverpay,0)) 
	from carborr
	where left(datea,6)=@t_mon and typea='維修' and isnull(driverpay,0)!=0
	group by carno,ISNULL(driverno,''),isnull(driverno,'')
	
	update #z_trana set driverpay=case when b.money1=0 then 0 else round(a.money1/b.money1*c.driverpay,0) end
	from #z_trana a
	right join (select carno,SUM(money1) money1 from #z_trana where isnull(money1,0)>0 group by carno) b on a.carno=b.carno
	right join @tmp10 c on a.carno=c.carno and a.driverno=c.driverno
	where isnull(a.money1,0)>0
	--==修正金額
	update @tmp10 set driverpay1=b.mm1
	from @tmp10 a
	right join (select carno,driverno,SUM(ISNULL(driverpay,0)) mm1 from #z_trana group by carno,driverno) b on a.carno=b.carno and a.driverno=b.driverno
	
	update @tmp10 set driverpay2= ISNULL(driverpay,0)-ISNULL(driverpay1,0)	
	delete @tmp10 where ISNULL(driverpay2,0)=0 
	--==在平均分攤金額再加總時,多少會有誤差,因此依money1一次補1調整,LOOP 直到沒誤差
	update #z_trana set driverpay = a.driverpay + case when d.driverpay2<0 then -1 else 1 end * (floor(ABS(d.driverpay2)/c.nn)+case when (cast(ABS(d.driverpay2) as int)%c.nn)>=b.recno then 1 else 0 end)
	from #z_trana a
	right join(select ROW_NUMBER()over(partition by carno,driverno order by money1) recno
		,tranaccy,tranno,trannoq from #z_trana where money1!=0) b on a.tranaccy=b.tranaccy 
		and a.tranno=b.tranno and a.trannoq=b.trannoq
	right join(select carno,driverno,COUNT(1) nn from #z_trana where money1!=0 group by carno,driverno) c on a.carno=c.carno and a.driverno=c.driverno
	right join @tmp10 d on a.carno=d.carno and a.driverno=d.driverno	
	--==無出車單的另外寫入
	update @tmp10 set driverpay1=b.mm1
	from @tmp10 a
	right join (select carno,driverno,SUM(ISNULL(driverpay,0)) mm1 from #z_trana group by carno,driverno) b on a.carno=b.carno and a.driverno=b.driverno
	
	update @tmp10 set driverpay2= ISNULL(driverpay,0)-ISNULL(driverpay1,0)	
	delete @tmp10 where ISNULL(driverpay2,0)=0 
	insert into #z_trana(carno,driverno,driverpay)
	select carno,driverno,driverpay2 from @tmp10
	--===============================================================
	delete trans_sum where mon=@t_mon
	insert into trans_sum
	select @t_mon,* from #z_trana
	drop table #z_trana;