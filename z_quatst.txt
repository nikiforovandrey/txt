z_quatst1:--z_quatst1
declare @t_bdate nvarchar(20)
declare @t_edate nvarchar(20)
declare @t_noa nvarchar(30)
set @t_bdate = case when '#non' = [2] then '' else [2] end
set @t_edate = case when '#non' = [3] then CHAR(255) else [3] end
set @t_noa = case when '#non' = [4] then '' else [4] end
declare @tmp table(
	gno nvarchar(1),
	a_noa nvarchar(30),
	a_stype nvarchar(15),
	a_datea nvarchar(10),
	a_acomp nvarchar(50),
	a_coin nvarchar(20),
	a_floata nvarchar(30),
	a_contract nvarchar(30),
	a_comps nvarchar(50),
	a_paytype nvarchar(15),
	a_trantype nvarchar(15),
	a_sales nvarchar(50),
	a_tel nvarchar(50),
	a_fax nvarchar(50),
	a_kind nvarchar (30),
	a_addressa nvarchar(max),
	a_addressb nvarchar(max),
	a_apv nvarchar(50),
	a_money float,
	a_taxs float,
	a_taxtype nvarchar(30),
	a_totala float,
	a_totalus float,
	a_weight float,
	a_tpayweights float,
	a_tunpayweight float,
	a_ttransferordes float,
	a_tuntransferorde float,
	a_tenda nvarchar(10),
	a_mpayweights float,
	a_munpayweight float,
	a_mtransferordes float,
	a_muntransferorde float,
	a_menda nvarchar(10),
	a_memo nvarchar(200),
	b_productno nvarchar(35),
	b_no3 nvarchar(10),
	b_products nvarchar(50),
	b_class nvarchar(10),
	b_size nvarchar(100),
	b_spec nvarchar(90),
	b_unit nvarchar(10),
	b_mount float,
	b_weight float,
	b_price float,
	b_total float,
	b_theory float,
	b_memo nvarchar(200),
	b_ordeno nvarchar(35),
	b_enda nvarchar(10)
)
insert into @tmp
select
	'0',b.noa,
	case when b.stype = '1' then '內銷' when b.stype = '2' then '代工' else '外銷' end stype,
	b.datea,	b.acomp,b.coin,b.floata,b.contract,b.comp,b.paytype,b.trantype,b.sales,b.tel,b.fax,
	(case when b.kind = 1 then '鋼捲鋼板'
	when b.kind = 2 then '鋼管'
	when b.kind = 3 then '鋼筋'
	when b.kind = 4 then '鋼胚' end) kind,
	b.post + ' - ' + b.addr,b.post2 + ' - ' + b.addr2,b.apv,b.money,b.tax,
	(case when b.taxtype = 1 then '應稅'
	when b.taxtype = 2 then '零稅率'
	when b.taxtype = 3 then '內含'
	when b.taxtype = 4 then '免稅'
	when b.taxtype = 5 then '自訂'
	when b.taxtype = 6 then '作廢' end) taxtype,
	b.total,b.totalus,b.weight,b.tpayweight,b.tunpayweight,b.ttransferorde,b.tuntransferorde,
	case when b.tenda = '0' then '未結案' else '已結案' end tenda,
	b.mpayweight,b.munpayweight,b.mtransferorde,b.muntransferorde,
	case when b.menda = '0' then '未結案' else '已結案' end menda,
	b.memo,a.productno,a.no3,a.product,a.class,
	(
		case when b.kind = 1 /*板*/ then  cast(a.dime as nvarchar) + ' x '  + cast(a.width as nvarchar) + ' x ' + cast(a.lengthb as nvarchar) 
		when b.kind = 2 /*管*/ then  cast(a.radius as nvarchar) + ' x '  + cast(a.width as nvarchar) + ' x ' + cast(a.dime as nvarchar) + ' x ' + cast(a.lengthb as nvarchar) 
		else /*鋼筋和鋼胚*/ cast(a.lengthb as nvarchar) end
	) size,
	a.spec,a.unit,a.mount,a.weight,a.price,a.total,a.theory,
	a.memo,a.ordeno +'-'+a.no2,
	case when a.enda = '0' then '未結案' else '已結案' end enda
from quats[1] a
left join quat[1] b on a.noa = b.noa
where b.datea between @t_bdate and @t_edate and (len(@t_noa) = 0 or b.noa = @t_noa)
insert into @tmp(gno,a_noa)
	select '1',a_noa from @tmp group by a_noa
select * from @tmp;