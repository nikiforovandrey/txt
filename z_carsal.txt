z_carsal1:--z_carsal1	
	declare @t_accy nvarchar(20)
	declare @t_mon nvarchar(10)
	declare @t_bdriverno nvarchar(20)
	declare @t_edriverno nvarchar(20)
	
	set @t_accy = '[1]'
	set @t_mon = case when '#non'=[2] then '' else [2] end
	set @t_bdriverno = case when '#non'=[3] then '' else [3] end
	set @t_edriverno = case when '#non'=[4] then char(255) else [4] end
	------------------------------------------------------------------------------------------------------------------
	declare @tmp table(
		gno nvarchar(3),
		mon nvarchar(10),
		driverno nvarchar(20),
		driver nvarchar(20),
		[day] int,
		tranmoney float,
		drivermoney float,
		bonus float,
		plus float,
		[money] float,
		ticket float,
		labor float,
		health float,
		minus float,
		carborr float,
		total float,
		memo nvarchar(40)
	)

	insert into @tmp
	select '0',noa,driverno,driver,[day],tranmoney,drivermoney,bonus,plus,[money],ticket,labor,health,minus,carborr,total,memo from carsals
	insert into @tmp
	select '1',noa,'','',0,tranmoney,drivermoney,bonus,plus,[money],ticket,labor,health,minus,carborr,total,memo from carsal

	select gno,mon,driverno,driver,[day],
	reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,tranmoney),1)),4,12)) aa,
	reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,drivermoney),1)),4,12)) bb,
	reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,bonus),1)),4,12)) cc,
	reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,plus),1)),4,12)) dd,
	reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,[money]),1)),4,12)) ee, 
	reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,ticket),1)),4,12)) ff, 
	reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(labor,0)+isnull(health,0)),1)),4,12)) gg,
	reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,minus),1)),4,12)) hh,
	reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,carborr),1)),4,12)) ii,
	reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total),1)),4,12)) jj,
	memo
	from @tmp order by gno,driverno;

z_carsal2:--z_carsal2
	SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	declare @t_accy nvarchar(20)
	declare @t_mon nvarchar(10)
	declare @t_bdriverno nvarchar(20)
	declare @t_edriverno nvarchar(20)
	
	set @t_accy = '[1]'
	set @t_mon = case when '#non'=[2] then '' else [2] end
	set @t_bdriverno = case when '#non'=[3] then '' else [3] end
	set @t_edriverno = case when '#non'=[4] then char(255) else [4] end

	declare @tmp table(
		gno nvarchar(2),
		title nvarchar(20),
		mon nvarchar(10),
		driverno nvarchar(20),
		driver nvarchar(20),
		[day] int,
		drivermoney float,
		bonus float,
		plus float,
		[money] float,
		ticket float,
		labor float,
		health float,
		minus float,
		carborr float,
		total float,
		tranmoney float
	)
	set @cmd = 
		" select '0',LEFT(@t_mon,3)+'年'+RIGHT(@t_mon,2)+'月【明細單】',noa,driverno,driver,[day],"+
		" drivermoney,bonus,plus,[money],ticket,labor,health,minus,carborr,total,tranmoney"+
		" from carsals"+
		" where noa=@t_mon and (driverno between @t_bdriverno and @t_edriverno)"
	insert into @tmp
	execute sp_executesql @cmd,N'@t_mon nvarchar(10),@t_bdriverno nvarchar(20),@t_edriverno nvarchar(20)',
		@t_mon=@t_mon,@t_bdriverno=@t_bdriverno,@t_edriverno=@t_edriverno
	--insert into @tmp
	--select '1','','',driverno,'',0,0,0,0,0,0,0,0,0,0,0,0 from @tmp group by driverno
	select gno,title,mon,driverno,driver namea,[DAY],
		reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(drivermoney,0)),1)),4,12)) a1,
		reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(bonus,0)),1)),4,12)) a2,
		reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(plus,0)),1)),4,12)) a3,
		reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(drivermoney,0)+isnull(bonus,0)+isnull(plus,0)),1)),4,12)) a0,
		reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(ticket,0)),1)),4,12)) b1,
		reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,ISNULL(labor,0)+isnull(health,0)),1)),4,12)) b2,
		reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(minus,0)),1)),4,12)) b3,
		reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,ISNULL(ticket,0)+ISNULL(labor,0)+isnull(health,0)+ISNULL(minus,0)),1)),4,12)) b0,
		reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(drivermoney,0)+isnull(bonus,0)+isnull(plus,0)-(ISNULL(ticket,0)+ISNULL(labor,0)+isnull(health,0)+ISNULL(minus,0))),1)),4,12)) c1,
		reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(carborr,0)),1)),4,12)) c2,
		reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(drivermoney,0)+isnull(bonus,0)+isnull(plus,0)-(ISNULL(ticket,0)+ISNULL(labor,0)+isnull(health,0)+ISNULL(minus,0)+ISNULL(carborr,0))),1)),4,12)) c0,
		reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,isnull(tranmoney,0)),1)),4,12)) d0
	from @tmp order by driverno,gno;

z_carsal3:--z_carsal3	
	SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	declare @t_accy nvarchar(20)
	declare @t_mon nvarchar(10)
	declare @t_bdriverno nvarchar(20)
	declare @t_edriverno nvarchar(20)
	
	set @t_accy = '[1]'
	set @t_mon = case when '#non'=[2] then '' else [2] end
	set @t_bdriverno = case when '#non'=[3] then '' else [3] end
	set @t_edriverno = case when '#non'=[4] then char(255) else [4] end
	------------------------------------------------------------------------------------------------------------------
	declare @tmp table(
		gno nvarchar(3),
		mon nvarchar(10),
		driverno nvarchar(20),
		driver nvarchar(20),
		custno nvarchar(20),
		noa  nvarchar(20),
		datea  nvarchar(10),
		trandate  nvarchar(10),
		addr  nvarchar(20),
		product  nvarchar(20),
		mount2 float,
		price2 float,
		[money] float,
		total2 float,
		memo nvarchar(40)
	)
	
	set @cmd =
		" select '0',@t_mon,a.driverno,c.namea,a.custno,a.noa,a.datea,a.trandate,a.straddr,a.product,"+
		" isnull(a.mount2,0),isnull(a.price2,0),round(isnull(a.mount2,0)*isnull(a.price2,0),0),isnull(a.total2,0),''"+ 
		" from trans"+@t_accy+" a"+
		" left join calctypes b on a.calctype=b.noa+b.noq"+
		" left join driver c on a.driverno=c.noa"+ 
		" where LEFT(a.datea,6)=@t_mon and (a.driverno between @t_bdriverno and @t_edriverno) and b.isoutside=0"

	insert into @tmp
	execute sp_executesql @cmd,N'@t_mon nvarchar(10),@t_bdriverno nvarchar(20),@t_edriverno nvarchar(20)',
		@t_mon=@t_mon,@t_bdriverno=@t_bdriverno,@t_edriverno=@t_edriverno
	
	insert into @tmp
	select '1',@t_mon,driverno,driver,'','','','','','',SUM(mount2),0,SUM([money]),SUM(total2),''
	from @tmp where gno='0' group by mon,driverno,driver 
	
	select gno,mon,driverno,driver,custno,noa,datea,trandate,addr,product,
		reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,mount2),1)),4,12)) mount2,
		reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,price2),1)),4,12)) price2,
		reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,[money]),1)),4,12)) [money],
		reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total2),1)),4,12)) total2,
		memo
	from @tmp order by driverno,gno,trandate,noa;