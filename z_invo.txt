z_invo1:--z_invo1
declare @t_binvo nvarchar(50)
declare @t_einvo nvarchar(50)
declare @t_bdate nvarchar(30)
declare @t_edate nvarchar(30)
declare @t_bcustno nvarchar(50)
declare @t_ecustno nvarchar(50)
declare @t_commodity nvarchar(50)
declare @t_onlyunpay nvarchar(50)

set @t_binvo = case when '#non'=[2] then '' else [2] end
set @t_einvo = case when '#non'=[3] then char(255) else [3] end
set @t_bdate = case when '#non'=[4] then '' else [4] end
set @t_edate = case when '#non'=[5] then char(255) else [5] end
set @t_bcustno = case when '#non'=[6] then '' else [6] end
set @t_ecustno = case when '#non'=[7] then char(255) else [7] end
set @t_commodity = case when '#non'=[8] then '' else [8] end
set @t_onlyunpay = case when '#non'=[10] then '0' else [10] end

declare @tmp table(
	gno nvarchar(1),
	noa nvarchar(90),
	datea nvarchar(10),
	endate nvarchar(30),
	custno nvarchar(90),
	comp nvarchar(90),
	commodity nvarchar(90),
	pno nvarchar(90),
	contract nvarchar(90),
	froma nvarchar(90),
	toa nvarchar(90),
	shipped nvarchar(90),
	etd nvarchar(90),
	eta nvarchar(90),
	lcno nvarchar(90),
	total float,
	unpay float
)

insert into @tmp
select '0',a.noa,a.datea,cast(convert(int,LEFT(a.datea,3)+1911) as nvarchar(50))+'/'+SUBSTRING(a.datea,5,2)+'/'+RIGHT(a.datea,2)
,a.custno,a.comp,a.commodity,a.pno,a.contract,a.froma,a.toa,a.shipped,a.etd,a.eta,a.lcno,a.amount
,case when (select unpay from view_vcc where invo=a.noa) is null then a.amount else (select unpay from view_vcc where invo=a.noa) end
from invo a 
where (a.noa between @t_binvo and @t_einvo) and (a.datea between @t_bdate and @t_edate)
and (a.custno between @t_bcustno and @t_ecustno) and  (len(@t_commodity)=0 or charindex(@t_commodity,a.commodity)>0)

if @t_onlyunpay='1'
	delete @tmp where unpay=0

insert into @tmp(gno,noa,total,unpay)
select '1',char(255),sum(total),sum(unpay) from @tmp 

select dbo.getcomma(total,3) total
,dbo.getcomma(unpay,3) unpay
,* 
from @tmp order by gno,datea,noa;
------------------------------------------------------------------------------------------------------------------------------------------------------