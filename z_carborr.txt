z_carborr:--z_carborr
declare @t_accy nvarchar(10)
declare @t_bmon nvarchar(10)
declare @t_emon nvarchar(10)
set @t_accy = '[1]'
set @t_bmon = case when '#non' = [2] then '' else [2] end
set @t_emon = case when '#non' = [3] then CHAR(255) else [3] end
declare @cmp table(
		total2 int,
		minusmoney int,
		plusmoney int,
		performance int,
		driverno nvarchar(20)
)
insert into @cmp
select sum(a.total2),sum(b.minusmoney),sum(b.plusmoney),sum(a.total2+b.plusmoney-b.minusmoney),a.driverno
from trans[1] a 
left join carchg b on a.driverno=b.driverno
where left(a.datea,6) between @t_bmon and @t_emon and
left(b.datea,6) between @t_bmon and @t_emon
group by a.driverno

declare @tmp table(
		gno nvarchar(1),
		driverno nvarchar(20),
		driver nvarchar(50),
		mon nvarchar(10),
		performce int,
		borr int,
		m1 int,
		m2 int,
		total int,
		memo nvarchar(200)
)
insert into @tmp
select '0' gno,a.driverno,max(a.driver),max(left(a.datea,6)),max(b.performance),max(a.money2),max(case when RIGHT(a.datea,2)=15 then money else 0 end),
max(case when RIGHT(a.datea,2)=20 then money else 0 end),max(case when RIGHT(a.datea,2)=15 then money else 0 end)+max(case when RIGHT(a.datea,2)=20 then money else 0 end),
max(a.memo)
from carborr a 
left join @cmp b on a.driverno = b.driverno
where (left(a.datea,6) between @t_bmon and @t_emon)
group by a.driverno

insert into @tmp
select '1' gno,'','',mon,sum(performce),0,SUM(m1),SUM(m2),SUM(total),''
from @tmp
group by mon

select gno,driverno,driver,right(mon,2) m,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,performce),1)),4,12)) performce,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,borr),1)),4,12)) borr,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,m1),1)),4,12)) m1,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,m2),1)),4,12)) m2,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total),1)),4,12)) total,memo
from @tmp;


