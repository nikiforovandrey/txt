post:--workk
--轉出調撥和領料單
SET QUOTED_IDENTIFIER OFF
declare @noa nvarchar(20)=[2]--單據編號[2]
declare @year nvarchar(20)=[1]--年度[1]
declare @condition nvarchar(20)=[3]--動作 0 刪除, 1 新增[3]
-----------------------------------------------------------------------
declare @cmd nvarchar(max)
declare @accy nvarchar(20) --非workk的單號年度
--調撥單號
declare @cngno nvarchar(50) = isnull((select cngno from view_workk where noa=@noa),'')
--領料單號
declare @workano nvarchar(50) = isnull((select workano from view_workk where noa=@noa),'')
--撥料日期
declare @datea nvarchar(20)

if(@condition='0')
begin
	if(len(@cngno)>0)
	begin
		set @accy=(select accy from view_cng where noa=@cngno)
		--刪除產生的cng
		set @cmd="delete cng"+@accy+" where noa='"+@cngno+"'"
		EXECUTE sp_executesql @cmd
		set @cmd="delete cngs"+@accy+" where noa='"+@cngno+"'"
		EXECUTE sp_executesql @cmd
	end
	
	if(len(@workano)>0)
	begin
		set @accy=(select accy from view_worka where noa=@workano)
		--刪除產生的worka
		set @cmd="delete worka"+@accy+" where noa='"+@workano+"'"
		EXECUTE sp_executesql @cmd
		set @cmd="delete workas"+@accy+" where noa='"+@workano+"'"
		EXECUTE sp_executesql @cmd
	end
end

if(@condition='1')
begin
	--取得撥料日期
	set @datea=(select datea from view_workk where noa=@noa)
	
	--判斷是否已有調撥單號
	if(len(@cngno)=0)
	begin
		--產生調撥單號
		--取得當天最後一個調撥單號
		select @cngno=MAX(noa) from view_cng where noa like 'X'+REPLACE(@datea,'/','')+'%'
		--新的調撥單號(後面號碼+1)
		set @cngno='X'+REPLACE(@datea,'/','')+right('000'+cast(cast(RIGHT(isnull(@cngno,'000'),3) as int)+1 as nvarchar(10)),3)
	end
	
	--產生調撥單
	set @cmd="insert cng"+@year+" (noa,datea,typea,storeno,store,storeinno,storein,memo,sssno,namea,worker,workkno)
	select '"+@cngno+"' noa,'"+@datea+"' datea,'1' typea,storeno,store,storeinno,storein,'由撥料作業("+@noa+")轉來 chr(10)'+memo
	,(select noa from sss where namea=(case when worker2 !='' then worker2 else worker end))
	,(case when worker2 !='' then worker2 else worker end),(case when worker2 !='' then worker2 else worker end),'"+@noa+"'
	from view_workk where noa='"+@noa+"'"
	EXECUTE sp_executesql @cmd
	
	set @cmd="insert cngs"+@year+" (noa,noq,productno,product,unit,mount,memo)
	select '"+@cngno+"' noa,noq,productno,product,unit,mount,memo from view_workks where noa='"+@noa+"'"
	EXECUTE sp_executesql @cmd
	
	--判斷是否已有領料單號
	if(len(@workano)=0)
	begin
		--產生領料單號
		--取得當天最後一個領料單號
		select @workano=MAX(noa) from view_cng where noa like 'WA'+REPLACE(@datea,'/','')+'%'
		--新的領料單號(後面號碼+1)
		set @workano='WA'+REPLACE(@datea,'/','')+right('000'+cast(cast(RIGHT(isnull(@workano,'000'),3) as int)+1 as nvarchar(10)),3)
	end

	--產生領料單
	set @cmd="insert worka"+@year+" (noa,datea,typea,storeno,store,stationno,station,bdate,edate,memo,worker,workkno)
	select '"+@workano+"' noa,'"+@datea+"' datea,'1' typea,storeinno,storein,stationno,station
	,bdate,edate,'由撥料作業("+@noa+")轉來 '+memo,(case when worker2 !='' then worker2 else worker end),'"+@noa+"'
	from view_workk where noa='"+@noa+"'"
	EXECUTE sp_executesql @cmd
	
	set @cmd="insert workas"+@year+" (noa,noq,productno,product,unit,mount,storeno,store,memo,workno)
	select '"+@workano+"' noa,a.noq,a.productno,a.product,a.unit,a.mount,b.storeinno,b.storein,a.memo,a.workno 
	from view_workks a left join view_workk b on a.noa=b.noa where a.noa='"+@noa+"'"
	EXECUTE sp_executesql @cmd
	
	--更新workk的cngno,workano
	set @accy=(select accy from view_workk where noa=@noa)
	set @cmd="update workk"+@accy+" set cngno='"+@cngno+"',workano='"+@workano+"' where noa='"+@noa+"'"
	EXECUTE sp_executesql @cmd
	
	if(LEN(@cngno)=0)
	begin
		--資料寫入dno 避免下次自動產生出現問題
		insert dno(tablea,noa,usera)
		select 'cng',@cngno,'z001'
	end
	if(LEN(@workano)=0)
	begin
		--資料寫入dno 避免下次自動產生出現問題
		insert dno(tablea,noa,usera)
		select 'worka',@workano,'z001'
	end

end;