z_accz1:--z_accz1
declare @t_edate nvarchar(20)
set @t_edate = case when '#non'=[4] then '' else [4] end
declare @tmp table(
	gno nvarchar(1),
	orderby int,
	noa nvarchar(20),
	namea nvarchar(50),
	mount float,
	unit nvarchar(4),
	indate nvarchar(10),
	partno nvarchar(30),
	parts nvarchar(50),
	getmoney float,
	fixmoney float,
	scrapvalue float,
	base float,
	byear nvarchar(50),
	deplc float,
	accumulat float,
	notdepltotal float,
	memo nvarchar(max)
)
insert into @tmp
	select '0',1,acc1,namea,mount,unit,indate,partno,part,money,fixmoney,
	scrapvalue,0,year,isnull(b.depl,0),isnull(c.depl,0)+accumulat,0,memo
	from accz[1]_1 a
	left join acczt[1]_1 b on a.acc1 = b.noa and mon = left(@t_edate,6)
	left join (
		select noa,sum(depl) depl from acczt[1]_1
		where mon < left(@t_edate,6)
		group by noa
	) c on a.acc1 = b.noa
update @tmp set base = (getmoney+fixmoney)-scrapvalue
update @tmp set accumulat = deplc + accumulat
update @tmp set notdepltotal = (getmoney+fixmoney)-accumulat
---------列出主科目名稱
insert into @tmp(gno,orderby,noa,namea)
	select '0',0,b.acc1,b.acc2 from @tmp a
	left join acc[1]_1 b on left(a.noa,4) = left(b.acc1,4)
	group by b.acc1,b.acc2
---------列出科目小計
insert into @tmp
	select '1',2,left(noa,4),'',null,'','','','',sum(getmoney),sum(fixmoney),sum(scrapvalue),
	sum(base),'',sum(deplc),sum(accumulat),sum(notdepltotal),'' 
	from @tmp
	group by left(noa,4)
---------列出總計
insert into @tmp
	select '2',3,char(255),'',null,'','','','',sum(getmoney),sum(fixmoney),sum(scrapvalue),
	sum(base),'',sum(deplc),sum(accumulat),sum(notdepltotal),'' 
	from @tmp
	where gno=1
select
	gno,orderby,noa,namea,
	reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,mount),1)),4,12)) mount,
	unit,indate,parts,
	reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,getmoney),1)),4,12)) getmoney,
	reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,fixmoney),1)),4,12)) fixmoney,
	reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,scrapvalue),1)),4,12)) scrapvalue,
	reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,base),1)),4,12)) base,
	reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,byear),1)),4,12)) byear,
	reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,deplc),1)),4,12)) deplc,
	reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,accumulat),1)),4,12)) accumulat,
	reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,notdepltotal),1)),4,12)) notdepltotal,
	memo
from @tmp order by left(noa,4),orderby,gno;