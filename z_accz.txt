z_accz1:--z_accz1
declare @t_edate nvarchar(20)
declare @t_single nvarchar(20)
set @t_edate = case when '#non'=[4] then '' else [4] end
set @t_single = case when '#non'=[5] then '' else [5] end
declare @tmp table(
	gno nvarchar(1),
	idno int identity(0,1),
	noa nvarchar(20),
	namea nvarchar(50),
	mount float,
	unit nvarchar(4),
	indate nvarchar(10),
	money float,
	fixmoney float,
	endvalue float,
	base float,
	byear nvarchar(50),
	deplc float,
	year_depl float,
	notdepltotal float,
	memo nvarchar(max),
	isdepl nvarchar(1),
	scrapvalue nvarchar(30),
	accumulat float
)
insert into @tmp
	select
		'0',noa,namea,mount,UNIT,indate,money,fixmoney,
		endvalue,'',year,'',year_depl,(money+fixmoney)-year_depl as notdepltotal,
		memo,isdepl,scrapvalue,accumulat
	from accz102_1
declare @isdepl nvarchar(1)
declare @money float
declare @fixmoney float
declare @scrapvalue nvarchar(30)
declare @byear nvarchar(50)
declare @base float
declare @accumulat float
declare @mon nvarchar(10)
declare @depl float
declare @c float
declare @t2 float
declare @t3 float
declare @noa nvarchar(20)
declare cursor_table cursor for
	select noa,isdepl,money,fixmoney,scrapvalue,byear,accumulat from @tmp
open cursor_table
fetch next from cursor_table
into @noa,@isdepl,@money,@fixmoney,@scrapvalue,@byear,@accumulat
while(@@FETCH_STATUS <> -1)
begin
	------base
--case when isdepl = 1 then 0 
--			else ((money+fixmoney)-(case when scrapvalue= 'N' then 0 else (case when scrapvalue= 'N' or isdepl = 1 then 0 else ROUND((money+fixmoney)/(year+1),0) end) end))
--		end
	set @base = 0
	if(@isdepl = 1)
	begin
		set @base = 0
	end
	else
	begin
		set @base = (@money + @fixmoney)
		if(@scrapvalue = 'N')
		begin
			set @base = @base - 0
		end
		else
		begin
			set @t2 = 0
			set @t3 = 0
			declare cursor_table2 cursor for
				select depl,mon from acczt where (noa = @noa) and (@isdepl = 0)
			open cursor_table2
			fetch next from cursor_table2
			into @depl,@mon
			while(@@FETCH_STATUS <> -1)
			begin
				if((LEFT(@mon,6) <= LEFT(@t_edate,6) and @t_single != '單月') or (@mon=LEFT(@t_edate,6) and @t_single = '單月'))
				begin
					set @t2 += @depl
				end
				if(LEFT(@mon,6) <= LEFT(@t_edate,6))
				begin
					set @t3 += @depl
				end
				fetch next from cursor_table2
				into @depl,@mon
			end
			close cursor_table2
			deallocate cursor_table2
			set @c = ROUND((@money+@fixmoney)/(@byear+1),0)
			if(@c > ((@money+@fixmoney)-(@accumulat-@t2-@t3)))
			begin
				set @c = ((@money+@fixmoney)-(@accumulat-@t2-@t3))
			end
			set @base = @base - @c
			update @tmp set base = @base,deplc = (case when @isdepl = 0 then @depl else '' end)
			where current of cursor_table
			
		end
	end
	
	fetch next from cursor_table
	into @noa,@isdepl,@money,@fixmoney,@scrapvalue,@byear,@accumulat
end
close cursor_table
deallocate cursor_table
select * from @tmp;