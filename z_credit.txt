z_credit02:--z_credit02
	SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	declare @t_accy nvarchar(10)
	declare @t_bcustno nvarchar(20)
	declare @t_ecustno nvarchar(20)
	declare @t_bgroupno nvarchar(20)
	declare @t_egroupno	nvarchar(20)
	
	set @t_accy = '[1]'
	set @t_bcustno = case when '#non'=[2] then '' else [2] end
	set @t_ecustno = case when '#non'=[3] then CHAR(255) else [3] end
	set @t_bgroupno = case when '#non'=[4] then '' else [4] end
	set @t_egroupno = case when '#non'=[5] then CHAR(255) else [5] end
	----------------------------------------------------------------------------------
	declare @listorde table(
		tablea nvarchar(20),
		tableas nvarchar(20),
		accy nvarchar(20)
	)
	insert into @listorde(tablea,tableas,accy)
	SELECT TABLE_NAME 
	,replace(TABLE_NAME,'orde','ordes')
	,replace(TABLE_NAME,'orde','')
	FROM INFORMATION_SCHEMA.TABLES 
	where TABLE_NAME like 'orde[0-9][0-9][0-9]'
	
	declare @listvcc table(
		tablea nvarchar(20),
		tableas nvarchar(20),
		accy nvarchar(20)
	)
	insert into @listvcc(tablea,tableas,accy)
	SELECT TABLE_NAME 
	,replace(TABLE_NAME,'vcc','vccs')
	,replace(TABLE_NAME,'vcc','')
	FROM INFORMATION_SCHEMA.TABLES 
	where TABLE_NAME like 'vcc[0-9][0-9][0-9]' 

	----------------------------------------------------------------------------------
	IF OBJECT_ID('tempdb..#z_credit02')is not null
	BEGIN
		set @cmd = 'drop table #z_credit02'
		EXECUTE sp_executesql @cmd
	END
	create table #z_credit02(
		gno nvarchar(10),
		tno nvarchar(20),
		team nvarchar(max),
		custno nvarchar(20),
		cust nvarchar(max),
		nick nvarchar(max),
		credit float,--可用額度
		ordeMoney float,--訂單金額(只算未結案)
		vccMoney float,--應收帳款
		ummMoney float,--預付
		gqbMoney float, --未兌現票據
		total float
	)
	declare @tablea nvarchar(20)
	declare @tableas nvarchar(20)
	declare @accy nvarchar(10)
	
	------ORDE 只算未結案的
	declare cursor_table cursor for
	select tablea,tableas,accy from @listorde
	open cursor_table
	fetch next from cursor_table
	into @tablea,@tableas,@accy
	while(@@FETCH_STATUS <> -1)
	begin
		set @cmd =""
		+" select isnull(b.custno,'')from "+@tableas+" a"
		+" left join "+@tablea+" b on a.noa=b.noa"
		+" left join #z_credit02 c on isnull(b.custno,'')=c.custno"
		+" where c.custno is null and isnull(a.enda,0)=0 and isnull(b.enda,0)=0"
		+" and (isnull(b.custno,'') between @t_bcustno and @t_ecustno)"
		+" group by isnull(b.custno,'')"
		insert into #z_credit02(custno)
		execute sp_executesql @cmd,N'@t_bcustno nvarchar(20),@t_ecustno nvarchar(20)',@t_bcustno=@t_bcustno,@t_ecustno=@t_ecustno
		
		set @cmd =""
		+" update #z_credit02 set ordemoney = isnull(a.ordemoney,0)+isnull(b.total,0)"
		+" from #z_credit02 a"
		+" left join (select isnull(b.custno,'') custno,sum(isnull(a.[total],0)) total from "+@tableas+" a "
		+" 	left join "+@tablea+" b on a.noa=b.noa"
		+" where isnull(a.enda,0)=0 and isnull(b.enda,0)=0"
		+" and (isnull(b.custno,'') between @t_bcustno and @t_ecustno)"
		+" group by ISNULL(b.custno,'')) b on a.custno=b.custno"
		execute sp_executesql @cmd,N'@t_bcustno nvarchar(20),@t_ecustno nvarchar(20)',@t_bcustno=@t_bcustno,@t_ecustno=@t_ecustno
		
		fetch next from cursor_table
		into @tablea,@tableas,@accy
	end
	close cursor_table
	deallocate cursor_table
	------UMM 預付
	insert into #z_credit02(custno)
	select isnull(a.custno,'') from umm a
	left join #z_credit02 b on a.custno=b.custno
	where b.custno is null and (isnull(a.custno,'') between @t_bcustno and @t_ecustno)
	group by isnull(a.custno,'')
	
	update #z_credit02 set ummmoney = isnull(a.ummmoney,0)+isnull(b.total,0)
	from #z_credit02 a
	left join (select isnull(custno,'') custno,SUM(ISNULL(opay,0)-isnull(unopay,0)) total from umm
		where (isnull(custno,'') between @t_bcustno and @t_ecustno)
		group by ISNULL(custno,'')) b on a.custno=b.custno
	------GQB 收票未兌現票據
	insert into #z_credit02(custno)
	select isnull(a.compno,'') from gqb a
	left join #z_credit02 b on a.compno=b.custno
	where b.custno is null and a.typea='1' and (ISNULL(a.enda,'')='' or upper(a.enda)='N')
		and (isnull(a.compno,'') between @t_bcustno and @t_ecustno)
	group by isnull(a.compno,'')
	
	update #z_credit02 set gqbmoney = isnull(a.gqbmoney,0)+isnull(b.total,0)
	from #z_credit02 a
	left join (select isnull(compno,'') custno,SUM(ISNULL([money],0)) total from gqb 
		where typea='1' and (ISNULL(enda,'')='' or upper(enda)='N') and (isnull(compno,'') between @t_bcustno and @t_ecustno)
		group by ISNULL(compno,'')) b on a.custno=b.custno
	------vcc 應收帳款
	declare cursor_table cursor for
	select tablea,tableas,accy from @listvcc
	open cursor_table
	fetch next from cursor_table
	into @tablea,@tableas,@accy
	while(@@FETCH_STATUS <> -1)
	begin
		set @cmd =""
		+" select isnull(b.custno,'')from "+@tableas+" a"
		+" left join "+@tablea+" b on a.noa=b.noa"
		+" left join #z_credit02 c on isnull(b.custno,'')=c.custno"
		+" where c.custno is null"
		+" and (isnull(b.custno,'') between @t_bcustno and @t_ecustno)"
		+" group by isnull(b.custno,'')"
		insert into #z_credit02(custno)
		execute sp_executesql @cmd,N'@t_bcustno nvarchar(20),@t_ecustno nvarchar(20)',@t_bcustno=@t_bcustno,@t_ecustno=@t_ecustno
		
		set @cmd =""
		+" update #z_credit02 set vccmoney = isnull(a.vccmoney,0)+isnull(b.total,0)"
		+" from #z_credit02 a"
		+" left join (select isnull(b.custno,'') custno,sum(isnull(a.[total],0)) total from "+@tableas+" a "
		+" 	left join "+@tablea+" b on a.noa=b.noa where (isnull(b.custno,'') between @t_bcustno and @t_ecustno) group by ISNULL(b.custno,'')) b on a.custno=b.custno"
		execute sp_executesql @cmd,N'@t_bcustno nvarchar(20),@t_ecustno nvarchar(20)',@t_bcustno=@t_bcustno,@t_ecustno=@t_ecustno
		
		fetch next from cursor_table
		into @tablea,@tableas,@accy
	end
	close cursor_table
	deallocate cursor_table
	--扣掉已收
	update #z_credit02 set vccMoney = ISNULL(a.vccmoney,0)- ISNULL(b.total,0)
	from #z_credit02 a
	left join (select isnull(b.custno,'') custno,SUM(ISNULL(a.paysale,0)) total 
		from umms a left join umm b on a.noa=b.noa 
		where (isnull(b.custno,'') between @t_bcustno and @t_ecustno) 
		group by isnull(b.custno,'')) b on a.custno=b.custno
	---------------------------------------
	delete #z_credit02
	from #z_credit02 a
	left join cust b on a.custno=b.noa
	where b.noa is null or not(isnull(b.grpno,'') between @t_bgroupno and @t_egroupno)
	---------------------------------------
	update #z_credit02 set cust=b.comp,nick=b.nick,credit=isnull(b.credit,0),tno=ISNULL(b.grpno,''),team=ISNULL(c.team,'')
	from #z_credit02 a
	left join cust b on a.custno=b.noa
	left join team c on b.grpno=c.noa
	update #z_credit02 set total = ISNULL(credit,0)-ISNULL(ordeMoney,0)-ISNULL(vccmoney,0)-ISNULL(ummMoney,0)-ISNULL(gqbMoney,0)
	update #z_credit02 set gno = case when total>=0 then '1' else '2' end
	insert into #z_credit02(gno,tno,team,custno,credit,ordeMoney,vccMoney,ummMoney,gqbMoney,total)
	select '3',tno,team,CHAR(255),SUM(ISNULL(credit,0)),SUM(ISNULL(ordemoney,0)),SUM(ISNULL(vccmoney,0))
		,SUM(ISNULL(ummmoney,0)),SUM(ISNULL(gqbmoney,0)),SUM(ISNULL(total,0))
	from #z_credit02 group by tno,team
	
	select gno
	,tno
	,team
	,custno
	,cust comp 
	,nick
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,credit),1)),4,12)) credit
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,ordemoney),1)),4,12)) orde
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,vccmoney),1)),4,12)) vcc
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,ummmoney),1)),4,12)) opay
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,gqbmoney),1)),4,12)) gqb
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total),1)),4,12)) total
	from #z_credit02 order by tno,custno
	drop table #z_credit02;

z_credit01:--z_credit01	
	SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	declare @t_accy nvarchar(20)
	declare @t_bcustno nvarchar(20)
	declare @t_ecustno nvarchar(20)
	
	set @t_accy = '[1]'
	set @t_bcustno = case when '#non'=[2] then '' else [2] end
	set @t_ecustno = case when '#non'=[3] then CHAR(255) else [3] end
	----------------------------------------------------------------------------------
	declare @listorde table(
		tablea nvarchar(20),
		tableas nvarchar(20),
		accy nvarchar(20)
	)
	insert into @listorde(tablea,tableas,accy)
	SELECT TABLE_NAME 
	,replace(TABLE_NAME,'orde','ordes')
	,replace(TABLE_NAME,'orde','')
	FROM INFORMATION_SCHEMA.TABLES 
	where TABLE_NAME like 'orde[0-9][0-9][0-9]'
	
	declare @listvcc table(
		tablea nvarchar(20),
		tableas nvarchar(20),
		accy nvarchar(20)
	)
	insert into @listvcc(tablea,tableas,accy)
	SELECT TABLE_NAME 
	,replace(TABLE_NAME,'vcc','vccs')
	,replace(TABLE_NAME,'vcc','')
	FROM INFORMATION_SCHEMA.TABLES 
	where TABLE_NAME like 'vcc[0-9][0-9][0-9]' 

	----------------------------------------------------------------------------------
	IF OBJECT_ID('tempdb..#z_credit01')is not null
	BEGIN
		set @cmd = 'drop table #z_credit01'
		EXECUTE sp_executesql @cmd
	END
	create table #z_credit01(
		gno nvarchar(10),
		custno nvarchar(20),
		cust nvarchar(max),
		nick nvarchar(max),
		credit float,--可用額度
		ordeMoney float,--訂單金額(只算未結案)
		vccMoney float,--應收帳款
		ummMoney float,--預付
		gqbMoney float, --未兌現票據
		total float
	)
	declare @tablea nvarchar(20)
	declare @tableas nvarchar(20)
	declare @accy nvarchar(10)
	
	------ORDE 只算未結案的
	declare cursor_table cursor for
	select tablea,tableas,accy from @listorde
	open cursor_table
	fetch next from cursor_table
	into @tablea,@tableas,@accy
	while(@@FETCH_STATUS <> -1)
	begin
		set @cmd =""
		+" select isnull(b.custno,'')from "+@tableas+" a"
		+" left join "+@tablea+" b on a.noa=b.noa"
		+" left join #z_credit01 c on isnull(b.custno,'')=c.custno"
		+" where c.custno is null and isnull(a.enda,0)=0 and isnull(b.enda,0)=0"
		+" and (isnull(b.custno,'') between @t_bcustno and @t_ecustno)"
		+" group by isnull(b.custno,'')"
		insert into #z_credit01(custno)
		execute sp_executesql @cmd,N'@t_bcustno nvarchar(20),@t_ecustno nvarchar(20)',@t_bcustno=@t_bcustno,@t_ecustno=@t_ecustno
		
		set @cmd =""
		+" update #z_credit01 set ordemoney = isnull(a.ordemoney,0)+isnull(b.total,0)"
		+" from #z_credit01 a"
		+" left join (select isnull(b.custno,'') custno,sum(isnull(a.[total],0)) total from "+@tableas+" a "
		+" 	left join "+@tablea+" b on a.noa=b.noa"
		+" where isnull(a.enda,0)=0 and isnull(b.enda,0)=0"
		+" and (isnull(b.custno,'') between @t_bcustno and @t_ecustno)"
		+" group by ISNULL(b.custno,'')) b on a.custno=b.custno"
		execute sp_executesql @cmd,N'@t_bcustno nvarchar(20),@t_ecustno nvarchar(20)',@t_bcustno=@t_bcustno,@t_ecustno=@t_ecustno
		
		fetch next from cursor_table
		into @tablea,@tableas,@accy
	end
	close cursor_table
	deallocate cursor_table
	------UMM 預付
	insert into #z_credit01(custno)
	select isnull(a.custno,'') from umm a
	left join #z_credit01 b on a.custno=b.custno
	where b.custno is null and (isnull(a.custno,'') between @t_bcustno and @t_ecustno)
	group by isnull(a.custno,'')
	
	update #z_credit01 set ummmoney = isnull(a.ummmoney,0)+isnull(b.total,0)
	from #z_credit01 a
	left join (select isnull(custno,'') custno,SUM(ISNULL(opay,0)-isnull(unopay,0)) total from umm
		where (isnull(custno,'') between @t_bcustno and @t_ecustno)
		group by ISNULL(custno,'')) b on a.custno=b.custno
	------GQB 收票未兌現票據
	insert into #z_credit01(custno)
	select isnull(a.compno,'') from gqb a
	left join #z_credit01 b on a.compno=b.custno
	where b.custno is null and a.typea='1' and (ISNULL(a.enda,'')='' or upper(a.enda)='N')
		and (isnull(a.compno,'') between @t_bcustno and @t_ecustno)
	group by isnull(a.compno,'')
	
	update #z_credit01 set gqbmoney = isnull(a.gqbmoney,0)+isnull(b.total,0)
	from #z_credit01 a
	left join (select isnull(compno,'') custno,SUM(ISNULL([money],0)) total from gqb 
		where typea='1' and (ISNULL(enda,'')='' or upper(enda)='N') and (isnull(compno,'') between @t_bcustno and @t_ecustno)
		group by ISNULL(compno,'')) b on a.custno=b.custno
	------vcc 應收帳款
	declare cursor_table cursor for
	select tablea,tableas,accy from @listvcc
	open cursor_table
	fetch next from cursor_table
	into @tablea,@tableas,@accy
	while(@@FETCH_STATUS <> -1)
	begin
		set @cmd =""
		+" select isnull(b.custno,'')from "+@tableas+" a"
		+" left join "+@tablea+" b on a.noa=b.noa"
		+" left join #z_credit01 c on isnull(b.custno,'')=c.custno"
		+" where c.custno is null"
		+" and (isnull(b.custno,'') between @t_bcustno and @t_ecustno)"
		+" group by isnull(b.custno,'')"
		insert into #z_credit01(custno)
		execute sp_executesql @cmd,N'@t_bcustno nvarchar(20),@t_ecustno nvarchar(20)',@t_bcustno=@t_bcustno,@t_ecustno=@t_ecustno
		
		set @cmd =""
		+" update #z_credit01 set vccmoney = isnull(a.vccmoney,0)+isnull(b.total,0)"
		+" from #z_credit01 a"
		+" left join (select isnull(b.custno,'') custno,sum(isnull(a.[total],0)) total from "+@tableas+" a "
		+" 	left join "+@tablea+" b on a.noa=b.noa where (isnull(b.custno,'') between @t_bcustno and @t_ecustno) group by ISNULL(b.custno,'')) b on a.custno=b.custno"
		execute sp_executesql @cmd,N'@t_bcustno nvarchar(20),@t_ecustno nvarchar(20)',@t_bcustno=@t_bcustno,@t_ecustno=@t_ecustno
		
		fetch next from cursor_table
		into @tablea,@tableas,@accy
	end
	close cursor_table
	deallocate cursor_table
	--扣掉已收
	update #z_credit01 set vccMoney = ISNULL(a.vccmoney,0)- ISNULL(b.total,0)
	from #z_credit01 a
	left join (select isnull(b.custno,'') custno,SUM(ISNULL(a.paysale,0)) total 
		from umms a left join umm b on a.noa=b.noa 
		where (isnull(b.custno,'') between @t_bcustno and @t_ecustno) 
		group by isnull(b.custno,'')) b on a.custno=b.custno
	
	---------------------------------------
	update #z_credit01 set cust=b.comp,nick=b.nick,credit=isnull(b.credit,0)
	from #z_credit01 a
	left join cust b on a.custno=b.noa
	update #z_credit01 set total = ISNULL(credit,0)-ISNULL(ordeMoney,0)-ISNULL(vccmoney,0)-ISNULL(ummMoney,0)-ISNULL(gqbMoney,0)
	update #z_credit01 set gno = case when total>=0 then '1' else '2' end
	insert into #z_credit01(gno,custno,credit,ordeMoney,vccMoney,ummMoney,gqbMoney,total)
	select '3',CHAR(255),SUM(ISNULL(credit,0)),SUM(ISNULL(ordemoney,0)),SUM(ISNULL(vccmoney,0))
		,SUM(ISNULL(ummmoney,0)),SUM(ISNULL(gqbmoney,0)),SUM(ISNULL(total,0))
	from #z_credit01
	
	select gno
	,custno
	,cust comp 
	,nick
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,credit),1)),4,12)) credit
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,ordemoney),1)),4,12)) orde
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,vccmoney),1)),4,12)) vcc
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,ummmoney),1)),4,12)) opay
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,gqbmoney),1)),4,12)) gqb
	,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total),1)),4,12)) total
	from #z_credit01 order by custno
	drop table #z_credit01;