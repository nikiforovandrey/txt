z_carplate1:--z_carplate	
	SET QUOTED_IDENTIFIER OFF
	declare @cmd nvarchar(max)
	
	IF OBJECT_ID('tempdb..#tmp')is not null
	BEGIN
		set @cmd = 'drop table #tmp'
		EXECUTE sp_executesql @cmd
	END
	create table #tmp(
		driverno nvarchar(20),
		n int,
		chk nvarchar(10),
		carno nvarchar(20),
		chk0 nvarchar(10),
		carpno0 nvarchar(20),
		carp0 nvarchar(20),
		cardno0 nvarchar(20),
		size0 nvarchar(20),
		chk1 nvarchar(10),
		carpno1 nvarchar(20),
		carp1 nvarchar(20),
		cardno1 nvarchar(20),
		size1 nvarchar(20)
	)
	declare @n int
	declare @p nvarchar(10)
	declare @q nvarchar(10)
	declare @driverno nvarchar(20)
	declare @carno nvarchar(20)
	declare @carplateno nvarchar(20)
	declare @carplate nvarchar(20)
	declare @cardno nvarchar(20)
	declare @size nvarchar(20)
	-------------------------------------------------------------------------------------------------
	declare @tmp1 table(
		driverno nvarchar(20),
		carno nvarchar(20)
	)
	insert into @tmp1
	select driverno,carno from car2 where len(ISNULL(driverno,''))>0 and cartype='2' order by driverno,carno
	
	declare @tmp2 table(
		driverno nvarchar(20),
		carplateno nvarchar(20),
		carplate nvarchar(20),
		cardno nvarchar(20),
		size nvarchar(20)
	)
	insert into @tmp2
	select driverno,noa,carplate,cardno,size from carplate where len(ISNULL(driverno,''))>0 order by driverno,noa
	
	declare cursor_table cursor for
	select driverno from @tmp1 group by driverno
	open cursor_table
	fetch next from cursor_table
	into @driverno
	while(@@FETCH_STATUS <> -1)
	begin
		set @n=1
		declare cursor_table2 cursor for
		select carno from @tmp1 where driverno=@driverno
		open cursor_table2
		fetch next from cursor_table2
		into @carno
		while(@@FETCH_STATUS <> -1)
		begin
			insert into #tmp(driverno,n,chk,carno)values(@driverno,@n,'□',@carno)
			set @n = @n +1
			fetch next from cursor_table2
			into @carno
		end
		close cursor_table2
		deallocate cursor_table2
		
		fetch next from cursor_table
		into @driverno
	end
	close cursor_table
	deallocate cursor_table

	declare cursor_table cursor for
	select driverno from @tmp2 group by driverno
	open cursor_table
	fetch next from cursor_table
	into @driverno
	while(@@FETCH_STATUS <> -1)
	begin
		set @n = 1
		declare cursor_table2 cursor for
		select carplateno,carplate,cardno,size from @tmp2 where driverno=@driverno
		open cursor_table2
		fetch next from cursor_table2
		into @carplateno,@carplate,@cardno,@size
		while(@@FETCH_STATUS <> -1)
		begin
			set @p = cast(@n/2+1+(case when @n%2=0 then -1 else 0 end) as nvarchar)
			set @q = cast(case when @n%2=0 then '1' else @n%2-1 end as nvarchar)
			
			if exists( select * from #tmp where driverno=@driverno and n=@p)
			begin
				set @cmd = "update #tmp set chk"+@q+"='□',carpno"+@q+"=@carplateno,carp"+@q+"=@carplate,cardno"+@q+"=@cardno,size"+@q+"=@size"
						+" where driverno=@driverno and n=@p"
				execute sp_executesql @cmd,N'@carplateno nvarchar(20),@carplate nvarchar(20),@driverno nvarchar(20),@p int,@cardno nvarchar(20),@size nvarchar(20)'
				,@carplateno=@carplateno,@carplate=@carplate,@driverno=@driverno,@p=@p,@cardno=@cardno,@size=@size
			end
			else
			begin
				set @cmd = "insert into #tmp(driverno,n,chk"+@q+",carpno"+@q+",carp"+@q+",cardno"+@q+",size"+@q+")"
						+"values(@driverno,@p,'□',@carplateno,@carplate,@cardno,@size)"
				execute sp_executesql @cmd,N'@carplateno nvarchar(20),@carplate nvarchar(20),@driverno nvarchar(20),@p int,@cardno nvarchar(20),@size nvarchar(20)'
				,@carplateno=@carplateno,@carplate=@carplate,@driverno=@driverno,@p=@p,@cardno=@cardno,@size=@size
			end
			set @n = @n + 1
			fetch next from cursor_table2
			into @carplateno,@carplate,@cardno,@size
		end
		close cursor_table2
		deallocate cursor_table2
		
		fetch next from cursor_table
		into @driverno
	end
	close cursor_table
	deallocate cursor_table

	select a.*
	,'0' gno
	,a.driverno aa
	,b.namea bb 
	,chk cz
	,chk0 c0
	,carpno0 cc0
	,carp0 dd0
	,cardno0 ee0
	,size0 ff0
	,chk1 c1
	,carpno1 cc1
	,carp1 dd1
	,cardno1 ee1
	,size1 ff1
	from #tmp a
	left join driver b on a.driverno=b.noa
	order by a.driverno,a.n

	drop table #tmp;