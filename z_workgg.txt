z_workgg1:--z_workgg1
declare @t_bdate nvarchar(10)
declare @t_edate nvarchar(10)
declare @t_bstationno nvarchar(10)
declare @t_estationno nvarchar(10)
set @t_bdate = case when '#non' = [1] then '' else [1] end
set @t_edate = case when '#non' = [2] then @t_bdate else [2] end
set @t_bstationno = case when '#non' = [4] then '' else [4] end
set @t_estationno = case when '#non' = [5] then char(255) else [5] end
declare @tmp table(
	gno nvarchar(10),
	stationno nvarchar(50),
	station nvarchar(max),
	datea nvarchar(10),
	gen float,
	mount float
)
insert into @tmp
	select
		'0' gno,a.stationno,b.station,a.datea,isnull(c.gen,isnull(b.gen,0)),sum(a.hours)
	from view_cugu a
	left join station b on (a.stationno=b.noa)
	outer apply(select top 1 gen from view_cugt where (datea=a.datea) and (stationno=a.stationno)) c
	where (a.datea between @t_bdate and @t_edate) and
		  (a.stationno between @t_bstationno and @t_estationno) and
		  (isnull(a.workno,'') != '')
	group by a.stationno,b.station,a.datea,c.gen,b.gen
select
	a.gno,a.stationno,a.station,a.datea,a.gen,a.mount
from @tmp a
order by a.stationno,a.station,a.datea;
--------------------------------------------------------------------------------------*
z_workgg2:--z_workgg2
declare @now_date nvarchar(15)
set @now_date=CONVERT (nvarchar(15), cast(getdate() as datetime),12 )+0890000
set @now_date=left(@now_date,3)+'/'+substring(@now_date,4,2)+'/'+right(@now_date,2)
declare @t_bdate nvarchar(10)
declare @t_edate nvarchar(10)
declare @t_bstationno nvarchar(90)
declare @t_estationno nvarchar(90)
set @t_bdate = case when '#non' = [2] then @now_date else [2] end
set @t_edate = case when '#non' = [3] then @t_bdate else [3] end
set @t_bstationno = case when '#non' = [4] then '' else [4] end
set @t_estationno = case when '#non' = [5] then char(255) else [5] end
declare @t_issaturday int = 1
declare @dateList table(
	idno int identity(1,1),
	datea nvarchar(10)
)
declare @tmp table(
	gno nvarchar(10),
	stationno nvarchar(50),
	station nvarchar(50),
	gen float,
	cuadate nvarchar(10),
	uindate nvarchar(10),
	datea nvarchar(10),
	nos nvarchar(10),
	workno nvarchar(90),
	hours float,
	mount float
)
declare @result table(
	gno nvarchar(10),
	idno int identity(0,1),
	stationno nvarchar(50),
	station nvarchar(50),
	gen float,
	ogen float,
	usegen float,
	datea nvarchar(10),
	cuadate nvarchar(10),
	uindate nvarchar(10),
	workno nvarchar(90),
	hours float,
	mount float
)
insert into @tmp
	select
		'0' gno,a.stationno,b.station,isnull(b.gen,0),a.cuadate,a.uindate,c.datea,c.nos,a.noa,c.hours,c.mount
	from view_cugu c
	left join view_work a on (a.noa=c.workno)
	left join station b on (a.stationno=b.noa)
	where (isnull(a.cuadate,'')!='' and isnull(a.uindate,'')!='' ) and (isnull(b.noa,'') != '') and
		  (a.stationno between @t_bstationno and @t_estationno)
	order by a.stationno,a.cuadate,a.uindate
declare @t_adbdate nvarchar(15) = convert(nvarchar(4),convert(int,LEFT(@t_bdate,3))+1911)+'/'+SUBSTRING(@t_bdate,5,2)+'/'+RIGHT(@t_bdate,2)
declare @t_adedate nvarchar(15) = convert(nvarchar(4),convert(int,LEFT(@t_edate,3))+1911)+'/'+SUBSTRING(@t_edate,5,2)+'/'+RIGHT(@t_edate,2)
declare @CountAdDate nvarchar(15) = @t_adbdate
while(1=1)
begin
	if((isdate(@CountAdDate)=1) and (datepart(weekday,@CountAdDate) != 1))
	begin
		if(@t_issaturday='1' or (@t_issaturday!='1' and ((datepart (DW,@CountAdDate)) !=7)))
		begin
			-------將日期轉為民國年
			set @now_date=CONVERT (nvarchar(15), cast(@CountAdDate as datetime),12 )+0890000
			set @now_date=left(@now_date,3)+'/'+substring(@now_date,4,2)+'/'+right(@now_date,2)
			insert into @dateList(datea) values(@now_date)
		end
	end
	set @CountAdDate = convert(nvarchar,dateadd(day,1,@CountAdDate),111)
	if(@CountAdDate > @t_adedate)
	begin
		break
	end
end
insert into @result(gno,stationno,station,ogen,gen,usegen,datea)
	select
		'0' gno,a.noa,a.station,a.gen,a.gen,a.gen,b.datea
	from station a,@dateList b
	where (a.noa between @t_bstationno and @t_estationno)
	order by a.noa,b.datea
update a
	set a.gen = isnull(d.gen,a.gen)
from @result a
outer apply(select top 1 cugt.gen from view_cug cug left join view_cugt cugt on cug.noa=cugt.noa where (cug.stationno=a.stationno) and (cugt.datea=a.datea)) d
declare @datea nvarchar(10)
declare @workno nvarchar(max)
declare @stationno nvarchar(max)
declare @station nvarchar(max)
declare @gen float
declare @usegen float
declare @cuadate nvarchar(10)
declare @uindate nvarchar(10)
declare @mount float
declare @hours float
declare cursor_table cursor for
	select
		a.stationno,a.station,a.gen,a.cuadate,a.uindate,a.datea,a.workno,a.hours,a.mount
	from @tmp a
	order by a.stationno,a.datea,a.nos
open cursor_table
fetch next from cursor_table
into @stationno,@station,@gen,@cuadate,@uindate,@datea,@workno,@hours,@mount
while(@@FETCH_STATUS <> -1)
begin
	declare @workno2 nvarchar(max) = (select workno from @result where (stationno=@stationno) and (datea=@datea))
	if(@workno2 is null)
	begin
		update a
			set gen=@gen,hours=@hours,cuadate=@cuadate,uindate=@uindate,workno=@workno,mount=@mount
		from @result a
		where (a.stationno=@stationno) and (a.datea=@datea)
	end
	else
	begin
		insert into @result(gno,stationno,station,gen,usegen,hours,datea,cuadate,uindate,workno,mount)
			select '0',@stationno,@station,@gen,@gen,@hours,@datea,@cuadate,@uindate,@workno,@mount
	end
	fetch next from cursor_table
	into @stationno,@station,@gen,@cuadate,@uindate,@datea,@workno,@hours,@mount
end
close cursor_table
deallocate cursor_table
insert into @result(gno,stationno,station,datea,hours)
	select
		'1' gno,stationno,station,'' datea,sum(hours)
	from @result
	group by stationno,station,gen
delete @result where stationno in (select stationno from @result where (isnull(hours,0)=0) and (gno='1'))
declare @idno int
declare @stationno_tmp nvarchar(max) = ''
declare @datea_tmp nvarchar(10) = ''
declare @nowgen float = 0
declare cursor_table cursor for
	select idno,stationno,datea,gen,hours from @result where gno='0' order by stationno,datea,idno
open cursor_table
fetch next from cursor_table
into @idno,@stationno,@datea,@gen,@hours
while(@@FETCH_STATUS <> -1)
begin
	if((@stationno_tmp <> @stationno) or (@datea_tmp <> @datea))
	begin
		set @nowgen = @gen
		set @stationno_tmp = @stationno
		set @datea_tmp = @datea
	end
	set @nowgen = @nowgen-isnull(@hours,0)
	update @result set usegen = @nowgen where idno=@idno
	fetch next from cursor_table
	into @idno,@stationno,@datea,@gen,@hours
end
close cursor_table
deallocate cursor_table
select
	a.gno,a.idno,a.stationno,a.station stations,a.ogen,a.gen gena,
	round(a.usegen,4) usegen,round(a.hours,4) hours,a.datea,a.cuadate,
	a.uindate,a.workno,round(a.mount,4) mount,
	ROW_NUMBER()over(partition by a.stationno order by a.stationno,a.gno,a.datea,a.workno) recno,
	'work?left(noa,'+cast(len(b.noa) as nvarchar)+')=$workno?'+b.accy qhref
from @result a
outer apply(select top 1 accy,noa from view_work where noa=a.workno) b
order by a.stationno,a.gno,a.datea,a.workno;
-------------------------------------------------------------------------------------*
z_workgg3:--z_workgg3
declare @t_bdate nvarchar(20)
declare @t_edate nvarchar(20)
declare @t_bstationno nvarchar(20)
declare @t_estationno nvarchar(20)
declare @t_xgroupano nvarchar(90)
declare @t_showdiff nvarchar(20)
set @t_bdate = case when '#non' = [2] then '' else [2] end
set @t_edate = case when '#non' = [3] then CHAR(255) else [3] end
set @t_bstationno = case when '#non' = [4] then '' else [4] end
set @t_estationno = case when '#non' = [5] then CHAR(255) else [5] end
set @t_xgroupano = case when '#non' = [7] then '' else [7] end
set @t_showdiff = case when '#non' = [6] then '' else [6] end
declare @tmp table(
	gno nvarchar(1),
	stationno nvarchar(90),
	stations nvarchar(90),
	datea nvarchar(10),
	udate nvarchar(10),
	noa nvarchar(30),
	productno nvarchar(30),
	products nvarchar(90),
	mount float,
	unit nvarchar(10),
	hours float,
	diffdate int, ---實際開工日與應完工日的差
	dayhtotal float, ---日小計
	dayhs float, ---標準日工時
	difftime float --負荷差異
)
insert into @tmp
select
	'0',a.stationno,a.station,a.cuadate,a.uindate,a.noa,a.productno,a.product,round(a.mount,3),a.unit,round(isnull(a.hours,0),3),
		DATEDIFF(day,CONVERT(datetime,(cast((left(a.cuadate,3)+1911) as nvarchar)+right(a.cuadate,6))),
				case when a.uindate!='' or a.cuadate>a.uindate  then
					CONVERT(datetime,(cast((left(a.uindate,3)+1911) as nvarchar)+right(a.uindate,6)))
				else
					CONVERT(datetime,(cast((left(a.cuadate,3)+1911) as nvarchar)+right(a.cuadate,6)))
				end
	) diffdate,
	0,isnull(b.gen,0),0
from view_work a
left join station b on a.stationno = b.noa
left join uca c on a.productno=c.noa
where (a.cuadate between @t_bdate and @t_edate) and 
	 (a.stationno between @t_bstationno and @t_estationno) and
	 (a.stationno!='') and
	 (len(@t_xgroupano)=0 or isnull(c.groupano,'')=@t_xgroupano)
order by a.cuadate,a.stationno,a.station
update a
	set a.dayhs = isnull(b.gen,a.dayhs)
from @tmp a
outer apply(select cugt.gen from view_cug cug left join view_cugt cugt on cug.noa=cugt.noa where (a.stationno=cug.stationno) and (cugt.datea=a.datea)) b
update @tmp set dayhtotal = ceiling((hours/diffdate)*100)/100 where diffdate != 0
insert into @tmp(gno,stationno,stations,datea,mount,hours,diffdate,dayhtotal,dayhs,difftime)
	select '1',stationno,stations,datea,sum(mount),sum(hours),sum(diffdate),sum(dayhtotal),max(dayhs),0 from @tmp
	group by stationno,stations,datea
update @tmp set difftime = dayhs-dayhtotal
if(@t_showdiff='1')
begin
	declare @datea nvarchar(10)
	declare @stationno nvarchar(50)
	declare @stations nvarchar(90)
	declare cursor_table cursor for 
		select datea,stationno,stations from @tmp where (difftime not between -5 and 5) and (gno='1')
	open cursor_table 
	fetch next from cursor_table 
	into @datea,@stationno,@stations
	while(@@FETCH_STATUS <> -1) 
	begin
		delete @tmp where (datea=@datea) and (stationno=@stationno) and (stations=@stations)
		fetch next from cursor_table 
		into @datea,@stationno,@stations
	end 
	close cursor_table 
	deallocate cursor_table 
end
select
	a.gno,a.stationno,a.stations,a.datea,a.udate,a.noa,a.productno,a.products,
	a.mount,a.unit,a.hours,a.diffdate,a.dayhtotal,a.dayhs,a.difftime,
	'work?left(noa,'+cast(len(b.noa) as nvarchar)+')=$noa?'+b.accy qhref 
from @tmp a
outer apply(select top 1 accy,noa from view_work where noa=a.noa) b
order by a.datea,a.stationno,a.stations,a.gno;
------------------------------------------------------------------------------------------------------------
z_workgg4:--z_workgg4
declare @t_bdate nvarchar(20) 
declare @t_edate nvarchar(20) 
declare @t_bstationno nvarchar(20) 
declare @t_estationno nvarchar(20) 
declare @t_xgroupano nvarchar(90) 
declare @t_showdiff nvarchar(20)
set @t_bdate = case when '#non' = [2] then '' else [2] end
set @t_edate = case when '#non' = [3] then CHAR(255) else [3] end
set @t_bstationno = case when '#non' = [4] then '' else [4] end
set @t_estationno = case when '#non' = [5] then CHAR(255) else [5] end
set @t_xgroupano = case when '#non' = [7] then '' else [7] end
set @t_showdiff = case when '#non' = [6] then '' else [6] end
declare @tmp table(
	gno nvarchar(1),
	stationno nvarchar(10),
	stations nvarchar(90),
	datea nvarchar(10),
	udate nvarchar(10),
	noa nvarchar(30),
	productno nvarchar(30),
	products nvarchar(90),
	mount float,
	unit nvarchar(10),
	hours float,
	diffdate int, ---實際開工日與應完工日的差
	dayhtotal float, ---日小計
	dayhs float, ---標準日工時
	difftime float --負荷差異
)
insert into @tmp
select
	'0',a.stationno,a.station,a.cuadate,a.uindate,a.noa,a.productno,a.product,round(a.mount,3),a.unit,round(isnull(a.hours,0),3),
		DATEDIFF(day,CONVERT(datetime,(cast((left(a.cuadate,3)+1911) as nvarchar)+right(a.cuadate,6))),
				case when a.uindate!='' or a.cuadate>a.uindate  then
					CONVERT(datetime,(cast((left(a.uindate,3)+1911) as nvarchar)+right(a.uindate,6)))
				else
					CONVERT(datetime,(cast((left(a.cuadate,3)+1911) as nvarchar)+right(a.cuadate,6)))
				end
	) diffdate,
	0,isnull(b.gen,0),0
from view_work a
left join station b on a.stationno = b.noa
left join uca c on a.productno=c.noa
where (a.cuadate between @t_bdate and @t_edate) and 
	 (a.stationno between @t_bstationno and @t_estationno) and
	 (a.stationno!='') and
	 (len(@t_xgroupano)=0 or isnull(c.groupano,'')=@t_xgroupano)
order by a.cuadate,a.stationno,a.station
update a
	set a.dayhs = isnull(b.gen,a.dayhs)
from @tmp a
outer apply(select cugt.gen from view_cug cug left join view_cugt cugt on cug.noa=cugt.noa where (a.stationno=cug.stationno) and (cugt.datea=a.datea)) b
update @tmp set dayhtotal = ceiling((hours/diffdate)*100)/100 where diffdate != 0
insert into @tmp(gno,stationno,stations,datea,mount,hours,diffdate,dayhtotal,dayhs,difftime)
	select '1',char(255),char(255),datea,sum(mount),sum(hours),sum(diffdate),sum(dayhtotal),max(dayhs),0 from @tmp
	group by datea
update @tmp set difftime = dayhs-dayhtotal
select
	a.gno,a.stationno,a.stations,a.datea,a.udate,a.noa,a.productno,a.products,
	a.mount,a.unit,a.hours,a.diffdate,a.dayhtotal,a.dayhs,a.difftime,
	'work?left(noa,'+cast(len(b.noa) as nvarchar)+')=$noa?'+b.accy qhref 
from @tmp a
outer apply(select top 1 accy,noa from view_work where noa=a.noa) b
order by a.datea,a.stationno,a.stations,a.gno;
--------------------------------------------------------------------------------------------------------*
z_workgg5:--z_workgg5
declare @t_bdate nvarchar(10)
declare @t_edate nvarchar(10)
declare @t_bstationno nvarchar(max)
declare @t_estationno nvarchar(max)
declare @t_bproductno nvarchar(max)
declare @t_eproductno nvarchar(max)
set @t_bdate = case when '#non' = [1] then '' else [1] end
set @t_edate = case when '#non' = [2] then char(255) else [2] end
set @t_bstationno = case when '#non' = [4] then '' else [4] end
set @t_estationno = case when '#non' = [5] then char(255) else [5] end
set @t_bproductno = case when '#non' = [7] then '' else [7] end
set @t_eproductno = case when '#non' = [8] then char(255) else [8] end
declare @tmp table(
	gno nvarchar(10),
	datea nvarchar(10),
	productno nvarchar(90),
	product nvarchar(max),
	stationno nvarchar(90),
	station nvarchar(max),
	gen nvarchar(max),
	value float
)
insert into @tmp
	select
		'0' gen,a.datea,c.productno,c.product,a.stationno,b.station,
		case when isnull(d.hours,0)=0 and isnull(d.minutes,0)=0 then null when isnull(d.hours,0)>0 then cast(round(d.hours,3) as nvarchar) + 'Hr.' else cast(round(d.minutes,3) as nvarchar) + 'Min.' end,
		sum(a.mount)
	from view_cugu a
	left join station b on (a.stationno=b.noa)
	left join view_work c on (a.workno=c.noa)
	outer apply(select hours,minutes from uca where noa=c.productno) d
	where (a.datea between @t_bdate and @t_edate) and
			 (c.productno between @t_bproductno and @t_eproductno) and
			 (a.stationno between @t_bstationno and @t_estationno)
	group by c.productno,c.product,a.stationno,b.station,a.datea,d.hours,d.minutes
select
	a.gno,a.datea,a.productno,a.product,a.stationno,a.station,a.gen,a.value
from @tmp a
order by a.productno,a.stationno,a.datea;
-----------------------------------------------------------------------------------------*
z_workgg6:--z_workgg6
declare @t_bdate nvarchar(10)
declare @t_edate nvarchar(10)
declare @t_bproductno nvarchar(max)
declare @t_eproductno nvarchar(max)
declare @now_date nvarchar(15)
set @t_bdate = case when '#non' = [1] then '' else [1] end
set @t_edate = case when '#non' = [2] then char(255) else [2] end
set @t_bproductno = case when '#non' = [7] then '' else [7] end
set @t_eproductno = case when '#non' = [8] then char(255) else [8] end
declare @tmp table(
	gno nvarchar(10),
	datea nvarchar(10),
	productno nvarchar(200),
	product nvarchar(max),
	value float,
	workmount float
)
insert into @tmp
	select
		'0' gno,a.odate,b.productno,b.product,sum(b.mount),isnull(c.mount,0)
	from view_orde a
	left join view_ordes b on (a.noa=b.noa)
	outer apply(
		select
			sum(cugu.mount) mount
		from view_cugu cugu
		left join view_work work on (cugu.workno=work.noa)
		where (work.productno=b.productno) and (cugu.datea=a.odate)
	) c
	where (a.odate between @t_bdate and @t_edate) and
		  (b.productno between @t_bproductno and @t_eproductno)
	group by a.odate,b.productno,b.product,c.mount
	order by a.odate
select
	a.gno,a.datea,a.productno,a.product,a.value,a.workmount
from @tmp a
order by a.datea,a.productno;
-----------------------------------------------------------------------------------------*
z_workgg7:--z_workgg7
declare @t_bdate nvarchar(10)
declare @t_edate nvarchar(10)
declare @t_bproductno nvarchar(max)
declare @t_eproductno nvarchar(max)
declare @now_date nvarchar(15)
set @t_bdate = case when '#non' = [1] then '' else [1] end
set @t_edate = case when '#non' = [2] then char(255) else [2] end
set @t_bproductno = case when '#non' = [7] then '' else [7] end
set @t_eproductno = case when '#non' = [8] then char(255) else [8] end
declare @tmp table(
	gno nvarchar(10),
	datea nvarchar(10),
	productno nvarchar(200),
	product nvarchar(max),
	value float
)
insert into @tmp
	select
		'0' gno,a.datea,b.productno,b.product,sum(a.mount)
	from view_cugu a
	left join view_work b on a.workno=b.noa
	where (a.datea between @t_bdate and @t_edate) and
		  (b.productno between @t_bproductno and @t_eproductno)
	group by a.datea,b.productno,b.product
	order by a.datea
select
	a.gno,a.datea,a.productno,a.product,a.value
from @tmp a
order by a.datea,a.productno;