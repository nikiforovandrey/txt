z_bcc2:--z_bcc2
	declare @t_bdate nvarchar(10)
	declare @t_edate nvarchar(10)
	declare @t_bbccno nvarchar(20)
	declare @t_ebccno nvarchar(20)
	set @t_bdate = case when '#non'=[1] then '' else [1] end
	set @t_edate = case when '#non'=[2] then char(255) else [2] end
	set @t_bbccno = case when '#non'=[3] then '' else [3] end
	set @t_ebccno = case when '#non'=[4] then char(255) else [4] end
	--*****************************************************************************************	
--全部資料
declare @t_result table(
		gno nvarchar(1),
		bccno nvarchar(20),
		bccname nvarchar(50),
		type nvarchar(20),
		noa nvarchar(30),	
		mech nvarchar(20),
		mount decimal (14,2),
		price decimal (18,2),
		stkmount decimal (18,2),
		memo nvarchar (200),
		datea nvarchar(10)	
)
insert into @t_result
select *
from(
select '0' gno, noa bccno,product bccname,'初始' type ,'' noa,'' mech,beginmount mount,price,beginmount stkmount,''memo,datea
from bcc
union
select '1' gno,bccins.bccno,bccins.bccname,'入料' type,bccin.noa,''mech,bccins.mount,bccins.price,null stkmount,bccins.memo,datea
from bccin ,bccins
where bccin.noa=bccins.noa
union
select '1' gno,bccouts.bccno,bccouts.bccname,'領料' type,bccout.noa,mech.mech,bccouts.mount,null price,null stkmount,bccouts.memo,datea
from bccout ,bccouts,mech
where bccout.noa=bccouts.noa and bccouts.mechno=mech.noa 
)T1
order by bccno,datea

declare	@gno nvarchar(1)
declare	@bccno nvarchar(20)
declare	@bccname nvarchar(50)
declare	@type nvarchar(20)
declare	@noa nvarchar(30)	
declare	@mech nvarchar(20)
declare	@mount decimal (14,2)
declare	@price decimal (18,2)
declare	@stkmount decimal (18,2)
declare	@memo nvarchar (200)
declare	@datea nvarchar(20)
declare	@t_bccno nvarchar(20)
declare	@t_bccname nvarchar(50)
declare	@t_gno nvarchar(1)
declare	@total decimal (18,2)
declare	@t_total decimal (18,2)
declare	@t_price decimal (18,2)

set @t_gno='0'
set @total=0
set @t_total=0
set @t_price=0

--更新全部資料
declare bcc_table cursor for
select gno,bccno,bccname,type,noa,mech,mount,price,stkmount,memo from @t_result
open bcc_table
fetch next from bcc_table
into @gno,@bccno,@bccname,@type,@noa,@mech,@mount,@price,@stkmount,@memo
while(@@FETCH_STATUS <> -1)
begin
	if(@gno='0')
	begin
		set @total=@stkmount
		set @t_price=@price
	end
	if(@gno='1')
	begin
		if(@type='入料')
		begin
			set @t_price = @price
		end
		update @t_result 
		set stkmount=@total+( case when @type='領料' then -1* @mount else @mount end),price =@t_price
		where current of bcc_table
		set @total=@total+( case when @type='領料' then -1* @mount else @mount end)
		set @t_total=@total
		
	end
	set @t_gno=@gno
	set @t_bccno=@bccno
	set @t_bccname=@bccname
	
	fetch next from bcc_table
	into @gno,@bccno,@bccname,@type,@noa,@mech,@mount,@price,@stkmount,@memo

end
close bcc_table
deallocate bcc_table


declare @result table(
		gno nvarchar(1),
		bccno nvarchar(20),
		bccname nvarchar(50),
		type nvarchar(20),
		noa nvarchar(30),	
		mech nvarchar(20),
		mount decimal (14,2),
		price decimal (18,2),
		stkmount decimal (18,2),
		memo nvarchar (200),
		datea nvarchar(10)
)
declare @t_datea nvarchar(10)
declare @t_stkmount nvarchar(10)
set @t_bccno='#zzzz#zzzz'

--插入上期存貨到結果表單
declare bcc_table cursor for
select gno,bccno,bccname,type,noa,mech,mount,price,stkmount,memo,datea 
from @t_result where bccno between @t_bbccno and @t_ebccno and datea < @t_bdate order by bccno,gno
open bcc_table
fetch next from bcc_table
into @gno,@bccno,@bccname,@type,@noa,@mech,@mount,@price,@stkmount,@memo,@datea
while(@@FETCH_STATUS <> -1)
begin
	if(@bccno!=@t_bccno and @t_bccno!='#zzzz#zzzz')
	begin
		insert into @result
		select '0' gno,@t_bccno,@t_bccname,'上期存貨','','',null,@t_price,@t_stkmount,'',@t_datea
	end
	
	set @t_bccno=@bccno
	set @t_bccname=@bccname
	set @t_price=@price
	set @t_stkmount=@stkmount
	set @t_datea=@datea

	fetch next from bcc_table
	into @gno,@bccno,@bccname,@type,@noa,@mech,@mount,@price,@stkmount,@memo,@datea

end
	if (@@CURSOR_ROWS=0)
		begin
			insert into @result
			select '0' gno,@bccno,@bccname,'上期存貨','','',null,@t_price,@t_stkmount,'',@t_datea
		end
	else
		begin
			insert into @result
			select '0' gno,@t_bccno,@t_bccname,'上期存貨','','',null,@t_price,@t_stkmount,'',@t_datea
		end
close bcc_table
deallocate bcc_table

set @t_bccno='#zzzz#zzzz'

----之後插入追蹤結果
declare bcc_table cursor for
select gno,bccno,bccname,type,noa,mech,mount,price,stkmount,memo,datea from @result
open bcc_table
fetch next from bcc_table
into @gno,@bccno,@bccname,@type,@noa,@mech,@mount,@price,@stkmount,@memo,@datea
while(@@FETCH_STATUS <> -1)
begin
	if(@bccno!=@t_bccno and @t_bccno!='#zzzz#zzzz' and @t_gno=0)
	begin
		insert into @result
		select '1' gno,bccno,bccname,type,noa,mech,mount,price,stkmount,memo,datea 
		from @t_result
		where bccno =@t_bccno and datea between @t_bdate and @t_edate
	end
	
	if(@t_gno=1 and @t_bccno!=@bccno and @t_bccno!='#zzzz#zzzz')
	begin
		insert into @result
		select '2' gno,@t_bccno,@t_bccname,'','','',null,null,@t_stkmount,null,null 
	end
	set @t_stkmount=@stkmount
	set @t_bccname=@bccname
	set @t_bccno=@bccno
	set @t_gno=@gno
	fetch next from bcc_table
	into @gno,@bccno,@bccname,@type,@noa,@mech,@mount,@price,@stkmount,@memo,@datea

end
close bcc_table
deallocate bcc_table

select *
from @result order by bccno,gno;