z_workbp1:--z_workbp1
declare @t_bdate nvarchar(20)
declare @t_edate nvarchar(20)
declare @t_noa nvarchar(30)
set @t_bdate = case when '#non' = [2] then '' else [2] end
set @t_edate = case when '#non' = [3] then CHAR(255) else [3] end
set @t_noa = case when '#non' = [4] then '' else [4] end
declare @tmp table(
	gno nvarchar(1),
	anoa nvarchar(50),
	adatea nvarchar(10),
	astationno nvarchar(50),
	astations nvarchar(90),
	aworkno nvarchar(30),
	astoreno nvarchar(50),
	astores nvarchar(90),
	amechno nvarchar(50),
	amechs nvarchar(90),
	amemo nvarchar(max),
	bproductno nvarchar(30),
	bproducts nvarchar(50),
	bstoreno nvarchar(50),
	bstores nvarchar(90),
	bunit nvarchar(10),
	wk_mount float,
	wk_inmount float,
	bmount float,
	wk_unmount float,
	wmount float,
	bmemo nvarchar(max),
	bordeno nvarchar(50),
	bworkno nvarchar(90),
	bworkno_img nvarchar(max),
	enda nvarchar(20)
)
insert into @tmp
	select
		'0',a.noa,b.datea,b.stationno,b.station,b.workno,b.storeno,b.store,b.mechno,b.mech,b.memo,
		a.productno,a.product,a.storeno,a.store,a.unit,c.wk_mount,isnull(c.wk_inmount,0)-a.mount,a.mount,c.wk_unmount,
		a.wmount,a.memo,a.ordeno,a.workno,'' img,
		case when isnull(a.enda,'0') = '0' then 'N' else 'Y' end
	from view_workbs a
	left join view_workb b on a.noa = b.noa
	outer apply(select top 1 mount wk_mount,inmount wk_inmount,(mount-inmount) wk_unmount from view_work where noa=a.workno) c
	where (b.datea between @t_bdate and @t_edate) and (len(@t_noa) = 0 or b.noa = @t_noa)
update @tmp set bworkno_img = '<img height="40px" src="http://barcode.tec-it.com/barcode.ashx?code=Code39&modulewidth=fit&data='+upper(bworkno)+'&dpi=96&imagetype=gif&rotation=0&color=&bgcolor=&fontcolor=&quiet=0&qunit=mm&download=true">'
insert into @tmp(gno,anoa)
	select '1',anoa from @tmp group by anoa
select * from @tmp order by anoa,gno;