zxls_cuyra:--zxls_cuyra
	declare @cmd nvarchar(max)
	declare @workerno nvarchar(20)
	declare @worker nvarchar(20)
	set @workerno=[1]
	set @worker=[2]
	
	declare @a nvarchar(max)
	declare @b nvarchar(max)
	declare @c nvarchar(max)
	declare @d nvarchar(max)
	declare @e nvarchar(max)
	declare @f nvarchar(max)
	declare @t_d nvarchar(max)
	declare @t_e nvarchar(max)
	declare @t_f nvarchar(max)
	declare @noa nvarchar(max)
	declare @noq nvarchar(max)
	
	declare cursor_table cursor for
	select a,b,c  from ztmpxls where isnull(a,'')!='' and a!='日期' group by a,b,c
	open cursor_table
	fetch next from cursor_table
	into @a,@b,@c
	while(@@FETCH_STATUS <> -1)
	begin
		select @d=MAX(d),@t_d=replace(MAX(d),char(59),',')
				,@e=MAX(e),@t_e=replace(MAX(e),char(59),',')
				,@f=MAX(f),@t_f=replace(MAX(f) ,char(59),',')
				from ztmpxls where a=@a and b=@b and c=@c 
		if((select count(*) from cuy where bdate=@a and stationno=@b)>0)
		begin
			--當天已有資料
			set @noa=isnull((select MAX(noa) from cuy where bdate=@a and stationno=@b),'')
			if((select count(*) from cuys where noa=@noa and worktime=@c))>0
			begin
				--已存在--更新
				set @noq=isnull((select MAX(noq) from cuys where noa=@noa and worktime=@c),'000')
				update cuys 
				set sales=@d,mans=(select count(*) from dbo.fnSplit(@t_d))
				,supworker=@e,supmans=(select count(*) from dbo.fnSplit(@t_e))
				,manager=@f,managermans=(select count(*) from dbo.fnSplit(@t_f))
				where noa=@noa and noq=@noq
			end
			else
			begin
				--不存在--新增
				set @noq=right('000'+cast(cast(isnull((select MAX(noq) from cuys where noa=@noa),'000') as int )+1 as nvarchar(10)),3)
				insert cuys(noa,noq,datea,stationno,worktime,sales,mans,supworker,supmans,manager,managermans)
				select @noa,@noq,@a,@b,@c,@d,@t_d,@e,@t_e,@f,@t_f
			end
		end
		else
		begin
			--當天沒有資料
			set @noa='CY'+replace(@a,'/','')+
			right('000'+cast(cast(right(isnull((select MAX(noa) from cuy where noa like 'CY'+replace(@a,'/','')+'%' ),'000'),3) as int)+1 as nvarchar(10)),3)
			set @noq='001'
			insert cuy(noa,datea,bdate,edate,stationno,station,stationgno,stationg,worker)
			select @noa,@a,@a,@a,@b,station,stationgno,stationg,@worker from station where noa=@b
			
			insert cuys(noa,noq,datea,stationno,worktime,sales,mans,supworker,supmans,manager,managermans)
			select @noa,@noq,@a,@b,@c,@d,@t_d,@e,@t_e,@f,@t_f
		end
		
		fetch next from cursor_table
		into @a,@b,@c
	end
	close cursor_table
	deallocate cursor_table
	
; 