z_bccin1:--z_bccin1
declare @t_bbccno nvarchar(20)
declare @t_ebccno nvarchar(20)
declare @t_bdate nvarchar(20)
declare @t_edate nvarchar(20)
declare @t_storeno nvarchar(max)
set @t_bdate = case when '#non' = [2] then '' else [2] end
set @t_edate = case when '#non' = [3] then CHAR(255) else [3] end
set @t_bbccno = case when '#non' = [4] then '' else [4] end
set @t_ebccno = case when '#non' = [5] then CHAR(255) else [5] end
set @t_storeno = case when '#non'=[6] then '' else [6] end

declare @tmp  table(
		storeno nvarchar(20),
		gno nvarchar(1),
		noa nvarchar(30),
		noq nvarchar(20),
		datea nvarchar(10),
		bccno nvarchar(20),
		sbccno nvarchar(50),
		bccname nvarchar(50),
		unit nvarchar(10),
		price int,
		mount int,
		total int
)

if(@t_storeno='99')
begin
	insert into @tmp
	select b.storeno,'0' gno,a.noa,b.noq,a.datea,b.bccno,b.bccno,b.bccname,b.unit,b.price,b.mount,b.total
	from bccin a
	left join bccins b on a.noa = b.noa
	where (a.datea between @t_bdate and @t_edate) and
	(b.bccno between @t_bbccno and @t_ebccno)
	order by b.storeno,b.bccno,a.noa
end
else
begin
	insert into @tmp
	select b.storeno,'0' gno,a.noa,b.noq,a.datea,b.bccno,b.bccno,b.bccname,b.unit,b.price,b.mount,b.total
	from bccin a
	left join bccins b on a.noa = b.noa
	where (a.datea between @t_bdate and @t_edate) and
	(b.bccno between @t_bbccno and @t_ebccno) and b.storeno=@t_storeno
	order by b.storeno,b.bccno,a.noa
end


declare @t_bccno nvarchar(20)
declare @t_bccname nvarchar(50)
declare @t_unit nvarchar(20)
declare @bccno nvarchar(20)
declare @sbccno nvarchar(20)
declare @bccname nvarchar(50)
declare @unit nvarchar(20)
declare @datea nvarchar(20)
declare @noa nvarchar(20)
set @t_bccno = 'wderfff'
set @t_bccname = 'erwereee'
set @t_unit = 'ererere'

declare cursor_table cursor for
select datea,noa,sbccno,bccno,bccname
from @tmp 
open cursor_table 
fetch next from cursor_table
into @datea,@noa,@sbccno,@bccno,@bccname
while(@@FETCH_STATUS <> -1)
begin
	if (@bccno = @t_bccno)  and(@t_bccno != 'wderfff') 
	begin
		update @tmp set bccno = '' , bccname = '',unit = '' where current of cursor_table
	end
	else
	begin
		set @t_bccno = @bccno
		set @t_bccname = @bccname
	end
fetch next from cursor_table
into @datea,@noa,@sbccno,@bccno,@bccname
end
close cursor_table
deallocate cursor_table

insert into @tmp
select storeno,'1' gno,'','','','',sbccno,'','',0,0,SUM(total)
from @tmp
group by storeno,sbccno

select b.store,a.gno,a.noa,a.noq,a.datea,a.bccno,a.sbccno,a.bccname,a.unit,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.price),1)),4,12)) price,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.mount),1)),4,12)) mount,
reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,a.total),1)),4,12)) total
from @tmp a left join store b on a.storeno=b.noa 
order by a.storeno,a.sbccno,a.gno;
-----------------------------------------------------------------------------------------------------------------
z_bccin2:--z_bccin2
declare @pagecount int
declare @t_xnoa nvarchar(20)
set @pageCount = 7
set @t_xnoa = case when '#non' = [1] then '' else [1] end
declare @tmpa table (
		gno nvarchar(1),
		noa nvarchar(30),
		noq nvarchar(20),
		mon nvarchar(10),
		tggno nvarchar(20),
		comp nvarchar(50),
		tel nvarchar(50),
		fax nvarchar(20),
		addr nvarchar(50),
		datea nvarchar(10),
		ordeno nvarchar(20),
		bccname nvarchar(90),
		weightb float,
		mount int,
		unit nvarchar(20),
		price float,
		total int,
		paytype nvarchar(20),
		tmemo nvarchar(200),
		memo nvarchar(200),
		tmount int,
		ttotal int,
		mttotal int,
		tax int,
		tmoney int,
		w nvarchar(20),
		store nvarchar(20),
		part nvarchar(20),
		invono nvarchar(20),
		buyer nvarchar(20)
)
insert into @tmpa
select '0' gno,a.noa,b.noq,a.mon,a.tggno,a.tgg,c.tel,c.fax,c.addr_invo,a.datea,'' /*a.ordeno*/,
b.bccname,'' /*b.weight*/,b.mount,b.unit,b.price,b.total,c.paytype,a.memo,b.memo,0,a.total,a.total,a.tax,a.total+a.tax,a.worker
,d.store,a.part,a.invono,a.buyer
from bccin a
left join bccins b on a.noa = b.noa
left join tgg c on a.tggno = c.noa
left join store d on a.storeno=d.noa
where @t_xnoa = a.noa


declare @tmp table (
		gno nvarchar(1),
		noa nvarchar(30),
		noq nvarchar(20),
		mon nvarchar(10),
		tggno nvarchar(20),
		comp nvarchar(50),
		tel nvarchar(50),
		fax nvarchar(20),
		addr nvarchar(50),
		datea nvarchar(10),
		ordeno nvarchar(20),
		bccname nvarchar(90),
		weightb float,
		mount int,
		unit nvarchar(20),
		price float,
		total int,
		paytype nvarchar(20),
		tmemo nvarchar(200),
		memo nvarchar(200),
		tmount int,
		ttotal int,
		mttotal int,
		tax int,
		tmoney int,
		w nvarchar(20),
		store nvarchar(20),
		part nvarchar(20),
		invono nvarchar(20),
		buyer nvarchar(20),
		recno int,
		currecno int,
		curpage int,
		totpage int
)
insert into @tmp
select a.*,ROW_NUMBER()over(order by gno) recno,0 currecno,0 curpage,0 totpage 
				 from( 
				select  gno,noa,noq,mon,tggno,comp,tel,fax,addr,datea,ordeno,bccname,weightb,mount,unit,price,
				total,paytype,tmemo,memo,tmount,ttotal,mttotal,tax,tmoney,w,store,part,invono,buyer
				from @tmpa a
				 )a


declare @noa nvarchar(20)
declare @gno nvarchar(20)
declare @tmount float
declare @count int
declare @t_count int
declare @recno int
declare @currecno int
declare @curpage int
declare @totpage int
declare @ttotal int
declare @mttotal int
declare @tax int
declare @tmoney int
declare @w nvarchar(30)
declare @paytype nvarchar(20)
declare @tmemo nvarchar(20)
declare @t_noa nvarchar(30)
declare @t_currecno float
set @t_currecno = 0


	
	declare cursor_table cursor for
	select noa,min(recno) from @tmp group by noa
	open cursor_table
	fetch next from cursor_table
	into @noa,@recno
	while(@@FETCH_STATUS <> -1)
	begin
		update @tmp set currecno = recno - @recno +1 where noa=@noa
		fetch next from cursor_table
		into @noa,@recno
	end
	close cursor_table
	deallocate cursor_table
	--------------------------------------------------
		
	----------------------------------------------------
	declare @count1 int
	declare @count2 int
	declare cursor_table cursor for
	select noa,sum(mount),max(ttotal),max(mttotal),max(tax),max(tmoney),max(w),max(paytype),max(tmemo),count(*) count1,(count(*)/@pageCount+1)*@pageCount count2 from @tmp group by noa
	open cursor_table
	fetch next from cursor_table
	into @noa,@tmount,@ttotal,@mttotal,@tax,@tmoney,@w,@paytype,@tmemo,@count1,@count2
	while(@@FETCH_STATUS <> -1)
	begin
		while(@count1<@count2) and not(@count1 % @pagecount = 0)
		begin
			insert into @tmp (gno,noa,noq,tmount,ttotal,mttotal,tax,tmoney,w,paytype,tmemo,currecno)VALUES
			(0,@noa,CHAR(255),@tmount,@ttotal,@mttotal,@tax,@tmoney,@w,@paytype,@tmemo,@count1+1)
			set @count1=@count1+1
		end
		fetch next from cursor_table
		into @noa,@tmount,@ttotal,@mttotal,@tax,@tmoney,@w,@paytype,@tmemo,@count1,@count2
	end
	close cursor_table
	deallocate cursor_table


	---------------------------------------------------
	declare cursor_table cursor for
	select noa,max(currecno) from @tmp group by noa
	open cursor_table
	fetch next from cursor_table
	into @noa,@currecno
	while(@@FETCH_STATUS <> -1)
	begin
		update @tmp set totpage = (@currecno-@currecno%@pagecount)/@pagecount where noa=@noa
		fetch next from cursor_table
		into @noa,@currecno
	end
	close cursor_table
	deallocate cursor_table
	
	declare cursor_table cursor for
	select noa,recno,currecno from @tmp
	open cursor_table
	fetch next from cursor_table
	into @noa,@recno,@currecno
	while(@@FETCH_STATUS <> -1)
	begin
		update @tmp set curpage = FLOOR((@currecno-1)/@pagecount)+1 where noa=@noa and recno=@recno
		fetch next from cursor_table
		into @noa,@recno,@currecno
	end
		close cursor_table
	deallocate cursor_table
	
	select gno,noa,noq,mon,tggno,comp,tel,fax,addr,datea,ordeno,bccname,store,part,invono,buyer,
	reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,weightb),1)),4,12)) weightb,
	reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,mount),1)),4,12)) mount,unit,
	reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,price),1)),4,12)) price,
	reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,total),1)),4,12)) total,paytype,
	tmemo,memo,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,tmount),1)),4,12)) tmount,
	reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,ttotal),1)),4,12)) ttotal,
	reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,mttotal),1)),4,12)) mttotal,
	reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,tax),1)),4,12)) tax,
	reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,tmoney),1)),4,12)) tmoney,
	w,recno,currecno,curpage,totpage,CONVERT(nvarchar(5),curpage)+'/'+CONVERT(nvarchar(5),totpage) page
	from @tmp where gno = 0
	order by noa,currecno;
