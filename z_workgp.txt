z_workgp1:--z_workgp1
declare @t_noa nvarchar(30)
set @t_noa = case when '#non' = [2] then '' else  [2] end

declare @tmp table(
	gno nvarchar(1),
	productno nvarchar(50),
	products nvarchar(90),
	datea nvarchar(10),
	ordemount float,
	planmount float,
	stkmount float,
	intmount float,
	purmount float,
	avaimount float,
	mount float,
	salemount float,
	indate nvarchar(10),
	inmount float,
	wmount float,
	ordenos nvarchar(MAX),
	ordenoa nvarchar(50),
	ordenoq nvarchar(20),
	omount float, 
	oc1 float, 
	onotv float, 
	odate nvarchar(10)
)

insert into @tmp
select '0',productno,product,dworkdate
,ordemount,planmount,stkmount,intmount,purmount
,availmount,mount,salemount,indate,inmount,wmount,ordeno,'','','','','',''
from workgs[1]
where noa=@t_noa

insert into @tmp(gno,productno,ordenoa,ordenoq,omount,oc1,onotv,odate)
select '2',productno,noa,no2,mount,c1,notv,datea
from view_ordes[1]
where CHARINDEX(noa+'-'+no2,(select ordenos+',' from @tmp FOR XML PATH('')))>0

insert into @tmp(gno,productno)
select '1',productno from @tmp where gno='2' group by productno
insert into @tmp(gno,productno)
select '3',productno from @tmp where gno='2' group by productno

select gno,productno,products,datea 
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,ordemount),1)),4,12)) ordemount 
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,planmount),1)),4,12)) planmount 
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,stkmount),1)),4,12)) stkmount 
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,intmount),1)),4,12)) intmount 
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,purmount),1)),4,12)) purmount 
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,avaimount),1)),4,12)) avaimount 
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,mount),1)),4,12)) mount 
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,salemount),1)),4,12)) salemount 
,indate 
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,inmount),1)),4,12)) inmount 
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,wmount),1)),4,12)) wmount 
,ordenos,ordenoa,ordenoq
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,omount),1)),4,12)) omount 
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,oc1),1)),4,12)) oc1
,reverse(substring(reverse(convert(nvarchar(15),CONVERT(money,onotv),1)),4,12)) onotv
,odate
from @tmp order by productno,gno
;

